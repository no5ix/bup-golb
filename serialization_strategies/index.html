<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


  <meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)">

<script>
    (function(){
        if(''){
            let localStoragePasswdKey = 'æ„å»ºæ¸¸æˆç½‘ç»œåè®®äºŒä¹‹åºåˆ—åŒ–ç­–ç•¥' + '_last_passwd';
            let tryCnt = 0;
            function checkPassword(password) {
                password = password == null ? null : password.trim();
                if (password !== '') {
                    if (password != null) {
                        // å¦‚æœç”¨æˆ·ç‚¹å‡»äº†ç¡®è®¤è€Œä¸”å¯†ç é”™è¯¯çš„æ—¶å€™, å› ä¸ºå½“password == nullçš„æ—¶å€™è¯´æ˜ç”¨æˆ·ç‚¹äº†å–æ¶ˆ
                        alert('Error!');
                        if (++tryCnt < 3) {
                            password = prompt('Open Sesame');
                            checkPassword(password);
                            return;
                        }
                    }

                    // if (history.length > 1) {
                    //     alert('back!');
                    //     history.back();
                    // } else {
                        // alert('blankkkk!');
                    //     window.location.href = "about:blank";
                    // }
                    if (document.referrer) {
                        window.location.href = document.referrer;
                    } else {
                        window.location.href = "about:blank";; // fallback if no referrer
                    }

                } else {
                    localStorage.setItem(localStoragePasswdKey, password);
                }
            }

            var password_verify_on_local = false;
            const hostname = window.location.hostname;
            if (password_verify_on_local || (!(hostname === "localhost" || hostname === "127.0.0.1" || hostname === "::1" || hostname.startsWith("192")))) {
                const lspk = localStorage.getItem(localStoragePasswdKey) || "";
                if (lspk !== '') {
                    var password = prompt('Open Sesame');
                    checkPassword(password);
                }
            }
        }
    })();
</script>








<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">





















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="GafferOnGames,">








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2">






<meta name="description" content="è‡ªæˆ‘æ€»ç»“æœ¬ç¯‡æ¦‚è¦ è¯»å–æ•°æ®çš„æ—¶å€™è¦ç‰¹åˆ«å°å¿ƒï¼Œ å› ä¸ºå¯èƒ½ä¼šæœ‰æ”»å‡»è€…å‘é€è¿‡æ¥çš„æ¶æ„çš„æ•°æ®åŒ…ä»¥åŠé”™è¯¯çš„åŒ…ï¼Œ åœ¨å†™å…¥æ•°æ®çš„æ—¶å€™ä½ å¯èƒ½ä¼šè½»æ¾å¾ˆå¤šï¼Œå› ä¸ºå¦‚æœæœ‰ä»»ä½•äº‹æƒ…å‡ºé”™äº†ï¼Œé‚£å‡ ä¹è‚¯å®šæ˜¯ä½ è‡ªå·±å¯¼è‡´çš„é”™è¯¯ ç»Ÿä¸€çš„æ•°æ®åŒ…åºåˆ—åŒ–åŠŸèƒ½ ï¼šè¯€çªåœ¨äºè®©æµç±»å‹çš„åºåˆ—åŒ–å‡½æ•°æ¨¡æ¿åŒ–ã€‚åœ¨æˆ‘çš„ç³»ç»Ÿä¸­æœ‰ä¸¤ä¸ªæµç±»å‹ï¼šReadStreamç±»å’ŒWriteStreamç±»ã€‚æ¯ä¸ªç±»éƒ½æœ‰ç›¸åŒçš„ä¸€å¥—æ–¹æ³•ï¼Œä½†å®é™…ä¸Šå®ƒä»¬æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚ä¸€ä¸ªç±»è´Ÿè´£ä»æ¯”ç‰¹æµ">
<meta name="keywords" content="GafferOnGames">
<meta property="og:type" content="article">
<meta property="og:title" content="æ„å»ºæ¸¸æˆç½‘ç»œåè®®äºŒä¹‹åºåˆ—åŒ–ç­–ç•¥">
<meta property="og:url" content="https://hulinhong.com/serialization_strategies/index.html">
<meta property="og:site_name" content="ğŸš™">
<meta property="og:description" content="è‡ªæˆ‘æ€»ç»“æœ¬ç¯‡æ¦‚è¦ è¯»å–æ•°æ®çš„æ—¶å€™è¦ç‰¹åˆ«å°å¿ƒï¼Œ å› ä¸ºå¯èƒ½ä¼šæœ‰æ”»å‡»è€…å‘é€è¿‡æ¥çš„æ¶æ„çš„æ•°æ®åŒ…ä»¥åŠé”™è¯¯çš„åŒ…ï¼Œ åœ¨å†™å…¥æ•°æ®çš„æ—¶å€™ä½ å¯èƒ½ä¼šè½»æ¾å¾ˆå¤šï¼Œå› ä¸ºå¦‚æœæœ‰ä»»ä½•äº‹æƒ…å‡ºé”™äº†ï¼Œé‚£å‡ ä¹è‚¯å®šæ˜¯ä½ è‡ªå·±å¯¼è‡´çš„é”™è¯¯ ç»Ÿä¸€çš„æ•°æ®åŒ…åºåˆ—åŒ–åŠŸèƒ½ ï¼šè¯€çªåœ¨äºè®©æµç±»å‹çš„åºåˆ—åŒ–å‡½æ•°æ¨¡æ¿åŒ–ã€‚åœ¨æˆ‘çš„ç³»ç»Ÿä¸­æœ‰ä¸¤ä¸ªæµç±»å‹ï¼šReadStreamç±»å’ŒWriteStreamç±»ã€‚æ¯ä¸ªç±»éƒ½æœ‰ç›¸åŒçš„ä¸€å¥—æ–¹æ³•ï¼Œä½†å®é™…ä¸Šå®ƒä»¬æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚ä¸€ä¸ªç±»è´Ÿè´£ä»æ¯”ç‰¹æµ">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2025-12-17T18:31:29.675Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="æ„å»ºæ¸¸æˆç½‘ç»œåè®®äºŒä¹‹åºåˆ—åŒ–ç­–ç•¥">
<meta name="twitter:description" content="è‡ªæˆ‘æ€»ç»“æœ¬ç¯‡æ¦‚è¦ è¯»å–æ•°æ®çš„æ—¶å€™è¦ç‰¹åˆ«å°å¿ƒï¼Œ å› ä¸ºå¯èƒ½ä¼šæœ‰æ”»å‡»è€…å‘é€è¿‡æ¥çš„æ¶æ„çš„æ•°æ®åŒ…ä»¥åŠé”™è¯¯çš„åŒ…ï¼Œ åœ¨å†™å…¥æ•°æ®çš„æ—¶å€™ä½ å¯èƒ½ä¼šè½»æ¾å¾ˆå¤šï¼Œå› ä¸ºå¦‚æœæœ‰ä»»ä½•äº‹æƒ…å‡ºé”™äº†ï¼Œé‚£å‡ ä¹è‚¯å®šæ˜¯ä½ è‡ªå·±å¯¼è‡´çš„é”™è¯¯ ç»Ÿä¸€çš„æ•°æ®åŒ…åºåˆ—åŒ–åŠŸèƒ½ ï¼šè¯€çªåœ¨äºè®©æµç±»å‹çš„åºåˆ—åŒ–å‡½æ•°æ¨¡æ¿åŒ–ã€‚åœ¨æˆ‘çš„ç³»ç»Ÿä¸­æœ‰ä¸¤ä¸ªæµç±»å‹ï¼šReadStreamç±»å’ŒWriteStreamç±»ã€‚æ¯ä¸ªç±»éƒ½æœ‰ç›¸åŒçš„ä¸€å¥—æ–¹æ³•ï¼Œä½†å®é™…ä¸Šå®ƒä»¬æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚ä¸€ä¸ªç±»è´Ÿè´£ä»æ¯”ç‰¹æµ">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"scrollpercent":true,"onmobile":true,"dimmer":true,"body_content_height":0,"display_duration":150},
    local_search: {"enable":true,"trigger":"auto","top_n_per_article":1},
    fancybox: false,
    mediumzoom: true,
    darkmode_js: false,
    tabs: true,
    motion: {"enable":true,"async":false,"duration":188,"transition":{"header":"fadeIn","menu":"fadeIn","logo":"fadeIn","post_block_else":"fadeIn","post_header":"fadeIn","post_body":"fadeIn","coll_header":"fadeIn","footer":"fadeIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>








  <title>æ„å»ºæ¸¸æˆç½‘ç»œåè®®äºŒä¹‹åºåˆ—åŒ–ç­–ç•¥ | ğŸš™</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ğŸš™</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">ğŸ’¨ ğŸ’¨ ğŸ’¨</p>
      
  </div>

  <div class="menu-item sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div class="menu-item site-search">
    
  
  <div class="site-search-div">
    <button class="search-icon" id="search-button">
      <i class="fa fa-search"></i>
    </button>
    <input type="text" id="local-search-input" class="st-search-input">
    <i id="local-search-close">Ã—</i>
  </div>


<script type="text/javascript" id="local.search.active">
    {/* var inputArea       = document.querySelector("#local-search-input");
    inputArea.onclick   = function(){ getSearchFile(); this.focus(); }
    inputArea.onkeydown = function(){ if(event.keyCode == 13) return false } */}
</script>



  </div>
  <div id="local-search-result-pc" class="local-search-result-cls"></div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      

       
    </ul>
  

  
    
  
</nav>



 </div>
    </header>

    <div id="local-search-result-mobile" class="local-search-result-cls"></div>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hulinhong.com/serialization_strategies/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mike">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ğŸš™">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">æ„å»ºæ¸¸æˆç½‘ç»œåè®®äºŒä¹‹åºåˆ—åŒ–ç­–ç•¥</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-25T17:13:35+00:00">
                02-25-2017
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/GS/" itemprop="url" rel="index">
                    <span itemprop="name">GS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            <div class="post-tags">
              
                <a href="/tags/GafferOnGames/" rel="tag"><i class="fa fa-tag"></i> GafferOnGames</a>
              
            </div>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    




    
    
    
    <div class="post-body" itemprop="articleBody">
      
      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/reading_and_writing_packets/" rel="next" title="æ„å»ºæ¸¸æˆç½‘ç»œåè®®ä¸€ä¹‹æ•°æ®åŒ…çš„è¯»å–å’Œå†™å…¥">
                <i class="fa fa-chevron-left"></i> 
                <p class="post-nav-pre-next-title">
                  æ„å»ºæ¸¸æˆç½‘ç»œåè®®ä¸€ä¹‹æ•°æ®åŒ…çš„è¯»å–å’Œå†™å…¥
                </p> 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/packet_fragmentation_and_reassembly/" rel="prev" title="æ„å»ºæ¸¸æˆç½‘ç»œåè®®ä¸‰ä¹‹æ•°æ®åŒ…çš„åˆ†åŒ…å’Œé‡ç»„">
              <p class="post-nav-pre-next-title">
                  æ„å»ºæ¸¸æˆç½‘ç»œåè®®ä¸‰ä¹‹æ•°æ®åŒ…çš„åˆ†åŒ…å’Œé‡ç»„
              </p> 
              <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      

      
      

      
        <h1 id="è‡ªæˆ‘æ€»ç»“æœ¬ç¯‡æ¦‚è¦"><a href="#è‡ªæˆ‘æ€»ç»“æœ¬ç¯‡æ¦‚è¦" class="headerlink" title="è‡ªæˆ‘æ€»ç»“æœ¬ç¯‡æ¦‚è¦"></a>è‡ªæˆ‘æ€»ç»“æœ¬ç¯‡æ¦‚è¦</h1><ul>
<li>è¯»å–æ•°æ®çš„æ—¶å€™è¦ç‰¹åˆ«å°å¿ƒï¼Œ å› ä¸ºå¯èƒ½ä¼šæœ‰æ”»å‡»è€…å‘é€è¿‡æ¥çš„æ¶æ„çš„æ•°æ®åŒ…ä»¥åŠé”™è¯¯çš„åŒ…ï¼Œ åœ¨å†™å…¥æ•°æ®çš„æ—¶å€™ä½ å¯èƒ½ä¼šè½»æ¾å¾ˆå¤šï¼Œå› ä¸ºå¦‚æœæœ‰ä»»ä½•äº‹æƒ…å‡ºé”™äº†ï¼Œé‚£å‡ ä¹è‚¯å®šæ˜¯ä½ è‡ªå·±å¯¼è‡´çš„é”™è¯¯</li>
<li><p><strong>ç»Ÿä¸€çš„æ•°æ®åŒ…åºåˆ—åŒ–åŠŸèƒ½</strong> ï¼šè¯€çªåœ¨äºè®©æµç±»å‹çš„åºåˆ—åŒ–å‡½æ•°æ¨¡æ¿åŒ–ã€‚åœ¨æˆ‘çš„ç³»ç»Ÿä¸­æœ‰ä¸¤ä¸ªæµç±»å‹ï¼šReadStreamç±»å’ŒWriteStreamç±»ã€‚æ¯ä¸ªç±»éƒ½æœ‰ç›¸åŒçš„ä¸€å¥—æ–¹æ³•ï¼Œä½†å®é™…ä¸Šå®ƒä»¬æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚ä¸€ä¸ªç±»è´Ÿè´£ä»æ¯”ç‰¹æµè¯»å–å€¼åˆ°å˜é‡ä¸­ï¼Œå¦å¤–ä¸€ä¸ªç±»è´Ÿè´£æŠŠå˜é‡çš„å€¼å†™åˆ°æµä¸­ã€‚<br>åœ¨æ¨¡æ¿é‡Œç±»ä¼¼è¿™æ ·å†™, é€šè¿‡ <code>Stream::IsWriting</code> å’Œ <code>Stream::IsReading</code> æ¨¡æ¿ä¼šè‡ªåŠ¨åŒºåˆ†,ç„¶åå¸®ä½ ç”Ÿäº§ä½ æƒ³è¦çš„ä»£ç , ç®€æ´æ¼‚äº®</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WriteStream</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> &#123; IsWriting = <span class="number">1</span> &#125;;</span><br><span class="line">    <span class="keyword">enum</span> &#123; IsReading = <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadStream</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> &#123; IsWriting = <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">enum</span> &#123; IsReading = <span class="number">1</span> &#125;;</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Stream&gt;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">serialize</span><span class="params">( Stream &amp; stream, <span class="keyword">float</span> &amp; value )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">union</span> FloatInt</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">float</span> float_value;</span><br><span class="line">       <span class="keyword">uint32_t</span> int_value;</span><br><span class="line">   &#125;;</span><br><span class="line">  </span><br><span class="line">   FloatInt tmp;</span><br><span class="line">   <span class="keyword">if</span> ( Stream::IsWriting )</span><br><span class="line">       tmp.float_value = value;</span><br><span class="line">  </span><br><span class="line">   <span class="keyword">bool</span> result = stream.SerializeBits( tmp.int_value, <span class="number">32</span> );</span><br><span class="line">  </span><br><span class="line">   <span class="keyword">if</span> ( Stream::IsReading )</span><br><span class="line">       value = tmp.float_value;</span><br><span class="line">  </span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>è¾¹ç•Œæ£€æŸ¥å’Œç»ˆæ­¢è¯»å–</strong> ï¼š æŠŠå…è®¸çš„å¤§å°èŒƒå›´ä¹Ÿä¼ ç»™åºåˆ—åŒ–å‡½æ•°è€Œä¸ä»…ä»…æ˜¯æ‰€éœ€çš„æ¯”ç‰¹æ•°é‡ã€‚</p>
</li>
<li><p><strong>åºåˆ—åŒ–æµ®ç‚¹æ•°å’Œå‘é‡</strong> ï¼š è®¡ç®—æœºæ ¹æœ¬ä¸çŸ¥é“å†…å­˜ä¸­çš„è¿™ä¸ª32ä½çš„å€¼åˆ°åº•æ˜¯ä¸€ä¸ªæ•´æ•°è¿˜æ˜¯ä¸€ä¸ªæµ®ç‚¹æ•°è¿˜æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²çš„éƒ¨åˆ†ã€‚å®ƒçŸ¥é“çš„å°±æ˜¯è¿™ä»…ä»…æ˜¯ä¸€ä¸ª32ä½çš„å€¼ã€‚ä»£ç å¦‚ä¸‹(å¯ä»¥é€šè¿‡ä¸€ä¸ªè”åˆä½“æ¥è®¿é—®çœ‹ä¸Šå»æ˜¯æ•´æ•°çš„æµ®ç‚¹æ•°).<br>æœ‰äº›æ—¶å€™ï¼Œä½ å¹¶ä¸æƒ³æŠŠä¸€ä¸ªå®Œæ•´ç²¾åº¦çš„æµ®ç‚¹æ•°è¿›è¡Œä¼ é€’ã€‚é‚£ä¹ˆè¯¥å¦‚ä½•å‹ç¼©è¿™ä¸ªæµ®ç‚¹å€¼ï¼Ÿç¬¬ä¸€æ­¥æ˜¯å°†å®ƒçš„å€¼é™åˆ¶åœ¨æŸä¸ªç¡®å®šçš„èŒƒå›´å†…ç„¶åç”¨ä¸€ä¸ªæ•´æ•°è¡¨ç¤ºæ–¹å¼æ¥å°†å®ƒé‡åŒ–ã€‚<br>ä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼Œå¦‚æœä½ çŸ¥é“ä¸€ä¸ªæµ®ç‚¹ç±»å‹çš„å€¼æ˜¯åœ¨åŒºé—´[-10,+10]ï¼Œå¯¹äºè¿™ä¸ªå€¼æ¥è¯´å¯ä»¥æ¥å—çš„ç²¾ç¡®åº¦æ˜¯0.01ï¼Œé‚£ä¹ˆä½ å¯ä»¥æŠŠè¿™ä¸ªæµ®ç‚¹æ•°ä¹˜ä»¥100.0è®©å®ƒçš„å€¼åœ¨åŒºé—´[-1000,+1000]å¹¶åœ¨ç½‘ç»œä¸Šå°†å…¶ä½œä¸ºä¸€ä¸ªæ•´æ•°è¿›è¡Œåºåˆ—åŒ–ã€‚è€Œåœ¨æ¥æ”¶çš„é‚£ä¸€ç«¯ï¼Œä»…ä»…éœ€è¦å°†å®ƒé™¤ä»¥100.0æ¥å¾—åˆ°æœ€åˆçš„æµ®ç‚¹å€¼. </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">union</span> FloatInt</span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">float</span> float_value;</span><br><span class="line">   <span class="keyword">uint32_t</span> int_value;</span><br><span class="line">&#125;;</span><br><span class="line">  </span><br><span class="line">FloatInt tmp;</span><br><span class="line">tmp.float_value= <span class="number">10.0f</span>;</span><br><span class="line"><span class="built_in">printf</span>(â€œ<span class="keyword">float</span> value as an integer: %x\nâ€, tmp.int_value );</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>åºåˆ—åŒ–å­—ç¬¦ä¸²å’Œæ•°ç»„</strong> : ä¸ºä»€ä¹ˆè¦è´¹é‚£ä¹ˆå¤§ç²¾åŠ›æŠŠä¸€ä¸ªå­—èŠ‚æ•°ç»„æŒ‰æ¯”ç‰¹æ‰“åŒ…åˆ°ä½ çš„æ¯”ç‰¹æµé‡Œ?ä¸ºä»€ä¹ˆä¸åœ¨åºåˆ—åŒ–å†™å…¥ä¹‹å‰è¿›è¡ŒæŒ‰å­—èŠ‚è¿›è¡Œå¯¹é½ï¼ŸWhy not align to byte so you can <strong>memcpy</strong> the array of bytes directly into the packet?<br>å¦‚ä½•å°†æ¯”ç‰¹æµæŒ‰å­—èŠ‚å¯¹é½ï¼Ÿåªéœ€è¦åœ¨æµçš„å½“å‰ä½ç½®åšäº›è®¡ç®—å°±å¯ä»¥äº†ï¼Œæ‰¾å‡ºè¿˜å·®å†™å…¥å¤šå°‘ä¸ªæ¯”ç‰¹å°±èƒ½è®©å½“å‰æ¯”ç‰¹æµçš„æ¯”ç‰¹æ•°é‡è¢«8æ•´é™¤ï¼Œç„¶åæŒ‰ç…§è¿™ä¸ªæ•°å­—æ’å…¥å¡«å……æ¯”ç‰¹ï¼ˆæ¯”å¦‚å½“å‰æ¯”ç‰¹æµçš„æ¯”ç‰¹æ•°é‡æ˜¯323ï¼Œé‚£ä¹ˆ323+5æ‰èƒ½è¢«8æ•´é™¤ï¼Œæ‰€ä»¥éœ€è¦æ’å…¥5ä¸ªå¡«å……æ¯”ç‰¹ï¼‰ã€‚å¯¹äºå¡«å……æ¯”ç‰¹æ¥è¯´ï¼Œå¡«å……çš„æ¯”ç‰¹å€¼éƒ½æ˜¯0ï¼Œè¿™æ ·å½“ä½ åºåˆ—åŒ–è¯»å–çš„æ—¶å€™ä½ å¯ä»¥è¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœæ£€æµ‹çš„ç»“æœæ˜¯æ­£ç¡®çš„ï¼Œé‚£ä¹ˆå°±ç¡®å®æ˜¯åœ¨è¯»å–å¡«å……çš„éƒ¨åˆ†ï¼Œå¹¶ä¸”å¡«å……çš„éƒ¨åˆ†ç¡®å®æ˜¯0ã€‚ä¸€ç›´è¯»å–åˆ°ä¸‹ä¸€ä¸ªå®Œæ•´å­—èŠ‚çš„æ¯”ç‰¹èµ·å§‹ä½ç½®ï¼ˆå¯ä»¥è¢«8æ•´é™¤çš„ä½ç½®ï¼‰ã€‚å¦‚æœæ£€æµ‹çš„ç»“æœæ˜¯åœ¨åº”è¯¥å¡«å……çš„åœ°æ–¹å‘ç°äº†é0çš„æ¯”ç‰¹å€¼ï¼Œé‚£ä¹ˆå°±ä¸­æ­¢åºåˆ—åŒ–è¯»å–å¹¶ä¸¢å¼ƒè¿™ä¸ªæ•°æ®åŒ…ã€‚</p>
</li>
<li><strong>åºåˆ—åŒ–æ•°ç»„çš„å­é›†</strong> : å½“å®ç°ä¸€ä¸ªæ¸¸æˆç½‘ç»œåè®®çš„æ—¶å€™ï¼Œæˆ–æ—©æˆ–æ™šæ€»ä¼šéœ€è¦åºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡æ•°ç»„ç„¶ååœ¨ç½‘ç»œä¸Šä¼ é€’ã€‚æ¯”å¦‚è¯´æœåŠ¡å™¨ä¹Ÿè®¸éœ€è¦æŠŠæ‰€æœ‰çš„ç‰©ä½“å‘é€ç»™å®¢æˆ·ç«¯ï¼Œæˆ–è€…æœ‰æ—¶å€™éœ€è¦å‘é€ä¸€ç»„äº‹ä»¶æˆ–è€…æ¶ˆæ¯ã€‚å¦‚æœä½ è¦å‘é€æ‰€æœ‰çš„ç‰©ä½“åˆ°å®¢æˆ·ç«¯ï¼Œè¿™æ˜¯ç›¸å½“ç®€å•ç›´è§‚çš„ï¼Œä½†æ˜¯å¦‚æœä½ åªæ˜¯æƒ³å‘é€ä¸€ä¸ªæ•°ç»„çš„ä¸€ä¸ªå­é›†æ€ä¹ˆåŠï¼Ÿ<br>æœ€å…ˆæƒ³åˆ°ä¹Ÿæ˜¯æœ€å®¹æ˜“çš„åŠæ³•æ˜¯éå†æ•°ç»„çš„æ‰€æœ‰ç‰©ä½“ç„¶ååºåˆ—åŒ–ä¸€ä¸ªboolæ•°ç»„ï¼Œè¿™ä¸ªboolæ•°ç»„æ ‡è®°çš„æ˜¯å¯¹åº”çš„ç‰©ä½“æ˜¯å¦é€šè¿‡ç½‘ç»œå‘é€ã€‚å¦‚æœboolå€¼ä¸º1é‚£ä¹ˆåé¢ä¼šè·Ÿç€ç‰©ä½“çš„æ•°æ®ï¼Œå¦åˆ™å°±ä¼šè¢«å¿½ç•¥ç„¶åä¸‹ä¸€ä¸ªç‰©ä½“çš„boolå€¼å–å†³äºæµçš„ä¸‹ä¸€ä¸ªå€¼ã€‚<br>å¦‚æœæœ‰å¤§é‡çš„ç‰©ä½“éœ€è¦å‘é€ï¼Œä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼Œæ•´ä¸ªåœºæ™¯ä¸­æœ‰4000ä¸ªç‰©ä½“ï¼Œæœ‰ä¸€åŠçš„ç‰©ä½“ä¹Ÿå°±æ˜¯2000ä¸ªéœ€è¦é€šè¿‡ç½‘ç»œè¿›è¡Œå‘é€ã€‚æ¯ä¸ªç‰©ä½“éœ€è¦ä¸€ä¸ªåºå·ï¼Œé‚£ä¹ˆå°±éœ€è¦2000ä¸ªåºå·ï¼Œæ¯ä¸ªåºå·éœ€è¦12æ¯”ç‰¹ã€‚ã€‚ã€‚ã€‚è¿™å°±æ˜¯è¯´æ•°æ®åŒ…é‡Œé¢24000æ¯”ç‰¹æˆ–è€…è¯´æ¥è¿‘30000æ¯”ç‰¹ï¼ˆå‡ ä¹æ˜¯30000ï¼Œä¸æ˜¯ä¸¥æ ¼æ˜¯ï¼Œè¯‘æ³¨ï¼šåŸæ–‡å¦‚æ­¤ï¼‰çš„æ•°æ®è¢«åºå·æµªè´¹æ‰äº†.<br>å¯ä»¥æŠŠåºå·çš„ç¼–ç æ–¹å¼ä¿®æ”¹ä¸‹æ¥èŠ‚çœæ•°æ®ï¼Œåºå·ä¸å†æ˜¯å…¨å±€åºå·ï¼Œè€Œæ˜¯ç›¸å¯¹ä¸Šä¸€ä¸ªç‰©ä½“çš„ç›¸å¯¹åºå·ã€‚</li>
<li><strong>å¦‚ä½•åº”å¯¹æ¶æ„æ•°æ®åŒ…å’Œé”™è¯¯åŒ…</strong> : å¦‚æœæŸäº›äººå‘é€ä¸€äº›åŒ…å«éšæœºä¿¡æ¯çš„æ¶æ„æ•°æ®åŒ…ç»™ä½ çš„æœåŠ¡å™¨ã€‚ä½ ä¼šä¸ä¼šåœ¨è§£æçš„æ—¶å€™æŠŠæœåŠ¡å™¨å¼„å´©æºƒæ‰ï¼Ÿ<br>æœ‰ä¸‰ç§æŠ€æœ¯åº”å¯¹ : <ul>
<li>åè®®ID : åœ¨ä½ çš„æ•°æ®åŒ…é‡Œé¢åŒ…å«åè®®IDã€‚ä¸€èˆ¬å…¸å‹çš„åšæ³•æ˜¯ï¼Œå¤´4ä¸ªå­—èŠ‚ä½ å¯ä»¥è®¾å®šä¸€äº›æ¯”è¾ƒç½•è§è€Œä¸”ç‹¬ç‰¹çš„å€¼ï¼Œä½ å¯ä»¥é€šè¿‡è¿™ï¼“ï¼’æ¯”ç‰¹çš„æ•°æ®åˆ¤æ–­å‡ºæ¥æ ¹æœ¬å°±ä¸æ˜¯ä½ çš„åº”ç”¨ç¨‹åºçš„åŒ…ï¼Œç„¶åå°±å¯ä»¥ç›´æ¥ä¸¢å¼ƒäº†ã€‚</li>
<li>CRC32 : å¯¹ä½ çš„æ•°æ®åŒ…æ•´ä½“åšä¸€ä¸ªCRC32çš„æ ¡éªŒï¼Œå¹¶æŠŠè¿™ä¸ªæ ¡éªŒç æ”¾åˆ°æ•°æ®åŒ…çš„åŒ…å¤´ã€‚å¯ä»¥ä¸å‘é€è¿™ä¸ªåè®®IDï¼Œä½†æ˜¯å‘é€æ–¹å’Œæ¥æ”¶æ–¹æå‰ç¡®è®¤è¿‡è¿™ä¸ªåè®®IDæ˜¯ä»€ä¹ˆï¼Œå¹¶åœ¨è®¡ç®—æ•°æ®åŒ…CRC32å€¼çš„æ—¶å€™è£…ä½œè¿™ä¸ªæ•°æ®åŒ…å¸¦ä¸Šäº†è¿™ä¸ªåè®®IDçš„å‰ç¼€æ¥å‚ä¸è®¡ç®—ã€‚è¿™æ ·å¦‚æœå‘é€æ–¹ä½¿ç”¨çš„åè®®IDä¸æ¥æ”¶æ–¹ä¸ä¸€è‡´çš„æ—¶å€™ï¼ŒCRC32çš„æ ¡éªŒå°±ä¼šå¤±è´¥ï¼Œè¿™å°†ä¸ºæ¯ä¸ªæ•°æ®åŒ…èŠ‚çœ4ä¸ªå­—èŠ‚.</li>
<li>åºåˆ—åŒ–æ£€æµ‹ : æ˜¯åœ¨åŒ…çš„ä¸­é—´ï¼Œåœ¨ä¸€æ®µå¤æ‚çš„åºåˆ—åŒ–å†™å…¥ä¹‹å‰æˆ–è€…ä¹‹åå†™ä¸Šä¸€ä¸ªå·²çŸ¥çš„32æ¯”ç‰¹æ•´æ•°ï¼Œå¹¶åœ¨å¦å¤–ä¸€ç«¯åºåˆ—åŒ–è¯»å–çš„æ—¶å€™ç”¨ç›¸åŒçš„å€¼è¿›è¡Œæ£€æµ‹åˆ¤æ–­ã€‚å¦‚æœåºåˆ—åŒ–æ£€æŸ¥å€¼æ˜¯ä¸æ­£ç¡®çš„ï¼Œé‚£ä¹ˆå°±ä¸­æ­¢åºåˆ—åŒ–è¯»å–å¹¶ä¸¢å¼ƒè¿™ä¸ªæ•°æ®åŒ…ã€‚<br><strong>. . .</strong><a id="more"></a></li>
</ul>
</li>
</ul>
<h1 id="åŸæ–‡"><a href="#åŸæ–‡" class="headerlink" title="åŸæ–‡"></a>åŸæ–‡</h1><p><a href="https://gafferongames.com/post/serialization_strategies/" target="_blank" rel="noopener">åŸæ–‡å‡ºå¤„</a></p>
<p>åŸæ–‡æ ‡é¢˜ : <strong>Serialization Strategies</strong> (<em>Smart tricks that unify packet read and write</em>)</p>
<hr>
<p></p><h2 id="introduction">Introduction</h2><p></p>
<p>Hi, Iâ€™m <a href="https://gafferongames.com/about" target="_blank" rel="noopener">Glenn Fiedler</a> and welcome to <strong><a href="https://gafferongames.com/categories/building-a-game-network-protocol/" target="_blank" rel="noopener">Building a Game Network Protocol</a></strong>.</p><br><p>In the <a href="https://gafferongames.com/post/reading_and_writing_packets/" target="_blank" rel="noopener">previous article</a>, we created a bitpacker but it required manual checking to make sure reading a packet from the network is safe. This is a real problem because the stakes are particularly high - a single missed check creates a vulnerability that an attacker can use to crash your server.</p><br><p>In this article, we&rsquo;re going to transform the bitpacker into a system where this checking is <em>automatic</em>. We&rsquo;re going to do this with minimal runtime overhead, and in such a way that we don&rsquo;t have to code separate read and write functions, performing both read and write with a single function.</p><br><p>This is called a <em>serialize function</em>.</p><br><h2 id="serializing-bits">Serializing Bits</h2><br><p>Let&rsquo;s start with the goal. Here&rsquo;s where we want to end up:</p><br><pre>struct PacketA<br>{<br>    int x,y,z;<br><br>    template &lt;typename Stream&gt; bool Serialize( Stream &amp; stream )<br>    {<br>        serialize_bits( stream, x, 32 );<br>        serialize_bits( stream, y, 32 );<br>        serialize_bits( stream, z, 32 );<br>        return true;<br>    }<br>};<br></pre><br><p>Above you can see a simple serialize function. We serialize three integer variables x,y,z with 32 bits each.</p><br><pre>struct PacketB<br>{<br>    int numElements;<br>    int elements[MaxElements];<br><br>    template &lt;typename Stream&gt; bool Serialize( Stream &amp; stream )<br>    {<br>        serialize_int( stream, numElements, 0, MaxElements );<br>        for ( int i = 0; i &lt; numElements; ++i )<br>        {<br>            serialize_bits( buffer, elements[i], 32 );<br>        }<br>        return true;<br>    }<br>};<br></pre><br><p>And now something more complicated. We serialize a variable length array, making sure that the array length is in the range [0,MaxElements].</p><br><p>Next, we serialize a rigid body with an simple optimization while it&rsquo;s at rest, serializing only one bit in place of linear and angular velocity:</p><br><pre>struct RigidBody<br>{<br>    vec3f position;<br>    quat4f orientation;<br>    vec3f linear_velocity;<br>    vec3f angular_velocity;<br><br>    template &lt;typename Stream&gt; bool Serialize( Stream &amp; stream )<br>    {<br>        serialize_vector( stream, position );<br>        serialize_quaternion( stream, orientation );<br>        bool at_rest = Stream::IsWriting ? ( velocity.length() == 0 ) : 1;<br>        serialize_bool( stream, at_rest );<br>        if ( !at_rest )<br>        {<br>            serialize_vector( stream, linear_velocity );<br>            serialize_vector( stream, angular_velocity );<br>        }<br>        else if ( Stream::IsReading )<br>        {<br>            linear_velocity = vec3f(0,0,0);<br>            angular<em>velocity = vec3f(0,0,0);<br>        }<br>        return true;<br>    }<br>};<br></em></pre><br><p>Notice how we&rsquo;re able to branch on Stream::IsWriting and Stream::IsReading to write code for each case. These branches are removed by the compiler when the specialized read and write serialize functions are generated.</p><br><p>As you can see, serialize functions are flexible and expressive. They&rsquo;re also <em>safe</em>, with each <strong>serialize<em></em></strong> call performing checks and aborting read if anything is wrong (eg. a value out of range, going past the end of the buffer). Most importantly, this checking is automatic, <em>so you can&rsquo;t forget to do it!</em></p><br><h2 id="implementation-in-c">Implementation in C++</h2><br><p>The trick to making this all work is to create two stream classes that share the same interface: <strong>ReadStream</strong> and <strong>WriteStream</strong>.</p><br><p>The write stream implementation <em>writes values</em> using the bitpacker:</p><br><pre>class WriteStream<br>{<br>public:<br><br>    enum { IsWriting = 1 };<br>    enum { IsReading = 0 };<br><br>    WriteStream( uint8_t  buffer, int bytes ) : m_writer( buffer, bytes ) {}<br><br>    bool SerializeInteger( int32_t value, int32_t min, int32_t max )<br>    {<br>        assert( min &lt; max );<br>        assert( value &gt;= min );<br>        assert( value &lt;= max );<br>        const int bits = bits_required( min, max );<br>        uint32_t unsigned_value = value - min;<br>        m_writer.WriteBits( unsigned_value, bits );<br>        return true;<br>    }<br><br>    // â€¦<br><br>private:<br><br>    BitWriter m_writer;<br>};<br></pre><br><p>And the read stream implementation <em>reads values in</em>:</p><br><pre>class ReadStream<br>{<br>public:<br><br>    enum { IsWriting = 0 };<br>    enum { IsReading = 1 };<br><br>    ReadStream( const uint8_t <em> buffer, int bytes ) : m_reader( buffer, bytes ) {}<br><br>    bool SerializeInteger( int32_t &amp; value, int32_t min, int32_t max )<br>    {<br>        assert( min &lt; max );<br>        const int bits = bits_required( min, max );<br>        if ( m_reader.WouldReadPastEnd( bits ) )<br>        {<br>            return false;<br>        }<br>        uint32_t unsigned_value = m_reader.ReadBits( bits );<br>        value = (int32_t) unsigned_value + min;<br>        return true;<br>    }<br><br>    // â€¦<br><br>private:<br><br>    BitReader m<em>reader;<br>};<br></em></em></pre><br><p>With the magic of C++ templates, we leave it up to the compiler to specialize the serialize function to the stream class passed in, producing optimized read and write functions.</p><br><p>To handle safety <strong>serialize</strong> calls are not actually functions at all. They&rsquo;re actually macros that return false on error, thus unwinding the stack in case of error, without the need for exceptions.</p><br><p>For example, this macro serializes an integer in a given range:</p><br><pre>#define serialize_int( stream, value, min, max )                    \<br>    do                                                              \<br>    {                                                               \<br>        assert( min &lt; max );                                        \<br>        int32_t int32_value;                                        \<br>        if ( Stream::IsWriting )                                    \<br>        {                                                           \<br>            assert( value &gt;= min );                                 \<br>            assert( value &lt;= max );                                 \<br>            int32_value = (int32_t) value;                          \<br>        }                                                           \<br>        if ( !stream.SerializeInteger( int32_value, min, max ) )    \<br>        {                                                           \<br>            return false;                                           \<br>        }                                                           \<br>        if ( Stream::IsReading )                                    \<br>        {                                                           \<br>            value = int32_value;                                    \<br>            if ( value &lt; min || value &gt; max )                       \<br>            {                                                       \<br>                return false;                                       \<br>            }                                                       \<br>        }                                                           \<br>     } while (0)<br></pre><br><p>If a value read in from the network is outside the expected range, or we read past the end of the buffer, the packet read is aborted.</p><br><h2 id="serializing-floating-point-values">Serializing Floating Point Values</h2><br><p>We&rsquo;re used to thinking about floating point numbers as being different to integers, but in memory they&rsquo;re just a 32 bit value like any other.</p><br><p>The C++ language lets us work with this fundamental property, allowing us to directly access the bits of a float value as if it were an integer:</p><br><pre>union FloatInt<br>{<br>    float float_value;<br>    uint32_t int_value;<br>};<br><br>FloatInt tmp;<br>tmp.float_value = 10.0f;<br>printf( â€œfloat value as an integer: %x\nâ€, tmp.int_value );<br></pre><br><p>You may prefer to do this with an aliased uint32_t<em> pointer, but this breaks with GCC -O2. Friends of mine point out that the only <em>truly standard way</em> to get the float as an integer is to cast a pointer to the float value to char</em> and reconstruct the integer from the bytes values accessed through the char pointer.</p><br><p>Meanwhile in the past 5 years I&rsquo;ve had no problems in the field with the union trick. Here&rsquo;s how I use it to serialize an uncompressed float value:</p><br><pre>template &lt;typename Stream&gt;<br>bool serialize_float_internal( Stream &amp; stream,<br>                               float &amp; value )<br>{<br>    union FloatInt<br>    {<br>        float float_value;<br>        uint32_t int_value;<br>    };<br>    FloatInt tmp;<br>    if ( Stream::IsWriting )<br>    {<br>        tmp.float_value = value;<br>    }<br>    bool result = stream.SerializeBits( tmp.int_value, 32 );<br>    if ( Stream::IsReading )<br>    {<br>        value = tmp.float_value;<br>    }<br>    return result;<br>}<br></pre><br><p>This is of course wrapped with a <strong>serialize_float</strong> macro for error checking:</p><br><pre>#define serialize_float( stream, value )                             \<br>  do                                                                 \<br>  {                                                                  \<br>      if ( !serialize_float_internal( stream, value ) )              \<br>      {                                                              \<br>          return false;                                              \<br>      }<br>  } while (0)<br></pre><br><p>We can now transmit full precision floating point values over the network.</p><br><p>But what about situations where you don&rsquo;t need full precision? What about a floating point value in the range [0,10] with an acceptable precision of 0.01? Is there a way to send this over the network using less bits?</p><br><p>Yes there is. The trick is to simply divide by 0.01 to get an integer in the range [0,1000] and send that value over the network. On the other side, convert back to a float by multiplying by 0.01.</p><br><p>Here&rsquo;s a general purpose implementation of this basic idea:</p><br><pre>template &lt;typename Stream&gt;<br>bool serialize_compressed_float_internal( Stream &amp; stream,<br>                                          float &amp; value,<br>                                          float min,<br>                                          float max,<br>                                          float res )<br>{<br>    const float delta = max - min;<br>    const float values = delta / res;<br>    const uint32_t maxIntegerValue = (uint32_t) ceil( values );<br>    const int bits = bits_required( 0, maxIntegerValue );<br>    uint32_t integerValue = 0;<br>    if ( Stream::IsWriting )<br>    {<br>        float normalizedValue =<br>            clamp( ( value - min ) / delta, 0.0f, 1.0f );<br>        integerValue = (uint32_t) floor( normalizedValue <em><br>                                         maxIntegerValue + 0.5f );<br>    }<br>    if ( !stream.SerializeBits( integerValue, bits ) )<br>    {<br>        return false;<br>    }<br>    if ( Stream::IsReading )<br>    {<br>        const float normalizedValue =<br>            integerValue / float( maxIntegerValue );<br>        value = normalizedValue </em> delta + min;<br>    }<br>    return true;<br>}<br></pre><br><p>Of course we need error checking, so we wrap this with a macro:</p><br><pre>#define serialize_compressed_float( stream, value, min, max )        \<br>  do                                                                 \<br>  {                                                                  \<br>    if ( !serialize_float_internal( stream, value, min, max ) )      \<br>    {                                                                \<br>        return false;                                                \<br>    }                                                                \<br>  } while (0)<br></pre><br><p>And now the basic interface is complete. We can serialize both compressed and uncompressed floating point values over the network.</p><br><h2 id="serializing-vectors-and-quaternions">Serializing Vectors and Quaternions</h2><br><p>Once you can serialize float values it&rsquo;s trivial to serialize vectors over the network. I use a modified version of the <a href="https://github.com/scoopr/vectorial" target="_blank" rel="noopener">vectorial library</a> in my projects and implement serialization for its vector type like this:</p><br><pre>template &lt;typename Stream&gt;<br>bool serialize_vector_internal( Stream &amp; stream,<br>                                vec3f &amp; vector )<br>{<br>    float values[3];<br>    if ( Stream::IsWriting )<br>    {<br>        vector.store( values );<br>    }<br>    serialize_float( stream, values[0] );<br>    serialize_float( stream, values[1] );<br>    serialize_float( stream, values[2] );<br>    if ( Stream::IsReading )<br>    {<br>        vector.load( values );<br>    }<br>    return true;<br>}<br><br>#define serialize_vector( stream, value )                       \<br> do                                                             \<br> {                                                              \<br>     if ( !serialize_vector_internal( stream, value ) )         \<br>     {                                                          \<br>         return false;                                          \<br>     }                                                          \<br> }                                                              \<br> while(0)<br></pre><br><p>If your vector is bounded in some range, then you can compress it:</p><br><pre>template &lt;typename Stream&gt;<br>bool serialize_compressed_vector_internal( Stream &amp; stream,<br>                                           vec3f &amp; vector,<br>                                           float min,<br>                                           float max,<br>                                           float res )<br>{<br>    float values[3];<br>    if ( Stream::IsWriting )<br>    {<br>        vector.store( values );<br>    }<br>    serialize_compressed_float( stream, values[0], min, max, res );<br>    serialize_compressed_float( stream, values[1], min, max, res );<br>    serialize_compressed_float( stream, values[2], min, max, res );<br>    if ( Stream::IsReading )<br>    {<br>        vector.load( values );<br>    }<br>    return true;<br>}<br></pre><br><p>Notice how we are able to build more complex serialization using the primitives we&rsquo;re already created. Using this approach you can easily extend the serialization to support anything you need.</p><br><h2 id="serializing-strings-and-arrays">Serializing Strings and Arrays</h2><br><p>What if you need to serialize a string over the network?</p><br><p>Is it a good idea to send a string over the network with null termination? Not really. You&rsquo;re just asking for trouble! Instead, serialize the string as an array of bytes with the string length in front. Therefore, in order to send a string over the network, we have to work out how to send an array of bytes.</p><br><p>First observation. Why waste effort bitpacking an array of bytes into your bit stream just so they are randomly shifted by [0,7] bits? Why not align to byte so you can memcpy the array of bytes directly into the packet?</p><br><p>To align a bitstream just work out your current bit index in the stream and how many bits of padding are needed until the current bit index divides evenly into 8, then insert that number of padding bits. </p><br><p>For bonus points, pad up with zero bits to add entropy so that on read you can verify that yes, you are reading a byte align and yes, it is indeed padded up with zero bits to the next whole byte bit index. If a non-zero bit is discovered in the padding, <em>abort serialize read and discard the packet</em>.</p><br><p>Here&rsquo;s my code to align a bit stream to byte:</p><br><pre>void BitWriter::WriteAlign()<br>{<br>    const int remainderBits = m_bitsWritten % 8;<br>    if ( remainderBits != 0 )<br>    {<br>        uint32_t zero = 0;<br>        WriteBits( zero, 8 - remainderBits );<br>        assert( ( m_bitsWritten % 8 ) == 0 );<br>    }<br>}<br><br>bool BitReader::ReadAlign()<br>{<br>    const int remainderBits = m_bitsRead % 8;<br>    if ( remainderBits != 0 )<br>    {<br>        uint32_t value = ReadBits( 8 - remainderBits );<br>        assert( m_bitsRead % 8 == 0 );<br>        if ( value != 0 )<br>            return false;<br>    }<br>    return true;<br>}<br><br>#define serialize_align( stream )           \<br>  do                                        \<br>  {                                         \<br>      if ( !stream.SerializeAlign() )       \<br>          return false;                     \<br>  } while (0)<br></pre><br><p>Now we can align to byte prior to writing an array of bytes, letting us use memcpy for the bulk of the array data. The only wrinkle is because the bitpacker works at the word level, it&rsquo;s necessary to have special handling for the head and tail portions. Because of this, the code is quite complex and is omitted for brevity. You can find it in the <a href="https://www.patreon.com/gafferongames" target="_blank" rel="noopener">sample code</a> for this article.</p><br><p>The end result of all this is a <strong>serialize_bytes</strong> primitive that we can use to serialize a string as a length followed by the string data, like so:</p><br><pre>template &lt;typename Stream&gt;<br>bool serialize_string_internal( Stream &amp; stream,<br>                                char <em> string,<br>                                int buffer_size )<br>{<br>    uint32_t length;<br>    if ( Stream::IsWriting )<br>    {<br>        length = strlen( string );<br>        assert( length &lt; buffer_size - 1 );<br>    }<br>    serialize_int( stream, length, 0, buffer_size - 1 );<br>    serialize_bytes( stream, (uint8_t</em>)string, length );<br>    if ( Stream::IsReading )<br>    {<br>        string[length] = â€˜\0â€™;<br>    }<br>}<br><br>#define serialize_string( stream, string, buffer_size )              \<br>do                                                                   \<br>{                                                                    \<br>    if ( !serialize_string_internal( stream,                         \<br>                                     string,                         \<br>                                     buffer_size ) )                 \<br>    {                                                                \<br>        return false;                                                \<br>    }                                                                \<br>} while (0)<br></pre><br><p>This is an ideal string format because it lets us quickly reject malicious data, vs. having to scan through to the end of the packet searching for <strong>&lsquo;\0&rsquo;</strong> before giving up. This is important because otherwise protocol level attacks could be crafted to degrade your server&rsquo;s performance by making it do extra work.</p><br><h2 id="serializing-array-subsets">Serializing Array Subsets</h2><br><p>When implemeting a game network protocol, sooner or later you need to serialize an array of objects over the network. Perhaps the server needs to send object state down to the client, or there is an array of messages to be sent.</p><br><p>This is straightforward if you are sending <em>all</em> objects in the array - just iterate across the array and serialize each object in turn. But what if you want to send a subset of the array?</p><br><p>The simplest approach is to iterate across all objects in the array and serialize a bit per-object if that object is to be sent. If the value of the bit is 1 then the object data follows in the bit stream, otherwise it&rsquo;s ommitted:</p><br><pre>template &lt;typename Stream&gt;<br>bool serialize_scene_a( Stream &amp; stream, Scene &amp; scene )<br>{<br>    for ( int i = 0; i &lt; MaxObjects; ++i )<br>    {<br>        serialize_bool( stream, scene.objects[i].send );<br>        if ( !scene.objects[i].send )<br>        {<br>            if ( Stream::IsReading )<br>            {<br>                memset( &amp;scene.objects[i], 0, sizeof( Object ) );<br>            }<br>            continue;<br>        }<br>        serialize_object( stream, scene.objects[i] );<br>    }<br>    return true;<br>}<br></pre><br><p>This approach breaks down as the size of the array gets larger. For example, for an array size of size 4096, then 4096 / 8 = 512 bytes spent on skip bits. That&rsquo;s not good. Can we switch it around so we take overhead propertional to the number of objects sent instead of the total number of objects in the array?</p><br><p>We can but now, we&rsquo;ve done something interesting. We&rsquo;re walking one set of objects in the serialize write (all objects in the array) and are walking over a different set of objects in the serialize read (subset of objects sent).</p><br><p>At this point the unified serialize function concept starts to breaks down, and in my opinion, it&rsquo;s best to separate the read and write back into separate functions, because they have so little in common:</p><br><pre>bool write_scene_b( WriteStream &amp; stream, Scene &amp; scene )<br>{<br>    int num_objects_sent = 0;<br>    for ( int i = 0; i &lt; MaxObjects; ++i )<br>    {<br>        if ( scene.objects[i].send )<br>            num_objects_sent++;<br>    }<br>    write_int( stream, num_objects_sent, 0, MaxObjects );<br>    for ( int i = 0; i &lt; MaxObjects; ++i )<br>    {<br>        if ( !scene.objects[i].send )<br>        {<br>            continue;<br>        }<br>        write_int( stream, i, 0, MaxObjects - 1 );<br>        write_object( stream, scene.objects[i] );<br>    }<br>    return true;<br>}<br><br>bool read_scene_b( ReadStream &amp; stream, Scene &amp; scene )<br>{<br>    memset( &amp;scene, 0, sizeof( scene ) );<br>    int num_objects_sent;<br>    read_int( stream, num_objects_sent, 0, MaxObjects );<br>    for ( int i = 0; i &lt; num_objects_sent; ++i )<br>    {<br>        int index;<br>        read_int( stream, index, 0, MaxObjects - 1 );<br>        read_object( stream, scene.objects[index] );<br>    }<br>    return true;<br>}<br></pre><br><p>One more point. The code above walks over the set of objects <em>twice</em> on serialize write. Once to determine the number of changed objects and a second time to actually serialize the set of changed objects. Can we do it in one pass instead? Absolutely! You can use another trick, rather than serializing the # of objects in the array up front, use a <em>sentinel value</em> to indicate the end of the array:</p><br><pre>bool write_scene_c( WriteStream &amp; stream, Scene &amp; scene )<br>{<br>    for ( int i = 0; i &lt; MaxObjects; ++i )<br>    {<br>        if ( !scene.objects[i].send )<br>        {<br>            continue;<br>        }<br>        write_int( stream, i, 0, MaxObjects );<br>        write_object( stream, scene.objects[i] );<br>    }<br>    write_int( stream, MaxObjects, 0, MaxObjects );<br>    return true;<br>}<br><br>bool read_scene_c( ReadStream &amp; stream, Scene &amp; scene )<br>{<br>    memset( &amp;scene, 0, sizeof( scene ) );<br>    while ( true )<br>    {<br>        int index; read_int( stream, index, 0, MaxObjects );<br>        if ( index == MaxObjects )<br>        {<br>            break;<br>        }<br>        read_object( stream, scene.objects[index] );<br>    }<br>    return true;<br>}<br></pre><br><p>The above technique works great if the objects sent are a small percentage of total objects. But what if a large number of objects are sent, lets say half of the 4000 objects in the scene. That&rsquo;s 2000 object indices with each index costing 12 bits&hellip; that&rsquo;s 24000 bits or 3000 bytes (almost 3k!) in your packet wasted on indexing.</p><br><p>You can reduce this overhead by encoding each object index relative to the previous object index. Think about it, you&rsquo;re walking from left to right along an array, so object indices start at 0 and go up to MaxObjects - 1. Statistically speaking, you&rsquo;re quite likely to have objects that are close to each other and if the next index is +1 or even +10 or +30 from the previous one, on average, you&rsquo;ll need quite a few less bits to represent that difference than an absolute index.</p><br><p>Here&rsquo;s one way to encode the object index as an integer relative to the previous object index, while spending less bits on statistically more likely values:</p><br><pre>template &lt;typename Stream&gt;<br>bool serialize_object_index_internal( Stream &amp; stream,<br>                                      int &amp; previous,<br>                                      int &amp; current )<br>{<br>    uint32_t difference;<br>    if ( Stream::IsWriting )<br>    {<br>        assert( previous &lt; current );<br>        difference = current - previous;<br>        assert( difference &gt; 0 );<br>    }<br><br>    // +1 (1 bit)<br>    bool plusOne;<br>    if ( Stream::IsWriting )<br>    {<br>       plusOne = difference == 1;<br>    }<br>    serialize_bool( stream, plusOne );<br>    if ( plusOne )<br>    {<br>        if ( Stream::IsReading )<br>        {<br>            current = previous + 1;<br>        }<br>        previous = current;<br>        return true;<br>    }<br><br>    // [+2,5] -&gt; [0,3] (2 bits)<br>    bool twoBits;<br>    if ( Stream::IsWriting )<br>    {<br>        twoBits = difference &lt;= 5;<br>    }<br>    serialize_bool( stream, twoBits );<br>    if ( twoBits )<br>    {<br>        serialize_int( stream, difference, 2, 5 );<br>        if ( Stream::IsReading )<br>        {<br>            current = previous + difference;<br>        }<br>        previous = current;<br>        return true;<br>    }<br><br>    // [6,13] -&gt; [0,7] (3 bits)<br>    bool threeBits;<br>    if ( Stream::IsWriting )<br>    {<br>        threeBits = difference &lt;= 13;<br>    }<br>    serialize_bool( stream, threeBits );<br>    if ( threeBits )<br>    {<br>        serialize_int( stream, difference, 6, 13 );<br>        if ( Stream::IsReading )<br>        {<br>            current = previous + difference;<br>        }<br>        previous = current;<br>        return true;<br>    }<br><br>    // [14,29] -&gt; [0,15] (4 bits)<br>    bool fourBits;<br>    if ( Stream::IsWriting )<br>    {<br>        fourBits = difference &lt;= 29;<br>    }<br>    serialize_bool( stream, fourBits );<br>    if ( fourBits )<br>    {<br>        serialize_int( stream, difference, 14, 29 );<br>        if ( Stream::IsReading )<br>        {<br>            current = previous + difference;<br>        }<br>        previous = current;<br>        return true;<br>    }<br><br>    // [30,61] -&gt; [0,31] (5 bits)<br>    bool fiveBits;<br>    if ( Stream::IsWriting )<br>    {<br>        fiveBits = difference &lt;= 61;<br>    }<br>    serialize_bool( stream, fiveBits );<br>    if ( fiveBits )<br>    {<br>        serialize_int( stream, difference, 30, 61 );<br>        if ( Stream::IsReading )<br>        {<br>            current = previous + difference;<br>        }<br>        previous = current;<br>        return true;<br>    }<br><br>    // [62,125] -&gt; [0,63] (6 bits)<br>    bool sixBits;<br>    if ( Stream::IsWriting )<br>    {<br>        sixBits = difference &lt;= 125;<br>    }<br>    serialize_bool( stream, sixBits );<br>    if ( sixBits )<br>    {<br>        serialize_int( stream, difference, 62, 125 );<br>        if ( Stream::IsReading )<br>        {<br>            current = previous + difference;<br>        }<br>        previous = current;<br>        return true;<br>    }<br><br>    // [126,MaxObjects+1]<br>    serialize_int( stream, difference, 126, MaxObjects + 1 );<br>    if ( Stream::IsReading )<br>    {<br>        current = previous + difference;<br>    }<br>    previous = current;<br>    return true;<br>}<br><br>template &lt;typename Stream&gt;<br>bool serialize_scene_d( Stream &amp; stream, Scene &amp; scene )<br>{<br>    int previous_index = -1;<br><br>    if ( Stream::IsWriting )<br>    {<br>        for ( int i = 0; i &lt; MaxObjects; ++i )<br>        {<br>            if ( !scene.objects[i].send )<br>            {<br>                continue;<br>            }<br>            write_object_index( stream, previous_index, i );<br>            write_object( stream, scene.objects[i] );<br>        }<br>        write_object_index( stream, previous_index, MaxObjects );<br>    }<br>    else<br>    {<br>        while ( true )<br>        {<br>            int index;<br>            read_object_index( stream, previous_index, index );<br>            if ( index == MaxObjects )<br>            {<br>                break;<br>            }<br>            read_object( stream, scene.objects[index] );<br>        }<br>    }<br>    return true;<br>}<br></pre><br><p>But what about the worst case? Won&rsquo;t we spent more bits when indices are &gt;= +126 apart than on an absolute index? Yes we do, but how many of these worst case indices fit in an array of size 4096? Just 32. It&rsquo;s nothing to worry about.</p><br><h2 id="protocol-ids-crc32-and-serialization-checks">Protocol IDs, CRC32 and Serialization Checks</h2><br><p>We are nearly at the end of this article, and you can see by now that we are sending a completely unattributed binary stream. It&rsquo;s essential that read and write match perfectly, which is of course why the serialize functions are so great, it&rsquo;s hard to desync something when you unify read and write.</p><br><p>But accidents happen, and when they do this system can seem like a stack of cards. What if you somehow desync read and write? How can you debug this? What if somebody tries to connect to your latest server code with an old version of your client?</p><br><p>One technique to protect against this is to include a protocol id in your packet. For example, it could be a combination of a unique number for your game, plus the hash of your protocol version and a hash of your game data. Now if a packet comes in from an incompatible game version, it&rsquo;s automatically discarded because the protocol ids don&rsquo;t match:</p><br><pre>[protocol id] (64bits)<br>(packet data)<br></pre><br><p>The next level of protection is to pass a CRC32 over your packet and include that in the header. This lets you pick up corrupt packets (these do happen, remember that the IP checksum is just 16 bits&hellip;). Now your packet header looks like this:</p><br><pre>[protocol id] (64bits)<br>[crc32] (32bits)<br>(packet data)<br></pre><br><p>At this point you may be wincing. Wait. I have to take 8+4 = 12 bytes of overhead per-packet just to implement my own checksum and protocol id? Well actually, <em>you don&rsquo;t</em>. You can take a leaf out of how IPv4 does their checksum, and make the protocol id a <strong>magical prefix</strong>.</p><br><p>This means you don&rsquo;t actually send it, and rely on the fact that if the CRC32 is calculated as if the packet were prefixed by the protocol id, then the CRC32 will be incorrect if the sender does not have the same protocol id as the receiver, thus saving 8 bytes per-packet:</p><br><pre><del>[protocol id] (64bits)</del>   // not actually sent, but used to calc crc32<br>[crc32] (32bits)<br>(packet data)<br></pre><br><p>One final technique, perhaps as much a check against programmer error on your part and malicious senders (although redundant once you encrypt and sign your packet) is the <em>serialization check</em>. Basically, somewhere mid-packet, either before or after a complicated serialization section, just write out a known 32 bit integer value, and check that it reads back in on the other side with the same value. If the serialize check value is incorrect <em>abort read and discard the packet</em>.</p><br><p>I like to do this between sections of my packet as I write them, so at least I know which part of my packet serialization has desynced read and write as I&rsquo;m developing my protocol. Another cool trick I like to use is to always serialize a protocol check at the very end of the packet, to detect accidental packet truncation (which happens more often than you would think).</p><br><p>Now the packet looks something like this:</p><br><pre><del>[protocol id] (64bits)</del>   // not actually sent, but used to calc crc32<br>[crc32] (32bits)<br>(packet data)<br>[end of packet serialize check] (32 bits)<br></pre><br><p>This is great packet structure to use during development.</p>


<h1 id="è¯‘æ–‡">è¯‘æ–‡</h1>

<p>æ³¨æ„ ï¼šè¿™ç¯‡è¯‘æ–‡å¯¹åº”çš„æ˜¯ä¸‹é¢çš„åŸä½œè€…<a href="#åŸæ–‡æ—§ç‰ˆæœ¬">åŸæ–‡æ—§ç‰ˆæœ¬</a>ã€‚</p>
<p><a href="http://gad.qq.com/program/translateview/7161833" target="_blank" rel="noopener">è¯‘æ–‡å‡ºå¤„</a></p>
<div class="WordSection1"><b><span style="color: rgb(34, 34, 34); font-family: å¾®è½¯é›…é»‘, sans-serif; font-size: 12pt;">è¯‘è€…ï¼šå´”å˜‰è‰ºï¼ˆ</span><span style="color: rgb(34, 34, 34); font-family: å¾®è½¯é›…é»‘, sans-serif; font-size: 12pt;">milan21</span><span style="color: rgb(34, 34, 34); font-family: å¾®è½¯é›…é»‘, sans-serif; font-size: 12pt;">ï¼‰ å®¡æ ¡ï¼šé™ˆæ•¬å‡¤</span><span style="color: rgb(34, 34, 34); font-family: å¾®è½¯é›…é»‘, sans-serif; font-size: 12pt;">(nunu)</span></b><p class="MsoNormal" align="left" style="line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span style="color: rgb(34, 34, 34); font-family: å¾®è½¯é›…é»‘, sans-serif; font-size: 12pt;"> </span></p><p class="MsoNormal" style="line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">åœ¨è¿™ä¸ªç³»åˆ—æ–‡ç« ä¸­ï¼Œæˆ‘å°†å®Œå…¨ä»å¤´å¼€å§‹æ„å»ºä¸€ä¸ªä¸“ä¸šçº§åˆ«çš„å®¢æˆ·ç«¯<span>/</span>æœåŠ¡å™¨æ¸¸æˆç½‘ç»œåè®®ï¼Œåªä½¿ç”¨äº†<span>C++</span>ç¼–è¯‘å™¨å’Œä¸€ç»„<span>UDP</span>å¥—æ¥å­—ã€‚å¦‚æœä½ æ­£åœ¨å¯»æ‰¾ä¸€ä¸ªå…³äºå¦‚ä½•å®ç°ä½ è‡ªå·±çš„æ¸¸æˆç½‘ç»œåè®®æ–¹é¢çš„è¯¦ç»†ã€å®ç”¨å®ç°ï¼Œé‚£ä¹ˆè¿™ä¸ªç³»åˆ—çš„æ–‡ç« å¯¹ä½ æ¥è¯´å°±å†é€‚åˆä¸è¿‡äº†ã€‚</span><span style="font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:#2B2B2B;background:#F8F8F8"><br><br></span></p><p class="MsoNormal" align="left" style="line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯<span>Glenn Fiedler</span>ï¼Œæ¬¢è¿é˜…è¯»ã€Šæ„å»ºæ¸¸æˆç½‘ç»œåè®®ã€‹ç³»åˆ—æ•™ç¨‹çš„ç¬¬äºŒç¯‡æ–‡ç« ã€‚</span></p><p class="MsoNormal" align="left" style="line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">åœ¨å‰é¢çš„æ–‡ç« é‡Œï¼Œæˆ‘ä»¬è®¨è®ºäº†åœ¨å¤šäººåœ¨çº¿ç½‘ç»œæ¸¸æˆé‡Œé¢è¯»å–å’Œå†™å…¥ç½‘ç»œåŒ…çš„ä¸åŒæ–¹æ³•ã€‚æˆ‘ä»¬å¾ˆå¿«å°±å¦å†³äº†é€šè¿‡æ–‡æœ¬çš„æ ¼å¼æ¯”å¦‚<span>XML</span>å’Œ<span>JSON</span>æ¥å‘é€æ¸¸æˆçŠ¶æ€çš„åŠæ³•å› ä¸ºå®ƒä»¬ç¡®å®åœ¨æ•ˆç‡ä¸Šå­˜åœ¨æ¯”è¾ƒå¤§çš„é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬å†³å®šç”¨è‡ªå®šä¹‰çš„äºŒè¿›åˆ¶æ ¼å¼è¿›è¡Œä»£æ›¿ã€‚</span></p><p class="MsoNormal" align="left" style="line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªä½æ‰“åŒ…å™¨<span>(bitpacker)</span>ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— éœ€æ‰‹åŠ¨å°†å‡ ä¸ªå¸ƒå°”å˜é‡èšæˆä¸€ä¸ª<span>8</span>ä½æ¯”ç‰¹å€¼<span>(</span>ä»¥ä¾¿ä¸ºäº†èŠ‚çœç©ºé—´<span>)</span>ï¼Œä¹Ÿæ— éœ€è€ƒè™‘å¤§ç«¯å°ç«¯é—®é¢˜ï¼Œå¯ä»¥æ¯æ¬¡å†™å…¥ä¸€ä¸ªå®Œæ•´çš„å•è¯è€Œä¸éœ€è¦å°†å•è¯æ‹†æˆä¸€ä¸ªä¸ªå­—ç¬¦ï¼Œå†è€ƒè™‘å¦‚ä½•ç”¨å­—èŠ‚è¡¨ç¤ºå®ƒä»¬ï¼Œè¿™ä½¿å¾—ä½æ‰“åŒ…å™¨æ—¢éå¸¸ç®€å•ä¹Ÿå·¥ä½œçš„éå¸¸å¿«ï¼Œä¹Ÿæ— éœ€è€ƒè™‘ä¸å¹³å°æœ‰å…³çš„ç»†èŠ‚ã€‚</span></p><p class="MsoNormal" align="left" style="line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#333333"> </span></p><p class="MsoNormal" align="left" style="line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ä½†æ˜¯æˆ‘ä»¬ä»ç„¶é—ç•™äº†ä»¥ä¸‹è¿™äº›é—®é¢˜éœ€è¦è§£å†³ï¼š</span></p><p class="MsoListParagraph" align="left" style="margin-l : initial; background-repeat: initial;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#333333">1.<span style="font-stretch: normal; font-size: 7pt; line-height: normal; font-family: &quot;Times New Roman&quot;;">    </span></span><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#333333">æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªæ–¹æ³•æ¥åˆ¤æ–­æ•´æ•°å€¼æ˜¯å¦è¶…å‡ºé¢„æœŸèŒƒå›´ï¼Œå¦‚æœè¶…å‡ºäº†å°±è¦ä¸­æ­¢ç½‘ç»œåŒ…çš„è¯»å–å’Œè§£æï¼Œå› ä¸ºä¼šæœ‰ä¸€äº›ä¸æ€€å¥½æ„çš„äººç»™æˆ‘ä»¬å‘é€æ¶æ„ç½‘ç»œåŒ…å¸Œæœ›æˆ‘ä»¬çš„ç¨‹åºå’Œå†…å­˜å´©æºƒæ‰ã€‚ç½‘ç»œåŒ…çš„è¯»å–å’Œè§£æçš„ä¸­æ­¢å¿…é¡»æ˜¯è‡ªåŠ¨åŒ–çš„ï¼Œè€Œä¸”ä¸èƒ½ä½¿ç”¨å¼‚å¸¸å¤„ç†ï¼Œå› ä¸ºå¼‚å¸¸å¤„ç†å¤ªæ…¢äº†ä¼šæ‹–ç´¯æˆ‘ä»¬çš„ç¨‹åºã€‚</span></p><p class="MsoListParagraph" align="left" style="margin-l : initial; background-repeat: initial;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#333333">2.<span style="font-stretch: normal; font-size: 7pt; line-height: normal; font-family: &quot;Times New Roman&quot;;">    </span></span><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#333333">å¦‚æœç‹¬ç«‹çš„è¯»å–å’Œå†™å…¥å‡½æ•°æ˜¯æ‰‹åŠ¨ç¼–è§£ç çš„ï¼Œé‚£ä¹ˆç»´æŠ¤å®ƒä»¬çœŸçš„æ˜¯ä¸€ä¸ªå™©æ¢¦ã€‚æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿä¸ºåŒ…ä¸€æ¬¡æ€§çš„ç¼–å†™å¥½åºåˆ—åŒ–ä»£ç å¹¶ä¸”æ²¡æœ‰ä»»ä½•è¿è¡Œæ—¶çš„æ€§èƒ½æ¶ˆè€—ï¼ˆä¸»è¦æ˜¯é¢å¤–çš„åˆ†æ”¯ã€è™šåŒ–ç­‰ç­‰ï¼‰ã€‚</span></p><p class="MsoNormal" align="left" style="line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æˆ‘ä»¬åº”è¯¥å¦‚ä½•å®ç°ä¸Šé¢çš„è¿™äº›ç›®æ ‡<span>? </span>è¯·ç»§ç»­é˜…è¯»ï¼Œæˆ‘å°†å‘ä½ å±•ç¤ºå¦‚ä½•ç”¨ï¼£ï¼‹ï¼‹æ¥å®ç°è¿™äº›åŠŸèƒ½ã€‚å¼€å‘å’Œå®Œå–„è¿™äº›æŠ€æœ¯èŠ±è´¹äº†æˆ‘ä¸å°‘æ—¶é—´ï¼Œæ‰€ä»¥æˆ‘å¸Œæœ›è¿™äº›å†…å®¹å¯¹ä½ æ¥è¯´æ˜¯æœ‰å¸®åŠ©çš„ï¼Œè‡³å°‘æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©å€¼å¾—è€ƒè™‘æ˜¯å¦è¦æ›¿æ¢ä½ ç›®å‰é‡‡ç”¨çš„æ–¹æ¡ˆï¼Œæˆ–è€…å¯ä»¥ä¸ä½ åœ¨å…¶ä»–æ¸¸æˆçœ‹åˆ°çš„è¿™ä¸ªé—®é¢˜è§£å†³æ–¹æ¡ˆç›¸ç»“åˆï¼Œçœ‹æ˜¯å¦èƒ½å¾—åˆ°æ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:10.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left"><span style="font-size:10.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><h2 id="ç»Ÿä¸€çš„æ•°æ®åŒ…åºåˆ—åŒ–åŠŸèƒ½"><span style="font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;">ç»Ÿä¸€çš„æ•°æ®åŒ…åºåˆ—åŒ–åŠŸèƒ½</span></h2><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">è®©æˆ‘ä»¬ä»æˆ‘ä»¬çš„ç›®æ ‡å¼€å§‹ã€‚è¿™å°±æ˜¯æˆ‘ä»¬åœ¨æœ¬æ–‡ç»“æŸçš„æ—¶å€™å¸Œæœ›å¾—åˆ°çš„ä¸œè¥¿ï¼š</span></p><div><div id="highlighter_882458" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">struct</code> <code class="cpp plain">PacketA</code></div><div class="line number2 index1 alt1"><code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">   </code><code class="cpp color1 bold">int</code> <code class="cpp plain">x,y,z;</code></div><div class="line number4 index3 alt1"><code class="cpp spaces"> </code> </div><div class="line number5 index4 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">template &lt;typename Stream&gt;</code> <code class="cpp color1 bold">bool</code> <code class="cpp plain">Serialize( Stream &amp; stream )</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">       </code><code class="cpp plain">serialize_bits( stream, x, 32 );</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">       </code><code class="cpp plain">serialize_bits( stream, y, 32 );</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">       </code><code class="cpp plain">serialize_bits( stream, z, 32 );</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number12 index11 alt1"><code class="cpp plain">};</code></div><div class="line number13 index12 alt2"><code class="cpp spaces"> </code> </div><div class="line number14 index13 alt1"><code class="cpp keyword bold">struct</code> <code class="cpp plain">PacketB</code></div><div class="line number15 index14 alt2"><code class="cpp plain">{</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">int</code> <code class="cpp plain">numElements;</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">   </code><code class="cpp color1 bold">int</code> <code class="cpp plain">elements[MaxElements];</code></div><div class="line number18 index17 alt1"><code class="cpp spaces"> </code> </div><div class="line number19 index18 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">template &lt;typename Stream&gt;</code> <code class="cpp color1 bold">bool</code> <code class="cpp plain">Serialize( Stream &amp; stream )</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">       </code><code class="cpp plain">serialize_int( stream, numElements, 0, MaxElements );</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; numElements; ++i )</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">           </code><code class="cpp plain">serialize_bits( buffer, elements[i], 32 );</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number26 index25 alt1"><code class="cpp plain">};</code></div><div class="line number27 index26 alt2"><code class="cpp spaces"> </code> </div><div class="line number28 index27 alt1"><code class="cpp keyword bold">struct</code> <code class="cpp plain">PacketC</code></div><div class="line number29 index28 alt2"><code class="cpp plain">{</code></div><div class="line number30 index29 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">bool</code> <code class="cpp plain">x;</code></div><div class="line number31 index30 alt2"><code class="cpp spaces">   </code><code class="cpp color1 bold">short</code> <code class="cpp plain">y;</code></div><div class="line number32 index31 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">int</code> <code class="cpp plain">z;</code></div><div class="line number33 index32 alt2"><code class="cpp spaces"> </code> </div><div class="line number34 index33 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">template &lt;typename Stream&gt;</code> <code class="cpp color1 bold">bool</code> <code class="cpp plain">Serialize( Stream &amp; stream )</code></div><div class="line number35 index34 alt2"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number36 index35 alt1"><code class="cpp spaces">       </code><code class="cpp plain">serialize_int( stream, x, 8 );</code></div><div class="line number37 index36 alt2"><code class="cpp spaces">       </code><code class="cpp plain">serialize_int( stream, y, 16 );</code></div><div class="line number38 index37 alt1"><code class="cpp spaces">       </code><code class="cpp plain">serialize_int( stream, z, 32 );</code></div><div class="line number39 index38 alt2"><code class="cpp spaces">       </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number40 index39 alt1"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number41 index40 alt2"><code class="cpp plain">};</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left"><br></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">çœ‹ä¸‹ä¸Šé¢çš„ä»£ç ç‰‡æ®µï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸ªæ•°æ®åŒ…ç»“æ„é‡Œé¢éƒ½åªæœ‰ä¸€ä¸ªå•ç‹¬çš„åºåˆ—åŒ–å‡½æ•°ï¼Œè€Œä¸æ˜¯æœ‰äº’ç›¸ç‹¬ç«‹çš„åºåˆ—åŒ–è¯»å–å’Œåºåˆ—åŒ–å†™å…¥å‡½æ•°ã€‚è¿™éå¸¸çš„æ£’ï¼å®ƒæŠŠæ•´ä¸ªåºåˆ—åŒ–ä»£ç ä¸€åˆ†ä¸ºäºŒï¼Œä½ å¯èƒ½éœ€è¦åšå¾ˆå¤šåŠªåŠ›æ¥å®ç°åºåˆ—åŒ–è¯»å–å’Œå†™å…¥ï¼ˆå› ä¸ºè¯»å–çš„è¿‡ç¨‹æ˜¯æ•°æ®è§£æå¹¶è£…å…¥æœ¬åœ°å†…å­˜ï¼Œå†™å…¥çš„çš„è¿‡ç¨‹æ˜¯å°†æœ¬åœ°çš„æ•°æ®å†™åˆ°æ¶ˆæ¯ä½“ï¼Œä¼šæœ‰æ¯”è¾ƒå¤§çš„å·®å¼‚ï¼Œæ‰€ä»¥ä»£ç åŸºæœ¬æ˜¯ä¸€åˆ†ä¸ºäºŒï¼Œä¸€åŠç”¨äºè¯»å–ï¼Œä¸€åŠç”¨äºå†™å…¥ï¼‰ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å¦‚æœè¦è®©è¿™é¡¹å·¥ä½œå˜å¾—æœ‰æ•ˆï¼Œè¯€çªåœ¨äºè®©æµç±»å‹çš„åºåˆ—åŒ–å‡½æ•°æ¨¡æ¿åŒ–ã€‚åœ¨æˆ‘çš„ç³»ç»Ÿä¸­æœ‰ä¸¤ä¸ªæµç±»å‹ï¼š<span>ReadStream</span>ç±»å’Œ<span>WriteStream</span>ç±»ã€‚æ¯ä¸ªç±»éƒ½æœ‰ç›¸åŒçš„ä¸€å¥—æ–¹æ³•ï¼Œä½†å®é™…ä¸Šå®ƒä»¬æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚ä¸€ä¸ªç±»è´Ÿè´£ä»æ¯”ç‰¹æµè¯»å–å€¼åˆ°å˜é‡ä¸­ï¼Œå¦å¤–ä¸€ä¸ªç±»è´Ÿè´£æŠŠå˜é‡çš„å€¼å†™åˆ°æµä¸­ã€‚<span>ReadStream</span>å’Œ<span>WriteStream</span>åªæ˜¯ä¸Šä¸€ç¯‡æ–‡ç« ä¸­<span>BitReader</span>å’Œ<span>BitWriter</span>ç±»çš„ä¸€ä¸ªé«˜å±‚æ¬¡å°è£…ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å½“ç„¶ä¹Ÿæœ‰å…¶ä»–æ–¹æ³•å¯ä»¥ç”¨æ¥ä»£æ›¿ã€‚å¦‚æœä½ ä¸å–œæ¬¢ç”¨æ¨¡æ¿çš„è¯ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªçº¯è™šçš„åŸºç±»ä½œä¸ºæµçš„æ¥å£ï¼Œç„¶ååˆ†åˆ«å®ç°è¯»å–å’Œå†™å…¥ç±»æ¥å®ç°è¿™ä¸ªæµæ¥å£ã€‚ä½†æ˜¯å¦‚æœä½ è¿™ä¹ˆåšçš„è¯ï¼Œå°±è¦åœ¨æ¯ä¸ªåºåˆ—åŒ–è°ƒç”¨çš„æ—¶å€™å‘ç”Ÿäº†ä¸€æ¬¡è™šå‡½æ•°è°ƒç”¨ã€‚è¿™ç§æ–¹æ³•å¯¹æˆ‘æ¥è¯´å¼€é”€ä¼¼ä¹æ¯”è¾ƒå¤§ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å®ç°è¿™ä¸ªåŠŸèƒ½çš„å¦å¤–ä¸€ç§æ–¹æ³•æ˜¯å®ç°ä¸€ä¸ªè¶…çº§æ£’çš„æµç±»å‹ï¼Œå¯ä»¥é€šè¿‡é…ç½®è€Œåœ¨è¿è¡Œæ—¶è¿›å…¥è¯»å–æˆ–è€…å†™å…¥æ¨¡å¼ã€‚è¿™ç§æ–¹æ³•ä¼šæ¯”è™šå‡½æ•°æ–¹æ³•å¿«ä¸€äº›ï¼Œä½†æ˜¯ä»ç„¶ä¼šåœ¨æ¯æ¬¡åºåˆ—åŒ–è°ƒç”¨çš„æ—¶å€™å­˜åœ¨åˆ†æ”¯åˆ¤æ–­åˆ°åº•åº”è¯¥æ˜¯è¯»è¿˜æ˜¯å†™ï¼Œæ‰€ä»¥å®ƒä¸å¦‚ç¡¬ç¼–ç è¯»å–å’Œå†™å…¥å‡½æ•°é‚£ä¹ˆå¿«ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æˆ‘æ›´å–œæ¬¢æ¨¡æ¿æ–¹æ³•ï¼Œå› ä¸ºå®ƒå¯ä»¥è®©ç¼–è¯‘å™¨ä¸ºé¡¹ç›®äº§ç”Ÿç»è¿‡ä¼˜åŒ–çš„è¯»å–<span>/</span>å†™å…¥å‡½æ•°ã€‚ä½ ç”šè‡³å¯ä»¥æŠŠåºåˆ—åŒ–ä»£ç ä¹Ÿè¿™æ ·å®ç°ä»¥ä¾¿è®©ç¼–è¯‘å™¨ä¸ºç‰¹å®šçš„è¯»å–å’Œå†™å…¥ä¼˜åŒ–ä¸€å¤§å †ä¸œè¥¿ï¼š</span></p><div><div id="highlighter_37287" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">struct RigidBody</code></div><div class="line number2 index1 alt1"><code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">   </code><code class="cpp plain">vec3f position;</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">   </code><code class="cpp plain">quat3f orientation;</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">   </code><code class="cpp plain">vec3f linear_velocity;</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">   </code><code class="cpp plain">vec3f angular_velocity;</code></div><div class="line number7 index6 alt2"><code class="cpp spaces"> </code> </div><div class="line number8 index7 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">template &lt;typename Stream&gt;</code> <code class="cpp color1 bold">bool</code> <code class="cpp plain">Serialize( Stream &amp; stream )</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">       </code><code class="cpp plain">serialize_vector( stream, position );</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">       </code><code class="cpp plain">serialize_quaternion( stream, orientation );</code></div><div class="line number12 index11 alt1"><code class="cpp spaces"> </code> </div><div class="line number13 index12 alt2"><code class="cpp spaces">       </code><code class="cpp color1 bold">bool</code> <code class="cpp plain">at_rest = Stream::IsWriting ? velocity.length() == 0 : 1;</code></div><div class="line number14 index13 alt1"><code class="cpp spaces"> </code> </div><div class="line number15 index14 alt2"><code class="cpp spaces">       </code><code class="cpp plain">serialize_bool( stream, at_rest );</code></div><div class="line number16 index15 alt1"><code class="cpp spaces"> </code> </div><div class="line number17 index16 alt2"><code class="cpp spaces">       </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( !at_rest )</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">       </code><code class="cpp plain">{</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">           </code><code class="cpp plain">serialize_vector( stream, linear_velocity );</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">           </code><code class="cpp plain">serialize_vector( stream, angular_velocity );</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">       </code><code class="cpp plain">}</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">else</code> <code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsReading )</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">       </code><code class="cpp plain">{</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">           </code><code class="cpp plain">linear_velocity = vec3f(0,0,0);</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">           </code><code class="cpp plain">angular_velocity = vec3f(0,0,0);</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">       </code><code class="cpp plain">}</code></div><div class="line number27 index26 alt2"><code class="cpp spaces"> </code> </div><div class="line number28 index27 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number30 index29 alt1"><code class="cpp plain">};</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left"><br></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">è™½ç„¶è¿™çœ‹èµ·æ¥å¾ˆæ²¡æœ‰æ•ˆç‡ï¼Œä½†æ˜¯å®é™…ä¸Šå¹¶ä¸æ˜¯ï¼è¿™ä¸ªå‡½æ•°ç»è¿‡æ¨¡æ¿ç‰¹åŒ–ä»¥åä¼šæ ¹æ®æµçš„ç±»å‹ä¼˜åŒ–äº†æ‰€æœ‰åˆ†æ”¯ã€‚è¿™å¾ˆæ•´é½æ¼‚äº®å§ï¼Ÿ</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><br><br>è€ŒReadStreamå’ŒWriteStreamæ˜¯è¿™æ ·çš„ ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class WriteStream</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line"></span><br><span class="line">    enum &#123; IsWriting = 1 &#125;;</span><br><span class="line">    enum &#123; IsReading = 0 &#125;;</span><br><span class="line">    // ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class ReadStream</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line"></span><br><span class="line">    enum &#123; IsWriting = 0 &#125;;</span><br><span class="line">    enum &#123; IsReading = 1 &#125;;</span><br><span class="line">    // ..</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><br><h2 id="è¾¹ç•Œæ£€æŸ¥å’Œç»ˆæ­¢è¯»å–"><span style="font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;">è¾¹ç•Œæ£€æŸ¥å’Œç»ˆæ­¢è¯»å–</span></h2><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ç°åœ¨æˆ‘ä»¬é€šè¿‡ç¼–è¯‘å™¨å®ç°äº†ç”Ÿæˆä¼˜åŒ–è¿‡çš„åºåˆ—åŒ–è¯»å–<span>/</span>å†™å…¥å‡½æ•°ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€äº›æ–¹æ³•æ¥åšåºåˆ—åŒ–è¯»å–æ—¶å€™çš„è‡ªåŠ¨é”™è¯¯æ£€æµ‹ä»¥ä¾¿è®©æˆ‘ä»¬ä¸å—æ¶æ„ç½‘ç»œåŒ…çš„å½±å“ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹æƒ…æ˜¯æŠŠå…è®¸çš„å¤§å°èŒƒå›´ä¹Ÿä¼ ç»™åºåˆ—åŒ–å‡½æ•°è€Œä¸ä»…ä»…æ˜¯æ‰€éœ€çš„æ¯”ç‰¹æ•°é‡ã€‚è¯•æƒ³ä¸€ä¸‹å¦‚æœæœ‰äº†æœ€å°å’Œæœ€å¤§çš„èŒƒå›´ï¼Œåºåˆ—åŒ–å‡½æ•°å°±èƒ½è‡ªå·±ç®—å‡ºæ‰€éœ€çš„æ¯”ç‰¹æ•°é‡ï¼š</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:10.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">serialize_int(stream, numElements, 0, MaxElements );</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">è¿™ç§åšæ³•å¼€è¾Ÿäº†ä¸€ç±»æ–°çš„æ–¹æ³•ï¼Œå¯ä»¥éå¸¸å®¹æ˜“åœ°æ”¯æŒå¸¦ç¬¦å·æ•´æ•°çš„åºåˆ—åŒ–å¹¶ä¸”åºåˆ—åŒ–å‡½æ•°å¯ä»¥æ£€æµ‹ä»ç½‘ç»œä¸­è¯»å–çš„å€¼å¹¶ç¡®ä¿è¿™ä¸ªå€¼ä¸€å®šåœ¨æœŸæœ›çš„èŒƒå›´å†…ã€‚å¦‚æœè¿™ä¸ªå€¼è¶…å‡ºèŒƒå›´äº†ï¼Œå°±ç«‹å³ä¸­æ­¢åºåˆ—åŒ–è¯»å–å¹¶ä¸¢å¼ƒè¿™ä¸ªæ•°æ®åŒ…ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å› ä¸ºæˆ‘ä»¬æ²¡æœ‰åŠæ³•ä½¿ç”¨å¼‚å¸¸æ¥å¤„ç†è¿™ç§ä¸­æ­¢ï¼ˆå› ä¸ºå¼‚å¸¸å¤ªæ…¢äº†ï¼‰ï¼Œæ‰€ä»¥ä¸Šé¢çš„æ–¹å¼æ˜¯æˆ‘æ¯”è¾ƒå–œæ¬¢çš„å¤„ç†æ–¹å¼ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">åœ¨æˆ‘çš„ç¯å¢ƒä¸­ï¼Œ<span>serialize_int</span>å…¶å®å¹¶ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå®é™…æ˜¯ä¸€ä¸ªå¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºçš„å®ï¼š</span></p><div><div id="highlighter_611774" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp preprocessor">#define serialize_int( stream, value, min, max)                   \</code></div><div class="line number2 index1 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">do</code>                                                             <code class="cpp plain">\</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">   </code><code class="cpp plain">{                                                              \</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">       </code><code class="cpp functions bold">assert</code><code class="cpp plain">( min &lt; max);                                       \</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">       </code><code class="cpp plain">int32_tint32_value;                                       \</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsWriting)                                   \</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">       </code><code class="cpp plain">{                                                          \</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">           </code><code class="cpp functions bold">assert</code><code class="cpp plain">( value &gt;= min);                                \</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">           </code><code class="cpp functions bold">assert</code><code class="cpp plain">( value &lt;= max);                                 \</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">           </code><code class="cpp plain">int32_value = (int32_t)value;                         \</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">       </code><code class="cpp plain">}                                                          \</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( !stream.SerializeInteger( int32_value, min, max ) )    \</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">           </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">false</code><code class="cpp plain">;                                          \</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsReading)                                   \</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">       </code><code class="cpp plain">{                                                          \</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">           </code><code class="cpp plain">value =int32_value;                                   \</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">           </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( value &lt; min || value &gt; max)                      \</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">               </code><code class="cpp plain">return false;                                      \</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">       </code><code class="cpp plain">}                                                          \</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">    </code><code class="cpp plain">} </code><code class="cpp keyword bold">while</code> <code class="cpp plain">(0)</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left"><br></p><p class="MsoNormal" align="left" style="margin: 0cm 18.05pt 0.0001pt; line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span style="color: rgb(34, 34, 34); font-family: å¾®è½¯é›…é»‘, sans-serif; font-size: 12pt;">æˆ‘è®©äººè§‰å¾—ææ€–å®³æ€•çš„åŸå› æ˜¯æˆ‘ç«Ÿç„¶ä½¿ç”¨äº†å®æ¥æ’å…¥ä»£ç æ¥æ£€æµ‹</span><span style="color: rgb(34, 34, 34); font-family: å¾®è½¯é›…é»‘, sans-serif; font-size: 12pt;">SerializeInteger</span><span style="color: rgb(34, 34, 34); font-family: å¾®è½¯é›…é»‘, sans-serif; font-size: 12pt;">å‡½æ•°çš„ç»“æœä»¥åŠåœ¨å‘ç”Ÿé”™è¯¯çš„æ—¶å€™è¿”å›</span><span style="color: rgb(34, 34, 34); font-family: å¾®è½¯é›…é»‘, sans-serif; font-size: 12pt;">false</span><span style="color: rgb(34, 34, 34); font-family: å¾®è½¯é›…é»‘, sans-serif; font-size: 12pt;">ã€‚è¿™ä¼šè®©äººæ„Ÿè§‰åˆ°è¿™ç§è¡Œä¸ºå’Œå¼‚å¸¸å¤„ç†å¾ˆåƒï¼Œå®ƒä¼šåœ¨å‡ºé”™çš„æ—¶å€™å›æº¯å †æ ˆåˆ°åºåˆ—åŒ–è°ƒç”¨å †æ ˆçš„æœ€é¡¶ä¸Šï¼Œä½†æ˜¯è¿™ç§å¤„ç†ä¸ä¼šå¸¦æ¥ä»»ä½•çš„é—®é¢˜æ¯”å¦‚æ€§èƒ½çš„æ¶ˆè€—ã€‚åœ¨å›æº¯çš„æ—¶å€™å‡ºç°åˆ†æ”¯æ˜¯éå¸¸ç½•è§çš„ï¼ˆåºåˆ—åŒ–é”™è¯¯éå¸¸å°‘è§ï¼‰æ‰€ä»¥åˆ†æ”¯é¢„æµ‹åº”è¯¥ä¸ä¼šå¸¦æ¥ä»€ä¹ˆæ€§èƒ½ä¸Šçš„é—®é¢˜ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">è¿˜æœ‰ä¸€ç§æƒ…å†µæˆ‘ä»¬ä¹Ÿéœ€è¦ä¸­æ­¢åºåˆ—åŒ–è¯»å–ï¼šå¦‚æœæµè¯»å–è¶…å‡ºäº†ç»“å°¾ã€‚è¿™ç§æƒ…å†µå…¶å®ä¹Ÿæ˜¯éå¸¸ç½•è§çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¿…é¡»åœ¨æ¯æ¬¡åºåˆ—åŒ–æ“ä½œéƒ½è¿›è¡Œè¿™ä¸ªæ£€æŸ¥ï¼Œè¿™æ˜¯å› ä¸ºæµè¯»å–è¶…å‡ºç»“å°¾ä¼šé€ æˆçš„å½±å“æ˜¯æœªå®šä¹‰çš„ï¼ˆä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯¹äºå®ƒèƒ½é€ æˆä»€ä¹ˆæ ·å­çš„ç»“æœå®Œå…¨æ˜¯æœªçŸ¥çš„ï¼Œæœ€ç³Ÿç³•çš„æƒ…å†µå¹¶ä¸æ˜¯ä»£ç å´©æºƒï¼Œè€Œæ˜¯æŠŠæˆ‘ä»¬çš„å†…å®¹æ•°æ®å®Œå…¨æä¹±äº†ï¼Œç›¸ä¿¡æˆ‘ï¼Œä½ ä¼šæ— æ¯”ç—›æ¨è¿™ä»¶äº‹æƒ…ï¼‰ã€‚å¦‚æœæˆ‘ä»¬æ²¡æœ‰åšè¿™ä¸ªæ£€æµ‹ï¼Œå¯èƒ½ä¼šå‡ºç°ç¨‹åºæ— é™å¾ªç¯çš„æƒ…å†µï¼Œå› ä¸ºè¯»å–çš„ä½ç½®è¶…å‡ºäº†ç¼“å†²åŒºçš„ç»“å°¾ã€‚è™½ç„¶åœ¨è¯»å–çš„æ—¶å€™å¦‚æœå‘ç°è¶…å‡ºæ¯”ç‰¹æµç»“å°¾çš„æ—¶å€™è¿”å›<span>0</span>å€¼æ˜¯å¾ˆå¸¸è§çš„åšæ³•ï¼ˆå¦‚ä»¥å‰çš„æ–‡ç« æåˆ°çš„é‚£æ ·ï¼‰ï¼Œä½†æ˜¯è¿”å›<span>0</span>å€¼ä¹Ÿä¸èƒ½ä¿è¯åºåˆ—åŒ–å‡½æ•°åœ¨æœ‰å¾ªç¯çš„æ—¶å€™èƒ½å¤Ÿæ­£ç¡®çš„ä¸­æ­¢ã€‚å¦‚æœè¦ç¡®ä¿ç¨‹åºæ˜¯æœ‰è‰¯å¥½å®šä¹‰çš„è¡Œä¸ºï¼Œé‚£ä¹ˆè¿™ç§ç¼“å†²æº¢å‡ºæ£€æµ‹æ€»æ˜¯å¿…é¡»çš„ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æœ€åä¸€ç‚¹ï¼Œåœ¨åºåˆ—åŒ–å†™å…¥çš„æ—¶å€™å¦‚æœé‡åˆ°èŒƒå›´æ£€æµ‹å¤±è´¥æˆ–è€…å†™å…¥çš„åœ°å€è¶…å‡ºæµçš„ç»“å°¾çš„æ—¶å€™ï¼Œæˆ‘å¹¶æ²¡æœ‰é‡‡ç”¨ä¸­æ­¢è¿™ç§åšæ³•ã€‚åœ¨å†™å…¥æ•°æ®çš„æ—¶å€™ä½ å¯èƒ½ä¼šè½»æ¾å¾ˆå¤šï¼Œå› ä¸ºå¦‚æœæœ‰ä»»ä½•äº‹æƒ…å‡ºé”™äº†ï¼Œé‚£å‡ ä¹è‚¯å®šæ˜¯ä½ è‡ªå·±å¯¼è‡´çš„é”™è¯¯ã€‚åœ¨åºåˆ—åŒ–å†™å…¥çš„æ—¶å€™æˆ‘ä»¬åªæ˜¯å¯¹æ¯ä¸ªåºåˆ—åŒ–å†™å…¥åšäº†æ–­è¨€æ¥ç¡®ä¿ä¸€åˆ‡æ˜¯ç¬¦åˆé¢„æœŸçš„ï¼ˆåœ¨èŒƒå›´å†…ã€å†™å…¥çš„åœ°å€æ²¡æœ‰è¶…å‡ºæµçš„ç»“å°¾ï¼‰ï¼Œå…¶ä»–çš„ä¸€åˆ‡éƒ½ä»»ç”±ä½ æ¥å‘æŒ¥ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><h2 id="åºåˆ—åŒ–æµ®ç‚¹æ•°å’Œå‘é‡"><span style="font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;">åºåˆ—åŒ–æµ®ç‚¹æ•°å’Œå‘é‡</span></h2><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">è¿™ä¸ªæ¯”ç‰¹æµç°åœ¨åªåºåˆ—åŒ–ç±»å‹æ•´æ•°çš„å€¼ã€‚å¦‚æœæˆ‘ä»¬è¦åºåˆ—åŒ–ä¸€ä¸ªç±»å‹ä¸ºæµ®ç‚¹æ•°çš„å€¼ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆåšï¼Ÿ</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æˆ‘ä»¬çš„åšæ³•è™½ç„¶çœ‹ä¸Šå»æœ‰ç‚¹æŠ•æœºå–å·§ä½†å®é™…ä¸Šå¹¶ä¸æ˜¯ã€‚åœ¨å†…å­˜ä¸­æµ®ç‚¹æ•°ä¹Ÿæ˜¯åƒæ•´æ•°é‚£æ ·ä¿å­˜æˆä¸€ä¸ª<span>32</span>ä½çš„å€¼ã€‚ä½ çš„è®¡ç®—æœºæ ¹æœ¬ä¸çŸ¥é“å†…å­˜ä¸­çš„è¿™ä¸ª<span>32</span>ä½çš„å€¼åˆ°åº•æ˜¯ä¸€ä¸ªæ•´æ•°è¿˜æ˜¯ä¸€ä¸ªæµ®ç‚¹æ•°è¿˜æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²çš„éƒ¨åˆ†ã€‚å®ƒçŸ¥é“çš„å°±æ˜¯è¿™ä»…ä»…æ˜¯ä¸€ä¸ª<span>32</span>ä½çš„å€¼ã€‚å¹¸è¿çš„æ˜¯ï¼Œ<span>C++</span>è¯­è¨€ä½¿å¾—æˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¹è¿™ä¸ªåŸºç¡€å±æ€§è¿›è¡Œæ§åˆ¶ï¼ˆå…¶ä»–è¯­è¨€ä¸è¡Œï¼Œå› ä¸ºåº•å±‚è¢«å°è£…æ‰äº†ï¼Œè¿™ä¹Ÿæ˜¯<span>C++</span>è¢«è®¤ä¸ºä¸å¥½çš„åœ°æ–¹ä¹‹ä¸€ï¼Œå¾ˆå¤šç°ä»£è¯­è¨€éƒ½ç¦æ­¢äº†è¿™ç§åšæ³•ï¼‰ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ä½ å¯ä»¥é€šè¿‡ä¸€ä¸ªè”åˆä½“æ¥è®¿é—®çœ‹ä¸Šå»æ˜¯æ•´æ•°çš„æµ®ç‚¹æ•°ï¼š</span></p><div><div id="highlighter_59188" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">union</code> <code class="cpp plain">FloatInt</code></div><div class="line number2 index1 alt1"><code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">   </code><code class="cpp color1 bold">float</code> <code class="cpp plain">float_value;</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">   </code><code class="cpp plain">uint32_t int_value;</code></div><div class="line number5 index4 alt2"><code class="cpp plain">};</code></div><div class="line number6 index5 alt1"><code class="cpp spaces"> </code> </div><div class="line number7 index6 alt2"><code class="cpp plain">FloatInt tmp;</code></div><div class="line number8 index7 alt1"><code class="cpp plain">tmp.float_value= 10.0f;</code></div><div class="line number9 index8 alt2"><code class="cpp functions bold">printf</code><code class="cpp plain">(</code><code class="cpp string">â€œfloat value as an integer: %x\nâ€</code><code class="cpp plain">, tmp.int_value );</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left"><br></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ä½ ä¹Ÿå¯ä»¥é€šè¿‡åˆ«å<span>uint32_t<em></em></span>çš„æŒ‡é’ˆæ¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½†æ˜¯å› ä¸º<span>GCC -O2</span>ä¼šå¯¼è‡´è¿™ç§åšæ³•æœ‰äº›æ€§èƒ½é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘æ›´å€¾å‘äºä½¿ç”¨è”åˆä½“è¿™ç§åšæ³•ã€‚æˆ‘çš„æœ‹å‹ä»¬æŒ‡å‡ºï¼ˆå¾ˆæœ‰å¯èƒ½æ˜¯æ­£ç¡®çš„ï¼‰ä»ä¸€ä¸ªæ•´æ•°ç±»å‹çš„å€¼è½¬æ¢åˆ°æµ®ç‚¹å€¼çš„å”¯ä¸€çœŸæ­£æ ‡å‡†çš„åšæ³•æ˜¯å°†æµ®ç‚¹æ•°æŒ‡é’ˆè½¬æ¢æˆ<span>uint8_t</span>æŒ‡é’ˆç„¶åé€šè¿‡è¿™ä¸ªå­—èŠ‚æŒ‡é’ˆæ¥åˆ†åˆ«å¼•ç”¨<span>4</span>ä¸ªå­—èŠ‚æ¥å¯¹è¿™ä¸ªå€¼è¿›è¡Œé‡å»ºã€‚è™½ç„¶è¿™å¯¹æˆ‘æ¥è¯´ä¼¼ä¹æ˜¯ä¸€ä¸ªéå¸¸æ„šè ¢çš„åšæ³•ã€‚å¥³å£«ä»¬ï¼Œå…ˆç”Ÿä»¬ã€‚ã€‚ã€‚è¿™æ¯•ç«Ÿæ˜¯<span>C++</span>å•Šï¼ï¼ˆä½œè€…çš„æ„æ€æ˜¯<span>C++</span>æä¾›äº†å¾ˆå¤šæ¥è§¦åº•å±‚çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å°½æƒ…åˆ©ç”¨è¿™ä¸€ä¼˜åŠ¿ï¼Œåªè¦èƒ½ä¿è¯ç»“æœæ˜¯æ­£ç¡®çš„å°±å¯ä»¥äº†ï¼Œå“ªæ€•ä½¿ç”¨ä¸€äº›å–å·§çš„åŠæ³•ä¹Ÿæ— æ‰€è°“ï¼ï¼‰ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:10.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ä¸æ­¤åŒæ—¶ï¼Œåœ¨è¿‡å»çš„<span>5</span>å¹´é‡Œï¼Œåœ¨ä½¿ç”¨è”åˆä½“è¿™ä¸ªæŠ€å·§æ–¹é¢æˆ‘è¿˜æ²¡æœ‰é‡åˆ°è¿‡ä»€ä¹ˆé—®é¢˜ã€‚ä¸‹é¢æ˜¯æˆ‘å¦‚ä½•åºåˆ—åŒ–ä¸€ä¸ªæœªå‹ç¼©çš„æµ®ç‚¹å€¼ï¼š</span></p><div><div id="highlighter_22654" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">template &lt;typename Stream&gt;</code></div><div class="line number2 index1 alt1"><code class="cpp plain">bool serialize_float_internal( Stream &amp; stream,</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">                              </code><code class="cpp color1 bold">float</code> <code class="cpp plain">&amp; value )</code></div><div class="line number4 index3 alt1"><code class="cpp plain">{</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">union</code> <code class="cpp plain">FloatInt</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">       </code><code class="cpp color1 bold">float</code> <code class="cpp plain">float_value;</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">       </code><code class="cpp plain">uint32_t int_value;</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">   </code><code class="cpp plain">};</code></div><div class="line number10 index9 alt1"><code class="cpp spaces"> </code> </div><div class="line number11 index10 alt2"><code class="cpp spaces">   </code><code class="cpp plain">FloatInt tmp;</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsWriting )</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">       </code><code class="cpp plain">tmp.float_value = value;</code></div><div class="line number14 index13 alt1"><code class="cpp spaces"> </code> </div><div class="line number15 index14 alt2"><code class="cpp spaces">   </code><code class="cpp color1 bold">bool</code> <code class="cpp plain">result = stream.SerializeBits( tmp.int_value, 32 );</code></div><div class="line number16 index15 alt1"><code class="cpp spaces"> </code> </div><div class="line number17 index16 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsReading )</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">       </code><code class="cpp plain">value = tmp.float_value;</code></div><div class="line number19 index18 alt2"><code class="cpp spaces"> </code> </div><div class="line number20 index19 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">return</code> <code class="cpp plain">result;</code></div><div class="line number21 index20 alt2"><code class="cpp plain">}</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left" style="margin: 0cm 18.05pt 0.0001pt; line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><br></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">é€šè¿‡ä¸€ä¸ª<span>serialize_float</span>å®æ¥åŒ…è£…è¿™ä¸ªéƒ¨åˆ†ä»¥æ–¹ä¾¿åœ¨åºåˆ—åŒ–è¯»å–çš„æ—¶å€™æ–¹ä¾¿è¿›è¡Œä¸€è‡´çš„é”™è¯¯æ£€æµ‹ï¼š</span></p><div><div id="highlighter_519243" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp preprocessor">#define serialize_float( stream, value)                            \</code></div><div class="line number2 index1 alt1"><code class="cpp spaces"> </code><code class="cpp keyword bold">do</code>                                                                <code class="cpp plain">\</code></div><div class="line number3 index2 alt2"><code class="cpp spaces"> </code><code class="cpp plain">{                                                                 \</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( !protocol2::serialize_float_internal( stream, value ))     \</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">       </code><code class="cpp plain">return false;                                               \</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">  </code><code class="cpp plain">} </code><code class="cpp keyword bold">while</code><code class="cpp plain">(0)</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left"><br></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æœ‰äº›æ—¶å€™ï¼Œä½ å¹¶ä¸æƒ³æŠŠä¸€ä¸ªå®Œæ•´ç²¾åº¦çš„æµ®ç‚¹æ•°è¿›è¡Œä¼ é€’ã€‚é‚£ä¹ˆè¯¥å¦‚ä½•å‹ç¼©è¿™ä¸ªæµ®ç‚¹å€¼ï¼Ÿç¬¬ä¸€æ­¥æ˜¯å°†å®ƒçš„å€¼é™åˆ¶åœ¨æŸä¸ªç¡®å®šçš„èŒƒå›´å†…ç„¶åç”¨ä¸€ä¸ªæ•´æ•°è¡¨ç¤ºæ–¹å¼æ¥å°†å®ƒé‡åŒ–ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼Œå¦‚æœä½ çŸ¥é“ä¸€ä¸ªæµ®ç‚¹ç±»å‹çš„å€¼æ˜¯åœ¨åŒºé—´<span>[-10,+10]</span>ï¼Œå¯¹äºè¿™ä¸ªå€¼æ¥è¯´å¯ä»¥æ¥å—çš„ç²¾ç¡®åº¦æ˜¯<span>0.01</span>ï¼Œé‚£ä¹ˆä½ å¯ä»¥æŠŠè¿™ä¸ªæµ®ç‚¹æ•°ä¹˜ä»¥<span>100.0</span>è®©å®ƒçš„å€¼åœ¨åŒºé—´<span>[-1000,+1000]</span>å¹¶åœ¨ç½‘ç»œä¸Šå°†å…¶ä½œä¸ºä¸€ä¸ªæ•´æ•°è¿›è¡Œåºåˆ—åŒ–ã€‚è€Œåœ¨æ¥æ”¶çš„é‚£ä¸€ç«¯ï¼Œä»…ä»…éœ€è¦å°†å®ƒé™¤ä»¥<span>100.0</span>æ¥å¾—åˆ°æœ€åˆçš„æµ®ç‚¹å€¼ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ä¸‹é¢æ˜¯è¿™ä¸ªæ¦‚å¿µç”¨åºåˆ—åŒ–å®ç°çš„ç‰ˆæœ¬ï¼š</span></p><div><div id="highlighter_981553" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">template &lt;typename Stream&gt;</code></div><div class="line number2 index1 alt1"><code class="cpp plain">boolserialize_compressed_float_internal( Stream &amp; stream,</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">                                         </code><code class="cpp color1 bold">float</code> <code class="cpp plain">&amp; value,</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">                                         </code><code class="cpp color1 bold">float</code> <code class="cpp plain">min,</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">                                         </code><code class="cpp color1 bold">float</code> <code class="cpp plain">max,</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">                                         </code><code class="cpp color1 bold">float</code> <code class="cpp plain">res )</code></div><div class="line number7 index6 alt2"><code class="cpp plain">{</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">const</code> <code class="cpp color1 bold">float</code> <code class="cpp plain">delta = max - min;</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">const</code> <code class="cpp color1 bold">float</code> <code class="cpp plain">values = delta / res;</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">const</code> <code class="cpp plain">uint32_t maxIntegerValue = (uint32_t) </code><code class="cpp functions bold">ceil</code><code class="cpp plain">( values );</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">const</code> <code class="cpp color1 bold">int</code> <code class="cpp plain">bits = bits_required( 0, maxIntegerValue );</code></div><div class="line number12 index11 alt1"><code class="cpp spaces"> </code> </div><div class="line number13 index12 alt2"><code class="cpp spaces">   </code><code class="cpp plain">uint32_t integerValue = 0;</code></div><div class="line number14 index13 alt1"><code class="cpp spaces"> </code> </div><div class="line number15 index14 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsWriting )</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">       </code><code class="cpp color1 bold">float</code> <code class="cpp plain">normalizedValue =</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">           </code><code class="cpp plain">clamp( ( value - min ) / delta, 0.0f, 1.0f );</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">       </code><code class="cpp plain">integerValue = (uint32_t) </code><code class="cpp functions bold">floor</code><code class="cpp plain">( normalizedValue <em></em></code></div><div class="line number20 index19 alt1"><code class="cpp spaces">                                        </code><code class="cpp plain">maxIntegerValue + 0.5f );</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number22 index21 alt1"><code class="cpp spaces"> </code> </div><div class="line number23 index22 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( !stream.SerializeBits( integerValue, bits ) )</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">false</code><code class="cpp plain">;</code></div><div class="line number25 index24 alt2"><code class="cpp spaces"> </code> </div><div class="line number26 index25 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsReading )</code></div><div class="line number27 index26 alt2"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number28 index27 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">const</code> <code class="cpp color1 bold">float</code> <code class="cpp plain">normalizedValue =</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">           </code><code class="cpp plain">integerValue / </code><code class="cpp color1 bold">float</code><code class="cpp plain">( maxIntegerValue );</code></div><div class="line number30 index29 alt1"><code class="cpp spaces">       </code><code class="cpp plain">value = normalizedValue  delta + min;</code></div><div class="line number31 index30 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number32 index31 alt1"><code class="cpp spaces"> </code> </div><div class="line number33 index32 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number34 index33 alt1"><code class="cpp plain">}</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left" style="margin: 0cm 18.05pt 0.0001pt; line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><br></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ä¸€æ—¦ä½ å®ç°äº†å¯¹æµ®ç‚¹æ•°çš„åºåˆ—åŒ–ï¼Œé‚£ä¹ˆå°†æ–¹æ³•æ‹“å±•ä¸‹é€šè¿‡ç½‘ç»œåºåˆ—åŒ–å‘é‡å’Œå››å…ƒæ•°å°±éå¸¸å®¹æ˜“äº†ã€‚æˆ‘åœ¨æˆ‘è‡ªå·±çš„é¡¹ç›®ä¸­ä½¿ç”¨äº†è¿™ä¸ªè¶…èµçš„é’ˆå¯¹å‘é‡æ•°å­¦çš„å‘é‡åº“ï¼ˆ<span><a href="https://github.com/scoopr/vectorial" target="_blank" rel="noopener">https://github.com/scoopr/vectorial</a></span>ï¼‰çš„ä¸€ä¸ªä¿®æ”¹ç‰ˆæœ¬ï¼Œå¹¶ä¸”æˆ‘å¯¹è¿™äº›ç±»å‹å®ç°çš„åºåˆ—åŒ–æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</span></p><div><div id="highlighter_3804" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">template &lt;typename Stream&gt;</code></div><div class="line number2 index1 alt1"><code class="cpp plain">boolserialize_vector_internal( Stream &amp; stream,</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">                               </code><code class="cpp plain">vec3f &amp; vector )</code></div><div class="line number4 index3 alt1"><code class="cpp plain">{</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">   </code><code class="cpp color1 bold">float</code> <code class="cpp plain">values[3];</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsWriting )</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">       </code><code class="cpp plain">vector.store( values );</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">   </code><code class="cpp plain">serialize_float( stream, values[0] );</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">   </code><code class="cpp plain">serialize_float( stream, values[1] );</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">   </code><code class="cpp plain">serialize_float( stream, values[2] );</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsReading )</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">       </code><code class="cpp plain">vector.load( values );</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number14 index13 alt1"><code class="cpp plain">}</code></div><div class="line number15 index14 alt2"><code class="cpp spaces"> </code> </div><div class="line number16 index15 alt1"><code class="cpp keyword bold">template &lt;typename Stream&gt;</code></div><div class="line number17 index16 alt2"><code class="cpp plain">boolserialize_quaternion_internal( Stream &amp; stream,</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">                                   </code><code class="cpp plain">quat4f &amp; quaternion )</code></div><div class="line number19 index18 alt2"><code class="cpp plain">{</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">float</code> <code class="cpp plain">values[4];</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsWriting )</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">       </code><code class="cpp plain">quaternion.store( values );</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">   </code><code class="cpp plain">serialize_float( stream, values[0] );</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">   </code><code class="cpp plain">serialize_float( stream, values[1] );</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">   </code><code class="cpp plain">serialize_float( stream, values[2] );</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">   </code><code class="cpp plain">serialize_float( stream, values[3] );</code></div><div class="line number27 index26 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsReading )</code></div><div class="line number28 index27 alt1"><code class="cpp spaces">       </code><code class="cpp plain">quaternion.load( values );</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number30 index29 alt1"><code class="cpp plain">}</code></div><div class="line number31 index30 alt2"><code class="cpp spaces"> </code> </div><div class="line number32 index31 alt1"><code class="cpp preprocessor">#defineserialize_vector( stream, value)                      \</code></div><div class="line number33 index32 alt2"><code class="cpp spaces"> </code><code class="cpp keyword bold">do</code>                                                            <code class="cpp plain">\</code></div><div class="line number34 index33 alt1"><code class="cpp spaces"> </code><code class="cpp plain">{                                                             \</code></div><div class="line number35 index34 alt2"><code class="cpp spaces">    </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( !serialize_vector_internal( stream, value ))         \</code></div><div class="line number36 index35 alt1"><code class="cpp spaces">        </code><code class="cpp plain">return false;                                         \</code></div><div class="line number37 index36 alt2"><code class="cpp spaces"> </code><code class="cpp plain">}                                                             \</code></div><div class="line number38 index37 alt1"><code class="cpp spaces"> </code><code class="cpp keyword bold">while</code><code class="cpp plain">(0)</code></div><div class="line number39 index38 alt2"><code class="cpp spaces"> </code> </div><div class="line number40 index39 alt1"><code class="cpp preprocessor">#defineserialize_quaternion( stream, value)                  \</code></div><div class="line number41 index40 alt2"><code class="cpp spaces"> </code><code class="cpp keyword bold">do</code>                                                            <code class="cpp plain">\</code></div><div class="line number42 index41 alt1"><code class="cpp spaces"> </code><code class="cpp plain">{                                                             \</code></div><div class="line number43 index42 alt2"><code class="cpp spaces">    </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( !serialize_quaternion_internal( stream, value ) )    \</code></div><div class="line number44 index43 alt1"><code class="cpp spaces">        </code><code class="cpp plain">return false;                                         \</code></div><div class="line number45 index44 alt2"><code class="cpp spaces"> </code><code class="cpp plain">}                                                             \</code></div><div class="line number46 index45 alt1"><code class="cpp spaces"> </code><code class="cpp keyword bold">while</code><code class="cpp plain">(0)</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left"><br></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å¦‚æœä½ çŸ¥é“ä½ çš„å‘é‡çš„å–å€¼ä¼šé™åˆ¶åœ¨æŸä¸ªèŒƒå›´å†…ï¼Œä½ å¯ä»¥åƒä¸‹é¢è¿™æ ·å¯¹å®ƒè¿›è¡Œå‹ç¼©ï¼š</span></p><div><div id="highlighter_90817" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">template &lt;typename Stream&gt;</code> <code class="cpp plain">&lt;</code><code class="cpp keyword bold">typename</code> <code class="cpp plain">stream=</code><code class="cpp string">â€œâ€</code><code class="cpp plain">&gt;</code></div><div class="line number2 index1 alt1"> </div><div class="line number3 index2 alt2"><code class="cpp color1 bold">bool</code> <code class="cpp plain">serialize_compressed_vector_internal( Stream &amp; stream,</code></div><div class="line number4 index3 alt1"> </div><div class="line number5 index4 alt2"><code class="cpp spaces">                                           </code><code class="cpp plain">vec3f &amp; vector,</code></div><div class="line number6 index5 alt1"> </div><div class="line number7 index6 alt2"><code class="cpp spaces">                                           </code><code class="cpp color1 bold">float</code> <code class="cpp plain">min,</code></div><div class="line number8 index7 alt1"> </div><div class="line number9 index8 alt2"><code class="cpp spaces">                                           </code><code class="cpp color1 bold">float</code> <code class="cpp plain">max,</code></div><div class="line number10 index9 alt1"> </div><div class="line number11 index10 alt2"><code class="cpp spaces">                                           </code><code class="cpp color1 bold">float</code> <code class="cpp plain">res )</code></div><div class="line number12 index11 alt1"> </div><div class="line number13 index12 alt2"><code class="cpp plain">{</code></div><div class="line number14 index13 alt1"> </div><div class="line number15 index14 alt2"><code class="cpp spaces">    </code><code class="cpp color1 bold">float</code> <code class="cpp plain">values[3];</code></div><div class="line number16 index15 alt1"> </div><div class="line number17 index16 alt2"><code class="cpp spaces">    </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsWriting )</code></div><div class="line number18 index17 alt1"> </div><div class="line number19 index18 alt2"><code class="cpp spaces">        </code><code class="cpp plain">vector.store( values );</code></div><div class="line number20 index19 alt1"> </div><div class="line number21 index20 alt2"><code class="cpp spaces">    </code><code class="cpp plain">serialize_compressed_float( stream, values[0], min, max, res );</code></div><div class="line number22 index21 alt1"> </div><div class="line number23 index22 alt2"><code class="cpp spaces">    </code><code class="cpp plain">serialize_compressed_float( stream, values[1], min, max, res );</code></div><div class="line number24 index23 alt1"> </div><div class="line number25 index24 alt2"><code class="cpp spaces">    </code><code class="cpp plain">serialize_compressed_float( stream, values[2], min, max, res );</code></div><div class="line number26 index25 alt1"> </div><div class="line number27 index26 alt2"><code class="cpp spaces">    </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsReading )</code></div><div class="line number28 index27 alt1"> </div><div class="line number29 index28 alt2"><code class="cpp spaces">        </code><code class="cpp plain">vector.load( values );</code></div><div class="line number30 index29 alt1"> </div><div class="line number31 index30 alt2"><code class="cpp spaces">    </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number32 index31 alt1"> </div><div class="line number33 index32 alt2"><code class="cpp plain">}&lt;/</code><code class="cpp keyword bold">typename</code><code class="cpp plain">&gt;</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left"><br></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ä½ å¦‚æœæƒ³è¦åœ¨ç½‘ç»œä¸Šå‹ç¼©ä¸€ä¸ªæ–¹å‘ï¼Œä¸è¦æŠŠå®ƒè§†ä¸ºå››ä¸ªå–å€¼èŒƒå›´åœ¨<span>[-1,+1]</span>çš„æˆå‘˜å˜é‡çš„ç»“æ„ã€‚å¦‚æœä½¿ç”¨è¿™ä¸ªå››å…ƒæ•°çš„ä¸‰ä¸ªæœ€å°å€¼æ¥è¡¨ç¤ºå®ƒæ•ˆæœä¼šå¥½çš„å¤šï¼Œè¯·çœ‹ä¸‹è¿™ç¯‡æ–‡ç« çš„ç¤ºä¾‹ä»£ç <span>(</span>åœ°å€åœ¨<span><a href="https://www.patreon.com/gafferongames?ty=h" target="_blank" rel="noopener">https://www.patreon.com/gafferongames?ty=h</a>)</span>æ¥å¾—åˆ°ä¸€ä¸ªè¿™æ–¹é¢çš„å®ç°ã€‚</span></p><p class="MsoNormal" align="left" style="line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span><a rel="nofollow" href="http://baike.baidu.com/view/319754.htm" target="_blank"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222;text-decoration:none"><span>å››å…ƒæ•°</span></span></a></span><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æ˜¯ç®€å•çš„</span><span><a rel="nofollow" href="http://baike.baidu.com/view/1383306.htm" target="_blank"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222;text-decoration:none"><span>è¶…å¤æ•°</span></span></a></span><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ã€‚ </span><span><a rel="nofollow" href="http://baike.baidu.com/view/10078.htm" target="_blank"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222;text-decoration:none"><span>å¤æ•°</span></span></a></span><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æ˜¯ç”±</span><span><a rel="nofollow" href="http://baike.baidu.com/view/14749.htm" target="_blank"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222;text-decoration:none"><span>å®æ•°</span></span></a></span><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">åŠ ä¸Šè™šæ•°å•ä½<span> i </span>ç»„æˆï¼Œå…¶ä¸­<span>i^2 = -1</span>ã€‚ ç›¸ä¼¼åœ°ï¼Œ</span><span><a rel="nofollow" href="http://baike.baidu.com/view/319754.htm" target="_blank"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222;text-decoration:none"><span>å››å…ƒæ•°</span></span></a></span><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">éƒ½æ˜¯ç”±å®æ•°åŠ ä¸Šä¸‰ä¸ªè™šæ•°å•ä½<span> i</span>ã€<span>j</span>ã€<span>k </span>ç»„æˆï¼Œè€Œä¸”å®ƒä»¬æœ‰å¦‚ä¸‹çš„å…³ç³»ï¼š<span> i^2 = j^2 = k^2 = -1</span>ï¼Œ<span> i^0 = j^0 = k^0 = 1 , </span>æ¯ä¸ªå››å…ƒæ•°éƒ½æ˜¯<span> 1</span>ã€<span>i</span>ã€<span>j </span>å’Œ<span> k </span>çš„çº¿æ€§ç»„åˆï¼Œå³æ˜¯å››å…ƒæ•°ä¸€èˆ¬å¯è¡¨ç¤ºä¸º<span>a + bk+ cj + di</span>ï¼Œå…¶ä¸­<span>a</span>ã€<span>b</span>ã€<span>c </span>ã€<span>d</span>æ˜¯å®æ•°ã€‚</span></p><p class="MsoNormal" align="left" style="line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å¯¹äº<span>i</span>ã€<span>j</span>ã€<span>k</span>æœ¬èº«çš„å‡ ä½•æ„ä¹‰å¯ä»¥ç†è§£ä¸ºä¸€ç§æ—‹è½¬ï¼Œå…¶ä¸­<span>i</span>æ—‹è½¬ä»£è¡¨<span>X</span>è½´ä¸<span>Y</span>è½´ç›¸äº¤å¹³é¢ä¸­<span>X</span>è½´æ­£å‘å‘<span>Y</span>è½´æ­£å‘çš„æ—‹è½¬ï¼Œ<span>j</span>æ—‹è½¬ä»£è¡¨<span>Z</span>è½´ä¸<span>X</span>è½´ç›¸äº¤å¹³é¢ä¸­<span>Z</span>è½´æ­£å‘å‘<span>X</span>è½´æ­£å‘çš„æ—‹è½¬ï¼Œ<span>k</span>æ—‹è½¬ä»£è¡¨<span>Y</span>è½´ä¸<span>Z</span>è½´ç›¸äº¤å¹³é¢ä¸­<span>Y</span>è½´æ­£å‘å‘<span>Z</span>è½´æ­£å‘çš„æ—‹è½¬ï¼Œ<span>-i</span>ã€<span>-j</span>ã€<span>-k</span>åˆ†åˆ«ä»£è¡¨<span>i</span>ã€<span>j</span>ã€<span>k</span>æ—‹è½¬çš„åå‘æ—‹è½¬ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222"> </span></p><h2 id="åºåˆ—åŒ–å­—ç¬¦ä¸²å’Œæ•°ç»„"><span style="font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;">åºåˆ—åŒ–å­—ç¬¦ä¸²å’Œæ•°ç»„</span></h2><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å¦‚æœä½ æƒ³åºåˆ—åŒ–å­—ç¬¦ä¸²å¹¶é€šè¿‡ç½‘ç»œä¼ è¾“è¯¥æ€ä¹ˆåŠï¼Ÿ</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">åœ¨ç½‘ç»œä¸Šå‘é€å­—ç¬¦ä¸²çš„æ—¶å€™ç”¨<span>Null</span>ä½œä¸ºç»ˆæ­¢ç¬¦æ˜¯ä¸ªå¥½ä¸»æ„ä¹ˆï¼Ÿæˆ‘ä¸è¿™ä¹ˆè®¤ä¸ºã€‚æˆ‘è®¤ä¸ºè¿™ä¹ˆåšåªæ˜¯åœ¨è‡ªæ‰¾éº»çƒ¦ï¼æˆ‘ä»¬åº”è¯¥æŠŠå­—ç¬¦ä¸²ä½œä¸ºå¸¦é•¿åº¦ä½œä¸ºå‰ç¼€çš„å­—ç¬¦æ•°ç»„ã€‚æ‰€ä»¥ï¼Œè¦é€šè¿‡ç½‘ç»œå‘é€å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬å¿…é¡»è§£å†³å¦‚ä½•æœ‰æ•ˆçš„å‘é€å­—ç¬¦æ•°ç»„çš„é—®é¢˜ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">è§‚å¯Ÿåˆ°çš„ç¬¬ä¸€ä¸ªäº‹æƒ…ï¼šä¸ºä»€ä¹ˆè¦è´¹é‚£ä¹ˆå¤§ç²¾åŠ›æŠŠä¸€ä¸ªå­—èŠ‚æ•°ç»„æŒ‰æ¯”ç‰¹æ‰“åŒ…åˆ°ä½ çš„æ¯”ç‰¹æµé‡Œ?åªæ˜¯ä¸ºäº†è®©å®ƒä»¬éšæœºçš„åç§»<span>[0,7]</span>æ¯”ç‰¹ï¼Ÿä¸ºä»€ä¹ˆä¸åœ¨åºåˆ—åŒ–å†™å…¥ä¹‹å‰è¿›è¡ŒæŒ‰å­—èŠ‚è¿›è¡Œå¯¹é½ï¼ŸWhy not align to byte so you can memcpy the array of bytes directly into the packet?å¦‚æœè¿™ä¹ˆå¤„ç†çš„è¯ï¼Œæ•°æ®åŒ…é‡Œé¢çš„å­—èŠ‚æ•°ç»„æ•°æ®å°±å¾ˆå¯¹é½çš„å¾ˆå‡†ï¼Œæ•°ç»„çš„æ¯ä¸ªå­—èŠ‚éƒ½å¯¹åº”ç€æ•°æ®åŒ…é‡Œé¢çš„ä¸€ä¸ªå®é™…å­—èŠ‚ã€‚å¯¹äºæ¯ä¸ªè¦åºåˆ—åŒ–çš„å­—èŠ‚æ•°ç»„ï¼Œä½ åªæŸå¤±äº†<span>[0,7]</span>ä¸ªæ¯”ç‰¹ï¼Œè¿™å–å†³äºå¯¹é½çš„æ–¹å¼ï¼Œä½†æ˜¯ä»¥æˆ‘çš„è§‚ç‚¹æ¥çœ‹è¿™æ²¡ä»€ä¹ˆå¥½åœ¨æ„çš„ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å¦‚ä½•å°†æ¯”ç‰¹æµæŒ‰å­—èŠ‚å¯¹é½ï¼Ÿåªéœ€è¦åœ¨æµçš„å½“å‰ä½ç½®åšäº›è®¡ç®—å°±å¯ä»¥äº†ï¼Œæ‰¾å‡ºè¿˜å·®å†™å…¥å¤šå°‘ä¸ªæ¯”ç‰¹å°±èƒ½è®©å½“å‰æ¯”ç‰¹æµçš„æ¯”ç‰¹æ•°é‡è¢«<span>8</span>æ•´é™¤ï¼Œç„¶åæŒ‰ç…§è¿™ä¸ªæ•°å­—æ’å…¥å¡«å……æ¯”ç‰¹ï¼ˆæ¯”å¦‚å½“å‰æ¯”ç‰¹æµçš„æ¯”ç‰¹æ•°é‡æ˜¯<span>323</span>ï¼Œé‚£ä¹ˆ<span>323+5</span>æ‰èƒ½è¢«<span>8</span>æ•´é™¤ï¼Œæ‰€ä»¥éœ€è¦æ’å…¥<span>5</span>ä¸ªå¡«å……æ¯”ç‰¹ï¼‰ã€‚å¯¹äºå¡«å……æ¯”ç‰¹æ¥è¯´ï¼Œå¡«å……çš„æ¯”ç‰¹å€¼éƒ½æ˜¯<span>0</span>ï¼Œè¿™æ ·å½“ä½ åºåˆ—åŒ–è¯»å–çš„æ—¶å€™ä½ å¯ä»¥è¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœæ£€æµ‹çš„ç»“æœæ˜¯æ­£ç¡®çš„ï¼Œé‚£ä¹ˆå°±ç¡®å®æ˜¯åœ¨è¯»å–å¡«å……çš„éƒ¨åˆ†ï¼Œå¹¶ä¸”å¡«å……çš„éƒ¨åˆ†ç¡®å®æ˜¯<span>0</span>ã€‚ä¸€ç›´è¯»å–åˆ°ä¸‹ä¸€ä¸ªå®Œæ•´å­—èŠ‚çš„æ¯”ç‰¹èµ·å§‹ä½ç½®ï¼ˆå¯ä»¥è¢«<span>8</span>æ•´é™¤çš„ä½ç½®ï¼‰ã€‚å¦‚æœæ£€æµ‹çš„ç»“æœæ˜¯åœ¨åº”è¯¥å¡«å……çš„åœ°æ–¹å‘ç°äº†é<span>0</span>çš„æ¯”ç‰¹å€¼ï¼Œé‚£ä¹ˆå°±ä¸­æ­¢åºåˆ—åŒ–è¯»å–å¹¶ä¸¢å¼ƒè¿™ä¸ªæ•°æ®åŒ…ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ä¸‹é¢æ˜¯æˆ‘ç”¨æ¥å°†æ¯”ç‰¹æµæŒ‰æ¯”ç‰¹å¯¹é½çš„ä»£ç ï¼š</span></p><div><div id="highlighter_972905" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">void BitWriter::WriteAlign()</code></div><div class="line number2 index1 alt1"><code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">const</code> <code class="cpp color1 bold">int</code> <code class="cpp plain">remainderBits = m_bitsWritten % 8;</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( remainderBits != 0 )</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">       </code><code class="cpp plain">uint32_t zero = 0;</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">       </code><code class="cpp plain">WriteBits( zero, 8 - remainderBits );</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">       </code><code class="cpp functions bold">assert</code><code class="cpp plain">( ( m_bitsWritten % 8 ) == 0 );</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number10 index9 alt1"><code class="cpp plain">}</code></div><div class="line number11 index10 alt2"><code class="cpp spaces"> </code> </div><div class="line number12 index11 alt1"><code class="cpp plain">bool BitReader::ReadAlign()</code></div><div class="line number13 index12 alt2"><code class="cpp plain">{</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">const</code> <code class="cpp color1 bold">int</code> <code class="cpp plain">remainderBits = m_bitsRead % 8;</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( remainderBits != 0 )</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">       </code><code class="cpp plain">uint32_t value = ReadBits( 8 - remainderBits );</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">       </code><code class="cpp functions bold">assert</code><code class="cpp plain">( m_bitsRead % 8 == 0 );</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">       </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( value != 0 )</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">           </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">false</code><code class="cpp plain">;</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number23 index22 alt2"><code class="cpp plain">}</code></div><div class="line number24 index23 alt1"><code class="cpp spaces"> </code> </div><div class="line number25 index24 alt2"><code class="cpp preprocessor">#define serialize_align( stream)           \</code></div><div class="line number26 index25 alt1"><code class="cpp spaces"> </code><code class="cpp keyword bold">do</code>                                       <code class="cpp plain">\</code></div><div class="line number27 index26 alt2"><code class="cpp spaces"> </code><code class="cpp plain">{                                        \</code></div><div class="line number28 index27 alt1"><code class="cpp spaces">     </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( !stream.SerializeAlign() )       \</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">         </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">false</code><code class="cpp plain">;                    \</code></div><div class="line number30 index29 alt1"><code class="cpp spaces">  </code><code class="cpp plain">} </code><code class="cpp keyword bold">while</code><code class="cpp plain">(0)</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left"><br></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªå¯¹é½æ“ä½œæ¥æœ‰æ•ˆç‡çš„å°†å­—èŠ‚æ•°ç»„å†™å…¥æ¯”ç‰¹æµï¼šå› ä¸ºæˆ‘ä»¬å·²ç»å°†æ¯”ç‰¹æµæŒ‰ç…§å­—èŠ‚å¯¹é½äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<span>memcpy</span>æ–¹æ³•æ¥åšå¤§éƒ¨åˆ†çš„å·¥ä½œã€‚å”¯ä¸€çš„é—®é¢˜åœ¨äºæ¯”ç‰¹è¯»å–å™¨å’Œæ¯”ç‰¹å†™å…¥å™¨æ˜¯æŒ‰ç…§åŒå­—è¿›è¡Œå·¥ä½œçš„ï¼Œæ‰€ä»¥éœ€è¦ä¸€äº›ç‰¹æ®Šçš„ä»£ç æ¥å¤„ç†å­—èŠ‚æ•°ç»„çš„å¤´éƒ¨å’Œå°¾éƒ¨ï¼Œä»¥ç¡®ä¿å¤´éƒ¨çš„é›¶æ•£æ¯”ç‰¹ä¼šè¢«å†™å…¥å†…å­˜ï¼Œå¹¶ä¸”åœ¨å¤´éƒ¨å¤„ç†å®Œæ¯•ä»¥åï¼Œè¯»å–çš„ä½ç½®ä¼šè¢«æ­£ç¡®è®¾ç½®åˆ°ä¸‹ä¸€ä¸ªå­—èŠ‚ã€‚</span></p><div><div id="highlighter_313109" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">void BitWriter::WriteBytes( </code><code class="cpp keyword bold">const</code> <code class="cpp plain">uint8_t<em> data, </em></code><code class="cpp color1 bold">int</code> <code class="cpp plain">bytes )</code></div><div class="line number2 index1 alt1"><code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">   </code><code class="cpp functions bold">assert</code><code class="cpp plain">( GetAlignBits() == 0 );</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">   </code><code class="cpp functions bold">assert</code><code class="cpp plain">( m_bitsWritten + bytes  8 &lt;= m_numBits );</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">   </code><code class="cpp functions bold">assert</code><code class="cpp plain">( ( m_bitsWritten % 32 ) == 0 ||</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">           </code><code class="cpp plain">( m_bitsWritten % 32 ) == 8||             </code></div><div class="line number7 index6 alt2"><code class="cpp spaces">           </code><code class="cpp plain">( m_bitsWritten % 32 ) == 16 ||</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">           </code><code class="cpp plain">( m_bitsWritten % 32 ) == 24 );</code></div><div class="line number9 index8 alt2"><code class="cpp spaces"> </code> </div><div class="line number10 index9 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">int</code> <code class="cpp plain">headBytes = ( 4 - ( m_bitsWritten % 32 ) / 8 ) % 4;</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( headBytes &gt; bytes )</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">       </code><code class="cpp plain">headBytes = bytes;</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; headBytes; ++i )</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">       </code><code class="cpp plain">WriteBits( data[i], 8 );</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( headBytes == bytes )</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">return</code><code class="cpp plain">;</code></div><div class="line number17 index16 alt2"><code class="cpp spaces"> </code> </div><div class="line number18 index17 alt1"><code class="cpp spaces">   </code><code class="cpp functions bold">assert</code><code class="cpp plain">( GetAlignBits() == 0 );</code></div><div class="line number19 index18 alt2"><code class="cpp spaces"> </code> </div><div class="line number20 index19 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">int</code> <code class="cpp plain">numWords = ( bytes - headBytes ) / 4;</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( numWords &gt; 0 )</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">       </code><code class="cpp functions bold">assert</code><code class="cpp plain">( ( m_bitsWritten % 32 ) == 0 );</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">       </code><code class="cpp functions bold">memcpy</code><code class="cpp plain">( &amp;m_data[m_wordIndex], data+headBytes, numWords<em>4 );</em></code></div><div class="line number25 index24 alt2"><code class="cpp spaces">       </code><code class="cpp plain">m_bitsWritten += numWords  32;</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">       </code><code class="cpp plain">m_wordIndex += numWords;</code></div><div class="line number27 index26 alt2"><code class="cpp spaces">       </code><code class="cpp plain">m_scratch = 0;</code></div><div class="line number28 index27 alt1"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number29 index28 alt2"><code class="cpp spaces"> </code> </div><div class="line number30 index29 alt1"><code class="cpp spaces">   </code><code class="cpp functions bold">assert</code><code class="cpp plain">( GetAlignBits() == 0 );</code></div><div class="line number31 index30 alt2"><code class="cpp spaces"> </code> </div><div class="line number32 index31 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">int</code> <code class="cpp plain">tailStart = headBytes + numWords <em> 4;</em></code></div><div class="line number33 index32 alt2"><code class="cpp spaces">   </code><code class="cpp color1 bold">int</code> <code class="cpp plain">tailBytes = bytes - tailStart;</code></div><div class="line number34 index33 alt1"><code class="cpp spaces">   </code><code class="cpp functions bold">assert</code><code class="cpp plain">( tailBytes &gt;= 0 &amp;&amp; tailBytes &lt; 4 );</code></div><div class="line number35 index34 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; tailBytes; ++i )</code></div><div class="line number36 index35 alt1"><code class="cpp spaces">       </code><code class="cpp plain">WriteBits( data[tailStart+i], 8 );</code></div><div class="line number37 index36 alt2"><code class="cpp spaces"> </code> </div><div class="line number38 index37 alt1"><code class="cpp spaces">   </code><code class="cpp functions bold">assert</code><code class="cpp plain">( GetAlignBits() == 0 );</code></div><div class="line number39 index38 alt2"><code class="cpp spaces"> </code> </div><div class="line number40 index39 alt1"><code class="cpp spaces">   </code><code class="cpp functions bold">assert</code><code class="cpp plain">( headBytes + numWords  4 + tailBytes == bytes );</code></div><div class="line number41 index40 alt2"><code class="cpp plain">}</code></div><div class="line number42 index41 alt1"><code class="cpp spaces"> </code> </div><div class="line number43 index42 alt2"><code class="cpp plain">void ReadBytes( uint8_t<em> data, </em></code><code class="cpp color1 bold">int</code> <code class="cpp plain">bytes )</code></div><div class="line number44 index43 alt1"><code class="cpp plain">{</code></div><div class="line number45 index44 alt2"><code class="cpp spaces">   </code><code class="cpp functions bold">assert</code><code class="cpp plain">( GetAlignBits() == 0 );</code></div><div class="line number46 index45 alt1"><code class="cpp spaces">   </code><code class="cpp functions bold">assert</code><code class="cpp plain">( m_bitsRead + bytes  8 &lt;= m_numBits );</code></div><div class="line number47 index46 alt2"><code class="cpp spaces">   </code><code class="cpp functions bold">assert</code><code class="cpp plain">( ( m_bitsRead % 32 ) == 0 ||</code></div><div class="line number48 index47 alt1"><code class="cpp spaces">           </code><code class="cpp plain">( m_bitsRead % 32 ) == 8 ||</code></div><div class="line number49 index48 alt2"><code class="cpp spaces">           </code><code class="cpp plain">( m_bitsRead % 32 ) == 16 ||</code></div><div class="line number50 index49 alt1"><code class="cpp spaces">           </code><code class="cpp plain">( m_bitsRead % 32 ) == 24 );</code></div><div class="line number51 index50 alt2"><code class="cpp spaces"> </code> </div><div class="line number52 index51 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">int</code> <code class="cpp plain">headBytes = ( 4 - ( m_bitsRead % 32 ) / 8 ) % 4;</code></div><div class="line number53 index52 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( headBytes &gt; bytes )</code></div><div class="line number54 index53 alt1"><code class="cpp spaces">   </code><code class="cpp plain">headBytes = bytes;</code></div><div class="line number55 index54 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; headBytes; ++i )</code></div><div class="line number56 index55 alt1"><code class="cpp spaces">   </code><code class="cpp plain">data[i] = ReadBits( 8 );</code></div><div class="line number57 index56 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( headBytes == bytes )</code></div><div class="line number58 index57 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">return</code><code class="cpp plain">;</code></div><div class="line number59 index58 alt2"><code class="cpp spaces"> </code> </div><div class="line number60 index59 alt1"><code class="cpp spaces">   </code><code class="cpp functions bold">assert</code><code class="cpp plain">( GetAlignBits() == 0 );</code></div><div class="line number61 index60 alt2"><code class="cpp spaces"> </code> </div><div class="line number62 index61 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">int</code> <code class="cpp plain">numWords = ( bytes - headBytes ) / 4;</code></div><div class="line number63 index62 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( numWords &gt; 0 )</code></div><div class="line number64 index63 alt1"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number65 index64 alt2"><code class="cpp spaces">       </code><code class="cpp functions bold">assert</code><code class="cpp plain">( ( m_bitsRead % 32 ) == 0 );</code></div><div class="line number66 index65 alt1"><code class="cpp spaces">       </code><code class="cpp functions bold">memcpy</code><code class="cpp plain">( data + headBytes, &amp;m_data[m_wordIndex], numWords <em> 4 );</em></code></div><div class="line number67 index66 alt2"><code class="cpp spaces">       </code><code class="cpp plain">m_bitsRead += numWords  32;</code></div><div class="line number68 index67 alt1"><code class="cpp spaces">       </code><code class="cpp plain">m_wordIndex += numWords;</code></div><div class="line number69 index68 alt2"><code class="cpp spaces">       </code><code class="cpp plain">m_scratchBits = 0;</code></div><div class="line number70 index69 alt1"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number71 index70 alt2"><code class="cpp spaces"> </code> </div><div class="line number72 index71 alt1"><code class="cpp spaces">   </code><code class="cpp functions bold">assert</code><code class="cpp plain">( GetAlignBits() == 0 );</code></div><div class="line number73 index72 alt2"><code class="cpp spaces"> </code> </div><div class="line number74 index73 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">int</code> <code class="cpp plain">tailStart = headBytes + numWords <em> 4;</em></code></div><div class="line number75 index74 alt2"><code class="cpp spaces">   </code><code class="cpp color1 bold">int</code> <code class="cpp plain">tailBytes = bytes - tailStart;</code></div><div class="line number76 index75 alt1"><code class="cpp spaces">   </code><code class="cpp functions bold">assert</code><code class="cpp plain">( tailBytes &gt;= 0 &amp;&amp; tailBytes &lt; 4 );</code></div><div class="line number77 index76 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; tailBytes; ++i )</code></div><div class="line number78 index77 alt1"><code class="cpp spaces">       </code><code class="cpp plain">data[tailStart+i] = ReadBits( 8 );</code></div><div class="line number79 index78 alt2"><code class="cpp spaces"> </code> </div><div class="line number80 index79 alt1"><code class="cpp spaces">   </code><code class="cpp functions bold">assert</code><code class="cpp plain">( GetAlignBits() == 0 );</code></div><div class="line number81 index80 alt2"><code class="cpp spaces"> </code> </div><div class="line number82 index81 alt1"><code class="cpp spaces">   </code><code class="cpp functions bold">assert</code><code class="cpp plain">( headBytes + numWords  4 + tailBytes == bytes );</code></div><div class="line number83 index82 alt2"><code class="cpp plain">}</code></div><div class="line number84 index83 alt1"><code class="cpp spaces"> </code> </div><div class="line number85 index84 alt2"><code class="cpp keyword bold">template &lt;typename Stream&gt;</code></div><div class="line number86 index85 alt1"><code class="cpp plain">bool serialize_bytes_internal( Stream &amp; stream,</code></div><div class="line number87 index86 alt2"><code class="cpp spaces">                              </code><code class="cpp plain">uint8_t<em> data,</em></code></div><div class="line number88 index87 alt1"><code class="cpp spaces">                              </code><code class="cpp color1 bold">int</code> <code class="cpp plain">bytes )</code></div><div class="line number89 index88 alt2"><code class="cpp plain">{</code></div><div class="line number90 index89 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">return</code> <code class="cpp plain">stream.SerializeBytes( data, bytes );</code></div><div class="line number91 index90 alt2"><code class="cpp plain">}</code></div><div class="line number92 index91 alt1"><code class="cpp spaces"> </code> </div><div class="line number93 index92 alt2"><code class="cpp preprocessor">#define serialize_bytes( stream, data, bytes)                   \</code></div><div class="line number94 index93 alt1"><code class="cpp spaces"> </code><code class="cpp keyword bold">do</code>                                                             <code class="cpp plain">\</code></div><div class="line number95 index94 alt2"><code class="cpp spaces"> </code><code class="cpp plain">{                                                              \</code></div><div class="line number96 index95 alt1"><code class="cpp spaces">     </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( !serialize_bytes_internal( stream, data, bytes ) )    \</code></div><div class="line number97 index96 alt2"><code class="cpp spaces">         </code><code class="cpp plain">return false;                                          \</code></div><div class="line number98 index97 alt1"><code class="cpp spaces">  </code><code class="cpp plain">} </code><code class="cpp keyword bold">while</code><code class="cpp plain">(0)</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left"><br></p><p class="MsoNormal" align="left"><span style="color: rgb(34, 34, 34); font-family: å¾®è½¯é›…é»‘, sans-serif; font-size: 10pt;"> </span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å…ˆåºåˆ—åŒ–å­—ç¬¦ä¸²é•¿åº¦ç„¶ååºåˆ—åŒ–å­—ç¬¦ä¸²æ•°æ®çš„æ–¹æ³•æ¥åºåˆ—åŒ–ä¸€ä¸ªå­—ç¬¦ä¸²ï¼š</span></p><div><div id="highlighter_278980" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">template &lt;typename Stream&gt;</code></div><div class="line number2 index1 alt1"><code class="cpp color1 bold">bool</code> <code class="cpp plain">serialize_string_internal(Stream &amp; stream,</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">                               </code><code class="cpp color1 bold">char</code><code class="cpp plain"> string,</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">                               </code><code class="cpp color1 bold">int</code> <code class="cpp plain">buffer_size )</code></div><div class="line number5 index4 alt2"><code class="cpp plain">{</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">   </code><code class="cpp plain">uint32_t length;</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsWriting )</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">       </code><code class="cpp plain">length = </code><code class="cpp functions bold">strlen</code><code class="cpp plain">( string );</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">       </code><code class="cpp functions bold">assert</code><code class="cpp plain">( length &lt; buffer_size - 1 );</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">   </code><code class="cpp plain">serialize_int( stream, length, 0, buffer_size - 1 );</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">   </code><code class="cpp plain">serialize_bytes( stream, (uint8_t*)string, length );</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsReading )</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">       </code><code class="cpp plain">string[length] = </code><code class="cpp string">â€˜\0â€™</code><code class="cpp plain">;</code></div><div class="line number16 index15 alt1"><code class="cpp plain">}</code></div><div class="line number17 index16 alt2"><code class="cpp spaces"> </code> </div><div class="line number18 index17 alt1"><code class="cpp preprocessor">#define serialize_string( stream, string, buffer_size)             \</code></div><div class="line number19 index18 alt2"><code class="cpp keyword bold">do</code>                                                                  <code class="cpp plain">\</code></div><div class="line number20 index19 alt1"><code class="cpp plain">{                                                                   \</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( !serialize_string_internal(stream,                        \</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">                                    </code><code class="cpp plain">string,buffer_size ) )         \</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">       </code><code class="cpp plain">return false;                                               \</code></div><div class="line number24 index23 alt1"><code class="cpp plain">} </code><code class="cpp keyword bold">while</code> <code class="cpp plain">(0)</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left"><br></p><p class="MsoNormal" align="left" style="margin: 0cm 18.05pt 0.0001pt; line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt 18pt 0cm;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æ­£å¦‚ä½ çœ‹åˆ°çš„é‚£æ ·ï¼Œå¯ä»¥ä»åŸºæœ¬å…ƒç´ çš„åºåˆ—åŒ–å¼€å§‹æ„å»ºä¸€ä¸ªç›¸å½“å¤æ‚çš„åºåˆ—åŒ–ä½“ç³»ã€‚</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt 18pt 0cm;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><h2 id="åºåˆ—åŒ–æ•°ç»„çš„å­é›†"><span style="font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;">åºåˆ—åŒ–æ•°ç»„çš„å­é›†</span></h2><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt 18pt 0cm;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å½“å®ç°ä¸€ä¸ªæ¸¸æˆç½‘ç»œåè®®çš„æ—¶å€™ï¼Œæˆ–æ—©æˆ–æ™šæ€»ä¼šéœ€è¦åºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡æ•°ç»„ç„¶ååœ¨ç½‘ç»œä¸Šä¼ é€’ã€‚æ¯”å¦‚è¯´æœåŠ¡å™¨ä¹Ÿè®¸éœ€è¦æŠŠæ‰€æœ‰çš„ç‰©ä½“å‘é€ç»™å®¢æˆ·ç«¯ï¼Œæˆ–è€…æœ‰æ—¶å€™éœ€è¦å‘é€ä¸€ç»„äº‹ä»¶æˆ–è€…æ¶ˆæ¯ã€‚å¦‚æœä½ è¦å‘é€æ‰€æœ‰çš„ç‰©ä½“åˆ°å®¢æˆ·ç«¯ï¼Œè¿™æ˜¯ç›¸å½“ç®€å•ç›´è§‚çš„ï¼Œä½†æ˜¯å¦‚æœä½ åªæ˜¯æƒ³å‘é€ä¸€ä¸ªæ•°ç»„çš„ä¸€ä¸ªå­é›†æ€ä¹ˆåŠï¼Ÿ</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æœ€å…ˆæƒ³åˆ°ä¹Ÿæ˜¯æœ€å®¹æ˜“çš„åŠæ³•æ˜¯éå†æ•°ç»„çš„æ‰€æœ‰ç‰©ä½“ç„¶ååºåˆ—åŒ–ä¸€ä¸ª<span>bool</span>æ•°ç»„ï¼Œè¿™ä¸ª<span>bool</span>æ•°ç»„æ ‡è®°çš„æ˜¯å¯¹åº”çš„ç‰©ä½“æ˜¯å¦é€šè¿‡ç½‘ç»œå‘é€ã€‚å¦‚æœ<span>bool</span>å€¼ä¸º<span>1</span>é‚£ä¹ˆåé¢ä¼šè·Ÿç€ç‰©ä½“çš„æ•°æ®ï¼Œå¦åˆ™å°±ä¼šè¢«å¿½ç•¥ç„¶åä¸‹ä¸€ä¸ªç‰©ä½“çš„<span>bool</span>å€¼å–å†³äºæµçš„ä¸‹ä¸€ä¸ªå€¼ã€‚</span></p><div><div id="highlighter_16412" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">template &lt;typename Stream&gt;</code></div><div class="line number2 index1 alt1"><code class="cpp plain">bool serialize_scene_a( Stream &amp; stream, Scene &amp; scene )</code></div><div class="line number3 index2 alt2"><code class="cpp plain">{</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; MaxObjects; ++i )</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">       </code><code class="cpp plain">serialize_bool( stream, scene.objects[i].send );</code></div><div class="line number7 index6 alt2"><code class="cpp spaces"> </code> </div><div class="line number8 index7 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( !scene.objects[i].send )</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">       </code><code class="cpp plain">{</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">           </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsReading )</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">               </code><code class="cpp functions bold">memset</code><code class="cpp plain">( &amp;scene.objects[i], 0, </code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">( Object ) );</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">           </code><code class="cpp keyword bold">continue</code><code class="cpp plain">;</code></div><div class="line number13 index12 alt2"><code class="cpp spaces">       </code><code class="cpp plain">}</code></div><div class="line number14 index13 alt1"><code class="cpp spaces"> </code> </div><div class="line number15 index14 alt2"><code class="cpp spaces">       </code><code class="cpp plain">serialize_object( stream, scene.objects[i] );</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number17 index16 alt2"><code class="cpp spaces"> </code> </div><div class="line number18 index17 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number19 index18 alt2"><code class="cpp plain">}</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left"><br></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ä½†æ˜¯å¦‚æœç‰©ä½“çš„æ•°ç»„å¾ˆå¤§æ€ä¹ˆåŠï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚åœºæ™¯ä¸­æœ‰<span>4000</span>ä¸ªç‰©ä½“ã€‚<span>4000 / 8 = 500</span>ã€‚å…‰æ˜¯æ ‡è®°ç‰©ä½“æ˜¯å¦å‘é€çš„<span>BOOL</span>æ•°ç»„å°±è¦<span>500</span>ä¸ªå­—èŠ‚çš„å¼€é”€ï¼Œå³ä½¿ä½ åªå‘é€äº†ä¸€ä¸¤ä¸ªç‰©ä½“ä¹Ÿæ˜¯è¿™æ ·ï¼è¿™ç§æ–¹æ³•ã€‚ã€‚ã€‚ã€‚ä¸æ˜¯å¤ªå¥½ã€‚æ‰€ä»¥æˆ‘ä»¬æ˜¯å¦èƒ½å¤Ÿæ‰¾åˆ°ä¸€ç§åŠæ³•æ¥è®©é¢å¤–çš„å¼€é”€æ­£æ¯”äºå‘é€çš„ç‰©ä½“æ•°ç›®è€Œä¸æ˜¯æ­£æ¯”äºæ•°ç»„ä¸­çš„ç‰©ä½“æ•°ç›®ï¼Ÿ</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°è¿™ä¹ˆä¸€ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬å·²ç»åšäº†ä¸€äº›æœ‰æ„æ€çš„äº‹æƒ…ã€‚æˆ‘ä»¬åœ¨åºåˆ—åŒ–å†™å…¥çš„æ—¶å€™éå†ä¸€ä¸ªç‰©ä½“çš„é›†åˆï¼ˆæ•°ç»„é‡Œé¢çš„æ‰€æœ‰ç‰©ä½“ï¼‰ä½†æ˜¯åºåˆ—åŒ–è¯»å–çš„æ—¶å€™éå†çš„æ˜¯ä¸€ä¸ªä¸åŒçš„ç‰©ä½“é›†åˆï¼ˆå‘é€ç‰©ä½“æ•°ç»„çš„å­é›†ï¼‰ã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šç»Ÿä¸€çš„åºåˆ—åŒ–å‡½æ•°æ¦‚å¿µå°±ä¸èƒ½ç»´ç³»äº†ã€‚å¯¹äºè¿™ç§æƒ…å†µæœ€å¥½æ˜¯æŠŠè¯»å–å’Œå†™å…¥åˆ†è§£æˆå•ç‹¬çš„å‡½æ•°ï¼š</span></p><div><div id="highlighter_730107" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">bool write_scene_b( protocol2::WriteStream &amp; stream, Scene &amp; scene )</code></div><div class="line number2 index1 alt1"><code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">   </code><code class="cpp color1 bold">int</code> <code class="cpp plain">num_objects_sent = 0;</code></div><div class="line number4 index3 alt1"><code class="cpp spaces"> </code> </div><div class="line number5 index4 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; MaxObjects; ++i )</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">       </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( scene.objects[i].send )</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">           </code><code class="cpp plain">num_objects_sent++;</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number10 index9 alt1"><code class="cpp spaces"> </code> </div><div class="line number11 index10 alt2"><code class="cpp spaces">   </code><code class="cpp plain">write_int( stream, num_objects_sent, 0, MaxObjects );</code></div><div class="line number12 index11 alt1"><code class="cpp spaces"> </code> </div><div class="line number13 index12 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; MaxObjects; ++i )</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">       </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( !scene.objects[i].send )</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">           </code><code class="cpp keyword bold">continue</code><code class="cpp plain">;</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">       </code><code class="cpp plain">write_int( stream, i, 0, MaxObjects - 1 );</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">       </code><code class="cpp plain">write_object( stream, scene.objects[i] );</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number20 index19 alt1"><code class="cpp spaces"> </code> </div><div class="line number21 index20 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number22 index21 alt1"><code class="cpp plain">}</code></div><div class="line number23 index22 alt2"><code class="cpp spaces"> </code> </div><div class="line number24 index23 alt1"><code class="cpp plain">bool read_scene_b( protocol2::ReadStream &amp; stream, Scene &amp; scene )</code></div><div class="line number25 index24 alt2"><code class="cpp plain">{</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">   </code><code class="cpp functions bold">memset</code><code class="cpp plain">( &amp;scene, 0, </code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">( scene ) );</code></div><div class="line number27 index26 alt2"><code class="cpp spaces"> </code> </div><div class="line number28 index27 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">int</code> <code class="cpp plain">num_objects_sent;</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">   </code><code class="cpp plain">read_int( stream, num_objects_sent, 0, MaxObjects );</code></div><div class="line number30 index29 alt1"><code class="cpp spaces"> </code> </div><div class="line number31 index30 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; num_objects_sent; ++i )</code></div><div class="line number32 index31 alt1"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number33 index32 alt2"><code class="cpp spaces">       </code><code class="cpp color1 bold">int</code> <code class="cpp plain">index;</code></div><div class="line number34 index33 alt1"><code class="cpp spaces">       </code><code class="cpp plain">read_int( stream, index, 0, MaxObjects - 1 );</code></div><div class="line number35 index34 alt2"><code class="cpp spaces">       </code><code class="cpp plain">read_object( stream, scene.objects[index] );</code></div><div class="line number36 index35 alt1"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number37 index36 alt2"><code class="cpp spaces"> </code> </div><div class="line number38 index37 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number39 index38 alt2"><code class="cpp plain">}</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left"><br></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æ­¤å¤–ï¼Œä½ å¯ä»¥ç”¨å‘ç”Ÿå˜åŒ–çš„å¯¹è±¡é›†åˆæ¥ç”Ÿæˆä¸€ä¸ªå•ç‹¬çš„æ•°æ®ç»“æ„ï¼Œå¹¶ä¸”é’ˆå¯¹å‘ç”Ÿå˜åŒ–çš„å¯¹è±¡é›†åˆå®ç°åºåˆ—åŒ–ã€‚ä½†æ˜¯å¯¹æ¯ä¸ªä½ æœŸæœ›èƒ½å¤Ÿåºåˆ—åŒ–çš„æ•°æ®ç»“æ„éƒ½äº§ç”Ÿ<span>C++</span>ä»£ç å¯¹åº”çš„æ•°æ®ç»“æ„ä½“æ˜¯ä¸€ä»¶éå¸¸ç—›è‹¦çš„äº‹æƒ…ã€‚æœ€ç»ˆä½ å¯èƒ½æƒ³è¦åŒæ—¶éå†å‡ ä¸ªæ•°æ®ç»“æ„ç„¶åé«˜æ•ˆçš„å°†ä¸€ä¸ªåŠ¨æ€æ•°æ®ç»“æ„å†™å…¥æ¯”ç‰¹æµã€‚è¿™åœ¨å†™ä¸€äº›æ›´é«˜çº§çš„åºåˆ—åŒ–æ–¹æ³•æ¯”å¦‚å¢é‡ç¼–ç çš„æ—¶å€™æ˜¯ä¸€ç§éå¸¸å¹³å¸¸çš„åšæ³•ã€‚åªè¦ä½ é‡‡ç”¨äº†è¿™ç§åšæ³•ï¼Œç»Ÿä¸€åºåˆ—åŒ–è¿™ç§åšæ³•å°±ä¸å†æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æˆ‘å¯¹æ­¤çš„å»ºè®®æ˜¯å¦‚æœä»»ä½•æ—¶å€™ä½ æƒ³è¿™ä¹ˆåšï¼Œé‚£ä¹ˆè¯·ä¸è¦æ‹…å¿ƒï¼Œå°±æŠŠåºåˆ—åŒ–è¯»å–å’Œåºåˆ—åŒ–å†™å…¥åˆ†å¼€å¥½äº†ã€‚å°†åºåˆ—åŒ–è¯»å–å’Œåºåˆ—åŒ–å†™å…¥ç»Ÿä¸€èµ·æ¥æ˜¯ä¸€ç§éå¸¸ç®€å•çš„æ–¹å¼ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼å¸¦æ¥çš„ç®€å•æ˜“ç”¨ä¸åºåˆ—åŒ–å†™å…¥æ—¶åŠ¨æ€ç”Ÿæˆæ•°æ®ç»“æ„çš„ç—›è‹¦ç›¸æ¯”æ˜¯ä¸åˆ’ç®—çš„ã€‚æˆ‘çš„ç»éªŒæ˜¯å¤æ‚çš„åºåˆ—åŒ–åŠŸèƒ½æœ‰æ—¶å€™å¯èƒ½ä¼šéœ€è¦å•ç‹¬çš„åºåˆ—åŒ–è¯»å–å’Œåºåˆ—åŒ–å†™å…¥åŠŸèƒ½ï¼Œä½†æ˜¯å¦‚æœå¯èƒ½çš„è¯ï¼Œå°½é‡è®©å…·ä½“çš„åºåˆ—åŒ–å‡½æ•°æ˜¯ç»Ÿä¸€è¯»å–å’Œå†™å…¥çš„ï¼ˆä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼Œå®é™…çš„ç‰©ä½“å’Œäº‹ä»¶æ— è®ºä½•æ—¶åºåˆ—åŒ–éƒ½å°½é‡ä¿æŒåºåˆ—åŒ–è¯»å–å’Œåºåˆ—åŒ–å†™å…¥æ˜¯ç»Ÿä¸€çš„ï¼‰ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å¤šè¯´ä¸€ç‚¹ã€‚ä¸Šé¢çš„ä»£ç åœ¨ä¸€æ¬¡åºåˆ—åŒ–å†™å…¥çš„æ—¶å€™å¯¹ç‰©ä½“é›†åˆè¿›è¡Œäº†ä¸¤æ¬¡éå†ã€‚ä¸€æ¬¡éå†ç”¨æ¥ç¡®å®šå‘ç”Ÿå˜åŒ–çš„ç‰©ä½“æ•°ç›®ï¼Œç¬¬äºŒæ¬¡éå†ç”¨æ¥å¯¹å‘ç”Ÿå˜åŒ–çš„ç‰©ä½“é›†åˆè¿›è¡Œå®é™…çš„åºåˆ—åŒ–ã€‚æˆ‘ä»¬æ˜¯å¦èƒ½åªç”¨ä¸€æ¬¡éå†å°±èƒ½å¤„ç†å¥½å‘ç”Ÿå˜åŒ–çš„ç‰©ä½“é›†åˆçš„åºåˆ—åŒ–ï¼Ÿå½“ç„¶å¯ä»¥ï¼ä½ å¯ä»¥ä½¿ç”¨å¦å¤–ä¸€ä¸ªæŠ€å·§ï¼Œç”¨ä¸€ä¸ªå“¨å…µå€¼ï¼ˆ<span>sentinel value</span>ï¼‰æ¥æ ‡è®°æ•°ç»„çš„ç»“å°¾ä½ç½®ï¼Œè€Œä¸æ˜¯ä¸€ç›´åºåˆ—åŒ–æ•°ç»„ä¸­çš„ç‰©ä½“ç›´åˆ°é‡åˆ°<span>#</span>ã€‚ä½¿ç”¨è¿™ç§æ–¹æ³•ä½ å¯ä»¥åœ¨å‘é€çš„æ—¶å€™åªéå†æ•´ä¸ªæ•°ç»„ä¸€éï¼Œå½“æ²¡æœ‰æ›´å¤šç‰©ä½“éœ€è¦å‘é€çš„æ—¶å€™ï¼Œå°±æŠŠå“¨å…µå€¼åºåˆ—åŒ–è¿›æ•°æ®åŒ…ä»¥è¡¨ç¤ºæ•°ç»„ç»“æŸäº†ï¼š</span></p><div><div id="highlighter_951032" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp plain">bool write_scene_c( protocol2::WriteStream &amp; stream, Scene &amp; scene )</code></div><div class="line number2 index1 alt1"><code class="cpp plain">{</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; MaxObjects; ++i )</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">       </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( !scene.objects[i].send )</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">           </code><code class="cpp keyword bold">continue</code><code class="cpp plain">;</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">       </code><code class="cpp plain">write_int( stream, i, 0, MaxObjects );</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">       </code><code class="cpp plain">write_object( stream, scene.objects[i] );</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number10 index9 alt1"><code class="cpp spaces"> </code> </div><div class="line number11 index10 alt2"><code class="cpp spaces">   </code><code class="cpp plain">write_int( stream, MaxObjects, 0, MaxObjects );</code></div><div class="line number12 index11 alt1"><code class="cpp spaces"> </code> </div><div class="line number13 index12 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number14 index13 alt1"><code class="cpp plain">}</code></div><div class="line number15 index14 alt2"><code class="cpp spaces"> </code> </div><div class="line number16 index15 alt1"><code class="cpp plain">bool read_scene_c( protocol2::ReadStream &amp; stream, Scene &amp; scene )</code></div><div class="line number17 index16 alt2"><code class="cpp plain">{</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">   </code><code class="cpp functions bold">memset</code><code class="cpp plain">( &amp;scene, 0, </code><code class="cpp keyword bold">sizeof</code><code class="cpp plain">( scene ) );</code></div><div class="line number19 index18 alt2"><code class="cpp spaces"> </code> </div><div class="line number20 index19 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">while</code> <code class="cpp plain">( </code><code class="cpp keyword bold">true</code> <code class="cpp plain">)</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">       </code><code class="cpp color1 bold">int</code> <code class="cpp plain">index; read_int( stream, index, 0, MaxObjects );</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">       </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( index == MaxObjects )</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">           </code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">       </code><code class="cpp plain">read_object( stream, scene.objects[index] );</code></div><div class="line number26 index25 alt1"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number27 index26 alt2"><code class="cpp spaces"> </code> </div><div class="line number28 index27 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number29 index28 alt2"><code class="cpp plain">}</code><span style="color: rgb(34, 34, 34); font-family: &quot;Courier New&quot;; font-size: 12pt;"> </span></div></div></td></tr></table></div></div><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt 18pt 0cm;"><span style="font-size:10.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">è¿™ç§åšæ³•éå¸¸çš„ç®€å•ï¼Œå¹¶ä¸”åœ¨å‘é€çš„ç‰©ä½“é›†åˆç›¸æ¯”è¾ƒå…¨éƒ¨ç‰©ä½“é›†åˆæ¯”ä¾‹éå¸¸å°çš„æ—¶å€™å·¥ä½œçš„å¾ˆæ£’ã€‚ä½†æ˜¯å¦‚æœæœ‰å¤§é‡çš„ç‰©ä½“éœ€è¦å‘é€ï¼Œä¸¾ä¸ªä¾‹å­æ¥è¯´ï¼Œæ•´ä¸ªåœºæ™¯ä¸­æœ‰<span>4000</span>ä¸ªç‰©ä½“ï¼Œæœ‰ä¸€åŠçš„ç‰©ä½“ä¹Ÿå°±æ˜¯<span>2000</span>ä¸ªéœ€è¦é€šè¿‡ç½‘ç»œè¿›è¡Œå‘é€ã€‚æ¯ä¸ªç‰©ä½“éœ€è¦ä¸€ä¸ªåºå·ï¼Œé‚£ä¹ˆå°±éœ€è¦<span>2000</span>ä¸ªåºå·ï¼Œæ¯ä¸ªåºå·éœ€è¦<span>12</span>æ¯”ç‰¹ã€‚ã€‚ã€‚ã€‚è¿™å°±æ˜¯è¯´æ•°æ®åŒ…é‡Œé¢<span>24000</span>æ¯”ç‰¹æˆ–è€…è¯´æ¥è¿‘<span>30000</span>æ¯”ç‰¹ï¼ˆå‡ ä¹æ˜¯<span>30000</span>ï¼Œä¸æ˜¯ä¸¥æ ¼æ˜¯ï¼Œè¯‘æ³¨ï¼šåŸæ–‡å¦‚æ­¤ï¼‰çš„æ•°æ®è¢«åºå·æµªè´¹æ‰äº†ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å¯ä»¥æŠŠåºå·çš„ç¼–ç æ–¹å¼ä¿®æ”¹ä¸‹æ¥èŠ‚çœæ•°æ®ï¼Œåºå·ä¸å†æ˜¯å…¨å±€åºå·ï¼Œè€Œæ˜¯ç›¸å¯¹ä¸Šä¸€ä¸ªç‰©ä½“çš„ç›¸å¯¹åºå·ã€‚æƒ³ä¸‹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä»å·¦åˆ°å³éå†ä¸€ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥æ•°ç»„ä¸­ç‰©ä½“çš„åºå·ä»<span>0</span>å¼€å§‹å¹¶ä¸”é€æ­¥å¢å¤§åˆ°<span>MaxObjects â€“ 1</span>ã€‚ä»ç»Ÿè®¡å­¦çš„è§’åº¦æ¥è¯´ï¼Œè¦å‘é€çš„ç‰©ä½“æœ‰å¯èƒ½æ˜¯æŒ¨ç€å¾ˆè¿‘çš„ï¼Œè¿™æ ·ä¸‹ä¸€ä¸ªåºå·å¯èƒ½å°±æ˜¯<span>+1</span>æˆ–è€…<span>+10</span>å†æˆ–è€…æ˜¯<span>+30</span>è¿™æ ·çš„å°æ•°å­—ï¼Œå› ä¸ºæˆ‘ä»¬è¿™é‡Œç”¨çš„åºå·æ˜¯ç›¸å¯¹ä¸Šä¸€ä¸ªå‘é€çš„ç‰©ä½“çš„ï¼Œæ‰€ä»¥æ•°å­—ä»ç»Ÿè®¡æ„ä¹‰ä¸Šæ¥è¯´éƒ½ä¼šæ¯”è¾ƒå°ï¼Œæ‰€ä»¥å¹³å‡æ¥è®²ï¼Œç›¸æ¯”è¾ƒä¹‹å‰çš„è§£å†³æ–¹æ¡ˆä½ å¯èƒ½éœ€è¦æ›´å°‘çš„æ¯”ç‰¹æ¥è¡¨ç¤ºç‰©ä½“çš„åºå·ã€‚ï¼ˆå…¶å®æœ€å·®æƒ…å†µä¸‹æˆ‘ä»¬æ‰€éœ€çš„æ¯”ç‰¹ä½ä¹Ÿåªæ˜¯å’Œå‰ä¸€ä¸ªæ–¹æ¡ˆç›¸åŒè€Œå·²ï¼Œå¯ä»¥è¯æ˜æ¯ä¸ªåºå·ï¼Œåä¸€æ–¹æ¡ˆéƒ½æ¯”å‰ä¸€æ–¹æ¡ˆçš„è¦å°ï¼Œé‚£ä¹ˆæ¯ä¸ªåºå·èŠ±è´¹çš„æ¯”ç‰¹ä½æ— ç–‘ä¸ä¼šæ›´å¤šï¼Œä½†æ˜¯è¿™ç§æ–¹æ¡ˆçš„ä¸»è¦é—®é¢˜åœ¨äºå¥å£®æ€§ï¼Œéœ€è¦ç¡®ä¿å…³äºæ•°æ®é›†åˆçš„æ•°æ®åŒ…ä¸­é—´éƒ½ä¸èƒ½ä¸¢ï¼Œä¸€æ—¦ä¸­é—´æŸä¸ªåŒ…è¢«ä¸¢æ‰äº†ï¼Œé‚£ä¹ˆåé¢çš„è§£æå°±å®Œå…¨ä¹±æ‰äº†ï¼Œå®ç°èµ·æ¥æ›´åŠ å›°éš¾ä¸€äº›<span>)</span>ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ä¸‹é¢å°±æ˜¯è¿™ä¹ˆä¸€ç§ç¼–ç ç‰©ä½“åºå·çš„æ–¹å¼ï¼Œæ¯ä¸ªåºå·éƒ½æ˜¯ç›¸å¯¹ä¸Šä¸€ä¸ªç‰©ä½“åºå·è€Œè¨€çš„ï¼Œä¸å†æ˜¯å…¨å±€åºå·ï¼Œä»ç»Ÿè®¡çš„è§’åº¦æ¥è®²å®ƒä»¬ä¼šæ¶ˆè€—æ›´å°‘çš„æ¯”ç‰¹ä½ï¼ˆä½†æ˜¯å¦‚æœéå¸¸å¤§çš„é›†åˆï¼Œä½†æ˜¯å‘é€çš„æ•°ç»„æ‰€å çš„æ¯”ä¾‹å¾ˆå°ï¼Œé‚£ä¹ˆä¸¤ç§æ–¹æ³•çš„å·®å¼‚å…¶å®æ˜¯æ¯”è¾ƒå°çš„ï¼‰ï¼š</span></p><div><div id="highlighter_750294" class="syntaxhighlighter  cpp"><div class="toolbar"><a class="toolbar_item command_help help">?</a></div><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div><div class="line number90 index89 alt1">90</div><div class="line number91 index90 alt2">91</div><div class="line number92 index91 alt1">92</div><div class="line number93 index92 alt2">93</div><div class="line number94 index93 alt1">94</div><div class="line number95 index94 alt2">95</div><div class="line number96 index95 alt1">96</div><div class="line number97 index96 alt2">97</div><div class="line number98 index97 alt1">98</div><div class="line number99 index98 alt2">99</div><div class="line number100 index99 alt1">100</div><div class="line number101 index100 alt2">101</div><div class="line number102 index101 alt1">102</div><div class="line number103 index102 alt2">103</div><div class="line number104 index103 alt1">104</div><div class="line number105 index104 alt2">105</div><div class="line number106 index105 alt1">106</div><div class="line number107 index106 alt2">107</div><div class="line number108 index107 alt1">108</div><div class="line number109 index108 alt2">109</div><div class="line number110 index109 alt1">110</div><div class="line number111 index110 alt2">111</div><div class="line number112 index111 alt1">112</div><div class="line number113 index112 alt2">113</div><div class="line number114 index113 alt1">114</div><div class="line number115 index114 alt2">115</div><div class="line number116 index115 alt1">116</div><div class="line number117 index116 alt2">117</div><div class="line number118 index117 alt1">118</div><div class="line number119 index118 alt2">119</div><div class="line number120 index119 alt1">120</div><div class="line number121 index120 alt2">121</div><div class="line number122 index121 alt1">122</div><div class="line number123 index122 alt2">123</div><div class="line number124 index123 alt1">124</div><div class="line number125 index124 alt2">125</div><div class="line number126 index125 alt1">126</div><div class="line number127 index126 alt2">127</div><div class="line number128 index127 alt1">128</div><div class="line number129 index128 alt2">129</div><div class="line number130 index129 alt1">130</div><div class="line number131 index130 alt2">131</div><div class="line number132 index131 alt1">132</div><div class="line number133 index132 alt2">133</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="cpp keyword bold">template &lt;typename Stream&gt;</code></div><div class="line number2 index1 alt1"><code class="cpp plain">bool serialize_object_index_internal( Stream &amp; stream,</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">                                     </code><code class="cpp color1 bold">int</code> <code class="cpp plain">&amp; previous,</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">                                     </code><code class="cpp color1 bold">int</code> <code class="cpp plain">&amp; current )</code></div><div class="line number5 index4 alt2"><code class="cpp plain">{</code></div><div class="line number6 index5 alt1"><code class="cpp spaces">   </code><code class="cpp plain">uint32_t difference;</code></div><div class="line number7 index6 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsWriting )</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">       </code><code class="cpp functions bold">assert</code><code class="cpp plain">( previous &lt; current );</code></div><div class="line number10 index9 alt1"><code class="cpp spaces">       </code><code class="cpp plain">difference = current - previous;</code></div><div class="line number11 index10 alt2"><code class="cpp spaces">       </code><code class="cpp functions bold">assert</code><code class="cpp plain">( difference &gt; 0 );</code></div><div class="line number12 index11 alt1"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number13 index12 alt2"><code class="cpp spaces"> </code> </div><div class="line number14 index13 alt1"><code class="cpp spaces">   </code><code class="cpp comments">// +1 (1 bit)</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">   </code><code class="cpp color1 bold">bool</code> <code class="cpp plain">plusOne;</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsWriting )</code></div><div class="line number17 index16 alt2"><code class="cpp spaces">      </code><code class="cpp plain">plusOne = difference == 1;</code></div><div class="line number18 index17 alt1"><code class="cpp spaces">   </code><code class="cpp plain">serialize_bool( stream, plusOne );</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( plusOne )</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number21 index20 alt2"><code class="cpp spaces">       </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsReading )</code></div><div class="line number22 index21 alt1"><code class="cpp spaces">           </code><code class="cpp plain">current = previous + 1;</code></div><div class="line number23 index22 alt2"><code class="cpp spaces">       </code><code class="cpp plain">previous = current;</code></div><div class="line number24 index23 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number25 index24 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number26 index25 alt1"><code class="cpp spaces"> </code> </div><div class="line number27 index26 alt2"><code class="cpp spaces">   </code><code class="cpp comments">// [+2,5] -&gt; [0,3] (2 bits)</code></div><div class="line number28 index27 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">bool</code> <code class="cpp plain">twoBits;</code></div><div class="line number29 index28 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsWriting )</code></div><div class="line number30 index29 alt1"><code class="cpp spaces">       </code><code class="cpp plain">twoBits = difference &lt;= 5;</code></div><div class="line number31 index30 alt2"><code class="cpp spaces">   </code><code class="cpp plain">serialize_bool( stream, twoBits );</code></div><div class="line number32 index31 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( twoBits )</code></div><div class="line number33 index32 alt2"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number34 index33 alt1"><code class="cpp spaces">       </code><code class="cpp plain">serialize_int( stream, difference, 2, 5 );</code></div><div class="line number35 index34 alt2"><code class="cpp spaces">       </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsReading )</code></div><div class="line number36 index35 alt1"><code class="cpp spaces">           </code><code class="cpp plain">current = previous + difference;</code></div><div class="line number37 index36 alt2"><code class="cpp spaces">       </code><code class="cpp plain">previous = current;</code></div><div class="line number38 index37 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number39 index38 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number40 index39 alt1"><code class="cpp spaces"> </code> </div><div class="line number41 index40 alt2"><code class="cpp spaces">   </code><code class="cpp comments">// [6,13] -&gt; [0,7] (3 bits)</code></div><div class="line number42 index41 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">bool</code> <code class="cpp plain">threeBits;</code></div><div class="line number43 index42 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsWriting )</code></div><div class="line number44 index43 alt1"><code class="cpp spaces">       </code><code class="cpp plain">threeBits = difference &lt;= 13;</code></div><div class="line number45 index44 alt2"><code class="cpp spaces">   </code><code class="cpp plain">serialize_bool( stream, threeBits );</code></div><div class="line number46 index45 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( threeBits )</code></div><div class="line number47 index46 alt2"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number48 index47 alt1"><code class="cpp spaces">       </code><code class="cpp plain">serialize_int( stream, difference, 6, 13 );</code></div><div class="line number49 index48 alt2"><code class="cpp spaces">       </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsReading )</code></div><div class="line number50 index49 alt1"><code class="cpp spaces">           </code><code class="cpp plain">current = previous + difference;</code></div><div class="line number51 index50 alt2"><code class="cpp spaces">       </code><code class="cpp plain">previous = current;</code></div><div class="line number52 index51 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number53 index52 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number54 index53 alt1"><code class="cpp spaces"> </code> </div><div class="line number55 index54 alt2"><code class="cpp spaces">   </code><code class="cpp comments">// [14,29] -&gt; [0,15] (4 bits)</code></div><div class="line number56 index55 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">bool</code> <code class="cpp plain">fourBits;</code></div><div class="line number57 index56 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsWriting )</code></div><div class="line number58 index57 alt1"><code class="cpp spaces">       </code><code class="cpp plain">fourBits = difference &lt;= 29;</code></div><div class="line number59 index58 alt2"><code class="cpp spaces">   </code><code class="cpp plain">serialize_bool( stream, fourBits );</code></div><div class="line number60 index59 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( fourBits )</code></div><div class="line number61 index60 alt2"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number62 index61 alt1"><code class="cpp spaces">       </code><code class="cpp plain">serialize_int( stream, difference, 14, 29 );</code></div><div class="line number63 index62 alt2"><code class="cpp spaces">       </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsReading )</code></div><div class="line number64 index63 alt1"><code class="cpp spaces">           </code><code class="cpp plain">current = previous + difference;</code></div><div class="line number65 index64 alt2"><code class="cpp spaces">       </code><code class="cpp plain">previous = current;</code></div><div class="line number66 index65 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number67 index66 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number68 index67 alt1"><code class="cpp spaces"> </code> </div><div class="line number69 index68 alt2"><code class="cpp spaces">    </code><code class="cpp comments">//[30,61] -&gt; [0,31] (5 bits)</code></div><div class="line number70 index69 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">bool</code> <code class="cpp plain">fiveBits;</code></div><div class="line number71 index70 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsWriting )</code></div><div class="line number72 index71 alt1"><code class="cpp spaces">       </code><code class="cpp plain">fiveBits = difference &lt;= 61;</code></div><div class="line number73 index72 alt2"><code class="cpp spaces">   </code><code class="cpp plain">serialize_bool( stream, fiveBits );</code></div><div class="line number74 index73 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( fiveBits )</code></div><div class="line number75 index74 alt2"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number76 index75 alt1"><code class="cpp spaces">       </code><code class="cpp plain">serialize_int( stream, difference, 30, 61 );</code></div><div class="line number77 index76 alt2"><code class="cpp spaces">       </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsReading )</code></div><div class="line number78 index77 alt1"><code class="cpp spaces">           </code><code class="cpp plain">current = previous + difference;</code></div><div class="line number79 index78 alt2"><code class="cpp spaces">       </code><code class="cpp plain">previous = current;</code></div><div class="line number80 index79 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number81 index80 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number82 index81 alt1"><code class="cpp spaces"> </code> </div><div class="line number83 index82 alt2"><code class="cpp spaces">   </code><code class="cpp comments">// [62,125] -&gt; [0,63] (6 bits)</code></div><div class="line number84 index83 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">bool</code> <code class="cpp plain">sixBits;</code></div><div class="line number85 index84 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsWriting )</code></div><div class="line number86 index85 alt1"><code class="cpp spaces">       </code><code class="cpp plain">sixBits = difference &lt;= 125;</code></div><div class="line number87 index86 alt2"><code class="cpp spaces">   </code><code class="cpp plain">serialize_bool( stream, sixBits );</code></div><div class="line number88 index87 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( sixBits )</code></div><div class="line number89 index88 alt2"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number90 index89 alt1"><code class="cpp spaces">       </code><code class="cpp plain">serialize_int( stream, difference, 62, 125 );</code></div><div class="line number91 index90 alt2"><code class="cpp spaces">       </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsReading )</code></div><div class="line number92 index91 alt1"><code class="cpp spaces">           </code><code class="cpp plain">current = previous + difference;</code></div><div class="line number93 index92 alt2"><code class="cpp spaces">       </code><code class="cpp plain">previous = current;</code></div><div class="line number94 index93 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number95 index94 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number96 index95 alt1"><code class="cpp spaces"> </code> </div><div class="line number97 index96 alt2"><code class="cpp spaces">   </code><code class="cpp comments">// [126,MaxObjects+1]</code></div><div class="line number98 index97 alt1"><code class="cpp spaces">   </code><code class="cpp plain">serialize_int( stream, difference, 126, MaxObjects + 1 );</code></div><div class="line number99 index98 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsReading )</code></div><div class="line number100 index99 alt1"><code class="cpp spaces">       </code><code class="cpp plain">current = previous + difference;</code></div><div class="line number101 index100 alt2"><code class="cpp spaces">   </code><code class="cpp plain">previous = current;</code></div><div class="line number102 index101 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number103 index102 alt2"><code class="cpp plain">}</code></div><div class="line number104 index103 alt1"><code class="cpp spaces"> </code> </div><div class="line number105 index104 alt2"><code class="cpp keyword bold">template &lt;typename Stream&gt;</code></div><div class="line number106 index105 alt1"><code class="cpp plain">bool serialize_scene_d( Stream &amp; stream, Scene &amp; scene )</code></div><div class="line number107 index106 alt2"><code class="cpp plain">{</code></div><div class="line number108 index107 alt1"><code class="cpp spaces">   </code><code class="cpp color1 bold">int</code> <code class="cpp plain">previous_index = -1;</code></div><div class="line number109 index108 alt2"><code class="cpp spaces">   </code> </div><div class="line number110 index109 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( Stream::IsWriting )</code></div><div class="line number111 index110 alt2"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number112 index111 alt1"><code class="cpp spaces">       </code><code class="cpp keyword bold">for</code> <code class="cpp plain">( </code><code class="cpp color1 bold">int</code> <code class="cpp plain">i = 0; i &lt; MaxObjects; ++i )</code></div><div class="line number113 index112 alt2"><code class="cpp spaces">       </code><code class="cpp plain">{</code></div><div class="line number114 index113 alt1"><code class="cpp spaces">           </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( !scene.objects[i].send )</code></div><div class="line number115 index114 alt2"><code class="cpp spaces">               </code><code class="cpp keyword bold">continue</code><code class="cpp plain">;</code></div><div class="line number116 index115 alt1"><code class="cpp spaces">           </code><code class="cpp plain">write_object_index( stream, previous_index, i );</code></div><div class="line number117 index116 alt2"><code class="cpp spaces">           </code><code class="cpp plain">write_object( stream, scene.objects[i] );</code></div><div class="line number118 index117 alt1"><code class="cpp spaces">       </code><code class="cpp plain">}</code></div><div class="line number119 index118 alt2"><code class="cpp spaces">       </code><code class="cpp plain">write_object_index( stream, previous_index, MaxObjects );</code></div><div class="line number120 index119 alt1"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number121 index120 alt2"><code class="cpp spaces">   </code><code class="cpp keyword bold">else</code></div><div class="line number122 index121 alt1"><code class="cpp spaces">   </code><code class="cpp plain">{</code></div><div class="line number123 index122 alt2"><code class="cpp spaces">       </code><code class="cpp keyword bold">while</code> <code class="cpp plain">( </code><code class="cpp keyword bold">true</code> <code class="cpp plain">)</code></div><div class="line number124 index123 alt1"><code class="cpp spaces">       </code><code class="cpp plain">{</code></div><div class="line number125 index124 alt2"><code class="cpp spaces">           </code><code class="cpp color1 bold">int</code> <code class="cpp plain">index;</code></div><div class="line number126 index125 alt1"><code class="cpp spaces">           </code><code class="cpp plain">read_object_index( stream, previous_index, index );</code></div><div class="line number127 index126 alt2"><code class="cpp spaces">           </code><code class="cpp keyword bold">if</code> <code class="cpp plain">( index == MaxObjects )</code></div><div class="line number128 index127 alt1"><code class="cpp spaces">               </code><code class="cpp keyword bold">break</code><code class="cpp plain">;</code></div><div class="line number129 index128 alt2"><code class="cpp spaces">           </code><code class="cpp plain">read_object( stream, scene.objects[index] );</code></div><div class="line number130 index129 alt1"><code class="cpp spaces">       </code><code class="cpp plain">}</code></div><div class="line number131 index130 alt2"><code class="cpp spaces">   </code><code class="cpp plain">}</code></div><div class="line number132 index131 alt1"><code class="cpp spaces">   </code><code class="cpp keyword bold">return</code> <code class="cpp keyword bold">true</code><code class="cpp plain">;</code></div><div class="line number133 index132 alt2"><code class="cpp plain">}</code></div></div></td></tr></table></div></div><p class="MsoNormal" align="left"><br></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222"><br></span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™å°†èŠ‚çœå¤§é‡çš„å¸¦å®½ï¼Œå› ä¸ºè¦å‘é€çš„ç‰©ä½“çš„åºå·å¾€å¾€å€¾å‘äºèšåœ¨ä¸€èµ·ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœä¸‹ä¸€ä¸ªç‰©ä½“ä¹Ÿè¦è¢«å‘é€ï¼Œé‚£ä¹ˆå®ƒçš„çš„åºå·å°±æ˜¯<span>+1</span>åªéœ€è¦ä¸€ä¸ªæ¯”ç‰¹å¤§å°ã€‚å¦‚æœæ˜¯<span>+2</span>åˆ°<span>+5</span>çš„æƒ…å†µæ¯ä¸ªåºå·éœ€è¦<span>5</span>ä¸ªæ¯”ç‰¹ã€‚å¹³å‡ä¸‹æ¥åºå·æ‰€å çš„æ•°æ®å¤§å°æ–¹é¢å¯ä»¥é™ä½<span>2-3</span>å€ã€‚ä½†æ˜¯è¦æ³¨æ„çš„æ˜¯å¦‚æœæ˜¯é—´éš”åºå·æ¯”è¾ƒå¤§çš„åºå·çš„æ¶ˆè€—å°†æ¯”ä¸ç›¸å…³åºå·ç¼–ç æ–¹æ¡ˆï¼ˆæ¯ä¸ªåºå·éƒ½æ˜¯å <span>12</span>æ¯”ç‰¹ç©ºé—´ï¼‰è¦å¤§ã€‚è¿™çœ‹ä¸Šå»éå¸¸ç³Ÿç³•ï¼Œä½†æ˜¯å®é™…ä¸Šå¹¶ä¸ä¼šè¿™ä¹ˆå·®ï¼Œè¯•æƒ³ä¸€ä¸‹ï¼Œå³ä½¿ä½ é‡åˆ°äº†â€œæœ€å·®æƒ…å†µâ€ï¼ˆè¦å‘é€çš„ç‰©ä½“çš„åºå·é—´éš”å‡åŒ€éƒ½æ˜¯ç›¸å·®<span>128</span>ï¼‰ï¼Œé‚£ä¹ˆåœ¨ä¸€ä¸ª<span>4000</span>ç‰©ä½“çš„å¤§æ•°ç»„é‡Œé¢ä½ å®é™…æ‰å‘é€å‡ ä¸ªç‰©ä½“ï¼Ÿåªæœ‰<span>32</span>ä¸ªè€Œå·²ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒè¿™ä¸ªé—®é¢˜<span>!</span></span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222"><span><br></span></span></p><p class="MsoNormal" align="left" style="line-height: 22.5pt;"><br></p><h2 id="åè®®IDå’ŒCRC32å’Œåºåˆ—åŒ–æ£€æµ‹">åè®®IDå’ŒCRC32å’Œåºåˆ—åŒ–æ£€æµ‹</h2><br><p></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">é˜…è¯»åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šæœ‰ä¸€ä¸ªç–‘æƒ‘ã€‚â€œå“¦å“¦å“¦ï¼Œæ•´ä¸ªä½“ç³»çœ‹ä¸Šå»éå¸¸è„†å¼±å•Šï¼Œåªæœ‰ä¸€ä¸ªå®Œå…¨ä¸å¸¦ä»»ä½•å±æ€§ä¿¡æ¯çš„äºŒè¿›åˆ¶æµã€‚æµé‡Œé¢åªæœ‰ä¸€ä¸ªä¸ªæ•°æ®åè®®ã€‚ä½ è¯¥æ€ä¹ˆå¯¹è¿™äº›ä¿¡æ¯è¿›è¡Œååºåˆ—åŒ–è¯»å–å’Œå†™å…¥ï¼Ÿå¦‚æœæŸäº›äººå‘é€ä¸€äº›åŒ…å«éšæœºä¿¡æ¯çš„æ•°æ®åŒ…ç»™ä½ çš„æœåŠ¡å™¨ã€‚ä½ ä¼šä¸ä¼šåœ¨è§£æçš„æ—¶å€™æŠŠæœåŠ¡å™¨å¼„å´©æºƒæ‰ï¼Ÿâ€</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ç¡®å®å¤§éƒ¨åˆ†æ¸¸æˆæœåŠ¡å™¨å°±æ˜¯è¿™æ ·å·¥ä½œçš„ï¼Œä½†æ˜¯æˆ‘æœ‰ä¸ªå¥½æ¶ˆæ¯å‘Šè¯‰ä½ å’Œå…¶ä»–ä¹‹å‰æ˜¯è¿™ä¹ˆåšæœåŠ¡å™¨çš„äººï¼Œå­˜åœ¨è¿™æ ·çš„æŠ€æœ¯å¯ä»¥å‡å°‘æˆ–è€…å‡ ä¹æœç»ç”±äºåºåˆ—åŒ–å±‚ä¼ è¿‡æ¥çš„æ•°æ®å¯¼è‡´çš„å´©æºƒå¯èƒ½æ€§ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ç¬¬ä¸€ç§æŠ€æœ¯æ˜¯åœ¨ä½ çš„æ•°æ®åŒ…é‡Œé¢åŒ…å«åè®®<span>ID</span>ã€‚ä¸€èˆ¬å…¸å‹çš„åšæ³•æ˜¯ï¼Œå¤´<span>4</span>ä¸ªå­—èŠ‚ä½ å¯ä»¥è®¾å®šä¸€äº›æ¯”è¾ƒç½•è§è€Œä¸”ç‹¬ç‰¹çš„å€¼ï¼Œæ¯”å¦‚<span>0x12345678</span>ï¼Œåæ­£æ˜¯è¿™ç§å…¶ä»–äººä¸ä¼šæƒ³ç€å»ä½¿ç”¨çš„å€¼å°±å¥½äº†ã€‚ä½†æ˜¯è¯´çœŸçš„ï¼ŒæŠŠä½ çš„åºåˆ—<span>ID</span>å’Œåè®®ç‰ˆæœ¬çš„æ•°å­—ç”¨æ•£åˆ—å¾—åˆ°ä¸€ä¸ªæ•£åˆ—å€¼æ”¾åˆ°æ¯ä¸ªæ•°æ®åŒ…çš„å‰é¢<span>32</span>æ¯”ç‰¹çš„ä½ç½®ï¼Œè¿™ç§æ–¹æ³•çœŸçš„å·¥ä½œçš„å¾ˆå¥½ã€‚è‡³å°‘å¦‚æœæ˜¯å…¶ä»–åº”ç”¨ç¨‹åºçš„æ•°æ®åŒ…å‘é€åˆ°äº†ä½ çš„ç«¯å£ï¼ˆè¦è®°ä½ï¼Œ<span>UDP</span>çš„æ•°æ®åŒ…å¯ä»¥ä»ä»»ä½•<span>IP</span>ä»»ä½•ç«¯å£åœ¨ä»»ä½•æ—¶é—´å‘é€è¿‡æ¥ï¼‰ï¼Œä½ å¯ä»¥é€šè¿‡è¿™ï¼“ï¼’æ¯”ç‰¹çš„æ•°æ®åˆ¤æ–­å‡ºæ¥æ ¹æœ¬å°±ä¸æ˜¯ä½ çš„åº”ç”¨ç¨‹åºçš„åŒ…ï¼Œç„¶åå°±å¯ä»¥ç›´æ¥ä¸¢å¼ƒäº†ã€‚</span></p><br><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[protocol id] (32bits)</span><br><span class="line">(packet data)</span><br></pre></td></tr></table></figure><br><br><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&ququot;,&quot;sans-serif&quot;;color:#222222">ä¸‹ä¸€ä¸ªçº§åˆ«çš„é˜²æŠ¤æ˜¯å¯¹ä½ çš„æ•°æ®åŒ…æ•´ä½“åšä¸€ä¸ª<span>CRC32</span>çš„æ ¡éªŒï¼Œå¹¶æŠŠè¿™ä¸ªæ ¡éªŒç æ”¾åˆ°æ•°æ®åŒ…çš„åŒ…å¤´ã€‚è¿™å¯ä»¥è®©ä½ åœ¨æ¥æ”¶çš„æ—¶å€™å¶ç„¶ä¼šæ”¾è¿‡ä¸€äº›é”™è¯¯çš„æ•°æ®åŒ…è¿›æ¥å¤„ç†ï¼ˆè¿™ç¡®å®æ˜¯ä¼šå‘ç”Ÿï¼Œ<span>IP</span>çš„æ ¡éªŒå’Œæ˜¯<span>16</span>ä½çš„ï¼Œæ‰€ä»¥ä¸€å †ä¸œè¥¿ä¸ä¼šä½¿ç”¨<span>16</span>ä½çš„æ ¡éªŒå’Œã€‚ã€‚ã€‚å…¶å®æ˜¯é€šè¿‡åè®®<span>ID</span>æ¥é¿å…è¿™ç§å°æ¦‚ç‡äº‹ä»¶çš„ï¼‰ã€‚ç°åœ¨ä½ çš„æ•°æ®åŒ…å¤´æ–‡ä»¶çœ‹èµ·æ¥åƒä¸‹é¢è¿™æ ·ï¼š</span></p><br><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[protocol id](32bits)</span><br><span class="line"></span><br><span class="line">[crc32](32bits)</span><br><span class="line"></span><br><span class="line">(packet data)</span><br></pre></td></tr></table></figure><br><br><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å¦‚æœä½ æŒ‰ç€è¿™ä¸ªé¡ºåºåšä¸‹æ¥çš„è¯ï¼Œç°åœ¨ä½ å¯èƒ½ä¼šæœ‰ç‚¹ç•æƒ§ã€‚<span>â€</span>è¯·ç­‰ä¸€ä¸‹ï¼Œæˆ‘éœ€è¦ä¸ºæ¯ä¸ªæ•°æ®åŒ…èŠ±è´¹<span>8</span>ä¸ªé¢å¤–çš„å­—èŠ‚æ¥å®ç°æˆ‘è‡ªå·±çš„æ ¡éªŒå’Œä»¥åŠåè®®<span>ID</span>ä¹ˆï¼Ÿ<span>â€œ</span>äº‹å®ä¸Šï¼Œä½ å¯ä»¥ä¸è¿™ä¹ˆåšã€‚ä½ å¯ä»¥å­¦ä¹ ä¸‹çœ‹çœ‹<span>IPv4</span>æ˜¯å¦‚ä½•è¿›è¡Œæ ¡éªŒçš„ï¼Œå¹¶è®©åè®®<span>ID</span>å˜æˆä¸€ä¸ªé­”æœ¯å‰ç¼€(Magical Prefix)ã€‚ä¹Ÿå°±æ˜¯è¯´ä½ å¯ä»¥ä¸å‘é€è¿™ä¸ªåè®®<span>ID</span>ï¼Œä½†æ˜¯å‘é€æ–¹å’Œæ¥æ”¶æ–¹æå‰ç¡®è®¤è¿‡è¿™ä¸ªåè®®<span>ID</span>æ˜¯ä»€ä¹ˆï¼Œå¹¶åœ¨è®¡ç®—æ•°æ®åŒ…<span>CRC32</span>å€¼çš„æ—¶å€™è£…ä½œè¿™ä¸ªæ•°æ®åŒ…å¸¦ä¸Šäº†è¿™ä¸ªåè®®<span>ID</span>çš„å‰ç¼€æ¥å‚ä¸è®¡ç®—ã€‚è¿™æ ·å¦‚æœå‘é€æ–¹ä½¿ç”¨çš„åè®®<span>ID</span>ä¸æ¥æ”¶æ–¹ä¸ä¸€è‡´çš„æ—¶å€™ï¼Œ<span>CRC32</span>çš„æ ¡éªŒå°±ä¼šå¤±è´¥ï¼Œè¿™å°†ä¸ºæ¯ä¸ªæ•°æ®åŒ…èŠ‚çœ<span>4</span>ä¸ªå­—èŠ‚ï¼š</span></p><br><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[protocol id] (32bits)  // not actually sent, but used to calc crc32</span><br><span class="line"></span><br><span class="line">[crc32](32bits)</span><br><span class="line"></span><br><span class="line">(packet data)</span><br></pre></td></tr></table></figure><br><br><p class="MsoNormal" align="left"><span style="font-size:10.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222"><br></span><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å½“ç„¶ï¼Œ<span>CRC32</span>åªæ˜¯é˜²æ­¢æœ‰äº›éšæœºçš„æ•°æ®åŒ…è¯¯æ‰“è¯¯æ’çš„æƒ…å†µï¼Œä½†æ˜¯å¯¹äºå¯ä»¥è½»æ˜“ä¿®æ”¹æˆ–è€…æ„å»ºæ¶æ„æ•°æ®åŒ…çš„å¤´<span>4</span>ä¸ªå­—èŠ‚ä»¥ä¾¿ä¿®æ­£<span>CRC32</span>å€¼çš„é‚£äº›æ¶æ„å‘é€è€…æ¥è¯´å®ƒèµ·ä¸åˆ°ä»€ä¹ˆé˜²æŠ¤ä½œç”¨ã€‚è¦é˜²æ­¢é‚£äº›æ¶æ„å‘é€è€…ï¼Œä½ éœ€è¦ä½¿ç”¨ä¸€ä¸ªä¿å¯†æ€§æ›´å¥½çš„å¯†ç å“ˆå¸Œå‡½æ•°ï¼ŒåŒæ—¶è¿˜éœ€è¦ä¸€ä¸ªå¯†é’¥ï¼Œè¿™ä¸ªå¯†é’¥æœ€å¥½æ˜¯åœ¨å®¢æˆ·ç«¯å°è¯•ç™»é™†æ¸¸æˆæœåŠ¡å™¨ä¹‹å‰å°±é€šè¿‡<span>HTTPS</span>åè®®åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ç»Ÿä¸€å¥½<span>(</span>è€Œä¸”è¦ç¡®ä¿æ¯ä¸ªå®¢æˆ·ç«¯çš„å¯†é’¥éƒ½ä¸ä¸€æ ·ï¼Œåªæœ‰æœåŠ¡å™¨å’Œå¯¹åº”çš„å®¢æˆ·ç«¯æ‰çŸ¥é“å¯†é’¥æ˜¯ä»€ä¹ˆ<span>)</span>ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æœ€åä¸€é¡¹æŠ€æœ¯ï¼Œä¹Ÿå¯èƒ½æ˜¯æœ€æœ‰æ•ˆçš„é˜»æ­¢æ¶æ„å‘é€è€…çš„æŠ€æœ¯äº†ï¼ˆè™½ç„¶ä¼šå¯¼è‡´æ•°æ®åŒ…çš„åŠ å¯†å’Œç­¾åæœ‰å¾ˆå¤šå†—ä½™ä¿¡æ¯ï¼‰ï¼Œè¿™å°±æ˜¯åºåˆ—åŒ–æ£€æŸ¥ï¼ˆ<span>serialization check</span>ï¼‰ã€‚è¿™ä¸ªæŠ€æœ¯åŸºæœ¬ä¸Šæ¥è¯´æ˜¯åœ¨åŒ…çš„ä¸­é—´ï¼Œåœ¨ä¸€æ®µå¤æ‚çš„åºåˆ—åŒ–å†™å…¥ä¹‹å‰æˆ–è€…ä¹‹åå†™ä¸Šä¸€ä¸ªå·²çŸ¥çš„<span>32</span>æ¯”ç‰¹æ•´æ•°ï¼Œå¹¶åœ¨å¦å¤–ä¸€ç«¯åºåˆ—åŒ–è¯»å–çš„æ—¶å€™ç”¨ç›¸åŒçš„å€¼è¿›è¡Œæ£€æµ‹åˆ¤æ–­ã€‚å¦‚æœåºåˆ—åŒ–æ£€æŸ¥å€¼æ˜¯ä¸æ­£ç¡®çš„ï¼Œé‚£ä¹ˆå°±ä¸­æ­¢åºåˆ—åŒ–è¯»å–å¹¶ä¸¢å¼ƒè¿™ä¸ªæ•°æ®åŒ…ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222"><br></span><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æˆ‘å–œæ¬¢åœ¨æˆ‘çš„æ•°æ®åŒ…æ¯ä¸ªéƒ¨åˆ†ä¹‹é—´å†™å…¥ä¸€äº›åºåˆ—åŒ–æ£€æŸ¥å€¼ï¼Œè¿™æ ·æˆ‘è‡³å°‘çŸ¥é“æˆ‘çš„æ•°æ®åŒ…é‚£éƒ¨åˆ†å·²ç»è¢«æˆåŠŸçš„åºåˆ—åŒ–è¯»å–å’Œå†™å…¥ï¼ˆæœ‰äº›é—®é¢˜æ— è®ºä½ å¦‚ä½•åŠªåŠ›é¿å…éƒ½å¾ˆéš¾å®Œå…¨é¿å…çš„ï¼‰ã€‚æˆ‘å–œæ¬¢ä½¿ç”¨çš„å¦å¤–ä¸€ä¸ªå¾ˆé…·çš„æŠ€å·§æ˜¯åœ¨æ•°æ®åŒ…çš„ç»“å°¾åºåˆ—åŒ–ä¸€ä¸ªåè®®æ£€æŸ¥å€¼ï¼Œè¿™éå¸¸éå¸¸çš„æœ‰ç”¨ï¼Œå› ä¸ºå®ƒèƒ½å¤Ÿå¸®æˆ‘åˆ¤æ–­æ˜¯å¦é‡åˆ°äº†æ•°æ®åŒ…æˆªæ–­ï¼ˆéå¸¸åƒä¸Šä¸€ç¯‡æ–‡ç« æœ€åæåˆ°çš„è‡­åæ˜­è‘—çš„å¤§ç«¯æˆªæ–­å’Œå°ç«¯æˆªæ–­ï¼Œåœ¨å¼€å‘çš„æ—¶å€™ä¹Ÿæ˜¯å¾ˆè®©äººå¤´ç–¼çš„åœ°æ–¹ï¼‰ã€‚</span></p><p class="MsoNormal" align="left" style="line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æ‰€ä»¥ç°åœ¨ç½‘ç»œåŒ…çœ‹èµ·æ¥åº”è¯¥æ˜¯åƒè¿™æ ·ï¼š</span></p><br><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[protocol id] (32bits)  // not actually sent, but used to calc crc32</span><br><span class="line"></span><br><span class="line">[crc32](32bits)</span><br><span class="line"></span><br><span class="line">(packet data)</span><br><span class="line"></span><br><span class="line">[end of packet serialize check] (32 bits)</span><br></pre></td></tr></table></figure><br><br><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å¦‚æœä½ å–œæ¬¢çš„è¯ï¼Œä½ å¯ä»¥æŠŠè¿™äº›åè®®ç¼–è¯‘å‡ºæ¥ç„¶ååœ¨ä½ çš„å‘å¸ƒç‰ˆæœ¬ä¸­æ£€æŸ¥è¿™äº›æ•°æ®åŒ…çš„å†…å®¹ï¼Œç‰¹åˆ«æ˜¯åœ¨æœ‰éå¸¸æ£’çš„æ•°æ®åŒ…åŠ å¯†å’Œæ•°æ®åŒ…ç­¾åæ”¯æŒçš„æƒ…å†µä¸‹ï¼Œä¸è¿‡ä¸ç¼–è¯‘ä¹Ÿæ²¡å…³ç³»ï¼Œåæ­£ä¸å†éœ€è¦å®ƒä»¬äº†ã€‚</span></p><b><span style="font-family:å®‹ä½“"><br></span></b><b><span style="font-family:å®‹ä½“">ä¸‹ä¸€ç¯‡é¢„å‘Šï¼šæ•°æ®åŒ…çš„åˆ†åŒ…å’Œé‡ç»„</span></b><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">è¯·ç»§ç»­é˜…è¯»è¿™ä¸ªç³»åˆ—çš„ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œåœ¨è¿™ç¯‡æ–‡ç« é‡Œæˆ‘å°†å‘å¤§å®¶ä»‹ç»å¦‚ä½•æ‹“å±•æœ¬ç« ä¸­å®ç°çš„ç½‘ç»œåè®®æ¥å®ç°æ•°æ®åŒ…çš„åˆ†åŒ…å’Œé‡ç»„ä»¥ç¡®ä¿ä½ çš„ç½‘ç»œåŒ…çš„å¤§å°åœ¨<span>MTU</span>é™åˆ¶ä»¥ä¸‹ã€‚</span></p><p class="MsoNormal" align="left"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">MTU</span><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ï¼šæœ€å¤§<i>ä¼ è¾“</i>å•å…ƒï¼Œ<span>Maximum Transmission Unit</span>ï¼Œæ˜¯æŒ‡ä¸€ç§é€šä¿¡åè®®çš„æŸä¸€å±‚ä¸Šé¢æ‰€èƒ½é€šè¿‡çš„æœ€å¤§</span><span><a rel="nofollow" href="http://baike.baidu.com/view/25880.htm" target="_blank"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222;text-decoration:none"><span>æ•°æ®åŒ…</span></span></a></span><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å¤§ï¼Œä»¥</span><span><a rel="nofollow" href="http://baike.baidu.com/view/60408.htm" target="_blank"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222;text-decoration:none"><span>å­—èŠ‚</span></span></a></span><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ä¸ºå•ä½ã€‚</span><span><a rel="nofollow" href="http://baike.baidu.com/view/545115.htm" target="_blank"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222;text-decoration:none"><span>æœ€å¤§ä¼ è¾“å•å…ƒ</span></span></a></span><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">è¿™ä¸ªå‚æ•°é€šå¸¸ä¸</span><span><a rel="nofollow" href="http://baike.baidu.com/view/1296283.htm" target="_blank"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222;text-decoration:none"><span>é€šä¿¡æ¥å£</span></span></a></span><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">æœ‰å…³ï¼Œæ¯”å¦‚ç½‘ç»œæ¥å£å¡ã€ä¸²å£ç­‰ã€‚å› ä¸ºåè®®æ•°æ®å•å…ƒçš„åŒ…å¤´å’ŒåŒ…å°¾çš„é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œ<span>MTU</span>è¶Šå¤§ï¼Œåˆ™ä¸€ä¸ªåè®®æ•°æ®å•å…ƒçš„æ‰¿è½½çš„æœ‰æ•ˆæ•°æ®å°±è¶Šé•¿ï¼Œé€šä¿¡æ•ˆç‡ä¹Ÿè¶Šé«˜ã€‚<span>MTU</span>è¶Šå¤§ï¼Œä¼ é€ç›¸åŒçš„ç”¨æˆ·æ•°æ®æ‰€éœ€çš„æ•°æ®åŒ…ä¸ªæ•°ä¹Ÿè¶Šä½ã€‚<span>MTU</span>ä¹Ÿä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œå› ä¸º<span>MTU</span>è¶Šå¤§ï¼Œ ä¼ é€ä¸€ä¸ªæ•°æ®åŒ…çš„å»¶è¿Ÿä¹Ÿè¶Šå¤§ï¼›å¹¶ä¸”<span>MTU</span>è¶Šå¤§ï¼Œæ•°æ®åŒ…ä¸­<span> bit</span>ä½å‘ç”Ÿé”™è¯¯çš„æ¦‚ç‡ä¹Ÿè¶Šå¤§ã€‚<span>MTU</span>è¶Šå¤§ï¼Œé€šä¿¡æ•ˆç‡è¶Šé«˜è€Œä¼ è¾“å»¶è¿Ÿå¢å¤§ï¼Œæ‰€ä»¥è¦æƒè¡¡é€šä¿¡æ•ˆç‡å’Œä¼ è¾“å»¶è¿Ÿé€‰æ‹©åˆé€‚çš„<span>MTU</span>ã€‚ä»¥ä»¥å¤ªç½‘ä¼ é€<span>IPv4</span>æŠ¥æ–‡ä¸ºä¾‹ã€‚<span>MTU</span>è¡¨ç¤ºçš„é•¿åº¦åŒ…å«<span>IP</span>åŒ…å¤´çš„é•¿åº¦ï¼Œå¦‚æœ<span>IP</span>å±‚ä»¥ä¸Šçš„åè®®å±‚å‘é€çš„æ•°æ®æŠ¥æ–‡çš„é•¿åº¦è¶…è¿‡äº†<span>MTU</span>ï¼Œåˆ™åœ¨å‘é€è€…çš„<span>IP</span>å±‚å°†å¯¹æ•°æ®æŠ¥æ–‡è¿›è¡Œåˆ†ç‰‡ï¼Œåœ¨æ¥æ”¶è€…çš„<span>IP</span>å±‚å¯¹æ¥æ”¶åˆ°çš„åˆ†ç‰‡è¿›è¡Œé‡ç»„ã€‚</span></p><p class="MsoNormal" align="left" style="line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span style="font-size:12.0pt;font-family:&quot;Arial&quot;,&quot;sans-serif&quot;;color:#333333"> </span></p><p class="MsoNormal" align="left" style="line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰ä»·å€¼çš„è¯ï¼Œè¯·åœ¨<span>patreon</span>ä¸Šæ”¯æŒæˆ‘çš„å†™ä½œï¼Œè¿™æ ·æˆ‘ä¼šå†™çš„æ›´å¿«ã€‚ä½ å¯ä»¥åœ¨<span>BSD 3.0</span>è®¸å¯ä¸‹è®¿é—®åˆ°è¿™ç¯‡æ–‡ç« é‡Œé¢çš„ä»£ç ã€‚éå¸¸æ„Ÿè°¢ä½ çš„æ”¯æŒï¼</span></p><p class="MsoNormal" align="left" style="line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="line-height: 18pt; background-image: initial; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">ã€ç‰ˆæƒå£°æ˜ã€‘</span></p><p class="MsoNormal"><span style="font-size:12.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;;color:#222222">åŸæ–‡ä½œè€…æœªåšæƒåˆ©å£°æ˜ï¼Œè§†ä¸ºå…±äº«çŸ¥è¯†äº§æƒè¿›å…¥å…¬å…±é¢†åŸŸï¼Œè‡ªåŠ¨è·å¾—æˆæƒã€‚</span></p><p class="MsoNormal" align="left" style="line-height: 22.5pt;"><span style="font-size:10.0pt;font-family:&quot;å¾®è½¯é›…é»‘&quot;,&quot;sans-serif&quot;"> </span></p></div>                    <br>                


<h1 id="åŸæ–‡æ—§ç‰ˆæœ¬">åŸæ–‡æ—§ç‰ˆæœ¬</h1>

<div class="WordSection1"><p class="MsoNormal" align="left" style="line-height: 21pt;"><br></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Hi, Iâ€™mGlenn Fiedler and welcome to the second article in <b><u>Building a GameNetwork Protocol</u></b>.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">In the </span><span><a rel="noopener" href="http://gafferongames.com/building-a-game-network-protocol/reading-and-writing-packets/" target="_blank"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;">previous article</span></a></span><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222"> we discussed different ways to read and write packets in multiplayer games. Wequickly shot down sending game state via text formats like XML and JSON becausetheyâ€™re really inefficient and decided to write own binary protocolinstead. We implemented a bitpacker so we donâ€™t have to round boolsup to 8 bits, solved endianness issues, wrote words at a time instead of bytesand pretty much made the bitpacker as simple and as fast as possible withoutplatform specific tricks.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Where weleft off we still had the following problems to solve:</span></p><p class="MsoNormal" align="left" style="margin-left: 36.05pt; text-indent: -18pt;"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">1.<span style="font-stretch: normal; font-size: 7pt; line-height: normal; font-family: &#39;Times New Roman&#39;;">    </span></span><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Weneed a way to check if integer values are outside the expected rangeand abort packet read because people will send malicious packets tryingto make us trash memory. The packet read abort must be automatic and notuse exceptions because theyâ€™re really slow.</span></p><p class="MsoNormal" align="left" style="margin-left: 36.05pt; text-indent: -18pt;"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">2.<span style="font-stretch: normal; font-size: 7pt; line-height: normal; font-family: &#39;Times New Roman&#39;;">    </span></span><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Separateread and write functions are a maintainance nightmare if those functions arecoded manually. Weâ€™d like to write the serialization code for a packet <u>once</u> but not pay any runtime cost (in terms of additional branching, virtuals and soon) when doing so.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">How can wedo this? Read on and Iâ€™ll show you how exactly I do it in C++. Itâ€™s taken awhile for me to develop and refine this technique so I hope youâ€™ll find ituseful and at least a good alternative to consider vs. the way youcurrently do it or how youâ€™ve seen it done in other game engines.</span></p><p class="MsoNormal" align="left" style="line-height: 22.5pt;"><b><span style="font-size:18.0pt;font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Unified Packet Serialize Function</span></b></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Lets startwith the goal. Hereâ€™s where we want to end up:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">struct PacketA</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   int x,y,z;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   template &lt;typename Stream&gt; <typename stream="stream"> bool Serialize( Stream &amp; stream )</typename></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_bits( stream, x, 32 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_bits( stream, y, 32 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_bits( stream, z, 32 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">};</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">struct PacketB</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   int numElements;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   int elements[MaxElements];</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   template &lt;typename Stream&gt; <typename stream="stream"> bool Serialize( Stream &amp; stream )</typename></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_int( stream, numElements, 0, MaxElements );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       for ( int i = 0; i &lt; numElements; ++i )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           serialize_bits( buffer, elements[i], 32 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">};</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">struct PacketC</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   bool x;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   short y;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   int z;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   template &lt;typename Stream&gt; <typename stream="stream"> bool Serialize( Stream &amp; stream )</typename></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_int( stream, x, 8 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_int( stream, y, 16 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_int( stream, z, 32 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">};</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Noticethere is a single serialize function per-packet struct instead of separate readand write functions. This is great! It halves the amount of serialization codeand now you have put in some serious effort in order to desync read andwrite.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">The trickto making this work <u>efficiently</u><i> </i>is having thestream class templated in the serialize function. There are two stream types inmy system: ReadStream and WriteStream. Each class has the same set of methods,but otherwise are not related in any way. One class reads values in from a bitstream to variables, and the other writes variables values out to a bit stream.ReadStream and WriteStream are just wrappers on top of BitReader andBitWriter classes from the previous article.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">There areof course alternatives to this approach. If you dislike templates you couldhave a pure virtual base stream interface and implement that interfacewith read and write stream classes. But now youâ€™re taking a virtualfunction for each serialize call. Seems like an excessive amount of overhead tome.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Anotheroption is to have an uber-stream class that can be configured to act in read orwrite mode at runtime. This can be faster than the virtual functionmethod, but you still have to branch per-serialize call to decide if you shouldread or write so itâ€™s not going to be as fast as hand-coded read and write.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">I preferthe templated method because it lets the compiler do the work of generatingoptimized read/write functions for you. You can even code serializefunctions like this and let the compiler optimize out a bunch of stuff whenspecializing read and write:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">structRigidBody</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   vec3f position;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   quat3f orientation;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   vec3f linear_velocity;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   vec3f angular_velocity;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   template &lt;typename Stream&gt; <typename stream="stream"> bool Serialize( Stream &amp; stream )</typename></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_vector( stream, position );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_quaternion( stream, orientation );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       bool at_rest = Stream::IsWriting ? velocity.length() == 0 : 1;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_bool( stream, at_rest );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       if ( !at_rest )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           serialize_vector( stream, linear_velocity );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           serialize_vector( stream, angular_velocity );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       else if ( Stream::IsReading )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           linear_velocity = vec3f(0,0,0);</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           angular_velocity = vec3f(0,0,0);</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">};</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">While thismay <u>look</u> inefficient, itâ€™s actually not! The templatespecialization of this function optimizes out all of the branchesaccording to the stream type. Pretty neat huh?</span></p><p class="MsoNormal" align="left" style="line-height: 22.5pt;"><b><span style="font-size:18.0pt;font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Bounds Checking and Abort Read</span></b></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Now thatweâ€™ve twisted the compilerâ€™s arm to generate optimized read/writefunctions, we need some way to automate error checking on readso weâ€™re not vulnerable to malicious packets.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">The firststep is to pass in the range of the integer to the serialize functioninstead of just the number of bits required. Think about it. The serializefunction can work out the number of bits required from the min/max values:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">serialize_int(stream, numElements, 0, MaxElements );</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">This opensup the interface to support easy serialization of signed integer quantities andthe serialize function can check the value read in from the networkand make sure itâ€™s within the expected range. If the value is outsiderange, <u>abort serialize read immediately and discard the packet</u>.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Since wecanâ€™t use exceptions to handle this abort (too slow), hereâ€™s how I like to doit.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">In mysetup <b>serialize_int</b> is not actually a function, itâ€™s a sneaky macro likethis:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">#defineserialize_int( stream, value, min, max)                   \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   do                                                             \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {                                                              \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       assert( min &lt; max);                                       \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       int32_tint32_value;                                       \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       if ( Stream::IsWriting)                                   \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       {                                                          \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           assert( value &gt;= min);                                \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           assert( value &lt;= max);                                 \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           int32_value = (int32_t)value;                         \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       }                                                          \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       if ( !stream.SerializeInteger( int32_value, min, max ) )    \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           return false;                                          \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       if ( Stream::IsReading)                                   \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       {                                                          \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           value =int32_value;                                   \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           if ( value &lt; min || value &gt; max)                      \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">               return false;                                      \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       }                                                          \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">    } while (0)</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">The reasonIâ€™m being a terrible person here is that Iâ€™m using the macro to insert codethat checks the result of SerializeInteger and returns false onerror. This gives you exception-like behavior in the sense that itunwinds the stack back to the top of the serialization callstack on error, butyou donâ€™t pay anything like the cost of exceptions to do this. The branch tounwind is super uncommon (serialization errors are <u>rare</u>) so branchprediction should have no trouble at all.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Anothercase where we need to abort is if the stream reads past the end. This is also arare branch but itâ€™s one we do have to check on each serialization operationbecause reading past the end is undefined. If we fail to do this check, weexpose ourselves to infinite loops as we read past the end of the buffer.While itâ€™s common to return 0 values when reading past the end of a bit stream(as per-the previous article) there is no guarantee that reading zerovalues will always result in the serialize function terminating correctlyif it has loops. This overflow check is necessary for well defined behavior.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">One finalpoint. On serialize write I donâ€™t do any abort on range checksor write past the end of the stream. You can be a lot more relaxed on thewrite since if anything goes wrong itâ€™s pretty much guaranteed to be <u>yourfault</u>. Just assert that everything is as expected (in range, not past theend of stream) for each serialize write and youâ€™re good to go.</span></p><p class="MsoNormal" align="left" style="line-height: 22.5pt;"><b><span style="font-size:18.0pt;font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Serializing Floats and Vectors</span></b></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">The bitstream only serializes integer values. How can we serialize a float value?</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Seemstrickly but itâ€™s not actually. A floating point number stored inmemory is just a 32 bit value like any other. Your computer doesnâ€™t knowif a 32 bit word in memory is an integer, a floating point value or partof a string. <u>Itâ€™s just a 32 bit value</u>. Luckily, the C++ language (unlikea few others) lets us work with this fundamental property.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">You canaccess the integer value behind a floating point number with a union:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">union FloatInt</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   float float_value;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   uint32_t int_value;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">};</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">FloatInt tmp;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">tmp.float_value= 10.0f;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">printf(â€œfloat value as an integer: %x\nâ€, tmp.int_value );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">You canalso do it via an aliased uint32_t<em> pointer, but Iâ€™ve experienced thisbreak with GCC -O2, so I prefer the union trick instead. Friends of minepoint out (likely correctly) that the only <i><u>truly standard way</u></i> to get the float as an integer is to cast a pointer to the float value touint8_t</em> and reconstruct the integer value from the four bytevalues accessed individually through the byte pointer. Seems a prettydumb way to do it to me though. Ladies and gentlemenâ€¦ <b>C++!</b></span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Meanwhilein the past 5 years Iâ€™ve had no actual problems in the field with the uniontrick. Hereâ€™s how I serialize an uncompressed float value:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">template &lt;typename Stream&gt;<typename stream="stream"> </typename></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">boolserialize_float_internal( Stream &amp; stream, </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                              float &amp; value )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   union FloatInt</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       float float_value;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       uint32_t int_value;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   };</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   FloatInt tmp;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsWriting )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       tmp.float_value = value;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   bool result = stream.SerializeBits( tmp.int_value, 32 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsReading )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       value = tmp.float_value;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   return result;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Wrap thiswith a <b>serialize_float</b> macro for convenient error checking on read:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">#define serialize_float( stream, value)                            \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> do                                                                \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> {                                                                 \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( !protocol2::serialize_float_internal( stream, value ))     \ </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       return false;                                               \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">  } while(0)</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Sometimesyou donâ€™t want to transmit a full precision float. How can you compress a floatvalue? The first step is to <u>bound</u> that value in some known rangethen <u>quantize</u> it down to an integer representation.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Forexample, if you know a floating point number in is range [-10,+10] and anacceptable resolution for that value is 0.01, then you can just multiply thatfloating point number by 100.0 to get it in the range [-1000,+1000] andserialize that as an integer over the network. On the other side, justdivide by 100.0 to get back to the floating point value.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Here is ageneralized version of this concept:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">template &lt;typename Stream&gt;<typename stream="stream"> </typename></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">boolserialize_compressed_float_internal( Stream &amp; stream, </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                                         float &amp; value, </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                                         float min, </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                                         float max, </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                                         float res )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   const float delta = max - min;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   const float values = delta / res;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   const uint32_t maxIntegerValue = (uint32_t) ceil( values );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   const int bits = bits_required( 0, maxIntegerValue );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   uint32_t integerValue = 0;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsWriting )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       float normalizedValue = </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           clamp( ( value - min ) / delta, 0.0f, 1.0f );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       integerValue = (uint32_t) floor( normalizedValue <em> </em></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                                        maxIntegerValue + 0.5f );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( !stream.SerializeBits( integerValue, bits ) )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       return false;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsReading )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       const float normalizedValue = </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           integerValue / float( maxIntegerValue );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       value = normalizedValue  delta + min;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Once youcan serialize float values itâ€™s trivial extend to serialize vectorsand quaternions over the network. I use a modified version of  the awesome </span><span><a rel="noopener" href="https://github.com/scoopr/vectorial" target="_blank"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;">vectorial library</span></a></span><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222"> for vector math in my projects and I implement serialization for thosetypes like this:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">template &lt;typename Stream&gt;<typename stream="stream"> </typename></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">boolserialize_vector_internal( Stream &amp; stream, </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                               vec3f &amp; vector )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   float values[3];</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsWriting )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       vector.store( values );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_float( stream, values[0] );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_float( stream, values[1] );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_float( stream, values[2] );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsReading )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       vector.load( values );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">template &lt;typename Stream&gt;<typename stream="stream"> </typename></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">boolserialize_quaternion_internal( Stream &amp; stream, </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                                   quat4f &amp; quaternion )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   float values[4];</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsWriting )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       quaternion.store( values );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_float( stream, values[0] );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_float( stream, values[1] );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_float( stream, values[2] );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_float( stream, values[3] );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsReading )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       quaternion.load( values );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">#defineserialize_vector( stream, value)                      \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> do                                                            \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> {                                                             \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">    if ( !serialize_vector_internal( stream, value ))         \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">        return false;                                         \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> }                                                             \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> while(0)</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">#defineserialize_quaternion( stream, value)                  \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> do                                                            \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> {                                                             \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">    if ( !serialize_quaternion_internal( stream, value ) )    \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">        return false;                                         \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> }                                                             \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> while(0)</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">If youknow your vector is bounded in some range, you can compress it like this:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">template &lt;typename Stream&gt;<typename stream="stream"> </typename></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">boolserialize_compressed_vector_internal( Stream &amp; stream, </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                                          vec3f &amp; vector,</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                                          float min,</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                                          float max,</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                                          float res )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   float values[3];</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsWriting )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       vector.store( values );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_compressed_float( stream, values[0], min, max, res );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_compressed_float( stream, values[1], min, max, res );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_compressed_float( stream, values[2], min, max, res );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsReading )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       vector.load( values );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">If youwant to compress an orientation over the network, donâ€™t just compress it as avector with 8.8.8.8 bounded in the range [-1,+1]. You can do much better if youuse the smallest three representation of the quaternion. See the </span><span><a rel="noopener" href="http://www.patreon.com/gafferongames" target="_blank"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;">sample code</span></a></span><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222"> for this article for an implementation.</span></p><p class="MsoNormal" align="left" style="line-height: 22.5pt;"><b><span style="font-size:18.0pt;font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Serializing Strings and Arrays</span></b></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">What ifyou want to serialize a string over the network?</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Is it agood idea to send a string over the network with null termination? I donâ€™tthink so. Youâ€™re just asking for trouble! Instead, treat the string as an arrayof bytes with length prefixed. So, in order to send a string over thenetwork, we have to work out how to efficiently send an array of bytes.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Firstobservation: why waste effort bitpacking an array of bytes into your bit streamjust so they are randomly shifted by shifted by [0,7] bits? Why not just <u>alignto byte</u> before writing the array, so the array data sits in the packetnicely aligned, each byte of the array corresponding to an actual byte in thepacket. You lose only [0,7] bits for each array of bytes serialized,depending on the alignment, but thatâ€™s nothing to be too concerned about in myopinion.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">How toalign the bit stream to byte? Just work out your current bit index in thestream and how many bits are left to write until the current bit number in thebit stream divides evenly into 8, then insert that number of paddingbits. For bonus points, pad up with zero bits to add entropy so that onread you can verify that yes, you are reading a byte align and yes, it isindeed padded up with zero bits to the next whole byte bit index. If a non-zerobit is discovered in the pad bits, <u>abort serialize read and discard thepacket</u>.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Hereâ€™s mycode to align a bit stream to byte:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">void BitWriter::WriteAlign()</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   const int remainderBits = m_bitsWritten % 8;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( remainderBits != 0 )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       uint32_t zero = 0;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       WriteBits( zero, 8 - remainderBits );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       assert( ( m_bitsWritten % 8 ) == 0 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">bool BitReader::ReadAlign()</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   const int remainderBits = m_bitsRead % 8;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( remainderBits != 0 )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       uint32_t value = ReadBits( 8 - remainderBits );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       assert( m_bitsRead % 8 == 0 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       if ( value != 0 )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           return false;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">#define serialize_align( stream)           \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> do                                       \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> {                                        \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">     if ( !stream.SerializeAlign() )       \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">         return false;                    \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">  } while(0)</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Now we canuse this align operation to write an array of bytes into the bit streamefficiently: since we are aligned to bytes we can do most of the workusing memcpy. The only wrinkle is because the bit reader and bit writer work atthe word level, so itâ€™s neccessary to have special code to handle the head andtail portion of the byte array, to make sure any previous scratch bits areflushed to memory at the head, and the scratch is properly setup for the nextbytes after the array in the tail section.</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">void BitWriter::WriteBytes( const uint8_t<em> data, int bytes )</em></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   assert( GetAlignBits() == 0 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   assert( m_bitsWritten + bytes  8 &lt;= m_numBits );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   assert( ( m_bitsWritten % 32 ) == 0 || </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           ( m_bitsWritten % 32 ) == 8||              </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           ( m_bitsWritten % 32 ) == 16 || </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           ( m_bitsWritten % 32 ) == 24 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   int headBytes = ( 4 - ( m_bitsWritten % 32 ) / 8 ) % 4;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( headBytes &gt; bytes )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       headBytes = bytes;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   for ( int i = 0; i &lt; headBytes; ++i )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       WriteBits( data[i], 8 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( headBytes == bytes )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       return;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   assert( GetAlignBits() == 0 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   int numWords = ( bytes - headBytes ) / 4;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( numWords &gt; 0 )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       assert( ( m_bitsWritten % 32 ) == 0 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       memcpy( &amp;m_data[m_wordIndex], data+headBytes, numWords<em>4 );</em></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       m_bitsWritten += numWords  32;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       m_wordIndex += numWords;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       m_scratch = 0;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   assert( GetAlignBits() == 0 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   int tailStart = headBytes + numWords <em> 4;</em></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   int tailBytes = bytes - tailStart;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   assert( tailBytes &gt;= 0 &amp;&amp; tailBytes &lt; 4 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   for ( int i = 0; i &lt; tailBytes; ++i )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       WriteBits( data[tailStart+i], 8 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   assert( GetAlignBits() == 0 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   assert( headBytes + numWords  4 + tailBytes == bytes );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">void ReadBytes( uint8_t<em> data, int bytes )</em></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   assert( GetAlignBits() == 0 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   assert( m_bitsRead + bytes  8 &lt;= m_numBits );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   assert( ( m_bitsRead % 32 ) == 0 || </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           ( m_bitsRead % 32 ) == 8 || </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           ( m_bitsRead % 32 ) == 16 || </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           ( m_bitsRead % 32 ) == 24 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   int headBytes = ( 4 - ( m_bitsRead % 32 ) / 8 ) % 4;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( headBytes &gt; bytes )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   headBytes = bytes;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   for ( int i = 0; i &lt; headBytes; ++i )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   data[i] = ReadBits( 8 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( headBytes == bytes )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       return;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   assert( GetAlignBits() == 0 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   int numWords = ( bytes - headBytes ) / 4;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( numWords &gt; 0 )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       assert( ( m_bitsRead % 32 ) == 0 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       memcpy( data + headBytes, &amp;m_data[m_wordIndex], numWords <em> 4 );</em></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       m_bitsRead += numWords  32;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       m_wordIndex += numWords;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       m_scratchBits = 0;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   assert( GetAlignBits() == 0 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   int tailStart = headBytes + numWords <em> 4;</em></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   int tailBytes = bytes - tailStart;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   assert( tailBytes &gt;= 0 &amp;&amp; tailBytes &lt; 4 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   for ( int i = 0; i &lt; tailBytes; ++i )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       data[tailStart+i] = ReadBits( 8 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   assert( GetAlignBits() == 0 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   assert( headBytes + numWords  4 + tailBytes == bytes );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">template &lt;typename Stream&gt;<typename stream="stream"> </typename></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">bool serialize_bytes_internal( Stream &amp; stream, </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                              uint8_t<em> data, </em></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                              int bytes )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   return stream.SerializeBytes( data, bytes );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">#define serialize_bytes( stream, data, bytes)                   \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> do                                                             \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> {                                                              \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">     if ( !serialize_bytes_internal( stream, data, bytes ) )    \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">         return false;                                          \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">  } while(0)</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Now we canserialize a string by by serializing its length followed by the stringdata:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">template &lt;typename Stream&gt;<typename stream="stream"> </typename></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">bool serialize_string_internal(Stream &amp; stream, </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                               char string, </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                               int buffer_size )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   uint32_t length;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsWriting )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       length = strlen( string );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       assert( length &lt; buffer_size - 1 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_int( stream, length, 0, buffer_size - 1 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_bytes( stream, (uint8_t*)string, length );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsReading )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       string[length] = â€˜\0â€™;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">#define serialize_string( stream, string, buffer_size)             \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">do                                                                  \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{                                                                   \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( !serialize_string_internal(stream,                        \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                                    string,buffer_size ) )         \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       return false;                                               \</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">} while (0)</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">As you cansee, you can build up quite complicated serialization from basicprimitives.</span></p><p class="MsoNormal" align="left" style="line-height: 22.5pt;"><b><span style="font-size:18.0pt;font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Serializing Array Subsets</span></b></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Whenimplemeting a game network protocol, sooner or later you need to serialize anarray of objects over the network. Perhaps the server needs to send all objectsdown to the client, or an array of events or messages to be sent. This isfairly straightforward if you are sending <u>all</u> objects in the array downto the client, but what if you want to send only a subset of the array?</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">The firstand simplest approach is to iterate across all objects in the array andserialize a bool per-object if that object is to be sent. If the value of thatbool 1 then the object data follows, otherwise itâ€™s ommitted and the bool forthe next object is up next in the stream.</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">template &lt;typename Stream&gt;<typename stream="stream"> </typename></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">bool serialize_scene_a( Stream &amp; stream, Scene &amp; scene )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   for ( int i = 0; i &lt; MaxObjects; ++i )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_bool( stream, scene.objects[i].send );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       if ( !scene.objects[i].send )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           if ( Stream::IsReading )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">               memset( &amp;scene.objects[i], 0, sizeof( Object ) );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           continue;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_object( stream, scene.objects[i] );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">But whatif the array of objects is very large, like 4000 objects in the scene? 4000 / 8= 500. Ruh roh. Thatâ€™s an overhead of 500 bytes, even if you only send oneor two objects! Thatâ€™sâ€¦ not good. Can we switch it around so we take overheadpropertional to the number of objects sent instead of the total number ofobjects in the array?</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Wecan but now, weâ€™ve done something interesting. Weâ€™re walking one set of objectsin the serialize write (all objects in the array) and are walking over adifferent set of objects in the serialize read (subset of objects sent). Atthis point the unified serialize function concept breaks down. Itâ€™s best toseparate the read and write back into separate functions in cases like this:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">bool write_scene_b( protocol2::WriteStream &amp; stream, Scene &amp; scene )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   int num_objects_sent = 0;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   for ( int i = 0; i &lt; MaxObjects; ++i )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       if ( scene.objects[i].send )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           num_objects_sent++;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   write_int( stream, num_objects_sent, 0, MaxObjects );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   for ( int i = 0; i &lt; MaxObjects; ++i )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       if ( !scene.objects[i].send )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           continue;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       write_int( stream, i, 0, MaxObjects - 1 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       write_object( stream, scene.objects[i] );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">bool read_scene_b( protocol2::ReadStream &amp; stream, Scene &amp; scene )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   memset( &amp;scene, 0, sizeof( scene ) );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   int num_objects_sent; </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   read_int( stream, num_objects_sent, 0, MaxObjects );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   for ( int i = 0; i &lt; num_objects_sent; ++i )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       int index; </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       read_int( stream, index, 0, MaxObjects - 1 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       read_object( stream, scene.objects[index] );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Alternativelyyou could generate a separate data structure with the set of changed objects,and implement a serialize for that array of changed objects. But having togenerate a C++ data structure for each data structure you want serialized is ahuge pain in the ass. Eventually you want to walk several datastructures at the same time and effectively write out a dynamic data structureto the bit stream. This is a really common thing to do when writing moreadvanced serialization methods like delta encoding. As soon as you do it thisway, unified serialize no longer makes sense.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">My adviceis that when you want to do this, donâ€™t worry, just separate read and write.Unifying read and write are simply not worth the hassle when dynamicallygenerating a data structure on write. My rule of thumb is that complicatedserialization <i><u>probably</u></i> justifies separate read and writefunctions, but if possible, try to keep the leaf nodes unified if you can (eg.the actual objects / events, whatever being serialized).</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">One morepoint. The code above walks over the set of objects <u>twice</u> onserialize write. Once to determine the number of changed objects and a secondtime to actually serialize the set of changed objects. Can we do it in onepass instead? Absolutely! You can use another trick, a <u>sentinel value</u> toindicate the end of the array, rather than serializing the # of objects in thearray up front. This way you can iterate over the array only once onsend, and when there are no more objects to send, serialize the sentinalvalue to indicate the end of the array:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">bool write_scene_c( protocol2::WriteStream &amp; stream, Scene &amp; scene )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   for ( int i = 0; i &lt; MaxObjects; ++i )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       if ( !scene.objects[i].send )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           continue;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       write_int( stream, i, 0, MaxObjects );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       write_object( stream, scene.objects[i] );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   write_int( stream, MaxObjects, 0, MaxObjects );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">bool read_scene_c( protocol2::ReadStream &amp; stream, Scene &amp; scene )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   memset( &amp;scene, 0, sizeof( scene ) );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   while ( true )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       int index; read_int( stream, index, 0, MaxObjects );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       if ( index == MaxObjects )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           break;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       read_object( stream, scene.objects[index] );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">This ispretty simple and it works great if the set of objects sent is a smallpercentage of total objects. But what if a large number of objects are sent,lets say half of the 4000 objects in the scene. Thatâ€™s 2000 object indices witheach index costing 12 bitsâ€¦ thatâ€™s 24000 bits or 3000 bytes (almost 3k!) inyour packet wasted indexing objects.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">You canreduce this by encoding each object index relative to the previous objectindex. Think about it, weâ€™re walking left to right along an array, so objectindices start at 0 and go up to MaxObjects â€“ 1. Statistically speaking, youâ€™relikely to have objects that are close to each other and if the next index is +1or even +10 or +30 from the previous one, on average, youâ€™ll need quite a fewless bits to represent that difference than youneed to represent an absolute index.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Hereâ€™s oneway to encode the object index as an integer relative to the previous objectindex, while spending less bits on statistically more likely values (eg. smalldifferences between successive object indices, vs. large ones):</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">template &lt;typename Stream&gt;<typename stream="stream"> </typename></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">bool serialize_object_index_internal( Stream &amp; stream, </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                                     int &amp; previous, </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">                                     int &amp; current )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   uint32_t difference;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsWriting )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       assert( previous &lt; current );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       difference = current - previous;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       assert( difference &gt; 0 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   // +1 (1 bit)</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   bool plusOne;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsWriting )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">      plusOne = difference == 1;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_bool( stream, plusOne );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( plusOne )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       if ( Stream::IsReading )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           current = previous + 1;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       previous = current;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   // [+2,5] -&gt; [0,3] (2 bits)</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   bool twoBits;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsWriting )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       twoBits = difference &lt;= 5;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_bool( stream, twoBits );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( twoBits )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_int( stream, difference, 2, 5 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       if ( Stream::IsReading )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           current = previous + difference;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       previous = current;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   // [6,13] -&gt; [0,7] (3 bits)</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   bool threeBits;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsWriting )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       threeBits = difference &lt;= 13;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_bool( stream, threeBits );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( threeBits )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_int( stream, difference, 6, 13 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       if ( Stream::IsReading )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           current = previous + difference;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       previous = current;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   // [14,29] -&gt; [0,15] (4 bits)</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   bool fourBits;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsWriting )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       fourBits = difference &lt;= 29;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_bool( stream, fourBits );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( fourBits )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_int( stream, difference, 14, 29 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       if ( Stream::IsReading )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           current = previous + difference;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       previous = current;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">    //[30,61] -&gt; [0,31] (5 bits)</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   bool fiveBits;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsWriting )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       fiveBits = difference &lt;= 61;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_bool( stream, fiveBits );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( fiveBits )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_int( stream, difference, 30, 61 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       if ( Stream::IsReading )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           current = previous + difference;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       previous = current;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   // [62,125] -&gt; [0,63] (6 bits)</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   bool sixBits;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsWriting )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       sixBits = difference &lt;= 125;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_bool( stream, sixBits );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( sixBits )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       serialize_int( stream, difference, 62, 125 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       if ( Stream::IsReading )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           current = previous + difference;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       previous = current;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   // [126,MaxObjects+1] </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   serialize_int( stream, difference, 126, MaxObjects + 1 );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsReading )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       current = previous + difference;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   previous = current;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">template &lt;typename Stream&gt;<typename stream="stream"> </typename></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">bool serialize_scene_d( Stream &amp; stream, Scene &amp; scene )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">{</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   int previous_index = -1;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">    </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   if ( Stream::IsWriting )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       for ( int i = 0; i &lt; MaxObjects; ++i )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           if ( !scene.objects[i].send )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">               continue;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           write_object_index( stream, previous_index, i );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           write_object( stream, scene.objects[i] );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       write_object_index( stream, previous_index, MaxObjects );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   else</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       while ( true )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       {</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           int index; </span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           read_object_index( stream, previous_index, index );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           if ( index == MaxObjects )</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">               break;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">           read_object( stream, scene.objects[index] );</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">       }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   }</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">   return true;</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">}</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"> </span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">In thecommon case this saves a bunch of bandwidth because object indices tend to beclustered together. In the case where the next object is sent, thatâ€™s just onebit for the next index being +1 and 5 bits per-index for +2 to +5. On averagethis gives somewhere between a 2-3X reduction in indexing overhead. But noticethat larger indices far apart cost a lot more for each index than thenon-relative encoding (12 bits per index). This <u>seems</u> bad but itâ€™snot because think about it, even if you hit the â€˜worst caseâ€™ (objectsindices spaced apart evenly with by +128 apart) how many of these can youactually fit into an object array 4000 large? Just 32. No worries!</span></p><p class="MsoNormal" align="left" style="line-height: 22.5pt;"><b><span style="font-size:18.0pt;font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Protocol IDs, CRC32 and Serialization Checks</span></b></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">At thispoint you may wonder. <u>Wow</u>. This whole thing seems reallyfragile. Itâ€™s a totally unattributed binary stream. A stack of cards. Whatif you somehow desync read and write? What if somebody just sent packetscontaining random bytes to your server. How long until you hit a sequence ofbytes that crashes you out?</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">I havegood news for you and the rest of the game industry since most game serversbasically work this way. There are techniques you can use to reduce orvirtually eliminate the possibility of corrupt data getting past theserialization layer.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">The firsttechnique is to include a protocol id in your packet. Typically, the first 4bytes you can set to some reasonable rare and unique value, maybe 0x12345678because nobody else will ever think to use that. But seriously, put in a hashof your protocol id and your protocol version number in the first 32 bits ofeach packet and youâ€™re doing pretty good. At least if a random packet gets sentto your port from some other application (remember UDP packets can come in fromany IP/port combination at any time) you can trivially discard it:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">[protocol id] (32bits)</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">(packet data)</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">The nextlevel of protection is to pass a CRC32 over your packet and include that in theheader. This lets you pick up corrupt packets (these do happen, rememberthat the IP checksum is just 16 bits, and a bunch of stuff will not get pickedup by a checksum of 16bitsâ€¦). Now your packet header looks ilke this:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"><a href="32bits">protocol id</a></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"><a href="32bits">crc32</a></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">(packet data)</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">At thispoint you may be wincing. Wait. I have to take 8 bytes of overhead per-packetjust to implement my own checksum and protocol id? Well actually, <u>you donâ€™t</u>.You can take a leaf out of how IPv4 does their checksum, and make the protocolid a <i><u>magical prefix</u></i>. eg: you donâ€™t actually send it, but if bothsender and receiver <u>knows</u> the protocol id and the CRC32 iscalculated <u>as if</u> the packet were prefixed by the protocol id, the CRC32will be incorrect if the sender does not have the same protocol id as thereceiver, saving 4 bytes per-packet:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">[<span class="msoDel">protocol id] (32bits)</span></span><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">  // not actually sent, but used to calc crc32</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"><a href="32bits">crc32</a></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">(packet data)</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Of courseCRC32 is only protection against random packet correction, and is no actualprotection against a malicious sender who can easily modify or construct amalicious packet and then properly adjust the CRC32 in the first four bytes. Toprotect against this you need to use a more cryptographically secure hashfunction combined with a secret key perhaps exchanged between client andserver over HTTPS by the matchmaker prior to the client attempting to connectto the game server (different key for each client, known only by the server andthat particular client).</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">One finaltechnique, perhaps as much a check against programmer error on your part andmalicious senders (although redundant once you encrypt and sign your packet) isthe <u>serialization check</u>. Basically, somewhere mid-packet, either beforeor after a complicated serialization section, just write out a known 32 bitinteger value, and check that it reads back in on the other side with the samevalue. If the serialize check value is incorrect <u>abort read and discardthe packet</u>.</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">I like todo this between sections of my packet as I write them, so at least I know whichpart of my packet serialization has desynced read and write as Iâ€™m developingmy protocol (itâ€™s going to happen no matter how hard you try to avoid itâ€¦).Another cool trick I like to use is to serialize a protocol check at the veryend of the packet, this is super, super useful because it helps pick up packettruncations (like the infamous, little endian vs. big endian truncation of thelast word from the </span><span><a rel="noopener" href="http://gafferongames.com/building-a-game-network-protocol/reading-and-writing-packets/" target="_blank"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;">previous article</span></a></span><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">).</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">So now thepacket looks something like this:</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">[<span class="msoDel">protocol id] (32bits)</span></span><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">  // not actually sent, but used to calc crc32</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222"><a href="32bits">crc32</a></span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">(packet data)</span></p><p class="MsoNormal" align="left" style="margin: 18pt 18.05pt;"><span style="font-size:12.0pt;font-family:&quot;Courier New&quot;;color:#222222">[end of packetserialize check] (32 bits)</span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">You canjust compile these protocol checks out in your retail build if you like,especially if you have a good encryption and packet signature, as they shouldno longer be necessary.</span></p><p class="MsoNormal" align="left" style="line-height: 22.5pt;"><b><span style="font-size:18.0pt;font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Up next: </span></b><span><a rel="noopener" href="http://gafferongames.com/building-a-game-network-protocol/packet-fragmentation-and-reassembly/" target="_blank"><b><span style="font-size:18.0pt;font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;text-decoration:none">Packet Fragmentation and Reassembly</span></b></a></span></p><p class="MsoNormal" align="left"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">Read onfor the next article in this series where I show you how to extend your networkprotocol to perform packet fragmentation and reassembly so you can keep yourpacket payload under MTU.</span></p><p class="MsoNormal" align="left"><span><a rel="noopener" href="http://www.patreon.com/gafferongames" target="_blank"><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;">Pleasesupport my writing on patreon</span></a></span><span style="font-family:&quot;Lucida Sans Unicode&quot;,&quot;sans-serif&quot;;color:#222222">, and Iâ€™llwrite new articles faster, plus you get access to example source code for thisarticle under BSD 3.0 licence. <b><u>Thanks for your support</u>!</b></span></p><p class="MsoNormal"><span> </span></p></div><br>                <br>                

      


      

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/GafferOnGames/" rel="tag"><i class="fa fa-tag"></i> GafferOnGames</a>
            
          </div>
        

        
        
        

        
          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/reading_and_writing_packets/" rel="next" title="æ„å»ºæ¸¸æˆç½‘ç»œåè®®ä¸€ä¹‹æ•°æ®åŒ…çš„è¯»å–å’Œå†™å…¥">
                  <i class="fa fa-chevron-left"></i> 
                  <p class="post-nav-pre-next-title">
                    æ„å»ºæ¸¸æˆç½‘ç»œåè®®ä¸€ä¹‹æ•°æ®åŒ…çš„è¯»å–å’Œå†™å…¥
                  </p> 
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/packet_fragmentation_and_reassembly/" rel="prev" title="æ„å»ºæ¸¸æˆç½‘ç»œåè®®ä¸‰ä¹‹æ•°æ®åŒ…çš„åˆ†åŒ…å’Œé‡ç»„">
                <p class="post-nav-pre-next-title">
                    æ„å»ºæ¸¸æˆç½‘ç»œåè®®ä¸‰ä¹‹æ•°æ®åŒ…çš„åˆ†åŒ…å’Œé‡ç»„
                </p> 
                <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        

        
        
      </footer>
      
    </div>
    
    
    

    

    

    

  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  

  <aside id="sidebar" class="sidebar">

    
      
        <div id="sidebar-dimmer"></div>
      
    

    <div class="sidebar-inner">
    
      <div class="sidebar-toggle-inside motion-element">
        <div class="sidebar-toggle-line-wrap">
          <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
          <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
          <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
        </div>
      </div>

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a href="/" class="site-author-image" rel="start" style="border:none">
            <img class="site-author-image" itemprop="image" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/uploads/avatar.png" alt="Mike">
          </a>
          <p class="site-author-name" itemprop="name">Mike</p>
           
              <p class="site-description motion-element" itemprop="description">ğŸš™ ğŸš— ğŸ’¨ ğŸ’¨ If you want to create a blog like this, just follow my open-source project, "hexo-theme-neo", click the GitHub button below and check it out ^_^ . It is recommended to use Chrome, Safari, or Edge to read this blog since this blog was developed on Edge (Chromium kernel version) and tested on Safari.</p>
          
        </div>

        <nav class="site-state motion-element">

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">298</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">111</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

          <div class="site-state-item site-state-about">
            <a href="/about/">
              <span class="site-state-item-about fa fa-fw fa-user"></span>
              <span class="site-state-item-name">about</span>
            </a>
          </div>
          
        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/no5ix" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://open.spotify.com/user/313duq77ekebrfyak3xijqewzss4?si=e7653b829a9747bf" target="_blank" title="Spotify">
                  
                    <i class="fa fa-fw fa-spotify"></i>
                  
                    
                      Spotify
                    
                </a>
              </span>
            
          
          
          <!-- ç½‘æ˜“äº‘éŸ³ä¹ -->
            <!-- <div class="netease-cloud-music"> -->
              <!-- <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=110 src="//music.163.com/outchain/player?type=0&id=992743594&auto=0&height=90"></iframe> -->
            <!-- </div> -->
          <!-- ç½‘æ˜“äº‘éŸ³ä¹ -->

        </div>

        
        

        
        

        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#è‡ªæˆ‘æ€»ç»“æœ¬ç¯‡æ¦‚è¦"><span class="nav-text">è‡ªæˆ‘æ€»ç»“æœ¬ç¯‡æ¦‚è¦</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#åŸæ–‡"><span class="nav-text">åŸæ–‡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#introduction"><span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#serializing-bits"><span class="nav-text">Serializing Bits</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#implementation-in-c"><span class="nav-text">Implementation in C++</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#serializing-floating-point-values"><span class="nav-text">Serializing Floating Point Values</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#serializing-vectors-and-quaternions"><span class="nav-text">Serializing Vectors and Quaternions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#serializing-strings-and-arrays"><span class="nav-text">Serializing Strings and Arrays</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#serializing-array-subsets"><span class="nav-text">Serializing Array Subsets</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#protocol-ids-crc32-and-serialization-checks"><span class="nav-text">Protocol IDs, CRC32 and Serialization Checks</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#è¯‘æ–‡"><span class="nav-text">è¯‘æ–‡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ç»Ÿä¸€çš„æ•°æ®åŒ…åºåˆ—åŒ–åŠŸèƒ½"><span class="nav-text">ç»Ÿä¸€çš„æ•°æ®åŒ…åºåˆ—åŒ–åŠŸèƒ½</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è¾¹ç•Œæ£€æŸ¥å’Œç»ˆæ­¢è¯»å–"><span class="nav-text">è¾¹ç•Œæ£€æŸ¥å’Œç»ˆæ­¢è¯»å–</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åºåˆ—åŒ–æµ®ç‚¹æ•°å’Œå‘é‡"><span class="nav-text">åºåˆ—åŒ–æµ®ç‚¹æ•°å’Œå‘é‡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åºåˆ—åŒ–å­—ç¬¦ä¸²å’Œæ•°ç»„"><span class="nav-text">åºåˆ—åŒ–å­—ç¬¦ä¸²å’Œæ•°ç»„</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åºåˆ—åŒ–æ•°ç»„çš„å­é›†"><span class="nav-text">åºåˆ—åŒ–æ•°ç»„çš„å­é›†</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åè®®IDå’ŒCRC32å’Œåºåˆ—åŒ–æ£€æµ‹"><span class="nav-text">åè®®IDå’ŒCRC32å’Œåºåˆ—åŒ–æ£€æµ‹</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#åŸæ–‡æ—§ç‰ˆæœ¬"><span class="nav-text">åŸæ–‡æ—§ç‰ˆæœ¬</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mike</span>
</div>



        

        
      </div>
    </footer>

    <!--
    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      
        <span id="scrollpercent"><span>0</span>%</span>
      
    </div>
    -->

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>










  















  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/mediumzoom/medium-zoom.js?v=1.1.0"></script>





  




  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>


  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  

    <script src="/js/src/local-search.js"></script>





  

  

  

  

  

  


  <script type="text/javascript" src="/lib/wobble_window/wobblewindow.js"> </script>
<script type="text/javascript" src="/js/src/custom.js"></script>
</body>
</html>






<script type="text/javascript" src="/js/src/headroom.js"></script>

<!-- ä»£ç å—å¤åˆ¶åŠŸèƒ½ -->
<script type="text/javascript" src="/js/src/code-highlight-modification.js"></script>

<!-- Flashcards Script -->
<script type="text/javascript" src="/js/src/flashcards.js"></script>
