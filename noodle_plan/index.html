<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


  <meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)">

<script>
    (function(){
        if('mmp'){
            let localStoragePasswdKey = 'noodle_plan' + '_last_passwd';
            let tryCnt = 0;
            function checkPassword(password) {
                password = password == null ? null : password.trim();
                if (password !== 'mmp') {
                    if (password != null) {
                        // å¦‚æœç”¨æˆ·ç‚¹å‡»äº†ç¡®è®¤è€Œä¸”å¯†ç é”™è¯¯çš„æ—¶å€™, å› ä¸ºå½“password == nullçš„æ—¶å€™è¯´æ˜ç”¨æˆ·ç‚¹äº†å–æ¶ˆ
                        alert('Error!');
                        if (++tryCnt < 3) {
                            password = prompt('Open Sesame');
                            checkPassword(password);
                            return;
                        }
                    }

                    // if (history.length > 1) {
                    //     alert('back!');
                    //     history.back();
                    // } else {
                        // alert('blankkkk!');
                    //     window.location.href = "about:blank";
                    // }
                    if (document.referrer) {
                        window.location.href = document.referrer;
                    } else {
                        window.location.href = "about:blank";; // fallback if no referrer
                    }

                } else {
                    localStorage.setItem(localStoragePasswdKey, password);
                }
            }

            var password_verify_on_local = false;
            const hostname = window.location.hostname;
            if (password_verify_on_local || (!(hostname === "localhost" || hostname === "127.0.0.1" || hostname === "::1" || hostname.startsWith("192")))) {
                const lspk = localStorage.getItem(localStoragePasswdKey) || "";
                if (lspk !== 'mmp') {
                    var password = prompt('Open Sesame');
                    checkPassword(password);
                }
            }
        }
    })();
</script>








<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">





















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="noodle,">








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2">






<meta name="description" content="pending_fini çœ‹çœ‹å…¶ä»–å†…å­˜åº“çš„ä¼˜åŒ–å®ç°,,å¦‚tcmallocå•¥çš„ ç®—æ³•ç±» çº¿æ®µæ ‘ å­—å…¸æ ‘  lcé«˜é¢‘ çƒ­é—¨ kmp lc 174 åœ°ä¸‹åŸæ¸¸æˆé—®é¢˜ çŸ©é˜µç›¸å…³çš„ç®—æ³•é¢˜ lfu, ä»£ç å¤ªé•¿, è€Œä¸”ç”¨åˆ°äº†ä¸å¸¸ç”¨çš„æ•°æ®ç»“æ„, ç›®æµ‹ä¸å¤ªä¼šè€ƒ       å¾®ä¿¡ç¤¾æ‹›é¢ç»çš„é¢/ç¬”è¯•é¢˜ å­—èŠ‚è·³åŠ¨ç™¾åº¦æ‹¼å¤šå¤šé¢ç¬”è¯•é¢˜  . . .">
<meta name="keywords" content="noodle">
<meta property="og:type" content="article">
<meta property="og:title" content="noodle_plan">
<meta property="og:url" content="https://hulinhong.com/noodle_plan/index.html">
<meta property="og:site_name" content="ğŸš™">
<meta property="og:description" content="pending_fini çœ‹çœ‹å…¶ä»–å†…å­˜åº“çš„ä¼˜åŒ–å®ç°,,å¦‚tcmallocå•¥çš„ ç®—æ³•ç±» çº¿æ®µæ ‘ å­—å…¸æ ‘  lcé«˜é¢‘ çƒ­é—¨ kmp lc 174 åœ°ä¸‹åŸæ¸¸æˆé—®é¢˜ çŸ©é˜µç›¸å…³çš„ç®—æ³•é¢˜ lfu, ä»£ç å¤ªé•¿, è€Œä¸”ç”¨åˆ°äº†ä¸å¸¸ç”¨çš„æ•°æ®ç»“æ„, ç›®æµ‹ä¸å¤ªä¼šè€ƒ       å¾®ä¿¡ç¤¾æ‹›é¢ç»çš„é¢/ç¬”è¯•é¢˜ å­—èŠ‚è·³åŠ¨ç™¾åº¦æ‹¼å¤šå¤šé¢ç¬”è¯•é¢˜  . . .">
<meta property="og:locale" content="en">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="http://www.plantuml.com/plantuml/svg/ZLBBJi9G4DttAsvOmo-OI731WXLBmm9jGPAcZOX6OaWK4r8YB-KH20Y24Z6chKOIDK3u6Uw3l_3YvN7RIkAgCtFkd9bpEeUoUYg22m60VMZqaFQ9NysGa184CPm87uHF9E0A98F7ikltJKILHIaEN44fVYR5uNkQbMapcRPHeGyRWn3BKQTFp1uUbw5UNvQWba7jqkR9R5o7kHhNadqctTmcjr2ckEa-BzXJeZ55uXVmAuhgyovR0qb_S3UmcglNONe0nrLKBfmpBggFamiydXtBE2vcc5MD0-QKSV6VhNQOCu6BbwqRGxYOOIkv3c0btG7OR104HKr881wB7YM06h7PZOqkBcLOoGtG_VMyKIB64p6l14aHmQBLGM3vlyJCeuygAxbffg-pxGJscu6tazcN3hK6RWxf7cHQWSqs7fLHksKdaQK8ux0S5RE065setU5A1sbq5JpiKG_cbrbqyxALnNAAg9oVJLhCE2hbFriuJcvHADPGzGtb3UhdmpVz4dC4Cus5vyN7DTCF">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="http://www.plantuml.com/plantuml/svg/dPF1Qjj048RlUeevfc1R1PzgGY0nQLhQWa2-bM9sDukyTBKIkniRdKk2APHIA4aElHHwoCcN7f9BsgUHqhn5HxkLBJMcX-vfPdPc_cz6Ay9ifY4XAP_caXHSJvaKN5aW1bXmJ2oXn728Xq6WERD49P93Ok1r07XswLvrSrCjFrPVFkpKJSnSFt8t0ppEY0exonGiX9rXJv6nJ7DtqSVZZFqvgcXdth-xAfTdOzJdkWUnFQ71cxOmRGilBwlpYrgO4clbVqaVAYjiCO83rw47qKcUStiWrB6_SKalCqPaa-bXVLuFdigY1gq5EvnfYxFyiKB8yltNdTJycp7XSvnyst9YhkU28U0hOjbixNdijVi0W-HYmx4VFOSZOlc255s4kzjFvUdthcpvxHp3Tv-lgkNrhzNF-ulLpDhSZC8mUVAO98k14doWkENuE0OiIttHsUcMedLDNwW7PN_ZJeqVPeCDDVUV4RlSHvd4EdWscKGkWMiG2k8YpN6Z1OHmE8wxKqdn5jSaiqIe7fZXUcCCTllzFNpM8vYCeyQbwBuOHs4hX8GZS9l0I1s8XzuF0lmdN4fg0hencoXrPgT5wFlGxU7wqpMIpLA2zeAy-cy0">
<meta property="og:image" content="http://www.plantuml.com/plantuml/svg/bPHFQnD16CRlyoc6w7LP8I2wf84cWIeK36x4eqntnztHpSooEsd9JT13iRLwKamz6F4G4AfWfIcK-cMIRNBgL_2TcKtO3Jt4s_2yl_Tv_-pif7729CMtFT6DyGkIE2JnGjObajfA4fnoYT8SIccoopowmkLgYQB92kJJ4kD538nN6E99aI2q5F2jTjXFcKSYt3GyIN4JrseQhDTl95rJ7KWNI5CMq2BReLx8HII2FdxaKS8Lt6e0dKzITYxGRdKDQ7Ood9sUAy-OzDVWAvljXtWBr3tIhwYqhQUbh6BQPXn7CALaWkDASF-E3GwCMsRZEjdTLWeOBBzUkN3PuUuzEo7yfSby3ATr4w5qwYMKSckd5qLK6eU6Fl-FHzKawiMkcmHhxG9LchgjLrrqG4ri-MAFMtLOg8CVT3fj5y5g5w9Pb8DjqfDXAM2cW4XAkL-Ag0s17b3vJAqDeNnd1i2kWv_4lcfQoKXFLGn5WlZsDakbtQ9GWIBTzjBTmN1_8onun3Z5P5UMuws6Wnc7eINsXGT7AN2NfYa9Q8hWhbi92qAfGJsyigoQmNKhLY_EfHiwGN6n4oYhnWzPZ5140rW3ZkXpYQR7bvFBW-kB0Qhf1wFkO7Lv5mz0RV50W3xz_d7-UfHzUJTzEym3D04z6u-p_VT6dtuUAIFzQwkKas_P_jdLZvzeOmDblqTGPybDnaU5IfFpW_cdqwl1c_chmUJlyFhYSFhXCFjwDllpg_0p8UZRTFyF">
<meta property="og:image" content="http://www.plantuml.com/plantuml/svg/dLDDIyD04BtdLynH8TL3RoA5jjGl50lfJKGcoP0i9fkmkwtaB4WHn9jwyEBDa-UU_3Sj-2_Sx3PjGaNGERtPUPbvRxCJea8V9S5vGCW19QGPZp8dhCu5XKp2XGCwJaWnQT2E3WC62Kh5-XZ4v5okl_BQQqmg21r7KA2GHmb1LBNRzpkBsMmnVLoyFcn5c9ASYErc-s6Xuep33LEnriQo81Da2YqT1dGdUeumyElsVJwzwnDN95pmrDXlKiiHANACoF93lvv5g6X5qrvgYlswukdBukcvLEoZKic_D0-uOghOWvxfuC9mdEUaUeo7jc98frc0ISMqBYtFXOEaA1rM0_zgq0flManh5kUV7zhV_FvjAvM_sujeec_xfn_YaPYmG7ixGnN4gymwNgKR3gIjNAsqBW-QOZ5dQxNTuJ4i6pQ57cQ9fiFHQ3Gq11B0E7X5cclz1Up2eEyrfmlarouaMSIu2x9jzUd9vRnMgrE-wWhQBQaoioIEer_skkRNaxIUB6bcB_mQJZUnQVmD">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="http://www.plantuml.com/plantuml/svg/AqWiAibCpYn8p2jHK0hApyyDJYqgoqnEZSdpJIn9pe3ob1GIYnMAkGgG53ibbfJaf4BbGT99N2c99Ob9YSMf2a6fAPd58B4YBgvY1LqxXIGhXSI2WfpA-2ImBWqzFJrDhYIGJ94LrAIWrCBIrE8IlUB4CeZyqxQPppfcF9is_SNwxSysDi6L9-VdbQHMbEZb59GMPsWuEOQ4-BZ61uQwXhh6Uxj6wYX0h8ZFJD440000">
<meta property="og:image" content="http://www.plantuml.com/plantuml/svg/VP2_Ri8m48TtFyM9gKJAqB8nL2BCB6LiKNHnJYMAROnzZLHL7RkL1-A167YBEhPI_WZXyNw_xxkJBSeMtmb6dbpNI2hD2Bu4XFUwG9RhPHgl03re8xw5iDU4laFecuJz9mfaLdIELBv7QcIiq1EyKDtuVkw4c7LXwY3FduDu2bason-p32GQIQhK_NAXTSnTYfz2N9CYfalQz74HQKVR3_8yuEQ45n5lJBYQHHIdlOVV_V5dnuriOttGpQFkBBoGpQDCRMHRCg7sR-OX7JOUQfLFlKdeeRNgiwpYv_m1">
<meta property="og:image" content="http://www.plantuml.com/plantuml/svg/7Sen3i8m34RXtQVm20CvG0SasDWG7A3wanZ94cein-JyD5tVzr2YETy60ixe339uQ5735dn7n5VUuaEBJCvKzpEZ2x-aQf_DYS2NA-U5NQnvhFOparYhbZYbbCwKf_l2pmCUswUbZY47_W40">
<meta property="og:image" content="http://www.plantuml.com/plantuml/svg/TP6_JW914CRxVOefeV22XGs52PYhD2OY55QNlRk9kRZUhhkBiQIGH31Q2Z4aLYPQq15YWq_3BVWMxXt8VpVPBRxvpJUpCu9A7GMHeB66CjMQOOan7b3DvH766YLG1RuYOeixHtaR1PZ5IKWrzQb2g60OgLIJX33E1T2P7Nf-bkLPboi2zlYmTmYo206tPUwq8mKNkNAfMZrnlREQMtEzO_SYdw4oHVqYp2sYa6GoPNef9Vrkqll8zFHSIbuNu0d90rHgNdmHNQq_-qq5R-gejCCu3NEEu-JNs8q6v0pUYOWwO_OH0hKNHe7UhccXwR1fEiD9lvLyDrVOyLVRjDztPlmqMkRnSpfucuv6fjSOZvudh_VceMjUEgRtj2D5sSbAJ0SlyPelvhzEghbx1PNWiLf6CGx9PWkA8GeeE8NzB8JChdinVh1RF-Kn_fjrGFvyxVq5">
<meta property="og:image" content="http://www.plantuml.com/plantuml/svg/VL7DIiCm7B_dASAEXGs_3nu4zGtSqOwGfN-qh4j3aWv5X89UYZ1lEyXW5mzwLjXXz6rSkxs5ITk3srfxIE7t7I8e6z0RmAq-rJe0ijV23mYRx_gY0Cw386HKX_8Ik0RPmrJXFcMragwE-ZtqY93O2hrh2YqSPQJQC2gG8vy16MuvkoLUUjImriF_zN3hyQYcfXBm5NY-GcZvFba_VUHVYtmnm-tscSq-nLI8u9vKTp2B1owt9_5v1Reysa4aY51g8Y8XG1FFPzhbdKwdeS9nzXrdemWP71kwM6O51qOGY4ZT8bHWkF1oInqQIefGx117XbYDvylNIPR4sJHn-Pyzfe6N2oYpucCZNiT9zlAv-fwjqZIRnZ_fE7zxBWUfaNGvaq0r40d3qFogfSW4L475qfEc8FlCzHc_">
<meta property="og:image" content="http://www.plantuml.com/plantuml/svg/bLPRJnj757xVNx5I7X9BlYXHsmSKLKA5Lb6RboPL7qfbBTu1Rp2pxkuw4MycOB2fBuIxkGIRGB12i558ZQ_up-pCxZxrB_IinzYmDYbPhLQpC-TyvphVZ2Pf8SGRsJffhfDQXiGtoSubfqv9E2memZG_BWIc9XKvWiKVv92iyFT-j9zHxhxPobgBIRsICj_F6ck5tuEIXjmysSdfbPhHV6Fb_w6x7ytQ2Tqg6TcccVZavesrVHfVDhRdmOIHMDGRsoIpPKKpT2lDtU-Pd9Qn70WgyZJYDIM2hY-fwAy8mW7q5AcgC8c6Gz8avWC8QqZXX8WcuyZqE0plzyPW7XpIQmlcuWUoL30Q6oHp0Ivmd13G81vIFA3n2-Ean8tRGGhAp5KoBejqDqMMybn03eLGG9DahF8qlM9jxLzVmveYXtXQgT1uXXmUatGCbZXHq8HnGKNyy4iOAS-Gyb8A80uybRGPtYpcpSzLQwvWRHPKy3Le5W_DqkmDnT-mz6paPrh9MREh7DTra_VySKz1uf_Vtn3WXpfUT-Hxue-PkCSftZRhVw7AU0m_O6iaiq4MQv0RwqCIlB7NzCed-BVz-UuRcckGHiOro1L7nW3UPyC3Cicyfkjd3uTuhBexIG8Pepx_P0IQfRtuwBepBiw91KR6Gn44LcxF6XWajJMpT0JL9kaw2vBcydOWhQnU-T0pq8V_k8Fl-H_ydRVaCCKFm_IlA1oQQVUF1CL5VVroMmIUGOaYrNDQVqEMSdHlpcmMpT81FL-dYKiIFzChV-kLA7X_CszGaEw488gAUmppndoPBAVfkoZTFwAdXps5xNamQMKNQFgOnCjwAqzdItPPth-sKxNytgX_fak7FlFWP5p0FfOuAxji7Up15pHyi7V9SegardqMkCb6Fprb0-Cq0Q_hwmAcIqjO9Il9RYRroYcuEVnaX2PMIJ863F7YbGO-GXoQF8MmJI3rRBVhW6letX40EA3rsg5UMm4aD_yjYIzOA_lFd__YSlDZ63I6Hv-HKjKuFeD4azA2KTo4BBDnrm_6JhqA-qTnG9a9QqYq4rO2n2EoMt1iTBswJzSkWLxiIjMRBav4j_O5P_Dek4CXnaw5nCxxKzThTmVLiDGDSe_N6pd8a4DUR-qPnVmO9jKoD9MrMMG5jtQZGDXCzWjxeTyu46y4-IKy8Jzu9KYQNn9zOLdrXH2Ur88-DOoGw1h4E_qTq4Ew6vVOvgviklcWfeNzGII8I1c2Hd7T7iJ0xckJ0kW1-rJB97v1DyxWxmkiCp0Joem_454Klwe9MaIzSix5URtURaWqLwMf8cckaaHARwOCsDp5I_YIuZRTB9DiWIPdZVfffpXjAsn_0iXNLQOpKqn2-xfvixK6N3MeJ-vMdJkZ8ImEF9SSEmGW1sdtwDDvT3hrFOCW7JEC-OQ02U5vwENfUO7EPx3QFlrJxMyQhYDqjmRxr5py_6yZQSssI2nbiqdyGc-sO43Y9zUvjNiGige0wR1aCIEFl9sxpe3Wx1jEco--J1PkXcG_D04JDyJDkIOzVMVaY-RnEzA8sZns9SncRBvlDpE9bHc5JWhJI1BPDk_4smPa8Tynh-m8QMEmGs6GterBZKFBofVXXkM6gzkCVqeAJFNfF_RqwPEp1LMSYaYYDnmIj0bPcVO6WWB6A4HEjqZiIB_SWSEGVipt6nh3RfwDZFegVRjhHRUD_QC7K7N6T6oDnZVCQ8oD0ScejMpNaEYN9oPki9PdG4xwuQ-pl4F-Fm00">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="http://www.plantuml.com/plantuml/svg/YzQALT3LjLF8ICt9oTTBveg6yejBKZBpzJAueE8AkaMPwHabG8cNYrgUBcbvFg6D2we4h1mX2cSXj43Co5JWWZ7WCi_tJ7knVY8NX4BNa0XLduYGUBQn7QYM2qAXgy-7gi-7k6ZolcTzIxboCfEIGIOWH20KGdEYNdvf2G00">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">
<meta property="og:updated_time" content="2025-12-17T18:31:29.667Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="noodle_plan">
<meta name="twitter:description" content="pending_fini çœ‹çœ‹å…¶ä»–å†…å­˜åº“çš„ä¼˜åŒ–å®ç°,,å¦‚tcmallocå•¥çš„ ç®—æ³•ç±» çº¿æ®µæ ‘ å­—å…¸æ ‘  lcé«˜é¢‘ çƒ­é—¨ kmp lc 174 åœ°ä¸‹åŸæ¸¸æˆé—®é¢˜ çŸ©é˜µç›¸å…³çš„ç®—æ³•é¢˜ lfu, ä»£ç å¤ªé•¿, è€Œä¸”ç”¨åˆ°äº†ä¸å¸¸ç”¨çš„æ•°æ®ç»“æ„, ç›®æµ‹ä¸å¤ªä¼šè€ƒ       å¾®ä¿¡ç¤¾æ‹›é¢ç»çš„é¢/ç¬”è¯•é¢˜ å­—èŠ‚è·³åŠ¨ç™¾åº¦æ‹¼å¤šå¤šé¢ç¬”è¯•é¢˜  . . .">
<meta name="twitter:image" content="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"scrollpercent":true,"onmobile":true,"dimmer":true,"body_content_height":0,"display_duration":150},
    local_search: {"enable":true,"trigger":"auto","top_n_per_article":1},
    fancybox: false,
    mediumzoom: true,
    darkmode_js: false,
    tabs: true,
    motion: {"enable":true,"async":false,"duration":188,"transition":{"header":"fadeIn","menu":"fadeIn","logo":"fadeIn","post_block_else":"fadeIn","post_header":"fadeIn","post_body":"fadeIn","coll_header":"fadeIn","footer":"fadeIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>








  <title>noodle_plan | ğŸš™</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ğŸš™</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">ğŸ’¨ ğŸ’¨ ğŸ’¨</p>
      
  </div>

  <div class="menu-item sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div class="menu-item site-search">
    
  
  <div class="site-search-div">
    <button class="search-icon" id="search-button">
      <i class="fa fa-search"></i>
    </button>
    <input type="text" id="local-search-input" class="st-search-input">
    <i id="local-search-close">Ã—</i>
  </div>


<script type="text/javascript" id="local.search.active">
    {/* var inputArea       = document.querySelector("#local-search-input");
    inputArea.onclick   = function(){ getSearchFile(); this.focus(); }
    inputArea.onkeydown = function(){ if(event.keyCode == 13) return false } */}
</script>



  </div>
  <div id="local-search-result-pc" class="local-search-result-cls"></div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      

       
    </ul>
  

  
    
  
</nav>



 </div>
    </header>

    <div id="local-search-result-mobile" class="local-search-result-cls"></div>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hulinhong.com/noodle_plan/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mike">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ğŸš™">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">noodle_plan</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-08-06T08:08:06+00:00">
                08-06-2018
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Noodle/" itemprop="url" rel="index">
                    <span itemprop="name">Noodle</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            <div class="post-tags">
              
                <a href="/tags/noodle/" rel="tag"><i class="fa fa-tag"></i> noodle</a>
              
            </div>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    




    
    
    
    <div class="post-body" itemprop="articleBody">
      
      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/zen_åœ¨æè´¨é‡Œé¢ç©¿å€¼ç»™GBuffer/" rel="next" title="åœ¨æè´¨ä¼ å€¼ç»™GBuffer">
                <i class="fa fa-chevron-left"></i> 
                <p class="post-nav-pre-next-title">
                  åœ¨æè´¨ä¼ å€¼ç»™GBuffer
                </p> 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/fd_inode/" rel="prev" title="æ–‡ä»¶æè¿°ç¬¦FDä¸Inode">
              <p class="post-nav-pre-next-title">
                  æ–‡ä»¶æè¿°ç¬¦FDä¸Inode
              </p> 
              <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      

      
      

      
        <h1 id="pending-fini"><a href="#pending-fini" class="headerlink" title="pending_fini"></a>pending_fini</h1><ul>
<li>çœ‹çœ‹å…¶ä»–å†…å­˜åº“çš„ä¼˜åŒ–å®ç°,,å¦‚tcmallocå•¥çš„</li>
<li>ç®—æ³•ç±»<ul>
<li>çº¿æ®µæ ‘ å­—å…¸æ ‘ </li>
<li>lcé«˜é¢‘ çƒ­é—¨</li>
<li>kmp</li>
<li>lc 174 åœ°ä¸‹åŸæ¸¸æˆé—®é¢˜</li>
<li>çŸ©é˜µç›¸å…³çš„ç®—æ³•é¢˜</li>
<li>lfu, ä»£ç å¤ªé•¿, è€Œä¸”ç”¨åˆ°äº†ä¸å¸¸ç”¨çš„æ•°æ®ç»“æ„, ç›®æµ‹ä¸å¤ªä¼šè€ƒ</li>
</ul>
</li>
</ul>
<!-- * httpè½®è¯¢ -->
<!-- * websocket -->
<ul>
<li><a href="https://jishuin.proginn.com/p/763bfbd27fa0" target="_blank" rel="noopener">å¾®ä¿¡ç¤¾æ‹›é¢ç»çš„é¢/ç¬”è¯•é¢˜</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzIwNTA4NzI1Mw==&amp;mid=2247486096&amp;idx=1&amp;sn=ea19bfbecd6b0a27341cbd3fb7b2344d&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">å­—èŠ‚è·³åŠ¨ç™¾åº¦æ‹¼å¤šå¤šé¢ç¬”è¯•é¢˜</a></li>
</ul>
<p><strong>. . .</strong><a id="more"></a></p>
<h1 id="Linuxå®šæ—¶å™¨å®ç°åŸç†"><a href="#Linuxå®šæ—¶å™¨å®ç°åŸç†" class="headerlink" title="Linuxå®šæ—¶å™¨å®ç°åŸç†"></a>Linuxå®šæ—¶å™¨å®ç°åŸç†</h1><h2 id="æ—¶é—´è½®å®šæ—¶å™¨-ä½åˆ†è¾¨ç‡å®ç°"><a href="#æ—¶é—´è½®å®šæ—¶å™¨-ä½åˆ†è¾¨ç‡å®ç°" class="headerlink" title="æ—¶é—´è½®å®šæ—¶å™¨-ä½åˆ†è¾¨ç‡å®ç°"></a>æ—¶é—´è½®å®šæ—¶å™¨-ä½åˆ†è¾¨ç‡å®ç°</h2><p>Linux 2.6.16ä¹‹å‰ï¼Œå†…æ ¸åªæ”¯æŒä½ç²¾åº¦æ—¶é’Ÿï¼Œå†…æ ¸å®šæ—¶å™¨çš„<strong>å·¥ä½œæ–¹å¼</strong>ï¼š  </p>
<ol>
<li>ç³»ç»Ÿå¯åŠ¨åï¼Œä¼šè¯»å–æ—¶é’Ÿæºè®¾å¤‡(RTC,HPETï¼ŒPITâ€¦)ï¼Œåˆå§‹åŒ–å½“å‰ç³»ç»Ÿæ—¶é—´ã€‚</li>
<li>å†…æ ¸ä¼šæ ¹æ®HZ(ç³»ç»Ÿå®šæ—¶å™¨é¢‘ç‡ï¼ŒèŠ‚æ‹ç‡)å‚æ•°å€¼ï¼Œè®¾ç½®æ—¶é’Ÿäº‹ä»¶è®¾å¤‡ï¼Œå¯åŠ¨tick(èŠ‚æ‹)ä¸­æ–­ã€‚HZè¡¨ç¤º1ç§’ç§äº§ç”Ÿå¤šå°‘ä¸ªæ—¶é’Ÿç¡¬ä»¶ä¸­æ–­ï¼Œtickå°±è¡¨ç¤ºè¿ç»­ä¸¤ä¸ªä¸­æ–­çš„é—´éš”æ—¶é—´ã€‚</li>
<li>è®¾ç½®æ—¶é’Ÿäº‹ä»¶è®¾å¤‡åï¼Œæ—¶é’Ÿäº‹ä»¶è®¾å¤‡ä¼šå®šæ—¶äº§ç”Ÿä¸€ä¸ªtickä¸­æ–­ï¼Œè§¦å‘æ—¶é’Ÿä¸­æ–­å¤„ç†å‡½æ•°ï¼Œæ›´æ–°ç³»ç»Ÿæ—¶é’Ÿ,å¹¶æ£€æµ‹timer wheelï¼Œè¿›è¡Œè¶…æ—¶äº‹ä»¶çš„å¤„ç†ã€‚</li>
</ol>
<p>åœ¨ä¸Šé¢å·¥ä½œæ–¹å¼ä¸‹ï¼ŒLinux 2.6.16 ä¹‹å‰ï¼Œå†…æ ¸è½¯ä»¶å®šæ—¶å™¨é‡‡ç”¨timer wheelå¤šçº§æ—¶é—´è½®çš„å®ç°æœºåˆ¶ï¼Œç»´æŠ¤æ“ä½œç³»ç»Ÿçš„æ‰€æœ‰å®šæ—¶äº‹ä»¶ã€‚timer wheelçš„è§¦å‘æ˜¯åŸºäºç³»ç»Ÿtickå‘¨æœŸæ€§ä¸­æ–­ã€‚æ‰€ä»¥è¯´è¿™ä¹‹å‰ï¼Œlinuxåªèƒ½æ”¯æŒmsçº§åˆ«çš„æ—¶é’Ÿï¼Œéšç€æ—¶é’Ÿæºç¡¬ä»¶è®¾å¤‡çš„ç²¾åº¦æé«˜å’Œè½¯ä»¶é«˜ç²¾åº¦è®¡æ—¶çš„éœ€æ±‚ï¼Œæœ‰äº†é«˜ç²¾åº¦æ—¶é’Ÿçš„å†…æ ¸è®¾è®¡ã€‚</p>
<p>æ‰€è°“ä½åˆ†è¾¨ç‡å®šæ—¶å™¨ï¼Œæ˜¯æŒ‡è¿™ç§å®šæ—¶å™¨çš„è®¡æ—¶å•ä½åŸºäºjiffieså€¼çš„è®¡æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒçš„ç²¾åº¦åªæœ‰1HZï¼Œå‡å¦‚ä½ çš„å†…æ ¸é…ç½®çš„HZæ˜¯1000ï¼Œé‚£æ„å‘³ç€ç³»ç»Ÿä¸­çš„ä½åˆ†è¾¨ç‡å®šæ—¶å™¨çš„ç²¾åº¦å°±æ˜¯1msã€‚æ—©æœŸçš„å†…æ ¸ç‰ˆæœ¬ä¸­ï¼Œå†…æ ¸å¹¶ä¸æ”¯æŒé«˜ç²¾åº¦å®šæ—¶å™¨ï¼Œç†æ‰€å½“ç„¶åªèƒ½ä½¿ç”¨è¿™ç§ä½åˆ†è¾¨ç‡å®šæ—¶å™¨, åæ¥éšç€æ—¶é’Ÿæºç¡¬ä»¶è®¾å¤‡çš„ç²¾åº¦æé«˜å’Œè½¯ä»¶é«˜ç²¾åº¦è®¡æ—¶çš„éœ€æ±‚ï¼Œæ‰æœ‰äº†<a href="#çº¢é»‘æ ‘å®šæ—¶å™¨-é«˜ç²¾åº¦å®ç°">é«˜ç²¾åº¦æ—¶é’Ÿçš„å†…æ ¸è®¾è®¡</a></p>
<h3 id="æ—¶é—´è½®ç®—æ³•æ€æƒ³"><a href="#æ—¶é—´è½®ç®—æ³•æ€æƒ³" class="headerlink" title="æ—¶é—´è½®ç®—æ³•æ€æƒ³"></a>æ—¶é—´è½®ç®—æ³•æ€æƒ³</h3><p>å¤šçº§æ—¶é—´è½®, æ’å…¥/åˆ é™¤/executeå¤æ‚åº¦éƒ½O(1)</p>
<p>ç®—æ³•æ€æƒ³: </p>
<ul>
<li>æŠŠå®šæ—¶å™¨åˆ†ä¸º 5 ä¸ªæ¡¶ï¼Œæ¯æ¡¶çš„ç²’åº¦åˆ†åˆ«è¡¨ç¤ºä¸ºï¼š<code>1 jiffiesï¼Œ256 jiffiesï¼Œ256*64 jiffiesï¼Œ256*64*64 jiffiesï¼Œ256*64*64*64 jiffies</code>ï¼Œæ¯æ¡¶bucketä¸­çš„slotçš„æ•°é‡åˆ†åˆ«ä¸ºï¼š<code>256ï¼Œ64ï¼Œ64ï¼Œ64ï¼Œ64</code>ï¼Œèƒ½è¡¨ç¤ºçš„èŒƒå›´ä¸º <code>2^32</code> </li>
<li>è¿™å¥½å‡ ä¸ªbucket, å…¶ä¸­ä¸€ä¸ªbucketå«nearæ˜¯å·®ä¸å¤šè¦è§¦å‘çš„å®šæ—¶å™¨èŒƒå›´æ˜¯<code>[0, 0x100)</code>, å’Œå‡ ä¸ªå®šæ—¶æ—¶é•¿æ¯”è¾ƒä¹…çš„bucket: <code>[0x100, 0x4000)ä»¥åŠ[0x4000, 0x100000)ä»¥åŠ[0x100000, 0x4000000)</code></li>
<li><strong>tick</strong>:<ul>
<li>æ¯æ¬¡tickéƒ½æ£€æŸ¥<code>jiffies</code>æ˜¯å¦å·²ç»åˆç»è¿‡ä¸€è½® <code>TVR_MASK(255)</code> äº†, ç»è¿‡äº†ä¸€è½®indexå°±åˆç­‰äº0, ç„¶åå°±å»åé¢çš„<code>bucket[0][INDEX(0)]</code>é‡Œå»æ‹¿å®šæ—¶å™¨è¿ç§»åˆ°nearé‡Œ(è¿™ä¸ª<code>INDEX(0)å®å…¶å®æ˜¯æ‹¿åˆ°jiffies_çš„ç¬¬9åˆ°14ä½çš„å€¼</code>), å¦‚æœ<code>INDEX(0)</code>ä¹Ÿç­‰äº0, åˆ™è¯´æ˜<code>bucket[0]</code>ä¹Ÿè½®è½¬è¿ç§»äº†ä¸€åœˆäº†, æ¥ç€å°±éœ€è¦å»<code>bucket[1]</code>é‡Œæ‹¿å®šæ—¶å™¨è¿ç§»åˆ°<code>bucket[0]</code>é‡Œ, åé¢<code>INDEX(1)</code>å’Œ<code>INDEX(2)</code>å¯¹åº”çš„bucketè°ƒæ•´éƒ½ä»¥æ­¤ç±»æ¨, è¿™å°±è·Ÿæ°´è¡¨ä¸€æ ·, å°è¡¨è½¬ä¸€åœˆéœ€è¦è°ƒæ•´ä¸­è¡¨, ä¸­è¡¨è½¬ä¸€åœˆåˆ™è¦è°ƒæ•´å¤§è¡¨å·®ä¸å¤š</li>
<li>ä¸ºå•¥å¯ä»¥ç›´æ¥æŠŠè¿™ä¸ª<code>bucket[0][INDEX(0)]</code>é‡Œçš„å®šæ—¶å™¨ç›´æ¥è¿ç§»åˆ°nearé‡Œå‘¢? å› ä¸ºåœ¨æ’å…¥çš„æ—¶å€™å°±æ˜¯è¿™ä¹ˆå“ˆå¸Œçš„, ä¸¾ä¸ªæ¯”è¾ƒç®€å•çš„ä¸å‡†ç¡®ä½†æ˜¯å¯ä»¥è¯´æ˜åŸç†çš„ä¾‹å­, å‡å¦‚ nearé‡Œæ˜¯å­˜æœ€è¿‘60ç§’è¿‡æœŸçš„å®šæ—¶å™¨, <code>bucket[0][0]</code>å­˜çš„æ˜¯60åˆ°120è¿‡æœŸçš„, <code>bucket[0][1]</code>çš„æ˜¯120åˆ°180è¿‡æœŸçš„, åˆ™jiffiesç­‰äº60çš„æ—¶å€™å°±è¦æŠŠ<code>bucket[0][0]</code>è¿ç§»åˆ°nearé‡Œ, jiffiesç­‰äº120çš„æ—¶å€™<code>bucket[0][1]</code>è¿ç§»åˆ°nearé‡Œâ€¦</li>
<li>ç±»ä¼¼äºlinuxçš„æ—¶é—´è½®å®ç°: å‡è®¾curr_time=0x12345678ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªæ£€æŸ¥çš„æ—¶åˆ»ä¸º0x12345679ã€‚å¦‚æœ<code>tv1.bucket[0x79]</code>ä¸Šé“¾è¡¨éç©ºï¼Œåˆ™ä¸‹ä¸€ä¸ªæ£€æŸ¥æ—¶åˆ»<code>tv1.bucket[0x79]</code>ä¸Šçš„å®šæ—¶å™¨èŠ‚ç‚¹è¶…æ—¶ã€‚å¦‚æœcurr_timeåˆ°äº†0x12345700ï¼Œä½8ä½ä¸ºç©ºï¼Œè¯´æ˜æœ‰è¿›ä½äº§ç”Ÿï¼Œè¿™æ—¶ç§»å‡º9ï½14ä½å¯¹åº”çš„å®šæ—¶å™¨é“¾è¡¨(å³æ­£å¥½å¯¹åº”ç€tv2è½®)ï¼ŒæŠŠ<code>tv2.bucket[æ­¤æ—¶9-14ä½çš„å€¼]</code>æ‰€å¯¹åº”çš„timeré“¾è¡¨è¿ç§»åˆ°tv1æ¥ï¼Œè¿™å°±å®Œæˆäº†ä¸€æ¬¡è¿›ä½è¿ç§»æ“ä½œã€‚åŒæ ·åœ°ï¼Œå½“curr_timeçš„ç¬¬9-14ä½ä¸º0æ—¶ï¼Œè¿™è¡¨æ˜tv2è½®å¯¹tv3è½®æœ‰è¿›ä½å‘ç”Ÿï¼Œå°†curr_timeç¬¬14-19ä½çš„å€¼ä½œä¸ºä¸‹æ ‡ï¼Œç§»å‡ºtv3ä¸­å¯¹åº”çš„å®šæ—¶å™¨é“¾è¡¨ï¼Œç„¶åå°†å®ƒä»¬è¿ç§»åˆ°tv2å»ã€‚tv4,tv5ä¾æ¬¡ç±»æ¨ã€‚ä¹‹æ‰€ä»¥èƒ½å¤Ÿæ ¹æ®curr_timeæ¥æ£€æŸ¥è¶…æ—¶é“¾ï¼Œæ˜¯å› ä¸ºtv1~tv5è½®çš„åº¦é‡èŒƒå›´æ­£å¥½ä¾æ¬¡è¦†ç›–äº†æ•´å‹çš„32ä½ï¼štv1(1-8ä½)ï¼Œtv2(9-14ä½)ï¼Œtv3(15-20ä½)ï¼Œtv4(21-26ä½)ï¼Œtv5(27-32ä½)ï¼›è€Œcurr_timeè®¡æ•°çš„é€’å¢ä¸­ï¼Œä½ä½å‘é«˜ä½çš„è¿›ä½æ­£æ˜¯ä½çº§æ—¶é—´è½®è½¬åœˆå¸¦åŠ¨é«˜çº§æ—¶é—´è½®èµ°åŠ¨çš„è¿‡ç¨‹ã€‚</li>
</ul>
</li>
<li><strong>æ’å…¥</strong>:<br>  æœ‰å¥½å‡ ä¸ªbucket, ç„¶åç”¨ç±»ä¼¼äºå–æ¨¡å“ˆå¸Œçš„æ€æƒ³å…ˆåˆ¤æ–­è¿˜æœ‰å¤šä¹…è¿‡æœŸçš„åŒºé—´, ç„¶åæ ¹æ®è¿‡æœŸæ—¶é—´expireå–ä»–ç›¸åº”çš„ä½æ”¾å…¥ç›¸åº”çš„æ¡¶é‡Œçš„æŸä¸ªslotçš„å®šæ—¶å™¨é“¾è¡¨TimerListé‡Œå³å¯, å‚è€ƒä¸‹æ–¹ä»£ç , å¦‚æœexpireå·²ç»è¶…è¿‡äº†æ¡¶èƒ½è¡¨ç¤ºçš„æœ€å¤§å€¼<code>MAX_TVAL</code>äº†, é‚£å°±ç›´æ¥å¯¹<code>MAX_TVAL+å½“å‰æ—¶é—´</code>å“ˆå¸Œæ”¾åœ¨æœ€åä¸€ä¸ªæ¡¶çš„æŸä¸ªæ§½é‡Œ, tickçš„æ—¶å€™ä¼šé€æ¸æŠŠä»–å¾€å‰è¿ç§»çš„</li>
<li><strong>excute</strong>:<br>  <code>near_</code> é‡Œé¢çš„å®šæ—¶å™¨å› ä¸ºéƒ½å·²ç»åœ¨ <code>addTimerNode</code> æ ¹æ®<code>expire</code>å“ˆå¸Œå®‰æ’å¥½äº†, æ‰€ä»¥è¿™é‡Œ <code>jiffies_ &amp; TVR_MASK</code> å‡ºæ¥çš„indexæ˜¯å‡ , é‚£å°±ç›´æ¥ä»<code>near_</code>é‡Œå–å‡ºæ¥æ‰§è¡Œå°±å®Œäº‹äº†,è§ä¸‹æ–¹ä»£ç <ul>
<li>åˆ é™¤: å› ä¸ºæ’å…¥çš„æ—¶å€™è¿˜ä¸“é—¨å¦å¤–æœ‰ä¸ªå“ˆå¸Œè¡¨æ¥ä¿å­˜å®šæ—¶å™¨idå’Œå®šæ—¶å™¨çš„æ˜ å°„å…³ç³», æ‰€æœ‰åˆ é™¤çš„æ—¶å€™å°±ç›´æ¥æ ¹æ®ä¼ å…¥çš„å®šæ—¶å™¨idæ¥æ‰¾åˆ°å®šæ—¶å™¨æœ¬èº«ç„¶åæŠŠä»–æ ‡è®°ä¸ºå·²åˆ é™¤, ç„¶ååœ¨excuteçš„æ—¶å€™ä¼šæ‰¾åˆ°<code>near_[index]</code>è¿™ä¸ªå®šæ—¶å™¨é“¾è¡¨TimerListç§»é™¤</li>
</ul>
</li>
<li><strong>åˆ é™¤</strong>:<br>  æƒ°æ€§åˆ é™¤, åªæ˜¯æ ‡è®°ç›¸å…³nodeä¸ºè¢«canceled, ç„¶åexcuteçš„æ—¶å€™å†freeNode </li>
<li><strong>tickless</strong>:<br>  ä¸å«Œéº»çƒ¦è¿˜å¯ä»¥æ¯æ¬¡ä» timer é›†åˆé‡Œé¢é€‰æ‹©æœ€å…ˆè¦è¶…æ—¶çš„äº‹ä»¶ï¼Œè®¡ç®—è¿˜æœ‰å¤šé•¿æ—¶é—´å°±ä¼šè¶…æ—¶ï¼Œä½œä¸º select wait çš„å€¼ï¼Œæ¯æ¬¡éƒ½ä¸ä¸€æ ·ï¼Œæ¯æ¬¡éƒ½åŸºæœ¬ç²¾ç¡®ï¼ŒåŒæ—¶ä¸ä¼šå ç”¨å¤šä½™ cpuï¼Œè¿™å« ticklessï¼ŒLinux çš„ 3.xä»¥ä¸Šç‰ˆæœ¬ä¹Ÿæ”¯æŒ tickless çš„æ¨¡å¼æ¥é©±åŠ¨å„ç§ç³»ç»Ÿçº§æ—¶é’Ÿï¼Œå·ç§°æ›´çœç”µæ›´ç²¾ç¡®ï¼Œä¸è¿‡éœ€è¦ä½ æ‰‹åŠ¨æ‰“å¼€ï¼ŒFreeBSD 9 ä»¥åä¹Ÿå¼•å…¥äº† ticklessã€‚</li>
</ul>
<h3 id="æ—¶é—´è½®æœ‰ä»€ä¹ˆç¼ºç‚¹"><a href="#æ—¶é—´è½®æœ‰ä»€ä¹ˆç¼ºç‚¹" class="headerlink" title="æ—¶é—´è½®æœ‰ä»€ä¹ˆç¼ºç‚¹"></a>æ—¶é—´è½®æœ‰ä»€ä¹ˆç¼ºç‚¹</h3><p>è™½ç„¶å¤§éƒ¨åˆ†æ—¶é—´é‡Œï¼Œæ—¶é—´è½®å¯ä»¥å®ç°O(1)æ—¶é—´å¤æ‚åº¦ï¼Œä½†æ˜¯å½“æœ‰è¿›ä½å‘ç”Ÿæ—¶ï¼Œä¸å¯é¢„æµ‹çš„O(N)å®šæ—¶å™¨çº§è”è¿ç§»æ—¶é—´ï¼Œè¿™å¯¹äºä½åˆ†è¾¨ç‡å®šæ—¶å™¨æ¥è¯´é—®é¢˜ä¸å¤§ï¼Œå¯æ˜¯å®ƒå¤§å¤§åœ°å½±å“äº†å®šæ—¶å™¨çš„ç²¾åº¦ï¼›</p>
<h3 id="æ—¶é—´è½®æ ¸å¿ƒä»£ç "><a href="#æ—¶é—´è½®æ ¸å¿ƒä»£ç " class="headerlink" title="æ—¶é—´è½®æ ¸å¿ƒä»£ç "></a>æ—¶é—´è½®æ ¸å¿ƒä»£ç </h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> WheelTimer::addTimerNode(TimerNode* node)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int64_t</span> expires = node-&gt;expire;</span><br><span class="line">    <span class="keyword">uint64_t</span> idx = (<span class="keyword">uint64_t</span>)(expires - jiffies_);</span><br><span class="line">    TimerList* <span class="built_in">list</span> = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span> (idx &lt; TVR_SIZE) <span class="comment">// [0, 0x100)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> i = expires &amp; TVR_MASK;  <span class="comment">// å› ä¸ºåªå…³å¿ƒå8ä½(å³TVR_BITS=8)</span></span><br><span class="line">        <span class="built_in">list</span> = &amp;near_[i];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(idx &lt; (<span class="number">1</span> &lt;&lt; (TVR_BITS + TVN_BITS))) <span class="comment">// [0x100, 0x4000)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å› ä¸ºä¸å…³å¿ƒå8ä½(å³TVR_BITS=8)çš„æ•°, æ‰€ä»¥ç›´æ¥ expires &gt;&gt; TVR_BITS äº†</span></span><br><span class="line">        <span class="comment">// åˆå› ä¸º TimerList buckets_[WHEEL_BUCKETS][TVN_SIZE] çš„ç¬¬äºŒç»´ä¸º TVN_SIZE, æ‰€ä»¥è¦ &amp; TVN_MASK</span></span><br><span class="line">        <span class="keyword">int</span> i = (expires &gt;&gt; TVR_BITS) &amp; TVN_MASK;</span><br><span class="line">        <span class="built_in">list</span> = &amp;buckets_[<span class="number">0</span>][i];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(idx &lt; (<span class="number">1</span> &lt;&lt; (TVR_BITS + <span class="number">2</span> * TVN_BITS))) <span class="comment">// [0x4000, 0x100000)</span></span><br><span class="line">    &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// #define INDEX(N) (   ( jiffies_ &gt;&gt; (8 +  (N) * 6)  )        &amp; 1111 11)</span></span><br><span class="line">#define INDEX(N) ((jiffies_ &gt;&gt; (TVR_BITS + (N) * TVN_BITS)) &amp; TVN_MASK)</span><br><span class="line"></span><br><span class="line"><span class="comment">// cascades all vectors and executes all expired timer</span></span><br><span class="line"><span class="keyword">int</span> WheelTimer::tick()&#123;</span><br><span class="line">    <span class="keyword">int</span> fired = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// æ¯æ¬¡tickéƒ½æ£€æŸ¥æ˜¯å¦å·²ç»åˆç»è¿‡ä¸€è½® TVR_MASK(255) äº†,</span></span><br><span class="line">    <span class="comment">// ç»è¿‡äº†ä¸€è½®indexå°±åˆç­‰äº0, ç„¶åå°±å»åé¢çš„bucketé‡Œæ‰¾æ˜¯å¦æœ‰éœ€è¦è°ƒæ•´åˆ°nearçš„å®šæ—¶å™¨</span></span><br><span class="line">    <span class="comment">// å°±è·Ÿæ°´è¡¨ä¸€æ ·, å°è¡¨è½¬ä¸€åœˆéœ€è¦è°ƒæ•´ä¸­è¡¨, ä¸­è¡¨è½¬ä¸€åœˆåˆ™è¦è°ƒæ•´å¤§è¡¨</span></span><br><span class="line">    <span class="keyword">int</span> index = jiffies_ &amp; TVR_MASK;</span><br><span class="line">    <span class="keyword">if</span>(index == <span class="number">0</span>) <span class="comment">// cascade timers</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">if</span>(cascade(<span class="number">0</span>, INDEX(<span class="number">0</span>)) &amp;&amp;</span><br><span class="line">        cascade(<span class="number">1</span>, INDEX(<span class="number">1</span>)) &amp;&amp;</span><br><span class="line">        cascade(<span class="number">2</span>, INDEX(<span class="number">2</span>))</span><br><span class="line">        )</span><br><span class="line">        cascade(<span class="number">3</span>, INDEX(<span class="number">3</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    jiffies_++;</span><br><span class="line">    fired += execute(index);</span><br><span class="line">    <span class="keyword">return</span> fired;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> WheelTimer::execute()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> fired = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// near é‡Œé¢çš„å®šæ—¶å™¨å› ä¸ºéƒ½å·²ç»åœ¨ addTimerNode æ ¹æ®expireé‡Œå“ˆå¸Œå®‰æ’å¥½äº†,</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥è¿™é‡Œ jiffies_ &amp; TVR_MASK å‡ºæ¥çš„indexæ˜¯å‡ , é‚£å°±ç›´æ¥ä»near_é‡Œå–å‡ºæ¥æ‰§è¡Œå°±å®Œäº‹äº†</span></span><br><span class="line">    <span class="keyword">int</span> index = jiffies_ &amp; TVR_MASK;</span><br><span class="line">    TimerList expired;</span><br><span class="line">    near_[index].swap(expired); <span class="comment">// swap list</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> node : expired)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!node-&gt;canceled &amp;&amp; node-&gt;cb)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//printf("wheel node %d triggered at %lld of jiffies %lld\n", node-&gt;id, current_, jiffies_);</span></span><br><span class="line">            node-&gt;cb();</span><br><span class="line">            size_--;</span><br><span class="line">            fired++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ref_.erase(node-&gt;id);</span><br><span class="line">        freeNode(node);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fired;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// cascade all the timers at bucket of index up one level</span></span><br><span class="line">    <span class="keyword">bool</span> WheelTimer::cascade(<span class="keyword">int</span> bucket, <span class="keyword">int</span> index)&#123;</span><br><span class="line">        <span class="comment">// swap list</span></span><br><span class="line">        TimerList <span class="built_in">list</span>;</span><br><span class="line">        buckets_[bucket][index].swap(<span class="built_in">list</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; node : <span class="built_in">list</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(node-&gt;id &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                addTimerNode(node);  <span class="comment">// æŠŠå„ä¸ªå®šæ—¶å™¨å¾€å‰æ¨, æ¯”å¦‚æ¡ä»¶è¾¾æˆå°±æŒªåˆ°this-&gt;near_é‡Œå»</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚INDEX(N), å½“N=0, å› ä¸ºè¿›å…¥æœ¬å‡½æ•°ä¹‹å‰, jiffies_ &amp; TVR_MASK æ˜¯ä¸º 0 çš„,</span></span><br><span class="line">        <span class="comment">// è¯´æ˜ jiffies_ 8ä½ä»¥å‰çš„é«˜ä½ç»å¯¹æœ‰ä¸ä¸º0çš„ä½,</span></span><br><span class="line">        <span class="comment">// jiffieså³ç§»8ä½ç„¶åè·ŸTVN_MASK(å³63, å³äºŒè¿›åˆ¶111111, å…­ä½)åšä¸”æ“ä½œä¹‹åçš„ç»“æœ index == 0 ,</span></span><br><span class="line">        <span class="comment">// åˆ™è¯´æ˜jiffieså¤§äºN=0çš„è¿™ä¸ªbucketåŒºé—´äº†, è¿˜éœ€è¦è°ƒæ•´ä¸‹ä¸€ä¸ªåŒºé—´(å³ N+1 è¿™ä¸ªbucketåŒºé—´),</span></span><br><span class="line">        <span class="comment">// å°±è·Ÿæ°´è¡¨ä¸€æ ·, å°è¡¨è½¬ä¸€åœˆéœ€è¦è°ƒæ•´ä¸­è¡¨, ä¸­è¡¨è½¬ä¸€åœˆåˆ™è¦è°ƒæ•´å¤§è¡¨</span></span><br><span class="line">        <span class="keyword">return</span> index == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do lazy cancellation, so we can effectively use vector as container of timer nodes</span></span><br><span class="line">    <span class="keyword">bool</span> WheelTimer::Cancel(<span class="keyword">int</span> id)</span><br><span class="line">    &#123;</span><br><span class="line">        TimerNode* node = ref_[id];</span><br><span class="line">        <span class="keyword">if</span> (node != <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            node-&gt;canceled = <span class="literal">true</span>;</span><br><span class="line">            size_--;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="çº¢é»‘æ ‘å®šæ—¶å™¨-é«˜ç²¾åº¦å®ç°"><a href="#çº¢é»‘æ ‘å®šæ—¶å™¨-é«˜ç²¾åº¦å®ç°" class="headerlink" title="çº¢é»‘æ ‘å®šæ—¶å™¨-é«˜ç²¾åº¦å®ç°"></a>çº¢é»‘æ ‘å®šæ—¶å™¨-é«˜ç²¾åº¦å®ç°</h2><p>è€Œéšç€å†…æ ¸çš„ä¸æ–­æ¼”è¿›ï¼Œå¤§ç‰›ä»¬å·²ç»å¯¹è¿™ç§ä½åˆ†è¾¨ç‡å®šæ—¶å™¨çš„ç²¾åº¦ä¸å†æ»¡è¶³ï¼Œè€Œä¸”ï¼Œç¡¬ä»¶ä¹Ÿåœ¨ä¸æ–­åœ°å‘å±•ï¼Œç³»ç»Ÿä¸­çš„å®šæ—¶å™¨ç¡¬ä»¶çš„ç²¾åº¦ä¹Ÿè¶Šæ¥è¶Šé«˜ï¼Œè¿™ä¹Ÿç»™é«˜åˆ†è¾¨ç‡å®šæ—¶å™¨çš„å‡ºç°åˆ›é€ äº†æ¡ä»¶ã€‚å†…æ ¸ä»2.6.16å¼€å§‹åŠ å…¥äº†é«˜ç²¾åº¦å®šæ—¶å™¨æ¶æ„ã€‚å®ƒå¯ä»¥ä¸ºæˆ‘ä»¬æä¾›çº³ç§’çº§çš„å®šæ—¶ç²¾åº¦ï¼Œä»¥æ»¡è¶³å¯¹ç²¾ç¡®æ—¶é—´æœ‰è¿«åˆ‡éœ€æ±‚çš„åº”ç”¨ç¨‹åºæˆ–å†…æ ¸é©±åŠ¨ï¼Œä¾‹å¦‚å¤šåª’ä½“åº”ç”¨ï¼ŒéŸ³é¢‘è®¾å¤‡çš„é©±åŠ¨ç¨‹åºç­‰ç­‰ã€‚</p>
<p>å½“å‰å†…æ ¸åŒæ—¶å­˜åœ¨æ–°æ—§timer wheel å’Œhrtimerä¸¤å¥—timerçš„å®ç°ï¼Œå†…æ ¸å¯åŠ¨åä¼šè¿›è¡Œä»ä½ç²¾åº¦æ¨¡å¼åˆ°é«˜ç²¾åº¦æ—¶é’Ÿæ¨¡å¼çš„åˆ‡æ¢.</p>
<h3 id="ä¸æ—¶é—´è½®çš„åŒºåˆ«"><a href="#ä¸æ—¶é—´è½®çš„åŒºåˆ«" class="headerlink" title="ä¸æ—¶é—´è½®çš„åŒºåˆ«"></a>ä¸æ—¶é—´è½®çš„åŒºåˆ«</h3><p>Linux 2.6.16 ï¼Œå†…æ ¸æ”¯æŒäº†é«˜ç²¾åº¦çš„æ—¶é’Ÿï¼Œå†…æ ¸é‡‡ç”¨æ–°çš„å®šæ—¶å™¨hrtimerï¼Œå…¶å®ç°é€»è¾‘å’ŒLinux 2.6.16 ä¹‹å‰å®šæ—¶å™¨é€»è¾‘åŒºåˆ«ï¼š  </p>
<ul>
<li>hrtimeré‡‡ç”¨çº¢é»‘æ ‘è¿›è¡Œé«˜ç²¾åº¦å®šæ—¶å™¨çš„ç®¡ç†ï¼Œè€Œä¸æ˜¯æ—¶é—´è½®ï¼›</li>
<li>é«˜ç²¾åº¦æ—¶é’Ÿå®šæ—¶å™¨<strong>ä¸åœ¨ä¾èµ–ç³»ç»Ÿçš„tickä¸­æ–­ï¼Œè€Œæ˜¯åŸºäºæ—¶é’Ÿç¡¬ä»¶çš„äº‹ä»¶è§¦å‘</strong>ã€‚</li>
<li>æ—§å†…æ ¸çš„å®šæ—¶å™¨å®ç°ä¾èµ–äºç³»ç»Ÿå®šæ—¶å™¨ç¡¬ä»¶å®šæœŸçš„tickï¼ŒåŸºäºè¯¥tickï¼Œå†…æ ¸ä¼šæ‰«ætimer wheelå¤„ç†è¶…æ—¶äº‹ä»¶ï¼Œä¼šæ›´æ–°jiffiesï¼Œwall time(å¢™ä¸Šæ—¶é—´ï¼Œç°å®æ—¶é—´)ï¼Œprocessçš„ä½¿ç”¨æ—¶é—´ç­‰ç­‰å·¥ä½œã€‚</li>
<li>æ–°çš„å†…æ ¸ä¸å†ä¼šç›´æ¥æ”¯æŒå‘¨æœŸæ€§çš„tickï¼Œæ–°å†…æ ¸å®šæ—¶å™¨æ¡†æ¶é‡‡ç”¨äº†åŸºäºé«˜ç²¾åº¦æ—¶é’Ÿç¡¬ä»¶çš„ä¸‹æ¬¡ä¸­æ–­è§¦å‘ï¼Œè€Œä¸æ˜¯ä»¥å‰çš„å‘¨æœŸæ€§è§¦å‘ã€‚æ–°å†…æ ¸å®ç°äº†hrtimer(high resolution timer)äºäº‹ä»¶è§¦å‘ã€‚</li>
</ul>
<h3 id="hrtimerçš„å·¥ä½œåŸç†"><a href="#hrtimerçš„å·¥ä½œåŸç†" class="headerlink" title="hrtimerçš„å·¥ä½œåŸç†"></a>hrtimerçš„å·¥ä½œåŸç†</h3><p>æˆ‘ä»¬çŸ¥é“ï¼Œä½åˆ†è¾¨ç‡å®šæ—¶å™¨ä½¿ç”¨5ä¸ªé“¾è¡¨æ•°ç»„æ¥ç»„ç»‡timer_listç»“æ„ï¼Œå½¢æˆäº†è‘—åçš„æ—¶é—´è½®æ¦‚å¿µï¼Œå¯¹äºé«˜åˆ†è¾¨ç‡å®šæ—¶å™¨ï¼Œæˆ‘ä»¬æœŸæœ›ç»„ç»‡å®ƒä»¬çš„æ•°æ®ç»“æ„è‡³å°‘å…·å¤‡ä»¥ä¸‹æ¡ä»¶ï¼š  </p>
<ul>
<li>ç¨³å®šè€Œä¸”å¿«é€Ÿçš„æŸ¥æ‰¾èƒ½åŠ›ï¼›</li>
<li>å¿«é€Ÿåœ°æ’å…¥å’Œåˆ é™¤å®šæ—¶å™¨çš„èƒ½åŠ›ï¼›</li>
<li>æ’åºåŠŸèƒ½ï¼›</li>
<li>å†…æ ¸çš„å¼€å‘è€…è€ƒå¯Ÿäº†å¤šç§æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚åŸºæ•°æ ‘ã€å“ˆå¸Œè¡¨ç­‰ç­‰ï¼Œæœ€ç»ˆä»–ä»¬é€‰æ‹©äº†çº¢é»‘æ ‘ï¼ˆrbtreeï¼‰æ¥ç»„ç»‡hrtimerï¼Œçº¢é»‘æ ‘å·²ç»ä»¥åº“çš„å½¢å¼å­˜åœ¨äºå†…æ ¸ä¸­ï¼Œå¹¶è¢«æˆåŠŸåœ°ä½¿ç”¨åœ¨å†…å­˜ç®¡ç†å­ç³»ç»Ÿå’Œæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œéšç€ç³»ç»Ÿçš„è¿è¡Œï¼Œhrtimerä¸åœåœ°è¢«åˆ›å»ºå’Œé”€æ¯ï¼Œæ–°çš„hrtimeræŒ‰é¡ºåºè¢«æ’å…¥åˆ°çº¢é»‘æ ‘ä¸­ï¼Œæ ‘çš„æœ€å·¦è¾¹çš„èŠ‚ç‚¹å°±æ˜¯æœ€å¿«åˆ°æœŸçš„å®šæ—¶å™¨ï¼Œå†…æ ¸ç”¨ä¸€ä¸ªhrtimerç»“æ„æ¥è¡¨ç¤ºä¸€ä¸ªé«˜ç²¾åº¦å®šæ—¶å™¨</li>
</ul>
<p>é€šè¿‡å°†é«˜ç²¾åº¦æ—¶é’Ÿç¡¬ä»¶çš„ä¸‹æ¬¡ä¸­æ–­è§¦å‘æ—¶é—´è®¾ç½®ä¸ºçº¢é»‘æ ‘ä¸­æœ€æ—©åˆ°æœŸçš„Timer çš„æ—¶é—´ï¼Œæ—¶é’Ÿåˆ°æœŸåä»çº¢é»‘æ ‘ä¸­å¾—åˆ°ä¸‹ä¸€ä¸ª Timer çš„åˆ°æœŸæ—¶é—´ï¼Œå¹¶è®¾ç½®ç¡¬ä»¶ï¼Œå¦‚æ­¤å¾ªç¯åå¤ã€‚</p>
<h3 id="å¦‚ä½•åœ¨é«˜ç²¾åº¦æ¨¡å¼ä¸‹æ¨¡æ‹Ÿtick"><a href="#å¦‚ä½•åœ¨é«˜ç²¾åº¦æ¨¡å¼ä¸‹æ¨¡æ‹Ÿtick" class="headerlink" title="å¦‚ä½•åœ¨é«˜ç²¾åº¦æ¨¡å¼ä¸‹æ¨¡æ‹Ÿtick"></a>å¦‚ä½•åœ¨é«˜ç²¾åº¦æ¨¡å¼ä¸‹æ¨¡æ‹Ÿtick</h3><p>å½“ç³»ç»Ÿåˆ‡æ¢åˆ°é«˜ç²¾åº¦æ¨¡å¼åï¼Œtick_deviceè¢«é«˜ç²¾åº¦å®šæ—¶å™¨ç³»ç»Ÿæ¥ç®¡ï¼Œä¸å†å®šæœŸåœ°äº§ç”Ÿtickäº‹ä»¶ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œåˆ°ç›®å‰çš„ç‰ˆæœ¬ä¸ºæ­¢ï¼ˆV3.4ï¼‰ï¼Œå†…æ ¸è¿˜æ²¡æœ‰å½»åº•åºŸé™¤jiffiesæœºåˆ¶ï¼Œç³»ç»Ÿè¿˜æ˜¯ä¾èµ–å®šæœŸåˆ°æ¥çš„tickäº‹ä»¶ï¼Œä¾›è¿›ç¨‹è°ƒåº¦ç³»ç»Ÿå’Œæ—¶é—´æ›´æ–°ç­‰æ“ä½œï¼Œå¤§é‡å­˜åœ¨çš„ä½ç²¾åº¦å®šæ—¶å™¨ä¹Ÿä»ç„¶ä¾èµ–äºjiffiesçš„è®¡æ•°ï¼Œæ‰€ä»¥ï¼Œå°½ç®¡tick_deviceè¢«æ¥ç®¡ï¼Œé«˜ç²¾åº¦å®šæ—¶å™¨ç³»ç»Ÿè¿˜æ˜¯è¦æƒ³åŠæ³•ç»§ç»­æä¾›å®šæœŸçš„tickäº‹ä»¶ã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸€ç›®çš„ï¼Œå†…æ ¸ä½¿ç”¨äº†ä¸€ä¸ªå–å·§çš„åŠæ³•ï¼šæ—¢ç„¶é«˜ç²¾åº¦æ¨¡å¼å·²ç»å¯ç”¨ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªhrtimerï¼ŒæŠŠå®ƒçš„åˆ°æœŸæ—¶é—´è®¾å®šä¸ºä¸€ä¸ªjiffyçš„æ—¶é—´ï¼Œå½“è¿™ä¸ªhrtimeråˆ°æœŸæ—¶ï¼Œåœ¨è¿™ä¸ªhrtimerçš„åˆ°æœŸå›è°ƒå‡½æ•°ä¸­ï¼Œè¿›è¡Œå’ŒåŸæ¥çš„tick_deviceåŒæ ·çš„æ“ä½œï¼Œç„¶åæŠŠè¯¥hrtimerçš„åˆ°æœŸæ—¶é—´é¡ºå»¶ä¸€ä¸ªjiffyå‘¨æœŸï¼Œå¦‚æ­¤åå¤å¾ªç¯ï¼Œå®Œç¾åœ°æ¨¡æ‹Ÿäº†åŸæœ‰tick_deviceçš„åŠŸèƒ½ã€‚</p>
<h1 id="Linuxæ–‡ä»¶ç³»ç»Ÿ"><a href="#Linuxæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="Linuxæ–‡ä»¶ç³»ç»Ÿ"></a>Linuxæ–‡ä»¶ç³»ç»Ÿ</h1><p>è¯¦ç»†çš„å¯ä»¥æŸ¥çœ‹æœ¬åšå®¢çš„è¿™ç¯‡æ–‡ç« å“ˆ<a href="/fd_inode/" title="æ–‡ä»¶æè¿°ç¬¦FDä¸Inode">æ–‡ä»¶æè¿°ç¬¦FDä¸Inode</a><br>fdæ•°ç›®å¤§å°çš„é™åˆ¶å¯ä»¥æ”¹å˜, å‚è€ƒ <a href="/fd_inode/#æ–‡ä»¶æè¿°ç¬¦é™åˆ¶">æ–‡ä»¶æè¿°ç¬¦é™åˆ¶</a></p>
<h2 id="ç³»ç»Ÿç›®å½•ç»“æ„"><a href="#ç³»ç»Ÿç›®å½•ç»“æ„" class="headerlink" title="ç³»ç»Ÿç›®å½•ç»“æ„"></a>ç³»ç»Ÿç›®å½•ç»“æ„</h2><blockquote>
<p>Linux ç³»ç»Ÿç›®å½•ç»“æ„ ç™»å½•ç³»ç»Ÿåï¼Œåœ¨å½“å‰å‘½ä»¤çª—å£ä¸‹è¾“å…¥å‘½ä»¤ï¼š  ls / ä½ ä¼šçœ‹åˆ°å¦‚ä¸‹å›¾æ‰€ç¤º: æ ‘çŠ¶ç›®å½•ç»“æ„ï¼š ä»¥ä¸‹æ˜¯å¯¹è¿™äº›ç›®å½•çš„è§£é‡Šï¼š /binï¼š bin æ˜¯ Binaries (äºŒè¿›åˆ¶æ–‡ä»¶) çš„ç¼©å†™, è¿™ä¸ªç›®å½•å­˜æ”¾ç€æœ€ç»å¸¸ä½¿ç”¨çš„å‘½ä»¤ã€‚</p>
</blockquote>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/linux_sys_dir.jpg" alt></p>
<p>ä»¥ä¸‹æ˜¯å¯¹è¿™äº›ç›®å½•çš„è§£é‡Šï¼š</p>
<ul>
<li><strong>/bin</strong>ï¼š<br>  bin æ˜¯ Binaries (äºŒè¿›åˆ¶æ–‡ä»¶) çš„ç¼©å†™, è¿™ä¸ªç›®å½•å­˜æ”¾ç€æœ€ç»å¸¸ä½¿ç”¨çš„å‘½ä»¤ã€‚</li>
<li><strong>/bootï¼š</strong><br>  è¿™é‡Œå­˜æ”¾çš„æ˜¯å¯åŠ¨ Linux æ—¶ä½¿ç”¨çš„ä¸€äº›æ ¸å¿ƒæ–‡ä»¶ï¼ŒåŒ…æ‹¬ä¸€äº›è¿æ¥æ–‡ä»¶ä»¥åŠé•œåƒæ–‡ä»¶ã€‚</li>
<li><strong>/dev ï¼š</strong><br>  dev æ˜¯ Device(è®¾å¤‡) çš„ç¼©å†™, è¯¥ç›®å½•ä¸‹å­˜æ”¾çš„æ˜¯ Linux çš„å¤–éƒ¨è®¾å¤‡ï¼Œåœ¨ Linux ä¸­è®¿é—®è®¾å¤‡çš„æ–¹å¼å’Œè®¿é—®æ–‡ä»¶çš„æ–¹å¼æ˜¯ç›¸åŒçš„ã€‚</li>
<li><strong>/etcï¼š</strong><br>  etc æ˜¯ Etcetera(ç­‰ç­‰) çš„ç¼©å†™, è¿™ä¸ªç›®å½•ç”¨æ¥å­˜æ”¾æ‰€æœ‰çš„ç³»ç»Ÿç®¡ç†æ‰€éœ€è¦çš„é…ç½®æ–‡ä»¶å’Œå­ç›®å½•ã€‚</li>
<li><strong>/home</strong>ï¼š<br>  ç”¨æˆ·çš„ä¸»ç›®å½•ï¼Œåœ¨ Linux ä¸­ï¼Œæ¯ä¸ªç”¨æˆ·éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ç›®å½•ï¼Œä¸€èˆ¬è¯¥ç›®å½•åæ˜¯ä»¥ç”¨æˆ·çš„è´¦å·å‘½åçš„ï¼Œå¦‚ä¸Šå›¾ä¸­çš„ aliceã€bob å’Œ eveã€‚</li>
<li><strong>/lib</strong>ï¼š<br>  lib æ˜¯ Library(åº“) çš„ç¼©å†™è¿™ä¸ªç›®å½•é‡Œå­˜æ”¾ç€ç³»ç»Ÿæœ€åŸºæœ¬çš„åŠ¨æ€è¿æ¥å…±äº«åº“ï¼Œå…¶ä½œç”¨ç±»ä¼¼äº Windows é‡Œçš„ DLL æ–‡ä»¶ã€‚å‡ ä¹æ‰€æœ‰çš„åº”ç”¨ç¨‹åºéƒ½éœ€è¦ç”¨åˆ°è¿™äº›å…±äº«åº“ã€‚</li>
<li><strong>/lost+found</strong>ï¼š<br>  è¿™ä¸ªç›®å½•ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ç©ºçš„ï¼Œå½“ç³»ç»Ÿéæ³•å…³æœºåï¼Œè¿™é‡Œå°±å­˜æ”¾äº†ä¸€äº›æ–‡ä»¶ã€‚</li>
<li><strong>/media</strong>ï¼š<br>  linux ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«ä¸€äº›è®¾å¤‡ï¼Œä¾‹å¦‚ U ç›˜ã€å…‰é©±ç­‰ç­‰ï¼Œå½“è¯†åˆ«åï¼ŒLinux ä¼šæŠŠè¯†åˆ«çš„è®¾å¤‡æŒ‚è½½åˆ°è¿™ä¸ªç›®å½•ä¸‹ã€‚</li>
<li><strong>/mnt</strong>ï¼š<br>  ç³»ç»Ÿæä¾›è¯¥ç›®å½•æ˜¯ä¸ºäº†è®©ç”¨æˆ·ä¸´æ—¶æŒ‚è½½åˆ«çš„æ–‡ä»¶ç³»ç»Ÿçš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…‰é©±æŒ‚è½½åœ¨ /mnt/ ä¸Šï¼Œç„¶åè¿›å…¥è¯¥ç›®å½•å°±å¯ä»¥æŸ¥çœ‹å…‰é©±é‡Œçš„å†…å®¹äº†ã€‚</li>
<li><strong>/opt</strong>ï¼š<br>  opt æ˜¯ optional(å¯é€‰) çš„ç¼©å†™ï¼Œè¿™æ˜¯ç»™ä¸»æœºé¢å¤–å®‰è£…è½¯ä»¶æ‰€æ‘†æ”¾çš„ç›®å½•ã€‚æ¯”å¦‚ä½ å®‰è£…ä¸€ä¸ª ORACLE æ•°æ®åº“åˆ™å°±å¯ä»¥æ”¾åˆ°è¿™ä¸ªç›®å½•ä¸‹ã€‚é»˜è®¤æ˜¯ç©ºçš„ã€‚</li>
<li><p><strong>/proc</strong>ï¼š<br>  proc æ˜¯ Processes(è¿›ç¨‹) çš„ç¼©å†™ï¼Œ/proc æ˜¯ä¸€ç§ä¼ªæ–‡ä»¶ç³»ç»Ÿï¼ˆä¹Ÿå³è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰ï¼Œå­˜å‚¨çš„æ˜¯å½“å‰å†…æ ¸è¿è¡ŒçŠ¶æ€çš„ä¸€ç³»åˆ—ç‰¹æ®Šæ–‡ä»¶ï¼Œè¿™ä¸ªç›®å½•æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„ç›®å½•ï¼Œå®ƒæ˜¯ç³»ç»Ÿå†…å­˜çš„æ˜ å°„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç›´æ¥è®¿é—®è¿™ä¸ªç›®å½•æ¥è·å–ç³»ç»Ÿä¿¡æ¯ã€‚<br>  è¿™ä¸ªç›®å½•çš„å†…å®¹ä¸åœ¨ç¡¬ç›˜ä¸Šè€Œæ˜¯åœ¨å†…å­˜é‡Œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ä¿®æ”¹é‡Œé¢çš„æŸäº›æ–‡ä»¶ï¼Œæ¯”å¦‚å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥å±è”½ä¸»æœºçš„ ping å‘½ä»¤ï¼Œä½¿åˆ«äººæ— æ³• ping ä½ çš„æœºå™¨ï¼š</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>/root</strong>ï¼š<br>  è¯¥ç›®å½•ä¸ºç³»ç»Ÿç®¡ç†å‘˜ï¼Œä¹Ÿç§°ä½œè¶…çº§æƒé™è€…çš„ç”¨æˆ·ä¸»ç›®å½•ã€‚</p>
</li>
<li><strong>/sbin</strong>ï¼š<br>  s å°±æ˜¯ Super User çš„æ„æ€ï¼Œæ˜¯ Superuser Binaries (è¶…çº§ç”¨æˆ·çš„äºŒè¿›åˆ¶æ–‡ä»¶) çš„ç¼©å†™ï¼Œè¿™é‡Œå­˜æ”¾çš„æ˜¯ç³»ç»Ÿç®¡ç†å‘˜ä½¿ç”¨çš„ç³»ç»Ÿç®¡ç†ç¨‹åºã€‚</li>
<li><strong>/selinux</strong>ï¼š<br>   è¿™ä¸ªç›®å½•æ˜¯ Redhat/CentOS æ‰€ç‰¹æœ‰çš„ç›®å½•ï¼ŒSelinux æ˜¯ä¸€ä¸ªå®‰å…¨æœºåˆ¶ï¼Œç±»ä¼¼äº windows çš„é˜²ç«å¢™ï¼Œä½†æ˜¯è¿™å¥—æœºåˆ¶æ¯”è¾ƒå¤æ‚ï¼Œè¿™ä¸ªç›®å½•å°±æ˜¯å­˜æ”¾ selinux ç›¸å…³çš„æ–‡ä»¶çš„ã€‚</li>
<li><strong>/srv</strong>ï¼š<br>   è¯¥ç›®å½•å­˜æ”¾ä¸€äº›æœåŠ¡å¯åŠ¨ä¹‹åéœ€è¦æå–çš„æ•°æ®ã€‚</li>
<li><strong>/sys</strong>ï¼š<br>  è¿™æ˜¯ Linux2.6 å†…æ ¸çš„ä¸€ä¸ªå¾ˆå¤§çš„å˜åŒ–ã€‚è¯¥ç›®å½•ä¸‹å®‰è£…äº† 2.6 å†…æ ¸ä¸­æ–°å‡ºç°çš„ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿ sysfs ã€‚<br>  sysfs æ–‡ä»¶ç³»ç»Ÿé›†æˆäº†ä¸‹é¢ 3 ç§æ–‡ä»¶ç³»ç»Ÿçš„ä¿¡æ¯ï¼šé’ˆå¯¹è¿›ç¨‹ä¿¡æ¯çš„ proc æ–‡ä»¶ç³»ç»Ÿã€é’ˆå¯¹è®¾å¤‡çš„ devfs æ–‡ä»¶ç³»ç»Ÿä»¥åŠé’ˆå¯¹ä¼ªç»ˆç«¯çš„ devpts æ–‡ä»¶ç³»ç»Ÿã€‚<br>  è¯¥æ–‡ä»¶ç³»ç»Ÿæ˜¯å†…æ ¸è®¾å¤‡æ ‘çš„ä¸€ä¸ªç›´è§‚åæ˜ ã€‚<br>  å½“ä¸€ä¸ªå†…æ ¸å¯¹è±¡è¢«åˆ›å»ºçš„æ—¶å€™ï¼Œå¯¹åº”çš„æ–‡ä»¶å’Œç›®å½•ä¹Ÿåœ¨å†…æ ¸å¯¹è±¡å­ç³»ç»Ÿä¸­è¢«åˆ›å»ºã€‚</li>
<li><strong>/tmp</strong>ï¼š<br>  tmp æ˜¯ temporary(ä¸´æ—¶) çš„ç¼©å†™è¿™ä¸ªç›®å½•æ˜¯ç”¨æ¥å­˜æ”¾ä¸€äº›ä¸´æ—¶æ–‡ä»¶çš„ã€‚</li>
<li><strong>/usr</strong>ï¼š<br>   usr æ˜¯ unix shared resources(å…±äº«èµ„æº) çš„ç¼©å†™ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç›®å½•ï¼Œç”¨æˆ·çš„å¾ˆå¤šåº”ç”¨ç¨‹åºå’Œæ–‡ä»¶éƒ½æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼Œç±»ä¼¼äº windows ä¸‹çš„ program files ç›®å½•ã€‚</li>
<li><strong>/usr/binï¼š</strong><br>  ç³»ç»Ÿç”¨æˆ·ä½¿ç”¨çš„åº”ç”¨ç¨‹åºã€‚</li>
<li><strong>/usr/sbinï¼š</strong><br>  è¶…çº§ç”¨æˆ·ä½¿ç”¨çš„æ¯”è¾ƒé«˜çº§çš„ç®¡ç†ç¨‹åºå’Œç³»ç»Ÿå®ˆæŠ¤ç¨‹åºã€‚</li>
<li><strong>/usr/srcï¼š</strong><br>  å†…æ ¸æºä»£ç é»˜è®¤çš„æ”¾ç½®ç›®å½•ã€‚</li>
<li><strong>/var</strong>ï¼š<br>  var æ˜¯ variable(å˜é‡) çš„ç¼©å†™ï¼Œè¿™ä¸ªç›®å½•ä¸­å­˜æ”¾ç€åœ¨ä¸æ–­æ‰©å……ç€çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬ä¹ æƒ¯å°†é‚£äº›ç»å¸¸è¢«ä¿®æ”¹çš„ç›®å½•æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹ã€‚åŒ…æ‹¬å„ç§æ—¥å¿—æ–‡ä»¶ã€‚</li>
<li><strong>/run</strong>ï¼š<br>  æ˜¯ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿï¼Œå­˜å‚¨ç³»ç»Ÿå¯åŠ¨ä»¥æ¥çš„ä¿¡æ¯ã€‚å½“ç³»ç»Ÿé‡å¯æ—¶ï¼Œè¿™ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶åº”è¯¥è¢«åˆ æ‰æˆ–æ¸…é™¤ã€‚å¦‚æœä½ çš„ç³»ç»Ÿä¸Šæœ‰ /var/run ç›®å½•ï¼Œåº”è¯¥è®©å®ƒæŒ‡å‘ runã€‚</li>
</ul>
<p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œæœ‰å‡ ä¸ªç›®å½•æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œå¹³æ—¶éœ€è¦æ³¨æ„ä¸è¦è¯¯åˆ é™¤æˆ–è€…éšæ„æ›´æ”¹å†…éƒ¨æ–‡ä»¶ã€‚<br><strong>/etc</strong>ï¼š ä¸Šè¾¹ä¹Ÿæåˆ°äº†ï¼Œè¿™ä¸ªæ˜¯ç³»ç»Ÿä¸­çš„é…ç½®æ–‡ä»¶ï¼Œå¦‚æœä½ æ›´æ”¹äº†è¯¥ç›®å½•ä¸‹çš„æŸä¸ªæ–‡ä»¶å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿä¸èƒ½å¯åŠ¨ã€‚<br><strong>/bin, /sbin, /usr/bin, /usr/sbin</strong>: è¿™æ˜¯ç³»ç»Ÿé¢„è®¾çš„æ‰§è¡Œæ–‡ä»¶çš„æ”¾ç½®ç›®å½•ï¼Œæ¯”å¦‚ ls å°±æ˜¯åœ¨ /bin/ls ç›®å½•ä¸‹çš„ã€‚<br>å€¼å¾—æå‡ºçš„æ˜¯ï¼Œ/bin, /usr/bin æ˜¯ç»™ç³»ç»Ÿç”¨æˆ·ä½¿ç”¨çš„æŒ‡ä»¤ï¼ˆé™¤ root å¤–çš„é€šç”¨æˆ·ï¼‰ï¼Œè€Œ / sbin, /usr/sbin åˆ™æ˜¯ç»™ root ä½¿ç”¨çš„æŒ‡ä»¤ã€‚<br><strong>/var</strong>ï¼š è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç›®å½•ï¼Œç³»ç»Ÿä¸Šè·‘äº†å¾ˆå¤šç¨‹åºï¼Œé‚£ä¹ˆæ¯ä¸ªç¨‹åºéƒ½ä¼šæœ‰ç›¸åº”çš„æ—¥å¿—äº§ç”Ÿï¼Œè€Œè¿™äº›æ—¥å¿—å°±è¢«è®°å½•åˆ°è¿™ä¸ªç›®å½•ä¸‹ï¼Œå…·ä½“åœ¨ /var/log ç›®å½•ä¸‹ï¼Œå¦å¤– mail çš„é¢„è®¾æ”¾ç½®ä¹Ÿæ˜¯åœ¨è¿™é‡Œã€‚</p>
<h2 id="inode"><a href="#inode" class="headerlink" title="inode"></a>inode</h2><p>ç¡¬ç›˜çš„æœ€å°å­˜å‚¨å•ä½æ˜¯æ‰‡åŒº(Sector)ï¼Œå—(block)ç”±å¤šä¸ªæ‰‡åŒºç»„æˆã€‚æ–‡ä»¶æ•°æ®å­˜å‚¨åœ¨å—ä¸­ã€‚å—çš„æœ€å¸¸è§çš„å¤§å°æ˜¯ 4kbï¼Œçº¦ä¸º 8 ä¸ªè¿ç»­çš„æ‰‡åŒºç»„æˆï¼ˆæ¯ä¸ªæ‰‡åŒºå­˜å‚¨ 512 å­—èŠ‚ï¼‰ã€‚ä¸€ä¸ªæ–‡ä»¶å¯èƒ½ä¼šå ç”¨å¤šä¸ª blockï¼Œä½†æ˜¯ä¸€ä¸ªå—åªèƒ½å­˜æ”¾ä¸€ä¸ªæ–‡ä»¶ã€‚</p>
<p>è™½ç„¶ï¼Œæˆ‘ä»¬å°†æ–‡ä»¶å­˜å‚¨åœ¨äº†å—(block)ä¸­ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç©ºé—´æ¥å­˜å‚¨æ–‡ä»¶çš„ å…ƒä¿¡æ¯ metadata ï¼šå¦‚æŸä¸ªæ–‡ä»¶è¢«åˆ†æˆå‡ å—ã€æ¯ä¸€å—åœ¨çš„åœ°å€ã€æ–‡ä»¶æ‹¥æœ‰è€…ï¼Œåˆ›å»ºæ—¶é—´ï¼Œæƒé™ï¼Œå¤§å°ç­‰ã€‚è¿™ç§ å­˜å‚¨æ–‡ä»¶å…ƒä¿¡æ¯çš„åŒºåŸŸå°±å« inodeï¼Œè¯‘ä¸ºç´¢å¼•èŠ‚ç‚¹ï¼šiï¼ˆindexï¼‰+nodeã€‚ æ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ª inodeï¼Œå­˜å‚¨æ–‡ä»¶çš„å…ƒä¿¡æ¯ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨ stat å‘½ä»¤å¯ä»¥æŸ¥çœ‹æ–‡ä»¶çš„ inode ä¿¡æ¯ã€‚æ¯ä¸ª inode éƒ½æœ‰ä¸€ä¸ªå·ç ï¼ŒLinux/Unix æ“ä½œç³»ç»Ÿä¸ä½¿ç”¨æ–‡ä»¶åæ¥åŒºåˆ†æ–‡ä»¶ï¼Œè€Œæ˜¯ä½¿ç”¨ inode å·ç åŒºåˆ†ä¸åŒçš„æ–‡ä»¶ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼šinode å°±æ˜¯ç”¨æ¥ç»´æŠ¤æŸä¸ªæ–‡ä»¶è¢«åˆ†æˆå‡ å—ã€æ¯ä¸€å—åœ¨çš„åœ°å€ã€æ–‡ä»¶æ‹¥æœ‰è€…ï¼Œåˆ›å»ºæ—¶é—´ï¼Œæƒé™ï¼Œå¤§å°ç­‰ä¿¡æ¯ã€‚<br>ç®€å•æ€»ç»“ä¸€ä¸‹ï¼š</p>
<ul>
<li>inode ï¼šè®°å½•æ–‡ä»¶çš„å±æ€§ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ stat å‘½ä»¤æŸ¥çœ‹ inode ä¿¡æ¯ã€‚</li>
<li>block ï¼šå®é™…æ–‡ä»¶çš„å†…å®¹ï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶å¤§äºä¸€ä¸ªå—æ—¶å€™ï¼Œé‚£ä¹ˆå°†å ç”¨å¤šä¸ª blockï¼Œä½†æ˜¯ä¸€ä¸ªå—åªèƒ½å­˜æ”¾ä¸€ä¸ªæ–‡ä»¶ã€‚ï¼ˆå› ä¸ºæ•°æ®æ˜¯ç”± inode æŒ‡å‘çš„ï¼Œå¦‚æœæœ‰ä¸¤ä¸ªæ–‡ä»¶çš„æ•°æ®å­˜æ”¾åœ¨åŒä¸€ä¸ªå—ä¸­ï¼Œå°±ä¼šä¹±å¥—äº†ï¼‰</li>
</ul>
<h2 id="è½¯é“¾æ¥ä¸ç¡¬é“¾æ¥"><a href="#è½¯é“¾æ¥ä¸ç¡¬é“¾æ¥" class="headerlink" title="è½¯é“¾æ¥ä¸ç¡¬é“¾æ¥"></a>è½¯é“¾æ¥ä¸ç¡¬é“¾æ¥</h2><p>è¯¦ç»†çš„å¯å‚è€ƒ: <a href="https://blog.csdn.net/yangxjsun/article/details/79681229" target="_blank" rel="noopener">https://blog.csdn.net/yangxjsun/article/details/79681229</a></p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/hard_link_soft_link.jpg" alt></p>
<h3 id="ç¡¬é“¾æ¥"><a href="#ç¡¬é“¾æ¥" class="headerlink" title="ç¡¬é“¾æ¥"></a>ç¡¬é“¾æ¥</h3><p>æ™®é€šé“¾æ¥ä¸€èˆ¬å°±æ˜¯æŒ‡ç¡¬é“¾æ¥, ç¡¬é“¾æ¥æ˜¯æ–°çš„ç›®å½•æ¡ç›®ï¼Œå…¶å¼•ç”¨ç³»ç»Ÿä¸­çš„ç°æœ‰æ–‡ä»¶ã€‚æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ¯ä¸€æ–‡ä»¶é»˜è®¤å…·æœ‰ä¸€ä¸ªç¡¬é“¾æ¥ã€‚ä¸ºèŠ‚çœç©ºé—´ï¼Œå¯ä»¥ä¸å¤åˆ¶æ–‡ä»¶ï¼Œè€Œåˆ›å»ºå¼•ç”¨åŒä¸€æ–‡ä»¶çš„æ–°ç¡¬é“¾æ¥ã€‚æ–°ç¡¬é“¾æ¥å¦‚æœåœ¨ä¸ç°æœ‰ç¡¬é“¾æ¥ç›¸åŒçš„ç›®å½•ä¸­åˆ›å»ºï¼Œåˆ™éœ€è¦æœ‰ä¸åŒçš„æ–‡ä»¶åï¼Œå¦åˆ™éœ€è¦åœ¨ä¸åŒçš„ç›®å½•ä¸­ã€‚æŒ‡å‘åŒä¸€æ–‡ä»¶çš„æ‰€æœ‰ç¡¬é“¾æ¥å…·æœ‰ç›¸åŒçš„æƒé™ã€è¿æ¥æ•°ã€ç”¨æˆ·/ç»„æ‰€æœ‰æƒã€æ—¶é—´æˆ³ä»¥åŠæ–‡ä»¶å†…å®¹ã€‚æŒ‡å‘åŒä¸€æ–‡ä»¶å†…å®¹çš„ç¡¬é“¾æ¥éœ€è¦åœ¨ç›¸åŒçš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚<br><strong>ç®€å•è¯´ï¼Œç¡¬é“¾æ¥å°±æ˜¯ä¸€ä¸ª inode å·å¯¹åº”å¤šä¸ªæ–‡ä»¶åã€‚å°±æ˜¯åŒä¸€ä¸ªæ–‡ä»¶ä½¿ç”¨äº†å¤šä¸ªåˆ«åï¼ˆä¸Šå›¾ä¸­ hard link å°±æ˜¯ file çš„ä¸€ä¸ªåˆ«åï¼Œä»–ä»¬æœ‰å…±åŒçš„ inodeï¼‰ã€‚</strong></p>
<p>ç”±äºç¡¬é“¾æ¥æ˜¯æœ‰ç€ç›¸åŒ inode å·ä»…æ–‡ä»¶åä¸åŒçš„æ–‡ä»¶ï¼Œå› æ­¤ç¡¬é“¾æ¥å­˜åœ¨ä»¥ä¸‹å‡ ç‚¹ç‰¹æ€§ï¼š</p>
<ul>
<li>æ–‡ä»¶æœ‰ç›¸åŒçš„ inode åŠ data blockï¼›</li>
<li>åªèƒ½å¯¹å·²å­˜åœ¨çš„æ–‡ä»¶è¿›è¡Œåˆ›å»ºï¼›</li>
<li>ä¸èƒ½äº¤å‰æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œç¡¬é“¾æ¥çš„åˆ›å»ºï¼›</li>
<li>ä¸èƒ½å¯¹ç›®å½•è¿›è¡Œåˆ›å»ºï¼Œåªå¯å¯¹æ–‡ä»¶åˆ›å»ºï¼›</li>
<li>åˆ é™¤ä¸€ä¸ªç¡¬é“¾æ¥æ–‡ä»¶å¹¶ä¸å½±å“å…¶ä»–æœ‰ç›¸åŒ inode å·çš„æ–‡ä»¶, åªæ˜¯ç›¸åº”çš„é“¾æ¥è®¡æ•°å™¨ï¼ˆlink count)å‡1</li>
</ul>
<h3 id="è½¯é“¾æ¥"><a href="#è½¯é“¾æ¥" class="headerlink" title="è½¯é“¾æ¥"></a>è½¯é“¾æ¥</h3><p>(åˆç§°ç¬¦å·é“¾æ¥ï¼Œå³ soft link æˆ– symbolic linkï¼‰ è½¯é“¾æ¥ä¸ç¡¬é“¾æ¥ä¸åŒï¼Œ<strong>è‹¥æ–‡ä»¶ç”¨æˆ·æ•°æ®å—ä¸­å­˜æ”¾çš„å†…å®¹æ˜¯å¦ä¸€æ–‡ä»¶çš„è·¯å¾„åçš„æŒ‡å‘ï¼Œåˆ™è¯¥æ–‡ä»¶å°±æ˜¯è½¯è¿æ¥</strong>ã€‚è½¯é“¾æ¥å°±æ˜¯ä¸€ä¸ªæ™®é€šæ–‡ä»¶ï¼Œåªæ˜¯æ•°æ®å—å†…å®¹æœ‰ç‚¹ç‰¹æ®Šã€‚è½¯é“¾æ¥æœ‰ç€è‡ªå·±çš„ inode å·ä»¥åŠç”¨æˆ·æ•°æ®å—ã€‚ï¼ˆè§å›¾2ï¼‰è½¯è¿æ¥å¯ä»¥æŒ‡å‘ç›®å½•ï¼Œè€Œä¸”è½¯è¿æ¥æ‰€æŒ‡å‘çš„ç›®å½•å¯ä»¥ä½äºä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚</p>
<p>è½¯é“¾æ¥ç‰¹æ€§ï¼š</p>
<ul>
<li>è½¯é“¾æ¥æœ‰è‡ªå·±çš„æ–‡ä»¶å±æ€§åŠæƒé™ç­‰ï¼›</li>
<li>å¯å¯¹ä¸å­˜åœ¨çš„æ–‡ä»¶æˆ–ç›®å½•åˆ›å»ºè½¯é“¾æ¥ï¼›</li>
<li>è½¯é“¾æ¥å¯äº¤å‰æ–‡ä»¶ç³»ç»Ÿï¼›</li>
<li>è½¯é“¾æ¥å¯å¯¹æ–‡ä»¶æˆ–ç›®å½•åˆ›å»ºï¼›</li>
<li>åˆ›å»ºè½¯é“¾æ¥æ—¶ï¼Œé“¾æ¥è®¡æ•° i_nlink ä¸ä¼šå¢åŠ ï¼›</li>
<li>åˆ é™¤è½¯é“¾æ¥å¹¶ä¸å½±å“è¢«æŒ‡å‘çš„æ–‡ä»¶ï¼Œä½†è‹¥è¢«æŒ‡å‘çš„åŸæ–‡ä»¶è¢«åˆ é™¤ï¼Œåˆ™ç›¸å…³è½¯è¿æ¥è¢«ç§°ä¸ºæ­»é“¾æ¥æˆ–æ‚¬æŒ‚çš„è½¯é“¾æ¥ï¼ˆå³ dangling linkï¼Œè‹¥è¢«æŒ‡å‘è·¯å¾„æ–‡ä»¶è¢«é‡æ–°åˆ›å»ºï¼Œæ­»é“¾æ¥å¯æ¢å¤ä¸ºæ­£å¸¸çš„è½¯é“¾æ¥ï¼‰ã€‚</li>
</ul>
<h2 id="Linux-ä¸ºä»€ä¹ˆå¤šè¿›ç¨‹èƒ½å¤Ÿè¯»å†™æ­£åœ¨åˆ é™¤çš„æ–‡ä»¶"><a href="#Linux-ä¸ºä»€ä¹ˆå¤šè¿›ç¨‹èƒ½å¤Ÿè¯»å†™æ­£åœ¨åˆ é™¤çš„æ–‡ä»¶" class="headerlink" title="Linux ä¸ºä»€ä¹ˆå¤šè¿›ç¨‹èƒ½å¤Ÿè¯»å†™æ­£åœ¨åˆ é™¤çš„æ–‡ä»¶"></a>Linux ä¸ºä»€ä¹ˆå¤šè¿›ç¨‹èƒ½å¤Ÿè¯»å†™æ­£åœ¨åˆ é™¤çš„æ–‡ä»¶</h2><p>å‚è€ƒ<a href="https://www.cnblogs.com/zhaoyl/archive/2012/05/15/2502010.html" target="_blank" rel="noopener">è¿›ç¨‹è¡¨_æ–‡ä»¶è¡¨_inode_vnode</a></p>
<p>Linuxä¸­å¤šè¿›ç¨‹ç¯å¢ƒä¸‹ï¼Œæ‰“å¼€åŒä¸€ä¸ªæ–‡ä»¶ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹è¿›è¡Œè¯»å†™æ“ä½œï¼Œå¦‚æœå¦å¤–ä¸€ä¸ªè¿›ç¨‹åˆ é™¤äº†è¿™ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆè¯»å†™è¯¥æ–‡ä»¶çš„è¿›ç¨‹ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢?</p>
<ul>
<li>å› ä¸ºæ–‡ä»¶è¢«åˆ é™¤äº†ï¼Œè¯»å†™è¿›ç¨‹å‘ç”Ÿå¼‚å¸¸?</li>
<li>æ­£åœ¨è¯»å†™çš„è¿›ç¨‹ä»ç„¶æ­£å¸¸è¯»å†™ï¼Œå¥½åƒæ²¡æœ‰å‘ç”Ÿä»€ä¹ˆï¼Ÿ</li>
</ul>
<p>å­¦æ“ä½œç³»ç»ŸåŸç†çš„æ—¶å€™ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œlinuxæ˜¯é€šè¿‡linkçš„æ•°é‡æ¥æ§åˆ¶æ–‡ä»¶åˆ é™¤ï¼Œåªæœ‰å½“ä¸€ä¸ªæ–‡ä»¶ä¸å­˜åœ¨ä»»ä½•linkçš„æ—¶å€™ï¼Œè¿™ä¸ªæ–‡ä»¶æ‰ä¼šè¢«åˆ é™¤ã€‚</p>
<p><strong>è€Œæ¯ä¸ªæ–‡ä»¶éƒ½ä¼šæœ‰2ä¸ªlinkè®¡æ•°å™¨:</strong></p>
<ul>
<li><code>i_count</code>: <code>i_count</code>çš„æ„ä¹‰æ˜¯å½“å‰ä½¿ç”¨è€…çš„æ•°é‡ï¼Œä¹Ÿå°±æ˜¯æ‰“å¼€æ–‡ä»¶è¿›ç¨‹çš„ä¸ªæ•°ã€‚</li>
<li><code>i_nlink</code>: <code>i_nlink</code>çš„æ„ä¹‰æ˜¯ä»‹è´¨è¿æ¥çš„æ•°é‡.</li>
</ul>
<p>æˆ–è€…å¯ä»¥ç†è§£ä¸º <code>i_count</code>æ˜¯å†…å­˜å¼•ç”¨è®¡æ•°å™¨ï¼Œ<code>i_nlink</code>æ˜¯ç¡¬ç›˜å¼•ç”¨è®¡æ•°å™¨ã€‚å†æ¢å¥è¯è¯´ï¼Œå½“æ–‡ä»¶è¢«æŸä¸ªè¿›ç¨‹å¼•ç”¨æ—¶ï¼Œ<code>i_count</code> å°±ä¼šå¢åŠ ï¼›å½“åˆ›å»ºæ–‡ä»¶çš„ç¡¬è¿æ¥çš„æ—¶å€™ï¼Œ<code>i_nlink</code> å°±ä¼šå¢åŠ ã€‚</p>
<p>å¯¹äº rm è€Œè¨€ï¼Œå°±æ˜¯å‡å°‘ <code>i_nlink</code>ã€‚è¿™é‡Œå°±å‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶æ­£åœ¨è¢«æŸä¸ªè¿›ç¨‹è°ƒç”¨ï¼Œè€Œç”¨æˆ·å´æ‰§è¡Œ rm æ“ä½œæŠŠæ–‡ä»¶åˆ é™¤äº†ï¼Œä¼šå‡ºç°ä»€ä¹ˆç»“æœå‘¢ï¼Ÿ</p>
<p>å½“ç”¨æˆ·æ‰§è¡Œ rm æ“ä½œåï¼Œls æˆ–è€…å…¶ä»–æ–‡ä»¶ç®¡ç†å‘½ä»¤ä¸å†èƒ½å¤Ÿæ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶ï¼Œä½†æ˜¯è¿›ç¨‹å´ä¾ç„¶åœ¨ç»§ç»­æ­£å¸¸æ‰§è¡Œï¼Œä¾ç„¶èƒ½å¤Ÿä»æ–‡ä»¶ä¸­æ­£ç¡®çš„è¯»å–å†…å®¹ã€‚è¿™æ˜¯å› ä¸ºï¼Œrm æ“ä½œåªæ˜¯å°† <code>i_nlink</code> ç½®ä¸º 0 äº†ï¼›ç”±äºæ–‡ä»¶è¢«è¿›ç¨‹å¼•ç”¨çš„ç¼˜æ•…ï¼Œ<code>i_count</code> ä¸ä¸º 0ï¼Œæ‰€ä»¥ç³»ç»Ÿæ²¡æœ‰çœŸæ­£åˆ é™¤è¿™ä¸ªæ–‡ä»¶ã€‚<code>i_nlink</code> æ˜¯æ–‡ä»¶åˆ é™¤çš„å……åˆ†æ¡ä»¶ï¼Œè€Œ <code>i_count</code> æ‰æ˜¯æ–‡ä»¶åˆ é™¤çš„å¿…è¦æ¡ä»¶ã€‚</p>
<p>åŸºäºä»¥ä¸Šåªæ˜¯ï¼Œå¤§å®¶çŒœä¸€ä¸‹ï¼Œå¦‚æœåœ¨ä¸€ä¸ªè¿›ç¨‹åœ¨æ‰“å¼€æ–‡ä»¶å†™æ—¥å¿—çš„æ—¶å€™ï¼Œæ‰‹åŠ¨æˆ–è€…å¦å¤–ä¸€ä¸ªè¿›ç¨‹å°†è¿™ä¸ªæ—¥å¿—åˆ é™¤ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿ</p>
<p>æ˜¯çš„ï¼Œæ•°æ®åº“å¹¶æ²¡æœ‰åœæ‰ã€‚è™½ç„¶æ—¥å¿—æ–‡ä»¶è¢«åˆ é™¤äº†ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªè¿›ç¨‹å·²ç»æ‰“å¼€äº†é‚£ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥å‘é‚£ä¸ªæ–‡ä»¶ä¸­çš„å†™æ“ä½œä»ç„¶ä¼šæˆåŠŸï¼Œæ•°æ®ä»ç„¶ä¼šæäº¤ã€‚</p>
<h2 id="æ–‡ä»¶æ“ä½œåç§»lseek"><a href="#æ–‡ä»¶æ“ä½œåç§»lseek" class="headerlink" title="æ–‡ä»¶æ“ä½œåç§»lseek"></a>æ–‡ä»¶æ“ä½œåç§»lseek</h2><p>lseekçš„å‡½æ•°ç”¨äºè®¾ç½®æ–‡ä»¶åç§»é‡ã€‚ </p>
<p>æ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªä¸å…¶ç›¸å…³è”çš„â€œå½“å‰æ–‡ä»¶åç§»é‡â€ï¼ˆå½“å‰æ–‡ä»¶åç§»é‡ï¼‰ã€‚å®ƒé€šå¸¸æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼Œç”¨ä»¥åº¦é‡ä»æ–‡ä»¶å¼€å§‹å¤„è®¡ç®—çš„å­—èŠ‚æ•°ã€‚é€šå¸¸ï¼Œè¯»å†™æ“ä½œéƒ½ä»å½“å‰æ–‡ä»¶åç§»é‡å¤„å¼€å§‹ï¼Œå¹¶ä½¿åç§»é‡å¢åŠ æ‰€è¯»å†™çš„å­—èŠ‚æ•°ã€‚æŒ‰ç³»ç»Ÿé»˜è®¤çš„æƒ…å†µï¼Œå½“æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œé™¤éåˆ¶å®šO_APPENDé€‰é¡¹ï¼Œå¦åˆ™è¯¥åç§»é‡è¢«è®¾ç½®ä¸º0ã€‚</p>
<h3 id="æ–‡ä»¶ç©ºæ´"><a href="#æ–‡ä»¶ç©ºæ´" class="headerlink" title="æ–‡ä»¶ç©ºæ´"></a>æ–‡ä»¶ç©ºæ´</h3><p>æˆ‘ä»¬çŸ¥é“lseek()ç³»ç»Ÿè°ƒç”¨å¯ä»¥æ”¹å˜æ–‡ä»¶çš„åç§»é‡ï¼Œä½†å¦‚æœç¨‹åºè°ƒç”¨ä½¿å¾—æ–‡ä»¶åç§»é‡è·¨è¶Šäº†æ–‡ä»¶ç»“å°¾ï¼Œç„¶åå†æ‰§è¡ŒI/Oæ“ä½œï¼Œå°†ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿ read()è°ƒç”¨å°†ä¼šè¿”å›0ï¼Œè¡¨ç¤ºæ–‡ä»¶ç»“å°¾ã€‚ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œwrite()å‡½æ•°å¯ä»¥åœ¨æ–‡ä»¶ç»“å°¾åçš„ä»»æ„ä½ç½®å†™å…¥æ•°æ®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯¹è¯¥æ–‡ä»¶çš„ä¸‹ä¸€æ¬¡å†™å°†å»¶é•¿è¯¥æ–‡ä»¶ï¼Œå¹¶åœ¨æ–‡ä»¶ä¸­æ„æˆä¸€ä¸ªç©ºæ´ï¼Œè¿™ä¸€ç‚¹æ˜¯å…è®¸çš„ã€‚ä»åŸæ¥çš„æ–‡ä»¶ç»“å°¾åˆ°æ–°å†™å…¥æ•°æ®é—´çš„è¿™æ®µç©ºé—´è¢«æˆä¸ºæ–‡ä»¶ç©ºæ´ã€‚è°ƒç”¨writeåæ–‡ä»¶ç»“å°¾çš„ä½ç½®å·²ç»å‘ç”Ÿå˜åŒ–ã€‚</p>
<p>æ–‡ä»¶ç©ºæ´ä¸å ç”¨ä»»ä½•ç£ç›˜ç©ºé—´ï¼Œç›´åˆ°åç»­æŸä¸ªæ—¶ç‚¹ï¼Œåœ¨æ–‡ä»¶ç©ºæ´ä¸­å†™å…¥äº†æ•°æ®ï¼Œæ–‡ä»¶ç³»ç»Ÿæ‰ä¼šä¸ºä¹‹åˆ†é…ç£ç›˜å—ã€‚ç©ºæ´çš„å­˜åœ¨æ„å‘³ç€ä¸€ä¸ªæ–‡ä»¶åä¹‰ä¸Šçš„å¤§å°å¯èƒ½è¦æ¯”å…¶å ç”¨çš„ç£ç›˜å­˜å‚¨æ€»é‡è¦å¤§ï¼ˆæœ‰æ—¶å¤§å‡ºè®¸å¤šï¼‰ã€‚å‘æ–‡ä»¶ç©ºæ´ä¸­å†™å…¥å­—èŠ‚ï¼Œå†…æ ¸éœ€è¦ä¸ºå…¶åˆ†é…å­˜å‚¨å•å…ƒï¼Œå³ä½¿æ–‡ä»¶å¤§å°ä¸å˜ï¼Œç³»ç»Ÿçš„å¯ç”¨ç£ç›˜ç©ºé—´ä¹Ÿå°†å‡å°‘ã€‚è¿™ç§æƒ…å†µå¹¶ä¸å¸¸è§ï¼Œä½†ä¹Ÿéœ€è¦äº†è§£ã€‚</p>
<p>å®é™…ä¸­çš„ç©ºæ´æ–‡ä»¶ä¼šåœ¨å“ªé‡Œç”¨åˆ°å‘¢?<strong>å¸¸è§çš„åœºæ™¯</strong>æœ‰:</p>
<ul>
<li>ä¸€æ˜¯åœ¨ä¸‹è½½ç”µå½±çš„æ—¶å€™,å‘ç°åˆšå¼€å§‹ä¸‹è½½,æ–‡ä»¶çš„å¤§å°å°±å·²ç»åˆ°å‡ ç™¾Mäº†.</li>
<li>äºŒæ˜¯åœ¨åˆ›å»ºè™šæ‹Ÿæœºçš„ç£ç›˜é•œåƒçš„æ—¶å€™,ä½ åˆ›å»ºäº†ä¸€ä¸ª100Gçš„ç£ç›˜é•œåƒ,ä½†æ˜¯å…¶å®è£…èµ·æ¥ç³»ç»Ÿä¹‹å,å¼€å§‹ä¹Ÿä¸è¿‡åªå ç”¨äº†3,4Gçš„ç£ç›˜ç©ºé—´,å¦‚æœä¸€å¼€å§‹æŠŠ100Géƒ½åˆ†é…å‡ºå»çš„è¯,æ— ç–‘æ˜¯å¾ˆå¤§çš„æµªè´¹.</li>
<li>ç©ºæ´æ–‡ä»¶æ–¹æ³•å¯¹å¤šçº¿ç¨‹å…±åŒæ“ä½œæ–‡ä»¶æ˜¯åŠå…¶æœ‰ç”¨çš„ã€‚æœ‰æ—¶å€™æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¾ˆå¤§çš„æ–‡ä»¶(æ¯”å¦‚è§†é¢‘æ–‡ä»¶)ï¼Œå¦‚æœä»å¤´å¼€å§‹ä¾æ¬¡æ„å»ºæ—¶é—´å¾ˆé•¿ã€‚æœ‰ä¸€ç§æ€è·¯å°±æ˜¯å°†æ–‡ä»¶åˆ†ä¸ºå¤šæ®µï¼Œç„¶åå¤šçº¿ç¨‹æ¥æ“ä½œæ¯ä¸ªçº¿ç¨‹è´Ÿè´£å…¶ä¸­ä¸€æ®µçš„å†™å…¥ã€‚ï¼ˆå°±åƒä¿®100å…¬é‡Œçš„é«˜é€Ÿå…¬è·¯ï¼Œåˆ†æˆ20ä¸ªæ®µæ¥ä¿®ï¼Œæ¯ä¸ªæ®µå°±åªè´Ÿè´£5å…¬é‡Œï¼Œå°±å¯ä»¥å¤§å¤§æé«˜æ•ˆç‡ï¼‰ã€‚</li>
</ul>
<h3 id="ä¹ é¢˜"><a href="#ä¹ é¢˜" class="headerlink" title="ä¹ é¢˜"></a>ä¹ é¢˜</h3><p>Linuxä¸‹ä¸¤ä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶æ‰“å¼€åŒä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™æ—¶å¦‚ä¸‹æè¿°<strong>é”™è¯¯</strong>çš„æ˜¯(ç­”æ¡ˆæ˜¯4)ï¼š</p>
<ol>
<li>ä¸¤ä¸ªè¿›ç¨‹ä¸­åˆ†åˆ«äº§ç”Ÿç”Ÿæˆä¸¤ä¸ªç‹¬ç«‹çš„fd</li>
<li>ä¸¤ä¸ªè¿›ç¨‹å¯ä»¥ä»»æ„å¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œï¼Œæ“ä½œç³»ç»Ÿå¹¶ä¸ä¿è¯å†™çš„åŸå­æ€§</li>
<li>è¿›ç¨‹å¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨å¯¹æ–‡ä»¶åŠ é”ï¼Œä»è€Œå®ç°å¯¹æ–‡ä»¶å†…å®¹çš„ä¿æŠ¤</li>
<li>ä»»ä½•ä¸€ä¸ªè¿›ç¨‹åˆ é™¤è¯¥æ–‡ä»¶æ—¶ï¼Œå¦å¤–ä¸€ä¸ªè¿›ç¨‹ä¼šç«‹å³å‡ºç°è¯»å†™å¤±è´¥</li>
<li>ä¸¤ä¸ªè¿›ç¨‹å¯ä»¥åˆ†åˆ«è¯»å–æ–‡ä»¶çš„ä¸åŒéƒ¨åˆ†è€Œä¸ä¼šç›¸äº’å½±å“</li>
<li>ä¸€ä¸ªè¿›ç¨‹å¯¹æ–‡ä»¶é•¿åº¦å’Œå†…å®¹çš„ä¿®æ”¹å¦å¤–ä¸€ä¸ªè¿›ç¨‹å¯ä»¥ç«‹å³æ„ŸçŸ¥</li>
</ol>
<h2 id="procæ–‡ä»¶å¤¹"><a href="#procæ–‡ä»¶å¤¹" class="headerlink" title="procæ–‡ä»¶å¤¹"></a>procæ–‡ä»¶å¤¹</h2><p>å‚è€ƒ: <a href="https://www.cnblogs.com/liushui-sky/p/9354536.html" target="_blank" rel="noopener">https://www.cnblogs.com/liushui-sky/p/9354536.html</a></p>
<p>ä¸‹é¢æ˜¯ä½œè€…ç³»ç»Ÿï¼ˆRHEL5.3ï¼‰ä¸Šè¿è¡Œçš„ä¸€ä¸ªPIDä¸º2674çš„è¿›ç¨‹saslauthdçš„ç›¸å…³æ–‡ä»¶ï¼Œå…¶ä¸­æœ‰äº›æ–‡ä»¶æ˜¯æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šå…·æœ‰çš„ï¼Œåæ–‡ä¼šå¯¹è¿™äº›å¸¸è§æ–‡ä»¶åšå‡ºè¯´æ˜ã€‚<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@rhel5 ~]# ll /proc/2674</span><br><span class="line">total 0</span><br><span class="line">dr-xr-xr-x 2 root root 0 Feb  8 17:15 attr</span><br><span class="line">-r-------- 1 root root 0 Feb  8 17:14 auxv</span><br><span class="line">-r--r--r-- 1 root root 0 Feb  8 17:09 cmdline</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb  8 17:14 coredump_filter</span><br><span class="line">-r--r--r-- 1 root root 0 Feb  8 17:14 cpuset</span><br><span class="line">lrwxrwxrwx 1 root root 0 Feb  8 17:14 cwd -&gt; /var/run/saslauthd</span><br><span class="line">-r-------- 1 root root 0 Feb  8 17:14 environ</span><br><span class="line">lrwxrwxrwx 1 root root 0 Feb  8 17:09 exe -&gt; /usr/sbin/saslauthd</span><br><span class="line">dr-x------ 2 root root 0 Feb  8 17:15 fd</span><br><span class="line">-r-------- 1 root root 0 Feb  8 17:14 limits</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb  8 17:14 loginuid</span><br><span class="line">-r--r--r-- 1 root root 0 Feb  8 17:14 maps</span><br><span class="line">-rw------- 1 root root 0 Feb  8 17:14 mem</span><br><span class="line">-r--r--r-- 1 root root 0 Feb  8 17:14 mounts</span><br><span class="line">-r-------- 1 root root 0 Feb  8 17:14 mountstats</span><br><span class="line">-rw-r--r-- 1 root root 0 Feb  8 17:14 oom_adj</span><br><span class="line">-r--r--r-- 1 root root 0 Feb  8 17:14 oom_score</span><br><span class="line">lrwxrwxrwx 1 root root 0 Feb  8 17:14 root -&gt; /</span><br><span class="line">-r--r--r-- 1 root root 0 Feb  8 17:14 schedstat</span><br><span class="line">-r-------- 1 root root 0 Feb  8 17:14 smaps</span><br><span class="line">-r--r--r-- 1 root root 0 Feb  8 17:09 stat</span><br><span class="line">-r--r--r-- 1 root root 0 Feb  8 17:14 statm</span><br><span class="line">-r--r--r-- 1 root root 0 Feb  8 17:10 status</span><br><span class="line">dr-xr-xr-x 3 root root 0 Feb  8 17:15 task</span><br><span class="line">-r--r--r-- 1 root root 0 Feb  8 17:14 wchan</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>cmdline â€” å¯åŠ¨å½“å‰è¿›ç¨‹çš„å®Œæ•´å‘½ä»¤ï¼Œä½†åƒµå°¸è¿›ç¨‹ç›®å½•ä¸­çš„æ­¤æ–‡ä»¶ä¸åŒ…å«ä»»ä½•ä¿¡æ¯ï¼›</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@rhel5 ~]# more /proc/2674/cmdline </span><br><span class="line">/usr/sbin/saslauthd</span><br></pre></td></tr></table></figure>
</li>
<li><p>cwd â€” æŒ‡å‘å½“å‰è¿›ç¨‹è¿è¡Œç›®å½•çš„ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼›</p>
</li>
<li><p>environ â€” å½“å‰è¿›ç¨‹çš„ç¯å¢ƒå˜é‡åˆ—è¡¨ï¼Œå½¼æ­¤é—´ç”¨ç©ºå­—ç¬¦ï¼ˆNULLï¼‰éš”å¼€ï¼›å˜é‡ç”¨å¤§å†™å­—æ¯è¡¨ç¤ºï¼Œå…¶å€¼ç”¨å°å†™å­—æ¯è¡¨ç¤ºï¼›</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@rhel5 ~]# more /proc/2674/environ </span><br><span class="line">TERM=linuxauthd</span><br></pre></td></tr></table></figure>
</li>
<li><p>exe â€” æŒ‡å‘å¯åŠ¨å½“å‰è¿›ç¨‹çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå®Œæ•´è·¯å¾„ï¼‰çš„ç¬¦å·é“¾æ¥ï¼Œé€šè¿‡/proc/N/exeå¯ä»¥å¯åŠ¨å½“å‰è¿›ç¨‹çš„ä¸€ä¸ªæ‹·è´ï¼›</p>
</li>
<li><p>fd â€” è¿™æ˜¯ä¸ªç›®å½•ï¼ŒåŒ…å«å½“å‰è¿›ç¨‹æ‰“å¼€çš„æ¯ä¸€ä¸ªæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰ï¼Œè¿™äº›æ–‡ä»¶æè¿°ç¬¦æ˜¯æŒ‡å‘å®é™…æ–‡ä»¶çš„ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼›</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@rhel5 ~]# ll /proc/2674/fd</span><br><span class="line">total 0</span><br><span class="line">lrwx------ 1 root root 64 Feb  8 17:17 0 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 root root 64 Feb  8 17:17 1 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 root root 64 Feb  8 17:17 2 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 root root 64 Feb  8 17:17 3 -&gt; socket:[7990]</span><br><span class="line">lrwx------ 1 root root 64 Feb  8 17:17 4 -&gt; /var/run/saslauthd/saslauthd.pid</span><br><span class="line">lrwx------ 1 root root 64 Feb  8 17:17 5 -&gt; socket:[7991]</span><br><span class="line">lrwx------ 1 root root 64 Feb  8 17:17 6 -&gt; /var/run/saslauthd/mux.accept</span><br></pre></td></tr></table></figure>
</li>
<li><p>limits â€” å½“å‰è¿›ç¨‹æ‰€ä½¿ç”¨çš„æ¯ä¸€ä¸ªå—é™èµ„æºçš„è½¯é™åˆ¶ã€ç¡¬é™åˆ¶å’Œç®¡ç†å•å…ƒï¼›æ­¤æ–‡ä»¶ä»…å¯ç”±å®é™…å¯åŠ¨å½“å‰è¿›ç¨‹çš„UIDç”¨æˆ·è¯»å–ï¼›ï¼ˆ2.6.24ä»¥åçš„å†…æ ¸ç‰ˆæœ¬æ”¯æŒæ­¤åŠŸèƒ½ï¼‰ï¼›</p>
</li>
<li><p>maps â€” å½“å‰è¿›ç¨‹å…³è”åˆ°çš„æ¯ä¸ªå¯æ‰§è¡Œæ–‡ä»¶å’Œåº“æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„æ˜ å°„åŒºåŸŸåŠå…¶è®¿é—®æƒé™æ‰€ç»„æˆçš„åˆ—è¡¨ï¼›</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@rhel5 ~]# cat /proc/2674/maps </span><br><span class="line">00110000-00239000 r-xp 00000000 08:02 130647     /lib/libcrypto.so.0.9.8e</span><br><span class="line">00239000-0024c000 rwxp 00129000 08:02 130647     /lib/libcrypto.so.0.9.8e</span><br><span class="line">0024c000-00250000 rwxp 0024c000 00:00 0 </span><br><span class="line">00250000-00252000 r-xp 00000000 08:02 130462     /lib/libdl-2.5.so</span><br><span class="line">00252000-00253000 r-xp 00001000 08:02 130462     /lib/libdl-2.5.so</span><br></pre></td></tr></table></figure>
</li>
<li><p>mem â€” å½“å‰è¿›ç¨‹æ‰€å ç”¨çš„å†…å­˜ç©ºé—´ï¼Œç”±openã€readå’Œlseekç­‰ç³»ç»Ÿè°ƒç”¨ä½¿ç”¨ï¼Œä¸èƒ½è¢«ç”¨æˆ·è¯»å–ï¼›</p>
</li>
<li><p>root â€” æŒ‡å‘å½“å‰è¿›ç¨‹è¿è¡Œæ ¹ç›®å½•çš„ç¬¦å·é“¾æ¥ï¼›åœ¨Unixå’ŒLinuxç³»ç»Ÿä¸Šï¼Œé€šå¸¸é‡‡ç”¨chrootå‘½ä»¤ä½¿æ¯ä¸ªè¿›ç¨‹è¿è¡Œäºç‹¬ç«‹çš„æ ¹ç›®å½•ï¼›</p>
</li>
<li><p>stat â€” å½“å‰è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…å«ä¸€ç³»ç»Ÿæ ¼å¼åŒ–åçš„æ•°æ®åˆ—ï¼Œå¯è¯»æ€§å·®ï¼Œé€šå¸¸ç”±pså‘½ä»¤ä½¿ç”¨ï¼›</p>
</li>
<li><p>statm â€” å½“å‰è¿›ç¨‹å ç”¨å†…å­˜çš„çŠ¶æ€ä¿¡æ¯ï¼Œé€šå¸¸ä»¥â€œé¡µé¢â€ï¼ˆpageï¼‰è¡¨ç¤ºï¼›</p>
</li>
<li><p>status â€” ä¸statæ‰€æä¾›ä¿¡æ¯ç±»ä¼¼ï¼Œä½†å¯è¯»æ€§è¾ƒå¥½ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œæ¯è¡Œè¡¨ç¤ºä¸€ä¸ªå±æ€§ä¿¡æ¯ï¼›å…¶è¯¦ç»†ä»‹ç»è¯·å‚è§ procçš„manæ‰‹å†Œé¡µï¼›</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@rhel5 ~]# more /proc/2674/status </span><br><span class="line">Name:   saslauthd</span><br><span class="line">State:  S (sleeping)</span><br><span class="line">SleepAVG:       0%</span><br><span class="line">Tgid:   2674</span><br><span class="line">Pid:    2674</span><br><span class="line">PPid:   1</span><br><span class="line">TracerPid:      0</span><br><span class="line">Uid:    0       0       0       0</span><br><span class="line">Gid:    0       0       0       0</span><br><span class="line">FDSize: 32</span><br><span class="line">Groups:</span><br><span class="line">VmPeak:     5576 kB</span><br><span class="line">VmSize:     5572 kB</span><br><span class="line">VmLck:         0 kB</span><br><span class="line">VmHWM:       696 kB</span><br><span class="line">VmRSS:       696 kB</span><br><span class="line">â€¦â€¦â€¦â€¦</span><br></pre></td></tr></table></figure>
</li>
<li><p>task â€” ç›®å½•æ–‡ä»¶ï¼ŒåŒ…å«ç”±å½“å‰è¿›ç¨‹æ‰€è¿è¡Œçš„æ¯ä¸€ä¸ªçº¿ç¨‹çš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯ä¸ªçº¿ç¨‹çš„ç›¸å…³ä¿¡æ¯æ–‡ä»¶å‡ä¿å­˜åœ¨ä¸€ä¸ªç”±çº¿ç¨‹å·ï¼ˆtidï¼‰å‘½åçš„ç›®å½•ä¸­ï¼Œè¿™ç±»ä¼¼äºå…¶å†…å®¹ç±»ä¼¼äºæ¯ä¸ªè¿›ç¨‹ç›®å½•ä¸­çš„å†…å®¹ï¼›ï¼ˆå†…æ ¸2.6ç‰ˆæœ¬ä»¥åæ”¯æŒæ­¤åŠŸèƒ½ï¼‰</p>
</li>
</ul>
<h1 id="Linuxè¿›ç¨‹ç®¡ç†"><a href="#Linuxè¿›ç¨‹ç®¡ç†" class="headerlink" title="Linuxè¿›ç¨‹ç®¡ç†"></a>Linuxè¿›ç¨‹ç®¡ç†</h1><h2 id="è¯»è€…-å†™è€…é—®é¢˜"><a href="#è¯»è€…-å†™è€…é—®é¢˜" class="headerlink" title="è¯»è€…-å†™è€…é—®é¢˜"></a>è¯»è€…-å†™è€…é—®é¢˜</h2><p>å®šä¹‰ï¼š å…è®¸å¤šä¸ªè¿›ç¨‹åŒæ—¶å¯¹æ•°æ®è¿›è¡Œè¯»æ“ä½œï¼Œä½†æ˜¯ä¸å…è®¸è¯»å’Œå†™ä»¥åŠå†™å’Œå†™æ“ä½œåŒæ—¶å‘ç”Ÿã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š  </p>
<ul>
<li>è¯»è€…ä¼˜å…ˆ<br>  è¯»è¿›ç¨‹åªè¦çœ‹åˆ°æœ‰å…¶ä»–è¯»è¿›ç¨‹æ­£åœ¨è®¿é—®æ–‡ä»¶ï¼Œå°±å¯ä»¥ç»§ç»­ä½œè¯»è®¿é—®ï¼›å†™è¿›ç¨‹å¿…é¡»ç­‰å¾…æ‰€æœ‰è¯»è¿›ç¨‹éƒ½ä¸è®¿é—®æ—¶æ‰èƒ½å†™æ–‡ä»¶ï¼Œå³ä½¿å†™è¿›ç¨‹å¯èƒ½æ¯”ä¸€äº›è¯»è¿›ç¨‹æ›´æ—©æå‡ºç”³è¯·ã€‚</li>
<li>è¯»è€…å†™è€…å…¬å¹³ç«äº‰ï¼Œè€å®æ’é˜Ÿ<br>  å› ä¸ºè¯»è€…ä¼˜å…ˆçš„æ–¹æ¡ˆå¦‚æœåœ¨è¯»è®¿é—®éå¸¸é¢‘ç¹çš„åœºåˆï¼Œæœ‰å¯èƒ½é€ æˆå†™è¿›ç¨‹ä¸€ç›´æ— æ³•è®¿é—®æ–‡ä»¶çš„å±€é¢â€¦.ä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„äº§ç”Ÿï¼Œè¯»è€…å†™è€…è¯·æ±‚éƒ½è€å®æ’é˜Ÿï¼Œ æ’åˆ°è°å°±æ‰§è¡Œè°ï¼Œ ä¸å‡†è¯»è€…æ’é˜Ÿ</li>
<li>å†™è€…ä¼˜å…ˆ<br>  å¦‚æœæœ‰å†™è€…ç”³è¯·å†™æ–‡ä»¶ï¼Œé‚£ä¹ˆåœ¨ç”³è¯·ä¹‹å‰å·²ç»å¼€å§‹è¯»å–æ–‡ä»¶çš„å¯ä»¥ç»§ç»­è¯»å–ï¼Œä½†æ˜¯å¦‚æœå†æœ‰è¯»è€…ç”³è¯·è¯»å–æ–‡ä»¶ï¼Œåˆ™ä¸èƒ½å¤Ÿè¯»å–ï¼Œåªæœ‰åœ¨æ‰€æœ‰çš„å†™è€…å†™å®Œä¹‹åæ‰å¯ä»¥è¯»å–</li>
</ul>
<h2 id="å“²å­¦å®¶å°±é¤é—®é¢˜"><a href="#å“²å­¦å®¶å°±é¤é—®é¢˜" class="headerlink" title="å“²å­¦å®¶å°±é¤é—®é¢˜"></a>å“²å­¦å®¶å°±é¤é—®é¢˜</h2><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/an_illustration_of_the_dining_philosophers_problem.png" alt></p>
<p>5 ä¸ªæ²‰é»˜å¯¡è¨€çš„å“²å­¦å®¶å›´ååœ¨åœ†æ¡Œå‰ï¼Œæ¯äººé¢å‰ä¸€ç›˜æ„é¢ã€‚å‰å­æ”¾åœ¨å“²å­¦å®¶ä¹‹é—´çš„æ¡Œé¢ä¸Šã€‚ï¼ˆ5 ä¸ªå“²å­¦å®¶ï¼Œ5 æ ¹å‰å­ï¼‰</p>
<p>æ‰€æœ‰çš„å“²å­¦å®¶éƒ½åªä¼šåœ¨æ€è€ƒå’Œè¿›é¤ä¸¤ç§è¡Œä¸ºé—´äº¤æ›¿ã€‚å“²å­¦å®¶åªæœ‰åŒæ—¶æ‹¿åˆ°å·¦è¾¹å’Œå³è¾¹çš„å‰å­æ‰èƒ½åƒåˆ°é¢ï¼Œè€ŒåŒä¸€æ ¹å‰å­åœ¨åŒä¸€æ—¶é—´åªèƒ½è¢«ä¸€ä¸ªå“²å­¦å®¶ä½¿ç”¨ã€‚æ¯ä¸ªå“²å­¦å®¶åƒå®Œé¢åéƒ½éœ€è¦æŠŠå‰å­æ”¾å›æ¡Œé¢ä»¥ä¾›å…¶ä»–å“²å­¦å®¶åƒé¢ã€‚åªè¦æ¡ä»¶å…è®¸ï¼Œå“²å­¦å®¶å¯ä»¥æ‹¿èµ·å·¦è¾¹æˆ–è€…å³è¾¹çš„å‰å­ï¼Œä½†åœ¨æ²¡æœ‰åŒæ—¶æ‹¿åˆ°å·¦å³å‰å­æ—¶ä¸èƒ½è¿›é£Ÿã€‚</p>
<p>è®¾è®¡ä¸€ä¸ªè¿›é¤è§„åˆ™ï¼ˆå¹¶è¡Œç®—æ³•ï¼‰ä½¿å¾—æ¯ä¸ªå“²å­¦å®¶éƒ½ä¸ä¼šæŒ¨é¥¿ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ²¡æœ‰äººçŸ¥é“åˆ«äººä»€ä¹ˆæ—¶å€™æƒ³åƒä¸œè¥¿æˆ–æ€è€ƒçš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå“²å­¦å®¶éƒ½å¯ä»¥åœ¨åƒé¥­å’Œæ€è€ƒä¹‹é—´ä¸€ç›´äº¤æ›¿ä¸‹å»ã€‚</p>
<p>æ˜¾è€Œæ˜“è§ï¼Œ<strong>å¦‚æœä¸å°å¿ƒå¤„ç†ä¼šæœ‰æ­»é”ç°è±¡</strong>ï¼Œ æ¯”å¦‚ï¼šå½“æ¯ä¸ªç§‘å­¦å®¶éƒ½åŒæ—¶æ‹¿èµ·äº†å·¦è¾¹çš„ç­·å­æ—¶å€™æ­»é”å‘ç”Ÿäº†ï¼Œéƒ½æƒ³æ‹¿è‡ªå·±å³è¾¹çš„ç­·å­ï¼Œä½†æ˜¯ç§‘å­¦å®¶æ¯ä¸ªäººå·¦æ‰‹éƒ½ä¸æ¾æ‰‹ã€‚å¯¼è‡´éƒ½åƒä¸äº†é¥­</p>
<p><a href="https://zhuanlan.zhihu.com/p/34553097" target="_blank" rel="noopener">å‚è€ƒ</a><br>è§£å†³æ–¹æ¡ˆï¼š  </p>
<ul>
<li>è§„å®šå¥‡æ•°å·ç§‘å­¦å®¶å…ˆæ‹¿å·¦è¾¹çš„ç­·å­ï¼Œç„¶åæ‹¿å³è¾¹çš„ç­·å­ã€‚å¶æ•°å·ç§‘å­¦å®¶å…ˆæ‹¿å³è¾¹çš„ç­·å­ï¼Œç„¶åé‚£å·¦è¾¹çš„ç­·å­ã€‚å¯¼è‡´0ï¼Œ1ç§‘å­¦å®¶ç«äº‰1å·ç­·å­ï¼Œ2ï¼Œ3ç§‘å­¦å®¶ç«äº‰3å·ç­·å­ã€‚å››å·ç§‘å­¦å®¶æ— äººç«äº‰ã€‚æœ€åæ€»æœ‰ä¸€ä¸ªç§‘å­¦å®¶èƒ½è·å¾—ä¸¤åªç­·å­ã€‚</li>
<li>ä»…å½“ç§‘å­¦å®¶å·¦å³ä¸¤åªç­·å­éƒ½èƒ½ç”¨çš„æ—¶å€™ï¼Œæ‰å…è®¸ä»–è¿›é¤ï¼Œä»£ç é‡Œçš„ç”¨trylockæ¥å®ç°</li>
<li>è‡³å¤šå…è®¸å››ä¸ªå“²å­¦å®¶åŒæ—¶å»æ‹¿å·¦è¾¹çš„ç­·å­ï¼Œæœ€ç»ˆä¿è¯è‡³å°‘æœ‰ä¸€ä¸ªç§‘å­¦å®¶èƒ½è¿›é¤ï¼Œå¹¶ä¸”ç”¨å®Œä¹‹åé‡Šæ”¾ç­·å­ï¼Œä»è€Œä½¿æ›´å¤šçš„å“²å­¦å®¶èƒ½å¤Ÿæ‹¿åˆ°ç­·å­ã€‚</li>
</ul>
<h2 id="æ´»é”"><a href="#æ´»é”" class="headerlink" title="æ´»é”"></a>æ´»é”</h2><p>åœ¨æŸç§æƒ…å½¢ä¸‹ï¼Œè½®è¯¢ï¼ˆå¿™ç­‰å¾…ï¼‰å¯ç”¨äºè¿›å…¥ä¸´ç•ŒåŒºæˆ–å­˜å–èµ„æºã€‚é‡‡ç”¨è¿™ä¸€ç­–ç•¥çš„ä¸»è¦åŸå› æ˜¯ï¼Œç›¸æ¯”æ‰€åšçš„å·¥ä½œè€Œè¨€ï¼Œäº’æ–¥çš„æ—¶é—´å¾ˆçŸ­è€ŒæŒ‚èµ·ç­‰å¾…çš„æ—¶é—´å¼€é”€å¾ˆå¤§ã€‚è€ƒè™‘ä¸€ä¸ªåŸè¯­ï¼Œé€šè¿‡è¯¥åŸè¯­ï¼Œè°ƒç”¨è¿›ç¨‹æµ‹è¯•ä¸€ä¸ªäº’æ–¥ä¿¡å·é‡ï¼Œç„¶åæˆ–è€…å¾—åˆ°è¯¥ä¿¡å·é‡æˆ–è€…è¿”å›å¤±è´¥ä¿¡æ¯ã€‚</p>
<p>ç°åœ¨å‡è®¾æœ‰ä¸€å¯¹è¿›ç¨‹ä½¿ç”¨ä¸¤ç§èµ„æºã€‚æ¯ä¸ªè¿›ç¨‹éœ€è¦ä¸¤ç§èµ„æºï¼Œå®ƒä»¬åˆ©ç”¨è½®è¯¢åŸè¯­enter_regionå»å°è¯•å–å¾—å¿…è¦çš„é”ï¼Œå¦‚æœå°è¯•å¤±è´¥ï¼Œåˆ™è¯¥è¿›ç¨‹ç»§ç»­å°è¯•ã€‚å¦‚æœè¿›ç¨‹Aå…ˆè¿è¡Œå¹¶å¾—åˆ°èµ„æº1ï¼Œç„¶åè¿›ç¨‹2è¿è¡Œå¹¶å¾—åˆ°èµ„æº2ï¼Œä»¥åä¸ç®¡å“ªä¸€ä¸ªè¿›ç¨‹è¿è¡Œï¼Œéƒ½ä¸ä¼šæœ‰ä»»ä½•è¿›å±•ï¼Œä½†æ˜¯å“ªä¸€ä¸ªè¿›ç¨‹ä¹Ÿæ²¡æœ‰è¢«é˜»å¡ã€‚ç»“æœæ˜¯ä¸¤ä¸ªè¿›ç¨‹æ€»æ˜¯ä¸€å†æ¶ˆè€—å®Œåˆ†é…ç»™å®ƒä»¬çš„CPUé…é¢ï¼Œ<strong>ä½†æ˜¯æ²¡æœ‰è¿›å±•ä¹Ÿæ²¡æœ‰é˜»å¡</strong>ã€‚å› æ­¤ï¼Œæ²¡æœ‰å‡ºç°æ­»é”ç°è±¡ï¼ˆå› ä¸ºæ²¡æœ‰è¿›ç¨‹é˜»å¡ï¼‰ï¼Œä½†æ˜¯ä»ç°è±¡ä¸Šçœ‹å¥½åƒæ­»é”å‘ç”Ÿäº†ï¼Œè¿™å°±æ˜¯æ´»é”ï¼ˆlivelockï¼‰ã€‚</p>
<h2 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h2><p><a href="https://www.cyc2018.xyz/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%20-%20%E6%AD%BB%E9%94%81.html" target="_blank" rel="noopener">å‚è€ƒ</a></p>
<h3 id="å¿…è¦æ¡ä»¶"><a href="#å¿…è¦æ¡ä»¶" class="headerlink" title="å¿…è¦æ¡ä»¶"></a>å¿…è¦æ¡ä»¶</h3><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/dead_lock/dead_lock1.png" alt></p>
<p>(å£è¯€äº’å ä¸è¿˜ï¼Ÿ233):  </p>
<ul>
<li>äº’æ–¥ï¼šæ¯ä¸ªèµ„æºè¦ä¹ˆå·²ç»åˆ†é…ç»™äº†ä¸€ä¸ªè¿›ç¨‹ï¼Œè¦ä¹ˆå°±æ˜¯å¯ç”¨çš„ã€‚</li>
<li>å æœ‰å’Œç­‰å¾…ï¼šå·²ç»å¾—åˆ°äº†æŸä¸ªèµ„æºçš„è¿›ç¨‹å¯ä»¥å†è¯·æ±‚æ–°çš„èµ„æºã€‚</li>
<li>ä¸å¯æŠ¢å ï¼šå·²ç»åˆ†é…ç»™ä¸€ä¸ªè¿›ç¨‹çš„èµ„æºä¸èƒ½å¼ºåˆ¶æ€§åœ°è¢«æŠ¢å ï¼Œå®ƒåªèƒ½è¢«å æœ‰å®ƒçš„è¿›ç¨‹æ˜¾å¼åœ°é‡Šæ”¾ã€‚</li>
<li>ç¯è·¯ç­‰å¾…ï¼šæœ‰ä¸¤ä¸ªæˆ–è€…ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹ç»„æˆä¸€æ¡ç¯è·¯ï¼Œè¯¥ç¯è·¯ä¸­çš„æ¯ä¸ªè¿›ç¨‹éƒ½åœ¨ç­‰å¾…ä¸‹ä¸€ä¸ªè¿›ç¨‹æ‰€å æœ‰çš„èµ„æºã€‚</li>
</ul>
<h3 id="æ­»é”å¤„ç†æ–¹æ³•å¤§çº²"><a href="#æ­»é”å¤„ç†æ–¹æ³•å¤§çº²" class="headerlink" title="æ­»é”å¤„ç†æ–¹æ³•å¤§çº²"></a>æ­»é”å¤„ç†æ–¹æ³•å¤§çº²</h3><p>ä¸»è¦æœ‰ä»¥ä¸‹å››ç§æ–¹æ³•ï¼š  </p>
<ul>
<li>é¸µé¸Ÿç­–ç•¥</li>
<li>æ­»é”æ£€æµ‹ä¸æ­»é”æ¢å¤</li>
<li>æ­»é”é¢„é˜²</li>
<li>æ­»é”é¿å…</li>
</ul>
<h3 id="é¸µé¸Ÿç­–ç•¥"><a href="#é¸µé¸Ÿç­–ç•¥" class="headerlink" title="é¸µé¸Ÿç­–ç•¥"></a>é¸µé¸Ÿç­–ç•¥</h3><p>æŠŠå¤´åŸ‹åœ¨æ²™å­é‡Œï¼Œå‡è£…æ ¹æœ¬æ²¡å‘ç”Ÿé—®é¢˜ã€‚<br>å› ä¸ºè§£å†³æ­»é”é—®é¢˜çš„ä»£ä»·å¾ˆé«˜ï¼Œå› æ­¤é¸µé¸Ÿç­–ç•¥è¿™ç§ä¸é‡‡å–ä»»åŠ¡æªæ–½çš„æ–¹æ¡ˆä¼šè·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚å½“å‘ç”Ÿæ­»é”æ—¶ä¸ä¼šå¯¹ç”¨æˆ·é€ æˆå¤šå¤§å½±å“ï¼Œæˆ–å‘ç”Ÿæ­»é”çš„æ¦‚ç‡å¾ˆä½ï¼Œå¯ä»¥é‡‡ç”¨é¸µé¸Ÿç­–ç•¥ã€‚å¤§å¤šæ•°æ“ä½œç³»ç»Ÿï¼ŒåŒ…æ‹¬ Unixï¼ŒLinux å’Œ Windowsï¼Œå¤„ç†æ­»é”é—®é¢˜çš„åŠæ³•ä»…ä»…æ˜¯å¿½ç•¥å®ƒã€‚</p>
<h3 id="æ­»é”æ£€æµ‹ä¸æ­»é”æ¢å¤"><a href="#æ­»é”æ£€æµ‹ä¸æ­»é”æ¢å¤" class="headerlink" title="æ­»é”æ£€æµ‹ä¸æ­»é”æ¢å¤"></a>æ­»é”æ£€æµ‹ä¸æ­»é”æ¢å¤</h3><p>ä¸è¯•å›¾é˜»æ­¢æ­»é”ï¼Œè€Œæ˜¯å½“æ£€æµ‹åˆ°æ­»é”å‘ç”Ÿæ—¶ï¼Œé‡‡å–æªæ–½è¿›è¡Œæ¢å¤ã€‚</p>
<h4 id="æ¯ç§ç±»å‹ä¸€ä¸ªèµ„æºçš„æ­»é”æ£€æµ‹"><a href="#æ¯ç§ç±»å‹ä¸€ä¸ªèµ„æºçš„æ­»é”æ£€æµ‹" class="headerlink" title="æ¯ç§ç±»å‹ä¸€ä¸ªèµ„æºçš„æ­»é”æ£€æµ‹"></a>æ¯ç§ç±»å‹ä¸€ä¸ªèµ„æºçš„æ­»é”æ£€æµ‹</h4><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/dead_lock/dead_lock2.png" alt></p>
<p>ä¸Šå›¾ä¸ºèµ„æºåˆ†é…å›¾ï¼Œå…¶ä¸­æ–¹æ¡†è¡¨ç¤ºèµ„æºï¼Œåœ†åœˆè¡¨ç¤ºè¿›ç¨‹ã€‚èµ„æºæŒ‡å‘è¿›ç¨‹è¡¨ç¤ºè¯¥èµ„æºå·²ç»åˆ†é…ç»™è¯¥è¿›ç¨‹ï¼Œè¿›ç¨‹æŒ‡å‘èµ„æºè¡¨ç¤ºè¿›ç¨‹è¯·æ±‚è·å–è¯¥èµ„æºã€‚</p>
<p>å›¾ a å¯ä»¥æŠ½å–å‡ºç¯ï¼Œå¦‚å›¾ bï¼Œå®ƒæ»¡è¶³äº†ç¯è·¯ç­‰å¾…æ¡ä»¶ï¼Œå› æ­¤ä¼šå‘ç”Ÿæ­»é”ã€‚</p>
<p>æ¯ç§ç±»å‹ä¸€ä¸ªèµ„æºçš„æ­»é”æ£€æµ‹ç®—æ³•æ˜¯é€šè¿‡æ£€æµ‹æœ‰å‘å›¾æ˜¯å¦å­˜åœ¨ç¯æ¥å®ç°ï¼Œä»ä¸€ä¸ªèŠ‚ç‚¹å‡ºå‘è¿›è¡Œæ·±åº¦ä¼˜å…ˆæœç´¢ï¼Œå¯¹è®¿é—®è¿‡çš„èŠ‚ç‚¹è¿›è¡Œæ ‡è®°ï¼Œå¦‚æœè®¿é—®äº†å·²ç»æ ‡è®°çš„èŠ‚ç‚¹ï¼Œå°±è¡¨ç¤ºæœ‰å‘å›¾å­˜åœ¨ç¯ï¼Œä¹Ÿå°±æ˜¯æ£€æµ‹åˆ°æ­»é”çš„å‘ç”Ÿã€‚ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ç”¨æ‹“æ‰‘æ’åºæ€è·¯æ¥æ£€æµ‹å“ˆï¼‰</p>
<h4 id="æ¯ç§ç±»å‹å¤šä¸ªèµ„æºçš„æ­»é”æ£€æµ‹"><a href="#æ¯ç§ç±»å‹å¤šä¸ªèµ„æºçš„æ­»é”æ£€æµ‹" class="headerlink" title="æ¯ç§ç±»å‹å¤šä¸ªèµ„æºçš„æ­»é”æ£€æµ‹"></a>æ¯ç§ç±»å‹å¤šä¸ªèµ„æºçš„æ­»é”æ£€æµ‹</h4><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/dead_lock/dead_lock3.png" alt></p>
<p>ä¸Šå›¾ä¸­ï¼Œæœ‰ä¸‰ä¸ªè¿›ç¨‹å››ä¸ªèµ„æºï¼Œæ¯ä¸ªæ•°æ®ä»£è¡¨çš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>E å‘é‡ï¼šèµ„æºæ€»é‡</li>
<li>A å‘é‡ï¼šèµ„æºå‰©ä½™é‡</li>
<li>C çŸ©é˜µï¼šæ¯ä¸ªè¿›ç¨‹æ‰€æ‹¥æœ‰çš„èµ„æºæ•°é‡ï¼Œæ¯ä¸€è¡Œéƒ½ä»£è¡¨ä¸€ä¸ªè¿›ç¨‹æ‹¥æœ‰èµ„æºçš„æ•°é‡</li>
<li>R çŸ©é˜µï¼šæ¯ä¸ªè¿›ç¨‹è¯·æ±‚çš„èµ„æºæ•°é‡</li>
</ul>
<p>è¿›ç¨‹ P<sub>1</sub> å’Œ P<sub>2</sub> æ‰€è¯·æ±‚çš„èµ„æºéƒ½å¾—ä¸åˆ°æ»¡è¶³ï¼Œåªæœ‰è¿›ç¨‹ P<sub>3</sub> å¯ä»¥ï¼Œè®© P<sub>3</sub> æ‰§è¡Œï¼Œä¹‹åé‡Šæ”¾ P<sub>3</sub> æ‹¥æœ‰çš„èµ„æºï¼Œæ­¤æ—¶ A = (2 2 2 0)ã€‚P<sub>2</sub> å¯ä»¥æ‰§è¡Œï¼Œæ‰§è¡Œåé‡Šæ”¾ P<sub>2</sub> æ‹¥æœ‰çš„èµ„æºï¼ŒA = (4 2 2 1) ã€‚P<sub>1</sub> ä¹Ÿå¯ä»¥æ‰§è¡Œã€‚æ‰€æœ‰è¿›ç¨‹éƒ½å¯ä»¥é¡ºåˆ©æ‰§è¡Œï¼Œæ²¡æœ‰æ­»é”ã€‚</p>
<p>ç®—æ³•æ€»ç»“å¦‚ä¸‹ï¼š</p>
<p>æ¯ä¸ªè¿›ç¨‹æœ€å¼€å§‹æ—¶éƒ½ä¸è¢«æ ‡è®°ï¼Œæ‰§è¡Œè¿‡ç¨‹æœ‰å¯èƒ½è¢«æ ‡è®°ã€‚å½“ç®—æ³•ç»“æŸæ—¶ï¼Œä»»ä½•æ²¡æœ‰è¢«æ ‡è®°çš„è¿›ç¨‹éƒ½æ˜¯æ­»é”è¿›ç¨‹ã€‚</p>
<ol>
<li>å¯»æ‰¾ä¸€ä¸ªæ²¡æœ‰æ ‡è®°çš„è¿›ç¨‹ P<sub>i</sub>ï¼Œå®ƒæ‰€è¯·æ±‚çš„èµ„æºå°äºç­‰äº Aã€‚</li>
<li>å¦‚æœæ‰¾åˆ°äº†è¿™æ ·ä¸€ä¸ªè¿›ç¨‹ï¼Œé‚£ä¹ˆå°† C çŸ©é˜µçš„ç¬¬ i è¡Œå‘é‡åŠ åˆ° A ä¸­ï¼Œæ ‡è®°è¯¥è¿›ç¨‹ï¼Œå¹¶è½¬å› 1ã€‚</li>
<li>å¦‚æœæ²¡æœ‰è¿™æ ·ä¸€ä¸ªè¿›ç¨‹ï¼Œç®—æ³•ç»ˆæ­¢ã€‚</li>
</ol>
<h4 id="æ­»é”æ¢å¤"><a href="#æ­»é”æ¢å¤" class="headerlink" title="æ­»é”æ¢å¤"></a>æ­»é”æ¢å¤</h4><ul>
<li>åˆ©ç”¨æŠ¢å æ¢å¤</li>
<li>åˆ©ç”¨å›æ»šæ¢å¤</li>
<li>é€šè¿‡æ€æ­»è¿›ç¨‹æ¢å¤</li>
</ul>
<h3 id="æ­»é”é¢„é˜²"><a href="#æ­»é”é¢„é˜²" class="headerlink" title="æ­»é”é¢„é˜²"></a>æ­»é”é¢„é˜²</h3><p>åœ¨ç¨‹åºè¿è¡Œä¹‹å‰é¢„é˜²å‘ç”Ÿæ­»é”ã€‚</p>
<ul>
<li>ç ´åäº’æ–¥æ¡ä»¶<br>  ä¾‹å¦‚å‡è„±æœºæ‰“å°æœºæŠ€æœ¯å…è®¸è‹¥å¹²ä¸ªè¿›ç¨‹åŒæ—¶è¾“å‡ºï¼Œå”¯ä¸€çœŸæ­£è¯·æ±‚ç‰©ç†æ‰“å°æœºçš„è¿›ç¨‹æ˜¯æ‰“å°æœºå®ˆæŠ¤è¿›ç¨‹ã€‚</li>
<li>ç ´åå æœ‰å’Œç­‰å¾…æ¡ä»¶<br>  ä¸€ç§å®ç°æ–¹å¼æ˜¯è§„å®šæ‰€æœ‰è¿›ç¨‹åœ¨å¼€å§‹æ‰§è¡Œå‰è¯·æ±‚æ‰€éœ€è¦çš„å…¨éƒ¨èµ„æºã€‚</li>
<li>ç ´åä¸å¯æŠ¢å æ¡ä»¶</li>
<li>ç ´åç¯è·¯ç­‰å¾…<br>  ç»™èµ„æºç»Ÿä¸€ç¼–å·ï¼Œè¿›ç¨‹åªèƒ½æŒ‰ç¼–å·é¡ºåºæ¥è¯·æ±‚èµ„æºã€‚</li>
</ul>
<h3 id="æ­»é”é¿å…"><a href="#æ­»é”é¿å…" class="headerlink" title="æ­»é”é¿å…"></a>æ­»é”é¿å…</h3><p>åœ¨ç¨‹åºè¿è¡Œæ—¶é¿å…å‘ç”Ÿæ­»é”ã€‚é¿å…æ­»é”çš„ä¸»è¦ç®—æ³•æ˜¯åŸºäºä¸€ä¸ªå®‰å…¨çŠ¶æ€çš„æ¦‚å¿µã€‚åœ¨æè¿°ç®—æ³•å‰ï¼Œæˆ‘ä»¬å…ˆè®¨è®ºæœ‰å…³å®‰å…¨çš„æ¦‚å¿µã€‚</p>
<h4 id="å®‰å…¨çŠ¶æ€çš„æ£€æµ‹"><a href="#å®‰å…¨çŠ¶æ€çš„æ£€æµ‹" class="headerlink" title="å®‰å…¨çŠ¶æ€çš„æ£€æµ‹"></a>å®‰å…¨çŠ¶æ€çš„æ£€æµ‹</h4><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/dead_lock/dead_lock4.png" alt></p>
<p>å›¾ a çš„ç¬¬äºŒåˆ— Has è¡¨ç¤ºå·²æ‹¥æœ‰çš„èµ„æºæ•°ï¼Œç¬¬ä¸‰åˆ— Max è¡¨ç¤ºæ€»å…±éœ€è¦çš„èµ„æºæ•°ï¼ŒFree è¡¨ç¤ºè¿˜æœ‰å¯ä»¥ä½¿ç”¨çš„èµ„æºæ•°ã€‚ä»å›¾ a å¼€å§‹å‡ºå‘ï¼Œå…ˆè®© B æ‹¥æœ‰æ‰€éœ€çš„æ‰€æœ‰èµ„æºï¼ˆå›¾ bï¼‰ï¼Œè¿è¡Œç»“æŸåé‡Šæ”¾ Bï¼Œæ­¤æ—¶ Free å˜ä¸º 5ï¼ˆå›¾ cï¼‰ï¼›æ¥ç€ä»¥åŒæ ·çš„æ–¹å¼è¿è¡Œ C å’Œ Aï¼Œä½¿å¾—æ‰€æœ‰è¿›ç¨‹éƒ½èƒ½æˆåŠŸè¿è¡Œï¼Œå› æ­¤å¯ä»¥ç§°å›¾ a æ‰€ç¤ºçš„çŠ¶æ€æ—¶å®‰å…¨çš„ã€‚</p>
<p><strong>å®‰å…¨çŠ¶æ€çš„å®šä¹‰</strong>ï¼šå¦‚æœæ²¡æœ‰æ­»é”å‘ç”Ÿï¼Œå¹¶ä¸”å³ä½¿æ‰€æœ‰è¿›ç¨‹çªç„¶è¯·æ±‚å¯¹èµ„æºçš„æœ€å¤§éœ€æ±‚ï¼Œä¹Ÿä»ç„¶<strong>å­˜åœ¨æŸç§è°ƒåº¦æ¬¡åº</strong>èƒ½å¤Ÿä½¿å¾—æ¯ä¸€ä¸ªè¿›ç¨‹è¿è¡Œå®Œæ¯•ï¼Œåˆ™ç§°è¯¥çŠ¶æ€æ˜¯å®‰å…¨çš„ã€‚</p>
<p>å®‰å…¨çŠ¶æ€çš„æ£€æµ‹ä¸æ­»é”çš„æ£€æµ‹ç±»ä¼¼ï¼Œå› ä¸ºå®‰å…¨çŠ¶æ€å¿…é¡»è¦æ±‚ä¸èƒ½å‘ç”Ÿæ­»é”ã€‚ä¸‹é¢çš„é“¶è¡Œå®¶ç®—æ³•ä¸æ­»é”æ£€æµ‹ç®—æ³•éå¸¸ç±»ä¼¼ï¼Œå¯ä»¥ç»“åˆç€åšå‚è€ƒå¯¹æ¯”ã€‚</p>
<h4 id="å•ä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•"><a href="#å•ä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•" class="headerlink" title="å•ä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•"></a>å•ä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•</h4><p>Dijkstraï¼ˆ1965ï¼‰æå‡ºäº†ä¸€ç§èƒ½å¤Ÿé¿å…æ­»é”çš„è°ƒåº¦ç®—æ³•ï¼Œç§°ä¸ºé“¶è¡Œå®¶ç®—æ³•ï¼ˆbankerâ€™s algorithmï¼‰ï¼Œ<br>ä¸€ä¸ªå°åŸé•‡çš„é“¶è¡Œå®¶ï¼Œä»–å‘ä¸€ç¾¤å®¢æˆ·åˆ†åˆ«æ‰¿è¯ºäº†ä¸€å®šçš„è´·æ¬¾é¢åº¦ï¼Œç®—æ³•è¦åšçš„æ˜¯åˆ¤æ–­å¯¹è¯·æ±‚çš„æ»¡è¶³æ˜¯å¦ä¼šè¿›å…¥ä¸å®‰å…¨çŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œå°±æ‹’ç»è¯·æ±‚ï¼›å¦åˆ™äºˆä»¥åˆ†é…ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/dead_lock/dead_lock5.png" alt></p>
<p>å®¢æˆ·ä»¬å„è‡ªåšè‡ªå·±çš„ç”Ÿæ„ï¼Œåœ¨æŸäº›æ—¶åˆ»éœ€è¦è´·æ¬¾ï¼ˆç›¸å½“äºè¯·æ±‚èµ„æºï¼‰ã€‚åœ¨æŸä¸€æ—¶åˆ»ï¼Œå…·ä½“æƒ…å†µå¦‚å›¾bæ‰€ç¤ºã€‚è¿™ä¸ªçŠ¶æ€æ˜¯å®‰å…¨çš„ï¼Œç”±äºä¿ç•™ç€2ä¸ªå•ä½ï¼Œé“¶è¡Œå®¶èƒ½å¤Ÿæ‹–å»¶é™¤äº†Cä»¥å¤–çš„å…¶ä»–è¯·æ±‚ã€‚å› è€Œå¯ä»¥è®©Cå…ˆå®Œæˆï¼Œç„¶åé‡Šæ”¾Cæ‰€å çš„4ä¸ªå•ä½èµ„æºã€‚æœ‰äº†è¿™4ä¸ªå•ä½èµ„æºï¼Œé“¶è¡Œå®¶å°±å¯ä»¥ç»™Dæˆ–Båˆ†é…æ‰€éœ€çš„è´·æ¬¾å•ä½ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<p>è€ƒè™‘å‡å¦‚å‘Bæä¾›äº†å¦ä¸€ä¸ªä»–æ‰€è¯·æ±‚çš„è´·æ¬¾å•ä½ï¼Œå¦‚å›¾bæ‰€ç¤ºï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æœ‰å¦‚å›¾cæ‰€ç¤ºçš„çŠ¶æ€ï¼Œè¯¥çŠ¶æ€æ˜¯ä¸å®‰å…¨çš„ã€‚å¦‚æœå¿½ç„¶æ‰€æœ‰çš„å®¢æˆ·éƒ½è¯·æ±‚æœ€å¤§çš„é™é¢ï¼Œè€Œé“¶è¡Œå®¶æ— æ³•æ»¡è¶³å…¶ä¸­ä»»ä½•ä¸€ä¸ªçš„è¦æ±‚ï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿæ­»é”ã€‚ä¸å®‰å…¨çŠ¶æ€å¹¶ä¸ä¸€å®šå¼•èµ·æ­»é”ï¼Œç”±äºå®¢æˆ·ä¸ä¸€å®šéœ€è¦å…¶æœ€å¤§è´·æ¬¾é¢åº¦ï¼Œä½†é“¶è¡Œå®¶ä¸æ•¢æŠ±è¿™ç§ä¾¥å¹¸å¿ƒç†ã€‚</p>
<p><strong>é“¶è¡Œå®¶ç®—æ³•å°±æ˜¯å¯¹æ¯ä¸€ä¸ªè¯·æ±‚è¿›è¡Œæ£€æŸ¥ï¼Œæ£€æŸ¥å¦‚æœæ»¡è¶³è¿™ä¸€è¯·æ±‚æ˜¯å¦ä¼šè¾¾åˆ°å®‰å…¨çŠ¶æ€ã€‚è‹¥æ˜¯ï¼Œé‚£ä¹ˆå°±æ»¡è¶³è¯¥è¯·æ±‚ï¼›è‹¥å¦ï¼Œé‚£ä¹ˆå°±æ¨è¿Ÿå¯¹è¿™ä¸€è¯·æ±‚çš„æ»¡è¶³ã€‚</strong>ä¸ºäº†çœ‹çŠ¶æ€æ˜¯å¦å®‰å…¨ï¼Œé“¶è¡Œå®¶çœ‹ä»–æ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æºæ»¡è¶³æŸä¸€ä¸ªå®¢æˆ·ã€‚å¦‚æœå¯ä»¥ï¼Œé‚£ä¹ˆè¿™ç¬”æŠ•èµ„è®¤ä¸ºæ˜¯èƒ½å¤Ÿæ”¶å›çš„ï¼Œå¹¶ä¸”æ¥ç€æ£€æŸ¥æœ€æ¥è¿‘æœ€å¤§é™é¢çš„ä¸€ä¸ªå®¢æˆ·ï¼Œä»¥æ­¤ç±»æ¨ã€‚å¦‚æœæ‰€æœ‰æŠ•èµ„æœ€ç»ˆéƒ½è¢«æ”¶å›ï¼Œé‚£ä¹ˆè¯¥çŠ¶æ€æ˜¯å®‰å…¨çš„ï¼Œæœ€åˆçš„è¯·æ±‚å¯ä»¥æ‰¹å‡†ã€‚</p>
<p>ä¸Šå›¾ c ä¸ºä¸å®‰å…¨çŠ¶æ€ï¼Œå› æ­¤ç®—æ³•ä¼šæ‹’ç»ä¹‹å‰çš„è¯·æ±‚ï¼Œä»è€Œé¿å…è¿›å…¥å›¾ c ä¸­çš„çŠ¶æ€ã€‚</p>
<h4 id="å¤šä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•"><a href="#å¤šä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•" class="headerlink" title="å¤šä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•"></a>å¤šä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•</h4><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/dead_lock/dead_lock6.png" alt></p>
<p>å¯ä»¥æŠŠé“¶è¡Œå®¶ç®—æ³•è¿›è¡Œæ¨å¹¿ä»¥å¤„ç†å¤šä¸ªèµ„æº  </p>
<p>ä¸Šå›¾ä¸­æœ‰äº”ä¸ªè¿›ç¨‹ï¼Œå››ä¸ªèµ„æºã€‚å·¦è¾¹çš„å›¾è¡¨ç¤ºå·²ç»åˆ†é…çš„èµ„æºï¼Œå³è¾¹çš„å›¾è¡¨ç¤ºè¿˜éœ€è¦åˆ†é…çš„èµ„æºã€‚æœ€å³è¾¹çš„ Eã€P ä»¥åŠ A åˆ†åˆ«è¡¨ç¤ºï¼šæ€»èµ„æºã€å·²åˆ†é…èµ„æºä»¥åŠå¯ç”¨èµ„æºï¼Œæ³¨æ„è¿™ä¸‰ä¸ªä¸ºå‘é‡ï¼Œè€Œä¸æ˜¯å…·ä½“æ•°å€¼ï¼Œä¾‹å¦‚ A=(1020)ï¼Œè¡¨ç¤º 4 ä¸ªèµ„æºåˆ†åˆ«è¿˜å‰©ä¸‹ 1/0/2/0ã€‚</p>
<p>æ£€æŸ¥ä¸€ä¸ªçŠ¶æ€æ˜¯å¦å®‰å…¨çš„ç®—æ³•å¦‚ä¸‹ï¼š</p>
<ul>
<li>æŸ¥æ‰¾å³è¾¹çš„çŸ©é˜µæ˜¯å¦å­˜åœ¨ä¸€è¡Œå°äºç­‰äºå‘é‡ Aã€‚å¦‚æœä¸å­˜åœ¨è¿™æ ·çš„è¡Œï¼Œé‚£ä¹ˆç³»ç»Ÿå°†ä¼šå‘ç”Ÿæ­»é”ï¼ŒçŠ¶æ€æ˜¯ä¸å®‰å…¨çš„ã€‚</li>
<li>å‡è‹¥æ‰¾åˆ°è¿™æ ·ä¸€è¡Œï¼Œå°†è¯¥è¿›ç¨‹æ ‡è®°ä¸ºç»ˆæ­¢ï¼Œå¹¶å°†å…¶å·²åˆ†é…èµ„æºåŠ åˆ° A ä¸­ã€‚</li>
<li>é‡å¤ä»¥ä¸Šä¸¤æ­¥ï¼Œç›´åˆ°æ‰€æœ‰è¿›ç¨‹éƒ½æ ‡è®°ä¸ºç»ˆæ­¢ï¼Œåˆ™çŠ¶æ€æ—¶å®‰å…¨çš„ã€‚</li>
</ul>
<p>å¦‚æœä¸€ä¸ªçŠ¶æ€ä¸æ˜¯å®‰å…¨çš„ï¼Œéœ€è¦æ‹’ç»è¿›å…¥è¿™ä¸ªçŠ¶æ€ã€‚</p>
<h2 id="linuxè¿›ç¨‹è°ƒåº¦"><a href="#linuxè¿›ç¨‹è°ƒåº¦" class="headerlink" title="linuxè¿›ç¨‹è°ƒåº¦"></a>linuxè¿›ç¨‹è°ƒåº¦</h2><p>å‚è€ƒ <a href="https://juejin.im/post/6844903568613310477" target="_blank" rel="noopener">https://juejin.im/post/6844903568613310477</a></p>
<p>åœ¨Linuxä¸­ï¼Œçº¿ç¨‹å’Œè¿›ç¨‹ä¸€è§†åŒä»ï¼Œæ‰€ä»¥è®²åˆ°è¿›ç¨‹è°ƒåº¦ï¼Œä¹ŸåŒ…å«äº†çº¿ç¨‹è°ƒåº¦ã€‚</p>
<p>è°ƒåº¦åˆ†ä¸¤ç§:  </p>
<ul>
<li>éæŠ¢å å¼å¤šä»»åŠ¡<br>  é™¤éä»»åŠ¡è‡ªå·±ç»“æŸï¼Œå¦åˆ™å°†ä¼šä¸€ç›´æ‰§è¡Œã€‚</li>
<li><strong>æŠ¢å å¼å¤šä»»åŠ¡ï¼ˆLinuxç”¨çš„æ˜¯è¿™ç§)</strong><br>  è¿™ç§æƒ…å†µä¸‹ï¼Œç”±è°ƒåº¦ç¨‹åºæ¥å†³å®šä»€ä¹ˆæ—¶å€™åœæ­¢ä¸€ä¸ªè¿›ç¨‹çš„è¿è¡Œï¼Œè¿™ä¸ªå¼ºåˆ¶çš„æŒ‚èµ·åŠ¨ä½œå³ä¸º<strong>æŠ¢å </strong>ã€‚é‡‡ç”¨æŠ¢å å¼å¤šä»»åŠ¡çš„åŸºç¡€æ˜¯ä½¿ç”¨æ—¶é—´ç‰‡è½®è½¬æœºåˆ¶æ¥ä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…å¯ä»¥è¿è¡Œçš„æ—¶é—´å•ä½ã€‚</li>
</ul>
<p>Linuxæœ‰ä¸¤ç§ä¸åŒçš„è¿›ç¨‹ä¼˜å…ˆçº§èŒƒå›´:</p>
<ul>
<li>ä½¿ç”¨niceå€¼ï¼šè¶Šå¤§çš„niceå€¼æ„å‘³ç€æ›´ä½çš„ä¼˜å…ˆçº§ã€‚ (-19 ~ 20ä¹‹é—´)</li>
<li>å®æ—¶ä¼˜å…ˆçº§ï¼šå¯é…ç½®(é€šè¿‡å®æ—¶è°ƒåº¦API)ï¼Œè¶Šé«˜æ„å‘³ç€è¿›ç¨‹ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
</ul>
<p>ä»»ä½•å®æ—¶çš„è¿›ç¨‹ä¼˜å…ˆçº§éƒ½é«˜äºæ™®é€šçš„è¿›ç¨‹ï¼Œå› æ­¤ä¸Šé¢çš„ä¸¤ç§ä¼˜å…ˆçº§èŒƒå›´å¤„äºäº’ä¸ç›¸äº¤çš„èŒƒç•´ã€‚</p>
<p>æ—¶é—´ç‰‡ï¼šLinuxä¸­å¹¶ä¸æ˜¯ä»¥å›ºå®šçš„æ—¶é—´å€¼(å¦‚10ms)æ¥åˆ†é…æ—¶é—´ç‰‡çš„ï¼Œè€Œæ˜¯å°†å¤„ç†å™¨çš„ä½¿ç”¨æ¯”ä½œä¸ºâ€œæ—¶é—´ç‰‡â€åˆ’åˆ†ç»™è¿›ç¨‹ã€‚è¿™æ ·ï¼Œè¿›ç¨‹æ‰€è·å¾—çš„å®é™…CPUæ—¶é—´å°±å’Œç³»ç»Ÿçš„è´Ÿè½½å¯†åˆ‡ç›¸å…³ã€‚</p>
<p>Linuxå†…æ ¸æœ‰ä¸¤ä¸ªè°ƒåº¦ç±»ï¼š</p>
<ul>
<li>CFS(å®Œå…¨å…¬å¹³è°ƒåº¦å™¨Completely Fair Scheduler)</li>
<li>å®æ—¶è°ƒåº¦ç±»ã€‚</li>
</ul>
<h3 id="å…¬å¹³è°ƒåº¦CFS"><a href="#å…¬å¹³è°ƒåº¦CFS" class="headerlink" title="å…¬å¹³è°ƒåº¦CFS"></a>å…¬å¹³è°ƒåº¦CFS</h3><p>ä¸¾ä¸ªä¾‹å­æ¥åŒºåˆ†Unixè°ƒåº¦å’ŒCFS, æœ‰ä¸¤ä¸ªè¿è¡Œçš„ä¼˜å…ˆçº§ç›¸åŒçš„è¿›ç¨‹:</p>
<ul>
<li>åœ¨Unixä¸­å¯èƒ½æ˜¯æ¯ä¸ªå„æ‰§è¡Œ5msï¼Œæ‰§è¡ŒæœŸé—´å®Œå…¨å ç”¨å¤„ç†å™¨ï¼Œä½†åœ¨â€œç†æƒ³æƒ…å†µâ€ä¸‹ï¼Œåº”è¯¥æ˜¯ï¼Œèƒ½å¤Ÿåœ¨10mså†…åŒæ—¶è¿è¡Œä¸¤ä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªå ç”¨å¤„ç†å™¨ä¸€åŠçš„èƒ½åŠ›ã€‚</li>
<li>CFSçš„åšæ³•æ˜¯ï¼šCFS è°ƒåº¦ç¨‹åºå¹¶ä¸é‡‡ç”¨ä¸¥æ ¼è§„åˆ™æ¥ä¸ºä¸€ä¸ªä¼˜å…ˆçº§åˆ†é…æŸä¸ªé•¿åº¦çš„æ—¶é—´ç‰‡, åœ¨æ‰€æœ‰å¯è¿è¡Œè¿›ç¨‹çš„æ€»æ•°ä¸Šè®¡ç®—å‡ºä¸€ä¸ªè¿›ç¨‹åº”è¯¥è¿è¡Œçš„æ—¶é—´ï¼Œniceå€¼ä¸å†ä½œä¸ºæ—¶é—´ç‰‡åˆ†é…çš„æ ‡å‡†ï¼Œè€Œæ˜¯ç”¨äºå¤„ç†è®¡ç®—è·å¾—çš„å¤„ç†å™¨ä½¿ç”¨æƒé‡ã€‚</li>
</ul>
<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬çš„ç³»ç»Ÿåªæœ‰ä¸¤ä¸ªè¿›ç¨‹åœ¨è¿è¡Œï¼Œä¸€ä¸ªæ˜¯æ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆI/Oæ¶ˆè€—å‹ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯è§†é¢‘è§£ç å™¨ï¼ˆå¤„ç†å™¨æ¶ˆè€—å‹ï¼‰ã€‚<br>ç†æƒ³çš„æƒ…å†µä¸‹ï¼Œæ–‡æœ¬ç¼–è¾‘å™¨åº”è¯¥å¾—åˆ°æ›´å¤šçš„å¤„ç†å™¨æ—¶é—´ï¼Œè‡³å°‘å½“å®ƒéœ€è¦å¤„ç†å™¨æ—¶ï¼Œå¤„ç†å™¨åº”è¯¥ç«‹åˆ»è¢«åˆ†é…ç»™å®ƒï¼ˆè¿™æ ·æ‰èƒ½å®Œæˆç”¨æˆ·çš„äº¤äº’ï¼‰ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€å½“æ–‡æœ¬ç¼–è¾‘å™¨è¢«å”¤é†’çš„æ—¶å€™ï¼Œå®ƒåº”è¯¥æŠ¢å è§†é¢‘è§£ç ç¨‹åºã€‚<br>æŒ‰ç…§æ™®é€šçš„æƒ…å†µï¼ŒOSåº”è¯¥åˆ†é…ç»™æ–‡æœ¬ç¼–è¾‘å™¨æ›´å¤§çš„ä¼˜å…ˆçº§å’Œæ›´å¤šçš„æ—¶é—´ç‰‡ï¼Œä½†åœ¨Linuxä¸­ï¼Œè¿™ä¸¤ä¸ªè¿›ç¨‹éƒ½æ˜¯æ™®é€šè¿›ç¨‹ï¼Œä»–ä»¬å…·æœ‰ç›¸åŒçš„niceå€¼ï¼Œå› æ­¤å®ƒä»¬å°†å¾—åˆ°ç›¸åŒçš„å¤„ç†å™¨ä½¿ç”¨æ¯”ï¼ˆ50%ï¼‰ã€‚<br>ä½†å®é™…çš„è¿è¡Œè¿‡ç¨‹ä¸­ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼ŸCFSå°†èƒ½å¤Ÿæ³¨æ„åˆ°ï¼Œæ–‡æœ¬ç¼–è¾‘å™¨ä½¿ç”¨çš„å¤„ç†å™¨æ—¶é—´æ¯”åˆ†é…ç»™å®ƒçš„è¦å°‘å¾—å¤šï¼ˆå› ä¸ºå¤§å¤šæ—¶é—´åœ¨ç­‰å¾…I/Oï¼‰ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œè¦å®ç°æ‰€æœ‰è¿›ç¨‹â€œå…¬å¹³â€åœ°åˆ†äº«å¤„ç†å™¨ï¼Œå°±ä¼šè®©æ–‡æœ¬ç¼–è¾‘å™¨åœ¨éœ€è¦è¿è¡Œæ—¶ç«‹åˆ»æŠ¢å è§†é¢‘è§£ç å™¨ï¼ˆæ¯æ¬¡éƒ½æ˜¯å¦‚æ­¤ï¼‰ã€‚</p>
<h3 id="å®æ—¶è°ƒåº¦"><a href="#å®æ—¶è°ƒåº¦" class="headerlink" title="å®æ—¶è°ƒåº¦"></a>å®æ—¶è°ƒåº¦</h3><p>Linuxè¿˜å®ç°äº† POS1Xå®æ—¶è°ƒåº¦æ‰©å±•ã€‚è¿™äº›æ‰©å±•å…è®¸åº”ç”¨ç¨‹åºç²¾ç¡®åœ°æ§åˆ¶å¦‚ä½•åˆ†é…CPU<br>ç»™è¿›ç¨‹ã€‚è¿ä½œåœ¨ä¸¤ä¸ªå®æ—¶è°ƒåº¦ç­–ç•¥</p>
<ul>
<li>SCHED RR ï¼ˆå¾ªç¯ï¼‰</li>
<li>SCHED FIFO ï¼ˆå…ˆå…¥å…ˆå‡ºï¼‰</li>
</ul>
<p>ä¸‹çš„è¿›ç¨‹çš„ä¼˜å…ˆçº§æ€»æ˜¯é«˜äºè¿ä½œåœ¨éå®æ—¶ç­–ç•¥ä¸‹çš„è¿›ç¨‹ã€‚å®æ—¶è¿›ç¨‹ä¼˜å…ˆçº§çš„å–å€¼èŒƒå›´ä¸º1 ï¼ˆä½ï¼‰ã€œ99<br>ï¼ˆé«˜ï¼‰ã€‚åªæœ‰è¿›ç¨‹å¤„äºå¯è¿è¡ŒçŠ¶æ€ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§æ›´é«˜çš„è¿›ç¨‹å°±ä¼šå®Œå…¨å°†ä¼˜å…ˆçº§ä½çš„è¿›ç¨‹æ’é™¤åœ¨<br>CPUä¹‹å¤–ã€‚</p>
<ul>
<li>è¿ä½œåœ¨SCHED_FIFOç­–ç•¥ä¸‹çš„è¿›ç¨‹ä¼šäº’æ–¥åœ°è®¿é—®CPUç›´åˆ°å®ƒæ‰§è¡Œç»ˆæ­¢æˆ–è‡ªåŠ¨é‡Šæ”¾CPUæˆ–è¢«è¿›å…¥å¯è¿è¡ŒçŠ¶æ€çš„ä¼˜å…ˆçº§æ›´é«˜çš„è¿›ç¨‹æŠ¢å ã€‚</li>
<li>ç±»ä¼¼çš„è§„åˆ™åŒæ ·é€‚ç”¨äºSCHED RRç­–ç•¥, ä½†åœ¨è¯¥ç­–ç•¥ä¸‹ï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªè¿›ç¨‹è¿è¡ŒäºåŒæ ·çš„ä¼˜å…ˆçº§ä¸‹ï¼Œé‚£ä¹ˆCPUå°±ä¼šä»¥å¾ªç¯çš„æ–¹å¼è¢«è¿™<br>äº›è¿›ç¨‹å…±äº«ã€‚</li>
</ul>
<p>å®æ—¶è°ƒåº¦é‡‡ç”¨ SCHED_FIFO æˆ– SCHED_RR å®æ—¶ç­–ç•¥æ¥è°ƒåº¦çš„ä»»ä½•ä»»åŠ¡ï¼Œä¸æ™®é€šï¼ˆéå®æ—¶çš„ï¼‰ä»»åŠ¡ç›¸æ¯”ï¼Œå…·æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚</p>
<p>Linux é‡‡ç”¨ä¸¤ä¸ªå•ç‹¬çš„ä¼˜å…ˆçº§èŒƒå›´ï¼Œä¸€ä¸ªç”¨äºå®æ—¶ä»»åŠ¡ï¼Œå¦ä¸€ä¸ªç”¨äºæ­£å¸¸ä»»åŠ¡ã€‚å®æ—¶ä»»åŠ¡åˆ†é…çš„é™æ€ä¼˜å…ˆçº§ä¸º 0ã€œ99ï¼Œè€Œæ­£å¸¸ä»»åŠ¡åˆ†é…çš„ä¼˜å…ˆçº§ä¸º 100ã€œ139ã€‚</p>
<p>è¿™ä¸¤ä¸ªå€¼åŸŸåˆå¹¶æˆä¸ºä¸€ä¸ªå…¨å±€çš„ä¼˜å…ˆçº§æ–¹æ¡ˆï¼Œå…¶ä¸­è¾ƒä½æ•°å€¼è¡¨æ˜è¾ƒé«˜çš„ä¼˜å…ˆçº§ã€‚æ­£å¸¸ä»»åŠ¡ï¼Œæ ¹æ®å®ƒä»¬çš„niceå€¼ï¼Œåˆ†é…ä¸€ä¸ªä¼˜å…ˆçº§ï¼›è¿™é‡Œ -20 çš„niceå€¼æ˜ å°„åˆ°ä¼˜å…ˆçº§ 100ï¼Œè€Œ +19 çš„niceå€¼æ˜ å°„åˆ° 139ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†è¿™ä¸ªæ–¹æ¡ˆã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/process_scheduler.jpg" alt></p>
<h2 id="linuxè½»é‡çº§è¿›ç¨‹LWP"><a href="#linuxè½»é‡çº§è¿›ç¨‹LWP" class="headerlink" title="linuxè½»é‡çº§è¿›ç¨‹LWP"></a>linuxè½»é‡çº§è¿›ç¨‹LWP</h2><p>å¯¹äºLinuxæ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œå®ƒå¯¹Threadçš„å®ç°æ–¹å¼æ¯”è¾ƒç‰¹æ®Šã€‚åœ¨Linuxå†…æ ¸ä¸­ï¼Œå…¶å®æ˜¯æ²¡æœ‰çº¿ç¨‹çš„æ¦‚å¿µçš„ï¼Œå®ƒæŠŠæ‰€æœ‰çš„çº¿ç¨‹å½“åšæ ‡å‡†çš„è¿›ç¨‹æ¥å®ç°ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>Linuxå†…æ ¸ï¼Œå¹¶æ²¡æœ‰ä¸ºçº¿ç¨‹æä¾›ä»»ä½•ç‰¹æ®Šçš„è°ƒåº¦è¯­ä¹‰ï¼Œä¹Ÿæ²¡æœ‰ä¸ºçº¿ç¨‹å®ç°ç‰¹å®šçš„æ•°æ®ç»“æ„ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œçº¿ç¨‹åªæ˜¯ä¸€ä¸ªä¸å…¶ä»–è¿›ç¨‹å…±äº«æŸäº›èµ„æºçš„è¿›ç¨‹ã€‚</strong>æ¯ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰ä¸€ä¸ªå”¯ä¸€çš„task_structç»“æ„ï¼ŒLinuxå†…æ ¸å®ƒä»…ä»…æŠŠçº¿ç¨‹å½“åšä¸€ä¸ªæ­£å¸¸çš„è¿›ç¨‹ï¼Œæˆ–è€…è¯´æ˜¯è½»é‡çº§è¿›ç¨‹ï¼ŒLWP(Lightweight processes)ã€‚</p>
<p>Linuxçº¿ç¨‹ä¸è¿›ç¨‹çš„åŒºåˆ«ï¼Œä¸»è¦ä½“ç°åœ¨èµ„æºå…±äº«ã€è°ƒåº¦ã€æ€§èƒ½å‡ ä¸ªæ–¹é¢ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹èµ„æºå…±äº«æ–¹é¢ã€‚ä¸Šé¢ä¹Ÿæåˆ°ï¼Œçº¿ç¨‹å…¶å®æ˜¯å…±äº«äº†æŸä¸€ä¸ªè¿›ç¨‹çš„èµ„æºï¼Œè¿™äº›èµ„æºåŒ…æ‹¬ï¼š</p>
<ul>
<li>å†…å­˜åœ°å€ç©ºé—´</li>
<li>è¿›ç¨‹åŸºç¡€ä¿¡æ¯</li>
<li>å¤§éƒ¨åˆ†æ•°æ®</li>
<li>æ‰“å¼€çš„æ–‡ä»¶</li>
<li>ä¿¡å·å¤„ç†</li>
<li>å½“å‰å·¥ä½œç›®å½•</li>
<li>ç”¨æˆ·å’Œç”¨æˆ·ç»„å±æ€§</li>
<li>â€¦</li>
</ul>
<p>å“ªäº›æ˜¯çº¿ç¨‹ç‹¬è‡ªæ‹¥æœ‰çš„å‘¢ï¼Ÿ</p>
<ul>
<li>çº¿ç¨‹ID</li>
<li>ä¸€ç³»åˆ—çš„å¯„å­˜å™¨</li>
<li>æ ˆçš„å±€éƒ¨å˜é‡å’Œè¿”å›åœ°å€</li>
<li>é”™è¯¯ç  errno</li>
<li>ä¿¡å·æ©ç </li>
<li>ä¼˜å…ˆçº§</li>
<li>â€¦</li>
</ul>
<p>è¿™é‡Œè¯´ä¸€ä¸ªé»‘ç§‘æŠ€ï¼Œçº¿ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„è°ƒç”¨æ ˆï¼Œé™¤äº†æ ˆä¹‹å¤–å…±äº«äº†å…¶ä»–æ‰€æœ‰çš„æ®µsegmentã€‚ä½†æ˜¯ç”±äºçº¿ç¨‹é—´å…±äº«äº†å†…å­˜ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªçº¿ç¨‹ï¼Œç†è®ºä¸Šæ˜¯å¯ä»¥è®¿é—®åˆ°å…¶ä»–çº¿ç¨‹çš„è°ƒç”¨æ ˆçš„ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªæŒ‡é’ˆå˜é‡ï¼Œå»è®¿é—®å…¶ä»–çº¿ç¨‹çš„å±€éƒ¨æ ˆå¸§ï¼Œä»¥è®¿é—®å…¶ä»–çº¿ç¨‹çš„å±€éƒ¨å˜é‡ã€‚</p>
<h3 id="LWPå¦‚ä½•åˆ›å»ºå‡ºæ¥"><a href="#LWPå¦‚ä½•åˆ›å»ºå‡ºæ¥" class="headerlink" title="LWPå¦‚ä½•åˆ›å»ºå‡ºæ¥"></a>LWPå¦‚ä½•åˆ›å»ºå‡ºæ¥</h3><p>é‚£ä¹ˆLinuxä¸­çº¿ç¨‹æ˜¯å¦‚ä½•åˆ›å»ºå‡ºæ¥çš„å‘¢ï¼Ÿä¸Šé¢ä¹Ÿæåˆ°ï¼Œåœ¨Linuxä¸­çº¿ç¨‹æ˜¯ä¸€ç§èµ„æºå…±äº«çš„æ–¹å¼ï¼Œå¯ä»¥åœ¨åˆ›å»ºè¿›ç¨‹çš„æ—¶å€™ï¼ŒæŒ‡å®šæŸäº›èµ„æºæ˜¯ä»å…¶ä»–è¿›ç¨‹å…±äº«çš„ï¼Œä»è€Œåœ¨æ¦‚å¿µä¸Šåˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ã€‚åœ¨Linuxä¸­ï¼Œå¯ä»¥é€šè¿‡cloneç³»ç»Ÿè°ƒç”¨æ¥åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ï¼Œå®ƒçš„å‡½æ•°ç­¾åå¦‚ä¸‹ï¼š<br><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line">int clone(int (*fn)(void *), void *child_stack, int flags, void *arg, ...);</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬åœ¨ä½¿ç”¨cloneåˆ›å»ºè¿›ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥æŒ‡æ˜ç›¸åº”çš„å‚æ•°ï¼Œæ¥å†³å®šå…±äº«æŸäº›èµ„æºï¼Œæ¯”å¦‚:<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">clone(CLONE_VM | CLONE_FS | CLONE_FILES | CLONE_SIGHAND, <span class="number">0</span>);</span><br></pre></td></tr></table></figure></p>
<p><strong>è¿™ä¸ªcloneç³»ç»Ÿè°ƒç”¨çš„è¡Œä¸ºç±»ä¼¼äºforkï¼Œä¸è¿‡æ–°åˆ›å»ºå‡ºæ¥çš„è¿›ç¨‹ï¼Œå®ƒçš„å†…å­˜åœ°å€ã€æ–‡ä»¶ç³»ç»Ÿèµ„æºã€æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦å’Œä¿¡å·å¤„ç†å™¨ï¼Œéƒ½æ˜¯å…±äº«çˆ¶è¿›ç¨‹çš„ã€‚æ¢å¥è¯è¯´ï¼Œè¿™ä¸ªæ–°åˆ›å»ºå‡ºæ¥çš„è¿›ç¨‹ï¼Œä¹Ÿè¢«å«åšLinux Thread</strong>ã€‚ä»è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¹Ÿå¯ä»¥çœ‹å‡º<strong>Linuxä¸­ï¼Œçº¿ç¨‹å…¶å®æ˜¯è¿›ç¨‹å®ç°èµ„æºå…±äº«çš„ä¸€ç§æ–¹å¼ã€‚</strong></p>
<p>åœ¨å†…æ ¸ä¸­ï¼Œcloneè°ƒç”¨ç»è¿‡å‚æ•°ä¼ é€’å’Œè§£é‡Šåä¼šè°ƒç”¨do_forkï¼Œè¿™ä¸ªæ ¸å†…å‡½æ•°åŒæ—¶ä¹Ÿæ˜¯forkã€vforkç³»ç»Ÿè°ƒç”¨çš„æœ€ç»ˆå®ç°ï¼š<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_fork</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> clone_flags, <span class="keyword">unsigned</span> <span class="keyword">long</span> stack_start, struct pt_regs* regs,<span class="keyword">unsigned</span> <span class="keyword">long</span> stack_size)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨do_forkä¸­ï¼Œä¸åŒçš„clone_flagså°†å¯¼è‡´ä¸åŒçš„è¡Œä¸ºï¼ˆå…±äº«ä¸åŒçš„èµ„æºï¼‰ï¼Œä¸‹é¢åˆ—ä¸¾å‡ ä¸ªflagçš„ä½œç”¨ã€‚ </p>
<ul>
<li>CLONE_VM<br>  å¦‚æœdo_forkæ—¶æŒ‡å®šäº†CLONE_VMå¼€å…³ï¼Œåˆ›å»ºçš„è½»é‡çº§è¿›ç¨‹çš„å†…å­˜ç©ºé—´å°†ä¼šå’Œçˆ¶è¿›ç¨‹æŒ‡å‘åŒä¸€ä¸ªåœ°å€ï¼Œå³åˆ›å»ºçš„è½»é‡çº§è¿›ç¨‹å°†ä¸çˆ¶è¿›ç¨‹å…±äº«å†…å­˜åœ°å€ç©ºé—´ã€‚</li>
<li>CLONE_FS<br>  å¦‚æœdo_forkæ—¶æŒ‡å®šäº†CLONE_FSå¼€å…³ï¼Œå¯¹äºè½»é‡çº§è¿›ç¨‹åˆ™ä¼šä¸çˆ¶è¿›ç¨‹å…±äº«ç›¸åŒçš„æ‰€åœ¨æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ç›®å½•å’Œå½“å‰ç›®å½•ä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè½»é‡çº§è¿›ç¨‹æ²¡æœ‰ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„ä¿¡æ¯ï¼Œè¿›ç¨‹ä¸­ä»»ä½•ä¸€ä¸ªçº¿ç¨‹æ”¹å˜å½“å‰ç›®å½•ã€æ ¹ç›®å½•ç­‰ä¿¡æ¯éƒ½å°†ç›´æ¥å½±å“åˆ°å…¶ä»–çº¿ç¨‹ã€‚</li>
<li>CLONE_FILES<br>  å¦‚æœdo_forkæ—¶æŒ‡å®šäº†CLONE_FILESå¼€å…³ï¼Œåˆ›å»ºçš„è½»é‡çº§è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å°†ä¼šå…±äº«å·²ç»æ‰“å¼€çš„æ–‡ä»¶ã€‚è¿™ä¸€å…±äº«ä½¿å¾—ä»»ä½•çº¿ç¨‹éƒ½èƒ½è®¿é—®è¿›ç¨‹æ‰€ç»´æŠ¤çš„æ‰“å¼€æ–‡ä»¶ï¼Œå¯¹å®ƒä»¬çš„æ“ä½œä¼šç›´æ¥åæ˜ åˆ°è¿›ç¨‹ä¸­çš„å…¶ä»–çº¿ç¨‹ã€‚</li>
<li>CLONE_SIGHAND<br>  å¦‚æœdo_forkæ—¶æŒ‡å®šäº†CLONE_FILESå¼€å…³ï¼Œè½»é‡çº§è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å°†ä¼šå…±äº«å¯¹ä¿¡å·çš„å¤„ç†æ–¹å¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹çš„ä¿¡å·å¤„ç†æ–¹å¼å®Œå…¨ç›¸åŒï¼Œè€Œä¸”å¯ä»¥ç›¸äº’æ›´æ”¹ã€‚</li>
</ul>
<p>å°½ç®¡linuxæ”¯æŒè½»é‡çº§è¿›ç¨‹ï¼Œä½†å¹¶ä¸èƒ½è¯´å®ƒå°±æ”¯æŒå†…æ ¸çº¿ç¨‹ï¼Œå› ä¸ºlinuxçš„â€çº¿ç¨‹â€å’Œâ€è¿›ç¨‹â€å®é™…ä¸Šå¤„äºä¸€ä¸ªè°ƒåº¦å±‚æ¬¡ï¼Œå…±äº«ä¸€ä¸ªè¿›ç¨‹æ ‡è¯†ç¬¦ç©ºé—´ï¼Œè¿™ç§é™åˆ¶ä½¿å¾—ä¸å¯èƒ½åœ¨linuxä¸Šå®ç°å®Œå…¨æ„ä¹‰ä¸Šçš„POSIXçº¿ç¨‹æœºåˆ¶ï¼Œå› æ­¤ä¼—å¤šçš„linuxçº¿ç¨‹åº“å®ç°å°è¯•éƒ½åªèƒ½å°½å¯èƒ½å®ç°POSIXçš„ç»å¤§éƒ¨åˆ†è¯­ä¹‰ï¼Œå¹¶åœ¨åŠŸèƒ½ä¸Šå°½å¯èƒ½é€¼è¿‘ã€‚</p>
<h2 id="å¤šæ ¸CPUæ˜¯å¦èƒ½åŒæ—¶æ‰§è¡Œå¤šä¸ªè¿›ç¨‹ï¼Ÿ"><a href="#å¤šæ ¸CPUæ˜¯å¦èƒ½åŒæ—¶æ‰§è¡Œå¤šä¸ªè¿›ç¨‹ï¼Ÿ" class="headerlink" title="å¤šæ ¸CPUæ˜¯å¦èƒ½åŒæ—¶æ‰§è¡Œå¤šä¸ªè¿›ç¨‹ï¼Ÿ"></a>å¤šæ ¸CPUæ˜¯å¦èƒ½åŒæ—¶æ‰§è¡Œå¤šä¸ªè¿›ç¨‹ï¼Ÿ</h2><p>å¤šæ ¸çš„ä½œç”¨å°±æ˜¯æ¯ä¸ªCPUå¯ä»¥è°ƒåº¦ä¸åŒçš„ä»»åŠ¡â€œå¹¶è¡Œâ€æ‰§è¡Œã€‚æ³¨æ„ï¼Œè¿™é‡Œè¯´çš„æ˜¯â€œå¹¶è¡Œâ€ï¼Œè€Œä¸æ˜¯â€œå¹¶å‘â€ï¼Œæ‰€ä»¥é—®é¢˜çš„å›ç­”æ˜¯â€œèƒ½â€ã€‚</p>
<p>ç¬¬äºŒä¸ªé—®é¢˜ï¼Œâ€œåŒæ—¶æœ€å¤šæ‰§è¡Œå‡ ä¸ªè¿›ç¨‹â€œ?<br>è¿™é‡Œä½ æƒ³æè¿°çš„â€œåŒæ—¶â€çš„æ„æ€ï¼Œæ˜¯æŸä¸€ä¸ªç‰¹å®šæ—¶åˆ»å—ï¼Ÿå¦‚æœæ˜¯ï¼Œå¾ˆæ˜æ˜¾ï¼Œåœ¨æŸä¸€ç‰¹å®šæ—¶åˆ»ï¼Œæ¯ä¸ªæ ¸åªèƒ½è°ƒåº¦ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œï¼Œæ‰€ä»¥æœ‰å¤šå°‘ä¸ªæ ¸æœ€å¤šå°±å¯ä»¥è°ƒåº¦å¤šå°‘ä¸ªè¿›ç¨‹ï¼ˆæˆ–è€…è¯´æˆçº¿ç¨‹æ¯”è¾ƒå‡†ç¡®äº›ï¼‰ã€‚ä½†åœ¨ä¸€æ®µæ—¶é—´ä¹‹å†…ï¼Œæ¯ä¸ªæ ¸å¯ä»¥â€œå¹¶å‘â€è°ƒåº¦å¤šä¸ªä»»åŠ¡æ‰§è¡Œã€‚å¦‚ä½•â€œå¹¶å‘â€ï¼Œè¿™å°±æ˜¯ç”±ä¸åŒæ“ä½œç³»ç»Ÿçš„è¿›ç¨‹è°ƒåº¦ç­–ç•¥è§„å®šçš„äº†ï¼Œæ¯”å¦‚å¸¸è§Linuxçš„CFSè°ƒåº¦ç®—æ³•å’ŒWindowsçš„æŠ¢å å¼è°ƒåº¦ç®—æ³•ã€‚</p>
<h2 id="åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹çš„æ­¥éª¤"><a href="#åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹çš„æ­¥éª¤" class="headerlink" title="åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹çš„æ­¥éª¤"></a>åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹çš„æ­¥éª¤</h2><p>(ä¸¤forkä¸€set, uå·¥æ–‡dev)<br>æœ€å…³é”®çš„ä¸‰æ­¥éª¤:</p>
<ol>
<li><p>è°ƒç”¨forkï¼Œç„¶åä½¿çˆ¶è¿›ç¨‹exitã€‚<br>è™½ç„¶å­è¿›ç¨‹ç»§æ‰¿äº†çˆ¶è¿›ç¨‹çš„è¿›ç¨‹ç»„IDï¼Œä½†è·å¾—äº†ä¸€ä¸ªæ–°çš„è¿›ç¨‹IDï¼Œè¿™å°±ä¿è¯äº†å­è¿›ç¨‹ä¸æ˜¯ä¸€ä¸ªè¿›ç¨‹ç»„çš„ç»„é•¿è¿›ç¨‹ã€‚è¿™æ˜¯ä¸‹é¢å°†è¦è¿›è¡Œçš„setsidè°ƒç”¨çš„å…ˆå†³æ¡ä»¶ã€‚</p>
</li>
<li><p>è°ƒç”¨setsidåˆ›å»ºä¸€ä¸ªæ–°ä¼šè¯ã€‚<br>ä½¿è°ƒç”¨è¿›ç¨‹ï¼š(a)æˆä¸ºæ–°ä¼šè¯çš„é¦–è¿›ç¨‹ï¼Œ(b)æˆä¸ºä¸€ä¸ªæ–°è¿›ç¨‹ç»„çš„ç»„é•¿è¿›ç¨‹ï¼(c)æ²¡æœ‰æ§åˆ¶ç»ˆç«¯ã€‚ä¹Ÿå¯æ¦‚æ‹¬ä¸º : å¼€å¯ä¸€ä¸ªæ–°ä¼šè¯å¹¶é‡Šæ”¾å®ƒä¸æ§åˆ¶ç»ˆç«¯ä¹‹é—´çš„æ‰€æœ‰å…³è”å…³ç³»</p>
</li>
<li><p>å†æ¬¡forkå¹¶æ€æ‰é¦–è¿›ç¨‹.<br>è¿™æ ·å°±ç¡®ä¿äº†å­è¿›ç¨‹ä¸æ˜¯ä¸€ä¸ªä¼šè¯é¦–è¿›ç¨‹ï¼Œ æ ¹æ®linuxä¸­è·å–ç»ˆç«¯çš„è§„åˆ™ï¼ˆåªæœ‰ä¼šè¯é¦–è¿›ç¨‹æ‰èƒ½è¯·æ±‚ä¸€ä¸ªæ§åˆ¶ç»ˆç«¯ï¼‰ï¼Œ è¿™æ ·è¿›ç¨‹æ°¸è¿œä¸ä¼šé‡æ–°è¯·æ±‚ä¸€ä¸ªæ§åˆ¶ç»ˆç«¯</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">                   ä¼š      è¯</span><br><span class="line">                 /     |      \</span><br><span class="line">               /       |       \</span><br><span class="line">             /         |         \</span><br><span class="line">     å‰å°è¿›ç¨‹ç»„     åå°è¿›ç¨‹ç»„1     åå°è¿›ç¨‹ç»„2 ...</span><br><span class="line">   /    |   \     /    |   \      /    |   \</span><br><span class="line">è¿›ç¨‹1 è¿›ç¨‹2 ...  è¿›ç¨‹3 è¿›ç¨‹4 ...       ...</span><br></pre></td></tr></table></figure>
<h2 id="è¿›ç¨‹ç»„"><a href="#è¿›ç¨‹ç»„" class="headerlink" title="è¿›ç¨‹ç»„"></a>è¿›ç¨‹ç»„</h2><p>è¿›ç¨‹ç»„å°±æ˜¯ä¸€ç³»åˆ—ç›¸äº’å…³è”çš„è¿›ç¨‹é›†åˆï¼Œç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ªè¿›ç¨‹ä¹Ÿå¿…é¡»ä»å±äºæŸä¸€ä¸ªè¿›ç¨‹ç»„ï¼›æ¯ä¸ªè¿›ç¨‹ç»„ä¸­éƒ½ä¼šæœ‰ä¸€ä¸ªå”¯ä¸€çš„ ID(process group id)ï¼Œç®€ç§° PGIDï¼›PGID ä¸€èˆ¬ç­‰åŒäºè¿›ç¨‹ç»„çš„åˆ›å»ºè¿›ç¨‹çš„ Process IDï¼Œè€Œè¿™ä¸ªè¿›è¿›ç¨‹ä¸€èˆ¬ä¹Ÿä¼šè¢«ç§°ä¸ºè¿›ç¨‹ç»„å…ˆå¯¼ (process group leader)</p>
<h2 id="ä¼šè¯"><a href="#ä¼šè¯" class="headerlink" title="ä¼šè¯"></a>ä¼šè¯</h2><p>ä¼šè¯ï¼ˆsessionï¼‰æ˜¯ä¸€ä¸ªè‹¥å¹²è¿›ç¨‹ç»„çš„é›†åˆï¼ŒåŒæ ·çš„ï¼Œç³»ç»Ÿä¸­æ¯ä¸€ä¸ªè¿›ç¨‹ç»„ä¹Ÿéƒ½å¿…é¡»ä»å±äºæŸä¸€ä¸ªä¼šè¯ï¼›ä¸€ä¸ªä¼šè¯åªæ‹¥æœ‰æœ€å¤šä¸€ä¸ªæ§åˆ¶ç»ˆç«¯ï¼ˆä¹Ÿå¯ä»¥æ²¡æœ‰ï¼‰ï¼Œè¯¥ç»ˆç«¯ä¸ºä¼šè¯ä¸­æ‰€æœ‰è¿›ç¨‹ç»„ä¸­çš„è¿›ç¨‹æ‰€å…±ç”¨ã€‚ä¸€ä¸ªä¼šè¯ä¸­å‰å°è¿›ç¨‹ç»„åªä¼šæœ‰ä¸€ä¸ªï¼Œåªæœ‰å…¶ä¸­çš„è¿›ç¨‹æ‰å¯ä»¥å’Œæ§åˆ¶ç»ˆç«¯è¿›è¡Œäº¤äº’ï¼›é™¤äº†å‰å°è¿›ç¨‹ç»„å¤–çš„è¿›ç¨‹ç»„ï¼Œéƒ½æ˜¯åå°è¿›ç¨‹ç»„ï¼›å’Œè¿›ç¨‹ç»„å…ˆå¯¼ç±»ä¼¼ï¼Œä¼šè¯ä¸­ä¹Ÿæœ‰ä¼šè¯å…ˆå¯¼ (session leader) çš„æ¦‚å¿µï¼Œç”¨æ¥è¡¨ç¤ºå»ºç«‹èµ·åˆ°æ§åˆ¶ç»ˆç«¯è¿æ¥çš„è¿›ç¨‹ã€‚åœ¨æ‹¥æœ‰æ§åˆ¶ç»ˆç«¯çš„ä¼šè¯ä¸­ï¼Œsession leader ä¹Ÿè¢«ç§°ä¸ºæ§åˆ¶è¿›ç¨‹(controlling process)ï¼Œä¸€èˆ¬æ¥è¯´æ§åˆ¶è¿›ç¨‹ä¹Ÿå°±æ˜¯ç™»å…¥ç³»ç»Ÿçš„ shell è¿›ç¨‹(login shell)ï¼›</p>
<h2 id="æ€æ­»è¿›ç¨‹ç»„æˆ–ä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹"><a href="#æ€æ­»è¿›ç¨‹ç»„æˆ–ä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹" class="headerlink" title="æ€æ­»è¿›ç¨‹ç»„æˆ–ä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹"></a>æ€æ­»è¿›ç¨‹ç»„æˆ–ä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹</h2><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥ PGIDï¼Œé€šè¿‡ kill å‘½ä»¤å‘æ•´ä¸ªè¿›ç¨‹ç»„å‘é€ä¿¡å·ï¼š</p>
<p><code>kill -SIGTERM -- -19701</code></p>
<p>æˆ‘ä»¬ç”¨ä¸€ä¸ªè´Ÿæ•° -19701 å‘è¿›ç¨‹ç»„å‘é€ä¿¡å·ã€‚å¦‚æœæˆ‘ä»¬ä¼ é€’çš„æ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œè¿™ä¸ªæ•°å°†è¢«è§†ä¸ºè¿›ç¨‹ ID ç”¨äºç»ˆæ­¢è¿›ç¨‹ã€‚å¦‚æœæˆ‘ä»¬ä¼ é€’çš„æ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼Œå®ƒè¢«è§†ä¸º PGIDï¼Œç”¨äºç»ˆæ­¢æ•´ä¸ªè¿›ç¨‹ç»„ã€‚<br>è´Ÿæ•°æ¥è‡ªç³»ç»Ÿè°ƒç”¨çš„ç›´æ¥å®šä¹‰ã€‚</p>
<p>æ€æ­»ä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹ä¸ä¹‹å®Œå…¨ä¸åŒã€‚æœ‰äº›ç³»ç»Ÿæ²¡æœ‰ä¼šè¯ ID çš„æ¦‚å¿µã€‚å³ä½¿æ˜¯å…·æœ‰ä¼šè¯ ID çš„ç³»ç»Ÿï¼Œä¾‹å¦‚ Linuxï¼Œä¹Ÿæ²¡æœ‰æä¾›ç³»ç»Ÿè°ƒç”¨æ¥ç»ˆæ­¢ä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹ã€‚ä½ éœ€è¦éå† /proc è¾“å‡ºçš„è¿›ç¨‹æ ‘ï¼Œæ”¶é›†æ‰€æœ‰çš„ SIDï¼Œç„¶åä¸€ä¸€ç»ˆæ­¢è¿›ç¨‹ã€‚<br>Pgrep å®ç°äº†éå†ã€æ”¶é›†å¹¶é€šè¿‡ä¼šè¯ ID æ€æ­»è¿›ç¨‹çš„ç®—æ³•ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p>
<p><code>pkill -s &lt;SID&gt;</code></p>
<h2 id="SIGHUP"><a href="#SIGHUP" class="headerlink" title="SIGHUP"></a>SIGHUP</h2><p>SIGHUP ä¼šåœ¨ä»¥ä¸‹ 3 ç§æƒ…å†µä¸‹è¢«å‘é€ç»™ç›¸åº”çš„è¿›ç¨‹ï¼š</p>
<ul>
<li>ç»ˆç«¯å…³é—­æ—¶ï¼Œè¯¥ä¿¡å·è¢«å‘é€åˆ° session é¦–è¿›ç¨‹ä»¥åŠä½œä¸º job æäº¤çš„è¿›ç¨‹ï¼ˆå³ç”¨ &amp; ç¬¦å·æäº¤çš„è¿›ç¨‹ï¼‰ï¼›</li>
<li>session é¦–è¿›ç¨‹é€€å‡ºæ—¶ï¼Œè¯¥ä¿¡å·è¢«å‘é€åˆ°è¯¥ session ä¸­çš„å‰å°è¿›ç¨‹ç»„ä¸­çš„æ¯ä¸€ä¸ªè¿›ç¨‹ï¼›</li>
<li>è‹¥çˆ¶è¿›ç¨‹é€€å‡ºå¯¼è‡´è¿›ç¨‹ç»„æˆä¸ºå­¤å„¿è¿›ç¨‹ç»„ï¼Œä¸”è¯¥è¿›ç¨‹ç»„ä¸­æœ‰è¿›ç¨‹å¤„äºåœæ­¢çŠ¶æ€ï¼ˆæ”¶åˆ° SIGSTOP æˆ– SIGTSTP ä¿¡å·ï¼‰ï¼Œè¯¥ä¿¡å·ä¼šè¢«å‘é€åˆ°è¯¥è¿›ç¨‹ç»„ä¸­çš„æ¯ä¸€ä¸ªè¿›ç¨‹ã€‚</li>
</ul>
<p>ä¾‹å¦‚ï¼šåœ¨æˆ‘ä»¬ç™»å½• Linux æ—¶ï¼Œç³»ç»Ÿä¼šåˆ†é…ç»™ç™»å½•ç”¨æˆ·ä¸€ä¸ªç»ˆç«¯ (Session)ã€‚åœ¨è¿™ä¸ªç»ˆç«¯è¿è¡Œçš„æ‰€æœ‰ç¨‹åºï¼ŒåŒ…æ‹¬å‰å°è¿›ç¨‹ç»„å’Œåå°è¿›ç¨‹ç»„ï¼Œä¸€èˆ¬éƒ½å±äºè¿™ä¸ª Sessionã€‚å½“ç”¨æˆ·é€€å‡º Linux ç™»å½•æ—¶ï¼Œå‰å°è¿›ç¨‹ç»„å’Œåå°æœ‰å¯¹ç»ˆç«¯è¾“å‡ºçš„è¿›ç¨‹å°†ä¼šæ”¶åˆ° SIGHUP ä¿¡å·ã€‚è¿™ä¸ªä¿¡å·çš„é»˜è®¤æ“ä½œä¸ºç»ˆæ­¢è¿›ç¨‹ï¼Œå› æ­¤å‰å°è¿›ç¨‹ç»„å’Œåå°æœ‰ç»ˆç«¯è¾“å‡ºçš„è¿›ç¨‹å°±ä¼šä¸­æ­¢ã€‚<br><strong>æ­¤å¤–ï¼Œå¯¹äºä¸ç»ˆç«¯è„±ç¦»å…³ç³»çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œæ­£å¸¸æƒ…å†µä¸‹æ˜¯æ°¸è¿œéƒ½æ”¶ä¸åˆ°è¿™ä¸ªä¿¡å·çš„, æ‰€ä»¥å¯ä»¥äººä¸ºçš„å‘SIGHUPä¿¡å·ç»™å¥¹ç”¨äºé€šçŸ¥å®ƒåšä¸€äº›æƒ³è¦çš„è‡ªå®šä¹‰çš„æ“ä½œ</strong>, æ¯”è¾ƒå¸¸è§çš„å¦‚é‡æ–°è¯»å–é…ç½®æ–‡ä»¶æ“ä½œã€‚ æ¯”å¦‚ xinetd è¶…çº§æœåŠ¡ç¨‹åºã€‚</p>
<h2 id="SIGCHLDä¸åƒµæ­»è¿›ç¨‹"><a href="#SIGCHLDä¸åƒµæ­»è¿›ç¨‹" class="headerlink" title="SIGCHLDä¸åƒµæ­»è¿›ç¨‹"></a>SIGCHLDä¸åƒµæ­»è¿›ç¨‹</h2><p>SIGCHLDä¿¡å·,å­è¿›ç¨‹ç»“æŸæ—¶, çˆ¶è¿›ç¨‹ä¼šæ”¶åˆ°è¿™ä¸ªä¿¡å·ã€‚å¦‚æœçˆ¶è¿›ç¨‹æ²¡æœ‰å¤„ç†è¿™ä¸ªä¿¡å·ï¼Œä¹Ÿæ²¡æœ‰ç­‰å¾…(waitpid)å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹è™½ç„¶ç»ˆæ­¢ï¼Œä½†æ˜¯è¿˜ä¼šåœ¨å†…æ ¸è¿›ç¨‹è¡¨ä¸­å æœ‰è¡¨é¡¹ï¼Œè¿™æ—¶çš„å­è¿›ç¨‹ç§°ä¸º<strong>åƒµå°¸è¿›ç¨‹</strong>ã€‚è¿™ç§æƒ…å†µæˆ‘ä»¬åº”è¯¥æ•æ‰å®ƒï¼Œæˆ–è€…waitå®ƒæ´¾ç”Ÿçš„å­è¿›ç¨‹ï¼Œæˆ–è€…çˆ¶è¿›ç¨‹å…ˆç»ˆæ­¢ï¼Œè¿™æ—¶å­è¿›ç¨‹å˜æˆ<strong>å­¤å„¿è¿›ç¨‹</strong>çš„ç»ˆæ­¢è‡ªåŠ¨ç”±initè¿›ç¨‹ æ¥æ¥ç®¡</p>
<h3 id="å­¤å„¿è¿›ç¨‹ä¸åƒµå°¸è¿›ç¨‹"><a href="#å­¤å„¿è¿›ç¨‹ä¸åƒµå°¸è¿›ç¨‹" class="headerlink" title="å­¤å„¿è¿›ç¨‹ä¸åƒµå°¸è¿›ç¨‹"></a>å­¤å„¿è¿›ç¨‹ä¸åƒµå°¸è¿›ç¨‹</h3><ul>
<li><strong>å­¤å„¿è¿›ç¨‹</strong>: å°±æ˜¯æ²¡æœ‰çˆ¶è¿›ç¨‹çš„è¿›ç¨‹ã€‚å½“ç„¶åˆ›å»ºçš„æ—¶å€™è‚¯å®šæ˜¯è¦å…ˆåˆ›å»ºçˆ¶è¿›ç¨‹äº†ï¼Œå½“çˆ¶è¿›ç¨‹é€€å‡ºæ—¶ï¼Œå®ƒçš„å­è¿›ç¨‹ä»¬ï¼ˆä¸€ä¸ªæˆ–è€…å¤šä¸ªï¼‰å°±æˆäº†å­¤å„¿è¿›ç¨‹äº†ã€‚çˆ¶è¿›ç¨‹é€€å‡ºåï¼Œå­è¿›ç¨‹è¢«ä¸€ä¸ªè¿›ç¨‹ ID ä¸º 1 çš„è¿›ç¨‹é¢†å…»çš„ã€‚è¿˜æŒºå¥½è¿™ä¸ªç»“æœï¼Œè‡³å°‘è¿˜æ˜¯æœ‰äººç®¡çš„ï¼Œè¢«æš–åˆ°äº†ï½ è¿›ç¨‹ id ä¸º 1 çš„è¿›ç¨‹æ˜¯ init è¿›ç¨‹ï¼Œæ¯å½“æœ‰å­¤å„¿è¿›ç¨‹å‡ºç°æ—¶ï¼Œinit è¿›ç¨‹å°±ä¼šæ”¶å…»å®ƒå¹¶æˆä¸ºå®ƒçš„çˆ¶è¿›ç¨‹ï¼Œæ¥ç…§é¡¾å®ƒä»¥å­¤å„¿è¿›ç¨‹ä»¥åçš„ç”Ÿæ´»ã€‚<ul>
<li>å±å®³: å› ä¸ºå­¤å„¿è¿›ç¨‹ä¼šè¢« init è¿›ç¨‹æ¥ç®¡ï¼Œæ‰€ä»¥å­¤å„¿è¿›ç¨‹æ˜¯æ²¡æœ‰å±å®³çš„ã€‚</li>
</ul>
</li>
<li><strong>åƒµå°¸è¿›ç¨‹</strong>: å’Œå­¤å„¿è¿›ç¨‹ç›¸åçš„æ˜¯ï¼Œè¿™æ¬¡æ˜¯å­è¿›ç¨‹å…ˆé€€å‡ºï¼Œè€Œçˆ¶è¿›ç¨‹åˆæ²¡æœ‰å»å¤„ç†å›æ”¶é‡Šæ”¾å­è¿›ç¨‹çš„èµ„æºï¼Œè¿™ä¸ªæ—¶å€™å­è¿›ç¨‹å°±æˆäº†åƒµå°¸è¿›ç¨‹ã€‚<ul>
<li>å±å®³: èµ„æºä¸Šæ˜¯å ç”¨ä¸äº†ä»€ä¹ˆèµ„æºã€‚ä½†æ˜¯é€šå¸¸ç³»ç»Ÿçš„è¿›ç¨‹æ•°é‡éƒ½æ˜¯æœ‰é™åˆ¶çš„ï¼Œå¦‚æœæœ‰å¤§é‡çš„åƒµå°¸è¿›ç¨‹å ç”¨è¿›ç¨‹å·ï¼Œå¯¼è‡´æ–°çš„è¿›ç¨‹æ— æ³•åˆ›å»ºï¼Œè¿™ä¸ªå±å®³ç±»ä¼¼äºå ä¸ªå‘ï¼Œä¸åŠäº‹</li>
<li>å¤„ç†: ç›´æ¥<code>kill -9</code>åƒµå°¸è¿›ç¨‹çš„è¯ä¸€èˆ¬æ˜¯killä¸æ‰çš„, åªèƒ½<code>ps</code>ä¹‹åæŸ¥å‡ºä»–çš„çˆ¶è¿›ç¨‹çš„pidç„¶åå»killä»–çš„çˆ¶è¿›ç¨‹çš„pid</li>
</ul>
</li>
</ul>
<h2 id="SIGPIPE"><a href="#SIGPIPE" class="headerlink" title="SIGPIPE"></a>SIGPIPE</h2><p>åœ¨ç½‘ç»œç¼–ç¨‹ä¸­ï¼ŒSIGPIPE è¿™ä¸ªä¿¡å·æ˜¯å¾ˆå¸¸è§çš„ã€‚å½“å¾€ä¸€ä¸ªå†™ç«¯å…³é—­çš„ç®¡é“æˆ– socket è¿æ¥ä¸­è¿ç»­å†™å…¥æ•°æ®æ—¶ä¼šå¼•å‘ SIGPIPE ä¿¡å·, å¼•å‘ SIGPIPE ä¿¡å·çš„å†™æ“ä½œå°†è®¾ç½® errno ä¸º EPIPEã€‚åœ¨ TCP é€šä¿¡ä¸­ï¼Œå½“é€šä¿¡çš„åŒæ–¹ä¸­çš„ä¸€æ–¹ close ä¸€ä¸ªè¿æ¥æ—¶ï¼Œè‹¥å¦ä¸€æ–¹æ¥ç€å‘æ•°æ®ï¼Œæ ¹æ® TCP åè®®çš„è§„å®šï¼Œä¼šæ”¶åˆ°ä¸€ä¸ª RST å“åº”æŠ¥æ–‡ï¼Œè‹¥å†å¾€è¿™ä¸ªæœåŠ¡å™¨å‘é€æ•°æ®æ—¶ï¼Œç³»ç»Ÿä¼šå‘å‡ºä¸€ä¸ª SIGPIPE ä¿¡å·ç»™è¿›ç¨‹ï¼Œå‘Šè¯‰è¿›ç¨‹è¿™ä¸ªè¿æ¥å·²ç»æ–­å¼€äº†ï¼Œä¸èƒ½å†å†™å…¥æ•°æ®ã€‚</p>
<p>å› ä¸º SIGPIPE ä¿¡å·çš„é»˜è®¤è¡Œä¸ºæ˜¯ç»“æŸè¿›ç¨‹ï¼Œè€Œæˆ‘ä»¬ç»å¯¹ä¸å¸Œæœ›å› ä¸ºå†™æ“ä½œçš„é”™è¯¯è€Œå¯¼è‡´ç¨‹åºé€€å‡ºï¼Œå°¤å…¶æ˜¯ä½œä¸ºæœåŠ¡å™¨ç¨‹åºæ¥è¯´å°±æ›´æ¶åŠ£äº†ã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å¯¹è¿™ç§ä¿¡å·åŠ ä»¥å¤„ç†ï¼Œåœ¨è¿™é‡Œï¼Œä»‹ç»å¤„ç† SIGPIPE ä¿¡å·çš„æ–¹å¼ï¼š</p>
<p>ä¸€èˆ¬ç»™ SIGPIPE è®¾ç½® SIG_IGN ä¿¡å·å¤„ç†å‡½æ•°ï¼Œå¿½ç•¥è¯¥ä¿¡å·:</p>
<p><code>signal(SIGPIPE, SIG_IGN);</code></p>
<p>å‰æ–‡è¯´è¿‡ï¼Œå¼•å‘ SIGPIPE ä¿¡å·çš„å†™æ“ä½œå°†è®¾ç½® errno ä¸º EPIPE,ã€‚æ‰€ä»¥ï¼Œç¬¬äºŒæ¬¡å¾€å…³é—­çš„ socket ä¸­å†™å…¥æ•°æ®æ—¶, ä¼šè¿”å› - 1, åŒæ—¶ errno ç½®ä¸º EPIPE. è¿™æ ·ï¼Œä¾¿èƒ½çŸ¥é“å¯¹ç«¯å·²ç»å…³é—­ï¼Œç„¶åè¿›è¡Œç›¸åº”å¤„ç†ï¼Œè€Œä¸ä¼šå¯¼è‡´æ•´ä¸ªè¿›ç¨‹é€€å‡º.</p>
<h2 id="å†…æ ¸æ€ä¸ç”¨æˆ·æ€çš„åŒºåˆ«"><a href="#å†…æ ¸æ€ä¸ç”¨æˆ·æ€çš„åŒºåˆ«" class="headerlink" title="å†…æ ¸æ€ä¸ç”¨æˆ·æ€çš„åŒºåˆ«"></a>å†…æ ¸æ€ä¸ç”¨æˆ·æ€çš„åŒºåˆ«</h2><ul>
<li>å†…æ ¸æ€ï¼šcpuå¯ä»¥è®¿é—®å†…å­˜çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬å¤–å›´è®¾å¤‡ï¼Œä¾‹å¦‚ç¡¬ç›˜ï¼Œç½‘å¡ï¼Œcpuä¹Ÿå¯ä»¥å°†è‡ªå·±ä»ä¸€ä¸ªç¨‹åºåˆ‡æ¢åˆ°å¦ä¸€ä¸ªç¨‹åºã€‚</li>
<li>ç”¨æˆ·æ€ï¼šåªèƒ½å—é™çš„è®¿é—®å†…å­˜ï¼Œä¸”ä¸å…è®¸è®¿é—®å¤–å›´è®¾å¤‡ï¼Œå ç”¨cpuçš„èƒ½åŠ›è¢«å‰¥å¤ºï¼Œcpuèµ„æºå¯ä»¥è¢«å…¶ä»–ç¨‹åºè·å–ã€‚</li>
</ul>
<p>ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€åˆ‡æ¢å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼ï¼š</p>
<ul>
<li>ç³»ç»Ÿè°ƒç”¨: å…¶å®ç³»ç»Ÿè°ƒç”¨æœ¬èº«å°±æ˜¯ä¸­æ–­ï¼Œä½†æ˜¯è½¯ä»¶ä¸­æ–­ï¼Œè·Ÿç¡¬ä¸­æ–­ä¸åŒã€‚</li>
<li>å¼‚å¸¸ï¼šå¦‚æœå½“å‰è¿›ç¨‹è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™å‘ç”Ÿäº†å¼‚å¸¸äº‹ä»¶ï¼Œå°±ä¼šè§¦å‘åˆ‡æ¢ã€‚ä¾‹å¦‚ï¼šç¼ºé¡µå¼‚å¸¸ã€‚</li>
<li>å¤–è®¾ä¸­æ–­ï¼šå½“å¤–è®¾å®Œæˆç”¨æˆ·çš„è¯·æ±‚æ—¶ï¼Œä¼šå‘CPUå‘é€ä¸­æ–­ä¿¡å·ã€‚</li>
</ul>
<h1 id="Linuxç½‘ç»œç¼–ç¨‹"><a href="#Linuxç½‘ç»œç¼–ç¨‹" class="headerlink" title="Linuxç½‘ç»œç¼–ç¨‹"></a>Linuxç½‘ç»œç¼–ç¨‹</h1><table>
<thead>
<tr>
<th style="text-align:center">I/Oæ¨¡å¼</th>
<th style="text-align:center">æ°´å¹³è§¦å‘</th>
<th style="text-align:center">è¾¹ç¼˜è§¦å‘</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">epoll</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center">âœ“</td>
</tr>
<tr>
<td style="text-align:center">select/poll</td>
<td style="text-align:center">âœ“</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">ä¿¡å·é©±åŠ¨</td>
<td style="text-align:center"></td>
<td style="text-align:center">âœ“</td>
</tr>
</tbody>
</table>
<h2 id="select"><a href="#select" class="headerlink" title="select"></a>select</h2><p>ä¸€ä¸ªå¸¸è§çš„selectä¾‹å­(ä¸€ä¸ªå›å°„æœåŠ¡å™¨)å¦‚ä¸‹:<br><figure class="highlight c"><figcaption><span>å›å°„æœåŠ¡å™¨</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">/* include fig01 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span>	<span class="meta-string">"unp.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span>					i, maxi, maxfd, listenfd, connfd, sockfd;</span><br><span class="line">	<span class="keyword">int</span>					nready, client[FD_SETSIZE];</span><br><span class="line">	<span class="keyword">ssize_t</span>				n;</span><br><span class="line">	fd_set				rset, allset;</span><br><span class="line">	<span class="keyword">char</span>				buf[MAXLINE];</span><br><span class="line">	<span class="keyword">socklen_t</span>			clilen;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span>	<span class="title">cliaddr</span>, <span class="title">servaddr</span>;</span></span><br><span class="line"></span><br><span class="line">	listenfd = Socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	bzero(&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</span><br><span class="line">	servaddr.sin_family      = AF_INET;</span><br><span class="line">	servaddr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">	servaddr.sin_port        = htons(SERV_PORT);</span><br><span class="line"></span><br><span class="line">	Bind(listenfd, (SA *) &amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</span><br><span class="line"></span><br><span class="line">	Listen(listenfd, LISTENQ);</span><br><span class="line"></span><br><span class="line">	maxfd = listenfd;			<span class="comment">/* initialize */</span></span><br><span class="line">	maxi = <span class="number">-1</span>;					<span class="comment">/* index into client[] array */</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; FD_SETSIZE; i++)</span><br><span class="line">		client[i] = <span class="number">-1</span>;			<span class="comment">/* -1 indicates available entry */</span></span><br><span class="line">	FD_ZERO(&amp;allset);</span><br><span class="line">	FD_SET(listenfd, &amp;allset);</span><br><span class="line"><span class="comment">/* end fig01 */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* include fig02 */</span></span><br><span class="line">	<span class="keyword">for</span> ( ; ; ) &#123;</span><br><span class="line">		rset = allset;		<span class="comment">/* structure assignment */</span></span><br><span class="line">		nready = Select(maxfd+<span class="number">1</span>, &amp;rset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (FD_ISSET(listenfd, &amp;rset)) &#123;	<span class="comment">/* new client connection */</span></span><br><span class="line">			clilen = <span class="keyword">sizeof</span>(cliaddr);</span><br><span class="line">			connfd = Accept(listenfd, (SA *) &amp;cliaddr, &amp;clilen);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span>	NOTDEF</span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"new client: %s, port %d\n"</span>,</span><br><span class="line">					Inet_ntop(AF_INET, &amp;cliaddr.sin_addr, <span class="number">4</span>, <span class="literal">NULL</span>),</span><br><span class="line">					ntohs(cliaddr.sin_port));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; FD_SETSIZE; i++)</span><br><span class="line">				<span class="keyword">if</span> (client[i] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">					client[i] = connfd;	<span class="comment">/* save descriptor */</span></span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			<span class="keyword">if</span> (i == FD_SETSIZE)</span><br><span class="line">				err_quit(<span class="string">"too many clients"</span>);</span><br><span class="line"></span><br><span class="line">			FD_SET(connfd, &amp;allset);	<span class="comment">/* add new descriptor to set */</span></span><br><span class="line">			<span class="keyword">if</span> (connfd &gt; maxfd)</span><br><span class="line">				maxfd = connfd;			<span class="comment">/* for select */</span></span><br><span class="line">			<span class="keyword">if</span> (i &gt; maxi)</span><br><span class="line">				maxi = i;				<span class="comment">/* max index in client[] array */</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (--nready &lt;= <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">continue</span>;				<span class="comment">/* no more readable descriptors */</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= maxi; i++) &#123;	<span class="comment">/* check all clients for data */</span></span><br><span class="line">			<span class="keyword">if</span> ( (sockfd = client[i]) &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">if</span> (FD_ISSET(sockfd, &amp;rset)) &#123;</span><br><span class="line">				<span class="keyword">if</span> ( (n = Read(sockfd, buf, MAXLINE)) == <span class="number">0</span>) &#123;</span><br><span class="line">						<span class="comment">/*4connection closed by client */</span></span><br><span class="line">					Close(sockfd);</span><br><span class="line">					FD_CLR(sockfd, &amp;allset);</span><br><span class="line">					client[i] = <span class="number">-1</span>;</span><br><span class="line">				&#125; <span class="keyword">else</span></span><br><span class="line">					Writen(sockfd, buf, n);</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (--nready &lt;= <span class="number">0</span>)</span><br><span class="line">					<span class="keyword">break</span>;				<span class="comment">/* no more readable descriptors */</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* end fig02 */</span></span><br></pre></td></tr></table></figure></p>
<p>å‚è€ƒ<a href="https://zhuanlan.zhihu.com/p/39970630" target="_blank" rel="noopener">select poll epollçš„åŒºåˆ«</a></p>
<p>å¯ä»¥çœ‹å‡º<strong>selectçš„ç¼ºç‚¹</strong>å¦‚ä¸‹: </p>
<ul>
<li>(é)selectè¿”å›çš„æ˜¯å«æœ‰æ•´ä¸ªå¥æŸ„çš„æ•°ç»„ï¼Œåº”ç”¨ç¨‹åºéœ€è¦éå†æ•´ä¸ªæ•°ç»„æ‰èƒ½å‘ç°å“ªäº›å¥æŸ„å‘ç”Ÿäº†äº‹ä»¶ï¼›</li>
<li>fd_set ä½¿ç”¨æ•°ç»„å®ç°ï¼Œæ•°ç»„å¤§å°ä½¿ç”¨ FD_SETSIZE å®šä¹‰ï¼Œæ‰€ä»¥åªèƒ½ç›‘å¬å°‘äº FD_SETSIZE æ•°é‡çš„æè¿°ç¬¦ã€‚FD_SETSIZE å¤§å°é»˜è®¤ä¸º 1024ï¼Œå› æ­¤é»˜è®¤åªèƒ½ç›‘å¬å°‘äº 1024 ä¸ªæè¿°ç¬¦ã€‚å¦‚æœè¦ç›‘å¬æ›´å¤šæè¿°ç¬¦çš„è¯ï¼Œéœ€è¦ä¿®æ”¹ FD_SETSIZE ä¹‹åé‡æ–°ç¼–è¯‘</li>
<li>(å†…)å†…æ ¸/ç”¨æˆ·ç©ºé—´å†…å­˜æ‹·è´é—®é¢˜ï¼Œæ¯æ¬¡è°ƒç”¨selectéƒ½éœ€è¦å°†å…¨éƒ¨æè¿°ç¬¦ä»åº”ç”¨è¿›ç¨‹ç¼“å†²åŒºå¤åˆ¶åˆ°å†…æ ¸ç¼“å†²åŒº</li>
<li>(æ•°)å•ä¸ªè¿›ç¨‹èƒ½å¤Ÿç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡å­˜åœ¨æœ€å¤§é™åˆ¶ï¼Œé€šå¸¸æ˜¯1024ï¼Œå½“ç„¶å¯ä»¥æ›´æ”¹æ•°é‡ï¼Œä½†ç”±äºselecté‡‡ç”¨è½®è¯¢çš„æ–¹å¼æ‰«ææ–‡ä»¶æè¿°ç¬¦ï¼Œæ–‡ä»¶æè¿°ç¬¦æ•°é‡è¶Šå¤šï¼Œæ€§èƒ½è¶Šå·®ï¼›</li>
<li>selectçš„è§¦å‘æ–¹å¼æ˜¯æ°´å¹³è§¦å‘ï¼Œåº”ç”¨ç¨‹åºå¦‚æœæ²¡æœ‰å®Œæˆå¯¹ä¸€ä¸ªå·²ç»å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦è¿›è¡ŒIOï¼Œé‚£ä¹ˆä¹‹åå†æ¬¡selectè°ƒç”¨è¿˜æ˜¯ä¼šå°†è¿™äº›æ–‡ä»¶æè¿°ç¬¦é€šçŸ¥è¿›ç¨‹ã€‚</li>
<li>ç›¸æ¯”äºselectæ¨¡å‹ï¼Œpollä½¿ç”¨é“¾è¡¨ä¿å­˜æ–‡ä»¶æè¿°ç¬¦ï¼Œå› æ­¤æ²¡æœ‰äº†ç›‘è§†æ–‡ä»¶æ•°é‡çš„é™åˆ¶ï¼Œä½†å…¶ä»–ä¸‰ä¸ªç¼ºç‚¹ä¾ç„¶å­˜åœ¨ã€‚</li>
</ul>
<h2 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h2><p>ä¸€ä¸ªå¸¸è§çš„epollä½¿ç”¨ä¾‹å­:<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*************************************************************************\</span></span><br><span class="line"><span class="comment">*                  Copyright (C) Michael Kerrisk, 2017.                   *</span></span><br><span class="line"><span class="comment">*                                                                         *</span></span><br><span class="line"><span class="comment">* This program is free software. You may use, modify, and redistribute it *</span></span><br><span class="line"><span class="comment">* under the terms of the GNU General Public License as published by the   *</span></span><br><span class="line"><span class="comment">* Free Software Foundation, either version 3 or (at your option) any      *</span></span><br><span class="line"><span class="comment">* later version. This program is distributed without any warranty.  See   *</span></span><br><span class="line"><span class="comment">* the file COPYING.gpl-v3 for details.                                    *</span></span><br><span class="line"><span class="comment">\*************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Listing 63-5 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"tlpi_hdr.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_BUF     1000        <span class="comment">/* Maximum bytes fetched by a single read() */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_EVENTS     5        <span class="comment">/* Maximum number of events to be returned from</span></span></span><br><span class="line"><span class="meta"><span class="comment">                                   a single epoll_wait() call */</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> epfd, ready, fd, s, j, numOpenFds;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">ev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">evlist</span>[<span class="title">MAX_EVENTS</span>];</span></span><br><span class="line">    <span class="keyword">char</span> buf[MAX_BUF];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span> || <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--help"</span>) == <span class="number">0</span>)</span><br><span class="line">        usageErr(<span class="string">"%s file...\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    epfd = epoll_create(argc - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (epfd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">"epoll_create"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Open each file on command line, and add it to the "interest</span></span><br><span class="line"><span class="comment">       list" for the epoll instance */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt; argc; j++) &#123;</span><br><span class="line">        fd = open(argv[j], O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">"open"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Opened \"%s\" on fd %d\n"</span>, argv[j], fd);</span><br><span class="line"></span><br><span class="line">        ev.events = EPOLLIN;            <span class="comment">/* Only interested in input events */</span></span><br><span class="line">        ev.data.fd = fd;</span><br><span class="line">        <span class="keyword">if</span> (epoll_ctl(epfd, EPOLL_CTL_ADD, fd, &amp;ev) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">"epoll_ctl"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    numOpenFds = argc - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (numOpenFds &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Fetch up to MAX_EVENTS items from the ready list of the</span></span><br><span class="line"><span class="comment">           epoll instance */</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"About to epoll_wait()\n"</span>);</span><br><span class="line">        ready = epoll_wait(epfd, evlist, MAX_EVENTS, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span> (ready == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">                <span class="keyword">continue</span>;               <span class="comment">/* Restart if interrupted by signal */</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                errExit(<span class="string">"epoll_wait"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Ready: %d\n"</span>, ready);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Deal with returned list of events */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; ready; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"  fd=%d; events: %s%s%s\n"</span>, evlist[j].data.fd,</span><br><span class="line">                    (evlist[j].events &amp; EPOLLIN)  ? <span class="string">"EPOLLIN "</span>  : <span class="string">""</span>,</span><br><span class="line">                    (evlist[j].events &amp; EPOLLHUP) ? <span class="string">"EPOLLHUP "</span> : <span class="string">""</span>,</span><br><span class="line">                    (evlist[j].events &amp; EPOLLERR) ? <span class="string">"EPOLLERR "</span> : <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (evlist[j].events &amp; EPOLLIN) &#123;</span><br><span class="line">                s = read(evlist[j].data.fd, buf, MAX_BUF);</span><br><span class="line">                <span class="keyword">if</span> (s == <span class="number">-1</span>)</span><br><span class="line">                    errExit(<span class="string">"read"</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"    read %d bytes: %.*s\n"</span>, s, s, buf);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (evlist[j].events &amp; (EPOLLHUP | EPOLLERR)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* After the epoll_wait(), EPOLLIN and EPOLLHUP may both have</span></span><br><span class="line"><span class="comment">                   been set. But we'll only get here, and thus close the file</span></span><br><span class="line"><span class="comment">                   descriptor, if EPOLLIN was not set. This ensures that all</span></span><br><span class="line"><span class="comment">                   outstanding input (possibly more than MAX_BUF bytes) is</span></span><br><span class="line"><span class="comment">                   consumed (by further loop iterations) before the file</span></span><br><span class="line"><span class="comment">                   descriptor is closed. */</span></span><br><span class="line"></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"    closing fd %d\n"</span>, evlist[j].data.fd);</span><br><span class="line">                <span class="comment">// å…³é—­ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¼šè‡ªåŠ¨çš„å°†å…¶ä»æ‰€æœ‰çš„ epoll å®ä¾‹çš„å…´è¶£åˆ—è¡¨ä¸­ç§»é™¤</span></span><br><span class="line">                <span class="keyword">if</span> (close(evlist[j].data.fd) == <span class="number">-1</span>)</span><br><span class="line">                    errExit(<span class="string">"close"</span>);</span><br><span class="line">                numOpenFds--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"All file descriptors closed; bye\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>epollçš„è®¾è®¡å’Œå®ç°selectå®Œå…¨ä¸åŒ</strong>ã€‚epollæŠŠåŸå…ˆçš„select/pollè°ƒç”¨åˆ†æˆäº†3ä¸ªéƒ¨åˆ†ï¼š  </p>
<ol>
<li>è°ƒç”¨<code>epoll_create()</code>å»ºç«‹ä¸€ä¸ªepollå¯¹è±¡ï¼ˆåœ¨epollæ–‡ä»¶ç³»ç»Ÿä¸­ä¸ºè¿™ä¸ªå¥æŸ„å¯¹è±¡åˆ†é…èµ„æºï¼‰</li>
<li>è°ƒç”¨<code>epoll_ctl</code>å‘epollå¯¹è±¡ä¸­æ·»åŠ è¿™100ä¸‡ä¸ªè¿æ¥çš„å¥—æ¥å­—</li>
<li>è°ƒç”¨<code>epoll_wait</code>æ”¶é›†å‘ç”Ÿçš„äº‹ä»¶çš„è¿æ¥</li>
</ol>
<p>æ€»ç»“:  </p>
<ul>
<li><code>epoll_ctl</code> ç”¨äºå‘å†…æ ¸æ³¨å†Œæ–°çš„æè¿°ç¬¦æˆ–è€…æ˜¯æ”¹å˜æŸä¸ªæ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€ã€‚å·²æ³¨å†Œçš„æè¿°ç¬¦åœ¨å†…æ ¸ä¸­ä¼šè¢«ç»´æŠ¤åœ¨ä¸€æ£µçº¢é»‘æ ‘ä¸Šï¼Œé€šè¿‡å›è°ƒå‡½æ•°å†…æ ¸ä¼šå°† I/O å‡†å¤‡å¥½çš„æè¿°ç¬¦åŠ å…¥åˆ°ä¸€ä¸ªé“¾è¡¨ä¸­ç®¡ç†ï¼Œè¿›ç¨‹è°ƒç”¨ <code>epoll_wait</code> ä¾¿å¯ä»¥å¾—åˆ°äº‹ä»¶å®Œæˆçš„æè¿°ç¬¦ã€‚</li>
<li>ä»ä¸Šé¢çš„æè¿°å¯ä»¥çœ‹å‡ºï¼Œepoll åªéœ€è¦å°†æè¿°ç¬¦ä»è¿›ç¨‹ç¼“å†²åŒºå‘å†…æ ¸ç¼“å†²åŒºæ‹·è´ä¸€æ¬¡ï¼Œå¹¶ä¸”è¿›ç¨‹ä¸éœ€è¦é€šè¿‡è½®è¯¢æ¥è·å¾—äº‹ä»¶å®Œæˆçš„æè¿°ç¬¦ã€‚</li>
<li>epoll ä»…é€‚ç”¨äº Linux OSã€‚</li>
<li>epoll æ¯” select å’Œ poll æ›´åŠ çµæ´»è€Œä¸”æ²¡æœ‰æè¿°ç¬¦æ•°é‡é™åˆ¶ã€‚</li>
</ul>
<h3 id="æ°´å¹³è§¦å‘ä¸è¾¹ç¼˜è§¦å‘çš„åŒºåˆ«"><a href="#æ°´å¹³è§¦å‘ä¸è¾¹ç¼˜è§¦å‘çš„åŒºåˆ«" class="headerlink" title="æ°´å¹³è§¦å‘ä¸è¾¹ç¼˜è§¦å‘çš„åŒºåˆ«"></a>æ°´å¹³è§¦å‘ä¸è¾¹ç¼˜è§¦å‘çš„åŒºåˆ«</h3><p><strong>é»˜è®¤æƒ…å†µä¸‹ epoll æä¾›çš„æ˜¯æ°´å¹³è§¦å‘é€šçŸ¥</strong>.è¦ä½¿ç”¨è¾¹ç¼˜è§¦å‘é€šçŸ¥ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨<code>epoll_ctl()</code>æ—¶åœ¨evï¼eventså­—æ®µä¸­æŒ‡å®šEPOLLETæ ‡å¿—.</p>
<p>ä¾‹å¦‚ : </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">ev</span>;</span></span><br><span class="line">ev.data.fd = fd;</span><br><span class="line">ev.events = EPOLLIN | EPOLLET;</span><br><span class="line"><span class="keyword">if</span> (epoll_ctl(epfd, EPOLL_CTL_ADD, fd, ev) == <span class="number">-1</span>)</span><br><span class="line">    errExit(<span class="string">"epoll_ctl"</span>);</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜epollçš„æ°´å¹³è§¦å‘å’Œè¾¹ç¼˜è§¦å‘é€šçŸ¥ä¹‹é—´çš„åŒºåˆ«ã€‚<br>å‡è®¾æˆ‘ä»¬ä½¿ç”¨epollæ¥ç›‘è§†ä¸€ä¸ªå¥—æ¥å­—ä¸Šçš„è¾“å…¥ï¼ˆEPOLLINï¼‰ï¼Œæ¥ä¸‹æ¥ä¼šå‘ç”Ÿå¦‚ä¸‹çš„äº‹ä»¶ã€‚</p>
<ol>
<li>å¥—æ¥å­—ä¸Šæœ‰è¾“å…¥åˆ°æ¥ã€‚</li>
<li>æˆ‘ä»¬è°ƒç”¨ä¸€æ¬¡<code>epoll_wait()</code>ã€‚æ— è®ºæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯æ°´å¹³è§¦å‘è¿˜æ˜¯è¾¹ç¼˜è§¦å‘é€šçŸ¥ï¼Œè¯¥è°ƒç”¨<br>éƒ½ä¼šå‘Šè¯‰æˆ‘ä»¬å¥—æ¥å­—å·²ç»å¤„äºå°±ç»ªæ€äº†ã€‚</li>
<li>å†æ¬¡è°ƒç”¨<code>epoll_wait()</code>ã€‚<ul>
<li>å¦‚æœæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯æ°´å¹³è§¦å‘é€šçŸ¥ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ª<code>epoll_wait()</code>è°ƒç”¨å°†å‘Šè¯‰æˆ‘ä»¬å¥—æ¥å­—å¤„äºå°±ç»ªæ€ã€‚</li>
<li>è€Œå¦‚æœæˆ‘ä»¬é‡‡ç”¨è¾¹ç¼˜è§¦å‘é€šçŸ¥ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ª<code>epoll_wait()</code>è°ƒç”¨å°†é˜»å¡ï¼Œå› ä¸ºè‡ªä»ä¸Šä¸€æ¬¡è°ƒç”¨<code>epoll_wait()</code>ä»¥æ¥å¹¶æ²¡æœ‰æ–°çš„è¾“å…¥åˆ°æ¥ã€‚è¾¹ç¼˜è§¦å‘é€šçŸ¥é€šå¸¸å’Œéé˜»å¡çš„æ–‡ä»¶æè¿°ç¬¦ç»“åˆä½¿ç”¨ã€‚å› è€Œï¼Œé‡‡ç”¨epollçš„è¾¹ç¼˜è§¦å‘é€šçŸ¥æœºåˆ¶çš„ç¨‹åºåŸºæœ¬æ¡†æ¶å¦‚ä¸‹:<br>  1. è®©æ‰€æœ‰å¾…ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦éƒ½æˆä¸ºéé˜»å¡çš„ã€‚<br>  2. é€šè¿‡epoll_ctl()æ„å»ºepollçš„å…´è¶£åˆ—è¡¨ã€‚<br>  3. é€šè¿‡<code>epoll_wait()</code>å–å¾—å¤„äºå°±ç»ªæ€çš„æè¿°ç¬¦åˆ—è¡¨ã€‚<br>  4. é’ˆå¯¹æ¯ä¸€ä¸ªå¤„äºå°±ç»ªæ€çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸æ–­è¿›è¡ŒI/Oå¤„ç†ç›´åˆ°ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨( ä¾‹å¦‚read()ã€write()ï¼Œrecv()ã€send()æˆ–accept() )è¿”å›EAGAINæˆ–EWOULDBLOCKé”™è¯¯ã€‚</li>
</ul>
</li>
</ol>
<h3 id="æ°´å¹³è§¦å‘éœ€è¦å¤„ç†çš„é—®é¢˜"><a href="#æ°´å¹³è§¦å‘éœ€è¦å¤„ç†çš„é—®é¢˜" class="headerlink" title="æ°´å¹³è§¦å‘éœ€è¦å¤„ç†çš„é—®é¢˜"></a>æ°´å¹³è§¦å‘éœ€è¦å¤„ç†çš„é—®é¢˜</h3><p>ä½¿ç”¨linux epollæ¨¡å‹ï¼Œæ°´å¹³è§¦å‘æ¨¡å¼ï¼ˆLevel-Triggeredï¼‰ï¼›å½“socketå¯å†™æ—¶ï¼Œä¼šä¸åœçš„è§¦å‘socketå¯å†™çš„äº‹ä»¶ï¼Œå¦‚ä½•å¤„ç†ï¼Ÿ</p>
<ul>
<li><p>ç¬¬ä¸€ç§æœ€æ™®é€šçš„æ–¹å¼ï¼š<br>  å½“éœ€è¦å‘socketå†™æ•°æ®æ—¶ï¼Œå°†è¯¥socketåŠ å…¥åˆ°epollæ¨¡å‹ï¼ˆepoll_ctlï¼‰ï¼›ç­‰å¾…å¯å†™äº‹ä»¶ã€‚<br>  æ¥æ”¶åˆ°socketå¯å†™äº‹ä»¶åï¼Œè°ƒç”¨write()æˆ–send()å‘é€æ•°æ®ã€‚ã€‚ã€‚<br>  å½“æ•°æ®å…¨éƒ¨å†™å®Œåï¼Œ å°†socketæè¿°ç¬¦ç§»å‡ºepollæ¨¡å‹ã€‚</p>
<p>  è¿™ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯ï¼š  å³ä½¿å‘é€å¾ˆå°‘çš„æ•°æ®ï¼Œä¹Ÿè¦å°†socketåŠ å…¥ã€ç§»å‡ºepollæ¨¡å‹ã€‚æœ‰ä¸€å®šçš„æ“ä½œä»£ä»·ã€‚</p>
</li>
<li><p>ç¬¬äºŒç§æ–¹å¼ï¼Œï¼ˆæ˜¯æœ¬äººçš„æ”¹è¿›æ–¹æ¡ˆï¼Œ å«åšdirectly-writeï¼‰<br>  å‘socketå†™æ•°æ®æ—¶ï¼Œä¸å°†socketåŠ å…¥åˆ°epollæ¨¡å‹ï¼›è€Œæ˜¯ç›´æ¥è°ƒç”¨send()å‘é€ï¼›<br>  åªæœ‰å½“æˆ–send()è¿”å›é”™è¯¯ç EAGAINï¼ˆç³»ç»Ÿç¼“å­˜æ»¡ï¼‰ï¼Œæ‰å°†socketåŠ å…¥åˆ°epollæ¨¡å‹ï¼Œç­‰å¾…å¯å†™äº‹ä»¶å(è¡¨æ˜ç³»ç»Ÿç¼“å†²åŒºæœ‰ç©ºé—´å¯ä»¥å†™äº†)ï¼Œå†å‘é€æ•°æ®ã€‚<br>  å…¨éƒ¨æ•°æ®å‘é€å®Œæ¯•ï¼Œå†ç§»å‡ºepollæ¨¡å‹ã€‚</p>
<p>  è¿™ç§æ–¹æ¡ˆçš„ä¼˜ç‚¹ï¼š   å½“ç”¨æˆ·æ•°æ®æ¯”è¾ƒå°‘æ—¶ï¼Œä¸éœ€è¦epoolçš„äº‹ä»¶å¤„ç†ã€‚<br>  åœ¨é«˜å‹åŠ›çš„æƒ…å†µä¸‹ï¼Œæ€§èƒ½æ€ä¹ˆæ ·å‘¢ï¼Ÿ<br>  å¯¹ä¸€æ¬¡æ€§ç›´æ¥å†™æˆåŠŸã€å¤±è´¥çš„æ¬¡æ•°è¿›è¡Œç»Ÿè®¡ã€‚å¦‚æœæˆåŠŸæ¬¡æ•°è¿œå¤§äºå¤±è´¥çš„æ¬¡æ•°ï¼Œ è¯´æ˜æ€§èƒ½è‰¯å¥½ã€‚ï¼ˆå¦‚æœå¤±è´¥æ¬¡æ•°è¿œå¤§äºæˆåŠŸçš„æ¬¡æ•°ï¼Œåˆ™å…³é—­è¿™ç§ç›´æ¥å†™çš„æ“ä½œï¼Œæ”¹ç”¨ç¬¬ä¸€ç§æ–¹æ¡ˆã€‚åŒæ—¶åœ¨æ—¥å¿—é‡Œè®°å½•è­¦å‘Šï¼‰<br>  åœ¨æˆ‘è‡ªå·±çš„åº”ç”¨ç³»ç»Ÿä¸­ï¼Œå®éªŒç»“æœæ•°æ®è¯æ˜è¯¥æ–¹æ¡ˆçš„æ€§èƒ½è‰¯å¥½ã€‚</p>
<p>  äº‹å®ä¸Šï¼Œç½‘ç»œæ•°æ®å¯åˆ†ä¸ºä¸¤ç§åˆ°è¾¾/å‘é€æƒ…å†µï¼š<br>  ä¸€æ˜¯åˆ†æ•£çš„æ•°æ®åŒ…ï¼Œ ä¾‹å¦‚æ¯é—´éš”40mså·¦å³ï¼Œå‘é€/æ¥æ”¶3-5ä¸ª MTUï¼ˆæˆ–æ›´å°ï¼Œè¿™æ ·å°±æ²¡è¶…è¿‡é»˜è®¤çš„8Kç³»ç»Ÿç¼“å­˜ï¼‰ã€‚<br>  äºŒæ˜¯è¿ç»­çš„æ•°æ®åŒ…ï¼Œ ä¾‹å¦‚æ¯é—´éš”1så·¦å³ï¼Œè¿ç»­å‘é€/æ¥æ”¶ 20ä¸ª MTUï¼ˆæˆ–æ›´å¤šï¼‰ã€‚</p>
</li>
<li>ç¬¬ä¸‰ç§æ–¹å¼ï¼š  ä½¿ç”¨Edge-Triggeredï¼ˆè¾¹æ²¿è§¦å‘ï¼‰ï¼Œè¿™æ ·socketæœ‰å¯å†™äº‹ä»¶ï¼Œåªä¼šè§¦å‘ä¸€æ¬¡ã€‚<br>  å¯ä»¥åœ¨åº”ç”¨å±‚åšå¥½æ ‡è®°ã€‚ä»¥é¿å…é¢‘ç¹çš„è°ƒç”¨ <code>epoll_ctl( EPOLL_CTL_ADD, EPOLL_CTL_MOD)</code>ã€‚  è¿™ç§æ–¹å¼æ˜¯epoll çš„ man æ‰‹å†Œé‡Œæ¨èçš„æ–¹å¼ï¼Œ æ€§èƒ½æœ€é«˜ã€‚ä½†å¦‚æœå¤„ç†ä¸å½“å®¹æ˜“å‡ºé”™ï¼Œäº‹ä»¶é©±åŠ¨åœæ­¢ã€‚</li>
</ul>
<h3 id="epollå®ç°ç»†èŠ‚"><a href="#epollå®ç°ç»†èŠ‚" class="headerlink" title="epollå®ç°ç»†èŠ‚"></a>epollå®ç°ç»†èŠ‚</h3><p>epollçš„é«˜æ•ˆå°±åœ¨äºï¼Œå½“æˆ‘ä»¬è°ƒç”¨<code>epoll_ctl</code>å¾€é‡Œå¡å…¥ç™¾ä¸‡ä¸ªå¥æŸ„æ—¶ï¼Œ<code>epoll_wait</code>ä»ç„¶å¯ä»¥é£å¿«çš„è¿”å›ï¼Œå¹¶æœ‰æ•ˆçš„å°†å‘ç”Ÿäº‹ä»¶çš„å¥æŸ„ç»™æˆ‘ä»¬ç”¨æˆ·ã€‚è¿™æ˜¯ç”±äºæˆ‘ä»¬åœ¨è°ƒç”¨<code>epoll_create</code>æ—¶ï¼Œå†…æ ¸é™¤äº†å¸®æˆ‘ä»¬åœ¨epollæ–‡ä»¶ç³»ç»Ÿé‡Œå»ºäº†ä¸ªfileç»“ç‚¹ï¼Œåœ¨å†…æ ¸cacheé‡Œå»ºäº†ä¸ªçº¢é»‘æ ‘ç”¨äºå­˜å‚¨ä»¥å<code>epoll_ctl</code>ä¼ æ¥çš„socketå¤–ï¼Œè¿˜ä¼šå†å»ºç«‹ä¸€ä¸ªlisté“¾è¡¨ï¼Œç”¨äºå­˜å‚¨å‡†å¤‡å°±ç»ªçš„äº‹ä»¶ï¼Œå½“<code>epoll_wait</code>è°ƒç”¨æ—¶ï¼Œä»…ä»…è§‚å¯Ÿè¿™ä¸ªlisté“¾è¡¨é‡Œæœ‰æ²¡æœ‰æ•°æ®å³å¯ã€‚æœ‰æ•°æ®å°±è¿”å›ï¼Œæ²¡æœ‰æ•°æ®å°±sleepï¼Œç­‰åˆ°timeoutæ—¶é—´åˆ°åå³ä½¿é“¾è¡¨æ²¡æ•°æ®ä¹Ÿè¿”å›ã€‚æ‰€ä»¥ï¼Œ<code>epoll_wait</code>éå¸¸é«˜æ•ˆã€‚</p>
<p>è€Œä¸”ï¼Œé€šå¸¸æƒ…å†µä¸‹å³ä½¿æˆ‘ä»¬è¦ç›‘æ§ç™¾ä¸‡è®¡çš„å¥æŸ„ï¼Œå¤§å¤šä¸€æ¬¡ä¹Ÿåªè¿”å›å¾ˆå°‘é‡çš„å‡†å¤‡å°±ç»ªå¥æŸ„è€Œå·²ï¼Œæ‰€ä»¥ï¼Œ<code>epoll_wait</code>ä»…éœ€è¦ä»å†…æ ¸æ€copyå°‘é‡çš„å¥æŸ„åˆ°ç”¨æˆ·æ€è€Œå·²ï¼Œå¦‚ä½•èƒ½ä¸é«˜æ•ˆï¼Ÿï¼</p>
<p>é‚£ä¹ˆï¼Œè¿™ä¸ªå‡†å¤‡å°±ç»ªlisté“¾è¡¨æ˜¯æ€ä¹ˆç»´æŠ¤çš„å‘¢ï¼Ÿå½“æˆ‘ä»¬æ‰§è¡Œ<code>epoll_ctl</code>æ—¶ï¼Œé™¤äº†æŠŠsocketæ”¾åˆ°epollæ–‡ä»¶ç³»ç»Ÿé‡Œfileå¯¹è±¡å¯¹åº”çš„çº¢é»‘æ ‘ä¸Šä¹‹å¤–ï¼Œè¿˜ä¼šç»™å†…æ ¸ä¸­æ–­å¤„ç†ç¨‹åºæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå‘Šè¯‰å†…æ ¸ï¼Œå¦‚æœè¿™ä¸ªå¥æŸ„çš„ä¸­æ–­åˆ°äº†ï¼Œå°±æŠŠå®ƒæ”¾åˆ°å‡†å¤‡å°±ç»ªlisté“¾è¡¨é‡Œã€‚æ‰€ä»¥ï¼Œå½“ä¸€ä¸ªsocketä¸Šæœ‰æ•°æ®åˆ°äº†ï¼Œå†…æ ¸åœ¨æŠŠç½‘å¡ä¸Šçš„æ•°æ®copyåˆ°å†…æ ¸ä¸­åå°±æ¥æŠŠsocketæ’å…¥åˆ°å‡†å¤‡å°±ç»ªé“¾è¡¨é‡Œäº†ã€‚</p>
<p>å¦‚æ­¤ï¼Œä¸€é¢—çº¢é»‘æ ‘ï¼Œä¸€å¼ å‡†å¤‡å°±ç»ªå¥æŸ„é“¾è¡¨ï¼Œå°‘é‡çš„å†…æ ¸cacheï¼Œå°±å¸®æˆ‘ä»¬è§£å†³äº†å¤§å¹¶å‘ä¸‹çš„socketå¤„ç†é—®é¢˜ã€‚æ‰§è¡Œ<code>epoll_create</code>æ—¶ï¼Œåˆ›å»ºäº†çº¢é»‘æ ‘å’Œå°±ç»ªé“¾è¡¨ï¼Œæ‰§è¡Œ<code>epoll_ctl</code>æ—¶ï¼Œå¦‚æœå¢åŠ socketå¥æŸ„ï¼Œåˆ™æ£€æŸ¥åœ¨çº¢é»‘æ ‘ä¸­æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ç«‹å³è¿”å›ï¼Œä¸å­˜åœ¨åˆ™æ·»åŠ åˆ°æ ‘å¹²ä¸Šï¼Œç„¶åå‘å†…æ ¸æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œç”¨äºå½“ä¸­æ–­äº‹ä»¶æ¥ä¸´æ—¶å‘å‡†å¤‡å°±ç»ªé“¾è¡¨ä¸­æ’å…¥æ•°æ®ã€‚æ‰§è¡Œ<code>epoll_wait</code>æ—¶ç«‹åˆ»è¿”å›å‡†å¤‡å°±ç»ªé“¾è¡¨é‡Œçš„æ•°æ®å³å¯ã€‚</p>
<p>æœ€åçœ‹çœ‹epollç‹¬æœ‰çš„ä¸¤ç§æ¨¡å¼LTå’ŒETã€‚æ— è®ºæ˜¯LTå’ŒETæ¨¡å¼ï¼Œéƒ½é€‚ç”¨äºä»¥ä¸Šæ‰€è¯´çš„æµç¨‹ã€‚åŒºåˆ«æ˜¯ï¼ŒLTæ¨¡å¼ä¸‹ï¼Œåªè¦ä¸€ä¸ªå¥æŸ„ä¸Šçš„äº‹ä»¶ä¸€æ¬¡æ²¡æœ‰å¤„ç†å®Œï¼Œä¼šåœ¨ä»¥åè°ƒç”¨<code>epoll_wait</code>æ—¶æ¬¡æ¬¡è¿”å›è¿™ä¸ªå¥æŸ„ï¼Œè€ŒETæ¨¡å¼ä»…åœ¨ç¬¬ä¸€æ¬¡è¿”å›ã€‚</p>
<p>è¿™ä»¶äº‹æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿå½“ä¸€ä¸ªsocketå¥æŸ„ä¸Šæœ‰äº‹ä»¶æ—¶ï¼Œå†…æ ¸ä¼šæŠŠè¯¥å¥æŸ„æ’å…¥ä¸Šé¢æ‰€è¯´çš„å‡†å¤‡å°±ç»ªlisté“¾è¡¨ï¼Œè¿™æ—¶æˆ‘ä»¬è°ƒç”¨<code>epoll_wait</code>ï¼Œä¼šæŠŠå‡†å¤‡å°±ç»ªçš„socketæ‹·è´åˆ°ç”¨æˆ·æ€å†…å­˜ï¼Œç„¶åæ¸…ç©ºå‡†å¤‡å°±ç»ªlisté“¾è¡¨ï¼Œæœ€åï¼Œ<code>epoll_wait</code>å¹²äº†ä»¶äº‹ï¼Œå°±æ˜¯æ£€æŸ¥è¿™äº›socketï¼Œå¦‚æœä¸æ˜¯ETæ¨¡å¼ï¼ˆå°±æ˜¯LTæ¨¡å¼çš„å¥æŸ„äº†ï¼‰ï¼Œå¹¶ä¸”è¿™äº›socketä¸Šç¡®å®æœ‰æœªå¤„ç†çš„äº‹ä»¶æ—¶ï¼ŒåˆæŠŠè¯¥å¥æŸ„æ”¾å›åˆ°åˆšåˆšæ¸…ç©ºçš„å‡†å¤‡å°±ç»ªé“¾è¡¨äº†ã€‚æ‰€ä»¥ï¼ŒéETçš„å¥æŸ„ï¼Œåªè¦å®ƒä¸Šé¢è¿˜æœ‰äº‹ä»¶ï¼Œ<code>epoll_wait</code>æ¯æ¬¡éƒ½ä¼šè¿”å›ã€‚è€ŒETæ¨¡å¼çš„å¥æŸ„ï¼Œé™¤éæœ‰æ–°ä¸­æ–­åˆ°ï¼Œå³ä½¿socketä¸Šçš„äº‹ä»¶æ²¡æœ‰å¤„ç†å®Œï¼Œä¹Ÿæ˜¯ä¸ä¼šæ¬¡æ¬¡ä»<code>epoll_wait</code>è¿”å›çš„ã€‚</p>
<h2 id="select-å’Œ-epollçš„åŒºåˆ«"><a href="#select-å’Œ-epollçš„åŒºåˆ«" class="headerlink" title="select å’Œ epollçš„åŒºåˆ«"></a>select å’Œ epollçš„åŒºåˆ«</h2><p>selectå‡½æ•°ï¼Œå¿…é¡»å¾—æ¸…æ¥šselectè·Ÿlinuxç‰¹æœ‰çš„epollçš„åŒºåˆ«ï¼Œ æœ‰ä¸‰ç‚¹(éå†…æ•°)ï¼š</p>
<ul>
<li><strong>é</strong>å† ï¼š æ¯æ¬¡è°ƒç”¨selectéƒ½éœ€è¦åœ¨å†…æ ¸éå†ä¼ é€’è¿›æ¥çš„æ‰€æœ‰fdï¼Œè¿™ä¸ªå¼€é”€åœ¨fdå¾ˆå¤šæ—¶ä¹Ÿå¾ˆå¤§ï¼›å½“æˆ‘ä»¬æ‰§è¡Œ<code>epoll_ctl</code>æ—¶ï¼Œé™¤äº†æŠŠsocketæ”¾åˆ°epollæ–‡ä»¶ç³»ç»Ÿé‡Œfileå¯¹è±¡å¯¹åº”çš„çº¢é»‘æ ‘ä¸Šä¹‹å¤–ï¼Œè¿˜ä¼šç»™å†…æ ¸ä¸­æ–­å¤„ç†ç¨‹åºæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå‘Šè¯‰å†…æ ¸ï¼Œå¦‚æœè¿™ä¸ªå¥æŸ„çš„ä¸­æ–­åˆ°äº†ï¼Œå°±æŠŠå®ƒæ”¾åˆ°å‡†å¤‡å°±ç»ªlisté“¾è¡¨é‡Œã€‚æ‰€ä»¥ï¼Œå½“ä¸€ä¸ªsocketä¸Šæœ‰æ•°æ®åˆ°äº†ï¼Œå†…æ ¸åœ¨æŠŠç½‘å¡ä¸Šçš„æ•°æ®copyåˆ°å†…æ ¸ä¸­åå°±æ¥æŠŠsocketæ’å…¥åˆ°å‡†å¤‡å°±ç»ªé“¾è¡¨é‡Œäº†ã€‚<code>epoll_wait</code>çš„å·¥ä½œå®é™…ä¸Šå°±æ˜¯åœ¨è¿™ä¸ªå°±ç»ªé“¾è¡¨ä¸­æŸ¥çœ‹æœ‰æ²¡æœ‰å°±ç»ªçš„fd, æ¯æ¬¡åªéœ€è¦ç®€å•çš„ä»åˆ—è¡¨é‡Œå–å‡ºå°±è¡Œäº†</li>
<li><strong>å†…</strong>å­˜æ‹·è´ ï¼š selectï¼Œpollæ¯æ¬¡è°ƒç”¨éƒ½è¦æŠŠfdé›†åˆä»ç”¨æˆ·æ€å¾€å†…æ ¸æ€æ‹·è´ä¸€æ¬¡; epollçš„è§£å†³æ–¹æ¡ˆåœ¨<code>epoll_ctl</code>å‡½æ•°ä¸­ã€‚æ¯æ¬¡æ³¨å†Œæ–°çš„äº‹ä»¶åˆ°epollå¥æŸ„ä¸­æ—¶ï¼ˆåœ¨<code>epoll_ctl</code>ä¸­æŒ‡å®šEPOLL_CTL_ADDï¼‰ï¼Œä¼šæŠŠæ‰€æœ‰çš„fdæ‹·è´è¿›å†…æ ¸ï¼Œè€Œä¸æ˜¯åœ¨<code>epoll_wait</code>çš„æ—¶å€™é‡å¤æ‹·è´ã€‚epollä¿è¯äº†æ¯ä¸ªfdåœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­åªä¼šæ‹·è´ä¸€æ¬¡</li>
<li><strong>æ•°</strong>é‡é™åˆ¶ ï¼š selecté»˜è®¤åªæ”¯æŒ1024ä¸ªï¼›epollå¹¶æ²¡æœ‰æœ€å¤§æ•°ç›®é™åˆ¶</li>
</ul>
<h2 id="éé˜»å¡çš„connectå’Œaccept"><a href="#éé˜»å¡çš„connectå’Œaccept" class="headerlink" title="éé˜»å¡çš„connectå’Œaccept"></a>éé˜»å¡çš„connectå’Œaccept</h2><ul>
<li>éé˜»å¡connectä¸ºå•¥è¦ç”¨?æ€ä¹ˆç”¨?<ul>
<li>ä¸ºå•¥è¦ç”¨: å› ä¸ºconnectæ˜¯æ¯”è¾ƒè€—æ—¶çš„, æ‰€ä»¥æˆ‘ä»¬å¸Œæœ›å¯ä»¥åœ¨connectingçš„æ—¶å€™å¹¶è¡Œçš„åšç‚¹å…¶ä»–çš„äº‹</li>
<li>æ€ä¹ˆç”¨: è°ƒç”¨éé˜»å¡connectä¹‹åä¼šç«‹é©¬è¿”å›EINPROCESSé”™è¯¯, ç„¶åæˆ‘ä»¬å»epollæ³¨å†Œä¸€ä¸ªå¯å†™äº‹ä»¶, ç­‰å¾…æ­¤å¥—æ¥å­—å¯å†™æˆ‘ä»¬åˆ¤æ–­ä¸€ä¸‹å¦‚æœä¸æ˜¯socketå‘ç”Ÿå¼‚å¸¸é”™è¯¯åˆ™å³ä¸ºconnectè¿ä¸Šäº†</li>
</ul>
</li>
<li>éé˜»å¡acceptæœ‰å•¥ç”¨, æ€ä¹ˆç”¨?ä¸ºå•¥è¦ç”¨?<ul>
<li>ä¸ºå•¥è¦ç”¨: å¦‚æœè°ƒç”¨é˜»å¡acceptï¼Œè¿™æ ·å¦‚æœåœ¨selectæ£€æµ‹åˆ°æœ‰è¿æ¥è¯·æ±‚ï¼Œä½†åœ¨è°ƒç”¨acceptä¹‹å‰ï¼Œè¿™ä¸ªè¯·æ±‚æ–­å¼€äº†ï¼Œç„¶åè°ƒç”¨acceptçš„æ—¶å€™å°±ä¼šé˜»å¡åœ¨å“ªé‡Œï¼Œé™¤éè¿™æ—¶æœ‰å¦å¤–ä¸€ä¸ªè¿æ¥è¯·æ±‚ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä¸€ç›´è¢«é˜»å¡åœ¨acceptè°ƒç”¨ä¸Š, æ— æ³•å¤„ç†ä»»ä½•å…¶ä»–å·²å°±ç»ªçš„æè¿°ç¬¦ã€‚</li>
<li>æ€ä¹ˆç”¨: æˆ‘ä»¬å»epollæ³¨å†Œä¸€ä¸ªç›‘å¬å¥—æ¥å­—çš„fdå¯è¯»äº‹ä»¶, ç­‰å¾…æ­¤å¥—æ¥å­—çš„fdå¯å†™æˆ‘ä»¬åˆ¤æ–­ä¸€ä¸‹å¦‚æœä¸æ˜¯socketå‘ç”Ÿå¼‚å¸¸é”™è¯¯åˆ™å³ä¸ºå‡†å¤‡å¥½äº†ä¸€ä¸ªæ–°è¿æ¥</li>
</ul>
</li>
<li>æ³¨æ„ : å½“socketå¼‚å¸¸é”™è¯¯çš„æ—¶å€™socketæ˜¯å¯è¯»å¹¶å¯å†™çš„, æ‰€ä»¥åœ¨éé˜»å¡connect(åˆ¤æ–­æ˜¯å¦å¯å†™)/accept(åˆ¤æ–­æ˜¯å¦å¯è¯»)çš„æ—¶å€™è¦ç‰¹åˆ«æ³¨æ„è¿™ç§æƒ…å†µ, è¦ç”¨getsockoptå‡½æ•°, ä½¿ç”¨SO_ERRORé€‰é¡¹æ¥æ£€æŸ¥å¤„ç†.</li>
</ul>
<h2 id="é˜»å¡å’Œéé˜»å¡çš„sendå’Œrecvå’Œsendtoå’Œrecvfrom"><a href="#é˜»å¡å’Œéé˜»å¡çš„sendå’Œrecvå’Œsendtoå’Œrecvfrom" class="headerlink" title="é˜»å¡å’Œéé˜»å¡çš„sendå’Œrecvå’Œsendtoå’Œrecvfrom"></a>é˜»å¡å’Œéé˜»å¡çš„sendå’Œrecvå’Œsendtoå’Œrecvfrom</h2><p><strong>æ³¨æ„:</strong> é¦–å…ˆéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸ç®¡é˜»å¡è¿˜æ˜¯éé˜»å¡ï¼Œåœ¨å‘é€æ—¶éƒ½ä¼šå°†æ•°æ®ä»åº”ç”¨è¿›ç¨‹ç¼“å†²åŒºæ‹·è´åˆ°å†…æ ¸å¥—æ¥å­—å‘é€ç¼“å†²åŒºï¼ˆ<strong>UDPå¹¶æ²¡æœ‰å®é™…å­˜åœ¨è¿™ä¸ªå†…æ ¸å¥—æ¥å­—å‘é€ç¼“å†²åŒº</strong>, UDPçš„å¥—æ¥å­—ç¼“å†²åŒºå¤§å°ä»…ä»…æ˜¯å¯å†™åˆ°è¯¥å¥—æ¥å­—UDPæ•°æ®åŒ…çš„å¤§å°ä¸Šé™, TCP/UDPéƒ½å¯ä»¥ç”¨SO_SNDBUFé€‰é¡¹æ¥æ›´æ”¹è¯¥å†…æ ¸ç¼“å†²åŒºå¤§å°ï¼‰ã€‚</p>
<ul>
<li><strong>å‘é€</strong>, æˆ‘ä»¬å‘é€é€‰ç”¨sendï¼ˆè¿™é‡Œç‰¹æŒ‡TCPï¼‰ä»¥åŠsendtoï¼ˆè¿™é‡Œç‰¹æŒ‡UDPï¼‰æ¥æè¿°<ul>
<li>é˜»å¡<ul>
<li>åœ¨é˜»å¡æ¨¡å¼ä¸‹<strong>send</strong>æ“ä½œå°†ä¼šç­‰å¾…æ‰€æœ‰æ•°æ®å‡è¢«æ‹·è´åˆ°å‘é€ç¼“å†²åŒºåæ‰ä¼šè¿”å›ã€‚é˜»å¡çš„sendæ“ä½œè¿”å›çš„å‘é€å¤§å°ï¼Œå¿…ç„¶æ˜¯ä½ å‚æ•°ä¸­çš„å‘é€é•¿åº¦çš„å¤§å°ã€‚</li>
<li>åœ¨é˜»å¡æ¨¡å¼ä¸‹çš„<strong>sendto</strong>æ“ä½œä¸ä¼šé˜»å¡ã€‚<br>  å…³äºè¿™ä¸€ç‚¹çš„åŸå› åœ¨äºï¼šUDPå¹¶æ²¡æœ‰çœŸæ­£çš„å‘é€ç¼“å†²åŒºï¼Œå®ƒæ‰€åšçš„åªæ˜¯å°†åº”ç”¨ç¼“å†²åŒºæ‹·è´ç»™ä¸‹å±‚åè®®æ ˆï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­åŠ ä¸ŠUDPå¤´ï¼ŒIPå¤´ï¼Œæ‰€ä»¥å®é™…ä¸å­˜åœ¨é˜»å¡ã€‚</li>
</ul>
</li>
<li>éé˜»å¡<ul>
<li>åœ¨éé˜»å¡æ¨¡å¼ä¸‹<strong>send</strong>æ“ä½œè°ƒç”¨ä¼šç«‹å³è¿”å›ã€‚<br>å…³äºç«‹å³è¿”å›å¤§å®¶éƒ½ä¸ä¼šæœ‰å¼‚è®®ã€‚è¿˜æ˜¯æ‹¿é˜»å¡sendçš„é‚£ä¸ªä¾‹å­æ¥çœ‹ï¼Œå½“ç¼“å†²åŒºåªæœ‰192å­—èŠ‚ï¼Œä½†æ˜¯å´éœ€è¦å‘é€2000å­—èŠ‚æ—¶ï¼Œæ­¤æ—¶è°ƒç”¨ç«‹å³è¿”å›ï¼Œå¹¶å¾—åˆ°è¿”å›å€¼ä¸º192ã€‚ä»ä¸­å¯ä»¥çœ‹åˆ°ï¼Œéé˜»å¡sendä»…ä»…æ˜¯å°½è‡ªå·±çš„èƒ½åŠ›å‘ç¼“å†²åŒºæ‹·è´å°½å¯èƒ½å¤šçš„æ•°æ®ï¼Œå› æ­¤åœ¨éé˜»å¡ä¸‹sendæ‰æœ‰å¯èƒ½è¿”å›æ¯”ä½ å‚æ•°ä¸­çš„å‘é€é•¿åº¦å°çš„å€¼ã€‚<br>å¦‚æœç¼“å†²åŒºæ²¡æœ‰ä»»ä½•ç©ºé—´æ—¶å‘¢ï¼Ÿè¿™æ—¶è‚¯å®šä¹Ÿæ˜¯ç«‹å³è¿”å›ï¼Œä½†æ˜¯ä½ ä¼šå¾—åˆ°<code>WSAEWOULDBLOCK</code>/<code>EWOULDBLOCK</code> çš„é”™è¯¯ï¼Œæ­¤æ—¶è¡¨ç¤ºä½ æ— æ³•æ‹·è´ä»»ä½•æ•°æ®åˆ°ç¼“å†²åŒºï¼Œä½ æœ€å¥½ä¼‘æ¯ä¸€ä¸‹å†å°è¯•å‘é€ã€‚  </li>
<li>åœ¨éé˜»å¡æ¨¡å¼ä¸‹<strong>sendto</strong>æ“ä½œ ä¸ä¼šé˜»å¡ï¼ˆä¸é˜»å¡ä¸€è‡´ï¼Œä¸ä½œè¯´æ˜ï¼‰ã€‚ </li>
</ul>
</li>
</ul>
</li>
<li><strong>æ¥æ”¶</strong>, æ¥æ”¶é€‰ç”¨recvï¼ˆè¿™é‡Œç‰¹æŒ‡TCPï¼‰ä»¥åŠrecvfromï¼ˆè¿™é‡Œç‰¹æŒ‡UDPï¼‰æ¥æè¿°<ul>
<li>é˜»å¡<ul>
<li>åœ¨é˜»å¡æ¨¡å¼ä¸‹recvï¼Œrecvfromæ“ä½œå°†ä¼šé˜»å¡ åˆ°ç¼“å†²åŒºé‡Œæœ‰è‡³å°‘ä¸€ä¸ªå­—èŠ‚ï¼ˆTCPï¼‰æˆ–è€…ä¸€ä¸ªå®Œæ•´UDPæ•°æ®æŠ¥æ‰è¿”å›ã€‚</li>
<li>åœ¨æ²¡æœ‰æ•°æ®åˆ°æ¥æ—¶ï¼Œå¯¹å®ƒä»¬çš„è°ƒç”¨éƒ½å°†å¤„äºç¡çœ çŠ¶æ€ï¼Œä¸ä¼šè¿”å›ã€‚</li>
</ul>
</li>
<li>éé˜»å¡<ul>
<li>åœ¨éé˜»å¡æ¨¡å¼ä¸‹recvï¼Œrecvfromæ“ä½œå°†ä¼šç«‹å³è¿”å›ã€‚</li>
<li>å¦‚æœç¼“å†²åŒºæœ‰ä»»ä½•ä¸€ä¸ªå­—èŠ‚æ•°æ®ï¼ˆTCPï¼‰æˆ–è€…ä¸€ä¸ªå®Œæ•´UDPæ•°æ®æŠ¥ï¼Œå®ƒä»¬å°†ä¼šè¿”å›æ¥æ”¶åˆ°çš„æ•°æ®å¤§å°ã€‚è€Œå¦‚æœæ²¡æœ‰ä»»ä½•æ•°æ®åˆ™è¿”å›é”™è¯¯ <code>WSAEWOULDBLOCK</code>/<code>EWOULDBLOCK</code>ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="reuseaddrå’Œreuseport"><a href="#reuseaddrå’Œreuseport" class="headerlink" title="reuseaddrå’Œreuseport"></a>reuseaddrå’Œreuseport</h2><ul>
<li>reuseaddrçš„ä½œç”¨?<ul>
<li>å‚è€ƒ <a href="https://zhuanlan.zhihu.com/p/35367402" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/35367402</a></li>
<li><strong>ä¸»è¦æ˜¯ç”¨äºç»‘å®šTIME_WAITçŠ¶æ€çš„åœ°å€</strong>: ä¸€ä¸ªéå¸¸ç°å®çš„é—®é¢˜æ˜¯ï¼Œå‡å¦‚ä¸€ä¸ªsystemdæ‰˜ç®¡çš„serviceå¼‚å¸¸é€€å‡ºäº†ï¼Œç•™ä¸‹äº†TIME_WAITçŠ¶æ€çš„socketï¼Œé‚£ä¹ˆsystemdå°†ä¼šå°è¯•é‡å¯è¿™ä¸ªserviceã€‚ä½†æ˜¯å› ä¸ºç«¯å£è¢«å ç”¨ï¼Œä¼šå¯¼è‡´å¯åŠ¨å¤±è´¥ï¼Œé€ æˆä¸¤åˆ†é’Ÿçš„æœåŠ¡ç©ºæ¡£æœŸï¼Œsystemdä¹Ÿå¯èƒ½åœ¨è¿™æœŸé—´æ”¾å¼ƒé‡å¯æœåŠ¡ã€‚ä½†æ˜¯åœ¨è®¾ç½®äº†SO_REUSEADDRä»¥åï¼Œå¤„äºTIME_WAITçŠ¶æ€çš„åœ°å€ä¹Ÿå¯ä»¥è¢«ç»‘å®šï¼Œå°±æœç»äº†è¿™ä¸ªé—®é¢˜ã€‚å› ä¸ºTIME_WAITå…¶å®æœ¬èº«å°±æ˜¯åŠæ­»çŠ¶æ€ï¼Œè™½ç„¶è¿™æ ·é‡ç”¨TIME_WAITå¯èƒ½ä¼šé€ æˆä¸å¯é¢„æ–™çš„å‰¯ä½œç”¨ï¼Œä½†æ˜¯åœ¨ç°å®ä¸­é—®é¢˜å¾ˆå°‘å‘ç”Ÿï¼Œæ‰€ä»¥ä¹Ÿå¿½ç•¥äº†å®ƒçš„å‰¯ä½œç”¨<!-- * è¿˜å¯ä»¥æå®š0.0.0.0çš„å“ˆ: åªè¦åœ°å€ä¸æ˜¯æ­£å¥½(exactly)ç›¸åŒï¼Œé‚£ä¹ˆå¤šä¸ªSocketå°±èƒ½ç»‘å®šåˆ°åŒä¸€ipä¸Šã€‚æ¯”å¦‚0.0.0.0å’Œ192.168.0.100ï¼Œè™½ç„¶é€»è¾‘æ„ä¹‰ä¸Šå‰è€…åŒ…å«äº†åè€…ï¼Œä½†æ˜¯0.0.0.0æ³›æŒ‡æ‰€æœ‰æœ¬åœ°ipï¼Œè€Œ192.168.0.100ç‰¹æŒ‡æŸä¸€ipï¼Œä¸¤è€…å¹¶ä¸æ˜¯å®Œå…¨ç›¸åŒï¼Œæ‰€ä»¥Socket Bå°è¯•ç»‘å®šçš„æ—¶å€™ï¼Œä¸ä¼šå†æŠ¥EADDRINUSEï¼Œè€Œæ˜¯ç»‘å®šæˆåŠŸ --></li>
</ul>
</li>
<li><p>reuseportæœ‰å•¥ç”¨?</p>
<ul>
<li><p>SO_REUSEPORTä½¿ç”¨åœºæ™¯ï¼šlinux kernel 3.9 å¼•å…¥äº†æœ€æ–°çš„SO_REUSEPORTé€‰é¡¹ï¼Œä½¿å¾—å¤šè¿›ç¨‹æˆ–è€…å¤šçº¿ç¨‹åˆ›å»ºå¤šä¸ªç»‘å®šåŒä¸€ä¸ªip:portçš„ç›‘å¬socketï¼Œæé«˜æœåŠ¡å™¨çš„æ¥æ”¶é“¾æ¥çš„å¹¶å‘èƒ½åŠ›,ç¨‹åºçš„æ‰©å±•æ€§æ›´å¥½ï¼›æ­¤æ—¶éœ€è¦è®¾ç½®SO_REUSEPORTï¼ˆæ³¨æ„æ‰€æœ‰è¿›ç¨‹éƒ½è¦è®¾ç½®æ‰ç”Ÿæ•ˆï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">setsockopt(listenfd, SOL_SOCKET, SO_REUSEPORT,(<span class="keyword">const</span> <span class="keyword">void</span> *)&amp;reuse , <span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br></pre></td></tr></table></figure>
<p>ç›®çš„ï¼šæ¯ä¸€ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç›‘å¬socketï¼Œå¹¶ä¸”bindç›¸åŒçš„ip:portï¼Œç‹¬ç«‹çš„listen()å’Œaccept()ï¼›æé«˜æ¥æ”¶è¿æ¥çš„èƒ½åŠ›ã€‚ï¼ˆä¾‹å¦‚nginxå¤šè¿›ç¨‹åŒæ—¶ç›‘å¬åŒä¸€ä¸ªip:portï¼‰<br>è§£å†³çš„é—®é¢˜ï¼š</p>
<ul>
<li>é¿å…äº†åº”ç”¨å±‚å¤šçº¿ç¨‹æˆ–è€…è¿›ç¨‹ç›‘å¬åŒä¸€ip:portçš„â€œæƒŠç¾¤æ•ˆåº”â€ã€‚</li>
<li>å†…æ ¸å±‚é¢å®ç°è´Ÿè½½å‡è¡¡ï¼Œä¿è¯æ¯ä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹æ¥æ”¶å‡è¡¡çš„è¿æ¥æ•°ã€‚</li>
<li>åªæœ‰effective-user-idç›¸åŒçš„æœåŠ¡å™¨è¿›ç¨‹æ‰èƒ½ç›‘å¬åŒä¸€ip:port ï¼ˆå®‰å…¨æ€§è€ƒè™‘ï¼‰</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="Linuxå†…å­˜ç®¡ç†"><a href="#Linuxå†…å­˜ç®¡ç†" class="headerlink" title="Linuxå†…å­˜ç®¡ç†"></a>Linuxå†…å­˜ç®¡ç†</h1><h2 id="ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿå†…å­˜"><a href="#ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿå†…å­˜" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿå†…å­˜"></a>ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿå†…å­˜</h2><p>è™šæ‹Ÿå†…å­˜çš„ç›®çš„æ˜¯ä¸ºäº†è®©ç‰©ç†å†…å­˜æ‰©å……æˆæ›´å¤§çš„é€»è¾‘å†…å­˜ï¼Œä»è€Œè®©ç¨‹åºè·å¾—æ›´å¤šçš„å¯ç”¨å†…å­˜ã€‚</p>
<p>ä¸ºäº†æ›´å¥½çš„ç®¡ç†å†…å­˜ï¼Œæ“ä½œç³»ç»Ÿå°†å†…å­˜æŠ½è±¡æˆåœ°å€ç©ºé—´ã€‚æ¯ä¸ªç¨‹åºæ‹¥æœ‰è‡ªå·±çš„åœ°å€ç©ºé—´ï¼Œè¿™ä¸ªåœ°å€ç©ºé—´è¢«åˆ†å‰²æˆå¤šä¸ªå—ï¼Œæ¯ä¸€å—ç§°ä¸ºä¸€é¡µã€‚è¿™äº›é¡µè¢«æ˜ å°„åˆ°ç‰©ç†å†…å­˜ï¼Œä½†ä¸éœ€è¦æ˜ å°„åˆ°è¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œä¹Ÿä¸éœ€è¦æ‰€æœ‰é¡µéƒ½å¿…é¡»åœ¨ç‰©ç†å†…å­˜ä¸­ã€‚å½“ç¨‹åºå¼•ç”¨åˆ°ä¸åœ¨ç‰©ç†å†…å­˜ä¸­çš„é¡µæ—¶ï¼Œç”±ç¡¬ä»¶æ‰§è¡Œå¿…è¦çš„æ˜ å°„ï¼Œå°†ç¼ºå¤±çš„éƒ¨åˆ†è£…å…¥ç‰©ç†å†…å­˜å¹¶é‡æ–°æ‰§è¡Œå¤±è´¥çš„æŒ‡ä»¤ã€‚</p>
<p>ä»ä¸Šé¢çš„æè¿°ä¸­å¯ä»¥çœ‹å‡ºï¼Œ<strong>è™šæ‹Ÿå†…å­˜å…è®¸ç¨‹åºä¸ç”¨å°†åœ°å€ç©ºé—´ä¸­çš„æ¯ä¸€é¡µéƒ½æ˜ å°„åˆ°ç‰©ç†å†…å­˜ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªç¨‹åºä¸éœ€è¦å…¨éƒ¨è°ƒå…¥å†…å­˜å°±å¯ä»¥è¿è¡Œï¼Œè¿™ä½¿å¾—æœ‰é™çš„å†…å­˜è¿è¡Œå¤§ç¨‹åºæˆä¸ºå¯èƒ½ã€‚</strong>ä¾‹å¦‚æœ‰ä¸€å°è®¡ç®—æœºå¯ä»¥äº§ç”Ÿ 16 ä½åœ°å€ï¼Œé‚£ä¹ˆä¸€ä¸ªç¨‹åºçš„åœ°å€ç©ºé—´èŒƒå›´æ˜¯ 0~64Kã€‚è¯¥è®¡ç®—æœºåªæœ‰ 32KB çš„ç‰©ç†å†…å­˜ï¼Œè™šæ‹Ÿå†…å­˜æŠ€æœ¯å…è®¸è¯¥è®¡ç®—æœºè¿è¡Œä¸€ä¸ª 64K å¤§å°çš„ç¨‹åºã€‚</p>
<h2 id="MMUå·¥ä½œåŸç†"><a href="#MMUå·¥ä½œåŸç†" class="headerlink" title="MMUå·¥ä½œåŸç†"></a>MMUå·¥ä½œåŸç†</h2><p>å†…å­˜ç®¡ç†å•å…ƒï¼ˆMMUï¼‰ç®¡ç†ç€åœ°å€ç©ºé—´å’Œç‰©ç†å†…å­˜çš„è½¬æ¢ï¼Œå…¶ä¸­çš„é¡µè¡¨ï¼ˆPage tableï¼‰å­˜å‚¨ç€é¡µï¼ˆç¨‹åºåœ°å€ç©ºé—´ï¼‰å’Œé¡µæ¡†ï¼ˆç‰©ç†å†…å­˜ç©ºé—´ï¼‰çš„æ˜ å°„è¡¨ã€‚</p>
<p>ä¸€ä¸ªè™šæ‹Ÿåœ°å€åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†:  </p>
<ul>
<li>ä¸€éƒ¨åˆ†å­˜å‚¨é¡µé¢å·ï¼Œ</li>
<li>ä¸€éƒ¨åˆ†å­˜å‚¨åç§»é‡ã€‚</li>
</ul>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/mmu_1.jpg" alt><br>ä¸Šå›¾çš„é¡µè¡¨å­˜æ”¾ç€ 16 ä¸ªé¡µï¼Œè¿™ 16 ä¸ªé¡µéœ€è¦ç”¨ 4 ä¸ªæ¯”ç‰¹ä½æ¥è¿›è¡Œç´¢å¼•å®šä½ã€‚ä¾‹å¦‚å¯¹äºè™šæ‹Ÿåœ°å€ï¼ˆ0010 000000000100ï¼‰ï¼Œå‰ 4 ä½æ˜¯å­˜å‚¨é¡µé¢å· 2ï¼Œè¯»å–è¡¨é¡¹å†…å®¹ä¸ºï¼ˆ110 1ï¼‰ï¼Œé¡µè¡¨é¡¹æœ€åä¸€ä½è¡¨ç¤ºæ˜¯å¦å­˜åœ¨äºå†…å­˜ä¸­ï¼Œ1 è¡¨ç¤ºå­˜åœ¨ã€‚å 12 ä½å­˜å‚¨åç§»é‡ã€‚è¿™ä¸ªé¡µå¯¹åº”çš„é¡µæ¡†çš„åœ°å€ä¸º ï¼ˆ110 000000000100ï¼‰ã€‚</p>
<h2 id="ä¸»æœºå­—èŠ‚åº"><a href="#ä¸»æœºå­—èŠ‚åº" class="headerlink" title="ä¸»æœºå­—èŠ‚åº"></a>ä¸»æœºå­—èŠ‚åº</h2><p>ä¸»æœºå­—èŠ‚åºåˆå« CPU å­—èŠ‚åºï¼Œå…¶ä¸æ˜¯ç”±æ“ä½œç³»ç»Ÿå†³å®šçš„ï¼Œè€Œæ˜¯ç”± CPU æŒ‡ä»¤é›†æ¶æ„å†³å®šçš„ã€‚ä¸»æœºå­—èŠ‚åºåˆ†ä¸ºä¸¤ç§ï¼š  </p>
<ul>
<li><strong>è®°å¿†æŠ€å·§</strong>: ä½åºåœ°å€å­˜äº†é«˜åºå­—èŠ‚å°±å«å¤§ç«¯, åä¹‹å°±å°ç«¯</li>
<li>å¤§ç«¯å­—èŠ‚åºï¼ˆBig Endianï¼‰ï¼šé«˜åºå­—èŠ‚å­˜å‚¨åœ¨ä½ä½åœ°å€ï¼Œä½åºå­—èŠ‚å­˜å‚¨åœ¨é«˜ä½åœ°å€</li>
<li>å°ç«¯å­—èŠ‚åºï¼ˆLittle Endianï¼‰ï¼šä½åºå­—èŠ‚å­˜å‚¨åœ¨ä½ä½åœ°å€, é«˜åºå­—èŠ‚å­˜å‚¨åœ¨é«˜ä½åœ°å€ï¼Œç›®å‰ä¸»è¦æ˜¯Intel/AMD/ARMåœ¨ç”¨</li>
</ul>
<p>å­˜å‚¨æ–¹å¼:<br>32 ä½æ•´æ•° 0x12345678 æ˜¯ä»èµ·å§‹ä½ç½®ä¸º 0x00 çš„åœ°å€å¼€å§‹å­˜æ”¾ï¼Œåˆ™ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">å†…å­˜åœ°å€</th>
<th style="text-align:center">0x00</th>
<th style="text-align:center">0x01</th>
<th style="text-align:center">0x02</th>
<th style="text-align:center">0x03</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">å¤§ç«¯</td>
<td style="text-align:center">12</td>
<td style="text-align:center">34</td>
<td style="text-align:center">56</td>
<td style="text-align:center">78</td>
</tr>
<tr>
<td style="text-align:center">å°ç«¯</td>
<td style="text-align:center">78</td>
<td style="text-align:center">56</td>
<td style="text-align:center">34</td>
<td style="text-align:center">12</td>
</tr>
</tbody>
</table>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> i = <span class="number">0x12345678</span>;</span><br><span class="line"><span class="keyword">if</span> (*(<span class="keyword">char</span>*)(&amp;i) == <span class="number">0x12</span>)</span><br><span class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"å¤§ç«¯"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"å°ç«¯"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br></pre></td></tr></table></figure>
<h2 id="ç½‘ç»œå­—èŠ‚åº"><a href="#ç½‘ç»œå­—èŠ‚åº" class="headerlink" title="ç½‘ç»œå­—èŠ‚åº"></a>ç½‘ç»œå­—èŠ‚åº</h2><p>ç½‘ç»œå­—èŠ‚é¡ºåºæ˜¯ TCP/IP ä¸­è§„å®šå¥½çš„ä¸€ç§æ•°æ®è¡¨ç¤ºæ ¼å¼ï¼Œå®ƒä¸å…·ä½“çš„ CPU ç±»å‹ã€æ“ä½œç³»ç»Ÿç­‰æ— å…³ï¼Œä»è€Œå¯ä»¥ä¿è¯æ•°æ®åœ¨ä¸åŒä¸»æœºä¹‹é—´ä¼ è¾“æ—¶èƒ½å¤Ÿè¢«æ­£ç¡®è§£é‡Šã€‚</p>
<p>ç½‘ç»œå­—èŠ‚é¡ºåºé‡‡ç”¨ï¼š<strong>å¤§ç«¯</strong>ï¼ˆBig Endianï¼‰æ’åˆ—æ–¹å¼ã€‚</p>
<h2 id="Linuxè™šæ‹Ÿåœ°å€ç©ºé—´å¦‚ä½•åˆ†å¸ƒ"><a href="#Linuxè™šæ‹Ÿåœ°å€ç©ºé—´å¦‚ä½•åˆ†å¸ƒ" class="headerlink" title="Linuxè™šæ‹Ÿåœ°å€ç©ºé—´å¦‚ä½•åˆ†å¸ƒ"></a>Linuxè™šæ‹Ÿåœ°å€ç©ºé—´å¦‚ä½•åˆ†å¸ƒ</h2><p>Linux ä½¿ç”¨è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¤§å¤§å¢åŠ äº†è¿›ç¨‹çš„å¯»å€ç©ºé—´ï¼Œç”±ä½åœ°å€åˆ°é«˜åœ°å€(ä¸‹å›¾ä¸­ä»ä¸‹åˆ°ä¸Šå³ä¸ºä»ä½åˆ°é«˜)åˆ†åˆ«ä¸º(å£è¯€: æ–‡åˆå †æ ˆ)ï¼š</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/virtual_memory_mgr.jpeg" alt></p>
<ul>
<li>æ–‡æœ¬æ®µ(åªè¯»æ®µ)ï¼šè¯¥éƒ¨åˆ†ç©ºé—´åªèƒ½è¯»ï¼Œä¸å¯å†™ï¼›(åŒ…æ‹¬ï¼šä»£ç æ®µã€rodata æ®µ(Cå¸¸é‡å­—ç¬¦ä¸²å’Œ#defineå®šä¹‰çš„å¸¸é‡) )</li>
<li>æ•°æ®æ®µ(åˆå§‹åŒ–æ•°æ®æ®µä¸æœªåˆå§‹åŒ–æ•°æ®æ®µ)ï¼šä¿å­˜åˆå§‹åŒ–äº†çš„ä¸æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ã€é™æ€å˜é‡çš„ç©ºé—´ï¼›</li>
<li>å † ï¼šå°±æ˜¯å¹³æ—¶æ‰€è¯´çš„åŠ¨æ€å†…å­˜ï¼Œ malloc/new å¤§éƒ¨åˆ†éƒ½æ¥æºäºæ­¤ã€‚å…¶ä¸­å †é¡¶çš„ä½ç½®å¯é€šè¿‡å‡½æ•° brk å’Œ sbrk è¿›è¡ŒåŠ¨æ€è°ƒæ•´ã€‚</li>
<li>æ–‡ä»¶æ˜ å°„åŒºåŸŸ ï¼šå¦‚åŠ¨æ€åº“ã€å…±äº«å†…å­˜ç­‰æ˜ å°„ç‰©ç†ç©ºé—´çš„å†…å­˜ï¼Œä¸€èˆ¬æ˜¯ mmap å‡½æ•°æ‰€åˆ†é…çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</li>
<li>æ ˆï¼šç”¨äºç»´æŠ¤å‡½æ•°è°ƒç”¨çš„ä¸Šä¸‹æ–‡ç©ºé—´ï¼Œä¸€èˆ¬ä¸º 8M ï¼Œå¯é€šè¿‡ ulimit â€“s æŸ¥çœ‹ã€‚</li>
<li>å†…æ ¸è™šæ‹Ÿç©ºé—´ï¼šç”¨æˆ·ä»£ç ä¸å¯è§çš„å†…å­˜åŒºåŸŸï¼Œç”±å†…æ ¸ç®¡ç†(é¡µè¡¨å°±å­˜æ”¾åœ¨å†…æ ¸è™šæ‹Ÿç©ºé—´)ã€‚ä¸Šå›¾æ˜¯ 32 ä½ç³»ç»Ÿå…¸å‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†å¸ƒ(æ¥è‡ªã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹)ã€‚</li>
</ul>
<h2 id="brkå‡½æ•°"><a href="#brkå‡½æ•°" class="headerlink" title="brkå‡½æ•°"></a>brkå‡½æ•°</h2><p>å…ˆäº†è§£ï¼šbrk()å’Œsbrk()å‡½æ•°<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">brk</span><span class="params">( <span class="keyword">const</span> <span class="keyword">void</span> *addr )</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">sbrk</span> <span class="params">( <span class="keyword">intptr_t</span> incr )</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸¤ä¸ªå‡½æ•°çš„ä½œç”¨ä¸»è¦æ˜¯æ‰©å±•heapçš„ä¸Šç•Œbrkã€‚ç¬¬ä¸€ä¸ªå‡½æ•°çš„å‚æ•°ä¸ºè®¾ç½®çš„æ–°çš„brkä¸Šç•Œåœ°å€ï¼Œå¦‚æœæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1ã€‚ç¬¬äºŒä¸ªå‡½æ•°çš„å‚æ•°ä¸ºéœ€è¦ç”³è¯·çš„å†…å­˜çš„å¤§å°ï¼Œç„¶åè¿”å›heapæ–°çš„ä¸Šç•Œbrkåœ°å€ã€‚å¦‚æœsbrkçš„å‚æ•°ä¸º0ï¼Œåˆ™è¿”å›çš„ä¸ºåŸæ¥çš„brkåœ°å€ã€‚</p>
<h2 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h2><p>è™šæ‹Ÿå†…å­˜ç³»ç»Ÿé€šè¿‡å°†è™šæ‹Ÿå†…å­˜åˆ†å‰²ä¸ºç§°ä½œè™šæ‹Ÿé¡µ (Virtual Pageï¼ŒVP) å¤§å°å›ºå®šçš„å—ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯ä¸ªè™šæ‹Ÿé¡µçš„å¤§å°é»˜è®¤æ˜¯ 4096 å­—èŠ‚ã€‚åŒæ ·çš„ï¼Œç‰©ç†å†…å­˜ä¹Ÿè¢«åˆ†å‰²ä¸ºç‰©ç†é¡µ(Physical Pageï¼ŒPP)ï¼Œä¹Ÿä¸º 4096 å­—èŠ‚ã€‚</p>
<p>åœ¨ LINUX ä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ mmap ç”¨æ¥åœ¨è¿›ç¨‹è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´ä¸­åˆ†é…åœ°å€ç©ºé—´ï¼Œåˆ›å»ºå’Œç‰©ç†å†…å­˜çš„æ˜ å°„å…³ç³»ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/mmap.jpg" alt="æ˜ å°„å…³ç³»"></p>
<p><strong>æ˜ å°„å…³ç³»å¯ä»¥åˆ†ä¸ºä¸¤ç§</strong>  </p>
<ol>
<li>æ–‡ä»¶æ˜ å°„<br> ç£ç›˜æ–‡ä»¶æ˜ å°„è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä½¿ç”¨æ–‡ä»¶å†…å®¹åˆå§‹åŒ–ç‰©ç†å†…å­˜ã€‚  </li>
<li>åŒ¿åæ˜ å°„<br> ä¸€ä¸ªåŒ¿åæ˜ å°„æ²¡æœ‰å¯¹åº”çš„æ–‡ä»¶. ç›¸å, è¿™ç§æ˜ å°„çš„åˆ†é¡µä¼šåˆå§‹åŒ–å…¨ä¸º 0 çš„å†…å­˜ç©ºé—´</li>
</ol>
<p><strong>è€Œå¯¹äºæ˜ å°„å…³ç³»æ˜¯å¦å…±äº«åˆåˆ†ä¸º</strong>  </p>
<ol>
<li>ç§æœ‰æ˜ å°„ (<code>MAP_PRIVATE</code>, ä¹Ÿç§°ä½œå†™æ—¶å¤åˆ¶æ˜ å°„)<br> å¤šè¿›ç¨‹é—´æ•°æ®å…±äº«ï¼Œä¿®æ”¹ä¸ååº”åˆ°ç£ç›˜å®é™…æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ª copy-on-writeï¼ˆå†™æ—¶å¤åˆ¶ï¼‰çš„æ˜ å°„æ–¹å¼ã€‚ å½“ä¸€ä¸ªè¿›ç¨‹è¯•å›¾ä¿®æ”¹ä¸€ä¸ªåˆ†é¡µçš„å†…å®¹æ—¶, å†…æ ¸é¦–å…ˆä¼šä¸ºè¯¥è¿›ç¨‹åˆ›å»ºä¸€ä¸ªæ–°åˆ†é¡µå¹¶å°†éœ€è¦ä¿®æ”¹çš„åˆ†é¡µä¸­çš„å†…å®¹å¤åˆ¶åˆ°æ–°åˆ†é¡µä¸­ </li>
<li>å…±äº«æ˜ å°„ (<code>MAP_SHARED</code>)<br> å¤šè¿›ç¨‹é—´æ•°æ®å…±äº«ï¼Œä¿®æ”¹ååº”åˆ°ç£ç›˜å®é™…æ–‡ä»¶ä¸­ã€‚</li>
</ol>
<p><strong>å› æ­¤æ€»ç»“èµ·æ¥æœ‰ 4 ç§ç»„åˆ, ä»–ä»¬çš„ç”¨é€”å¦‚ä¸‹:</strong>  </p>
<ol>
<li>ç§æœ‰æ–‡ä»¶æ˜ å°„<br> å¤šä¸ªè¿›ç¨‹ä½¿ç”¨åŒæ ·çš„ç‰©ç†å†…å­˜é¡µè¿›è¡Œåˆå§‹åŒ–ï¼Œä½†æ˜¯å„ä¸ªè¿›ç¨‹å¯¹å†…å­˜æ–‡ä»¶çš„ä¿®æ”¹ä¸ä¼šå…±äº«ï¼Œä¹Ÿä¸ä¼šååº”åˆ°ç‰©ç†æ–‡ä»¶ä¸­</li>
<li>ç§æœ‰åŒ¿åæ˜ å°„<br> mmap ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ˜ å°„ï¼Œå„ä¸ªè¿›ç¨‹ä¸å…±äº«ï¼Œè¿™ç§ä½¿ç”¨ä¸»è¦ç”¨äºåˆ†é…å†…å­˜ (malloc åˆ†é…å¤§å†…å­˜ä¼šè°ƒç”¨ mmap)ã€‚<br> ä¾‹å¦‚å¼€è¾Ÿæ–°è¿›ç¨‹æ—¶ï¼Œä¼šä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…è™šæ‹Ÿçš„åœ°å€ç©ºé—´ï¼Œè¿™äº›è™šæ‹Ÿåœ°å€æ˜ å°„çš„ç‰©ç†å†…å­˜ç©ºé—´å„ä¸ªè¿›ç¨‹é—´è¯»çš„æ—¶å€™å…±äº«ï¼Œå†™çš„æ—¶å€™ä¼š copy-on-writeã€‚</li>
<li>å…±äº«æ–‡ä»¶æ˜ å°„<br> å¯ä»¥è®©å¤šä¸ª<strong>æ— å…³</strong>è¿›ç¨‹é€šè¿‡è™šæ‹Ÿå†…å­˜æŠ€æœ¯å…±äº«åŒæ ·çš„ç‰©ç†å†…å­˜ç©ºé—´ï¼Œå¯¹å†…å­˜æ–‡ä»¶ çš„ä¿®æ”¹ä¼šååº”åˆ°å®é™…ç‰©ç†æ–‡ä»¶ä¸­ï¼Œä»–ä¹Ÿæ˜¯è¿›ç¨‹é—´é€šä¿¡ (IPC) çš„ä¸€ç§æœºåˆ¶ã€‚</li>
<li>å…±äº«åŒ¿åæ˜ å°„<br> è¿™ç§æœºåˆ¶åœ¨è¿›è¡Œ fork çš„æ—¶å€™ä¸ä¼šé‡‡ç”¨å†™æ—¶å¤åˆ¶ï¼Œçˆ¶å­è¿›ç¨‹å®Œå…¨å…±äº«åŒæ ·çš„ç‰©ç†å†…å­˜é¡µï¼Œè¿™ä¹Ÿå°±å®ç°äº†çˆ¶å­è¿›ç¨‹é€šä¿¡ (IPC), ä½†åªæœ‰<strong>ç›¸å…³</strong>è¿›ç¨‹ä¹‹é—´æ‰å¯ä»¥è¿™ä¹ˆåš</li>
</ol>
<p><strong>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œmmap åªæ˜¯åœ¨è™šæ‹Ÿå†…å­˜åˆ†é…äº†åœ°å€ç©ºé—´ï¼Œåªæœ‰åœ¨ç¬¬ä¸€æ¬¡è®¿é—®è™šæ‹Ÿå†…å­˜çš„æ—¶å€™æ‰åˆ†é…ç‰©ç†å†…å­˜ã€‚</strong><br>åœ¨ mmap ä¹‹åï¼Œå¹¶æ²¡æœ‰åœ¨å°†æ–‡ä»¶å†…å®¹åŠ è½½åˆ°ç‰©ç†é¡µä¸Šï¼Œåªæ˜¯åœ¨è™šæ‹Ÿå†…å­˜ä¸­åˆ†é…äº†åœ°å€ç©ºé—´ã€‚å½“è¿›ç¨‹åœ¨è®¿é—®è¿™æ®µåœ°å€æ—¶ï¼Œé€šè¿‡æŸ¥æ‰¾é¡µè¡¨ï¼Œå‘ç°è™šæ‹Ÿå†…å­˜å¯¹åº”çš„é¡µæ²¡æœ‰åœ¨ç‰©ç†å†…å­˜ä¸­ç¼“å­˜ï¼Œåˆ™äº§ç”Ÿ â€œç¼ºé¡µâ€ï¼Œç”±å†…æ ¸çš„ç¼ºé¡µå¼‚å¸¸å¤„ç†ç¨‹åºå¤„ç†ï¼Œå°†æ–‡ä»¶å¯¹åº”å†…å®¹ï¼Œä»¥é¡µä¸ºå•ä½ (4096) åŠ è½½åˆ°ç‰©ç†å†…å­˜ï¼Œæ³¨æ„æ˜¯åªåŠ è½½ç¼ºé¡µï¼Œä½†ä¹Ÿä¼šå—æ“ä½œç³»ç»Ÿä¸€äº›è°ƒåº¦ç­–ç•¥å½±å“ï¼ŒåŠ è½½çš„æ¯”æ‰€éœ€çš„å¤šã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> length, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags, <span class="keyword">int</span> fd, <span class="keyword">off_t</span> offset)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">munmap</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> length)</span></span>;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯fdå‚æ•°ï¼Œfdä¸ºæ˜ å°„çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚æœæ˜¯åŒ¿åæ˜ å°„ï¼Œå¯ä»¥è®¾ä¸º-1ï¼›</p>
<ul>
<li>mmapå‡½æ•°ç¬¬ä¸€ç§ç”¨æ³•æ˜¯æ˜ å°„ç£ç›˜æ–‡ä»¶åˆ°å†…å­˜ä¸­ï¼›è€Œmallocä½¿ç”¨çš„æ˜¯mmapå‡½æ•°çš„ç¬¬äºŒç§ç”¨æ³•ï¼Œå³åŒ¿åæ˜ å°„ï¼ŒåŒ¿åæ˜ å°„ä¸æ˜ å°„ç£ç›˜æ–‡ä»¶ï¼Œè€Œæ˜¯å‘æ˜ å°„åŒºç”³è¯·ä¸€å—å†…å­˜ã€‚</li>
<li>munmapå‡½æ•°æ˜¯ç”¨äºé‡Šæ”¾å†…å­˜ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå†…å­˜é¦–åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå†…å­˜çš„é•¿åº¦ã€‚æ¥ä¸‹æ¥çœ‹ä¸‹mmapå‡½æ•°çš„å‚æ•°ã€‚</li>
</ul>
<p>ç”±äºbrk/sbrk/mmapå±äºç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚æœæ¯æ¬¡ç”³è¯·å†…å­˜ï¼Œéƒ½è°ƒç”¨è¿™ä¸‰ä¸ªå‡½æ•°ä¸­çš„ä¸€ä¸ªï¼Œé‚£ä¹ˆæ¯æ¬¡éƒ½è¦äº§ç”Ÿç³»ç»Ÿè°ƒç”¨å¼€é”€ï¼ˆå³cpuä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿™é‡Œè¦ä¿å­˜ç”¨æˆ·æ€æ•°æ®ï¼Œç­‰ä¼šè¿˜è¦åˆ‡æ¢å›ç”¨æˆ·æ€ï¼‰ï¼Œè¿™æ˜¯éå¸¸å½±å“æ€§èƒ½çš„ï¼›å…¶æ¬¡ï¼Œè¿™æ ·ç”³è¯·çš„å†…å­˜å®¹æ˜“äº§ç”Ÿç¢ç‰‡ï¼Œå› ä¸ºå †æ˜¯ä»ä½åœ°å€åˆ°é«˜åœ°å€ï¼Œå¦‚æœä½åœ°å€çš„å†…å­˜æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œé«˜åœ°å€çš„å†…å­˜å°±ä¸èƒ½è¢«å›æ”¶ã€‚</p>
<h2 id="mallocå’ŒfreeåŸç†"><a href="#mallocå’ŒfreeåŸç†" class="headerlink" title="mallocå’ŒfreeåŸç†"></a>mallocå’ŒfreeåŸç†</h2><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/heap_1.png" alt></p>
<p>malloc: </p>
<ul>
<li><strong>å½“ç”³è¯·å°å†…å­˜çš„æ—¶ï¼Œmallocä½¿ç”¨sbrkåˆ†é…å†…å­˜</strong></li>
<li><strong>å½“ç”³è¯·å¤§å†…å­˜æ—¶ï¼Œä½¿ç”¨mmapå‡½æ•°ç”³è¯·å†…å­˜</strong></li>
<li><strong>ä½†æ˜¯è¿™åªæ˜¯åˆ†é…äº†è™šæ‹Ÿå†…å­˜ï¼Œè¿˜æ²¡æœ‰æ˜ å°„åˆ°ç‰©ç†å†…å­˜ï¼Œå½“è®¿é—®ç”³è¯·çš„å†…å­˜æ—¶ï¼Œæ‰ä¼šå› ä¸ºç¼ºé¡µå¼‚å¸¸ï¼Œå†…æ ¸åˆ†é…ç‰©ç†å†…å­˜ã€‚</strong></li>
<li>å°†æ‰€æœ‰ç©ºé—²å†…å­˜å—è¿æˆé“¾è¡¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹è®°å½•ç©ºé—²å†…å­˜å—çš„åœ°å€ã€å¤§å°ç­‰ä¿¡æ¯</li>
<li>åˆ†é…å†…å­˜æ—¶ï¼Œæ‰¾åˆ°å¤§å°åˆé€‚çš„å—ï¼Œåˆ‡æˆä¸¤ä»½ï¼Œä¸€åˆ†ç»™ç”¨æˆ·ï¼Œä¸€ä»½æ”¾å›ç©ºé—²é“¾è¡¨</li>
<li>freeæ—¶ï¼Œç›´æ¥æŠŠå†…å­˜å—è¿”è¿˜ç»™é“¾è¡¨</li>
<li>è§£å†³å¤–éƒ¨ç¢ç‰‡ï¼šå°†èƒ½å¤Ÿåˆå¹¶çš„å†…å­˜å—è¿›è¡Œåˆå¹¶</li>
</ul>
<p>mallocå‡½æ•°çš„å®è´¨ä½“ç°åœ¨ï¼šå®ƒæœ‰ä¸€ä¸ªå°†å¯ç”¨çš„å†…å­˜å—è¿æ¥ä¸ºä¸€ä¸ªé•¿é•¿çš„åˆ—è¡¨çš„æ‰€è°“ç©ºé—²é“¾è¡¨ã€‚è°ƒç”¨mallocå‡½æ•°æ—¶ï¼Œå®ƒæ²¿è¿æ¥è¡¨å¯»æ‰¾ä¸€ä¸ªå¤§åˆ°è¶³ä»¥æ»¡è¶³ç”¨æˆ·è¯·æ±‚æ‰€éœ€è¦çš„å†…å­˜å—ã€‚ç„¶åï¼Œå°†è¯¥å†…å­˜å—ä¸€åˆ†ä¸ºäºŒï¼ˆä¸€å—çš„å¤§å°ä¸ç”¨æˆ·è¯·æ±‚çš„å¤§å°ç›¸ç­‰ï¼Œå¦ä¸€å—çš„å¤§å°å°±æ˜¯å‰©ä¸‹çš„å­—èŠ‚ï¼‰ã€‚æ¥ä¸‹æ¥ï¼Œå°†åˆ†é…ç»™ç”¨æˆ·çš„é‚£å—å†…å­˜ä¼ ç»™ç”¨æˆ·ï¼Œå¹¶å°†å‰©ä¸‹çš„é‚£å—ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰è¿”å›åˆ°è¿æ¥è¡¨ä¸Šã€‚</p>
<p>è¿™é‡Œæ³¨æ„ï¼Œmallocæ‰¾åˆ°çš„å†…å­˜å—å¤§å°ä¸€å®šæ˜¯ä¼šå¤§äºç­‰äºæˆ‘ä»¬éœ€è¦çš„å†…å­˜å¤§å°ï¼Œä¸‹é¢ä¼šæåˆ°å¦‚æœæ‰€æœ‰çš„å†…å­˜å—éƒ½æ¯”è¦æ±‚çš„å°ä¼šæ€ä¹ˆåŠï¼Ÿ</p>
<p><strong>è°ƒç”¨freeå‡½æ•°æ—¶ï¼Œå®ƒå°†ç”¨æˆ·é‡Šæ”¾çš„å†…å­˜å—è¿æ¥åˆ°ç©ºé—²é“¾ä¸Šã€‚åˆ°æœ€åï¼Œç©ºé—²é“¾ä¼šè¢«åˆ‡æˆå¾ˆå¤šçš„å°å†…å­˜ç‰‡æ®µï¼Œå¦‚æœè¿™æ—¶ç”¨æˆ·ç”³è¯·ä¸€ä¸ªå¤§çš„å†…å­˜ç‰‡æ®µï¼Œé‚£ä¹ˆç©ºé—²é“¾ä¸Šå¯èƒ½æ²¡æœ‰å¯ä»¥æ»¡è¶³ç”¨æˆ·è¦æ±‚çš„ç‰‡æ®µäº†ã€‚äºæ˜¯ï¼Œmallocå‡½æ•°è¯·æ±‚å»¶æ—¶ï¼Œå¹¶å¼€å§‹åœ¨ç©ºé—²é“¾ä¸Šç¿»ç®±å€’æŸœåœ°æ£€æŸ¥å„å†…å­˜ç‰‡æ®µï¼Œå¯¹å®ƒä»¬è¿›è¡Œæ•´ç†ï¼Œå°†ç›¸é‚»çš„å°ç©ºé—²å—åˆå¹¶æˆè¾ƒå¤§çš„å†…å­˜å—ã€‚</strong></p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/free_1.png" alt></p>
<p>åœ¨å¯¹å†…å­˜å—è¿›è¡Œäº† free è°ƒç”¨ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åšçš„æ˜¯è¯¸å¦‚å°†å®ƒä»¬æ ‡è®°ä¸ºæœªè¢«ä½¿ç”¨çš„ç­‰äº‹æƒ…ï¼Œå¹¶ä¸”ï¼Œåœ¨è°ƒç”¨ malloc æ—¶ï¼Œæˆ‘ä»¬è¦èƒ½å¤Ÿå®šä½æœªè¢«ä½¿ç”¨çš„å†…å­˜å—ã€‚å› æ­¤ï¼Œ mallocè¿”å›çš„æ¯å—å†…å­˜çš„èµ·å§‹å¤„é¦–å…ˆè¦æœ‰è¿™ä¸ªç»“æ„ï¼š</p>
<p>å†…å­˜æ§åˆ¶å—ç»“æ„å®šä¹‰<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_control_block</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> is_available;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>ç°åœ¨ï¼Œæ‚¨å¯èƒ½ä¼šè®¤ä¸ºå½“ç¨‹åºè°ƒç”¨ malloc æ—¶è¿™ä¼šå¼•å‘é—®é¢˜ â€”â€” å®ƒä»¬å¦‚ä½•çŸ¥é“è¿™ä¸ªç»“æ„ï¼Ÿç­”æ¡ˆæ˜¯å®ƒä»¬ä¸å¿…çŸ¥é“ï¼›åœ¨è¿”å›æŒ‡é’ˆä¹‹å‰ï¼Œæˆ‘ä»¬ä¼šå°†å…¶ç§»åŠ¨åˆ°è¿™ä¸ªç»“æ„ä¹‹åï¼ŒæŠŠå®ƒéšè—èµ·æ¥ã€‚è¿™ä½¿å¾—è¿”å›çš„æŒ‡é’ˆæŒ‡å‘æ²¡æœ‰ç”¨äºä»»ä½•å…¶ä»–ç”¨é€”çš„å†…å­˜ã€‚é‚£æ ·ï¼Œä»è°ƒç”¨ç¨‹åºçš„è§’åº¦æ¥çœ‹ï¼Œå®ƒä»¬æ‰€å¾—åˆ°çš„å…¨éƒ¨æ˜¯ç©ºé—²çš„ã€å¼€æ”¾çš„å†…å­˜ã€‚ç„¶åï¼Œå½“é€šè¿‡ free() å°†è¯¥æŒ‡é’ˆä¼ é€’å›æ¥æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦å€’é€€å‡ ä¸ªå†…å­˜å­—èŠ‚å°±å¯ä»¥å†æ¬¡æ‰¾åˆ°è¿™ä¸ªç»“æ„ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/malloc.png" alt></p>
<p><strong>å…³äº malloc è·å¾—è™šå­˜ç©ºé—´çš„å®ç°ï¼Œä¸ glibc çš„ç‰ˆæœ¬æœ‰å…³ï¼Œä½†å¤§ä½“é€»è¾‘æ˜¯ï¼š</strong></p>
<ul>
<li>è‹¥åˆ†é…å†…å­˜å°äº 128k ï¼Œè°ƒç”¨ sbrk() ï¼Œå°†å †é¡¶æŒ‡é’ˆå‘é«˜åœ°å€ç§»åŠ¨ï¼Œè·å¾—æ–°çš„è™šå­˜ç©ºé—´ã€‚</li>
<li>è‹¥åˆ†é…å†…å­˜å¤§äº 128k ï¼Œè°ƒç”¨ mmap() ï¼Œåœ¨æ–‡ä»¶æ˜ å°„åŒºåŸŸä¸­åˆ†é…åŒ¿åè™šå­˜ç©ºé—´ã€‚</li>
</ul>
<p>æ¥ç€ï¼š VSZä¸ºè™šæ‹Ÿå†…å­˜ RSSä¸ºç‰©ç†å†…å­˜</p>
<ul>
<li>VSZ å¹¶ä¸æ˜¯æ¯æ¬¡ malloc åéƒ½å¢é•¿ï¼Œæ˜¯ä¸ä¸Šä¸€èŠ‚è¯´çš„å †é¡¶æ²¡å‘ç”Ÿå˜åŒ–æœ‰å…³ï¼Œå› ä¸ºå¯é‡ç”¨å †é¡¶å†…å‰©ä½™çš„ç©ºé—´ï¼Œè¿™æ ·çš„ malloc æ˜¯å¾ˆè½»é‡å¿«é€Ÿçš„ã€‚</li>
<li>ä½†å¦‚æœ VSZ å‘ç”Ÿå˜åŒ–ï¼ŒåŸºæœ¬ä¸åˆ†é…å†…å­˜é‡ç›¸å½“ï¼Œå› ä¸º VSZ æ˜¯è®¡ç®—è™šæ‹Ÿåœ°å€ç©ºé—´æ€»å¤§å°ã€‚</li>
<li>RSS çš„å¢é‡å¾ˆå°‘ï¼Œæ˜¯å› ä¸º malloc åˆ†é…çš„å†…å­˜å¹¶ä¸å°±é©¬ä¸Šåˆ†é…å®é™…å­˜å‚¨ç©ºé—´ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œå¦‚ç¬¬ä¸€æ¬¡ memset åæ‰ä¼šåˆ†é…ã€‚</li>
<li>ç”±äºæ¯ä¸ªç‰©ç†å†…å­˜é¡µé¢å¤§å°æ˜¯ 4k ï¼Œä¸ç®¡ memset å…¶ä¸­çš„ 1k è¿˜æ˜¯ 5k ã€ 7k ï¼Œå®é™…å ç”¨ç‰©ç†å†…å­˜æ€»æ˜¯ 4k çš„å€æ•°ã€‚æ‰€ä»¥ RSS çš„å¢é‡æ€»æ˜¯ 4k çš„å€æ•°ã€‚</li>
<li>å› æ­¤ï¼Œä¸æ˜¯ malloc åå°±é©¬ä¸Šå ç”¨å®é™…å†…å­˜ï¼Œè€Œæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶å‘ç°è™šå­˜å¯¹åº”çš„ç‰©ç†é¡µé¢æœªåˆ†é…ï¼Œäº§ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œæ‰çœŸæ­£åˆ†é…ç‰©ç†é¡µé¢ï¼ŒåŒæ—¶æ›´æ–°è¿›ç¨‹é¡µé¢çš„æ˜ å°„å…³ç³»ã€‚è¿™ä¹Ÿæ˜¯ Linux è™šæ‹Ÿå†…å­˜ç®¡ç†çš„æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ã€‚</li>
</ul>
<h2 id="vmallocå’Œkmallocå’Œmallocçš„åŒºåˆ«"><a href="#vmallocå’Œkmallocå’Œmallocçš„åŒºåˆ«" class="headerlink" title="vmallocå’Œkmallocå’Œmallocçš„åŒºåˆ«"></a>vmallocå’Œkmallocå’Œmallocçš„åŒºåˆ«</h2><ul>
<li>kmallocå’Œvmallocæ˜¯åˆ†é…çš„æ˜¯å†…æ ¸çš„å†…å­˜,mallocåˆ†é…çš„æ˜¯ç”¨æˆ·çš„å†…å­˜</li>
<li>kmallocä¿è¯åˆ†é…çš„å†…å­˜åœ¨ç‰©ç†ä¸Šæ˜¯è¿ç»­çš„,vmallocä¿è¯çš„æ˜¯åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸Šçš„è¿ç»­,mallocä¸ä¿è¯ä»»ä½•ä¸œè¥¿(è¿™ç‚¹æ˜¯è‡ªå·±çŒœæµ‹çš„,ä¸ä¸€å®šæ­£ç¡®)</li>
<li>kmallocèƒ½åˆ†é…çš„å¤§å°æœ‰é™,vmallocå’Œmallocèƒ½åˆ†é…çš„å¤§å°ç›¸å¯¹è¾ƒå¤§</li>
<li>å†…å­˜åªæœ‰åœ¨è¦è¢«DMAè®¿é—®çš„æ—¶å€™æ‰éœ€è¦ç‰©ç†ä¸Šè¿ç»­</li>
<li>vmallocæ¯”kmallocè¦æ…¢</li>
</ul>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/virtual_memory_mgr1.jpg" alt></p>
<p>å¯¹äºæä¾›äº†MMUï¼ˆå­˜å‚¨ç®¡ç†å™¨ï¼Œè¾…åŠ©æ“ä½œç³»ç»Ÿè¿›è¡Œå†…å­˜ç®¡ç†ï¼Œæä¾›è™šå®åœ°å€è½¬æ¢ç­‰ç¡¬ä»¶æ”¯æŒï¼‰çš„å¤„ç†å™¨è€Œè¨€ï¼ŒLinuxæä¾›äº†å¤æ‚çš„å­˜å‚¨ç®¡ç†ç³»ç»Ÿï¼Œä½¿å¾—è¿›ç¨‹æ‰€èƒ½è®¿é—®çš„å†…å­˜è¾¾åˆ°4GBã€‚</p>
<p>è¿›ç¨‹çš„4GBå†…å­˜ç©ºé—´è¢«äººä¸ºçš„åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†â€“ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ã€‚ç”¨æˆ·ç©ºé—´åœ°å€åˆ†å¸ƒä»0åˆ°3GB(PAGE_OFFSETï¼Œåœ¨0x86ä¸­å®ƒç­‰äº0xC0000000)ï¼Œ3GBåˆ°4GBä¸ºå†…æ ¸ç©ºé—´ã€‚</p>
<p>å†…æ ¸ç©ºé—´ä¸­ï¼Œä»3Gåˆ°vmalloc_startè¿™æ®µåœ°å€æ˜¯ç‰©ç†å†…å­˜æ˜ å°„åŒºåŸŸï¼ˆè¯¥åŒºåŸŸä¸­åŒ…å«äº†å†…æ ¸é•œåƒã€ç‰©ç†é¡µæ¡†è¡¨mem_mapç­‰ç­‰ï¼‰ï¼Œæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨ çš„ VMwareè™šæ‹Ÿç³»ç»Ÿå†…å­˜æ˜¯160Mï¼Œé‚£ä¹ˆ3Gï½3G+160Mè¿™ç‰‡å†…å­˜å°±åº”è¯¥æ˜ å°„ç‰©ç†å†…å­˜ã€‚åœ¨ç‰©ç†å†…å­˜æ˜ å°„åŒºä¹‹åï¼Œå°±æ˜¯vmallocåŒºåŸŸã€‚å¯¹äº 160Mçš„ç³»ç»Ÿè€Œè¨€ï¼Œvmalloc_startä½ç½®åº”åœ¨3G+160Mé™„è¿‘ï¼ˆåœ¨ç‰©ç†å†…å­˜æ˜ å°„åŒºä¸vmalloc_startæœŸé—´è¿˜å­˜åœ¨ä¸€ä¸ª8Mçš„gap æ¥é˜²æ­¢è·ƒç•Œï¼‰ï¼Œvmalloc_endçš„ä½ç½®æ¥è¿‘4G(æœ€åä½ç½®ç³»ç»Ÿä¼šä¿ç•™ä¸€ç‰‡128kå¤§å°çš„åŒºåŸŸç”¨äºä¸“ç”¨é¡µé¢æ˜ å°„)</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªæœ‰ç¡¬ä»¶è®¾å¤‡æ‰éœ€è¦ç‰©ç†åœ°å€è¿ç»­çš„å†…å­˜ï¼Œå› ä¸ºç¡¬ä»¶è®¾å¤‡å¾€å¾€å­˜åœ¨äºMMUä¹‹å¤–ï¼Œæ ¹æœ¬ä¸äº†è§£è™šæ‹Ÿåœ°å€ï¼›ä½†ä¸ºäº†æ€§èƒ½ä¸Šçš„è€ƒè™‘ï¼Œå†…æ ¸ä¸­ä¸€èˆ¬ä½¿ç”¨kmalloc(),è€Œåªæœ‰åœ¨éœ€è¦è·å¾—å¤§å—å†…å­˜æ—¶æ‰ä½¿ç”¨vmallocï¼Œä¾‹å¦‚å½“æ¨¡å—è¢«åŠ¨æ€åŠ è½½åˆ°å†…æ ¸å½“ä¸­æ—¶ï¼Œå°±æŠŠæ¨¡å—è£…è½½åˆ°ç”±vmallocï¼ˆï¼‰åˆ†é…çš„å†…å­˜ä¸Šã€‚</p>
<ul>
<li><strong>kmalloc</strong>:<br>  kmallocç”³è¯·çš„æ˜¯è¾ƒå°çš„è¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œå†…å­˜ç‰©ç†åœ°å€ä¸Šè¿ç»­ï¼Œè™šæ‹Ÿåœ°å€ä¸Šä¹Ÿæ˜¯è¿ç»­çš„ï¼Œä½¿ç”¨çš„æ˜¯å†…å­˜åˆ†é…å™¨slabçš„ä¸€å°ç‰‡ã€‚ç”³è¯·çš„å†…å­˜ä½äºç‰©ç†å†…å­˜çš„æ˜ å°„åŒºåŸŸã€‚å…¶çœŸæ­£çš„ç‰©ç†åœ°å€åªç›¸å·®ä¸€ä¸ªå›ºå®šçš„åç§»ã€‚è€Œä¸”ä¸å¯¹è·å¾—ç©ºé—´æ¸…é›¶ã€‚å¯ä»¥æŸ¥çœ‹<a href="#Slabåˆ†é…å™¨">slabåˆ†é…å™¨</a></li>
<li><strong>kzalloc</strong>:<br>  ç”¨kzallocç”³è¯·å†…å­˜çš„æ—¶å€™ï¼Œ æ•ˆæœç­‰åŒäºå…ˆæ˜¯ç”¨ kmalloc() ç”³è¯·ç©ºé—´ , ç„¶åç”¨ memset() æ¥åˆå§‹åŒ– ,æ‰€æœ‰ç”³è¯·çš„å…ƒç´ éƒ½è¢«åˆå§‹åŒ–ä¸º 0.</li>
<li><strong>vmalloc</strong>:<br>  vmallocç”¨äºç”³è¯·è¾ƒå¤§çš„å†…å­˜ç©ºé—´ï¼Œè™šæ‹Ÿå†…å­˜æ˜¯è¿ç»­ã€‚ç”³è¯·çš„å†…å­˜çš„åˆ™ä½äºvmalloc_startï½vmalloc_endä¹‹é—´ï¼Œä¸ç‰©ç†åœ°å€æ²¡æœ‰ç®€å•çš„è½¬æ¢å…³ç³»ï¼Œè™½ç„¶åœ¨é€»è¾‘ä¸Šå®ƒä»¬ä¹Ÿæ˜¯è¿ç»­çš„ï¼Œä½†æ˜¯åœ¨ç‰©ç†ä¸Šå®ƒä»¬ä¸è¦æ±‚è¿ç»­ã€‚</li>
<li><strong>malloc</strong>:<br>  mallocåˆ†é…çš„æ˜¯ç”¨æˆ·çš„å†…å­˜ã€‚é™¤éè¢«é˜»å¡å¦åˆ™ä»–æ‰§è¡Œçš„é€Ÿåº¦éå¸¸å¿«ï¼Œè€Œä¸”ä¸å¯¹è·å¾—ç©ºé—´æ¸…é›¶ã€‚</li>
</ul>
<h2 id="Buddyï¼ˆä¼™ä¼´ï¼‰åˆ†é…ç®—æ³•"><a href="#Buddyï¼ˆä¼™ä¼´ï¼‰åˆ†é…ç®—æ³•" class="headerlink" title="Buddyï¼ˆä¼™ä¼´ï¼‰åˆ†é…ç®—æ³•"></a>Buddyï¼ˆä¼™ä¼´ï¼‰åˆ†é…ç®—æ³•</h2><p>å‚è€ƒ: <a href="https://zhuanlan.zhihu.com/p/149581303" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/149581303</a></p>
<p>ä¼™ä¼´ç³»ç»Ÿç”¨äºç®¡ç†ç‰©ç†é¡µï¼Œä¸»è¦ç›®çš„åœ¨äºç»´æŠ¤å¯ç”¨çš„è¿ç»­ç‰©ç†ç©ºé—´ï¼Œé¿å…å¤–éƒ¨ç¢ç‰‡ã€‚æ‰€æœ‰å…³äºå†…å­˜åˆ†é…çš„æ“ä½œéƒ½ä¼šä¸å…¶æ‰“äº¤é“ï¼Œbuddyæ˜¯ç‰©ç†å†…å­˜çš„ç®¡ç†çš„é—¨æˆ·</p>
<p>Linux å†…æ ¸å¼•å…¥äº†ä¼™ä¼´ç³»ç»Ÿç®—æ³•ï¼ˆBuddy systemï¼‰ï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå°±æ˜¯æŠŠç›¸åŒå¤§å°çš„é¡µæ¡†å—ç”¨é“¾è¡¨ä¸²èµ·æ¥ï¼Œé¡µæ¡†å—å°±åƒæ‰‹æ‹‰æ‰‹çš„å¥½ä¼™ä¼´ï¼Œä¹Ÿæ˜¯è¿™ä¸ªç®—æ³•åå­—çš„ç”±æ¥ã€‚</p>
<p>å…·ä½“çš„ï¼Œæ‰€æœ‰çš„ç©ºé—²é¡µæ¡†åˆ†ç»„ä¸º11ä¸ªå—é“¾è¡¨ï¼Œæ¯ä¸ªå—é“¾è¡¨åˆ†åˆ«åŒ…å«å¤§å°ä¸º1ï¼Œ2ï¼Œ4ï¼Œ8ï¼Œ16ï¼Œ32ï¼Œ64ï¼Œ128ï¼Œ256ï¼Œ512å’Œ1024ä¸ªè¿ç»­é¡µæ¡†çš„é¡µæ¡†å—ã€‚æœ€å¤§å¯ä»¥ç”³è¯·1024ä¸ªè¿ç»­é¡µæ¡†ï¼Œå¯¹åº”4MBå¤§å°çš„è¿ç»­å†…å­˜ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/buddy_algo.jpg" alt></p>
<p>ä¼™ä¼´ç³»ç»Ÿ:<br>å› ä¸ºä»»ä½•æ­£æ•´æ•°éƒ½å¯ä»¥ç”± 2^n çš„å’Œç»„æˆï¼Œæ‰€ä»¥æ€»èƒ½æ‰¾åˆ°åˆé€‚å¤§å°çš„å†…å­˜å—åˆ†é…å‡ºå»ï¼Œå‡å°‘äº†å¤–éƒ¨ç¢ç‰‡äº§ç”Ÿ ã€‚</p>
<p>åˆ†é…å®ä¾‹:<br>æ¯”å¦‚ï¼šæˆ‘éœ€è¦ç”³è¯·4ä¸ªé¡µæ¡†ï¼Œä½†æ˜¯é•¿åº¦ä¸º4ä¸ªè¿ç»­é¡µæ¡†å—é“¾è¡¨æ²¡æœ‰ç©ºé—²çš„é¡µæ¡†å—ï¼Œä¼™ä¼´ç³»ç»Ÿä¼šä»è¿ç»­8ä¸ªé¡µæ¡†å—çš„é“¾è¡¨è·å–ä¸€ä¸ªï¼Œå¹¶å°†å…¶æ‹†åˆ†ä¸ºä¸¤ä¸ªè¿ç»­4ä¸ªé¡µæ¡†å—ï¼Œå–å…¶ä¸­ä¸€ä¸ªï¼Œå¦å¤–ä¸€ä¸ªæ”¾å…¥è¿ç»­4ä¸ªé¡µæ¡†å—çš„ç©ºé—²é“¾è¡¨ä¸­ã€‚é‡Šæ”¾çš„æ—¶å€™ä¼šæ£€æŸ¥ï¼Œé‡Šæ”¾çš„è¿™å‡ ä¸ªé¡µæ¡†å‰åçš„é¡µæ¡†æ˜¯å¦ç©ºé—²ï¼Œèƒ½å¦ç»„æˆä¸‹ä¸€çº§é•¿åº¦çš„å—ã€‚</p>
<h2 id="Slabåˆ†é…å™¨"><a href="#Slabåˆ†é…å™¨" class="headerlink" title="Slabåˆ†é…å™¨"></a>Slabåˆ†é…å™¨</h2><p>ä¼™ä¼´ç³»ç»Ÿå’Œslabä¸æ˜¯äºŒé€‰ä¸€çš„å…³ç³»ï¼Œslab å†…å­˜åˆ†é…å™¨æ˜¯å¯¹ä¼™ä¼´åˆ†é…ç®—æ³•çš„è¡¥å……</p>
<p>slabçš„ç›®çš„åœ¨äºé¿å…å†…éƒ¨ç¢ç‰‡ã€‚ä»buddyç³»ç»Ÿè·å–çš„å†…å­˜è‡³å°‘æ˜¯ä¸€ä¸ªé¡µï¼Œä¹Ÿå°±æ˜¯4Kï¼Œå¦‚æœä»…ä»…éœ€è¦8å­—èŠ‚çš„å†…å­˜ï¼Œæ˜¾ç„¶å·¨å¤§çš„å†…éƒ¨ç¢ç‰‡æ— æ³•å®¹å¿ã€‚</p>
<p><strong>slabä»buddyç³»ç»Ÿç”³è¯·ç©ºé—´ï¼Œå°†è¾ƒå¤§çš„è¿ç»­å†…å­˜æ‹†åˆ†æˆä¸€ç³»åˆ—è¾ƒå°çš„å†…å­˜å—ã€‚</strong></p>
<p>ç”¨æˆ·ç”³è¯·ç©ºé—´æ—¶ä»slabä¸­è·å–å¤§å°æœ€ç›¸è¿‘çš„å°å—å†…å­˜ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆå‡å°‘å†…éƒ¨ç¢ç‰‡ã€‚åœ¨slabæœ€å¤§çš„å—ä¸º8Kï¼Œslabä¸­æ‰€æœ‰å—åœ¨ç‰©ç†ä¸Šä¹Ÿæ˜¯è¿ç»­çš„ã€‚</p>
<p>ä¸Šé¢è¯´çš„ç”¨äºå†…å­˜åˆ†é…çš„slabæ˜¯é€šç”¨çš„slabï¼Œä¸»è¦ç”¨äºæ”¯æŒkmallocåˆ†é…å†…å­˜ã€‚</p>
<p>slabè¿˜æœ‰ä¸€ä¸ªä½œç”¨å°±æ˜¯ç”¨ä½œå¯¹è±¡æ± ï¼Œé’ˆå¯¹ç»å¸¸åˆ†é…å’Œå›æ”¶çš„å¯¹è±¡æ¯”å¦‚task_structï¼Œå¯ä»¥åˆ†é…ä¸€ä¸ªslabå¯¹è±¡æ± å¯¹å…¶ä¼˜åŒ–ã€‚è¿™ç§slabæ˜¯ç‹¬ç«‹äºé€šç”¨çš„å†…å­˜åˆ†é…slabçš„ï¼Œåœ¨å†…æ ¸ä¸­æœ‰å¾ˆå¤šè¿™æ ·çš„é’ˆå¯¹ç‰¹å®šå¯¹è±¡çš„slabã€‚</p>
<p><strong>åœ¨å†…æ ¸ä¸­æƒ³è¦åˆ†é…ä¸€æ®µè¿ç»­çš„å†…å­˜</strong>ï¼Œé¦–å…ˆå‘slabç³»ç»Ÿç”³è¯·ï¼Œå¦‚æœä¸æ»¡è¶³ï¼ˆè¶…è¿‡ä¸¤ä¸ªé¡µé¢ï¼Œä¹Ÿå°±æ˜¯8Kï¼‰ï¼Œç›´æ¥å‘buddyç³»ç»Ÿç”³è¯·ã€‚å¦‚æœè¿˜ä¸æ»¡è¶³ï¼ˆè¶…è¿‡4Mï¼Œä¹Ÿå°±æ˜¯1024ä¸ªé¡µé¢ï¼‰ï¼Œå°†æ— æ³•è·å–åˆ°è¿ç»­çš„ç‰©ç†åœ°å€ã€‚å¯ä»¥é€šè¿‡vmallocè·å–è™šæ‹Ÿåœ°å€ç©ºé—´è¿ç»­ï¼Œä½†ç‰©ç†åœ°å€ä¸è¿ç»­çš„æ›´å¤§çš„å†…å­˜ç©ºé—´ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/buddy_algo2.png" alt></p>
<p>mallocæ˜¯ç”¨æˆ·æ€ä½¿ç”¨çš„å†…å­˜åˆ†é…æ¥å£ï¼Œæœ€ç»ˆè¿˜æ˜¯å‘buddyç”³è¯·å†…å­˜ï¼Œå› ä¸ºbuddyç³»ç»Ÿæ˜¯ç®¡ç†ç‰©ç†å†…å­˜çš„é—¨æˆ·ã€‚ç”³è¯·åˆ°å¤§å—å†…å­˜åï¼Œå†åƒslabä¸€æ ·å¯¹å…¶è¿›è¡Œç»†åˆ†ç»´æŠ¤ï¼Œæ ¹æ®ç”¨æˆ·éœ€è¦è¿”å›ç›¸åº”å†…å­˜çš„æŒ‡é’ˆã€‚</p>
<h2 id="forkå†…å­˜è¯­ä¹‰"><a href="#forkå†…å­˜è¯­ä¹‰" class="headerlink" title="forkå†…å­˜è¯­ä¹‰"></a>forkå†…å­˜è¯­ä¹‰</h2><ul>
<li>å…±äº«ä»£ç æ®µ, å­æŒ‡å‘çˆ¶ : çˆ¶å­è¿›ç¨‹å…±äº«åŒä¸€ä»£ç æ®µ, å­è¿›ç¨‹çš„é¡µè¡¨é¡¹æŒ‡å‘çˆ¶è¿›ç¨‹ç›¸åŒçš„ç‰©ç†å†…å­˜é¡µ(å³æ•°æ®æ®µ/å †æ®µ/æ ˆæ®µçš„å„é¡µ)</li>
<li>å†™æ—¶å¤åˆ¶(copy-on-write) : å†…æ ¸ä¼šæ•è·æ‰€æœ‰çˆ¶è¿›ç¨‹æˆ–å­è¿›ç¨‹é’ˆå¯¹è¿™äº›é¡µé¢(å³æ•°æ®æ®µ/å †æ®µ/æ ˆæ®µçš„å„é¡µ)çš„ä¿®æ”¹ä¼å›¾, å¹¶ä¸ºå°†è¦ä¿®æ”¹çš„é¡µé¢åˆ›å»ºæ‹·è´, å°†æ–°çš„é¡µé¢æ‹·è´åˆ†é…ç»™é­å†…æ ¸æ•è·çš„è¿›ç¨‹, ä»æ­¤çˆ¶/å­è¿›ç¨‹å¯ä»¥åˆ†åˆ«ä¿®æ”¹å„è‡ªçš„é¡µæ‹·è´, ä¸å†ç›¸äº’å½±å“.</li>
</ul>
<p>è™½ç„¶forkåˆ›å»ºçš„å­è¿›ç¨‹ä¸éœ€è¦æ‹·è´çˆ¶è¿›ç¨‹çš„ç‰©ç†å†…å­˜ç©ºé—´, ä½†æ˜¯ä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„ç©ºé—´å†…å­˜é¡µè¡¨. ä¾‹å¦‚å¯¹äº10GBçš„redisè¿›ç¨‹, éœ€è¦å¤åˆ¶çº¦20MBçš„å†…å­˜é¡µè¡¨, å› ä¸ºæ­¤forkæ“ä½œè€—æ—¶è·Ÿè¿›ç¨‹æ€»å†…å­˜é‡æ¯æ¯ç›¸å…³</p>
<h2 id="é›¶-CPU-æ‹·è´"><a href="#é›¶-CPU-æ‹·è´" class="headerlink" title="é›¶(CPU)æ‹·è´"></a>é›¶(CPU)æ‹·è´</h2><p>å‚è€ƒ <a href="https://juejin.im/post/6844903949359644680" target="_blank" rel="noopener">https://juejin.im/post/6844903949359644680</a></p>
<p>â€œå…ˆä»ç®€å•å¼€å§‹ï¼Œå®ç°ä¸‹è¿™ä¸ªåœºæ™¯ï¼šä»ä¸€ä¸ªæ–‡ä»¶ä¸­è¯»å‡ºæ•°æ®å¹¶å°†æ•°æ®ä¼ åˆ°å¦ä¸€å°æœåŠ¡å™¨ä¸Šï¼Ÿâ€<br>å¤§æ¦‚ä¼ªä»£ç å¦‚ä¸‹:<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">File.read(file, buf, len);</span><br><span class="line">Socket.send(socket, buf, len);</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹å‡º, è¿™æ ·æ•ˆç‡æ˜¯å¾ˆä½çš„. </p>
<p>ä¸‹å›¾åˆ†åˆ«å¯¹åº”ä¼ ç»Ÿ I/O æ“ä½œçš„æ•°æ®è¯»å†™æµç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹æ¶‰åŠ 2 æ¬¡ CPU æ‹·è´ã€2 æ¬¡ DMA æ‹·è´æ€»å…± 4 æ¬¡æ‹·è´ï¼Œä»¥åŠ 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä¸‹é¢ç®€å•åœ°é˜è¿°ä¸€ä¸‹ç›¸å…³çš„æ¦‚å¿µã€‚<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/traditional_io.jpg" alt></p>
<ul>
<li>ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šå½“ç”¨æˆ·ç¨‹åºå‘å†…æ ¸å‘èµ·ç³»ç»Ÿè°ƒç”¨æ—¶ï¼ŒCPU å°†ç”¨æˆ·è¿›ç¨‹ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼›å½“ç³»ç»Ÿè°ƒç”¨è¿”å›æ—¶ï¼ŒCPU å°†ç”¨æˆ·è¿›ç¨‹ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€ã€‚</li>
<li>CPUæ‹·è´ï¼šç”± CPU ç›´æ¥å¤„ç†æ•°æ®çš„ä¼ é€ï¼Œæ•°æ®æ‹·è´æ—¶ä¼šä¸€ç›´å ç”¨ CPU çš„èµ„æºã€‚</li>
<li>DMAæ‹·è´ï¼šç”± CPU å‘DMAç£ç›˜æ§åˆ¶å™¨ä¸‹è¾¾æŒ‡ä»¤ï¼Œè®© DMA æ§åˆ¶å™¨æ¥å¤„ç†æ•°æ®çš„ä¼ é€ï¼Œæ•°æ®ä¼ é€å®Œæ¯•å†æŠŠä¿¡æ¯åé¦ˆç»™ CPUï¼Œä»è€Œå‡è½»äº† CPU èµ„æºçš„å æœ‰ç‡ã€‚</li>
</ul>
<h3 id="ä¼ ç»Ÿè¯»æ“ä½œ"><a href="#ä¼ ç»Ÿè¯»æ“ä½œ" class="headerlink" title="ä¼ ç»Ÿè¯»æ“ä½œ"></a>ä¼ ç»Ÿè¯»æ“ä½œ</h3><p>å½“åº”ç”¨ç¨‹åºæ‰§è¡Œ read ç³»ç»Ÿè°ƒç”¨è¯»å–ä¸€å—æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœè¿™å—æ•°æ®å·²ç»å­˜åœ¨äºç”¨æˆ·è¿›ç¨‹çš„é¡µå†…å­˜ä¸­ï¼Œå°±ç›´æ¥ä»å†…å­˜ä¸­è¯»å–æ•°æ®ï¼›å¦‚æœæ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™å…ˆå°†æ•°æ®ä»ç£ç›˜åŠ è½½æ•°æ®åˆ°å†…æ ¸ç©ºé—´çš„è¯»ç¼“å­˜ï¼ˆread bufferï¼‰ä¸­ï¼Œå†ä»è¯»ç¼“å­˜æ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹çš„é¡µå†…å­˜ä¸­ã€‚<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">read(file_fd, tmp_buf, len);</span><br></pre></td></tr></table></figure></p>
<p>å¤åˆ¶ä»£ç åŸºäºä¼ ç»Ÿçš„ I/O è¯»å–æ–¹å¼ï¼Œread ç³»ç»Ÿè°ƒç”¨ä¼šè§¦å‘ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ1 æ¬¡ DMA æ‹·è´å’Œ 1 æ¬¡ CPU æ‹·è´ï¼Œå‘èµ·æ•°æ®è¯»å–çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç”¨æˆ·è¿›ç¨‹é€šè¿‡ read() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚</li>
<li>CPUåˆ©ç”¨DMAæ§åˆ¶å™¨å°†æ•°æ®ä»ä¸»å­˜æˆ–ç¡¬ç›˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ã€‚</li>
<li>CPUå°†è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ä¸­çš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼ˆuser spaceï¼‰çš„ç”¨æˆ·ç¼“å†²åŒºï¼ˆuser bufferï¼‰ã€‚</li>
<li>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œread è°ƒç”¨æ‰§è¡Œè¿”å›ã€‚</li>
</ol>
<h3 id="ä¼ ç»Ÿå†™æ“ä½œ"><a href="#ä¼ ç»Ÿå†™æ“ä½œ" class="headerlink" title="ä¼ ç»Ÿå†™æ“ä½œ"></a>ä¼ ç»Ÿå†™æ“ä½œ</h3><p>å½“åº”ç”¨ç¨‹åºå‡†å¤‡å¥½æ•°æ®ï¼Œæ‰§è¡Œ write ç³»ç»Ÿè°ƒç”¨å‘é€ç½‘ç»œæ•°æ®æ—¶ï¼Œå…ˆå°†æ•°æ®ä»ç”¨æˆ·ç©ºé—´çš„é¡µç¼“å­˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´çš„ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ä¸­ï¼Œç„¶åå†å°†å†™ç¼“å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ°ç½‘å¡è®¾å¤‡å®Œæˆæ•°æ®å‘é€ã€‚<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">write(socket_fd, tmp_buf, len);</span><br></pre></td></tr></table></figure></p>
<p>å¤åˆ¶ä»£ç åŸºäºä¼ ç»Ÿçš„ I/O å†™å…¥æ–¹å¼ï¼Œwrite() ç³»ç»Ÿè°ƒç”¨ä¼šè§¦å‘ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ1 æ¬¡ CPU æ‹·è´å’Œ 1 æ¬¡ DMA æ‹·è´ï¼Œç”¨æˆ·ç¨‹åºå‘é€ç½‘ç»œæ•°æ®çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç”¨æˆ·è¿›ç¨‹é€šè¿‡ write() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚</li>
<li>CPU å°†ç”¨æˆ·ç¼“å†²åŒºï¼ˆuser bufferï¼‰ä¸­çš„æ•°æ®æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ã€‚</li>
<li>CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰æ‹·è´åˆ°ç½‘å¡è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</li>
<li>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œwrite ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œè¿”å›ã€‚</li>
</ol>
<h3 id="sendfile"><a href="#sendfile" class="headerlink" title="sendfile"></a>sendfile</h3><p>sendfile ç³»ç»Ÿè°ƒç”¨åœ¨ Linux å†…æ ¸ç‰ˆæœ¬ 2.1 ä¸­è¢«å¼•å…¥ï¼Œç›®çš„æ˜¯ç®€åŒ–é€šè¿‡ç½‘ç»œåœ¨ä¸¤ä¸ªé€šé“ä¹‹é—´è¿›è¡Œçš„æ•°æ®ä¼ è¾“è¿‡ç¨‹ã€‚sendfile ç³»ç»Ÿè°ƒç”¨çš„å¼•å…¥ï¼Œä¸ä»…å‡å°‘äº† CPU æ‹·è´çš„æ¬¡æ•°ï¼Œè¿˜å‡å°‘äº†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¬¡æ•°ï¼Œå®ƒçš„ä¼ªä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sendfile(socket_fd, file_fd, len);</span><br></pre></td></tr></table></figure></p>
<p>å¤åˆ¶ä»£ç é€šè¿‡ sendfile ç³»ç»Ÿè°ƒç”¨ï¼Œæ•°æ®å¯ä»¥ç›´æ¥åœ¨å†…æ ¸ç©ºé—´å†…éƒ¨è¿›è¡Œ I/O ä¼ è¾“ï¼Œä»è€Œçœå»äº†æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´çš„æ¥å›æ‹·è´ã€‚ä¸ mmap å†…å­˜æ˜ å°„æ–¹å¼ä¸åŒçš„æ˜¯ï¼Œ sendfile è°ƒç”¨ä¸­ I/O æ•°æ®å¯¹ç”¨æˆ·ç©ºé—´æ˜¯å®Œå…¨ä¸å¯è§çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™æ˜¯ä¸€æ¬¡å®Œå…¨æ„ä¹‰ä¸Šçš„æ•°æ®ä¼ è¾“è¿‡ç¨‹ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/sendfile1.jpg" alt></p>
<p>åŸºäº sendfile ç³»ç»Ÿè°ƒç”¨çš„é›¶æ‹·è´æ–¹å¼ï¼Œæ•´ä¸ªæ‹·è´è¿‡ç¨‹ä¼šå‘ç”Ÿ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ1 æ¬¡ CPU æ‹·è´å’Œ 2 æ¬¡ DMA æ‹·è´ï¼Œç”¨æˆ·ç¨‹åºè¯»å†™æ•°æ®çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç”¨æˆ·è¿›ç¨‹é€šè¿‡ sendfile() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚</li>
<li>CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ä¸»å­˜æˆ–ç¡¬ç›˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ã€‚</li>
<li>CPU å°†è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ä¸­çš„æ•°æ®æ‹·è´åˆ°çš„ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ã€‚</li>
<li>CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰æ‹·è´åˆ°ç½‘å¡è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</li>
<li>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œsendfile ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œè¿”å›ã€‚</li>
</ol>
<p>ç›¸æ¯”è¾ƒäº mmap å†…å­˜æ˜ å°„çš„æ–¹å¼ï¼Œsendfile å°‘äº† 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ˜¯ä»ç„¶æœ‰ 1 æ¬¡ CPU æ‹·è´æ“ä½œã€‚sendfile å­˜åœ¨çš„é—®é¢˜æ˜¯ç”¨æˆ·ç¨‹åºä¸èƒ½å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œè€Œåªæ˜¯å•çº¯åœ°å®Œæˆäº†ä¸€æ¬¡æ•°æ®ä¼ è¾“è¿‡ç¨‹ã€‚</p>
<p>â€œè¿™æ ·ç¡®å®æ”¹å–„äº†å¾ˆå¤šï¼Œä½†è¿˜æ²¡è¾¾åˆ°é›¶æ‹·è´çš„è¦æ±‚ï¼ˆè¿˜æœ‰ä¸€æ¬¡cpuå‚ä¸çš„æ‹·è´ï¼‰ï¼Œè¿˜æœ‰å…¶å®ƒé»‘æŠ€æœ¯ï¼Ÿâ€<br>â€œå¯¹çš„ï¼Œå¦‚æœåº•å±‚ç½‘ç»œæ¥å£å¡æ”¯æŒæ”¶é›†(gather)æ“ä½œçš„è¯ï¼Œå°±å¯ä»¥è¿›ä¸€æ­¥çš„ä¼˜åŒ–ã€‚â€<br>â€œæ€ä¹ˆè¯´ï¼Ÿâ€<br>â€œç»§ç»­çœ‹ä¸‹ä¸€å°èŠ‚â€  </p>
<h3 id="sendfile-DMA-gather-copy"><a href="#sendfile-DMA-gather-copy" class="headerlink" title="sendfile + DMA gather copy"></a>sendfile + DMA gather copy</h3><p>Linux 2.4 ç‰ˆæœ¬çš„å†…æ ¸å¯¹ sendfile ç³»ç»Ÿè°ƒç”¨è¿›è¡Œä¿®æ”¹ï¼Œå¦‚æœåº•å±‚ç½‘ç»œæ¥å£å¡æ”¯æŒæ”¶é›†(gather)æ“ä½œçš„è¯, ä¸º  DMA æ‹·è´å¼•å…¥äº† gather æ“ä½œã€‚å®ƒå°†å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ä¸­å¯¹åº”çš„æ•°æ®æè¿°ä¿¡æ¯ï¼ˆå†…å­˜åœ°å€ã€åœ°å€åç§»é‡ï¼‰è®°å½•åˆ°ç›¸åº”çš„ç½‘ç»œç¼“å†²åŒºï¼ˆ socket  bufferï¼‰ä¸­ï¼Œç”± DMA æ ¹æ®å†…å­˜åœ°å€ã€åœ°å€åç§»é‡å°†æ•°æ®æ‰¹é‡åœ°ä»è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰æ‹·è´åˆ°ç½‘å¡è®¾å¤‡ä¸­ï¼Œè¿™æ ·å°±çœå»äº†å†…æ ¸ç©ºé—´ä¸­ä»…å‰©çš„ 1 æ¬¡ CPU æ‹·è´æ“ä½œï¼Œsendfile çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sendfile(socket_fd, file_fd, len);</span><br></pre></td></tr></table></figure></p>
<p>å¤åˆ¶ä»£ç åœ¨ç¡¬ä»¶çš„æ”¯æŒä¸‹ï¼Œsendfile æ‹·è´æ–¹å¼ä¸å†ä»å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºï¼Œå–è€Œä»£ä¹‹çš„ä»…ä»…æ˜¯ç¼“å†²åŒºæ–‡ä»¶æè¿°ç¬¦å’Œæ•°æ®é•¿åº¦çš„æ‹·è´ï¼Œè¿™æ · DMA å¼•æ“ç›´æ¥åˆ©ç”¨ gather æ“ä½œå°†é¡µç¼“å­˜ä¸­æ•°æ®æ‰“åŒ…å‘é€åˆ°ç½‘ç»œä¸­å³å¯ï¼Œæœ¬è´¨å°±æ˜¯å’Œè™šæ‹Ÿå†…å­˜æ˜ å°„çš„æ€è·¯ç±»ä¼¼ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/sendfile2.jpg" alt></p>
<p>åŸºäº sendfile + DMA gather copy ç³»ç»Ÿè°ƒç”¨çš„é›¶æ‹·è´æ–¹å¼ï¼Œæ•´ä¸ªæ‹·è´è¿‡ç¨‹ä¼šå‘ç”Ÿ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€0 æ¬¡ CPU æ‹·è´ä»¥åŠ 2 æ¬¡ DMA æ‹·è´ï¼Œç”¨æˆ·ç¨‹åºè¯»å†™æ•°æ®çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç”¨æˆ·è¿›ç¨‹é€šè¿‡ sendfile() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚</li>
<li>CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ä¸»å­˜æˆ–ç¡¬ç›˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ã€‚</li>
<li>CPU æŠŠè¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰å’Œæ•°æ®é•¿åº¦æ‹·è´åˆ°ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ã€‚</li>
<li>åŸºäºå·²æ‹·è´çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰å’Œæ•°æ®é•¿åº¦ï¼ŒCPU åˆ©ç”¨ DMA æ§åˆ¶å™¨çš„ gather/scatter æ“ä½œç›´æ¥æ‰¹é‡åœ°å°†æ•°æ®ä»å†…æ ¸çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰æ‹·è´åˆ°ç½‘å¡è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</li>
<li>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œsendfile ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œè¿”å›ã€‚</li>
</ol>
<p>sendfile + DMA gather copy æ‹·è´æ–¹å¼åŒæ ·å­˜åœ¨ç”¨æˆ·ç¨‹åºä¸èƒ½å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„é—®é¢˜ï¼Œè€Œä¸”æœ¬èº«éœ€è¦ç¡¬ä»¶çš„æ”¯æŒï¼Œå®ƒåªé€‚ç”¨äºå°†æ•°æ®ä»æ–‡ä»¶æ‹·è´åˆ° socket å¥—æ¥å­—ä¸Šçš„ä¼ è¾“è¿‡ç¨‹ã€‚</p>
<h1 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h1><p>åŒ…å¤´é•¿åº¦ 20ä¸ªå­—èŠ‚</p>
<h2 id="ä¸‰æ¬¡æ¡æ‰‹"><a href="#ä¸‰æ¬¡æ¡æ‰‹" class="headerlink" title="ä¸‰æ¬¡æ¡æ‰‹"></a>ä¸‰æ¬¡æ¡æ‰‹</h2><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/tcp/tcp_3_handshake.jpg" alt></p>
<h3 id="å¦‚æœç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„ackä¸¢å¤±äº†å’‹åŠ"><a href="#å¦‚æœç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„ackä¸¢å¤±äº†å’‹åŠ" class="headerlink" title="å¦‚æœç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„ackä¸¢å¤±äº†å’‹åŠ"></a>å¦‚æœç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„ackä¸¢å¤±äº†å’‹åŠ</h3><p>å½“å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯çš„SYNACKåº”ç­”åï¼Œå…¶çŠ¶æ€å˜ä¸ºESTABLISHEDï¼Œå¹¶ä¼šå‘é€ACKåŒ…ç»™æœåŠ¡ç«¯ï¼Œå‡†å¤‡å‘é€æ•°æ®äº†ã€‚å¦‚æœæ­¤æ—¶ACKåœ¨ç½‘ç»œä¸­ä¸¢å¤±ï¼ˆå¦‚ä¸Šå›¾æ‰€ç¤ºï¼‰ï¼Œè¿‡äº†è¶…æ—¶è®¡æ—¶å™¨åï¼Œé‚£ä¹ˆæœåŠ¡ç«¯ä¼šé‡æ–°å‘é€SYNACKåŒ…ï¼Œé‡ä¼ æ¬¡æ•°æ ¹æ®/proc/sys/net/ipv4/tcp_synack_retriesæ¥æŒ‡å®šï¼Œé»˜è®¤æ˜¯5æ¬¡ã€‚å¦‚æœé‡ä¼ æŒ‡å®šæ¬¡æ•°åˆ°äº†åï¼Œä»ç„¶æœªæ”¶åˆ°ACKåº”ç­”ï¼Œé‚£ä¹ˆä¸€æ®µæ—¶é—´åï¼ŒServerè‡ªåŠ¨å…³é—­è¿™ä¸ªè¿æ¥ã€‚</p>
<p>é—®é¢˜å°±åœ¨è¿™é‡Œï¼Œå®¢æˆ·ç«¯å·²ç»è®¤ä¸ºè¿æ¥å»ºç«‹ï¼Œè€ŒæœåŠ¡ç«¯åˆ™å¯èƒ½å¤„åœ¨SYN-RCVDæˆ–è€…CLOSEDï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦è€ƒè™‘è¿™ä¸¤ç§æƒ…å†µä¸‹æœåŠ¡ç«¯çš„åº”ç­”ï¼š</p>
<ul>
<li>æœåŠ¡ç«¯å¤„äºCLOSEDï¼Œå½“æ¥æ”¶åˆ°è¿æ¥å·²ç»å…³é—­çš„è¯·æ±‚æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šè¿”å›RST æŠ¥æ–‡ï¼Œå®¢æˆ·ç«¯æ¥æ”¶åˆ°åå°±ä¼šå…³é—­è¿æ¥ï¼Œå¦‚æœéœ€è¦çš„è¯åˆ™ä¼šé‡è¿ï¼Œé‚£ä¹ˆé‚£å°±æ˜¯å¦ä¸€ä¸ªä¸‰æ¬¡æ¡æ‰‹äº†ã€‚</li>
<li>æœåŠ¡ç«¯å¤„äºSYN-RCVDï¼Œæ­¤æ—¶å¦‚æœæ¥æ”¶åˆ°æ­£å¸¸çš„ACK æŠ¥æ–‡ï¼Œé‚£ä¹ˆå¾ˆå¥½ï¼Œè¿æ¥æ¢å¤ï¼Œç»§ç»­ä¼ è¾“æ•°æ®ï¼›å¦‚æœæ¥æ”¶åˆ°å†™å…¥æ•°æ®ç­‰è¯·æ±‚å‘¢ï¼Ÿæ³¨æ„äº†ï¼Œæ­¤æ—¶å†™å…¥æ•°æ®ç­‰è¯·æ±‚ä¹Ÿæ˜¯å¸¦ç€ACK æŠ¥æ–‡çš„ï¼Œå®é™…ä¸Šä¹Ÿèƒ½æ¢å¤è¿æ¥ï¼Œä½¿æœåŠ¡å™¨æ¢å¤åˆ°ESTABLISHEDçŠ¶æ€ï¼Œç»§ç»­ä¼ è¾“æ•°æ®ã€‚</li>
</ul>
<h3 id="SYN-Floodä¸SYN-Cookie"><a href="#SYN-Floodä¸SYN-Cookie" class="headerlink" title="SYN-Floodä¸SYN-Cookie"></a>SYN-Floodä¸SYN-Cookie</h3><p>æ‰€è°“SYN-Flood(SYN æ´ªæ³›æ”»å‡»)ï¼Œå°±æ˜¯åˆ©ç”¨SYNACK æŠ¥æ–‡çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨ä¼šä¸ºå®¢æˆ·ç«¯è¯·æ±‚åˆ†é…ç¼“å­˜ï¼Œé‚£ä¹ˆé»‘å®¢ï¼ˆæ”»å‡»è€…ï¼‰ï¼Œå°±å¯ä»¥ä½¿ç”¨ä¸€æ‰¹è™šå‡çš„ipå‘æœåŠ¡å™¨å¤§é‡åœ°å‘å»ºç«‹TCP è¿æ¥çš„è¯·æ±‚ï¼ŒæœåŠ¡å™¨ä¸ºè¿™äº›è™šå‡ipåˆ†é…äº†ç¼“å­˜åï¼Œå¤„åœ¨SYN_RCVDçŠ¶æ€ï¼Œå­˜æ”¾åœ¨åŠè¿æ¥é˜Ÿåˆ—ä¸­ï¼›å¦å¤–ï¼ŒæœåŠ¡å™¨å‘é€çš„è¯·æ±‚åˆä¸å¯èƒ½å¾—åˆ°å›å¤ï¼ˆipéƒ½æ˜¯å‡çš„ï¼Œèƒ½å›å¤å°±æœ‰é¬¼äº†ï¼‰ï¼Œåªèƒ½ä¸æ–­åœ°é‡å‘è¯·æ±‚ï¼Œç›´åˆ°è¾¾åˆ°è®¾å®šçš„æ—¶é—´/æ¬¡æ•°åï¼Œæ‰ä¼šå…³é—­ã€‚</p>
<p>æœåŠ¡å™¨ä¸æ–­ä¸ºè¿™äº›åŠå¼€è¿æ¥åˆ†é…èµ„æºï¼Œå¯¼è‡´æœåŠ¡å™¨çš„è¿æ¥èµ„æºè¢«æ¶ˆè€—æ®†å°½ï¼Œä¸è¿‡æ‰€å¹¸ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨SYN Cookieè¿›è¡Œç¨å¾®çš„é˜²å¾¡ä¸€ä¸‹ã€‚</p>
<p>æ‰€è°“çš„<strong>SYN Cookieé˜²å¾¡ç³»ç»Ÿ</strong>ï¼Œä¸å‰é¢æ¥æ”¶åˆ°SYN æŠ¥æ–‡å°±åˆ†é…ç¼“å­˜ä¸åŒï¼Œæ­¤æ—¶æš‚ä¸åˆ†é…èµ„æºï¼›åŒæ—¶åˆ©ç”¨SYN æŠ¥æ–‡çš„æºå’Œç›®çš„åœ°IPå’Œç«¯å£ï¼Œä»¥åŠæœåŠ¡å™¨å­˜å‚¨çš„ä¸€ä¸ªç§˜å¯†æ•°ï¼Œä½¿ç”¨å®ƒä»¬è¿›è¡Œæ•£åˆ—ï¼Œå¾—åˆ°server_isnä½œä¸ºæœåŠ¡ç«¯çš„åˆå§‹ TCP åºå·ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„SYN cookie, ç„¶åå°†SYNACK æŠ¥æ–‡ä¸­å‘é€ç»™å®¢æˆ·ç«¯ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯¹ACK æŠ¥æ–‡è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå…¶è¿”å›çš„acké‡Œçš„ç¡®è®¤å·æ­£å¥½ç­‰äºserver_isn + 1ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªåˆæ³•çš„ACKï¼Œé‚£ä¹ˆæœåŠ¡å™¨æ‰ä¼šä¸ºå…¶ç”Ÿæˆä¸€ä¸ªå…·æœ‰å¥—æ¥å­—çš„å…¨å¼€çš„è¿æ¥ã€‚(æœ‰ç‚¹ç±»ä¼¼äº<a href="#JWT">JWT</a>é‚£ä¸€å¥—æœºåˆ¶å“ˆ)</p>
<p>ç¼ºç‚¹: </p>
<ul>
<li>å¢åŠ äº†å¯†ç å­¦è¿ç®—, å¢å¤§äº†cpuæ¶ˆè€—</li>
<li>å› ä¸ºæ²¡æœ‰ä¿å­˜åŠè¿æ¥çŠ¶æ€, æ‰€ä»¥æ— æ³•å­˜å‚¨ä¸€äº›æ¯”å¦‚å¤§çª—å£/sackç­‰ä¿¡æ¯</li>
</ul>
<h2 id="å››æ¬¡æŒ¥æ‰‹"><a href="#å››æ¬¡æŒ¥æ‰‹" class="headerlink" title="å››æ¬¡æŒ¥æ‰‹"></a>å››æ¬¡æŒ¥æ‰‹</h2><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/tcp/tcp_4_handshake.jpg" alt></p>
<h3 id="timewaitçš„æ„ä¹‰"><a href="#timewaitçš„æ„ä¹‰" class="headerlink" title="timewaitçš„æ„ä¹‰"></a>timewaitçš„æ„ä¹‰</h3><ul>
<li>2mslä¹‹åç½‘ç»œä¸­çš„æ•°æ®åˆ†èŠ‚å…¨éƒ¨æ¶ˆå¤±, é˜²æ­¢å½±å“åˆ°å¤ç”¨äº†åŸç«¯å£ipçš„æ–°è¿æ¥</li>
<li>å¦‚æœbæ²¡æ”¶åˆ°æœ€åä¸€ä¸ªack, bå°±ä¼šé‡å‘fin, aå¦‚æœä¸ç»´æŠ¤ä¸€ä¸ªtimewaitå´æ”¶åˆ°äº†ä¸€ä¸ªfinä¼šæ„Ÿè§‰è«åå…¶å¦™ç„¶åå“åº”ä¸€ä¸ªrst, ç„¶åbå°±ä¼šè§£é‡Šä¸ºä¸€ä¸ªé”™è¯¯</li>
</ul>
<h2 id="timewaitå’Œclosewaitå¤ªå¤šå’‹åŠ"><a href="#timewaitå’Œclosewaitå¤ªå¤šå’‹åŠ" class="headerlink" title="timewaitå’Œclosewaitå¤ªå¤šå’‹åŠ"></a>timewaitå’Œclosewaitå¤ªå¤šå’‹åŠ</h2><ul>
<li>timewaitå¤ªå¤šå’‹åŠ? <ul>
<li>net.ipv4.tcp_tw_reuse = 1 è¡¨ç¤ºå¼€å¯é‡ç”¨ã€‚å…è®¸å°†TIME-WAIT socketsé‡æ–°ç”¨äºæ–°çš„TCPè¿æ¥ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ï¼›</li>
<li>net.ipv4.tcp_tw_recycle = 1 è¡¨ç¤ºå¼€å¯TCPè¿æ¥ä¸­TIME-WAIT socketsçš„å¿«é€Ÿå›æ”¶ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ã€‚</li>
<li>net.ipv4.tcp_fin_timeoutè¿™ä¸ªæ—¶é—´å¯ä»¥å‡å°‘åœ¨å¼‚å¸¸æƒ…å†µä¸‹æœåŠ¡å™¨ä»FIN-WAIT-2è½¬åˆ°TIME_WAITçš„æ—¶é—´ã€‚ </li>
</ul>
</li>
<li>closewaitå¤ªå¤šå’‹åŠ?<ul>
<li>è§£å†³æ–¹æ¡ˆåªæœ‰: æŸ¥ä»£ç . å› ä¸ºå¦‚æœä¸€ç›´ä¿æŒåœ¨CLOSE_WAITçŠ¶æ€ï¼Œé‚£ä¹ˆåªæœ‰ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯åœ¨å¯¹æ–¹å…³é—­è¿æ¥ä¹‹åæœåŠ¡å™¨ç¨‹åºè‡ªå·±æ²¡æœ‰è¿›ä¸€æ­¥å‘å‡ºfinä¿¡å·ã€‚æ¢å¥è¯è¯´ï¼Œå°±æ˜¯åœ¨å¯¹æ–¹è¿æ¥å…³é—­ä¹‹åï¼Œç¨‹åºé‡Œæ²¡æœ‰æ£€æµ‹åˆ°ï¼Œæˆ–è€…ç”±äºä»€ä¹ˆé€»è¾‘bugå¯¼è‡´æœåŠ¡ç«¯æ²¡æœ‰ä¸»åŠ¨å‘èµ·close, æˆ–è€…ç¨‹åºå‹æ ¹å°±å¿˜è®°äº†è¿™ä¸ªæ—¶å€™éœ€è¦å…³é—­è¿æ¥ï¼Œäºæ˜¯è¿™ä¸ªèµ„æºå°±ä¸€ç›´è¢«ç¨‹åºå ç€ã€‚</li>
</ul>
</li>
</ul>
<h2 id="tcpæ‹¥å¡æ§åˆ¶"><a href="#tcpæ‹¥å¡æ§åˆ¶" class="headerlink" title="tcpæ‹¥å¡æ§åˆ¶"></a>tcpæ‹¥å¡æ§åˆ¶</h2><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/tcp/tcp_congestion_control.png" alt></p>
<ul>
<li>å¿«é€Ÿé‡ä¼ :<br>  æŠ¥æ–‡æ®µ1æˆåŠŸæ¥æ”¶å¹¶è¢«ç¡®è®¤ACK 2ï¼Œæ¥æ”¶ç«¯çš„æœŸå¾…åºå·ä¸º2ï¼Œå½“æŠ¥æ–‡æ®µ2ä¸¢å¤±ï¼ŒæŠ¥æ–‡æ®µ3å¤±åºåˆ°æ¥ï¼Œä¸æ¥æ”¶ç«¯çš„æœŸæœ›ä¸åŒ¹é…ï¼Œæ¥æ”¶ç«¯é‡å¤å‘é€å†—ä½™ACK 2ã€‚è¿™æ ·ï¼Œå¦‚æœåœ¨è¶…æ—¶é‡ä¼ å®šæ—¶å™¨æº¢å‡ºä¹‹å‰ï¼Œæ¥æ”¶åˆ°è¿ç»­çš„ä¸‰ä¸ªé‡å¤å†—ä½™ACKï¼ˆå…¶å®æ˜¯æ”¶åˆ°4ä¸ªåŒæ ·çš„ACKï¼Œç¬¬ä¸€ä¸ªæ˜¯æ­£å¸¸çš„ï¼Œåä¸‰ä¸ªæ‰æ˜¯å†—ä½™çš„ï¼‰ï¼Œå‘é€ç«¯ä¾¿çŸ¥æ™“å“ªä¸ªæŠ¥æ–‡æ®µåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸¢å¤±äº†ï¼Œäºæ˜¯é‡å‘è¯¥æŠ¥æ–‡æ®µï¼Œä¸éœ€è¦ç­‰å¾…è¶…æ—¶é‡ä¼ å®šæ—¶å™¨æº¢å‡ºï¼Œå¤§å¤§æé«˜äº†æ•ˆç‡ã€‚è¿™ä¾¿æ˜¯å¿«é€Ÿé‡ä¼ æœºåˆ¶ã€‚</li>
<li>å¿«é€Ÿæ¢å¤</li>
<li>æ…¢å¯åŠ¨</li>
<li>æ‹¥å¡é¿å…</li>
</ul>
<h2 id="tcpæ»‘åŠ¨çª—å£"><a href="#tcpæ»‘åŠ¨çª—å£" class="headerlink" title="tcpæ»‘åŠ¨çª—å£"></a>tcpæ»‘åŠ¨çª—å£</h2><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/tcp/tcp_sliding_window1.png" alt></p>
<p>æ¯ä¸ªTCPè¿æ¥çš„ä¸¤ç«¯éƒ½ç»´æŠ¤ä¸€ç»„çª—å£ï¼šå‘é€çª—å£ç»“æ„ï¼ˆsend window structureï¼‰å’Œæ¥æ”¶çª—å£ç»“æ„ï¼ˆreceive window structureï¼‰ã€‚TCPä»¥å­—èŠ‚ä¸ºå•ä½ç»´æŠ¤å…¶çª—å£ç»“æ„ã€‚TCPå¤´éƒ¨ä¸­çš„çª—å£å¤§å°å­—æ®µç›¸å¯¹ACKå·æœ‰ä¸€ä¸ªå­—èŠ‚çš„åç§»é‡ã€‚å‘é€ç«¯è®¡ç®—å…¶å¯ç”¨çª—å£ï¼Œå³å®ƒå¯ä»¥ç«‹å³å‘é€çš„æ•°æ®é‡ã€‚å¯ç”¨çª—å£ï¼ˆå…è®¸å‘é€ä½†è¿˜æœªå‘é€ï¼‰è®¡ç®—å€¼ä¸ºæä¾›çª—å£ï¼ˆå³ç”±æ¥æ”¶ç«¯é€šå‘Šçš„çª—å£ï¼‰å¤§å°å‡å»åœ¨ä¼ ï¼ˆå·²å‘é€ä½†æœªå¾—åˆ°ç¡®è®¤ï¼‰çš„æ•°æ®é‡ã€‚å›¾ä¸­P1ã€P2ã€P3åˆ†åˆ«è®°å½•äº†çª—å£çš„å·¦è¾¹ç•Œã€ä¸‹æ¬¡å‘é€çš„åºåˆ—å·ã€å³è¾¹ç•Œã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/tcp/tcp_sliding_window2.png" alt></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ éšç€å‘é€ç«¯æ¥æ”¶åˆ°è¿”å›çš„æ•°æ®ACKï¼Œæ»‘åŠ¨çª—å£ä¹Ÿéšä¹‹å³ç§»ã€‚å‘é€ç«¯æ ¹æ®æ¥æ”¶ç«¯è¿”å›çš„ACKå¯ä»¥å¾—åˆ°ä¸¤ä¸ªé‡è¦çš„ä¿¡æ¯ï¼šä¸€æ˜¯æ¥æ”¶ç«¯æœŸæœ›æ”¶åˆ°çš„ä¸‹ä¸€ä¸ªå­—èŠ‚åºå·ï¼›äºŒæ˜¯å½“å‰çš„çª—å£å¤§å°ï¼ˆå†ç»“åˆå‘é€ç«¯å·²æœ‰çš„å…¶ä»–ä¿¡æ¯å¯ä»¥å¾—å‡ºè¿˜èƒ½å‘é€å¤šå°‘å­—èŠ‚æ•°æ®ï¼‰ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå‘é€çª—å£çš„å·¦è¾¹ç•Œåªèƒ½å³ç§»ï¼Œå› ä¸ºå®ƒæ§åˆ¶çš„æ˜¯å·²å‘é€å¹¶å—åˆ°ç¡®è®¤çš„æ•°æ®ï¼Œå…·æœ‰ç´¯ç§¯æ€§ï¼Œä¸èƒ½è¿”å›ï¼›å³è¾¹ç•Œå¯ä»¥å³ç§»ä¹Ÿå¯ä»¥å·¦ç§»ï¼ˆèƒ½å·¦ç§»çš„å³è¾¹ç•Œä¼šå¸¦æ¥ä¸€äº›ç¼ºé™·ï¼Œä¸‹æ–‡ä¼šè®²åˆ°ï¼‰ã€‚</p>
<p>æ¥æ”¶ç«¯ä¹Ÿç»´æŠ¤ä¸€ä¸ªçª—å£ç»“æ„ï¼Œä½†æ¯”å‘é€çª—å£ç®€å•ï¼ˆåªæœ‰å·¦è¾¹ç•Œå’Œå³è¾¹ç•Œï¼‰ã€‚è¯¥çª—å£ç»“æ„è®°å½•äº†å·²æ¥æ”¶å¹¶ç¡®è®¤çš„æ•°æ®ï¼Œä»¥åŠå®ƒèƒ½å¤Ÿæ¥æ”¶çš„æœ€å¤§åºåˆ—å·ï¼Œè¯¥çª—å£èƒ½ä¿è¯æ¥æ”¶æ•°æ®çš„æ­£ç¡®æ€§ï¼ˆé¿å…å­˜å‚¨é‡å¤çš„å·²æ¥æ”¶å’Œç¡®è®¤çš„æ•°æ®ï¼Œä»¥åŠé¿å…å­˜å‚¨ä¸åº”æ¥æ”¶çš„æ•°æ®ï¼‰ã€‚ç”±äºTCPçš„ç´¯ç§¯ACKç‰¹æ€§ï¼Œåªæœ‰å½“åˆ°è¾¾æ•°æ®åºåˆ—å·ç­‰äºå·¦è¾¹ç•Œæ—¶ï¼Œçª—å£æ‰èƒ½å‘å‰æ»‘åŠ¨ã€‚</p>
<h3 id="é›¶çª—å£ä¸TCPæŒç»­è®¡æ—¶å™¨"><a href="#é›¶çª—å£ä¸TCPæŒç»­è®¡æ—¶å™¨" class="headerlink" title="é›¶çª—å£ä¸TCPæŒç»­è®¡æ—¶å™¨"></a>é›¶çª—å£ä¸TCPæŒç»­è®¡æ—¶å™¨</h3><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/tcp/tcp_sliding_window3.png" alt></p>
<p>Zero Window  </p>
<p>ä¸Šå›¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå¤„ç†ç¼“æ…¢çš„Serverï¼ˆæ¥æ”¶ç«¯ï¼‰æ˜¯æ€ä¹ˆæŠŠClientï¼ˆå‘é€ç«¯ï¼‰çš„TCP Sliding Windowç»™é™æˆ0çš„ã€‚æ­¤æ—¶ï¼Œä½ ä¸€å®šä¼šé—®ï¼Œå¦‚æœWindowå˜æˆ0äº†ï¼ŒTCPä¼šæ€ä¹ˆæ ·ï¼Ÿæ˜¯ä¸æ˜¯å‘é€ç«¯å°±ä¸å‘æ•°æ®äº†ï¼Ÿæ˜¯çš„ï¼Œå‘é€ç«¯å°±ä¸å‘æ•°æ®äº†ï¼Œä½ å¯ä»¥æƒ³åƒæˆâ€œWindow Closedâ€ï¼Œé‚£ä½ ä¸€å®šè¿˜ä¼šé—®ï¼Œå¦‚æœå‘é€ç«¯ä¸å‘æ•°æ®äº†ï¼Œæ¥æ”¶æ–¹ä¸€ä¼šå„¿Window size å¯ç”¨äº†ï¼Œæ€ä¹ˆé€šçŸ¥å‘é€ç«¯å‘¢ï¼Ÿ</p>
<p>è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒTCPä½¿ç”¨äº†<strong>Zero Window ProbeæŠ€æœ¯</strong>ï¼Œç¼©å†™ä¸ºZWPï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œclientåœ¨serverçª—å£å˜æˆ0åï¼Œä¼šå‘ZWPçš„åŒ…ç»™serverï¼Œè®©serveræ¥å‘Šè¯‰clientæ­¤æ—¶serverçš„Windowå°ºå¯¸ï¼Œä¸€èˆ¬è¿™ä¸ªå€¼ä¼šè®¾ç½®æˆ3æ¬¡ï¼Œç¬¬æ¬¡å¤§çº¦30-60ç§’ï¼ˆä¸åŒçš„å®ç°å¯èƒ½ä¼šä¸ä¸€æ ·ï¼‰ã€‚å¦‚æœ3æ¬¡è¿‡åè¿˜æ˜¯0çš„è¯ï¼Œæœ‰çš„TCPå®ç°å°±ä¼šå‘RSTæŠŠé“¾æ¥æ–­äº†ã€‚</p>
<h2 id="Nagleç®—æ³•ä¸CORKç®—æ³•åŒºåˆ«"><a href="#Nagleç®—æ³•ä¸CORKç®—æ³•åŒºåˆ«" class="headerlink" title="Nagleç®—æ³•ä¸CORKç®—æ³•åŒºåˆ«"></a>Nagleç®—æ³•ä¸CORKç®—æ³•åŒºåˆ«</h2><ul>
<li><strong>corkç®—æ³•</strong>: æ‰€è°“çš„CORKå°±æ˜¯å¡å­çš„æ„æ€ï¼Œå½¢è±¡åœ°ç†è§£å°±æ˜¯ç”¨CORKå°†è¿æ¥å¡ä½ï¼Œä½¿å¾—æ•°æ®å…ˆä¸å‘å‡ºå»ï¼Œç­‰åˆ°æ‹”å»å¡å­åå†å‘å‡ºå»ã€‚è®¾ç½®è¯¥é€‰é¡¹åï¼Œå†…æ ¸ä¼šå°½åŠ›æŠŠå°æ•°æ®åŒ…æ‹¼æ¥æˆä¸€ä¸ªå¤§çš„æ•°æ®åŒ…ï¼ˆä¸€ä¸ªMTUï¼‰å†å‘é€å‡ºå»ï¼Œå½“ç„¶è‹¥ä¸€å®šæ—¶é—´åï¼ˆä¸€èˆ¬ä¸º200msï¼Œè¯¥å€¼å°šå¾…ç¡®è®¤ï¼‰ï¼Œå†…æ ¸ä»ç„¶æ²¡æœ‰ç»„åˆæˆä¸€ä¸ªMTUæ—¶ä¹Ÿå¿…é¡»å‘é€ç°æœ‰çš„æ•°æ®ï¼ˆä¸å¯èƒ½è®©æ•°æ®ä¸€ç›´ç­‰å¾…å§ï¼‰ã€‚</li>
<li><strong>Nagleç®—æ³•</strong>: åŸºæœ¬å®šä¹‰æ˜¯ä»»æ„æ—¶åˆ»ï¼Œæœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªæœªè¢«ç¡®è®¤çš„å°æ®µã€‚ æ‰€è°“â€œå°æ®µâ€ï¼ŒæŒ‡çš„æ˜¯å°äºMSSå°ºå¯¸çš„æ•°æ®å—ï¼Œæ‰€è°“â€œæœªè¢«ç¡®è®¤â€ï¼Œæ˜¯æŒ‡ä¸€ä¸ªæ•°æ®å—å‘é€å‡ºå»åï¼Œæ²¡æœ‰æ”¶åˆ°å¯¹æ–¹å‘é€çš„ACKç¡®è®¤è¯¥æ•°æ®å·²æ”¶åˆ°ã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘é€æ•°æ®é‡‡ç”¨Nagle ç®—æ³•ã€‚è¿™æ ·è™½ç„¶æé«˜äº†ç½‘ç»œååé‡ï¼Œä½†æ˜¯å®æ—¶æ€§å´é™ä½äº†ï¼Œåœ¨ä¸€äº›äº¤äº’æ€§å¾ˆå¼ºçš„åº”ç”¨ç¨‹åºæ¥è¯´æ˜¯ä¸å…è®¸çš„ï¼Œä½¿ç”¨TCP_NODELAYé€‰é¡¹å¯ä»¥ç¦æ­¢Nagle ç®—æ³•ã€‚<br>æ­¤æ—¶ï¼Œåº”ç”¨ç¨‹åºå‘å†…æ ¸é€’äº¤çš„æ¯ä¸ªæ•°æ®åŒ…éƒ½ä¼šç«‹å³å‘é€å‡ºå»ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶ç¦æ­¢äº†Nagle ç®—æ³•ï¼Œä½†ç½‘ç»œçš„ä¼ è¾“ä»ç„¶å—åˆ°TCPç¡®è®¤å»¶è¿Ÿæœºåˆ¶çš„å½±å“ã€‚</li>
</ul>
<p><strong>å¼‚åŒç‚¹</strong>:<br>Nagleç®—æ³•å’ŒCORKç®—æ³•éå¸¸ç±»ä¼¼ï¼Œä½†æ˜¯å®ƒä»¬çš„ç€çœ¼ç‚¹ä¸ä¸€æ ·ï¼ŒNagleç®—æ³•ä¸»è¦é¿å…ç½‘ç»œå› ä¸ºå¤ªå¤šçš„å°åŒ…ï¼ˆåè®®å¤´çš„æ¯”ä¾‹éå¸¸ä¹‹å¤§ï¼‰è€Œæ‹¥å¡ï¼Œè€ŒCORKç®—æ³•åˆ™æ˜¯ä¸ºäº†æé«˜ç½‘ç»œçš„åˆ©ç”¨ç‡ï¼Œä½¿å¾—æ€»ä½“ä¸Šåè®®å¤´å ç”¨çš„æ¯”ä¾‹å°½å¯èƒ½çš„å°ã€‚å¦‚æ­¤çœ‹æ¥è¿™äºŒè€…åœ¨é¿å…å‘é€å°åŒ…ä¸Šæ˜¯ä¸€è‡´çš„ï¼Œåœ¨ç”¨æˆ·æ§åˆ¶çš„å±‚é¢ä¸Šï¼ŒNagleç®—æ³•å®Œå…¨ä¸å—ç”¨æˆ·socketçš„æ§åˆ¶ï¼Œä½ åªèƒ½ç®€å•çš„è®¾ç½®TCP_NODELAYè€Œç¦ç”¨å®ƒï¼ŒCORKç®—æ³•åŒæ ·ä¹Ÿæ˜¯é€šè¿‡è®¾ç½®æˆ–è€…æ¸…é™¤TCP_CORKä½¿èƒ½æˆ–è€…ç¦ç”¨ä¹‹ï¼Œç„¶è€ŒNagleç®—æ³•å…³å¿ƒçš„æ˜¯ç½‘ç»œæ‹¥å¡é—®é¢˜ï¼Œåªè¦æ‰€æœ‰çš„ACKå›æ¥åˆ™å‘åŒ…ï¼Œè€ŒCORKç®—æ³•å´å¯ä»¥å…³å¿ƒå†…å®¹ï¼Œåœ¨å‰åæ•°æ®åŒ…å‘é€é—´éš”å¾ˆçŸ­çš„å‰æä¸‹ï¼ˆå¾ˆé‡è¦ï¼Œå¦åˆ™å†…æ ¸ä¼šå¸®ä½ å°†åˆ†æ•£çš„åŒ…å‘å‡ºï¼‰ï¼Œå³ä½¿ä½ æ˜¯åˆ†æ•£å‘é€å¤šä¸ªå°æ•°æ®åŒ…ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡ä½¿èƒ½CORKç®—æ³•å°†è¿™äº›å†…å®¹æ‹¼æ¥åœ¨ä¸€ä¸ªåŒ…å†…ï¼Œå¦‚æœæ­¤æ—¶ç”¨Nagleç®—æ³•çš„è¯ï¼Œåˆ™å¯èƒ½åšä¸åˆ°è¿™ä¸€ç‚¹ã€‚</p>
<h2 id="ACKå»¶è¿Ÿç¡®è®¤æœºåˆ¶"><a href="#ACKå»¶è¿Ÿç¡®è®¤æœºåˆ¶" class="headerlink" title="ACKå»¶è¿Ÿç¡®è®¤æœºåˆ¶"></a>ACKå»¶è¿Ÿç¡®è®¤æœºåˆ¶</h2><p>æ¥æ”¶æ–¹åœ¨æ”¶åˆ°æ•°æ®åï¼Œå¹¶ä¸ä¼šç«‹å³å›å¤ACK,è€Œæ˜¯å»¶è¿Ÿä¸€å®šæ—¶é—´ã€‚ä¸€èˆ¬ACKå»¶è¿Ÿå‘é€çš„æ—¶é—´ä¸º200msï¼Œä½†è¿™ä¸ª200mså¹¶éæ”¶åˆ°æ•°æ®åéœ€è¦å»¶è¿Ÿçš„æ—¶é—´ã€‚ç³»ç»Ÿæœ‰ä¸€ä¸ªå›ºå®šçš„å®šæ—¶å™¨æ¯éš”200msä¼šæ¥æ£€æŸ¥æ˜¯å¦éœ€è¦å‘é€ACKåŒ…ã€‚è¿™æ ·åšæœ‰ä¸¤ä¸ªç›®çš„ã€‚</p>
<ul>
<li>è¿™æ ·åšçš„ç›®çš„æ˜¯ACKæ˜¯å¯ä»¥åˆå¹¶çš„ï¼Œä¹Ÿå°±æ˜¯æŒ‡å¦‚æœè¿ç»­æ”¶åˆ°ä¸¤ä¸ªTCPåŒ…ï¼Œå¹¶ä¸ä¸€å®šéœ€è¦ACKä¸¤æ¬¡ï¼Œåªè¦å›å¤æœ€ç»ˆçš„ACKå°±å¯ä»¥äº†ï¼Œå¯ä»¥é™ä½ç½‘ç»œæµé‡ã€‚</li>
<li>å¦‚æœæ¥æ”¶æ–¹æœ‰æ•°æ®è¦å‘é€ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨å‘é€æ•°æ®çš„TCPæ•°æ®åŒ…é‡Œï¼Œå¸¦ä¸ŠACKä¿¡æ¯ã€‚è¿™æ ·åšï¼Œå¯ä»¥é¿å…å¤§é‡çš„ACKä»¥ä¸€ä¸ªå•ç‹¬çš„TCPåŒ…å‘é€ï¼Œå‡å°‘äº†ç½‘ç»œæµé‡ã€‚</li>
</ul>
<h1 id="HTTPä¸HTTPS"><a href="#HTTPä¸HTTPS" class="headerlink" title="HTTPä¸HTTPS"></a>HTTPä¸HTTPS</h1><p>ä¸‹é¢å®ä¾‹æ˜¯ä¸€ç‚¹å…¸å‹çš„ä½¿ç”¨GETæ¥ä¼ é€’æ•°æ®çš„å®ä¾‹,<br>å®¢æˆ·ç«¯è¯·æ±‚ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /hello.txt HTTP/1.1</span><br><span class="line">User-Agent: curl/7.16.3 libcurl/7.16.3 OpenSSL/0.9.7l zlib/1.2.3</span><br><span class="line">Host: www.example.com</span><br><span class="line">Accept-Language: en, mi</span><br></pre></td></tr></table></figure></p>
<p>æœåŠ¡ç«¯å“åº”:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Mon, 27 Jul 2009 12:28:53 GMT</span><br><span class="line">Server: Apache</span><br><span class="line">Last-Modified: Wed, 22 Jul 2009 19:15:56 GMT</span><br><span class="line">ETag: &quot;34aa387-d-1568eb00&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Content-Length: 51</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Content-Type: text/plain</span><br></pre></td></tr></table></figure></p>
<p>è¾“å‡ºç»“æœï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Hello World! My payload includes a trailing CRLF.</span><br></pre></td></tr></table></figure></p>
<h2 id="å®¢æˆ·ç«¯è¯·æ±‚æ¶ˆæ¯"><a href="#å®¢æˆ·ç«¯è¯·æ±‚æ¶ˆæ¯" class="headerlink" title="å®¢æˆ·ç«¯è¯·æ±‚æ¶ˆæ¯"></a>å®¢æˆ·ç«¯è¯·æ±‚æ¶ˆæ¯</h2><p>å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªHTTPè¯·æ±‚åˆ°æœåŠ¡å™¨çš„è¯·æ±‚æ¶ˆæ¯åŒ…æ‹¬ä»¥ä¸‹æ ¼å¼:  </p>
<ul>
<li>è¯·æ±‚è¡Œï¼ˆrequest lineï¼‰</li>
<li>è¯·æ±‚å¤´éƒ¨ï¼ˆheaderï¼‰</li>
<li>ç©ºè¡Œ</li>
<li>è¯·æ±‚æ•°æ®</li>
</ul>
<p>ç”±å››ä¸ªéƒ¨åˆ†ç»„æˆï¼Œä¸‹å›¾ç»™å‡ºäº†è¯·æ±‚æŠ¥æ–‡çš„ä¸€èˆ¬æ ¼å¼ã€‚<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/http/client_request_header.png" alt></p>
<h2 id="æœåŠ¡å™¨å“åº”æ¶ˆæ¯"><a href="#æœåŠ¡å™¨å“åº”æ¶ˆæ¯" class="headerlink" title="æœåŠ¡å™¨å“åº”æ¶ˆæ¯"></a>æœåŠ¡å™¨å“åº”æ¶ˆæ¯</h2><p>HTTPå“åº”ä¹Ÿç”±å››ä¸ªéƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯:  </p>
<ul>
<li>çŠ¶æ€è¡Œ</li>
<li>æ¶ˆæ¯æŠ¥å¤´</li>
<li>ç©ºè¡Œ</li>
<li>å“åº”æ­£æ–‡</li>
</ul>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/http/server_response_header.jpg" alt></p>
<h2 id="https"><a href="#https" class="headerlink" title="https"></a>https</h2><p>HTTPS åè®®ï¼ˆHyperText Transfer Protocol over Secure Socket Layerï¼‰ï¼šä¸€èˆ¬ç†è§£ä¸ºHTTP+SSL/TLSï¼Œé€šè¿‡ SSLè¯ä¹¦æ¥éªŒè¯æœåŠ¡å™¨çš„èº«ä»½ï¼Œå¹¶ä¸ºæµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡è¿›è¡ŒåŠ å¯†ã€‚</p>
<p>é‚£ä¹ˆSSL/TLSåˆæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>SSLï¼ˆSecure Socket Layerï¼Œå®‰å…¨å¥—æ¥å­—å±‚ï¼‰ï¼š1994å¹´ä¸º Netscape æ‰€ç ”å‘ï¼ŒSSL åè®®ä½äº TCP/IP åè®®ä¸å„ç§åº”ç”¨å±‚åè®®ä¹‹é—´ï¼Œä¸ºæ•°æ®é€šè®¯æä¾›å®‰å…¨æ”¯æŒã€‚</li>
<li>TLSï¼ˆTransport Layer Securityï¼Œä¼ è¾“å±‚å®‰å…¨ï¼‰ï¼šå…¶å‰èº«æ˜¯ SSLï¼Œå®ƒæœ€åˆçš„å‡ ä¸ªç‰ˆæœ¬ï¼ˆSSL 1.0ã€SSL 2.0ã€SSL 3.0ï¼‰ç”±ç½‘æ™¯å…¬å¸å¼€å‘ï¼Œ1999å¹´ä» 3.1 å¼€å§‹è¢« IETF æ ‡å‡†åŒ–å¹¶æ”¹åï¼Œå‘å±•è‡³ä»Šå·²ç»æœ‰ TLS 1.0ã€TLS 1.1ã€TLS 1.2 ä¸‰ä¸ªç‰ˆæœ¬ã€‚SSL3.0å’ŒTLS1.0ç”±äºå­˜åœ¨å®‰å…¨æ¼æ´ï¼Œå·²ç»å¾ˆå°‘è¢«ä½¿ç”¨åˆ°ã€‚TLS 1.3 æ”¹åŠ¨ä¼šæ¯”è¾ƒå¤§ï¼Œç›®å‰è¿˜åœ¨è‰æ¡ˆé˜¶æ®µï¼Œç›®å‰ä½¿ç”¨æœ€å¹¿æ³›çš„æ˜¯TLS 1.1ã€TLS 1.2ã€‚</li>
</ul>
<p>https ä¸æ˜¯ä¸€ç§æ–°çš„åè®®ï¼Œåªæ˜¯ http çš„é€šä¿¡æ¥å£éƒ¨åˆ†ä½¿ç”¨äº† ssl å’Œ tsl åè®®æ›¿ä»£ï¼ŒåŠ å…¥äº†åŠ å¯†ã€è¯ä¹¦ã€å®Œæ•´æ€§ä¿æŠ¤çš„åŠŸèƒ½ï¼Œä¸‹é¢è§£é‡Šä¸€ä¸‹åŠ å¯†å’Œè¯ä¹¦ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/http/https_ssl.png" alt></p>
<h3 id="å¯¹ç§°åŠ å¯†"><a href="#å¯¹ç§°åŠ å¯†" class="headerlink" title="å¯¹ç§°åŠ å¯†"></a>å¯¹ç§°åŠ å¯†</h3><p>ä¹Ÿå«<strong>å…±äº«å¯†é’¥åŠ å¯†</strong>, åŠ å¯†å’Œè§£å¯†å…¬ç”¨ä¸€å¥—ç§˜é’¥ï¼Œè¿™æ ·å°±ä¼šäº§ç”Ÿé—®é¢˜ï¼Œå·²å…±äº«ç§˜é’¥åŠ å¯†æ–¹å¼å¿…é¡»å°†ç§˜é’¥ä¼ é€ç»™å¯¹æ–¹ï¼Œä½†å¦‚æœé€šä¿¡è¢«ç›‘å¬ï¼Œé‚£ä¹ˆç§˜é’¥å¯èƒ½ä¼šè¢«æ³„æ¼äº§ç”Ÿå±é™©ã€‚<br>å¸¸è§å¯¹ç§°åŠ å¯†ç®—æ³•æœ‰des, aes</p>
<h3 id="éå¯¹ç§°åŠ å¯†"><a href="#éå¯¹ç§°åŠ å¯†" class="headerlink" title="éå¯¹ç§°åŠ å¯†"></a>éå¯¹ç§°åŠ å¯†</h3><p>ä¹Ÿå«<strong>å…¬å¼€ç§˜é’¥åŠ å¯†</strong>, ä½¿ç”¨ä¸€ç§éå¯¹ç§°åŠ å¯†çš„ç®—æ³•ï¼Œä½¿ç”¨ä¸€å¯¹éå¯¹ç§°çš„ç§˜é’¥ï¼Œä¸€æŠŠå«åšå…¬æœ‰ç§˜é’¥ï¼Œä¸€æŠŠå«åšç§æœ‰ç§˜é’¥ï¼Œåœ¨åŠ å¯†çš„æ—¶å€™ï¼Œé€šä¿¡çš„ä¸€æ–¹ä½¿ç”¨å…¬æœ‰ç§˜é’¥è¿›è¡ŒåŠ å¯†ï¼Œé€šä¿¡çš„å¦ä¸€æ–¹ä½¿ç”¨ç§æœ‰ç§˜é’¥è¿›è¡Œè§£å¯†ï¼Œåˆ©ç”¨è¿™ç§æ–¹å¼ä¸éœ€è¦å‘é€ç§æœ‰ç§˜é’¥ï¼Œä¹Ÿå°±ä¸å­˜åœ¨æ³„æ¼çš„é£é™©äº†ã€‚<br>å¸¸è§éå¯¹ç§°åŠ å¯†ç®—æ³•æœ‰rsa</p>
<h3 id="https-åŠ å¯†æ–¹å¼"><a href="#https-åŠ å¯†æ–¹å¼" class="headerlink" title="https åŠ å¯†æ–¹å¼"></a>https åŠ å¯†æ–¹å¼</h3><p>å› ä¸ºå…¬å¼€ç§˜é’¥åŠ å¯†çš„æ–¹å¼æ¯”å…±äº«ç§˜é’¥åŠ å¯†çš„æ–¹å¼é’¥æ¶ˆè€— cpu èµ„æºï¼Œhttps é‡‡å–äº†æ··åˆåŠ å¯†çš„æ–¹å¼ï¼Œæ¥ç»“åˆä¸¤è€…çš„ä¼˜ç‚¹ã€‚</p>
<p>åœ¨ç§˜é’¥äº¤æ¢é˜¶æ®µä½¿ç”¨å…¬å¼€åŠ å¯†çš„æ–¹å¼ï¼Œä¹‹åå»ºç«‹è¿æ¥åä½¿ç”¨å…±äº«ç§˜é’¥åŠ å¯†æ–¹å¼è¿›è¡ŒåŠ å¯†ï¼Œå¦‚ä¸‹å›¾ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/http/https_proc.png" alt></p>
<h3 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¯ä¹¦"><a href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¯ä¹¦" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¯ä¹¦"></a>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¯ä¹¦</h3><p>å› ä¸ºå…¬å¼€åŠ å¯†è¿˜å­˜åœ¨ä¸€äº›é—®é¢˜å°±æ˜¯æ— æ³•è¯æ˜å…¬å¼€ç§˜é’¥çš„æ­£ç¡®æ€§(æœ‰å¯èƒ½è¢«é»‘å®¢ä¸­é—´æ›¿æ¢æˆäº†é»‘å®¢è‡ªå·±çš„å…¬é’¥, ç„¶åé»‘å®¢ä¼ªè£…æˆæœåŠ¡å™¨/å®¢æˆ·ç«¯åšä¸­é—´è½¬å‘)ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œhttps é‡‡å–äº†æœ‰æ•°å­—è¯å®è®¤è¯æœºæ„å’Œå…¶ç›¸å…³æœºæ„é¢å‘çš„å…¬å¼€ç§˜é’¥è¯ä¹¦ï¼Œé€šä¿¡è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/http/https_ca.png" alt></p>
<p>è§£é‡Šä¸€ä¸‹ä¸Šå›¾çš„æ­¥éª¤ï¼š  </p>
<ol>
<li>æœåŠ¡å™¨å°†è‡ªå·±çš„å…¬å¼€ç§˜é’¥ä¼ åˆ°æ•°å­—è¯ä¹¦è®¤è¯æœºæ„  </li>
<li>æ•°å­—è¯ä¹¦è®¤è¯æœºæ„ä½¿ç”¨è‡ªå·±çš„ç§˜é’¥æ¥å¯¹ä¼ æ¥çš„æœåŠ¡å™¨å…¬é’¥è¿›è¡ŒåŠ å¯†ï¼Œå¹¶é¢å‘æ•°å­—è¯ä¹¦  </li>
<li>æœåŠ¡å™¨å°†ä¼ å›çš„å…¬é’¥è¯ä¹¦å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨æ•°å­—æœºæ„é¢å‘çš„å…¬å¼€ç§˜é’¥æ¥éªŒè¯è¯ä¹¦çš„æœ‰æ•ˆæ€§ï¼Œä»¥åŠå…¬å¼€ç§˜é’¥çš„çœŸå®æ€§<ul>
<li><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/https_pub_key_credential_verify.jpg" alt></li>
<li>è¯ä¹¦ç­¾åæ˜¯å…ˆå°†è¯ä¹¦ä¿¡æ¯ï¼ˆè¯ä¹¦æœºæ„åç§°ã€æœ‰æ•ˆæœŸã€æ‹¥æœ‰è€…ã€æ‹¥æœ‰è€…å…¬é’¥ï¼‰è¿›è¡Œhashï¼Œå†ç”¨CAçš„ç§æœ‰å¯†é’¥å¯¹hashå€¼åŠ å¯†è€Œç”Ÿæˆçš„ã€‚</li>
<li>æ‰€ä»¥æ‹¦æˆªè€…è™½ç„¶å¯ä»¥æ‹¦æˆªå¹¶ç¯¡æ”¹è¯ä¹¦ä¿¡æ¯ï¼ˆä¸»è¦æ˜¯æ‹¥æœ‰è€…å’Œæ‹¥æœ‰è€…çš„å…¬é’¥ï¼‰ï¼Œä½†æ˜¯ç”±äºæ‹¦æˆªè€…æ²¡æœ‰CAçš„ç§é’¥ï¼Œæ‰€ä»¥æ— æ³•ç”Ÿæˆæ­£ç¡®çš„ç­¾åï¼Œä»è€Œå¯¼è‡´å®¢æˆ·ç«¯æ‹¿åˆ°ç­¾ååï¼Œç”¨CAå…¬æœ‰å¯†é’¥å¯¹è¯ä¹¦ç­¾åè§£å¯†åå€¼ä¸ç”¨è¯ä¹¦è®¡ç®—å‡ºæ¥çš„å®é™…hashå€¼ä¸ä¸€æ ·ï¼Œä»è€Œå¾—ä¸åˆ°å®¢æˆ·ç«¯ä¿¡ä»»ã€‚(å…¶å®è¿™ä¸ªcaå…¬é’¥å’Œç§é’¥ä¹Ÿå°±æ˜¯éå¯¹ç§°åŠ å¯†çš„æ€æƒ³äº†)</li>
</ul>
</li>
<li>å®¢æˆ·ç«¯ä½¿ç”¨æœåŠ¡å™¨çš„å…¬å¼€ç§˜é’¥è¿›è¡Œæ¶ˆæ¯åŠ å¯†ï¼Œåå‘é€ç»™æœåŠ¡å™¨ã€‚  </li>
<li>æœåŠ¡å™¨ä½¿ç”¨ç§æœ‰ç§˜é’¥è¿›è¡Œè§£å¯†ã€‚</li>
</ol>
<p>æµè§ˆå™¨åœ¨å®‰è£…çš„æ—¶å€™ä¼šå†…ç½®å¯ä¿¡çš„æ•°å­—è¯ä¹¦æœºæ„çš„å…¬å¼€ç§˜é’¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/http/https_browser_ca.png" alt></p>
<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä½¿ç”¨è‡ªå·±ç”Ÿæˆçš„è¯ä¹¦çš„æ—¶å€™ä¼šäº§ç”Ÿå®‰å…¨è­¦å‘Šçš„åŸå› ã€‚</p>
<p>å†é™„ä¸€å¼  https çš„å…·ä½“é€šä¿¡æ­¥éª¤å’Œå›¾è§£ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/http/https_hand_shake2.png" alt></p>
<h2 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h2><p>æœåŠ¡å™¨å‘é€çš„å“åº”æŠ¥æ–‡åŒ…å« Set-Cookie é¦–éƒ¨å­—æ®µï¼Œå®¢æˆ·ç«¯å¾—åˆ°å“åº”æŠ¥æ–‡åæŠŠ Cookie å†…å®¹ä¿å­˜åˆ°æµè§ˆå™¨ä¸­ã€‚<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HTTP/1.0 200 OK</span><br><span class="line">Content-type: text/html</span><br><span class="line">Set-Cookie: yummy_cookie=choco</span><br><span class="line">Set-Cookie: tasty_cookie=strawberry</span><br></pre></td></tr></table></figure></p>
<p>å®¢æˆ·ç«¯ä¹‹åå¯¹åŒä¸€ä¸ªæœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œä¼šä»æµè§ˆå™¨ä¸­å–å‡º Cookie ä¿¡æ¯å¹¶é€šè¿‡ Cookie è¯·æ±‚é¦–éƒ¨å­—æ®µå‘é€ç»™æœåŠ¡å™¨ã€‚<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /sample_page.html HTTP/1.1</span><br><span class="line">Host: www.example.org</span><br><span class="line">Cookie: yummy_cookie=choco; tasty_cookie=strawberry</span><br></pre></td></tr></table></figure></p>
<p>Domain æ ‡è¯†æŒ‡å®šäº†å“ªäº›ä¸»æœºå¯ä»¥æ¥å— Cookieã€‚å¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤ä¸ºå½“å‰æ–‡æ¡£çš„ä¸»æœºï¼ˆä¸åŒ…å«å­åŸŸåï¼‰ã€‚å¦‚æœæŒ‡å®šäº† Domainï¼Œåˆ™ä¸€èˆ¬åŒ…å«å­åŸŸåã€‚ä¾‹å¦‚ï¼Œå¦‚æœè®¾ç½® Domain=mozilla.orgï¼Œåˆ™ Cookie ä¹ŸåŒ…å«åœ¨å­åŸŸåä¸­ï¼ˆå¦‚ developer.mozilla.orgï¼‰ã€‚</p>
<p>Path æ ‡è¯†æŒ‡å®šäº†ä¸»æœºä¸‹çš„å“ªäº›è·¯å¾„å¯ä»¥æ¥å— Cookieï¼ˆè¯¥ URL è·¯å¾„å¿…é¡»å­˜åœ¨äºè¯·æ±‚ URL ä¸­ï¼‰ã€‚ä»¥å­—ç¬¦ %x2F (â€œ/â€œ) ä½œä¸ºè·¯å¾„åˆ†éš”ç¬¦ï¼Œå­è·¯å¾„ä¹Ÿä¼šè¢«åŒ¹é…ã€‚ä¾‹å¦‚ï¼Œè®¾ç½® Path=/docsï¼Œåˆ™ä»¥ä¸‹åœ°å€éƒ½ä¼šåŒ¹é…ï¼š</p>
<ul>
<li><code>/docs</code></li>
<li><code>/docs/Web/</code></li>
<li><code>/docs/Web/HTTP</code></li>
</ul>
<h2 id="sessionå¦‚ä½•ä¿å­˜è¾ƒå¥½"><a href="#sessionå¦‚ä½•ä¿å­˜è¾ƒå¥½" class="headerlink" title="sessionå¦‚ä½•ä¿å­˜è¾ƒå¥½"></a>sessionå¦‚ä½•ä¿å­˜è¾ƒå¥½</h2><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/http/session_server.jpg" alt></p>
<p>ä¸€ä¸ªç”¨æˆ·çš„ Session ä¿¡æ¯å¦‚æœå­˜å‚¨åœ¨ä¸€ä¸ªæœåŠ¡å™¨ä¸Šï¼Œé‚£ä¹ˆå½“è´Ÿè½½å‡è¡¡å™¨æŠŠç”¨æˆ·çš„ä¸‹ä¸€ä¸ªè¯·æ±‚è½¬å‘åˆ°å¦ä¸€ä¸ªæœåŠ¡å™¨ï¼Œç”±äºæœåŠ¡å™¨æ²¡æœ‰ç”¨æˆ·çš„ Session ä¿¡æ¯ï¼Œé‚£ä¹ˆè¯¥ç”¨æˆ·å°±éœ€è¦é‡æ–°è¿›è¡Œç™»å½•ç­‰æ“ä½œ..æœ‰ä»€ä¹ˆå¥½çš„è§£å†³æ–¹æ¡ˆå‘¢?<br>Session Serverä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„æœåŠ¡å™¨å­˜å‚¨ Session æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ä¼ ç»Ÿçš„ MySQLï¼Œä¹Ÿä½¿ç”¨ Redis æˆ–è€… Memcached è¿™ç§å†…å­˜å‹æ•°æ®åº“ã€‚  </p>
<ul>
<li>ä¼˜ç‚¹ï¼š<br>  ä¸ºäº†ä½¿å¾—å¤§å‹ç½‘ç«™å…·æœ‰ä¼¸ç¼©æ€§ï¼Œé›†ç¾¤ä¸­çš„åº”ç”¨æœåŠ¡å™¨é€šå¸¸éœ€è¦ä¿æŒæ— çŠ¶æ€ï¼Œé‚£ä¹ˆåº”ç”¨æœåŠ¡å™¨ä¸èƒ½å­˜å‚¨ç”¨æˆ·çš„ä¼šè¯ä¿¡æ¯ã€‚Session Server å°†ç”¨æˆ·çš„ä¼šè¯ä¿¡æ¯å•ç‹¬è¿›è¡Œå­˜å‚¨ï¼Œä»è€Œä¿è¯äº†åº”ç”¨æœåŠ¡å™¨çš„æ— çŠ¶æ€ã€‚</li>
<li>ç¼ºç‚¹ï¼š<br>  éœ€è¦å»å®ç°å­˜å– Session çš„ä»£ç </li>
</ul>
<h2 id="cookieå’Œsessionå’Œtokençš„åŒºåˆ«"><a href="#cookieå’Œsessionå’Œtokençš„åŒºåˆ«" class="headerlink" title="cookieå’Œsessionå’Œtokençš„åŒºåˆ«"></a>cookieå’Œsessionå’Œtokençš„åŒºåˆ«</h2><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/http/cookie_session.png" alt></p>
<ul>
<li><strong>ç”±äºHTTPåè®®æ˜¯æ— çŠ¶æ€çš„åè®®ï¼Œæ‰€ä»¥æœåŠ¡ç«¯éœ€è¦è®°å½•ç”¨æˆ·çš„çŠ¶æ€æ—¶ï¼Œå°±éœ€è¦ç”¨æŸç§æœºåˆ¶æ¥è¯†å…·ä½“çš„ç”¨æˆ·ï¼Œè¿™ä¸ªæœºåˆ¶å°±æ˜¯Session</strong>.å…¸å‹çš„åœºæ™¯æ¯”å¦‚è´­ç‰©è½¦ï¼Œå½“ä½ ç‚¹å‡»ä¸‹å•æŒ‰é’®æ—¶ï¼Œç”±äºHTTPåè®®æ— çŠ¶æ€ï¼Œæ‰€ä»¥å¹¶ä¸çŸ¥é“æ˜¯å“ªä¸ªç”¨æˆ·æ“ä½œçš„ï¼Œæ‰€ä»¥æœåŠ¡ç«¯è¦ä¸ºç‰¹å®šçš„ç”¨æˆ·åˆ›å»ºäº†ç‰¹å®šçš„Sessionï¼Œç”¨ç”¨äºæ ‡è¯†è¿™ä¸ªç”¨æˆ·ï¼Œå¹¶ä¸”è·Ÿè¸ªç”¨æˆ·ï¼Œè¿™æ ·æ‰çŸ¥é“è´­ç‰©è½¦é‡Œé¢æœ‰å‡ æœ¬ä¹¦ã€‚è¿™ä¸ªSessionæ˜¯ä¿å­˜åœ¨æœåŠ¡ç«¯çš„ï¼Œæœ‰ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ã€‚åœ¨æœåŠ¡ç«¯ä¿å­˜Sessionçš„æ–¹æ³•å¾ˆå¤šï¼Œå†…å­˜ã€æ•°æ®åº“ã€æ–‡ä»¶éƒ½æœ‰ã€‚é›†ç¾¤çš„æ—¶å€™ä¹Ÿè¦è€ƒè™‘Sessionçš„è½¬ç§»ï¼Œåœ¨å¤§å‹çš„ç½‘ç«™ï¼Œä¸€èˆ¬ä¼šæœ‰ä¸“é—¨çš„SessionæœåŠ¡å™¨é›†ç¾¤ï¼Œç”¨æ¥ä¿å­˜ç”¨æˆ·ä¼šè¯ï¼Œè¿™ä¸ªæ—¶å€™ Session ä¿¡æ¯éƒ½æ˜¯æ”¾åœ¨å†…å­˜çš„ï¼Œä½¿ç”¨ä¸€äº›ç¼“å­˜æœåŠ¡æ¯”å¦‚Memcachedä¹‹ç±»çš„æ¥æ”¾ Sessionã€‚</li>
<li><strong>æ€è€ƒä¸€ä¸‹æœåŠ¡ç«¯å¦‚ä½•è¯†åˆ«ç‰¹å®šçš„å®¢æˆ·ï¼Ÿè¿™ä¸ªæ—¶å€™Cookieå°±ç™»åœºäº†</strong>ã€‚æ¯æ¬¡HTTPè¯·æ±‚çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯éƒ½ä¼šå‘é€ç›¸åº”çš„Cookieä¿¡æ¯åˆ°æœåŠ¡ç«¯ã€‚å®é™…ä¸Šå¤§å¤šæ•°çš„åº”ç”¨éƒ½æ˜¯ç”¨ Cookie æ¥å®ç°Sessionè·Ÿè¸ªçš„ï¼Œç¬¬ä¸€æ¬¡åˆ›å»ºSessionçš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯ä¼šåœ¨HTTPåè®®ä¸­å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œéœ€è¦åœ¨ Cookie é‡Œé¢è®°å½•ä¸€ä¸ªSession IDï¼Œä»¥åæ¯æ¬¡è¯·æ±‚æŠŠè¿™ä¸ªä¼šè¯IDå‘é€åˆ°æœåŠ¡å™¨ï¼Œæˆ‘å°±çŸ¥é“ä½ æ˜¯è°äº†ã€‚æœ‰äººé—®ï¼Œå¦‚æœå®¢æˆ·ç«¯çš„æµè§ˆå™¨ç¦ç”¨äº† Cookie æ€ä¹ˆåŠï¼Ÿä¸€èˆ¬è¿™ç§æƒ…å†µä¸‹ï¼Œä¼šä½¿ç”¨ä¸€ç§å«åšURLé‡å†™çš„æŠ€æœ¯æ¥è¿›è¡Œä¼šè¯è·Ÿè¸ªï¼Œå³æ¯æ¬¡HTTPäº¤äº’ï¼ŒURLåé¢éƒ½ä¼šè¢«é™„åŠ ä¸Šä¸€ä¸ªè¯¸å¦‚ sid=xxxxx è¿™æ ·çš„å‚æ•°ï¼ŒæœåŠ¡ç«¯æ®æ­¤æ¥è¯†åˆ«ç”¨æˆ·ã€‚</li>
<li><strong>Cookieå…¶å®è¿˜å¯ä»¥ç”¨åœ¨ä¸€äº›æ–¹ä¾¿ç”¨æˆ·çš„åœºæ™¯ä¸‹</strong>ï¼Œè®¾æƒ³ä½ æŸæ¬¡ç™»é™†è¿‡ä¸€ä¸ªç½‘ç«™ï¼Œä¸‹æ¬¡ç™»å½•çš„æ—¶å€™ä¸æƒ³å†æ¬¡è¾“å…¥è´¦å·äº†ï¼Œæ€ä¹ˆåŠï¼Ÿè¿™ä¸ªä¿¡æ¯å¯ä»¥å†™åˆ°Cookieé‡Œé¢ï¼Œè®¿é—®ç½‘ç«™çš„æ—¶å€™ï¼Œç½‘ç«™é¡µé¢çš„è„šæœ¬å¯ä»¥è¯»å–è¿™ä¸ªä¿¡æ¯ï¼Œå°±è‡ªåŠ¨å¸®ä½ æŠŠç”¨æˆ·åç»™å¡«äº†ï¼Œèƒ½å¤Ÿæ–¹ä¾¿ä¸€ä¸‹ç”¨æˆ·ã€‚è¿™ä¹Ÿæ˜¯Cookieåç§°çš„ç”±æ¥ï¼Œç»™ç”¨æˆ·çš„ä¸€ç‚¹ç”œå¤´ã€‚æ‰€ä»¥ï¼Œæ€»ç»“ä¸€ä¸‹ï¼šSessionæ˜¯åœ¨æœåŠ¡ç«¯ä¿å­˜çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œç”¨æ¥è·Ÿè¸ªç”¨æˆ·çš„çŠ¶æ€ï¼Œè¿™ä¸ªæ•°æ®å¯ä»¥ä¿å­˜åœ¨é›†ç¾¤ã€æ•°æ®åº“ã€æ–‡ä»¶ä¸­ï¼›Cookieæ˜¯å®¢æˆ·ç«¯ä¿å­˜ç”¨æˆ·ä¿¡æ¯çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨æ¥è®°å½•ç”¨æˆ·çš„ä¸€äº›ä¿¡æ¯ï¼Œä¹Ÿæ˜¯å®ç°Sessionçš„ä¸€ç§æ–¹å¼ã€‚</li>
<li><strong>ä¸ºä»€ä¹ˆéœ€è¦tokenæ¥æ›¿ä»£sessionæœºåˆ¶? å› ä¸ºsessionçš„å­˜å‚¨å¯¹æœåŠ¡å™¨è¯´æ˜¯ä¸€ä¸ªå·¨å¤§çš„å¼€é”€</strong>ï¼Œ ä¸¥é‡çš„é™åˆ¶äº†æœåŠ¡å™¨æ‰©å±•èƒ½åŠ›ï¼Œ æ¯”å¦‚è¯´æˆ‘ç”¨ä¸¤ä¸ªæœºå™¨ç»„æˆäº†ä¸€ä¸ªé›†ç¾¤ï¼Œ å° F é€šè¿‡æœºå™¨ A ç™»å½•äº†ç³»ç»Ÿï¼Œ é‚£ session id ä¼šä¿å­˜åœ¨æœºå™¨ A ä¸Šï¼Œ å‡è®¾å° F çš„ä¸‹ä¸€æ¬¡è¯·æ±‚è¢«è½¬å‘åˆ°æœºå™¨ B æ€ä¹ˆåŠï¼Ÿ æœºå™¨ B å¯æ²¡æœ‰å° F çš„ session id å•Šã€‚æœ‰æ—¶å€™ä¼šé‡‡ç”¨ä¸€ç‚¹å°ä¼ä¿©ï¼š session sticky ï¼Œ å°±æ˜¯è®©å° F çš„è¯·æ±‚ä¸€ç›´ç²˜è¿åœ¨æœºå™¨ A ä¸Šï¼Œ ä½†æ˜¯è¿™ä¹Ÿä¸ç®¡ç”¨ï¼Œ è¦æ˜¯æœºå™¨ A æŒ‚æ‰äº†ï¼Œ è¿˜å¾—è½¬åˆ°æœºå™¨ B å»ã€‚ </li>
</ul>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»äº‹å®ä¸Šçš„tokenæ ‡å‡†<a href="#JWT">JWT</a></p>
<h3 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h3><p>sessionId çš„æ–¹å¼æœ¬è´¨æ˜¯æŠŠç”¨æˆ·çŠ¶æ€ä¿¡æ¯ç»´æŠ¤åœ¨ server ç«¯ï¼Œtoken çš„æ–¹å¼å°±æ˜¯æŠŠç”¨æˆ·çš„çŠ¶æ€ä¿¡æ¯åŠ å¯†æˆä¸€ä¸² token ä¼ ç»™å‰ç«¯ï¼Œç„¶åæ¯æ¬¡å‘è¯·æ±‚æ—¶æŠŠ token å¸¦ä¸Šï¼Œä¼ å›ç»™æœåŠ¡å™¨ç«¯ï¼›<strong>æœåŠ¡å™¨ç«¯æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œè§£æ token å¹¶ä¸”éªŒè¯ç›¸å…³ä¿¡æ¯(ç”¨jwtçš„headeré‡Œçš„åŠ å¯†æ–¹å¼ç„¶åæ ¹æ®è‡ªå·±çš„ä¸å…¬å¼€çš„å¯†é’¥æŠŠjwtä¸­çš„payloadç”¨åŠ å¯†ä¸€ä¸‹å¾—åˆ°ä¸€ä¸ªç­¾å s, ç„¶åç”¨så¯¹æ¯”çœ‹çœ‹æ˜¯ä¸æ˜¯è·Ÿjwté‡Œçš„signatureç›¸ç­‰, ç›¸ç­‰åˆ™è¯´æ˜tokenå¯¹äº†)</strong>ï¼›</p>
<p>å¤‡æ³¨: å¯¹äºæ•°æ®æ ¡éªŒï¼Œä¸“é—¨çš„æ¶ˆæ¯è®¤è¯ç ç”Ÿæˆç®—æ³•, HMAC - ä¸€ç§ä½¿ç”¨å•å‘æ•£åˆ—å‡½æ•°æ„é€ æ¶ˆæ¯è®¤è¯ç çš„æ–¹æ³•ï¼Œå…¶è¿‡ç¨‹æ˜¯ä¸å¯é€†çš„ã€å”¯ä¸€ç¡®å®šçš„ï¼Œå¹¶ä¸”ä½¿ç”¨å¯†é’¥æ¥ç”Ÿæˆè®¤è¯ç ï¼Œå…¶ç›®çš„æ˜¯é˜²æ­¢æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«ç¯¡æ”¹æˆ–ä¼ªé€ ã€‚å°†åŸå§‹æ•°æ®ä¸è®¤è¯ç ä¸€èµ·ä¼ è¾“ï¼Œæ•°æ®æ¥æ”¶ç«¯å°†åŸå§‹æ•°æ®ä½¿ç”¨ç›¸åŒå¯†é’¥å’Œç›¸åŒç®—æ³•å†æ¬¡ç”Ÿæˆè®¤è¯ç ï¼Œä¸åŸæœ‰è®¤è¯ç è¿›è¡Œæ¯”å¯¹ï¼Œæ ¡éªŒæ•°æ®çš„åˆæ³•æ€§ã€‚</p>
<p>æ‰€ä»¥è·Ÿç¬¬ä¸€ç§ç™»å½•æ–¹å¼æœ€æœ¬è´¨çš„åŒºåˆ«æ˜¯ï¼šé€šè¿‡è§£æ token çš„è®¡ç®—æ—¶é—´æ¢å–äº† session çš„å­˜å‚¨ç©ºé—´</p>
<p>ä¸šç•Œé€šç”¨çš„åŠ å¯†æ–¹å¼æ˜¯ jwt, jwt çš„å…·ä½“æ ¼å¼å¦‚å›¾ï¼š<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/http/jwt1.png" alt><br>ç®€å•çš„ä»‹ç»ä¸€ä¸‹ jwtï¼Œå®ƒä¸»è¦ç”± 3 éƒ¨åˆ†ç»„æˆï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">header å¤´éƒ¨</span><br><span class="line">&#123;</span><br><span class="line">  &quot;alg&quot;: &quot;HS256&quot;,</span><br><span class="line">  &quot;typ&quot;: &quot;JWT&quot;</span><br><span class="line">&#125;</span><br><span class="line">payload è´Ÿè½½</span><br><span class="line">&#123;</span><br><span class="line">  &quot;sub&quot;: &quot;1234567890&quot;,</span><br><span class="line">  &quot;name&quot;: &quot;John Doe&quot;,</span><br><span class="line">  &quot;iat&quot;: 1516239022,</span><br><span class="line">  &quot;exp&quot;: 1555341649998</span><br><span class="line">&#125;</span><br><span class="line">signature ç­¾å</span><br><span class="line">&#123;</span><br><span class="line">  HMACSHA256(</span><br><span class="line">  base64UrlEncode(header) + &quot;.&quot; +</span><br><span class="line">  base64UrlEncode(payload),</span><br><span class="line">  your-256-bit-secret</span><br><span class="line">  ) secret base64 encoded</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>header<br>  header é‡Œé¢æè¿°åŠ å¯†ç®—æ³•å’Œ token çš„ç±»å‹ï¼Œç±»å‹ä¸€èˆ¬éƒ½æ˜¯ JWTï¼›</li>
<li>payload<br>  é‡Œé¢æ”¾çš„æ˜¯ç”¨æˆ·çš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ç§ç™»å½•æ–¹å¼ä¸­éœ€è¦ç»´æŠ¤åœ¨æœåŠ¡å™¨ç«¯ session ä¸­çš„ä¿¡æ¯ï¼›</li>
<li>signature<br>  æ˜¯å¯¹å‰ä¸¤éƒ¨åˆ†çš„ç­¾åï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºåŠ å¯†ï¼›å®ç°éœ€è¦ä¸€ä¸ªå¯†é’¥ï¼ˆsecretï¼‰ï¼Œè¿™ä¸ª secret åªæœ‰æœåŠ¡å™¨æ‰çŸ¥é“ï¼Œç„¶åä½¿ç”¨ header é‡Œé¢çš„ç®—æ³•æŒ‰ç…§å¦‚ä¸‹æ–¹æ³•æ¥åŠ å¯†ï¼š  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">HMACSHA256(</span><br><span class="line">base64UrlEncode(header) + <span class="string">"."</span> +</span><br><span class="line">base64UrlEncode(payload),</span><br><span class="line">secret)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>æ€»ä¹‹ï¼Œæœ€åçš„ <code>jwt = base64url(header) + &quot;.&quot; + base64url(payload) + &quot;.&quot; + signature</code><br>jwt å¯ä»¥æ”¾åœ¨ response ä¸­è¿”å›ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨ cookie ä¸­è¿”å›ï¼Œè¿™éƒ½æ˜¯å…·ä½“çš„è¿”å›æ–¹å¼ï¼Œå¹¶ä¸é‡è¦ã€‚<br>å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚æ—¶ï¼Œå®˜æ–¹æ¨èæ”¾åœ¨ HTTP header ä¸­ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Authorization: Bearer &lt;token&gt;</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ ·å­ç¡®å®ä¹Ÿå¯ä»¥è§£å†³ cookie è·¨åŸŸ(æ¯”å¦‚ç§»åŠ¨å¹³å°ä¸Šå¯¹cookieæ”¯æŒä¸å¥½)çš„é—®é¢˜ï¼Œä¸è¿‡å…·ä½“æ”¾åœ¨å“ªå„¿è¿˜æ˜¯æ ¹æ®ä¸šåŠ¡åœºæ™¯æ¥å®šï¼Œå¹¶æ²¡æœ‰ä¸€å®šä¹‹è§„ã€‚</p>
<h4 id="jwtè¿‡æœŸäº†å¦‚ä½•åˆ·æ–°"><a href="#jwtè¿‡æœŸäº†å¦‚ä½•åˆ·æ–°" class="headerlink" title="jwtè¿‡æœŸäº†å¦‚ä½•åˆ·æ–°"></a>jwtè¿‡æœŸäº†å¦‚ä½•åˆ·æ–°</h4><p><strong>å‰é¢è®²çš„ Tokenï¼Œéƒ½æ˜¯ Access Tokenï¼Œä¹Ÿå°±æ˜¯è®¿é—®èµ„æºæ¥å£æ—¶æ‰€éœ€è¦çš„ Tokenï¼Œè¿˜æœ‰å¦å¤–ä¸€ç§ Tokenï¼ŒRefresh Tokenï¼Œ</strong>é€šå¸¸æƒ…å†µä¸‹ï¼ŒRefresh Token çš„æœ‰æ•ˆæœŸä¼šæ¯”è¾ƒé•¿ï¼Œè€Œ Access Token çš„æœ‰æ•ˆæœŸæ¯”è¾ƒçŸ­ï¼Œå½“ Access Token ç”±äºè¿‡æœŸè€Œå¤±æ•ˆæ—¶ï¼Œä½¿ç”¨ Refresh Token å°±å¯ä»¥è·å–åˆ°æ–°çš„ Access Tokenï¼Œå¦‚æœ Refresh Token ä¹Ÿå¤±æ•ˆäº†ï¼Œç”¨æˆ·å°±åªèƒ½é‡æ–°ç™»å½•äº†ã€‚</p>
<p>åœ¨ JWT çš„å®è·µä¸­ï¼Œå¼•å…¥ Refresh Tokenï¼Œå°†ä¼šè¯ç®¡ç†æµç¨‹æ”¹è¿›å¦‚ä¸‹:</p>
<ol>
<li>å®¢æˆ·ç«¯ä½¿ç”¨ç”¨æˆ·åå¯†ç è¿›è¡Œè®¤è¯</li>
<li>æœåŠ¡ç«¯ç”Ÿæˆæœ‰æ•ˆæ—¶é—´è¾ƒçŸ­çš„ Access Tokenï¼ˆä¾‹å¦‚ 10 åˆ†é’Ÿï¼‰ï¼Œå’Œæœ‰æ•ˆæ—¶é—´è¾ƒé•¿çš„ Refresh Tokenï¼ˆä¾‹å¦‚ 7 å¤©ï¼‰</li>
<li>å®¢æˆ·ç«¯è®¿é—®éœ€è¦è®¤è¯çš„æ¥å£æ—¶ï¼Œæºå¸¦ Access Token</li>
<li>å¦‚æœ Access Token æ²¡æœ‰è¿‡æœŸï¼ŒæœåŠ¡ç«¯é‰´æƒåè¿”å›ç»™å®¢æˆ·ç«¯éœ€è¦çš„æ•°æ®</li>
<li>å¦‚æœæºå¸¦ Access Token è®¿é—®éœ€è¦è®¤è¯çš„æ¥å£æ—¶é‰´æƒå¤±è´¥ï¼ˆä¾‹å¦‚è¿”å› 401 é”™è¯¯ï¼‰ï¼Œåˆ™å®¢æˆ·ç«¯ä½¿ç”¨ Refresh Token å‘åˆ·æ–°æ¥å£ç”³è¯·æ–°çš„ Access Token</li>
<li>å¦‚æœ Refresh Token æ²¡æœ‰è¿‡æœŸï¼ŒæœåŠ¡ç«¯å‘å®¢æˆ·ç«¯ä¸‹å‘æ–°çš„ Access Token</li>
<li>å®¢æˆ·ç«¯ä½¿ç”¨æ–°çš„ Access Token è®¿é—®éœ€è¦è®¤è¯çš„æ¥å£</li>
</ol>
<h2 id="å¸¸è§çš„HTTPç›¸åº”çŠ¶æ€ç "><a href="#å¸¸è§çš„HTTPç›¸åº”çŠ¶æ€ç " class="headerlink" title="å¸¸è§çš„HTTPç›¸åº”çŠ¶æ€ç "></a>å¸¸è§çš„HTTPç›¸åº”çŠ¶æ€ç </h2><p>æ€»ä¹‹ï¼š(ä¸€èˆ¬æ ‡å‡†ç”¨æ³•æ˜¯è¿™æ ·ç”¨å“ˆ, ä½†æ˜¯çœŸçš„å†™ä»£ç çš„æ—¶å€™å…¶å®è·Ÿget/post/putä¸€æ ·, æƒ³æ€ä¹ˆç”¨å…¨çœ‹è‡ªå·±, å‰åç«¯å¼€å‘äººå‘˜åå•†å¥½å°±è¡Œ)</p>
<ul>
<li>1XXï¼šæ¶ˆæ¯</li>
<li>2XXï¼šæˆåŠŸ</li>
<li>3XXï¼šé‡å®šå‘</li>
<li>4XXï¼šè¯·æ±‚é”™è¯¯</li>
<li>5XXã€6XXï¼šæœåŠ¡å™¨é”™è¯¯</li>
</ul>
<p>å¸¸è§çŠ¶æ€ä»£ç ã€çŠ¶æ€æè¿°çš„è¯´æ˜å¦‚ä¸‹:</p>
<ul>
<li>200 OK:<br>è¯·æ±‚å·²æˆåŠŸï¼Œè¯·æ±‚æ‰€å¸Œæœ›çš„å“åº”å¤´æˆ–æ•°æ®ä½“å°†éšæ­¤å“åº”è¿”å›ã€‚å®é™…çš„å“åº”å°†å–å†³äºæ‰€ä½¿ç”¨çš„è¯·æ±‚æ–¹æ³•ã€‚åœ¨GETè¯·æ±‚ä¸­ï¼Œå“åº”å°†åŒ…å«ä¸è¯·æ±‚çš„èµ„æºç›¸å¯¹åº”çš„å®ä½“ã€‚åœ¨POSTè¯·æ±‚ä¸­ï¼Œå“åº”å°†åŒ…å«æè¿°æˆ–æ“ä½œç»“æœçš„å®ä½“ã€‚[7]</li>
<li>301 Moved Permanently:<br>è¢«è¯·æ±‚çš„èµ„æºå·²æ°¸ä¹…ç§»åŠ¨åˆ°æ–°ä½ç½®ï¼Œå¹¶ä¸”å°†æ¥ä»»ä½•å¯¹æ­¤èµ„æºçš„å¼•ç”¨éƒ½åº”è¯¥ä½¿ç”¨æœ¬å“åº”è¿”å›çš„è‹¥å¹²ä¸ªURIä¹‹ä¸€ã€‚å¦‚æœå¯èƒ½ï¼Œæ‹¥æœ‰é“¾æ¥ç¼–è¾‘åŠŸèƒ½çš„å®¢æˆ·ç«¯åº”å½“è‡ªåŠ¨æŠŠè¯·æ±‚çš„åœ°å€ä¿®æ”¹ä¸ºä»æœåŠ¡å™¨åé¦ˆå›æ¥çš„åœ°å€ã€‚[19]é™¤éé¢å¤–æŒ‡å®šï¼Œå¦åˆ™è¿™ä¸ªå“åº”ä¹Ÿæ˜¯å¯ç¼“å­˜çš„ã€‚<br>æ–°çš„æ°¸ä¹…æ€§çš„URIåº”å½“åœ¨å“åº”çš„LocationåŸŸä¸­è¿”å›ã€‚é™¤éè¿™æ˜¯ä¸€ä¸ªHEADè¯·æ±‚ï¼Œå¦åˆ™å“åº”çš„å®ä½“ä¸­åº”å½“åŒ…å«æŒ‡å‘æ–°çš„URIçš„è¶…é“¾æ¥åŠç®€çŸ­è¯´æ˜ã€‚<br>å¦‚æœè¿™ä¸æ˜¯ä¸€ä¸ªGETæˆ–è€…HEADè¯·æ±‚ï¼Œé‚£ä¹ˆæµè§ˆå™¨ç¦æ­¢è‡ªåŠ¨è¿›è¡Œé‡å®šå‘ï¼Œé™¤éå¾—åˆ°ç”¨æˆ·çš„ç¡®è®¤ï¼Œå› ä¸ºè¯·æ±‚çš„æ¡ä»¶å¯èƒ½å› æ­¤å‘ç”Ÿå˜åŒ–ã€‚<br>æ³¨æ„ï¼šå¯¹äºæŸäº›ä½¿ç”¨HTTP/1.0åè®®çš„æµè§ˆå™¨ï¼Œå½“å®ƒä»¬å‘é€çš„POSTè¯·æ±‚å¾—åˆ°äº†ä¸€ä¸ª301å“åº”çš„è¯ï¼Œæ¥ä¸‹æ¥çš„é‡å®šå‘è¯·æ±‚å°†ä¼šå˜æˆGETæ–¹å¼ã€‚</li>
<li>400 Bad Request<br>ç”±äºæ˜æ˜¾çš„å®¢æˆ·ç«¯é”™è¯¯ï¼ˆä¾‹å¦‚ï¼Œæ ¼å¼é”™è¯¯çš„è¯·æ±‚è¯­æ³•ï¼Œå¤ªå¤§çš„å¤§å°ï¼Œæ— æ•ˆçš„è¯·æ±‚æ¶ˆæ¯æˆ–æ¬ºéª—æ€§è·¯ç”±è¯·æ±‚ï¼‰ï¼ŒæœåŠ¡å™¨ä¸èƒ½æˆ–ä¸ä¼šå¤„ç†è¯¥è¯·æ±‚ã€‚[31]</li>
<li>401 Unauthorizedï¼ˆRFC 7235ï¼‰<br>å‚è§ï¼šHTTPåŸºæœ¬è®¤è¯ã€HTTPæ‘˜è¦è®¤è¯<br>ç±»ä¼¼äº403 Forbiddenï¼Œ401è¯­ä¹‰å³â€œæœªè®¤è¯â€ï¼Œå³ç”¨æˆ·æ²¡æœ‰å¿…è¦çš„å‡­æ®ã€‚[32]è¯¥çŠ¶æ€ç è¡¨ç¤ºå½“å‰è¯·æ±‚éœ€è¦ç”¨æˆ·éªŒè¯ã€‚è¯¥å“åº”å¿…é¡»åŒ…å«ä¸€ä¸ªé€‚ç”¨äºè¢«è¯·æ±‚èµ„æºçš„WWW-Authenticateä¿¡æ¯å¤´ç”¨ä»¥è¯¢é—®ç”¨æˆ·ä¿¡æ¯ã€‚å®¢æˆ·ç«¯å¯ä»¥é‡å¤æäº¤ä¸€ä¸ªåŒ…å«æ°å½“çš„Authorizationå¤´ä¿¡æ¯çš„è¯·æ±‚ã€‚[33]å¦‚æœå½“å‰è¯·æ±‚å·²ç»åŒ…å«äº†Authorizationè¯ä¹¦ï¼Œé‚£ä¹ˆ401å“åº”ä»£è¡¨ç€æœåŠ¡å™¨éªŒè¯å·²ç»æ‹’ç»äº†é‚£äº›è¯ä¹¦ã€‚å¦‚æœ401å“åº”åŒ…å«äº†ä¸å‰ä¸€ä¸ªå“åº”ç›¸åŒçš„èº«ä»½éªŒè¯è¯¢é—®ï¼Œä¸”æµè§ˆå™¨å·²ç»è‡³å°‘å°è¯•äº†ä¸€æ¬¡éªŒè¯ï¼Œé‚£ä¹ˆæµè§ˆå™¨åº”å½“å‘ç”¨æˆ·å±•ç¤ºå“åº”ä¸­åŒ…å«çš„å®ä½“ä¿¡æ¯ï¼Œå› ä¸ºè¿™ä¸ªå®ä½“ä¿¡æ¯ä¸­å¯èƒ½åŒ…å«äº†ç›¸å…³è¯Šæ–­ä¿¡æ¯ã€‚<br>æ³¨æ„ï¼šå½“ç½‘ç«™ï¼ˆé€šå¸¸æ˜¯ç½‘ç«™åŸŸåï¼‰ç¦æ­¢IPåœ°å€æ—¶ï¼Œæœ‰äº›ç½‘ç«™çŠ¶æ€ç æ˜¾ç¤ºçš„401ï¼Œè¡¨ç¤ºè¯¥ç‰¹å®šåœ°å€è¢«æ‹’ç»è®¿é—®ç½‘ç«™ã€‚</li>
<li>403 Forbidden<br>ä¸»æ¡ç›®ï¼šHTTP 403<br>æœåŠ¡å™¨å·²ç»ç†è§£è¯·æ±‚ï¼Œä½†æ˜¯æ‹’ç»æ‰§è¡Œå®ƒã€‚ä¸401å“åº”ä¸åŒçš„æ˜¯ï¼Œèº«ä»½éªŒè¯å¹¶ä¸èƒ½æä¾›ä»»ä½•å¸®åŠ©ï¼Œè€Œä¸”è¿™ä¸ªè¯·æ±‚ä¹Ÿä¸åº”è¯¥è¢«é‡å¤æäº¤ã€‚å¦‚æœè¿™ä¸æ˜¯ä¸€ä¸ªHEADè¯·æ±‚ï¼Œè€Œä¸”æœåŠ¡å™¨å¸Œæœ›èƒ½å¤Ÿè®²æ¸…æ¥šä¸ºä½•è¯·æ±‚ä¸èƒ½è¢«æ‰§è¡Œï¼Œé‚£ä¹ˆå°±åº”è¯¥åœ¨å®ä½“å†…æè¿°æ‹’ç»çš„åŸå› ã€‚å½“ç„¶æœåŠ¡å™¨ä¹Ÿå¯ä»¥è¿”å›ä¸€ä¸ª404å“åº”ï¼Œå‡å¦‚å®ƒä¸å¸Œæœ›è®©å®¢æˆ·ç«¯è·å¾—ä»»ä½•ä¿¡æ¯ã€‚</li>
<li>404 Not Found<br>ä¸»æ¡ç›®ï¼šHTTP 404<br>è¯·æ±‚å¤±è´¥ï¼Œè¯·æ±‚æ‰€å¸Œæœ›å¾—åˆ°çš„èµ„æºæœªè¢«åœ¨æœåŠ¡å™¨ä¸Šå‘ç°ï¼Œä½†å…è®¸ç”¨æˆ·çš„åç»­è¯·æ±‚ã€‚[35]æ²¡æœ‰ä¿¡æ¯èƒ½å¤Ÿå‘Šè¯‰ç”¨æˆ·è¿™ä¸ªçŠ¶å†µåˆ°åº•æ˜¯æš‚æ—¶çš„è¿˜æ˜¯æ°¸ä¹…çš„ã€‚å‡å¦‚æœåŠ¡å™¨çŸ¥é“æƒ…å†µçš„è¯ï¼Œåº”å½“ä½¿ç”¨410çŠ¶æ€ç æ¥å‘ŠçŸ¥æ—§èµ„æºå› ä¸ºæŸäº›å†…éƒ¨çš„é…ç½®æœºåˆ¶é—®é¢˜ï¼Œå·²ç»æ°¸ä¹…çš„ä¸å¯ç”¨ï¼Œè€Œä¸”æ²¡æœ‰ä»»ä½•å¯ä»¥è·³è½¬çš„åœ°å€ã€‚404è¿™ä¸ªçŠ¶æ€ç è¢«å¹¿æ³›åº”ç”¨äºå½“æœåŠ¡å™¨ä¸æƒ³æ­ç¤ºåˆ°åº•ä¸ºä½•è¯·æ±‚è¢«æ‹’ç»æˆ–è€…æ²¡æœ‰å…¶ä»–é€‚åˆçš„å“åº”å¯ç”¨çš„æƒ…å†µä¸‹ã€‚</li>
<li>500 Internal Server Error<br>é€šç”¨é”™è¯¯æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨é‡åˆ°äº†ä¸€ä¸ªæœªæ›¾é¢„æ–™çš„çŠ¶å†µï¼Œå¯¼è‡´äº†å®ƒæ— æ³•å®Œæˆå¯¹è¯·æ±‚çš„å¤„ç†ã€‚æ²¡æœ‰ç»™å‡ºå…·ä½“é”™è¯¯ä¿¡æ¯ã€‚[59]</li>
<li>503 Service Unavailable<br>ç”±äºä¸´æ—¶çš„æœåŠ¡å™¨ç»´æŠ¤æˆ–è€…è¿‡è½½ï¼ŒæœåŠ¡å™¨å½“å‰æ— æ³•å¤„ç†è¯·æ±‚ã€‚è¿™ä¸ªçŠ¶å†µæ˜¯æš‚æ—¶çš„ï¼Œå¹¶ä¸”å°†åœ¨ä¸€æ®µæ—¶é—´ä»¥åæ¢å¤ã€‚[62]å¦‚æœèƒ½å¤Ÿé¢„è®¡å»¶è¿Ÿæ—¶é—´ï¼Œé‚£ä¹ˆå“åº”ä¸­å¯ä»¥åŒ…å«ä¸€ä¸ªRetry-Afterå¤´ç”¨ä»¥æ ‡æ˜è¿™ä¸ªå»¶è¿Ÿæ—¶é—´ã€‚å¦‚æœæ²¡æœ‰ç»™å‡ºè¿™ä¸ªRetry-Afterä¿¡æ¯ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯åº”å½“ä»¥å¤„ç†500å“åº”çš„æ–¹å¼å¤„ç†å®ƒã€‚</li>
</ul>
<h2 id="getå’Œpostçš„æœ¬è´¨åŒºåˆ«"><a href="#getå’Œpostçš„æœ¬è´¨åŒºåˆ«" class="headerlink" title="getå’Œpostçš„æœ¬è´¨åŒºåˆ«"></a>getå’Œpostçš„æœ¬è´¨åŒºåˆ«</h2><p>ä»è®¾è®¡åˆè¡·ä¸Šæ¥è¯´ï¼ŒGET ç”¨æ¥å®ç°ä»æœåŠ¡ç«¯å–æ•°æ®ï¼ŒPOST ç”¨æ¥å®ç°å‘æœåŠ¡ç«¯æå‡ºè¯·æ±‚å¯¹æ•°æ®åšæŸäº›ä¿®æ”¹ï¼Œä¹Ÿå› æ­¤å¦‚æœä½ å‘nginxç”¨postè¯·æ±‚é™æ€æ–‡ä»¶ï¼Œnginxä¼šç›´æ¥è¿”å› 405 not allowedï¼Œä½†æ˜¯æœåŠ¡ç«¯æ¯•ç«Ÿæ˜¯äººå®ç°çš„ï¼Œä½ å¯ä»¥è®© POST åš GET ç›¸åŒçš„äº‹æƒ…</p>
<p>getè¯·æ±‚çš„å‚æ•°ä¸€èˆ¬æ”¾åœ¨urlä¸­ï¼Œä½†æ˜¯æµè§ˆå™¨å’ŒæœåŠ¡å™¨ç¨‹åºå¯¹urlé•¿åº¦è¿˜æ˜¯æœ‰é™åˆ¶çš„ã€‚<br>postè¯·æ±‚çš„å‚æ•°ä¸€èˆ¬æ”¾åœ¨bodyï¼Œä½ ç¡¬è¦æ”¾åˆ°urlä¸­ä¹Ÿå¯ä»¥ã€‚</p>
<p>åœ¨RESTfulé£æ ¼ä¸­ï¼Œgetç”¨äºä»æœåŠ¡å™¨è·è·å–æ•°æ®ï¼Œè€Œpostç”¨äºåˆ›å»ºæ•°æ®</p>
<h2 id="Connection-keep-alive"><a href="#Connection-keep-alive" class="headerlink" title="Connection: keep-alive"></a>Connection: keep-alive</h2><p>åœ¨æ—©æœŸçš„HTTP/1.0ä¸­ï¼Œæ¯æ¬¡httpè¯·æ±‚éƒ½è¦åˆ›å»ºä¸€ä¸ªè¿æ¥ï¼Œè€Œåˆ›å»ºè¿æ¥çš„è¿‡ç¨‹éœ€è¦æ¶ˆè€—èµ„æºå’Œæ—¶é—´ï¼Œä¸ºäº†å‡å°‘èµ„æºæ¶ˆè€—ï¼Œç¼©çŸ­å“åº”æ—¶é—´ï¼Œå°±éœ€è¦é‡ç”¨è¿æ¥ã€‚åœ¨åæ¥çš„HTTP/1.0ä¸­ä»¥åŠHTTP/1.1ä¸­ï¼Œå¼•å…¥äº†é‡ç”¨è¿æ¥çš„æœºåˆ¶ï¼Œå°±æ˜¯åœ¨httpè¯·æ±‚å¤´ä¸­åŠ å…¥Connection: keep-aliveæ¥å‘Šè¯‰å¯¹æ–¹è¿™ä¸ªè¯·æ±‚å“åº”å®Œæˆåä¸è¦å…³é—­ï¼Œä¸‹ä¸€æ¬¡å’±ä»¬è¿˜ç”¨è¿™ä¸ªè¯·æ±‚ç»§ç»­äº¤æµã€‚åè®®è§„å®šHTTP/1.0å¦‚æœæƒ³è¦ä¿æŒé•¿è¿æ¥ï¼Œéœ€è¦åœ¨è¯·æ±‚å¤´ä¸­åŠ ä¸ŠConnection: keep-aliveï¼Œè€ŒHTTP/1.1é»˜è®¤æ˜¯æ”¯æŒé•¿è¿æ¥çš„ï¼Œæœ‰æ²¡æœ‰è¿™ä¸ªè¯·æ±‚å¤´éƒ½è¡Œã€‚</p>
<p>è¦å®ç°é•¿è¿æ¥å¾ˆç®€å•ï¼Œåªè¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½ä¿æŒè¿™ä¸ªhttpé•¿è¿æ¥å³å¯ã€‚ä½†é—®é¢˜çš„å…³é”®åœ¨äºä¿æŒé•¿è¿æ¥åï¼Œæµè§ˆå™¨å¦‚ä½•çŸ¥é“æœåŠ¡å™¨å·²ç»å“åº”å®Œæˆï¼Ÿåœ¨ä½¿ç”¨çŸ­è¿æ¥çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨å®Œæˆå“åº”åå³å…³é—­httpè¿æ¥ï¼Œè¿™æ ·æµè§ˆå™¨å°±èƒ½çŸ¥é“å·²æ¥æ”¶åˆ°å…¨éƒ¨çš„å“åº”ï¼ŒåŒæ—¶ä¹Ÿå…³é—­è¿æ¥ï¼ˆTCPè¿æ¥æ˜¯åŒå‘çš„ï¼‰ã€‚</p>
<p>åœ¨ä½¿ç”¨é•¿è¿æ¥çš„æ—¶å€™ï¼Œå“åº”å®ŒæˆåæœåŠ¡å™¨æ˜¯ä¸èƒ½å…³é—­è¿æ¥çš„ï¼Œé‚£ä¹ˆå®ƒå°±è¦åœ¨å“åº”å¤´ä¸­åŠ ä¸Šç‰¹æ®Šæ ‡å¿—å‘Šè¯‰æµè§ˆå™¨å·²å“åº”å®Œæˆã€‚ä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªç‰¹æ®Šæ ‡å¿—å°±æ˜¯Content-Lengthï¼Œæ¥æŒ‡æ˜å“åº”ä½“çš„æ•°æ®å¤§å°ï¼Œæ¯”å¦‚Content-Length: 120è¡¨ç¤ºå“åº”ä½“å†…å®¹æœ‰120ä¸ªå­—èŠ‚ï¼Œè¿™æ ·æµè§ˆå™¨æ¥æ”¶åˆ°120ä¸ªå­—èŠ‚çš„å“åº”ä½“åå°±çŸ¥é“äº†å·²ç»å“åº”å®Œæˆã€‚</p>
<p>ç”±äºContent-Lengthå­—æ®µå¿…é¡»çœŸå®åæ˜ å“åº”ä½“é•¿åº¦ï¼Œä½†å®é™…åº”ç”¨ä¸­ï¼Œæœ‰äº›æ—¶å€™å“åº”ä½“é•¿åº¦å¹¶æ²¡é‚£ä¹ˆå¥½è·å¾—ï¼Œä¾‹å¦‚å“åº”ä½“æ¥è‡ªäºç½‘ç»œæ–‡ä»¶ï¼Œæˆ–è€…ç”±åŠ¨æ€è¯­è¨€ç”Ÿæˆã€‚è¿™æ—¶å€™è¦æƒ³å‡†ç¡®è·å–é•¿åº¦ï¼Œåªèƒ½å…ˆå¼€ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å†…å­˜ç©ºé—´ï¼Œç­‰å†…å®¹å…¨éƒ¨ç”Ÿæˆå¥½å†è®¡ç®—ã€‚ä½†è¿™æ ·åšä¸€æ–¹é¢éœ€è¦æ›´å¤§çš„å†…å­˜å¼€é”€ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿä¼šè®©å®¢æˆ·ç«¯ç­‰æ›´ä¹…ã€‚è¿™æ—¶å€™Transfer-Encoding: chunkedå“åº”å¤´å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œè¯¥å“åº”å¤´è¡¨ç¤ºå“åº”ä½“å†…å®¹ç”¨çš„æ˜¯åˆ†å—ä¼ è¾“ï¼Œæ­¤æ—¶æœåŠ¡å™¨å¯ä»¥å°†æ•°æ®ä¸€å—ä¸€å—åœ°åˆ†å—å“åº”ç»™æµè§ˆå™¨è€Œä¸å¿…ä¸€æ¬¡æ€§å…¨éƒ¨å“åº”ï¼Œå¾…æµè§ˆå™¨æ¥æ”¶åˆ°å…¨éƒ¨åˆ†å—åå°±è¡¨ç¤ºå“åº”ç»“æŸã€‚</p>
<p>å…·ä½“æ ¼å¼å¦‚ä¸‹:  </p>
<ul>
<li>å¦‚æœä¸€ä¸ªHTTPæ¶ˆæ¯ï¼ˆåŒ…æ‹¬å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚æ¶ˆæ¯æˆ–æœåŠ¡å™¨è¿”å›çš„åº”ç­”æ¶ˆæ¯ï¼‰çš„Transfer-Encodingæ¶ˆæ¯å¤´çš„å€¼ä¸ºchunkedï¼Œé‚£ä¹ˆï¼Œæ¶ˆæ¯ä½“ç”±æ•°é‡æœªå®šçš„å—ç»„æˆï¼Œå¹¶ä»¥æœ€åä¸€ä¸ªå¤§å°ä¸º0çš„å—ä¸ºç»“æŸã€‚</li>
<li>æ¯ä¸€ä¸ªéç©ºçš„å—éƒ½ä»¥è¯¥å—åŒ…å«æ•°æ®çš„å­—èŠ‚æ•°ï¼ˆå­—èŠ‚æ•°ä»¥åå…­è¿›åˆ¶è¡¨ç¤ºï¼‰å¼€å§‹ï¼Œè·Ÿéšä¸€ä¸ªCRLF ï¼ˆå›è½¦åŠæ¢è¡Œï¼‰ï¼Œç„¶åæ˜¯æ•°æ®æœ¬èº«ï¼Œæœ€åå—CRLFç»“æŸã€‚åœ¨ä¸€äº›å®ç°ä¸­ï¼Œå—å¤§å°å’ŒCRLFä¹‹é—´å¡«å……æœ‰ç™½ç©ºæ ¼ï¼ˆ0x20ï¼‰</li>
<li>æœ€åä¸€å—æ˜¯å•è¡Œï¼Œç”±å—å¤§å°ï¼ˆ0ï¼‰ï¼Œä¸€äº›å¯é€‰çš„å¡«å……ç™½ç©ºæ ¼ï¼Œä»¥åŠCRLFã€‚æœ€åä¸€å—ä¸å†åŒ…å«ä»»ä½•æ•°æ®ï¼Œä½†æ˜¯å¯ä»¥å‘é€å¯é€‰çš„å°¾éƒ¨ï¼ŒåŒ…æ‹¬æ¶ˆæ¯å¤´å­—æ®µã€‚</li>
<li>æ¶ˆæ¯æœ€åä»¥CRLFç»“å°¾ã€‚</li>
</ul>
<p>ä»¥åˆ†å—ä¼ è¾“ä¸€æ®µæ–‡æœ¬å†…å®¹ï¼šâ€œäººçš„ä¸€ç”Ÿæ€»æ˜¯åœ¨è¿½æ±‚è‡ªç”±çš„ä¸€ç”Ÿ So easyâ€æ¥è¯´æ˜åˆ†å—ä¼ è¾“çš„è¿‡ç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/http/http_alive.png" alt></p>
<h2 id="urlç¼–ç urlencodeæ˜¯ä»€ä¹ˆ"><a href="#urlç¼–ç urlencodeæ˜¯ä»€ä¹ˆ" class="headerlink" title="urlç¼–ç urlencodeæ˜¯ä»€ä¹ˆ"></a>urlç¼–ç urlencodeæ˜¯ä»€ä¹ˆ</h2><p>RFC3986æ–‡æ¡£è§„å®šï¼ŒUrlä¸­åªå…è®¸åŒ…å«è‹±æ–‡å­—æ¯ï¼ˆa-zA-Zï¼‰ã€æ•°å­—ï¼ˆ0-9ï¼‰ã€-_.~4ä¸ªç‰¹æ®Šå­—ç¬¦ä»¥åŠæ‰€æœ‰ä¿ç•™å­—ç¬¦ã€‚<br>é‚£å¦‚ä½•å¯¹Urlä¸­çš„éæ³•å­—ç¬¦è¿›è¡Œç¼–ç å‘¢?<br>â€ƒâ€ƒ<br><strong>Urlç¼–ç é€šå¸¸ä¹Ÿè¢«ç§°ä¸ºç™¾åˆ†å·ç¼–ç ï¼ˆUrl Encodingï¼Œalso known as percent-encodingï¼‰ï¼Œæ˜¯å› ä¸ºå®ƒçš„ç¼–ç æ–¹å¼éå¸¸ç®€å•ï¼Œä½¿ç”¨%ç™¾åˆ†å·åŠ ä¸Šä¸¤ä½çš„å­—ç¬¦â€”â€”0123456789ABCDEFâ€”â€”ä»£è¡¨ä¸€ä¸ªå­—èŠ‚çš„åå…­è¿›åˆ¶å½¢å¼</strong>ã€‚Urlç¼–ç é»˜è®¤ä½¿ç”¨çš„å­—ç¬¦é›†æ˜¯US-ASCIIã€‚ä¾‹å¦‚aåœ¨US-ASCIIç ä¸­å¯¹åº”çš„å­—èŠ‚æ˜¯0x61ï¼Œé‚£ä¹ˆUrlç¼–ç ä¹‹åå¾—åˆ°çš„å°±æ˜¯%61ï¼Œæˆ‘ä»¬åœ¨åœ°å€æ ä¸Šè¾“å…¥<a href="http://g.cn/search?q=%61%62%63ï¼Œ" target="_blank" rel="noopener">http://g.cn/search?q=%61%62%63ï¼Œ</a></p>
<p>å®é™…ä¸Šå°±ç­‰åŒäºåœ¨googleä¸Šæœç´¢abcäº†ã€‚åˆå¦‚@ç¬¦å·åœ¨ASCIIå­—ç¬¦é›†ä¸­å¯¹åº”çš„å­—èŠ‚ä¸º0x40ï¼Œç»è¿‡Urlç¼–ç ä¹‹åå¾—åˆ°çš„æ˜¯%40ã€‚<br>â€ƒâ€ƒ<br>â€ƒâ€ƒå¯¹äºéASCIIå­—ç¬¦ï¼Œéœ€è¦ä½¿ç”¨ASCIIå­—ç¬¦é›†çš„è¶…é›†è¿›è¡Œç¼–ç å¾—åˆ°ç›¸åº”çš„å­—èŠ‚ï¼Œç„¶åå¯¹æ¯ä¸ªå­—èŠ‚æ‰§è¡Œç™¾åˆ†å·ç¼–ç ã€‚å¯¹äºUnicodeå­—ç¬¦ï¼ŒRFCæ–‡æ¡£å»ºè®®ä½¿ç”¨utf-8å¯¹å…¶è¿›è¡Œç¼–ç å¾—åˆ°ç›¸åº”çš„å­—èŠ‚ï¼Œç„¶åå¯¹æ¯ä¸ªå­—èŠ‚æ‰§è¡Œç™¾åˆ†å·ç¼–ç ã€‚å¦‚â€ä¸­æ–‡â€ä½¿ç”¨UTF-8å­—ç¬¦é›†å¾—åˆ°çš„å­—èŠ‚ä¸º0xE4 0xB8 0xAD 0xE6 0x96 0x87ï¼Œç»è¿‡Urlç¼–ç ä¹‹åå¾—åˆ°â€%E4%B8%AD%E6%96%87â€ã€‚<br>â€ƒâ€ƒ<br>â€ƒâ€ƒå¦‚æœæŸä¸ªå­—èŠ‚å¯¹åº”ç€ASCIIå­—ç¬¦é›†ä¸­çš„æŸä¸ªéä¿ç•™å­—ç¬¦ï¼Œåˆ™æ­¤å­—èŠ‚æ— éœ€ä½¿ç”¨ç™¾åˆ†å·è¡¨ç¤ºã€‚ä¾‹å¦‚â€Urlç¼–ç â€ï¼Œä½¿ç”¨UTF-8ç¼–ç å¾—åˆ°çš„å­—èŠ‚æ˜¯0x55 0x72 0x6C 0xE7 0xBC 0x96 0xE7 0xA0 0x81ï¼Œç”±äºå‰ä¸‰ä¸ªå­—èŠ‚å¯¹åº”ç€ASCIIä¸­çš„éä¿ç•™å­—ç¬¦â€Urlâ€ï¼Œå› æ­¤è¿™ä¸‰ä¸ªå­—èŠ‚å¯ä»¥ç”¨éä¿ç•™å­—ç¬¦â€Urlâ€è¡¨ç¤ºã€‚æœ€ç»ˆçš„Urlç¼–ç å¯ä»¥ç®€åŒ–æˆâ€Url%E7%BC%96%E7%A0%81â€ ï¼Œå½“ç„¶ï¼Œå¦‚æœä½ ç”¨â€%55%72%6C%E7%BC%96%E7%A0%81â€ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<p>å¾ˆå¤šHTTPç›‘è§†å·¥å…·æˆ–è€…æµè§ˆå™¨åœ°å€æ ç­‰åœ¨æ˜¾ç¤ºUrlçš„æ—¶å€™ä¼šè‡ªåŠ¨å°†Urlè¿›è¡Œä¸€æ¬¡è§£ç ï¼ˆä½¿ç”¨UTF-8å­—ç¬¦é›†ï¼‰ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå½“ä½ åœ¨Firefoxä¸­è®¿é—®Googleæœç´¢ä¸­æ–‡çš„æ—¶å€™ï¼Œåœ°å€æ æ˜¾ç¤ºçš„UrlåŒ…å«ä¸­æ–‡çš„ç¼˜æ•…ã€‚<strong>ä½†å®é™…ä¸Šå‘é€ç»™æœåŠ¡ç«¯çš„åŸå§‹Urlè¿˜æ˜¯ç»è¿‡ç¼–ç çš„</strong>ã€‚</p>
<h1 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h1><h2 id="å‚è€ƒç½‘å€"><a href="#å‚è€ƒç½‘å€" class="headerlink" title="å‚è€ƒç½‘å€"></a>å‚è€ƒç½‘å€</h2><ul>
<li><a href="https://chenjiabing666.github.io/2020/04/20/Mysql%E6%9C%80%E5%85%A8%E9%9D%A2%E8%AF%95%E6%8C%87%E5%8D%97/" target="_blank" rel="noopener">https://chenjiabing666.github.io/2020/04/20/Mysql%E6%9C%80%E5%85%A8%E9%9D%A2%E8%AF%95%E6%8C%87%E5%8D%97/</a></li>
<li><a href="https://blog.csdn.net/qq_41011723/article/details/105953813" target="_blank" rel="noopener">https://blog.csdn.net/qq_41011723/article/details/105953813</a></li>
<li><a href="https://blog.csdn.net/qq_41011723/article/details/106028153" target="_blank" rel="noopener">https://blog.csdn.net/qq_41011723/article/details/106028153</a></li>
<li><a href="https://www.jianshu.com/p/18bad43446d1" target="_blank" rel="noopener">MySQLã€MongoDBã€Redis æ•°æ®åº“ä¹‹é—´çš„åŒºåˆ«</a></li>
</ul>
<h2 id="mysqlä¸€æ¡è¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹"><a href="#mysqlä¸€æ¡è¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="mysqlä¸€æ¡è¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹"></a>mysqlä¸€æ¡è¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹</h2><p>é€Ÿè®°: è¿/åˆ†/ä¼˜/æ‰§/å­˜</p>
<img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="http://www.plantuml.com/plantuml/svg/ZLBBJi9G4DttAsvOmo-OI731WXLBmm9jGPAcZOX6OaWK4r8YB-KH20Y24Z6chKOIDK3u6Uw3l_3YvN7RIkAgCtFkd9bpEeUoUYg22m60VMZqaFQ9NysGa184CPm87uHF9E0A98F7ikltJKILHIaEN44fVYR5uNkQbMapcRPHeGyRWn3BKQTFp1uUbw5UNvQWba7jqkR9R5o7kHhNadqctTmcjr2ckEa-BzXJeZ55uXVmAuhgyovR0qb_S3UmcglNONe0nrLKBfmpBggFamiydXtBE2vcc5MD0-QKSV6VhNQOCu6BbwqRGxYOOIkv3c0btG7OR104HKr881wB7YM06h7PZOqkBcLOoGtG_VMyKIB64p6l14aHmQBLGM3vlyJCeuygAxbffg-pxGJscu6tazcN3hK6RWxf7cHQWSqs7fLHksKdaQK8ux0S5RE065setU5A1sbq5JpiKG_cbrbqyxALnNAAg9oVJLhCE2hbFriuJcvHADPGzGtb3UhdmpVz4dC4Cus5vyN7DTCF">
<h2 id="charå’Œvarcharçš„åŒºåˆ«æ˜¯ä»€ä¹ˆ"><a href="#charå’Œvarcharçš„åŒºåˆ«æ˜¯ä»€ä¹ˆ" class="headerlink" title="charå’Œvarcharçš„åŒºåˆ«æ˜¯ä»€ä¹ˆ"></a>charå’Œvarcharçš„åŒºåˆ«æ˜¯ä»€ä¹ˆ</h2><ul>
<li>char(n) ï¼šå›ºå®šé•¿åº¦ç±»å‹ï¼Œæ¯”å¦‚è®¢é˜… char(10)ï¼Œå½“ä½ è¾“å…¥â€abcâ€ä¸‰ä¸ªå­—ç¬¦çš„æ—¶å€™ï¼Œå®ƒä»¬å çš„ç©ºé—´è¿˜æ˜¯ 10 ä¸ªå­—èŠ‚ï¼Œå…¶ä»– 7 ä¸ªæ˜¯ç©ºå­—èŠ‚ã€‚<ul>
<li>chat ä¼˜ç‚¹ï¼šæ•ˆç‡é«˜ï¼›ç¼ºç‚¹ï¼šå ç”¨ç©ºé—´ï¼›é€‚ç”¨åœºæ™¯ï¼šå­˜å‚¨å¯†ç çš„ md5 å€¼ï¼Œå›ºå®šé•¿åº¦çš„ï¼Œä½¿ç”¨ char éå¸¸åˆé€‚ã€‚</li>
</ul>
</li>
<li>varchar(n) ï¼šå¯å˜é•¿åº¦ï¼Œå­˜å‚¨çš„å€¼æ˜¯æ¯ä¸ªå€¼å ç”¨çš„å­—èŠ‚å†åŠ ä¸Šä¸€ä¸ªç”¨æ¥è®°å½•å…¶é•¿åº¦çš„å­—èŠ‚çš„é•¿åº¦ã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼Œä»ç©ºé—´ä¸Šè€ƒè™‘ varcahr æ¯”è¾ƒåˆé€‚ï¼›ä»æ•ˆç‡ä¸Šè€ƒè™‘ char æ¯”è¾ƒåˆé€‚ï¼ŒäºŒè€…ä½¿ç”¨éœ€è¦æƒè¡¡ã€‚</p>
<h2 id="redo-logä¸binlogä¸undo-logçš„åŒºåˆ«"><a href="#redo-logä¸binlogä¸undo-logçš„åŒºåˆ«" class="headerlink" title="redo logä¸binlogä¸undo logçš„åŒºåˆ«"></a>redo logä¸binlogä¸undo logçš„åŒºåˆ«</h2><p>å‚è€ƒ <a href="https://www.cnblogs.com/Java3y/p/12453755.html" target="_blank" rel="noopener">https://www.cnblogs.com/Java3y/p/12453755.html</a> , å†™çš„éå¸¸å¥½<br>ä¹Ÿå¯å‚è€ƒ <a href="https://www.jianshu.com/p/68d5557c65be" target="_blank" rel="noopener">https://www.jianshu.com/p/68d5557c65be</a></p>
<h3 id="redo-log"><a href="#redo-log" class="headerlink" title="redo log"></a>redo log</h3><p>redo log å­˜åœ¨äºInnoDB å¼•æ“ä¸­ï¼ŒInnoDBå¼•æ“æ˜¯ä»¥æ’ä»¶å½¢å¼å¼•å…¥Mysqlçš„ï¼Œredo logçš„å¼•å…¥ä¸»è¦æ˜¯ä¸ºäº†å®ç°Mysqlçš„crash-safeèƒ½åŠ›ã€‚<br>å®é™…ä¸ŠMysqlçš„åŸºæœ¬å­˜å‚¨ç»“æ„æ˜¯é¡µ(è®°å½•éƒ½å­˜åœ¨é¡µé‡Œè¾¹)ï¼Œæ‰€ä»¥MySQLæ˜¯å…ˆæŠŠè¿™æ¡è®°å½•æ‰€åœ¨çš„é¡µæ‰¾åˆ°ï¼Œç„¶åæŠŠè¯¥é¡µåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå°†å¯¹åº”è®°å½•è¿›è¡Œä¿®æ”¹ã€‚<br>ç°åœ¨å°±å¯èƒ½å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœåœ¨å†…å­˜ä¸­æŠŠæ•°æ®æ”¹äº†ï¼Œè¿˜æ²¡æ¥å¾—åŠè½ç£ç›˜ï¼Œè€Œæ­¤æ—¶çš„æ•°æ®åº“æŒ‚äº†æ€ä¹ˆåŠï¼Ÿæ˜¾ç„¶è¿™æ¬¡æ›´æ”¹å°±ä¸¢äº†ã€‚</p>
<p>å¦‚æœæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦å°†æ•°æ®ç«‹é©¬è½ç£ç›˜ä¹‹åï¼Œé‚£é€Ÿåº¦ä¼šå¾ˆæ…¢ï¼ŒMySQLå¯èƒ½ä¹Ÿé¡¶ä¸ä½ã€‚æ‰€ä»¥MySQLæ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ<br>MySQLå¼•å…¥äº†redo logï¼Œ<strong>å†…å­˜å†™å®Œäº†ï¼Œç„¶åä¼šå†™ä¸€ä»½redo logï¼Œè¿™ä»½redo logè®°è½½ç€è¿™æ¬¡åœ¨æŸä¸ªé¡µä¸Šåšäº†ä»€ä¹ˆä¿®æ”¹.å…¶å®å†™redo logçš„æ—¶å€™ï¼Œä¹Ÿä¼šæœ‰bufferï¼Œæ˜¯å…ˆå†™bufferï¼Œå†çœŸæ­£è½åˆ°ç£ç›˜ä¸­çš„ã€‚</strong>è‡³äºä»bufferä»€ä¹ˆæ—¶å€™è½ç£ç›˜ï¼Œä¼šæœ‰é…ç½®ä¾›æˆ‘ä»¬é…ç½®ã€‚</p>
<p>å†™redo logä¹Ÿæ˜¯éœ€è¦å†™ç£ç›˜çš„ï¼Œä½†å®ƒçš„å¥½å¤„å°±æ˜¯é¡ºåºIOï¼ˆæˆ‘ä»¬éƒ½çŸ¥é“é¡ºåºIOæ¯”éšæœºIOå¿«éå¸¸å¤šï¼‰ã€‚</p>
<p>æ‰€ä»¥ï¼Œ<strong>redo logçš„å­˜åœ¨ä¸ºäº†ï¼šå½“æˆ‘ä»¬ä¿®æ”¹çš„æ—¶å€™ï¼Œå†™å®Œå†…å­˜äº†ï¼Œä½†æ•°æ®è¿˜æ²¡çœŸæ­£å†™åˆ°ç£ç›˜çš„æ—¶å€™ã€‚æ­¤æ—¶æˆ‘ä»¬çš„æ•°æ®åº“æŒ‚äº†ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®redo logæ¥å¯¹æ•°æ®è¿›è¡Œæ¢å¤</strong>ã€‚å› ä¸ºredo logæ˜¯é¡ºåºIOï¼Œæ‰€ä»¥å†™å…¥çš„é€Ÿåº¦å¾ˆå¿«ï¼Œå¹¶ä¸”redo logè®°è½½çš„æ˜¯ç‰©ç†å˜åŒ–ï¼ˆxxxxé¡µåšäº†xxxä¿®æ”¹ï¼‰ï¼Œæ–‡ä»¶çš„ä½“ç§¯å¾ˆå°ï¼Œæ¢å¤é€Ÿåº¦å¾ˆå¿«</p>
<h3 id="binlog"><a href="#binlog" class="headerlink" title="binlog"></a>binlog</h3><p>binlogè®°å½•äº†æ•°æ®åº“è¡¨ç»“æ„å’Œè¡¨æ•°æ®å˜æ›´ï¼Œæ¯”å¦‚update/delete/insert/truncate/createã€‚å®ƒä¸ä¼šè®°å½•selectï¼ˆå› ä¸ºè¿™æ²¡æœ‰å¯¹è¡¨æ²¡æœ‰è¿›è¡Œå˜æ›´ï¼‰<br><strong>binlogæˆ‘ä»¬å¯ä»¥ç®€å•ç†è§£ä¸ºï¼šå­˜å‚¨ç€æ¯æ¡å˜æ›´çš„SQLè¯­å¥</strong>  </p>
<h3 id="undo-log"><a href="#undo-log" class="headerlink" title="undo log"></a>undo log</h3><p>undo logä¸»è¦æœ‰ä¸¤ä¸ªä½œç”¨ï¼š</p>
<ul>
<li>å›æ»š</li>
<li>å¤šç‰ˆæœ¬æ§åˆ¶(MVCC)</li>
</ul>
<p>åœ¨æ•°æ®ä¿®æ”¹çš„æ—¶å€™ï¼Œä¸ä»…è®°å½•äº†redo logï¼Œè¿˜è®°å½•undo logï¼Œå¦‚æœå› ä¸ºæŸäº›åŸå› å¯¼è‡´äº‹åŠ¡å¤±è´¥æˆ–å›æ»šäº†ï¼Œå¯ä»¥ç”¨undo logè¿›è¡Œå›æ»š<br>undo logä¸»è¦å­˜å‚¨çš„ä¹Ÿæ˜¯é€»è¾‘æ—¥å¿—ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦insertä¸€æ¡æ•°æ®äº†ï¼Œé‚£undo logä¼šè®°å½•çš„ä¸€æ¡å¯¹åº”çš„deleteæ—¥å¿—ã€‚æˆ‘ä»¬è¦updateä¸€æ¡è®°å½•æ—¶ï¼Œå®ƒä¼šè®°å½•ä¸€æ¡å¯¹åº”ç›¸åçš„updateè®°å½•ã€‚</p>
<p>è¿™ä¹Ÿåº”è¯¥å®¹æ˜“ç†è§£ï¼Œæ¯•ç«Ÿå›æ»šå˜›ï¼Œè·Ÿéœ€è¦ä¿®æ”¹çš„æ“ä½œç›¸åå°±å¥½ï¼Œè¿™æ ·å°±èƒ½è¾¾åˆ°å›æ»šçš„ç›®çš„ã€‚å› ä¸ºæ”¯æŒå›æ»šæ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å°±èƒ½ä¿è¯ï¼šâ€œä¸€ä¸ªäº‹åŠ¡åŒ…å«å¤šä¸ªæ“ä½œï¼Œè¿™äº›æ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œâ€ã€‚ã€åŸå­æ€§ã€‘</p>
<p>å› ä¸ºundo logå­˜å‚¨ç€ä¿®æ”¹ä¹‹å‰çš„æ•°æ®ï¼Œç›¸å½“äºä¸€ä¸ªå‰ç‰ˆæœ¬ï¼ŒMVCCå®ç°çš„æ˜¯è¯»å†™ä¸é˜»å¡ï¼Œè¯»çš„æ—¶å€™åªè¦è¿”å›å‰ä¸€ä¸ªç‰ˆæœ¬çš„æ•°æ®å°±è¡Œäº†ã€‚</p>
<h3 id="undologå’Œbinlogå’Œredologä¸åŒä¹‹å¤„æ€»ç»“"><a href="#undologå’Œbinlogå’Œredologä¸åŒä¹‹å¤„æ€»ç»“" class="headerlink" title="undologå’Œbinlogå’Œredologä¸åŒä¹‹å¤„æ€»ç»“"></a>undologå’Œbinlogå’Œredologä¸åŒä¹‹å¤„æ€»ç»“</h3><ul>
<li>å‚è€ƒ <a href="https://www.jianshu.com/p/68d5557c65be" target="_blank" rel="noopener">https://www.jianshu.com/p/68d5557c65be</a></li>
<li>redo log: åªå­˜åœ¨äºinnodbå¼•æ“ä¸­<br> ç‰©ç†æ ¼å¼çš„æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯ç‰©ç†æ•°æ®é¡µé¢çš„ä¿®æ”¹çš„ä¿¡æ¯ï¼ˆæ•°æ®åº“ä¸­æ¯ä¸ªé¡µçš„ä¿®æ”¹ï¼‰ï¼Œé¢å‘çš„æ˜¯è¡¨ç©ºé—´ã€æ•°æ®æ–‡ä»¶ã€æ•°æ®é¡µã€åç§»é‡ç­‰ã€‚</li>
<li>undo log<br> é€»è¾‘æ ¼å¼çš„æ—¥å¿—ï¼Œåœ¨æ‰§è¡Œundoçš„æ—¶å€™ï¼Œä»…ä»…æ˜¯å°†æ•°æ®ä»é€»è¾‘ä¸Šæ¢å¤è‡³äº‹åŠ¡ä¹‹å‰çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯ä»ç‰©ç†é¡µé¢ä¸Šæ“ä½œå®ç°çš„ï¼Œä¸redo logä¸åŒã€‚</li>
<li>binlog<ul>
<li>é€»è¾‘æ ¼å¼çš„æ—¥å¿—ï¼Œå¯ä»¥ç®€å•è®¤ä¸ºå°±æ˜¯æ‰§è¡Œè¿‡çš„äº‹åŠ¡ä¸­çš„sqlè¯­å¥ã€‚</li>
<li>ä½†åˆä¸å®Œå…¨æ˜¯sqlè¯­å¥è¿™ä¹ˆç®€å•ï¼Œè€Œæ˜¯åŒ…æ‹¬äº†æ‰§è¡Œçš„sqlè¯­å¥ï¼ˆå¢åˆ æ”¹ï¼‰åå‘çš„ä¿¡æ¯ã€‚æ¯”å¦‚deleteæ“ä½œçš„è¯ï¼Œå°±å¯¹åº”ç€deleteæœ¬èº«å’Œå…¶åå‘çš„insert/updateæ“ä½œçš„è¯ï¼Œå°±å¯¹åº”ç€updateæ‰§è¡Œå‰åçš„ç‰ˆæœ¬çš„ä¿¡æ¯ï¼›insertæ“ä½œåˆ™å¯¹åº”ç€deleteå’Œinsertæœ¬èº«çš„ä¿¡æ¯ã€‚</li>
<li>å› æ­¤å¯ä»¥åŸºäºbinlogåšåˆ°é—ªå›åŠŸèƒ½ã€‚</li>
</ul>
</li>
<li>binlogå¯ä»¥ä½œä¸ºæ¢å¤æ•°æ®ä½¿ç”¨ï¼Œä¸»ä»å¤åˆ¶æ­å»ºï¼Œredo logä½œä¸ºå¼‚å¸¸å®•æœºæˆ–è€…ä»‹è´¨æ•…éšœåçš„æ•°æ®æ¢å¤ä½¿ç”¨ã€‚</li>
<li>redo logæ˜¯åœ¨InnoDBå­˜å‚¨å¼•æ“å±‚äº§ç”Ÿï¼Œè€Œbinlogæ˜¯MySQLæ•°æ®åº“çš„ä¸Šå±‚äº§ç”Ÿçš„ï¼Œå¹¶ä¸”binlogæ—¥å¿—ä¸ä»…ä»…é’ˆå¯¹INNODBå­˜å‚¨å¼•æ“ï¼ŒMySQLæ•°æ®åº“ä¸­çš„ä»»ä½•å­˜å‚¨å¼•æ“å¯¹äºæ•°æ®åº“çš„æ›´æ”¹éƒ½ä¼šäº§ç”Ÿbinlogæ—¥å¿—ã€‚</li>
<li>ä¸¤ç§æ—¥å¿—è®°å½•çš„å†…å®¹å½¢å¼ä¸åŒã€‚MySQLçš„binlogæ˜¯é€»è¾‘æ—¥å¿—ï¼Œå¯ä»¥ç®€å•è®¤ä¸ºè®°å½•çš„å°±æ˜¯sqlè¯­å¥ã€‚è€Œinnodbå­˜å‚¨å¼•æ“å±‚é¢çš„redoæ—¥å¿—æ˜¯ç‰©ç†æ—¥å¿—, æ˜¯æ•°æ®é¡µé¢çš„ä¿®æ”¹ä¹‹åçš„ç‰©ç†è®°å½•ã€‚</li>
<li>å…³äºäº‹åŠ¡æäº¤æ—¶ï¼Œredo logå’Œbinlogçš„å†™å…¥é¡ºåºï¼Œä¸ºäº†ä¿è¯ä¸»ä»å¤åˆ¶æ—¶å€™çš„ä¸»ä»ä¸€è‡´ï¼ˆå½“ç„¶ä¹ŸåŒ…æ‹¬ä½¿ç”¨binlogè¿›è¡ŒåŸºäºæ—¶é—´ç‚¹è¿˜åŸçš„æƒ…å†µï¼‰ï¼Œæ˜¯è¦ä¸¥æ ¼ä¸€è‡´çš„ï¼ŒMySQLé€šè¿‡ä¸¤é˜¶æ®µæäº¤è¿‡ç¨‹æ¥å®Œæˆäº‹åŠ¡çš„ä¸€è‡´æ€§çš„ï¼Œä¹Ÿå³redo logå’Œbinlogçš„ä¸€è‡´æ€§çš„ï¼Œç†è®ºä¸Šæ˜¯å…ˆå†™redo logï¼Œå†å†™binlogï¼Œä¸¤ä¸ªæ—¥å¿—éƒ½æäº¤æˆåŠŸï¼ˆåˆ·å…¥ç£ç›˜ï¼‰ï¼Œäº‹åŠ¡æ‰ç®—çœŸæ­£çš„å®Œæˆã€‚å› æ­¤redoæ—¥å¿—çš„å†™ç›˜ï¼Œå¹¶ä¸ä¸€å®šæ˜¯éšç€äº‹åŠ¡çš„æäº¤æ‰å†™å…¥redoæ—¥å¿—æ–‡ä»¶çš„ï¼Œè€Œæ˜¯éšç€äº‹åŠ¡çš„å¼€å§‹ï¼Œé€æ­¥å¼€å§‹çš„ã€‚é‚£ä¹ˆå½“æˆ‘æ‰§è¡Œä¸€æ¡ update è¯­å¥æ—¶ï¼Œredo log å’Œ binlog æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è¢«å†™å…¥çš„å‘¢ï¼Ÿè¿™å°±æœ‰äº†æˆ‘ä»¬å¸¸è¯´çš„ã€Œä¸¤é˜¶æ®µæäº¤ã€ï¼š<ul>
<li>å†™å…¥ï¼šredo logï¼ˆprepareï¼‰</li>
<li>å†™å…¥ï¼šbinlog</li>
<li>å†™å…¥ï¼šredo logï¼ˆcommitï¼‰</li>
</ul>
</li>
<li>ä¸¤ç§æ—¥å¿—ä¸è®°å½•å†™å…¥ç£ç›˜çš„æ—¶é—´ç‚¹ä¸åŒï¼Œbinlogæ—¥å¿—åªåœ¨äº‹åŠ¡æäº¤å®Œæˆåè¿›è¡Œä¸€æ¬¡å†™å…¥ã€‚è€Œinnodbå­˜å‚¨å¼•æ“çš„redoæ—¥å¿—åœ¨äº‹åŠ¡è¿›è¡Œä¸­ä¸æ–­åœ°è¢«å†™å…¥ï¼Œå¹¶æ—¥å¿—ä¸æ˜¯éšäº‹åŠ¡æäº¤çš„é¡ºåºè¿›è¡Œå†™å…¥çš„ã€‚</li>
<li>binlogæ—¥å¿—ä»…åœ¨äº‹åŠ¡æäº¤æ—¶è®°å½•ï¼Œå¹¶ä¸”å¯¹äºæ¯ä¸€ä¸ªäº‹åŠ¡ï¼Œä»…åœ¨äº‹åŠ¡æäº¤æ—¶è®°å½•ï¼Œå¹¶ä¸”å¯¹äºæ¯ä¸€ä¸ªäº‹åŠ¡ï¼Œä»…åŒ…å«å¯¹åº”äº‹åŠ¡çš„ä¸€ä¸ªæ—¥å¿—ã€‚è€Œå¯¹äºinnodbå­˜å‚¨å¼•æ“çš„redoæ—¥å¿—ï¼Œç”±äºå…¶è®°å½•æ˜¯ç‰©ç†æ“ä½œæ—¥å¿—ï¼Œå› æ­¤æ¯ä¸ªäº‹åŠ¡å¯¹åº”å¤šä¸ªæ—¥å¿—æ¡ç›®ï¼Œå¹¶ä¸”äº‹åŠ¡çš„redoæ—¥å¿—å†™å…¥æ˜¯å¹¶å‘çš„ï¼Œå¹¶éåœ¨äº‹åŠ¡æäº¤æ—¶å†™å…¥ï¼Œå…¶åœ¨æ–‡ä»¶ä¸­è®°å½•çš„é¡ºåºå¹¶éæ˜¯äº‹åŠ¡å¼€å§‹çš„é¡ºåºã€‚</li>
<li>binlogä¸æ˜¯å¾ªç¯ä½¿ç”¨ï¼Œåœ¨å†™æ»¡æˆ–è€…é‡å¯ä¹‹åï¼Œä¼šç”Ÿæˆæ–°çš„binlogæ–‡ä»¶ï¼Œredo logæ˜¯å¾ªç¯ä½¿ç”¨ã€‚</li>
<li>binlog æ—¥å¿—æ˜¯ master æ¨çš„è¿˜æ˜¯ salve æ¥æ‹‰çš„ï¼Ÿslaveæ¥æ‹‰çš„, å› ä¸ºæ¯ä¸€ä¸ªslaveéƒ½æ˜¯å®Œå…¨ç‹¬ç«‹çš„ä¸ªä½“ï¼Œæ‰€ä»¥slaveå®Œå…¨ä¾æ®è‡ªå·±çš„èŠ‚å¥å»å¤„ç†åŒæ­¥ï¼Œ</li>
</ul>
<h2 id="äºŒé˜¶æ®µæäº¤"><a href="#äºŒé˜¶æ®µæäº¤" class="headerlink" title="äºŒé˜¶æ®µæäº¤"></a>äºŒé˜¶æ®µæäº¤</h2><p>redo log ä¿è¯çš„æ˜¯æ•°æ®åº“çš„ crash-safe èƒ½åŠ›ã€‚é‡‡ç”¨çš„ç­–ç•¥å°±æ˜¯å¸¸è¯´çš„â€œä¸¤é˜¶æ®µæäº¤â€ã€‚</p>
<p>ä¸€æ¡updateçš„SQLè¯­å¥æ˜¯æŒ‰ç…§è¿™æ ·çš„æµç¨‹æ¥æ‰§è¡Œçš„ï¼š<br><strong>å°†æ•°æ®é¡µåŠ è½½åˆ°å†…å­˜ â†’ ä¿®æ”¹æ•°æ® â†’ æ›´æ–°æ•°æ® â†’ å†™redo logï¼ˆçŠ¶æ€ä¸ºprepareï¼‰ â†’ å†™binlog â†’ æäº¤äº‹åŠ¡(æ•°æ®å†™å…¥æˆåŠŸåå°†redo logçŠ¶æ€æ”¹ä¸ºcommit)</strong></p>
<p>åªæœ‰å½“ä¸¤ä¸ªæ—¥å¿—éƒ½æäº¤æˆåŠŸï¼ˆåˆ·å…¥ç£ç›˜ï¼‰ï¼Œäº‹åŠ¡æ‰ç®—çœŸæ­£çš„å®Œæˆã€‚ä¸€æ—¦å‘ç”Ÿç³»ç»Ÿæ•…éšœï¼ˆä¸ç®¡æ˜¯å®•æœºã€æ–­ç”µã€é‡å¯ç­‰ç­‰ï¼‰ï¼Œéƒ½å¯ä»¥é…å¥—ä½¿ç”¨ redo log ä¸ binlog åšæ•°æ®ä¿®å¤ã€‚</p>
<h3 id="ä¸¤é˜¶æ®µæäº¤æœºåˆ¶çš„å¿…è¦æ€§"><a href="#ä¸¤é˜¶æ®µæäº¤æœºåˆ¶çš„å¿…è¦æ€§" class="headerlink" title="ä¸¤é˜¶æ®µæäº¤æœºåˆ¶çš„å¿…è¦æ€§"></a>ä¸¤é˜¶æ®µæäº¤æœºåˆ¶çš„å¿…è¦æ€§</h3><ul>
<li>binlog å­˜åœ¨äºMysql Serverå±‚ä¸­ï¼Œä¸»è¦ç”¨äºæ•°æ®æ¢å¤ï¼›å½“æ•°æ®è¢«è¯¯åˆ æ—¶ï¼Œå¯ä»¥é€šè¿‡ä¸Šä¸€æ¬¡çš„å…¨é‡å¤‡ä»½æ•°æ®åŠ ä¸ŠæŸæ®µæ—¶é—´çš„binlogå°†æ•°æ®æ¢å¤åˆ°æŒ‡å®šçš„æŸä¸ªæ—¶é—´ç‚¹çš„æ•°æ®ã€‚  </li>
<li>redo log å­˜åœ¨äºInnoDB å¼•æ“ä¸­ï¼ŒInnoDBå¼•æ“æ˜¯ä»¥æ’ä»¶å½¢å¼å¼•å…¥Mysqlçš„ï¼Œredo logçš„å¼•å…¥ä¸»è¦æ˜¯ä¸ºäº†å®ç°Mysqlçš„crash-safeèƒ½åŠ›ã€‚</li>
</ul>
<p>å‡è®¾redo logå’Œbinlogåˆ†åˆ«æäº¤ï¼Œå¯èƒ½ä¼šé€ æˆç”¨æ—¥å¿—æ¢å¤å‡ºæ¥çš„æ•°æ®å’ŒåŸæ¥æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p>
<ul>
<li>å‡è®¾å…ˆå†™redo logå†å†™binlogï¼Œå³redo logæ²¡æœ‰prepareé˜¶æ®µï¼Œå†™å®Œç›´æ¥ç½®ä¸ºcommitçŠ¶æ€ï¼Œç„¶åå†å†™binlogã€‚é‚£ä¹ˆå¦‚æœå†™å®Œredo logåMysqlå®•æœºäº†ï¼Œé‡å¯åç³»ç»Ÿè‡ªåŠ¨ç”¨redo log æ¢å¤å‡ºæ¥çš„æ•°æ®å°±ä¼šæ¯”binlogè®°å½•çš„æ•°æ®å¤šå‡ºä¸€äº›æ•°æ®ï¼Œè¿™å°±ä¼šé€ æˆç£ç›˜ä¸Šæ•°æ®åº“æ•°æ®é¡µå’Œbinlogçš„ä¸ä¸€è‡´ï¼Œä¸‹æ¬¡éœ€è¦ç”¨åˆ°binlogæ¢å¤è¯¯åˆ çš„æ•°æ®æ—¶ï¼Œå°±ä¼šå‘ç°æ¢å¤åçš„æ•°æ®å’ŒåŸæ¥çš„æ•°æ®ä¸ä¸€è‡´ã€‚</li>
<li>å‡è®¾å…ˆå†™binlogå†å†™redologã€‚å¦‚æœå†™å®ŒbinlogåMysqlå®•æœºäº†ï¼Œé‚£ä¹ˆbinlogä¸Šçš„è®°å½•å°±ä¼šæ¯”ç£ç›˜ä¸Šæ•°æ®é¡µçš„è®°å½•å¤šå‡ºä¸€äº›æ•°æ®å‡ºæ¥ï¼Œä¸‹æ¬¡ç”¨binlogæ¢å¤æ•°æ®ï¼Œå°±ä¼šå‘ç°æ¢å¤åçš„æ•°æ®å’ŒåŸæ¥çš„æ•°æ®ä¸ä¸€è‡´ã€‚</li>
</ul>
<p>ç”±æ­¤å¯è§ï¼Œredo logå’Œbinlogçš„ä¸¤é˜¶æ®µæäº¤æ˜¯éå¸¸å¿…è¦çš„ã€‚</p>
<h2 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h2><ul>
<li>èšé›†ç´¢å¼•(ä¹Ÿå«èšç°‡ç´¢å¼•)æ˜¯å•¥<ul>
<li>èšç°‡ç´¢å¼•ï¼šå°†æ•°æ®å­˜å‚¨ä¸ç´¢å¼•æ”¾åˆ°äº†ä¸€å—ï¼Œæ‰¾åˆ°ç´¢å¼•ä¹Ÿå°±æ‰¾åˆ°äº†æ•°æ®</li>
<li>éèšç°‡ç´¢å¼•ï¼šå°†æ•°æ®å­˜å‚¨äºç´¢å¼•åˆ†å¼€ç»“æ„ï¼Œç´¢å¼•ç»“æ„çš„å¶å­èŠ‚ç‚¹æŒ‡å‘äº†æ•°æ®çš„å¯¹åº”è¡Œï¼Œmyisamé€šè¿‡key_bufferæŠŠç´¢å¼•å…ˆç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œå½“éœ€è¦è®¿é—®æ•°æ®æ—¶ï¼ˆé€šè¿‡ç´¢å¼•è®¿é—®æ•°æ®ï¼‰ï¼Œåœ¨å†…å­˜ä¸­ç›´æ¥æœç´¢ç´¢å¼•ï¼Œç„¶åé€šè¿‡ç´¢å¼•æ‰¾åˆ°ç£ç›˜ç›¸åº”æ•°æ®ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆç´¢å¼•ä¸åœ¨key bufferå‘½ä¸­æ—¶ï¼Œé€Ÿåº¦æ…¢çš„åŸå› ã€‚</li>
</ul>
</li>
<li>å¤–é”®æ˜¯å•¥: æ¯”å¦‚åœ¨studentsè¡¨ä¸­ï¼Œé€šè¿‡class_idçš„å­—æ®µï¼Œå¯ä»¥æŠŠæ•°æ®ä¸å¦ä¸€å¼ è¡¨å…³è”èµ·æ¥ï¼Œè¿™ç§åˆ—ç§°ä¸ºå¤–é”®(ä¸€èˆ¬ä¸ç”¨å¤–é”®, å› ä¸ºä¼šé™ä½æ•°æ®åº“æ€§èƒ½)</li>
<li>mysql ç´¢å¼•åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå¤±æ•ˆ<ul>
<li><a href="https://database.51cto.com/art/201912/607742.htm" target="_blank" rel="noopener">https://database.51cto.com/art/201912/607742.htm</a></li>
<li>æŸ¥è¯¢æ¡ä»¶åŒ…å«orï¼Œå¯èƒ½å¯¼è‡´ç´¢å¼•å¤±æ•ˆ</li>
<li>å¦‚ä½•å­—æ®µç±»å‹æ˜¯å­—ç¬¦ä¸²ï¼Œwhereæ—¶ä¸€å®šç”¨å¼•å·æ‹¬èµ·æ¥ï¼Œå¦åˆ™ç´¢å¼•å¤±æ•ˆ</li>
<li>likeé€šé…ç¬¦å¯èƒ½å¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚</li>
<li>è”åˆç´¢å¼•ï¼ŒæŸ¥è¯¢æ—¶çš„æ¡ä»¶åˆ—ä¸æ˜¯è”åˆç´¢å¼•ä¸­çš„ç¬¬ä¸€ä¸ªåˆ—ï¼Œç´¢å¼•å¤±æ•ˆã€‚</li>
<li>åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨mysqlçš„å†…ç½®å‡½æ•°ï¼Œç´¢å¼•å¤±æ•ˆ</li>
<li>å¯¹ç´¢å¼•åˆ—è¿ç®—ï¼ˆå¦‚ï¼Œ+ã€-ã€*ã€/ï¼‰ï¼Œç´¢å¼•å¤±æ•ˆã€‚</li>
<li>ç´¢å¼•å­—æ®µä¸Šä½¿ç”¨ï¼ˆï¼= æˆ–è€… &lt; &gt;ï¼Œnot inï¼‰æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚</li>
<li>ç´¢å¼•å­—æ®µä¸Šä½¿ç”¨is nullï¼Œ is not nullï¼Œå¯èƒ½å¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚</li>
<li>å·¦è¿æ¥æŸ¥è¯¢æˆ–è€…å³è¿æ¥æŸ¥è¯¢æŸ¥è¯¢å…³è”çš„å­—æ®µç¼–ç æ ¼å¼ä¸ä¸€æ ·ï¼Œå¯èƒ½å¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚</li>
<li>mysqlä¼°è®¡ä½¿ç”¨å…¨è¡¨æ‰«æè¦æ¯”ä½¿ç”¨ç´¢å¼•å¿«,åˆ™ä¸ä½¿ç”¨ç´¢å¼•ã€‚</li>
</ul>
</li>
<li>mysql çš„ç´¢å¼•æ¨¡å‹:<br>åœ¨MySQLä¸­ä½¿ç”¨è¾ƒå¤šçš„ç´¢å¼•æœ‰Hashç´¢å¼•ï¼ŒB+æ ‘ç´¢å¼•ç­‰ï¼Œè€Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„InnoDBå­˜å‚¨å¼•æ“çš„é»˜è®¤ç´¢å¼•å®ç°ä¸ºï¼šB+æ ‘ç´¢å¼•ã€‚å¯¹äºå“ˆå¸Œç´¢å¼•æ¥è¯´ï¼Œåº•å±‚çš„æ•°æ®ç»“æ„å°±æ˜¯å“ˆå¸Œè¡¨ï¼Œå› æ­¤åœ¨ç»å¤§å¤šæ•°éœ€æ±‚ä¸ºå•æ¡è®°å½•æŸ¥è¯¢çš„æ—¶å€™ï¼Œå¯ä»¥é€‰æ‹©å“ˆå¸Œç´¢å¼•ï¼ŒæŸ¥è¯¢æ€§èƒ½æœ€å¿«ï¼›å…¶ä½™å¤§éƒ¨åˆ†åœºæ™¯ï¼Œå»ºè®®é€‰æ‹©BTreeç´¢å¼•ã€‚</li>
</ul>
<h3 id="ä¸ºä»€ä¹ˆè¯´Bç±»æ ‘æ›´é€‚åˆæ•°æ®åº“ç´¢å¼•"><a href="#ä¸ºä»€ä¹ˆè¯´Bç±»æ ‘æ›´é€‚åˆæ•°æ®åº“ç´¢å¼•" class="headerlink" title="ä¸ºä»€ä¹ˆè¯´Bç±»æ ‘æ›´é€‚åˆæ•°æ®åº“ç´¢å¼•"></a>ä¸ºä»€ä¹ˆè¯´Bç±»æ ‘æ›´é€‚åˆæ•°æ®åº“ç´¢å¼•</h3><p><a href="/algo_newbie/#ä¸ºä»€ä¹ˆè¯´Bç±»æ ‘æ›´é€‚åˆæ•°æ®åº“ç´¢å¼•">ä¸ºä»€ä¹ˆè¯´Bç±»æ ‘æ›´é€‚åˆæ•°æ®åº“ç´¢å¼•</a></p>
<h2 id="mysqlå…¨æ–‡ç´¢å¼•-pending-fin"><a href="#mysqlå…¨æ–‡ç´¢å¼•-pending-fin" class="headerlink" title="mysqlå…¨æ–‡ç´¢å¼• pending_fin"></a>mysqlå…¨æ–‡ç´¢å¼• pending_fin</h2><h2 id="mysql-æœ‰é‚£äº›å­˜å‚¨å¼•æ“ï¼Œæœ‰å“ªäº›åŒºåˆ«"><a href="#mysql-æœ‰é‚£äº›å­˜å‚¨å¼•æ“ï¼Œæœ‰å“ªäº›åŒºåˆ«" class="headerlink" title="mysql æœ‰é‚£äº›å­˜å‚¨å¼•æ“ï¼Œæœ‰å“ªäº›åŒºåˆ«"></a>mysql æœ‰é‚£äº›å­˜å‚¨å¼•æ“ï¼Œæœ‰å“ªäº›åŒºåˆ«</h2><ul>
<li>innodbæ˜¯ MySQL é»˜è®¤çš„äº‹åŠ¡å‹å­˜å‚¨å¼•æ“ï¼Œåªæœ‰åœ¨éœ€è¦å®ƒä¸æ”¯æŒçš„ç‰¹æ€§æ—¶ï¼Œæ‰è€ƒè™‘ä½¿ç”¨å…¶å®ƒå­˜å‚¨å¼•æ“ã€‚å®ç°äº†å››ä¸ªæ ‡å‡†çš„éš”ç¦»çº§åˆ«ï¼Œé»˜è®¤çº§åˆ«æ˜¯å¯é‡å¤è¯»ï¼ˆREPEATABLE READï¼‰ã€‚åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œé€šè¿‡å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰+ Next-Key Locking é˜²æ­¢å¹»å½±è¯»ã€‚ä¸»ç´¢å¼•æ˜¯èšç°‡ç´¢å¼•ï¼Œåœ¨ç´¢å¼•ä¸­ä¿å­˜äº†æ•°æ®ï¼Œä»è€Œé¿å…ç›´æ¥è¯»å–ç£ç›˜ï¼Œå› æ­¤å¯¹æŸ¥è¯¢æ€§èƒ½æœ‰å¾ˆå¤§çš„æå‡ã€‚</li>
<li>MyISAMç±»å‹ä¸æ”¯æŒäº‹åŠ¡å¤„ç†ç­‰é«˜çº§å¤„ç†ï¼Œè€ŒInnoDBç±»å‹æ”¯æŒã€‚</li>
<li>MyISAMç±»å‹çš„è¡¨å¼ºè°ƒçš„æ˜¯æ€§èƒ½ï¼Œå…¶æ‰§è¡Œé€Ÿåº¦æ¯”InnoDBç±»å‹æ›´å¿«ï¼Œä½†æ˜¯ä¸æä¾›äº‹åŠ¡æ”¯æŒï¼Œè€ŒInnoDBæä¾›äº‹åŠ¡æ”¯æŒä»¥åŠå¤–éƒ¨é”®ç­‰é«˜çº§æ•°æ®åº“åŠŸèƒ½ã€‚</li>
<li>ç°åœ¨ä¸€èˆ¬éƒ½æ˜¯é€‰ç”¨InnoDBäº†ï¼ŒInnoDBæ”¯æŒè¡Œé”, è€ŒMyISAMçš„å…¨è¡¨é”ï¼Œmyisamçš„è¯»å†™ä¸²è¡Œé—®é¢˜ï¼Œå¹¶å‘æ•ˆç‡é”è¡¨ï¼Œæ•ˆç‡ä½ï¼ŒMyISAMå¯¹äºè¯»å†™å¯†é›†å‹åº”ç”¨ä¸€èˆ¬æ˜¯ä¸ä¼šå»é€‰ç”¨çš„</li>
<li>memoryå¼•æ“ä¸€èˆ¬ç”¨äºä¸´æ—¶è¡¨, ä½¿ç”¨è¡¨çº§é”ï¼Œæ²¡æœ‰äº‹åŠ¡æœºåˆ¶, è™½ç„¶å†…å­˜è®¿é—®å¿«ï¼Œä½†å¦‚æœé¢‘ç¹çš„è¯»å†™ï¼Œè¡¨çº§é”ä¼šæˆä¸ºç“¶é¢ˆ, ä¸”å†…å­˜æ˜‚è´µ..æ»¡äº†å°±äºäº†</li>
<li>InnoDBæ˜¯èšé›†ç´¢å¼•ï¼Œä½¿ç”¨B+Treeä½œä¸ºç´¢å¼•ç»“æ„ï¼Œæ•°æ®æ–‡ä»¶æ˜¯å’Œï¼ˆä¸»é”®ï¼‰ç´¢å¼•ç»‘åœ¨ä¸€èµ·çš„ï¼ˆè¡¨æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯æŒ‰B+Treeç»„ç»‡çš„ä¸€ä¸ªç´¢å¼•ç»“æ„ï¼‰ï¼Œå¿…é¡»è¦æœ‰ä¸»é”®ï¼Œé€šè¿‡ä¸»é”®ç´¢å¼•æ•ˆç‡å¾ˆé«˜ã€‚MyISAMæ˜¯éèšé›†ç´¢å¼•ï¼Œä¹Ÿæ˜¯ä½¿ç”¨B+Treeä½œä¸ºç´¢å¼•ç»“æ„ï¼Œç´¢å¼•å’Œæ•°æ®æ–‡ä»¶æ˜¯åˆ†ç¦»çš„ï¼Œç´¢å¼•ä¿å­˜çš„æ˜¯æ•°æ®æ–‡ä»¶çš„æŒ‡é’ˆã€‚ä¸»é”®ç´¢å¼•å’Œè¾…åŠ©ç´¢å¼•æ˜¯ç‹¬ç«‹çš„ã€‚</li>
</ul>
<p>ç»¼ä¸Šæ‰€è¿°, <strong>å¦‚æœè¡¨çš„è¯»æ“ä½œè¿œè¿œå¤šäºå†™æ“ä½œæ—¶ï¼Œå¹¶ä¸”ä¸éœ€è¦äº‹åŠ¡çš„æ”¯æŒçš„ï¼Œå¯ä»¥å°† MyIASM ä½œä¸ºæ•°æ®åº“å¼•æ“çš„é¦–é€‰</strong></p>
<h2 id="mysql-ä¸»ä»åŒæ­¥åˆ†å“ªå‡ ä¸ªè¿‡ç¨‹"><a href="#mysql-ä¸»ä»åŒæ­¥åˆ†å“ªå‡ ä¸ªè¿‡ç¨‹" class="headerlink" title="mysql ä¸»ä»åŒæ­¥åˆ†å“ªå‡ ä¸ªè¿‡ç¨‹"></a>mysql ä¸»ä»åŒæ­¥åˆ†å“ªå‡ ä¸ªè¿‡ç¨‹</h2><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/mysql/mysql_master_slave_sync.jpg" alt><br>å¤åˆ¶çš„åŸºæœ¬è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ä»èŠ‚ç‚¹ä¸Šçš„I/O çº¿ç¨‹è¿æ¥ä¸»èŠ‚ç‚¹ï¼Œå¹¶è¯·æ±‚ä»æŒ‡å®šæ—¥å¿—æ–‡ä»¶çš„æŒ‡å®šä½ç½®ï¼ˆæˆ–è€…ä»æœ€å¼€å§‹çš„æ—¥å¿—ï¼‰ä¹‹åçš„æ—¥å¿—å†…å®¹ï¼›</li>
<li>ä¸»èŠ‚ç‚¹æ¥æ”¶åˆ°æ¥è‡ªä»èŠ‚ç‚¹çš„I/Oè¯·æ±‚åï¼Œé€šè¿‡è´Ÿè´£å¤åˆ¶çš„I/Oçº¿ç¨‹æ ¹æ®è¯·æ±‚ä¿¡æ¯è¯»å–æŒ‡å®šæ—¥å¿—æŒ‡å®šä½ç½®ä¹‹åçš„æ—¥å¿—ä¿¡æ¯ï¼Œè¿”å›ç»™ä»èŠ‚ç‚¹ã€‚è¿”å›ä¿¡æ¯ä¸­é™¤äº†æ—¥å¿—æ‰€åŒ…å«çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜åŒ…æ‹¬æœ¬æ¬¡è¿”å›çš„ä¿¡æ¯çš„bin-log file çš„ä»¥åŠbin-log positionï¼›ä»èŠ‚ç‚¹çš„I/Oçº¿ç¨‹æ¥æ”¶åˆ°å†…å®¹åï¼Œå°†æ¥æ”¶åˆ°çš„æ—¥å¿—å†…å®¹æ›´æ–°åˆ°æœ¬æœºçš„relay logä¸­ï¼Œå¹¶å°†è¯»å–åˆ°çš„binary logæ–‡ä»¶åå’Œä½ç½®ä¿å­˜åˆ°master-info æ–‡ä»¶ä¸­ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€æ¬¡è¯»å–çš„æ—¶å€™èƒ½å¤Ÿæ¸…æ¥šçš„å‘Šè¯‰Masterâ€œæˆ‘éœ€è¦ä»æŸä¸ªbin-log çš„å“ªä¸ªä½ç½®å¼€å§‹å¾€åçš„æ—¥å¿—å†…å®¹ï¼Œè¯·å‘ç»™æˆ‘â€ï¼›</li>
<li>Slave çš„ SQLçº¿ç¨‹æ£€æµ‹åˆ°relay-log ä¸­æ–°å¢åŠ äº†å†…å®¹åï¼Œä¼šå°†relay-logçš„å†…å®¹è§£ææˆåœ¨ä¸»èŠ‚ç‚¹ä¸Šå®é™…æ‰§è¡Œè¿‡çš„æ“ä½œï¼Œå¹¶åœ¨æœ¬æ•°æ®åº“ä¸­æ‰§è¡Œã€‚</li>
</ol>
<h2 id="ä¸»ä»åŒæ­¥å»¶è¿Ÿä¸åŒæ­¥æ•°æ®ä¸¢å¤±é—®é¢˜"><a href="#ä¸»ä»åŒæ­¥å»¶è¿Ÿä¸åŒæ­¥æ•°æ®ä¸¢å¤±é—®é¢˜" class="headerlink" title="ä¸»ä»åŒæ­¥å»¶è¿Ÿä¸åŒæ­¥æ•°æ®ä¸¢å¤±é—®é¢˜"></a>ä¸»ä»åŒæ­¥å»¶è¿Ÿä¸åŒæ­¥æ•°æ®ä¸¢å¤±é—®é¢˜</h2><p>ä¸»åº“å°†å˜æ›´å†™binlogæ—¥å¿—ï¼Œç„¶åä»åº“è¿æ¥åˆ°ä¸»åº“ä¹‹åï¼Œä»åº“æœ‰ä¸€ä¸ªIOçº¿ç¨‹ï¼Œå°†ä¸»åº“çš„binlogæ—¥å¿—æ‹·è´åˆ°è‡ªå·±æœ¬åœ°ï¼Œå†™å…¥ä¸€ä¸ªä¸­ç»§æ—¥å¿—ä¸­ã€‚æ¥ç€ä»åº“ä¸­æœ‰ä¸€ä¸ªSQLçº¿ç¨‹ä¼šä»ä¸­ç»§æ—¥å¿—è¯»å–binlogï¼Œç„¶åæ‰§è¡Œbinlogæ—¥å¿—ä¸­çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯åœ¨è‡ªå·±æœ¬åœ°å†æ¬¡æ‰§è¡Œä¸€éSQLï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯è‡ªå·±è·Ÿä¸»åº“çš„æ•°æ®æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„ä¸€ç‚¹ï¼Œå°±æ˜¯ä»åº“åŒæ­¥ä¸»åº“æ•°æ®çš„è¿‡ç¨‹æ˜¯ä¸²è¡ŒåŒ–çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸»åº“ä¸Šå¹¶è¡Œçš„æ“ä½œï¼Œåœ¨ä»åº“ä¸Šä¼šä¸²è¡Œæ‰§è¡Œã€‚æ‰€ä»¥è¿™å°±æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç‚¹äº†ï¼Œç”±äºä»åº“ä»ä¸»åº“æ‹·è´æ—¥å¿—ä»¥åŠä¸²è¡Œæ‰§è¡ŒSQLçš„ç‰¹ç‚¹ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä»åº“çš„æ•°æ®ä¸€å®šä¼šæ¯”ä¸»åº“æ…¢ä¸€äº›ï¼Œæ˜¯æœ‰å»¶æ—¶çš„ã€‚æ‰€ä»¥ç»å¸¸å‡ºç°ï¼Œåˆšå†™å…¥ä¸»åº“çš„æ•°æ®å¯èƒ½æ˜¯è¯»ä¸åˆ°çš„ï¼Œè¦è¿‡å‡ åæ¯«ç§’ï¼Œç”šè‡³å‡ ç™¾æ¯«ç§’æ‰èƒ½è¯»å–åˆ°ã€‚</p>
<p>è€Œä¸”è¿™é‡Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœä¸»åº“çªç„¶å®•æœºï¼Œç„¶åæ°å¥½æ•°æ®è¿˜æ²¡åŒæ­¥åˆ°ä»åº“ï¼Œé‚£ä¹ˆæœ‰äº›æ•°æ®å¯èƒ½åœ¨ä»åº“ä¸Šæ˜¯æ²¡æœ‰çš„ï¼Œæœ‰äº›æ•°æ®å¯èƒ½å°±ä¸¢å¤±äº†ã€‚<br>æ‰€ä»¥mysqlå®é™…ä¸Šåœ¨è¿™ä¸€å—æœ‰ä¸¤ä¸ªæœºåˆ¶:</p>
<ul>
<li>ä¸€ä¸ªæ˜¯åŠåŒæ­¥å¤åˆ¶ï¼Œç”¨æ¥è§£å†³ä¸»åº“æ•°æ®ä¸¢å¤±é—®é¢˜</li>
<li>ä¸€ä¸ªæ˜¯å¹¶è¡Œå¤åˆ¶ï¼Œç”¨æ¥è§£å†³ä¸»ä»åŒæ­¥å»¶æ—¶é—®é¢˜(å®åœ¨è§£å†³ä¸äº†åªèƒ½å¼ºåˆ¶è¯»ä¸»åº“)ã€‚</li>
</ul>
<h3 id="åŠåŒæ­¥å¤åˆ¶ï¼ˆSemisynchronous-replicationï¼‰"><a href="#åŠåŒæ­¥å¤åˆ¶ï¼ˆSemisynchronous-replicationï¼‰" class="headerlink" title="åŠåŒæ­¥å¤åˆ¶ï¼ˆSemisynchronous replicationï¼‰"></a>åŠåŒæ­¥å¤åˆ¶ï¼ˆSemisynchronous replicationï¼‰</h3><ul>
<li><strong>é€»è¾‘ä¸Š</strong>: æ˜¯ä»‹äºå…¨åŒæ­¥å¤åˆ¶ä¸å…¨å¼‚æ­¥å¤åˆ¶ä¹‹é—´çš„ä¸€ç§ï¼Œä¸»åº“åªéœ€è¦ç­‰å¾…è‡³å°‘ä¸€ä¸ªä»åº“èŠ‚ç‚¹æ”¶åˆ°å¹¶ä¸” Flush Binlog åˆ° Relay Log æ–‡ä»¶å³å¯ï¼Œä¸»åº“ä¸éœ€è¦ç­‰å¾…æ‰€æœ‰ä»åº“ç»™ä¸»åº“åé¦ˆã€‚åŒæ—¶ï¼Œè¿™é‡Œåªæ˜¯ä¸€ä¸ªæ”¶åˆ°çš„åé¦ˆï¼Œè€Œä¸æ˜¯å·²ç»å®Œå…¨å®Œæˆå¹¶ä¸”æäº¤çš„åé¦ˆï¼Œå¦‚æ­¤ï¼ŒèŠ‚çœäº†å¾ˆå¤šæ—¶é—´ã€‚</li>
<li><strong>æŠ€æœ¯ä¸Š</strong>: ä»‹äºå¼‚æ­¥å¤åˆ¶å’Œå…¨åŒæ­¥å¤åˆ¶ä¹‹é—´ï¼Œ<strong>ä¸»åº“åœ¨æ‰§è¡Œå®Œå®¢æˆ·ç«¯æäº¤çš„äº‹åŠ¡åä¸æ˜¯ç«‹åˆ»è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè€Œæ˜¯ç­‰å¾…è‡³å°‘ä¸€ä¸ªä»åº“æ¥æ”¶åˆ°å¹¶å†™åˆ°relay logä¸­æ‰è¿”å›ç»™å®¢æˆ·ç«¯</strong>ã€‚ç›¸å¯¹äºå¼‚æ­¥å¤åˆ¶ï¼ŒåŠåŒæ­¥å¤åˆ¶æé«˜äº†æ•°æ®çš„å®‰å…¨æ€§ï¼ŒåŒæ—¶å®ƒä¹Ÿé€ æˆäº†ä¸€å®šç¨‹åº¦çš„å»¶è¿Ÿï¼Œè¿™ä¸ªå»¶è¿Ÿæœ€å°‘æ˜¯ä¸€ä¸ªTCP/IPå¾€è¿”çš„æ—¶é—´ã€‚æ‰€ä»¥ï¼ŒåŠåŒæ­¥å¤åˆ¶æœ€å¥½åœ¨ä½å»¶æ—¶çš„ç½‘ç»œä¸­ä½¿ç”¨ã€‚</li>
</ul>
<h3 id="åº“å¹¶è¡Œå¤åˆ¶"><a href="#åº“å¹¶è¡Œå¤åˆ¶" class="headerlink" title="åº“å¹¶è¡Œå¤åˆ¶"></a>åº“å¹¶è¡Œå¤åˆ¶</h3><p>æ‰€è°“å¹¶è¡Œå¤åˆ¶ï¼ŒæŒ‡çš„æ˜¯ä»åº“å¼€å¯å¤šä¸ªçº¿ç¨‹ï¼Œå¹¶è¡Œè¯»å–relay logä¸­ä¸åŒåº“çš„æ—¥å¿—ï¼Œç„¶åå¹¶è¡Œé‡æ”¾ä¸åŒåº“çš„æ—¥å¿—ï¼Œ<strong>è¿™æ˜¯åº“çº§åˆ«çš„å¹¶è¡Œã€‚</strong></p>
<h3 id="å¼‚æ­¥å¤åˆ¶ï¼ˆAsynchronous-replicationï¼‰"><a href="#å¼‚æ­¥å¤åˆ¶ï¼ˆAsynchronous-replicationï¼‰" class="headerlink" title="å¼‚æ­¥å¤åˆ¶ï¼ˆAsynchronous replicationï¼‰"></a>å¼‚æ­¥å¤åˆ¶ï¼ˆAsynchronous replicationï¼‰</h3><ul>
<li><strong>é€»è¾‘ä¸Š</strong>: MySQLé»˜è®¤çš„å¤åˆ¶å³æ˜¯å¼‚æ­¥çš„ï¼Œä¸»åº“åœ¨æ‰§è¡Œå®Œå®¢æˆ·ç«¯æäº¤çš„äº‹åŠ¡åä¼šç«‹å³å°†ç»“æœè¿”ç»™ç»™å®¢æˆ·ç«¯ï¼Œå¹¶ä¸å…³å¿ƒä»åº“æ˜¯å¦å·²ç»æ¥æ”¶å¹¶å¤„ç†ï¼Œè¿™æ ·å°±ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸»å¦‚æœcrashæ‰äº†ï¼Œæ­¤æ—¶ä¸»ä¸Šå·²ç»æäº¤çš„äº‹åŠ¡å¯èƒ½å¹¶æ²¡æœ‰ä¼ åˆ°ä»åº“ä¸Šï¼Œå¦‚æœæ­¤æ—¶ï¼Œå¼ºè¡Œå°†ä»æå‡ä¸ºä¸»ï¼Œå¯èƒ½å¯¼è‡´æ–°ä¸»ä¸Šçš„æ•°æ®ä¸å®Œæ•´ã€‚</li>
<li><strong>æŠ€æœ¯ä¸Š</strong>: ä¸»åº“å°†äº‹åŠ¡ Binlog äº‹ä»¶å†™å…¥åˆ° Binlog æ–‡ä»¶ä¸­ï¼Œæ­¤æ—¶ä¸»åº“åªä¼šé€šçŸ¥ä¸€ä¸‹ Dump çº¿ç¨‹å‘é€è¿™äº›æ–°çš„ Binlogï¼Œç„¶åä¸»åº“å°±ä¼šç»§ç»­å¤„ç†æäº¤æ“ä½œï¼Œè€Œæ­¤æ—¶ä¸ä¼šä¿è¯è¿™äº› Binlog ä¼ åˆ°ä»»ä½•ä¸€ä¸ªä»åº“èŠ‚ç‚¹ä¸Šã€‚</li>
</ul>
<h3 id="å…¨åŒæ­¥å¤åˆ¶ï¼ˆFully-synchronous-replicationï¼‰"><a href="#å…¨åŒæ­¥å¤åˆ¶ï¼ˆFully-synchronous-replicationï¼‰" class="headerlink" title="å…¨åŒæ­¥å¤åˆ¶ï¼ˆFully synchronous replicationï¼‰"></a>å…¨åŒæ­¥å¤åˆ¶ï¼ˆFully synchronous replicationï¼‰</h3><ul>
<li><strong>é€»è¾‘ä¸Š</strong>: æŒ‡å½“ä¸»åº“æ‰§è¡Œå®Œä¸€ä¸ªäº‹åŠ¡ï¼Œæ‰€æœ‰çš„ä»åº“éƒ½æ‰§è¡Œäº†è¯¥äº‹åŠ¡æ‰è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å› ä¸ºéœ€è¦ç­‰å¾…æ‰€æœ‰ä»åº“æ‰§è¡Œå®Œè¯¥äº‹åŠ¡æ‰èƒ½è¿”å›ï¼Œæ‰€ä»¥å…¨åŒæ­¥å¤åˆ¶çš„æ€§èƒ½å¿…ç„¶ä¼šæ”¶åˆ°ä¸¥é‡çš„å½±å“ã€‚</li>
<li><strong>æŠ€æœ¯ä¸Š</strong>: <strong>å½“ä¸»åº“æäº¤äº‹åŠ¡ä¹‹åï¼Œæ‰€æœ‰çš„ä»åº“èŠ‚ç‚¹å¿…é¡»æ”¶åˆ°ã€APPLYå¹¶ä¸”æäº¤è¿™äº›äº‹åŠ¡ï¼Œç„¶åä¸»åº“çº¿ç¨‹æ‰èƒ½ç»§ç»­åšåç»­æ“ä½œ</strong>ã€‚ä½†ç¼ºç‚¹æ˜¯ï¼Œä¸»åº“å®Œæˆä¸€ä¸ªäº‹åŠ¡çš„æ—¶é—´ä¼šè¢«æ‹‰é•¿ï¼Œæ€§èƒ½é™ä½ã€‚</li>
</ul>
<h2 id="ä¹è§‚é”ä¸æ‚²è§‚é”çš„åŒºåˆ«ï¼Ÿ"><a href="#ä¹è§‚é”ä¸æ‚²è§‚é”çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="ä¹è§‚é”ä¸æ‚²è§‚é”çš„åŒºåˆ«ï¼Ÿ"></a>ä¹è§‚é”ä¸æ‚²è§‚é”çš„åŒºåˆ«ï¼Ÿ</h2><ul>
<li>æ‚²è§‚é”ï¼šè®¤ä¸ºæ•°æ®éšæ—¶ä¼šè¢«ä¿®æ”¹ï¼Œå› æ­¤æ¯æ¬¡è¯»å–æ•°æ®ä¹‹å‰éƒ½ä¼šä¸Šé”ï¼Œé˜²æ­¢å…¶å®ƒäº‹åŠ¡è¯»å–æˆ–ä¿®æ”¹æ•°æ®ï¼›åº”ç”¨äºæ•°æ®æ›´æ–°æ¯”è¾ƒé¢‘ç¹çš„åœºæ™¯ï¼›</li>
<li>ä¹è§‚é”ï¼šæ“ä½œæ•°æ®æ—¶ä¸ä¼šä¸Šé”ï¼Œä½†æ˜¯æ›´æ–°æ—¶ä¼šåˆ¤æ–­åœ¨æ­¤æœŸé—´æœ‰æ²¡æœ‰åˆ«çš„äº‹åŠ¡æ›´æ–°è¿™ä¸ªæ•°æ®ï¼Œè‹¥è¢«æ›´æ–°è¿‡ï¼Œåˆ™å¤±è´¥é‡è¯•ï¼›é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚</li>
</ul>
<p>ä¹è§‚é”æ€ä¹ˆå®ç°:  </p>
<ul>
<li>åŠ ç‰ˆæœ¬å·</li>
<li>cas</li>
</ul>
<h2 id="å®ç°äº‹åŠ¡é‡‡å–äº†å“ªäº›æŠ€æœ¯ä»¥åŠæ€æƒ³ï¼Ÿ"><a href="#å®ç°äº‹åŠ¡é‡‡å–äº†å“ªäº›æŠ€æœ¯ä»¥åŠæ€æƒ³ï¼Ÿ" class="headerlink" title="å®ç°äº‹åŠ¡é‡‡å–äº†å“ªäº›æŠ€æœ¯ä»¥åŠæ€æƒ³ï¼Ÿ"></a>å®ç°äº‹åŠ¡é‡‡å–äº†å“ªäº›æŠ€æœ¯ä»¥åŠæ€æƒ³ï¼Ÿ</h2><ul>
<li>â˜… aåŸå­æ€§ï¼šä½¿ç”¨ undo log ï¼Œä»è€Œè¾¾åˆ°å›æ»š</li>
<li>â˜… dæŒä¹…æ€§ï¼šä½¿ç”¨ redo logï¼Œä»è€Œè¾¾åˆ°æ•…éšœåæ¢å¤</li>
<li>â˜… iéš”ç¦»æ€§ï¼šä½¿ç”¨é”ä»¥åŠMVCC,è¿ç”¨çš„ä¼˜åŒ–æ€æƒ³æœ‰è¯»å†™åˆ†ç¦»ï¼Œè¯»è¯»å¹¶è¡Œï¼Œè¯»å†™å¹¶è¡Œ</li>
<li>â˜… cä¸€è‡´æ€§ï¼šé€šè¿‡å›æ»šï¼Œä»¥åŠæ¢å¤ï¼Œå’Œåœ¨å¹¶å‘ç¯å¢ƒä¸‹çš„éš”ç¦»åšåˆ°ä¸€è‡´æ€§ã€‚</li>
</ul>
<h2 id="mysqlå››ä¸ªäº‹åŠ¡éš”ç¦»çº§åˆ«"><a href="#mysqlå››ä¸ªäº‹åŠ¡éš”ç¦»çº§åˆ«" class="headerlink" title="mysqlå››ä¸ªäº‹åŠ¡éš”ç¦»çº§åˆ«"></a>mysqlå››ä¸ªäº‹åŠ¡éš”ç¦»çº§åˆ«</h2><p><a href="https://developer.aliyun.com/article/743691" target="_blank" rel="noopener">å››ä¸ªéš”ç¦»çº§åˆ«çš„åŒºåˆ«ä»¥åŠæ¯ä¸ªçº§åˆ«å¯èƒ½äº§ç”Ÿçš„é—®é¢˜ä»¥åŠå®ç°åŸç†</a><br>MySQL çš„äº‹åŠ¡éš”ç¦»æ˜¯åœ¨ MySQL. ini é…ç½®æ–‡ä»¶é‡Œæ·»åŠ çš„ï¼Œåœ¨æ–‡ä»¶çš„æœ€åæ·»åŠ ï¼š<code>transaction-isolation = REPEATABLE-READ</code><br>å¯ç”¨çš„é…ç½®å€¼ï¼š<code>READ-UNCOMMITTED</code>ã€<code>READ-COMMITTED</code>ã€<code>REPEATABLE-READ</code>ã€<code>SERIALIZABLE</code>ã€‚</p>
<p>MySQLçš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸€å…±æœ‰å››ä¸ªï¼Œåˆ†åˆ«æ˜¯</p>
<ul>
<li>è¯»æœªæäº¤</li>
<li>è¯»å·²æäº¤</li>
<li>å¯é‡å¤è¯»</li>
<li>å¯ä¸²è¡ŒåŒ–</li>
</ul>
<p>MySQLçš„éš”ç¦»çº§åˆ«çš„ä½œç”¨å°±æ˜¯è®©äº‹åŠ¡ä¹‹é—´äº’ç›¸éš”ç¦»ï¼Œäº’ä¸å½±å“ï¼Œè¿™æ ·å¯ä»¥ä¿è¯äº‹åŠ¡çš„ä¸€è‡´æ€§ã€‚</p>
<ul>
<li>éš”ç¦»çº§åˆ«æ¯”è¾ƒï¼šå¯ä¸²è¡ŒåŒ–&gt;å¯é‡å¤è¯»&gt;è¯»å·²æäº¤&gt;è¯»æœªæäº¤</li>
<li>éš”ç¦»çº§åˆ«å¯¹æ€§èƒ½çš„å½±å“æ¯”è¾ƒï¼šå¯ä¸²è¡ŒåŒ–&gt;å¯é‡å¤è¯»&gt;è¯»å·²æäº¤&gt;è¯»æœªæäº¤</li>
</ul>
<p>ç”±æ­¤çœ‹å‡ºï¼Œéš”ç¦»çº§åˆ«è¶Šé«˜ï¼Œæ‰€éœ€è¦æ¶ˆè€—çš„MySQLæ€§èƒ½è¶Šå¤§ï¼ˆå¦‚äº‹åŠ¡å¹¶å‘ä¸¥é‡æ€§ï¼‰ï¼Œä¸ºäº†å¹³è¡¡äºŒè€…ï¼Œä¸€èˆ¬å»ºè®®è®¾ç½®çš„éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯»ï¼ŒMySQLé»˜è®¤çš„éš”ç¦»çº§åˆ«ä¹Ÿæ˜¯å¯é‡å¤è¯»ã€‚</p>
<h3 id="äº‹åŠ¡å¹¶å‘å¯èƒ½å‡ºç°çš„æƒ…å†µ"><a href="#äº‹åŠ¡å¹¶å‘å¯èƒ½å‡ºç°çš„æƒ…å†µ" class="headerlink" title="äº‹åŠ¡å¹¶å‘å¯èƒ½å‡ºç°çš„æƒ…å†µ"></a>äº‹åŠ¡å¹¶å‘å¯èƒ½å‡ºç°çš„æƒ…å†µ</h3><ul>
<li>è„è¯»ï¼ˆDirty Readï¼‰<ul>
<li>ä¸€ä¸ªäº‹åŠ¡è¯»åˆ°äº†å¦ä¸€ä¸ªæœªæäº¤äº‹åŠ¡ä¿®æ”¹è¿‡çš„æ•°æ®</li>
<li>ä¼šè¯Bå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼ŒæŠŠid=1çš„nameä¸ºæ­¦æ±‰å¸‚ä¿®æ”¹æˆæ¸©å·å¸‚ï¼Œæ­¤æ—¶å¦å¤–ä¸€ä¸ªä¼šè¯Aä¹Ÿå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œè¯»å–id=1çš„nameï¼Œæ­¤æ—¶çš„æŸ¥è¯¢ç»“æœä¸ºæ¸©å·å¸‚ï¼Œä¼šè¯Bçš„äº‹åŠ¡æœ€åå›æ»šäº†åˆšæ‰ä¿®æ”¹çš„è®°å½•ï¼Œè¿™æ ·ä¼šè¯Aè¯»åˆ°çš„æ•°æ®æ˜¯ä¸å­˜åœ¨çš„ï¼Œè¿™ä¸ªç°è±¡å°±æ˜¯è„è¯»ã€‚ï¼ˆè„è¯»åªåœ¨è¯»æœªæäº¤éš”ç¦»çº§åˆ«æ‰ä¼šå‡ºç°ï¼‰</li>
</ul>
</li>
<li>ä¸å¯é‡å¤è¯»ï¼ˆNon-Repeatable Readï¼‰<ul>
<li>ä¸€ä¸ªäº‹åŠ¡åªèƒ½è¯»åˆ°å¦ä¸€ä¸ªå·²ç»æäº¤çš„äº‹åŠ¡ä¿®æ”¹è¿‡çš„æ•°æ®ï¼Œå¹¶ä¸”å…¶ä»–äº‹åŠ¡æ¯å¯¹è¯¥æ•°æ®è¿›è¡Œä¸€æ¬¡ä¿®æ”¹å¹¶æäº¤åï¼Œè¯¥äº‹åŠ¡éƒ½èƒ½æŸ¥è¯¢å¾—åˆ°æœ€æ–°å€¼ã€‚ï¼ˆä¸å¯é‡å¤è¯»åœ¨è¯»æœªæäº¤å’Œè¯»å·²æäº¤éš”ç¦»çº§åˆ«éƒ½å¯èƒ½ä¼šå‡ºç°ï¼‰</li>
<li>ä¼šè¯Aå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼ŒæŸ¥è¯¢id=1çš„ç»“æœï¼Œæ­¤æ—¶æŸ¥è¯¢çš„ç»“æœnameä¸ºæ­¦æ±‰å¸‚ã€‚æ¥ç€ä¼šè¯BæŠŠid=1çš„nameä¿®æ”¹ä¸ºæ¸©å·å¸‚ï¼ˆéšå¼äº‹åŠ¡ï¼Œå› ä¸ºæ­¤æ—¶çš„autocommitä¸º1ï¼Œæ¯æ¡SQLè¯­å¥æ‰§è¡Œå®Œè‡ªåŠ¨æäº¤ï¼‰ï¼Œæ­¤æ—¶ä¼šè¯Açš„äº‹åŠ¡å†ä¸€æ¬¡æŸ¥è¯¢id=1çš„ç»“æœï¼Œè¯»å–çš„ç»“æœnameä¸ºæ¸©å·å¸‚ã€‚ä¼šè¯Bå†æ­¤ä¿®æ”¹id=1çš„nameä¸ºæ­å·å¸‚ï¼Œä¼šè¯Açš„äº‹åŠ¡å†æ¬¡æŸ¥è¯¢id=1ï¼Œç»“æœnameçš„å€¼ä¸ºæ­å·å¸‚ï¼Œè¿™ç§ç°è±¡å°±æ˜¯ä¸å¯é‡å¤è¯»ã€‚</li>
</ul>
</li>
<li>å¹»è¯»ï¼ˆPhantomï¼‰<ul>
<li>ä¸€ä¸ªäº‹åŠ¡å…ˆæ ¹æ®æŸäº›æ¡ä»¶æŸ¥è¯¢å‡ºä¸€äº›è®°å½•ï¼Œä¹‹åå¦ä¸€ä¸ªäº‹åŠ¡åˆå‘è¡¨ä¸­æ’å…¥äº†ç¬¦åˆè¿™äº›æ¡ä»¶çš„è®°å½•ï¼ŒåŸå…ˆçš„äº‹åŠ¡å†æ¬¡æŒ‰ç…§è¯¥æ¡ä»¶æŸ¥è¯¢æ—¶ï¼Œèƒ½æŠŠå¦ä¸€ä¸ªäº‹åŠ¡æ’å…¥çš„è®°å½•ä¹Ÿè¯»å‡ºæ¥ã€‚ï¼ˆå¹»è¯»åœ¨è¯»æœªæäº¤ã€è¯»å·²æäº¤ã€å¯é‡å¤è¯»éš”ç¦»çº§åˆ«éƒ½å¯èƒ½ä¼šå‡ºç°ï¼‰</li>
<li>ä¼šè¯Aå¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼ŒæŸ¥è¯¢id&gt;0çš„è®°å½•ï¼Œæ­¤æ—¶ä¼šæŸ¥åˆ°name=æ­¦æ±‰å¸‚çš„è®°å½•ã€‚æ¥ç€ä¼šè¯Bæ’å…¥ä¸€æ¡name=æ¸©å·å¸‚çš„æ•°æ®ï¼ˆéšå¼äº‹åŠ¡ï¼Œå› ä¸ºæ­¤æ—¶çš„autocommitä¸º1ï¼Œæ¯æ¡SQLè¯­å¥æ‰§è¡Œå®Œè‡ªåŠ¨æäº¤ï¼‰ï¼Œè¿™æ—¶ä¼šè¯Açš„äº‹åŠ¡å†ä»¥åˆšæ‰çš„æŸ¥è¯¢æ¡ä»¶ï¼ˆid&gt;0ï¼‰å†ä¸€æ¬¡æŸ¥è¯¢ï¼Œæ­¤æ—¶ä¼šå‡ºç°ä¸¤æ¡è®°å½•ï¼ˆnameä¸ºæ­¦æ±‰å¸‚å’Œæ¸©å·å¸‚çš„è®°å½•ï¼‰ï¼Œè¿™ç§ç°è±¡å°±æ˜¯å¹»è¯»ã€‚</li>
</ul>
</li>
</ul>
<h3 id="å„ä¸ªéš”ç¦»çº§åˆ«çš„è¯¦ç»†è¯´æ˜"><a href="#å„ä¸ªéš”ç¦»çº§åˆ«çš„è¯¦ç»†è¯´æ˜" class="headerlink" title="å„ä¸ªéš”ç¦»çº§åˆ«çš„è¯¦ç»†è¯´æ˜"></a>å„ä¸ªéš”ç¦»çº§åˆ«çš„è¯¦ç»†è¯´æ˜</h3><ul>
<li>è¯»æœªæäº¤ï¼ˆREAD UNCOMMITTEDï¼‰<ul>
<li>åœ¨è¯»æœªæäº¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡Aå¯ä»¥è¯»å–åˆ°äº‹åŠ¡Bä¿®æ”¹è¿‡ä½†æœªæäº¤çš„æ•°æ®ã€‚</li>
<li>å¯èƒ½å‘ç”Ÿè„è¯»ã€ä¸å¯é‡å¤è¯»å’Œå¹»è¯»é—®é¢˜ï¼Œä¸€èˆ¬å¾ˆå°‘ä½¿ç”¨æ­¤éš”ç¦»çº§åˆ«ã€‚</li>
</ul>
</li>
<li>è¯»å·²æäº¤ï¼ˆREAD COMMITTEDï¼‰<ul>
<li>åœ¨è¯»å·²æäº¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡Båªèƒ½åœ¨äº‹åŠ¡Aä¿®æ”¹è¿‡å¹¶ä¸”å·²æäº¤åæ‰èƒ½è¯»å–åˆ°äº‹åŠ¡Bä¿®æ”¹çš„æ•°æ®ã€‚</li>
<li>è¯»å·²æäº¤éš”ç¦»çº§åˆ«è§£å†³äº†è„è¯»çš„é—®é¢˜ï¼Œä½†å¯èƒ½å‘ç”Ÿä¸å¯é‡å¤è¯»å’Œå¹»è¯»é—®é¢˜ï¼Œä¸€èˆ¬å¾ˆå°‘ä½¿ç”¨æ­¤éš”ç¦»çº§åˆ«ã€‚</li>
</ul>
</li>
<li>å¯é‡å¤è¯»ï¼ˆREPEATABLE READï¼‰<ul>
<li>åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡Båªèƒ½åœ¨äº‹åŠ¡Aä¿®æ”¹è¿‡æ•°æ®å¹¶æäº¤åï¼Œè‡ªå·±ä¹Ÿæäº¤äº‹åŠ¡åï¼Œæ‰èƒ½è¯»å–åˆ°äº‹åŠ¡Bä¿®æ”¹çš„æ•°æ®ã€‚</li>
<li>å¯é‡å¤è¯»éš”ç¦»çº§åˆ«è§£å†³äº†è„è¯»å’Œä¸å¯é‡å¤è¯»çš„é—®é¢˜ï¼Œä½†å¯èƒ½å‘ç”Ÿå¹»è¯»é—®é¢˜ã€‚</li>
<li>æé—®ï¼šä¸ºä»€ä¹ˆä¸Šäº†å†™é”ï¼ˆå†™æ“ä½œï¼‰ï¼Œåˆ«çš„äº‹åŠ¡è¿˜å¯ä»¥è¯»æ“ä½œï¼Ÿå› ä¸ºInnoDBæœ‰MVCCæœºåˆ¶ï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨å¿«ç…§è¯»ï¼Œè€Œä¸ä¼šè¢«é˜»å¡ã€‚</li>
</ul>
</li>
<li>å¯ä¸²è¡ŒåŒ–ï¼ˆSERIALIZABLEï¼‰<ul>
<li>å„ç§é—®é¢˜ï¼ˆè„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»ï¼‰éƒ½ä¸ä¼šå‘ç”Ÿï¼Œé€šè¿‡åŠ é”å®ç°ï¼ˆè¯»é”å’Œå†™é”ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<h2 id="mvccæ˜¯å•¥"><a href="#mvccæ˜¯å•¥" class="headerlink" title="mvccæ˜¯å•¥"></a>mvccæ˜¯å•¥</h2><p>mvccå¿…çœ‹æ–‡ç« : </p>
<ul>
<li><a href="https://www.jianshu.com/p/f692d4f8a53e" target="_blank" rel="noopener">mysql mvccå®ç°åŸç†</a>  </li>
<li><a href="https://chenjiayang.me/2019/06/22/mysql-innodb-mvcc/" target="_blank" rel="noopener">https://chenjiayang.me/2019/06/22/mysql-innodb-mvcc/</a></li>
</ul>
<p>MVCC (Multiversion Concurrency Control) ä¸­æ–‡å…¨ç¨‹å«<strong>å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶</strong>ï¼Œæ˜¯ç°ä»£æ•°æ®åº“ï¼ˆåŒ…æ‹¬ MySQLã€Oracleã€PostgreSQL ç­‰ï¼‰å¼•æ“å®ç°ä¸­å¸¸ç”¨çš„å¤„ç†è¯»å†™å†²çªçš„æ‰‹æ®µï¼Œç›®çš„åœ¨äºæé«˜æ•°æ®åº“é«˜å¹¶å‘åœºæ™¯ä¸‹çš„ååæ€§èƒ½ã€‚MVCC çš„æ¯ä¸€ä¸ªå†™æ“ä½œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°ç‰ˆæœ¬çš„æ•°æ®ï¼Œè¯»æ“ä½œä¼šä»æœ‰é™å¤šä¸ªç‰ˆæœ¬çš„æ•°æ®ä¸­æŒ‘é€‰ä¸€ä¸ªæœ€åˆé€‚ï¼ˆè¦ä¹ˆæ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œè¦ä¹ˆæ˜¯æŒ‡å®šç‰ˆæœ¬ï¼‰çš„ç»“æœç›´æ¥è¿”å› ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦å…³æ³¨è¯»å†™æ“ä½œä¹‹é—´çš„æ•°æ®å†²çª</p>
<p><strong>æ¯æ¡è®°å½•åœ¨æ›´æ–°çš„æ—¶å€™éƒ½ä¼šåŒæ—¶è®°å½•ä¸€æ¡å›æ»šæ“ä½œï¼ˆå›æ»šæ“ä½œæ—¥å¿—undo logï¼‰ã€‚åŒä¸€æ¡è®°å½•åœ¨ç³»ç»Ÿä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªç‰ˆæœ¬ï¼Œè¿™å°±æ˜¯æ•°æ®åº“çš„å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰ã€‚å³é€šè¿‡å›æ»šï¼ˆrollbackæ“ä½œï¼‰ï¼Œå¯ä»¥å›åˆ°å‰ä¸€ä¸ªçŠ¶æ€çš„å€¼ã€‚InnoDB ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè®¾è®¡äº† ReadViewï¼ˆå¯è¯»è§†å›¾ï¼‰çš„æ¦‚å¿µ.</strong></p>
<p>å¦‚æ­¤ä¸€æ¥ä¸åŒçš„äº‹åŠ¡åœ¨å¹¶å‘è¿‡ç¨‹ä¸­ï¼ŒSELECT æ“ä½œå¯ä»¥ä¸åŠ é”è€Œæ˜¯é€šè¿‡ MVCC æœºåˆ¶è¯»å–æŒ‡å®šçš„ç‰ˆæœ¬å†å²è®°å½•ï¼Œå¹¶é€šè¿‡ä¸€äº›æ‰‹æ®µä¿è¯ä¿è¯è¯»å–çš„è®°å½•å€¼ç¬¦åˆäº‹åŠ¡æ‰€å¤„çš„éš”ç¦»çº§åˆ«ï¼Œä»è€Œè§£å†³å¹¶å‘åœºæ™¯ä¸‹çš„è¯»å†™å†²çªã€‚</p>
<p>mysqlæŠŠæ¯ä¸ªæ“ä½œéƒ½å®šä¹‰æˆä¸€ä¸ªäº‹åŠ¡ï¼Œæ¯å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œç³»ç»Ÿçš„äº‹åŠ¡ç‰ˆæœ¬å·è‡ªåŠ¨é€’å¢ã€‚æ¯è¡Œè®°å½•éƒ½æœ‰ä¸¤ä¸ªéšè—åˆ—ï¼šåˆ›å»ºç‰ˆæœ¬å·å’Œåˆ é™¤ç‰ˆæœ¬å·</p>
<h3 id="ReadView"><a href="#ReadView" class="headerlink" title="ReadView"></a>ReadView</h3><ul>
<li>ç³»ç»Ÿç‰ˆæœ¬å· SYS_IDï¼šæ˜¯ä¸€ä¸ªé€’å¢çš„æ•°å­—ï¼Œæ¯å¼€å§‹ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œç³»ç»Ÿç‰ˆæœ¬å·å°±ä¼šè‡ªåŠ¨é€’å¢ã€‚</li>
<li>äº‹åŠ¡ç‰ˆæœ¬å· TRX_ID ï¼šäº‹åŠ¡å¼€å§‹æ—¶çš„ç³»ç»Ÿç‰ˆæœ¬å·ã€‚</li>
</ul>
<p>MVCC ç»´æŠ¤äº†ä¸€ä¸ª ReadView ç»“æ„ï¼Œä¸»è¦åŒ…å«äº†å½“å‰ç³»ç»Ÿæœªæäº¤çš„äº‹åŠ¡åˆ—è¡¨ TRX_IDs {TRX_ID_1, TRX_ID_2, â€¦}ï¼Œè¿˜æœ‰è¯¥åˆ—è¡¨çš„æœ€å°å€¼ TRX_ID_MIN å’Œ TRX_ID_MAXã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/mysql/readview.jpg" alt></p>
<p>åœ¨è¿›è¡Œ SELECT æ“ä½œæ—¶ï¼Œæ ¹æ®æ•°æ®è¡Œå¿«ç…§çš„ TRX_ID ä¸ TRX_ID_MIN å’Œ TRX_ID_MAX ä¹‹é—´çš„å…³ç³»ï¼Œä»è€Œåˆ¤æ–­æ•°æ®è¡Œå¿«ç…§æ˜¯å¦å¯ä»¥ä½¿ç”¨ï¼š</p>
<ul>
<li>TRX_ID &lt; TRX_ID_MINï¼Œè¡¨ç¤ºè¯¥æ•°æ®è¡Œå¿«ç…§æ—¶åœ¨å½“å‰æ‰€æœ‰æœªæäº¤äº‹åŠ¡ä¹‹å‰è¿›è¡Œæ›´æ”¹çš„ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ã€‚</li>
<li>TRX_ID &gt; TRX_ID_MAXï¼Œè¡¨ç¤ºè¯¥æ•°æ®è¡Œå¿«ç…§æ˜¯åœ¨äº‹åŠ¡å¯åŠ¨ä¹‹åè¢«æ›´æ”¹çš„ï¼Œå› æ­¤ä¸å¯ä½¿ç”¨ã€‚</li>
<li>TRX_ID_MIN &lt;= TRX_ID &lt;= TRX_ID_MAXï¼Œéœ€è¦æ ¹æ®éš”ç¦»çº§åˆ«å†è¿›è¡Œåˆ¤æ–­ï¼š<ul>
<li>æäº¤è¯»ï¼šå¦‚æœ TRX_ID åœ¨ TRX_IDs åˆ—è¡¨ä¸­ï¼Œè¡¨ç¤ºè¯¥æ•°æ®è¡Œå¿«ç…§å¯¹åº”çš„äº‹åŠ¡è¿˜æœªæäº¤ï¼Œåˆ™è¯¥å¿«ç…§ä¸å¯ä½¿ç”¨ã€‚å¦åˆ™è¡¨ç¤ºå·²ç»æäº¤ï¼Œå¯ä»¥ä½¿ç”¨ã€‚</li>
<li>å¯é‡å¤è¯»ï¼šéƒ½ä¸å¯ä»¥ä½¿ç”¨ã€‚å› ä¸ºå¦‚æœå¯ä»¥ä½¿ç”¨çš„è¯ï¼Œé‚£ä¹ˆå…¶å®ƒäº‹åŠ¡ä¹Ÿå¯ä»¥è¯»åˆ°è¿™ä¸ªæ•°æ®è¡Œå¿«ç…§å¹¶è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆå½“å‰äº‹åŠ¡å†å»è¯»è¿™ä¸ªæ•°æ®è¡Œå¾—åˆ°çš„å€¼å°±ä¼šå‘ç”Ÿæ”¹å˜ï¼Œä¹Ÿå°±æ˜¯å‡ºç°äº†ä¸å¯é‡å¤è¯»é—®é¢˜ã€‚</li>
</ul>
</li>
</ul>
<p>åœ¨æ•°æ®è¡Œå¿«ç…§ä¸å¯ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œéœ€è¦æ²¿ç€ Undo Log çš„å›æ»šæŒ‡é’ˆ ROLL_PTR æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¿«ç…§ï¼Œå†è¿›è¡Œä¸Šé¢çš„åˆ¤æ–­ã€‚</p>
<h2 id="mysqlåœ¨å¯é‡å¤è¯»RRçš„éš”ç¦»çº§åˆ«ä¸‹å¦‚ä½•é¿å…å¹»è¯»çš„"><a href="#mysqlåœ¨å¯é‡å¤è¯»RRçš„éš”ç¦»çº§åˆ«ä¸‹å¦‚ä½•é¿å…å¹»è¯»çš„" class="headerlink" title="mysqlåœ¨å¯é‡å¤è¯»RRçš„éš”ç¦»çº§åˆ«ä¸‹å¦‚ä½•é¿å…å¹»è¯»çš„"></a>mysqlåœ¨å¯é‡å¤è¯»RRçš„éš”ç¦»çº§åˆ«ä¸‹å¦‚ä½•é¿å…å¹»è¯»çš„</h2><p>å‚è€ƒ:  </p>
<ul>
<li>next-keyé”: <a href="https://juejin.im/post/6844903997090824200" target="_blank" rel="noopener">mysql æ’å®ƒé”ä¹‹è¡Œé”ã€é—´éš™é”ã€åç é”</a></li>
<li>mvcc: <ul>
<li><a href="https://www.jianshu.com/p/f692d4f8a53e" target="_blank" rel="noopener">mysql mvccå®ç°åŸç†</a></li>
<li><a href="https://blog.csdn.net/DILIGENT203/article/details/100751755" target="_blank" rel="noopener">https://blog.csdn.net/DILIGENT203/article/details/100751755</a></li>
</ul>
</li>
</ul>
<p>çŸ¥è¯†ç‚¹:</p>
<ul>
<li><code>Record Lock</code>ï¼šè¡Œé”, é”ç›´æ¥åŠ åœ¨ç´¢å¼•è®°å½•ä¸Šé¢ï¼Œé”ä½çš„æ˜¯keyã€‚å½“éœ€è¦å¯¹è¡¨ä¸­çš„æŸæ¡æ•°æ®è¿›è¡Œå†™æ“ä½œï¼ˆinsertã€updateã€deleteã€select for updateï¼‰æ—¶ï¼Œéœ€è¦å…ˆè·å–è®°å½•çš„æ’ä»–é”ï¼ˆXé”ï¼‰ï¼Œè¿™ä¸ªå°±ç§°ä¸ºè¡Œé”ã€‚</li>
<li><code>Gap Lock</code>ï¼šé—´éš™é”ï¼Œé”å®šç´¢å¼•è®°å½•é—´éš™ï¼Œç¡®ä¿ç´¢å¼•è®°å½•çš„é—´éš™ä¸å˜ã€‚é—´éš™é”æ˜¯é’ˆå¯¹äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯»æˆ–ä»¥ä¸Šçº§åˆ«è€Œè®¾è®¡çš„ã€‚GAPé”çš„ç›®çš„ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢åŒä¸€äº‹åŠ¡çš„ä¸¤æ¬¡å½“å‰è¯»ï¼Œå‡ºç°å¹»è¯»çš„æƒ…å†µã€‚ä¾‹å¦‚å½“ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¯­å¥<code>SELECT c FROM t WHERE c BETWEEN 10 and 20 FOR UPDATE;</code>ï¼Œåˆ™å…¶å®ƒäº‹åŠ¡å°±ä¸èƒ½åœ¨ t.c ä¸­æ’å…¥ 15ã€‚</li>
<li><code>Next-Key Lock</code> = <code>Record Lock</code> + <code>Gap Lock</code> ï¼Œ å®ƒæ˜¯ Record Locks å’Œ Gap Locks çš„ç»“åˆï¼Œä¸ä»…é”å®šä¸€ä¸ªè®°å½•ä¸Šçš„ç´¢å¼•ï¼Œä¹Ÿé”å®šç´¢å¼•ä¹‹é—´çš„é—´éš™ã€‚å®ƒé”å®šä¸€ä¸ªå‰å¼€åé—­åŒºé—´ï¼Œä¾‹å¦‚ä¸€ä¸ªç´¢å¼•åŒ…å«ä»¥ä¸‹å€¼ï¼š10, 11, 13, and 20ï¼Œé‚£ä¹ˆå°±éœ€è¦é”å®šä»¥ä¸‹åŒºé—´ï¼š  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(-âˆ, 10]</span><br><span class="line">(10, 11]</span><br><span class="line">(11, 13]</span><br><span class="line">(13, 20]</span><br><span class="line">(20, +âˆ)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒInnoDBå·¥ä½œåœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œå¹¶ä¸”ä¼šä»¥<code>Next-Key Lock</code>çš„æ–¹å¼å¯¹æ•°æ®è¡Œè¿›è¡ŒåŠ é”ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆé˜²æ­¢å¹»è¯»çš„å‘ç”Ÿã€‚<code>Next-Key Lock</code>æ˜¯è¡Œé”å’Œé—´éš™é”çš„ç»„åˆï¼Œå½“InnoDBæ‰«æç´¢å¼•è®°å½•çš„æ—¶å€™ï¼Œä¼šé¦–å…ˆå¯¹ç´¢å¼•è®°å½•åŠ ä¸ŠRecord Lockï¼Œå†å¯¹ç´¢å¼•è®°å½•ä¸¤è¾¹çš„é—´éš™åŠ ä¸Šé—´éš™é”ï¼ˆGap Lockï¼‰ã€‚åŠ ä¸Šé—´éš™é”ä¹‹åï¼Œå…¶ä»–äº‹åŠ¡å°±ä¸èƒ½åœ¨è¿™ä¸ªé—´éš™ä¿®æ”¹æˆ–è€…æ’å…¥è®°å½•ã€‚</p>
<ul>
<li><strong>å¿«ç…§è¯»</strong>ï¼šç®€å•çš„selectæ“ä½œï¼Œå±äºå¿«ç…§è¯»ï¼Œä¸åŠ é”ã€‚(å½“ç„¶ï¼Œä¹Ÿæœ‰ä¾‹å¤–ï¼Œä¸‹é¢ä¼šåˆ†æ)<br>  <code>select * from table where ?;</code></li>
<li><strong>å½“å‰è¯»</strong>ï¼šç‰¹æ®Šçš„è¯»æ“ä½œï¼Œæ’å…¥/æ›´æ–°/åˆ é™¤æ“ä½œï¼Œå±äºå½“å‰è¯»ï¼Œéœ€è¦åŠ é”ã€‚<ul>
<li><code>select * from table where ? lock in share mode;</code></li>
<li><code>select * from table where ? for update;</code></li>
<li><code>insert into table values (â€¦);</code></li>
<li><code>update table set ? where ?;</code></li>
<li><code>delete from table where ?;</code></li>
</ul>
</li>
</ul>
<p>åœ¨MySQLä¸­æ™®é€šçš„selectç§°ä¸ºå¿«ç…§è¯»ï¼Œä¸éœ€è¦é”ï¼Œè€Œinsertã€updateã€deleteã€select for updateåˆ™ç§°ä¸ºå½“å‰è¯»ï¼Œéœ€è¦ç»™æ•°æ®åŠ é”ï¼Œ<strong>å¹»è¯»ä¸­çš„â€œè¯»â€å³æ˜¯é’ˆå¯¹å½“å‰è¯»</strong>ã€‚<br>RRäº‹åŠ¡éš”ç¦»çº§åˆ«å…è®¸å­˜åœ¨å¹»è¯»ï¼Œä½†InnoDB RRçº§åˆ«å´é€šè¿‡Gapé”é¿å…äº†å¹»è¯»</p>
<p><strong>mysqlå¦‚ä½•å®ç°é¿å…å¹»è¯»</strong>:  </p>
<ol>
<li>åœ¨å¿«ç…§è¯»è¯»æƒ…å†µä¸‹ï¼Œmysqlé€šè¿‡mvccæ¥é¿å…å¹»è¯»ã€‚</li>
<li>åœ¨å½“å‰è¯»è¯»æƒ…å†µä¸‹ï¼Œmysqlé€šè¿‡<code>next-key lock</code>æ¥é¿å…å¹»è¯»ã€‚</li>
</ol>
<h3 id="æ­£ç¡®ç†è§£InnoDBå¼•æ“RRéš”ç¦»çº§åˆ«è§£å†³äº†å¹»è¯»è¿™ä»¶äº‹"><a href="#æ­£ç¡®ç†è§£InnoDBå¼•æ“RRéš”ç¦»çº§åˆ«è§£å†³äº†å¹»è¯»è¿™ä»¶äº‹" class="headerlink" title="æ­£ç¡®ç†è§£InnoDBå¼•æ“RRéš”ç¦»çº§åˆ«è§£å†³äº†å¹»è¯»è¿™ä»¶äº‹"></a>æ­£ç¡®ç†è§£InnoDBå¼•æ“RRéš”ç¦»çº§åˆ«è§£å†³äº†å¹»è¯»è¿™ä»¶äº‹</h3><p>Mysqlå®˜æ–¹ç»™å‡ºçš„å¹»è¯»è§£é‡Šæ˜¯ï¼šåªè¦åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œç¬¬äºŒæ¬¡selectå¤šå‡ºäº†rowå°±ç®—å¹»è¯»ã€‚</p>
<p>å…ˆçœ‹é—®é¢˜:<br>aäº‹åŠ¡å…ˆselectï¼Œbäº‹åŠ¡insertç¡®å®ä¼šåŠ ä¸€ä¸ªgapé”ï¼Œä½†æ˜¯å¦‚æœbäº‹åŠ¡commitï¼Œè¿™ä¸ªgapé”å°±ä¼šé‡Šæ”¾ï¼ˆé‡Šæ”¾åaäº‹åŠ¡å¯ä»¥éšæ„dmlæ“ä½œï¼‰ï¼Œaäº‹åŠ¡å†selectå‡ºæ¥çš„ç»“æœåœ¨MVCCä¸‹è¿˜å’Œç¬¬ä¸€æ¬¡selectä¸€æ ·ï¼Œæ¥ç€aäº‹åŠ¡ä¸åŠ æ¡ä»¶åœ°updateï¼Œè¿™ä¸ªupdateä¼šä½œç”¨åœ¨æ‰€æœ‰è¡Œä¸Šï¼ˆåŒ…æ‹¬bäº‹åŠ¡æ–°åŠ çš„ï¼‰ï¼Œaäº‹åŠ¡å†æ¬¡selectå°±ä¼šå‡ºç°bäº‹åŠ¡ä¸­çš„æ–°è¡Œï¼Œå¹¶ä¸”è¿™ä¸ªæ–°è¡Œå·²ç»è¢«updateä¿®æ”¹äº†ï¼Œå®æµ‹åœ¨RRçº§åˆ«ä¸‹ç¡®å®å¦‚æ­¤ã€‚</p>
<p><strong>å¦‚æœè¿™æ ·ç†è§£çš„è¯ï¼ŒMysqlçš„RRçº§åˆ«ç¡®å®é˜²ä¸ä½å¹»è¯», ä½†æ˜¯æˆ‘ä»¬ä¸èƒ½å‘ä¸Šé¢è¿™æ ·ç†è§£, æˆ‘ä»¬å¾—å¦‚ä¸‹ç†è§£:</strong></p>
<ul>
<li><code>select * from t where a=1;</code>å±äºå¿«ç…§è¯»</li>
<li><code>select * from t where a=1 lock in share mode;</code>å±äºå½“å‰è¯»</li>
<li>ä¸èƒ½æŠŠå¿«ç…§è¯»å’Œå½“å‰è¯»å¾—åˆ°çš„ç»“æœä¸ä¸€æ ·è¿™ç§æƒ…å†µè®¤ä¸ºæ˜¯å¹»è¯»ï¼Œè¿™æ˜¯ä¸¤ç§ä¸åŒçš„ä½¿ç”¨ã€‚æ‰€ä»¥mysqlçš„rrçº§åˆ«æ˜¯è§£å†³äº†å¹»è¯»çš„ã€‚</li>
<li>å¦‚ä¸Šé¢é—®é¢˜æ‰€è¯´ï¼ŒT1 select ä¹‹å updateï¼Œä¼šå°† T2 ä¸­ insert çš„æ•°æ®ä¸€èµ·æ›´æ–°ï¼Œé‚£ä¹ˆè®¤ä¸ºå¤šå‡ºæ¥ä¸€è¡Œï¼Œæ‰€ä»¥é˜²ä¸ä½å¹»è¯»ã€‚çœ‹ç€è¯´æ³•æ— æ‡ˆå¯å‡»ï¼Œä½†æ˜¯å…¶å®æ˜¯é”™è¯¯çš„ï¼ŒInnoDB ä¸­è®¾ç½®äº†å¿«ç…§è¯»å’Œå½“å‰è¯»ä¸¤ç§æ¨¡å¼ï¼Œå¦‚æœåªæœ‰å¿«ç…§è¯»ï¼Œé‚£ä¹ˆè‡ªç„¶æ²¡æœ‰å¹»è¯»é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœå°†è¯­å¥æå‡åˆ°å½“å‰è¯»ï¼Œé‚£ä¹ˆ T1 åœ¨ select çš„æ—¶å€™éœ€è¦ç”¨å¦‚ä¸‹è¯­æ³•ï¼š select * from t for update (lock in share mode) è¿›å…¥å½“å‰è¯»ï¼Œé‚£ä¹ˆè‡ªç„¶æ²¡æœ‰ T2 å¯ä»¥æ’å…¥æ•°æ®è¿™ä¸€å›äº‹å„¿äº†ã€‚</li>
</ul>
<h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="redis-æ•°æ®ç»“æ„æœ‰å“ªäº›ï¼Ÿåˆ†åˆ«æ€ä¹ˆå®ç°çš„ï¼Ÿ"><a href="#redis-æ•°æ®ç»“æ„æœ‰å“ªäº›ï¼Ÿåˆ†åˆ«æ€ä¹ˆå®ç°çš„ï¼Ÿ" class="headerlink" title="redis æ•°æ®ç»“æ„æœ‰å“ªäº›ï¼Ÿåˆ†åˆ«æ€ä¹ˆå®ç°çš„ï¼Ÿ"></a>redis æ•°æ®ç»“æ„æœ‰å“ªäº›ï¼Ÿåˆ†åˆ«æ€ä¹ˆå®ç°çš„ï¼Ÿ</h2><ul>
<li>String: <ul>
<li>å…¨æ˜¯æ•´æ•°çš„æ—¶å€™ç”¨<code>æ•´æ•°ç¼–ç int</code></li>
<li>å½“æœ‰å­—ç¬¦ä¸²çš„æ—¶å€™ç”¨<code>ç®€å•åŠ¨æ€å­—ç¬¦ä¸²sds</code>ç¼–ç </li>
</ul>
</li>
<li>HashTable: <ul>
<li>å…ƒç´ æ¯”è¾ƒå°‘æˆ–è€…å…ƒç´ æ¯”è¾ƒçŸ­çš„æ—¶å€™ç”¨<code>å‹ç¼©è¡¨ziplist</code>(key1|val1|key2|val2|â€¦è¿™æ ·å­˜å‚¨), </li>
<li>å…¶ä»–æ—¶å€™å°±ç”¨<code>å­—å…¸ht</code></li>
</ul>
</li>
<li>Set: <ul>
<li>å…ƒç´ å…¨æ˜¯æ•´æ•°çš„æ—¶å€™ç”¨<code>æ•´æ•°é›†åˆ</code>ç¼–ç (ä¸€ç§ç‰¹æ®Šçš„ç¼–ç , ä¼šä½¿ç”¨å„ç§è§„åˆ™æ¥åˆ©ç”¨ä½ç©ºé—´, æ¥èŠ‚çœå†…å­˜), </li>
<li>å…¶ä»–æ—¶å€™ç”¨<code>å­—å…¸ht</code>ç¼–ç (é”®ä¸ºSetçš„å…ƒç´ , å€¼éƒ½ä¸ºNull)</li>
</ul>
</li>
<li>List: <ul>
<li>å…ƒç´ æ¯”è¾ƒå°‘æˆ–è€…å…ƒç´ æ¯”è¾ƒçŸ­çš„æ—¶å€™ç”¨<code>å‹ç¼©è¡¨ziplist</code>,</li>
<li>å…¶ä»–æ—¶å€™å°±ç”¨<code>åŒç«¯åˆ—è¡¨LinkedList</code>ç¼–ç </li>
</ul>
</li>
<li>ZSet: <ul>
<li>å‚è€ƒ <a href="http://redisbook.com/preview/object/sorted_set.html" target="_blank" rel="noopener">http://redisbook.com/preview/object/sorted_set.html</a></li>
<li>å‚è€ƒ <a href="https://redisbook.readthedocs.io/en/latest/datatype/sorted_set.html" target="_blank" rel="noopener">https://redisbook.readthedocs.io/en/latest/datatype/sorted_set.html</a></li>
<li>å…ƒç´ æ¯”è¾ƒå°‘æˆ–è€…å…ƒç´ æ¯”è¾ƒçŸ­çš„æ—¶å€™ç”¨<code>å‹ç¼©è¡¨ziplist</code>(member1|score1|member2|score2|â€¦, æŒ‰ç…§scoreä»å°åˆ°å¤§æ’åˆ—), </li>
<li>å…¶ä»–æ—¶å€™å°±ç”¨<code>è·³è·ƒè¡¨SkipListç¼–ç </code>, è¿™ä¸ªç¼–ç é‡ŒåŒ…å«ä¸€ä¸ªå­—å…¸ç»“æ„å’Œä¸€ä¸ªè·³è¡¨ç»“æ„, ä½†è¿™ä¸¤ç§æ•°æ®ç»“æ„éƒ½ä¼šé€šè¿‡æŒ‡é’ˆæ¥å…±äº«ç›¸åŒå…ƒç´ çš„æˆå‘˜å’Œåˆ†å€¼ï¼Œ æ‰€ä»¥åŒæ—¶ä½¿ç”¨è·³è·ƒè¡¨å’Œå­—å…¸æ¥ä¿å­˜é›†åˆå…ƒç´ ä¸ä¼šäº§ç”Ÿä»»ä½•é‡å¤æˆå‘˜æˆ–è€…åˆ†å€¼ï¼Œ ä¹Ÿä¸ä¼šå› æ­¤è€Œæµªè´¹é¢å¤–çš„å†…å­˜:  <ul>
<li>å­—å…¸ç”¨äºå¿«é€ŸæŸ¥æ‰¾, å¦‚<code>ZScore</code>æŸ¥è¯¢memberæˆå‘˜çš„ score å€¼, æˆ–è€…å¿«é€Ÿç¡®å®šæ˜¯å¦æœ‰æŸä¸ªmember</li>
<li>è·³è¡¨ç”¨äº<code>zrank</code>/<code>zrange</code>ç­‰</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="zsetå„ç§é—®é¢˜"><a href="#zsetå„ç§é—®é¢˜" class="headerlink" title="zsetå„ç§é—®é¢˜"></a>zsetå„ç§é—®é¢˜</h2><h3 id="ä¸ºä»€ä¹ˆzsetç”¨è·³è¡¨ä¸ç”¨çº¢é»‘æ ‘"><a href="#ä¸ºä»€ä¹ˆzsetç”¨è·³è¡¨ä¸ç”¨çº¢é»‘æ ‘" class="headerlink" title="ä¸ºä»€ä¹ˆzsetç”¨è·³è¡¨ä¸ç”¨çº¢é»‘æ ‘"></a>ä¸ºä»€ä¹ˆzsetç”¨è·³è¡¨ä¸ç”¨çº¢é»‘æ ‘</h3><p>ç°åœ¨æˆ‘ä»¬çœ‹çœ‹ï¼Œå¯¹äºè¿™ä¸ªé—®é¢˜ï¼ŒRedisçš„ä½œè€… @antirez æ˜¯æ€ä¹ˆè¯´çš„ï¼š</p>
<p>There are a few reasons:</p>
<ul>
<li>They are not very memory intensive. Itâ€™s up to you basically. Changing parameters about the probability of a node to have a given number of levels will make then less memory intensive than btrees.</li>
<li>A sorted set is often target of many ZRANGE or ZREVRANGE operations, that is, traversing the skip list as a linked list. With this operation the cache locality of skip lists is at least as good as with other kind of balanced trees.</li>
<li>They are simpler to implement, debug, and so forth. For instance thanks to the skip list simplicity I received a patch (already in Redis master) with augmented skip lists implementing ZRANK in O(log(N)). It required little changes to the code.</li>
</ul>
<p>å¯å‚è€ƒ:  æœ¬åšå®¢æ–‡ç« <a href="/algo_newbie/#è·³è¡¨">è·³è¡¨</a><br>æ€»ç»“:<br><!-- * åœ¨åšèŒƒå›´æŸ¥æ‰¾çš„æ—¶å€™ï¼Œå¹³è¡¡æ ‘æ¯”skiplistæ“ä½œè¦å¤æ‚ã€‚åœ¨å¹³è¡¡æ ‘ä¸Šï¼Œæˆ‘ä»¬æ‰¾åˆ°æŒ‡å®šèŒƒå›´çš„å°å€¼ä¹‹åï¼Œè¿˜éœ€è¦ä»¥ä¸­åºéå†çš„é¡ºåºç»§ç»­å¯»æ‰¾å…¶å®ƒä¸è¶…è¿‡å¤§å€¼çš„èŠ‚ç‚¹ã€‚å¦‚æœä¸å¯¹å¹³è¡¡æ ‘è¿›è¡Œä¸€å®šçš„æ”¹é€ ï¼Œè¿™é‡Œçš„ä¸­åºéå†å¹¶ä¸å®¹æ˜“å®ç°ã€‚è€Œåœ¨skiplistä¸Šè¿›è¡ŒèŒƒå›´æŸ¥æ‰¾å°±éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨æ‰¾åˆ°å°å€¼ä¹‹åï¼Œå¯¹ç¬¬1å±‚é“¾è¡¨è¿›è¡Œè‹¥å¹²æ­¥çš„éå†å°±å¯ä»¥å®ç°ã€‚ --></p>
<ul>
<li>å¹³è¡¡æ ‘çš„æ’å…¥å’Œåˆ é™¤æ“ä½œå¯èƒ½å¼•å‘å­æ ‘çš„è°ƒæ•´ï¼Œé€»è¾‘å¤æ‚ï¼Œè€Œskiplistçš„æ’å…¥å’Œåˆ é™¤åªéœ€è¦ä¿®æ”¹ç›¸é‚»èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œæ“ä½œç®€å•åˆå¿«é€Ÿã€‚</li>
<li>ä»å†…å­˜å ç”¨ä¸Šæ¥è¯´ï¼Œskiplistæ¯”å¹³è¡¡æ ‘æ›´çµæ´»ä¸€äº›ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¹³è¡¡æ ‘æ¯ä¸ªèŠ‚ç‚¹åŒ…å«2ä¸ªæŒ‡é’ˆï¼ˆåˆ†åˆ«æŒ‡å‘å·¦å³å­æ ‘ï¼‰ï¼Œè€Œskiplistæ¯ä¸ªèŠ‚ç‚¹åŒ…å«çš„æŒ‡é’ˆæ•°ç›®å¹³å‡ä¸º1/(1-p)ï¼Œå…·ä½“å–å†³äºå‚æ•°pçš„å¤§å°ã€‚å¦‚æœåƒRedisé‡Œçš„å®ç°ä¸€æ ·ï¼Œå–p=1/4ï¼Œé‚£ä¹ˆå¹³å‡æ¯ä¸ªèŠ‚ç‚¹åŒ…å«1.33ä¸ªæŒ‡é’ˆï¼Œæ¯”å¹³è¡¡æ ‘æ›´æœ‰ä¼˜åŠ¿ã€‚</li>
<li>ä»ç®—æ³•å®ç°éš¾åº¦ä¸Šæ¥æ¯”è¾ƒï¼Œskiplistæ¯”å¹³è¡¡æ ‘è¦ç®€å•å¾—å¤šã€‚</li>
</ul>
<h3 id="zsetæ˜¯æ€ä¹ˆæ”¯æŒæŸ¥è¯¢æ’åçš„"><a href="#zsetæ˜¯æ€ä¹ˆæ”¯æŒæŸ¥è¯¢æ’åçš„" class="headerlink" title="zsetæ˜¯æ€ä¹ˆæ”¯æŒæŸ¥è¯¢æ’åçš„"></a>zsetæ˜¯æ€ä¹ˆæ”¯æŒæŸ¥è¯¢æ’åçš„</h3><p><a href="/algo_newbie/#è·³è¡¨æ€ä¹ˆæ”¯æŒæŸ¥è¯¢æ’åçš„">è·³è¡¨æ€ä¹ˆæ”¯æŒæŸ¥è¯¢æ’åçš„</a></p>
<h3 id="å»¶æ—¶é˜Ÿåˆ—ç”¨redisæ€ä¹ˆåš"><a href="#å»¶æ—¶é˜Ÿåˆ—ç”¨redisæ€ä¹ˆåš" class="headerlink" title="å»¶æ—¶é˜Ÿåˆ—ç”¨redisæ€ä¹ˆåš"></a>å»¶æ—¶é˜Ÿåˆ—ç”¨redisæ€ä¹ˆåš</h3><p>ç”¨zsetï¼Œæ‹¿æ—¶é—´æˆ³ä½œä¸ºscoreï¼Œæ¶ˆæ¯å†…å®¹ä½œä¸ºkeyè°ƒç”¨zaddæ¥ç”Ÿäº§æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…è½®è¯¢zsetç”¨zrangebyscoreæŒ‡ä»¤è·å–Nç§’ä¹‹å‰çš„æ•°æ®è½®è¯¢è¿›è¡Œå¤„ç†ã€‚</p>
<h3 id="ZSETåšæ’è¡Œæ¦œæ—¶è¦å®ç°åˆ†æ•°ç›¸åŒæ—¶æŒ‰æ—¶é—´é¡ºåºæ’åºæ€ä¹ˆå®ç°"><a href="#ZSETåšæ’è¡Œæ¦œæ—¶è¦å®ç°åˆ†æ•°ç›¸åŒæ—¶æŒ‰æ—¶é—´é¡ºåºæ’åºæ€ä¹ˆå®ç°" class="headerlink" title="ZSETåšæ’è¡Œæ¦œæ—¶è¦å®ç°åˆ†æ•°ç›¸åŒæ—¶æŒ‰æ—¶é—´é¡ºåºæ’åºæ€ä¹ˆå®ç°"></a>ZSETåšæ’è¡Œæ¦œæ—¶è¦å®ç°åˆ†æ•°ç›¸åŒæ—¶æŒ‰æ—¶é—´é¡ºåºæ’åºæ€ä¹ˆå®ç°</h3><p>è¯´äº†ä¸€ä¸ªå°† score æ‹†æˆé«˜ 32 ä½å’Œä½ 32 ä½ï¼Œé«˜ 32 ä½å­˜åˆ†æ•°ï¼Œä½ 32 ä½å­˜æ—¶é—´çš„æ–¹æ³•ã€‚</p>
<h2 id="å“ˆå¸Œè¡¨æ¸è¿›å¼rehash"><a href="#å“ˆå¸Œè¡¨æ¸è¿›å¼rehash" class="headerlink" title="å“ˆå¸Œè¡¨æ¸è¿›å¼rehash"></a>å“ˆå¸Œè¡¨æ¸è¿›å¼rehash</h2><ul>
<li><p>å½“ä»¥ä¸‹æ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªè¢«æ»¡è¶³æ—¶ï¼Œ ç¨‹åºä¼šè‡ªåŠ¨å¼€å§‹å¯¹å“ˆå¸Œè¡¨æ‰§è¡Œæ‰©å±•æ“ä½œï¼š  </p>
<ul>
<li>æœåŠ¡å™¨ç›®å‰æ²¡æœ‰åœ¨æ‰§è¡Œ BGSAVE å‘½ä»¤æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œ å¹¶ä¸”å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº 1 ï¼›</li>
<li><p>æœåŠ¡å™¨ç›®å‰æ­£åœ¨æ‰§è¡Œ BGSAVE å‘½ä»¤æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œ å¹¶ä¸”å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº 5 ï¼›</p>
<p>æ ¹æ® BGSAVE å‘½ä»¤æˆ– BGREWRITEAOF å‘½ä»¤æ˜¯å¦æ­£åœ¨æ‰§è¡Œï¼Œ æœåŠ¡å™¨æ‰§è¡Œæ‰©å±•æ“ä½œæ‰€éœ€çš„è´Ÿè½½å› å­å¹¶ä¸ç›¸åŒï¼Œ è¿™æ˜¯å› ä¸ºåœ¨æ‰§è¡Œ BGSAVE å‘½ä»¤æˆ– BGREWRITEAOF å‘½ä»¤çš„è¿‡ç¨‹ä¸­ï¼Œ Redis éœ€è¦åˆ›å»ºå½“å‰æœåŠ¡å™¨è¿›ç¨‹çš„å­è¿›ç¨‹ï¼Œ æ‰€ä»¥åœ¨å­è¿›ç¨‹å­˜åœ¨æœŸé—´ï¼Œ æœåŠ¡å™¨ä¼šæé«˜æ‰§è¡Œæ‰©å±•æ“ä½œæ‰€éœ€çš„è´Ÿè½½å› å­ï¼Œ ä»è€Œå°½å¯èƒ½åœ°é¿å…åœ¨å­è¿›ç¨‹å­˜åœ¨æœŸé—´è¿›è¡Œå“ˆå¸Œè¡¨æ‰©å±•æ“ä½œï¼Œ è¿™å¯ä»¥é¿å…ä¸å¿…è¦çš„å†…å­˜å†™å…¥æ“ä½œï¼Œ æœ€å¤§é™åº¦åœ°èŠ‚çº¦å†…å­˜ã€‚</p>
</li>
</ul>
</li>
<li>å¦ä¸€æ–¹é¢ï¼Œ å½“å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å°äº 0.1 æ—¶ï¼Œ ç¨‹åºè‡ªåŠ¨å¼€å§‹å¯¹å“ˆå¸Œè¡¨æ‰§è¡Œæ”¶ç¼©æ“ä½œã€‚</li>
</ul>
<p>ä»¥ä¸‹æ˜¯å“ˆå¸Œè¡¨æ¸è¿›å¼ rehash çš„è¯¦ç»†æ­¥éª¤ï¼š  </p>
<ol>
<li>ä¸º <code>ht[1]</code> åˆ†é…ç©ºé—´ï¼Œ è®©å­—å…¸åŒæ—¶æŒæœ‰ <code>ht[0]</code> å’Œ <code>ht[1]</code> ä¸¤ä¸ªå“ˆå¸Œè¡¨ã€‚</li>
<li>åœ¨å­—å…¸ä¸­ç»´æŒä¸€ä¸ªç´¢å¼•è®¡æ•°å™¨å˜é‡ rehashidx ï¼Œ å¹¶å°†å®ƒçš„å€¼è®¾ç½®ä¸º 0 ï¼Œ è¡¨ç¤º rehash å·¥ä½œæ­£å¼å¼€å§‹ã€‚</li>
<li>åœ¨ rehash è¿›è¡ŒæœŸé—´ï¼Œ æ¯æ¬¡å¯¹å­—å…¸æ‰§è¡Œåˆ é™¤ã€æŸ¥æ‰¾æˆ–è€…æ›´æ–°æ“ä½œæ—¶ï¼Œ ç¨‹åºé™¤äº†æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œä»¥å¤–ï¼Œ è¿˜ä¼šé¡ºå¸¦å°† <code>ht[0]</code> å“ˆå¸Œè¡¨åœ¨ rehashidx ç´¢å¼•ä¸Šçš„æ‰€æœ‰é”®å€¼å¯¹ rehash åˆ° <code>ht[1]</code> ï¼Œ å½“ rehash å·¥ä½œå®Œæˆä¹‹åï¼Œ ç¨‹åºå°† rehashidx å±æ€§çš„å€¼å¢ä¸€ã€‚</li>
<li>éšç€å­—å…¸æ“ä½œçš„ä¸æ–­æ‰§è¡Œï¼Œ æœ€ç»ˆåœ¨æŸä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œ <code>ht[0]</code> çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½ä¼šè¢« rehash è‡³ <code>ht[1]</code> ï¼Œ è¿™æ—¶ç¨‹åºå°† rehashidx å±æ€§çš„å€¼è®¾ä¸º -1 ï¼Œ è¡¨ç¤º rehash æ“ä½œå·²å®Œæˆã€‚</li>
</ol>
<p>æ¸è¿›å¼ rehash çš„å¥½å¤„åœ¨äºå®ƒé‡‡å–åˆ†è€Œæ²»ä¹‹çš„æ–¹å¼ï¼Œ å°† rehash é”®å€¼å¯¹æ‰€éœ€çš„è®¡ç®—å·¥ä½œå‡æ»©åˆ°å¯¹å­—å…¸çš„æ¯ä¸ªæ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾å’Œæ›´æ–°æ“ä½œä¸Šï¼Œ ä»è€Œé¿å…äº†é›†ä¸­å¼ rehash è€Œå¸¦æ¥çš„åºå¤§è®¡ç®—é‡ã€‚</p>
<p>å› ä¸ºåœ¨è¿›è¡Œæ¸è¿›å¼ rehash çš„è¿‡ç¨‹ä¸­ï¼Œ å­—å…¸ä¼šåŒæ—¶ä½¿ç”¨ <code>ht[0]</code> å’Œ <code>ht[1]</code> ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œ æ‰€ä»¥åœ¨æ¸è¿›å¼ rehash è¿›è¡ŒæœŸé—´ï¼Œ å­—å…¸çš„åˆ é™¤ï¼ˆdeleteï¼‰ã€æŸ¥æ‰¾ï¼ˆfindï¼‰ã€æ›´æ–°ï¼ˆupdateï¼‰ç­‰æ“ä½œä¼šåœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ä¸Šè¿›è¡Œï¼š æ¯”å¦‚è¯´ï¼Œ è¦åœ¨å­—å…¸é‡Œé¢æŸ¥æ‰¾ä¸€ä¸ªé”®çš„è¯ï¼Œ ç¨‹åºä¼šå…ˆåœ¨ <code>ht[0]</code> é‡Œé¢è¿›è¡ŒæŸ¥æ‰¾ï¼Œ å¦‚æœæ²¡æ‰¾åˆ°çš„è¯ï¼Œ å°±ä¼šç»§ç»­åˆ° <code>ht[1]</code> é‡Œé¢è¿›è¡ŒæŸ¥æ‰¾ï¼Œ è¯¸å¦‚æ­¤ç±»ã€‚</p>
<p>å¦å¤–ï¼Œ åœ¨æ¸è¿›å¼ rehash æ‰§è¡ŒæœŸé—´ï¼Œ æ–°æ·»åŠ åˆ°å­—å…¸çš„é”®å€¼å¯¹ä¸€å¾‹ä¼šè¢«ä¿å­˜åˆ° <code>ht[1]</code> é‡Œé¢ï¼Œ è€Œ <code>ht[0]</code> åˆ™ä¸å†è¿›è¡Œä»»ä½•æ·»åŠ æ“ä½œï¼š è¿™ä¸€æªæ–½ä¿è¯äº† <code>ht[0]</code> åŒ…å«çš„é”®å€¼å¯¹æ•°é‡ä¼šåªå‡ä¸å¢ï¼Œ å¹¶éšç€ rehash æ“ä½œçš„æ‰§è¡Œè€Œæœ€ç»ˆå˜æˆç©ºè¡¨ã€‚</p>
<h2 id="redis-æŒä¹…åŒ–æœ‰å“ªå‡ ç§æ–¹å¼ï¼Œæ€ä¹ˆé€‰ï¼Ÿ"><a href="#redis-æŒä¹…åŒ–æœ‰å“ªå‡ ç§æ–¹å¼ï¼Œæ€ä¹ˆé€‰ï¼Ÿ" class="headerlink" title="redis æŒä¹…åŒ–æœ‰å“ªå‡ ç§æ–¹å¼ï¼Œæ€ä¹ˆé€‰ï¼Ÿ"></a>redis æŒä¹…åŒ–æœ‰å“ªå‡ ç§æ–¹å¼ï¼Œæ€ä¹ˆé€‰ï¼Ÿ</h2><ul>
<li>æ··åˆæŒä¹…åŒ–<ul>
<li>åŸå› : é‡å¯ Redis æ—¶ï¼Œæˆ‘ä»¬å¾ˆå°‘ä½¿ç”¨ rdb æ¥æ¢å¤å†…å­˜çŠ¶æ€ï¼Œå› ä¸ºä¼šä¸¢å¤±å¤§é‡æ•°æ®ã€‚å¦‚æœä½¿ç”¨ AOF æ—¥å¿—é‡æ”¾ï¼Œæ€§èƒ½åˆ™ç›¸å¯¹ rdb æ¥è¯´è¦æ…¢å¾ˆå¤šï¼Œè¿™æ ·åœ¨ Redis å®ä¾‹å¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œå¯åŠ¨çš„æ—¶å€™éœ€è¦èŠ±è´¹å¾ˆé•¿çš„æ—¶é—´ã€‚</li>
<li>åŸç†: æ··åˆæŒä¹…åŒ–åŒæ ·ä¹Ÿæ˜¯é€šè¿‡bgrewriteaofå®Œæˆçš„ï¼Œä¸åŒçš„æ˜¯å½“å¼€å¯æ··åˆæŒä¹…åŒ–æ—¶ï¼Œforkå‡ºçš„å­è¿›ç¨‹å…ˆå°†å…±äº«çš„å†…å­˜å‰¯æœ¬å…¨é‡çš„ä»¥RDBæ–¹å¼å†™å…¥aofæ–‡ä»¶ï¼Œç„¶ååœ¨å°†aof_rewrite_bufé‡å†™ç¼“å†²åŒºçš„å¢é‡å‘½ä»¤ä»¥AOFæ–¹å¼å†™å…¥åˆ°æ–‡ä»¶ï¼Œå†™å…¥å®Œæˆåé€šçŸ¥ä¸»è¿›ç¨‹æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œå¹¶å°†æ–°çš„å«æœ‰RDBæ ¼å¼å’ŒAOFæ ¼å¼çš„AOFæ–‡ä»¶æ›¿æ¢æ—§çš„çš„AOFæ–‡ä»¶ã€‚</li>
<li>ç®€å•çš„è¯´ï¼šæ–°çš„AOFæ–‡ä»¶å‰åŠæ®µæ˜¯RDBæ ¼å¼çš„å…¨é‡æ•°æ®ååŠæ®µæ˜¯AOFæ ¼å¼çš„å¢é‡æ•°æ®ï¼Œ</li>
</ul>
</li>
<li>rdb<ul>
<li>ä¼˜åŠ¿: <ul>
<li>RDBæ–‡ä»¶ç´§å‡‘ï¼Œå…¨é‡å¤‡ä»½ï¼Œéå¸¸é€‚åˆç”¨äºè¿›è¡Œå¤‡ä»½å’Œç¾éš¾æ¢å¤ã€‚</li>
<li>ç”ŸæˆRDBæ–‡ä»¶çš„æ—¶å€™ï¼Œredisä¸»è¿›ç¨‹ä¼šfork()ä¸€ä¸ªå­è¿›ç¨‹æ¥å¤„ç†æ‰€æœ‰ä¿å­˜å·¥ä½œï¼Œä¸»è¿›ç¨‹ä¸éœ€è¦è¿›è¡Œä»»ä½•ç£ç›˜IOæ“ä½œã€‚</li>
<li>RDB åœ¨æ¢å¤å¤§æ•°æ®é›†æ—¶çš„é€Ÿåº¦æ¯” AOF çš„æ¢å¤é€Ÿåº¦è¦å¿«ã€‚</li>
</ul>
</li>
<li>åŠ£åŠ¿:<ul>
<li>å½“è¿›è¡Œå¿«ç…§æŒä¹…åŒ–æ—¶ï¼Œä¼šå¼€å¯ä¸€ä¸ªå­è¿›ç¨‹ä¸“é—¨è´Ÿè´£å¿«ç…§æŒä¹…åŒ–ï¼Œå­è¿›ç¨‹ä¼šæ‹¥æœ‰çˆ¶è¿›ç¨‹çš„å†…å­˜æ•°æ®ï¼Œçˆ¶è¿›ç¨‹ä¿®æ”¹å†…å­˜å­è¿›ç¨‹ä¸ä¼šååº”å‡ºæ¥ï¼Œæ‰€ä»¥åœ¨å¿«ç…§æŒä¹…åŒ–æœŸé—´ä¿®æ”¹çš„æ•°æ®ä¸ä¼šè¢«ä¿å­˜ï¼Œå¯èƒ½ä¸¢å¤±æ•°æ®ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>aof<ul>
<li>ä¼˜åŠ¿: <ul>
<li>AOFå¯ä»¥æ›´å¥½çš„ä¿æŠ¤æ•°æ®ä¸ä¸¢å¤±ï¼Œä¸€èˆ¬AOFä¼šæ¯éš”1ç§’ï¼Œé€šè¿‡ä¸€ä¸ª<strong>åå°åˆ·ç›˜çº¿ç¨‹</strong>æ‰§è¡Œä¸€æ¬¡fsyncæ“ä½œ(è¿™ç§ä¸€ç§’åˆ·ç›˜ä¸€æ¬¡çš„ç­–ç•¥, å¯èƒ½ä¼šé€ æˆ<strong>è¿½åŠ é˜»å¡</strong>: å½“ç¡¬ç›˜èµ„æºç¹å¿™æ—¶ï¼Œå³ä¸»çº¿ç¨‹å‘ç°è·ç¦»ä¸Šæ¬¡fsyncæ—¶é—´è¶…è¿‡2ç§’, ä¸ºäº†æ•°æ®å®‰å…¨æ€§, ä¸»çº¿ç¨‹ä¼šé˜»å¡ç›´åˆ°åå°åˆ·ç›˜çº¿ç¨‹æ‰§è¡Œfsyncæ“ä½œå®Œæˆ)ï¼Œä¿è¯æœ€å¤šä¸¢å¤±1ç§’é’Ÿçš„æ•°æ®ã€‚æ‰€ä»¥è¿™ä¹Ÿæ˜¯redisé‡å¯ä¼˜å…ˆåŠ è½½aofçš„ç†ç”±</li>
<li>AOFæ—¥å¿—æ–‡ä»¶æ²¡æœ‰ä»»ä½•ç£ç›˜å¯»å€çš„å¼€é”€ï¼Œå†™å…¥æ€§èƒ½éå¸¸é«˜ï¼Œæ–‡ä»¶ä¸å®¹æ˜“ç ´æŸã€‚</li>
<li>AOFæ—¥å¿—æ–‡ä»¶å³ä½¿è¿‡å¤§çš„æ—¶å€™ï¼Œå‡ºç°åå°é‡å†™æ“ä½œï¼Œä¹Ÿä¸ä¼šå½±å“å®¢æˆ·ç«¯çš„è¯»å†™ã€‚</li>
<li>AOFæ—¥å¿—æ–‡ä»¶çš„å‘½ä»¤é€šè¿‡å¯è¯»çš„æ–¹å¼è¿›è¡Œè®°å½•ï¼Œè¿™ä¸ªç‰¹æ€§éå¸¸é€‚åˆåšç¾éš¾æ€§çš„è¯¯åˆ é™¤çš„ç´§æ€¥æ¢å¤ã€‚æ¯”å¦‚æŸäººä¸å°å¿ƒç”¨flushallå‘½ä»¤æ¸…ç©ºäº†æ‰€æœ‰æ•°æ®ï¼Œåªè¦è¿™ä¸ªæ—¶å€™åå°rewriteè¿˜æ²¡æœ‰å‘ç”Ÿï¼Œé‚£ä¹ˆå°±å¯ä»¥ç«‹å³æ‹·è´AOFæ–‡ä»¶ï¼Œå°†æœ€åä¸€æ¡flushallå‘½ä»¤ç»™åˆ äº†ï¼Œç„¶åå†å°†è¯¥AOFæ–‡ä»¶æ”¾å›å»ï¼Œå°±å¯ä»¥é€šè¿‡æ¢å¤æœºåˆ¶ï¼Œè‡ªåŠ¨æ¢å¤æ‰€æœ‰æ•°æ®</li>
</ul>
</li>
<li>åŠ£åŠ¿:<ul>
<li>å¯¹äºåŒä¸€ä»½æ•°æ®æ¥è¯´ï¼ŒAOFæ—¥å¿—æ–‡ä»¶é€šå¸¸æ¯”RDBæ•°æ®å¿«ç…§æ–‡ä»¶æ›´å¤§</li>
<li>AOFå¼€å¯åï¼Œæ”¯æŒçš„å†™QPSä¼šæ¯”RDBæ”¯æŒçš„å†™QPSä½ï¼Œå› ä¸ºAOFä¸€èˆ¬ä¼šé…ç½®æˆæ¯ç§’fsyncä¸€æ¬¡æ—¥å¿—æ–‡ä»¶ï¼Œå½“ç„¶ï¼Œæ¯ç§’ä¸€æ¬¡fsyncï¼Œæ€§èƒ½ä¹Ÿè¿˜æ˜¯å¾ˆé«˜çš„</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="bgsaveæµç¨‹è¯´ä¸€ä¸‹"><a href="#bgsaveæµç¨‹è¯´ä¸€ä¸‹" class="headerlink" title="bgsaveæµç¨‹è¯´ä¸€ä¸‹"></a>bgsaveæµç¨‹è¯´ä¸€ä¸‹</h3><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/redis/bgsave.png" alt></p>
<p>å­è¿›ç¨‹åˆ›å»ºRDBæ–‡ä»¶, æ ¹æ®çˆ¶è¿›ç¨‹å†…å­˜ç”Ÿæˆä¸´æ—¶å¿«ç…§æ–‡ä»¶, å®Œæˆåå¯¹åŸæœ‰RDBæ–‡ä»¶è¿›è¡Œ<a href="#å¦‚ä½•åšrdbå’Œaofçš„åŸå­æ›¿æ¢çš„">åŸå­æ›¿æ¢</a>. ç„¶åå­è¿›ç¨‹å‘é€ä¿¡å·ç»™çˆ¶è¿›ç¨‹è¡¨ç¤ºå®Œæˆ</p>
<h3 id="aofæµç¨‹è¯´ä¸€ä¸‹ä»¥åŠaofè¿½åŠ é˜»å¡æ˜¯å•¥"><a href="#aofæµç¨‹è¯´ä¸€ä¸‹ä»¥åŠaofè¿½åŠ é˜»å¡æ˜¯å•¥" class="headerlink" title="aofæµç¨‹è¯´ä¸€ä¸‹ä»¥åŠaofè¿½åŠ é˜»å¡æ˜¯å•¥"></a>aofæµç¨‹è¯´ä¸€ä¸‹ä»¥åŠaofè¿½åŠ é˜»å¡æ˜¯å•¥</h3><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/redis/aof.png" alt></p>
<p>è¿½åŠ é˜»å¡: </p>
<p>AOFå¯ä»¥æ›´å¥½çš„ä¿æŠ¤æ•°æ®ä¸ä¸¢å¤±ï¼Œä¸€èˆ¬AOFä¼šæ¯éš”1ç§’ï¼Œé€šè¿‡ä¸€ä¸ªåå°åˆ·ç›˜çº¿ç¨‹æ‰§è¡Œä¸€æ¬¡fsyncæ“ä½œ(è¿™ç§ä¸€ç§’åˆ·ç›˜ä¸€æ¬¡çš„ç­–ç•¥, å¯èƒ½ä¼šé€ æˆè¿½åŠ é˜»å¡: å½“ç¡¬ç›˜èµ„æºç¹å¿™æ—¶ï¼Œå³ä¸»çº¿ç¨‹å‘ç°è·ç¦»ä¸Šæ¬¡fsyncæ—¶é—´è¶…è¿‡2ç§’, ä¸ºäº†æ•°æ®å®‰å…¨æ€§, ä¸»çº¿ç¨‹ä¼šé˜»å¡ç›´åˆ°åå°åˆ·ç›˜çº¿ç¨‹æ‰§è¡Œfsyncæ“ä½œå®Œæˆ)ï¼Œä¿è¯æœ€å¤šä¸¢å¤±1ç§’é’Ÿçš„æ•°æ®ã€‚</p>
<h3 id="AOFé‡å†™çš„å®ç°"><a href="#AOFé‡å†™çš„å®ç°" class="headerlink" title="AOFé‡å†™çš„å®ç°"></a>AOFé‡å†™çš„å®ç°</h3><ul>
<li><strong>æ‰€è°“çš„â€œé‡å†™â€å…¶å®æ˜¯ä¸€ä¸ªæœ‰æ­§ä¹‰çš„è¯è¯­, AOFé‡å†™å¹¶ä¸éœ€è¦å¯¹åŸæœ‰AOFæ–‡ä»¶è¿›è¡Œä»»ä½•çš„è¯»å–ï¼Œå†™å…¥ï¼Œåˆ†æç­‰æ“ä½œï¼Œè¿™ä¸ªåŠŸèƒ½æ˜¯é€šè¿‡è¯»å–æœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€æ¥å®ç°çš„ã€‚</strong></li>
<li>å¦‚å½“å‰åˆ—è¡¨é”®liståœ¨æ•°æ®åº“ä¸­çš„å€¼å°±ä¸º<code>[&quot;C&quot;, &quot;D&quot;, &quot;E&quot;, &quot;F&quot;, &quot;G&quot;]</code>ã€‚è¦ä½¿ç”¨å°½é‡å°‘çš„å‘½ä»¤æ¥è®°å½•listé”®çš„çŠ¶æ€ï¼Œæœ€ç®€å•çš„æ–¹å¼ä¸æ˜¯å»è¯»å–å’Œåˆ†æç°æœ‰AOFæ–‡ä»¶çš„å†…å®¹ï¼Œï¼Œè€Œæ˜¯ç›´æ¥è¯»å–listé”®åœ¨æ•°æ®åº“ä¸­çš„å½“å‰å€¼ï¼Œç„¶åç”¨ä¸€æ¡<code>RPUSH list &quot;C&quot; &quot;D&quot; &quot;E&quot; &quot;F&quot; &quot;G&quot;</code>ä»£æ›¿å‰é¢çš„6æ¡å‘½ä»¤</li>
</ul>
<p>AOF é‡å†™ç¨‹åºå¯ä»¥å¾ˆå¥½åœ°å®Œæˆåˆ›å»ºä¸€ä¸ªæ–° AOF æ–‡ä»¶çš„ä»»åŠ¡ï¼Œ ä½†æ˜¯ï¼Œ åœ¨æ‰§è¡Œè¿™ä¸ªç¨‹åºçš„æ—¶å€™ï¼Œ è°ƒç”¨è€…çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚å¾ˆæ˜æ˜¾ï¼Œ ä½œä¸ºä¸€ç§è¾…ä½æ€§çš„ç»´æŠ¤æ‰‹æ®µï¼Œ Redis ä¸å¸Œæœ› AOF é‡å†™é€ æˆæœåŠ¡å™¨æ— æ³•å¤„ç†è¯·æ±‚ï¼Œ æ‰€ä»¥ Redis å†³å®šå°† AOF é‡å†™ç¨‹åºæ”¾åˆ°ï¼ˆåå°ï¼‰å­è¿›ç¨‹é‡Œæ‰§è¡Œï¼Œ è¿™æ ·å¤„ç†çš„æœ€å¤§å¥½å¤„æ˜¯ï¼š  </p>
<ul>
<li>å­è¿›ç¨‹è¿›è¡Œ AOF é‡å†™æœŸé—´ï¼Œä¸»è¿›ç¨‹å¯ä»¥ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚</li>
<li>å­è¿›ç¨‹å¸¦æœ‰ä¸»è¿›ç¨‹çš„æ•°æ®å‰¯æœ¬ï¼Œä½¿ç”¨å­è¿›ç¨‹è€Œä¸æ˜¯çº¿ç¨‹ï¼Œå¯ä»¥åœ¨é¿å…é”çš„æƒ…å†µä¸‹ï¼Œä¿è¯æ•°æ®çš„å®‰å…¨æ€§ã€‚</li>
</ul>
<p>ä¸è¿‡ï¼Œ ä½¿ç”¨å­è¿›ç¨‹ä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼š å› ä¸ºå­è¿›ç¨‹åœ¨è¿›è¡Œ AOF é‡å†™æœŸé—´ï¼Œ ä¸»è¿›ç¨‹è¿˜éœ€è¦ç»§ç»­å¤„ç†å‘½ä»¤ï¼Œ è€Œæ–°çš„å‘½ä»¤å¯èƒ½å¯¹ç°æœ‰çš„æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œ è¿™ä¼šè®©å½“å‰æ•°æ®åº“çš„æ•°æ®å’Œé‡å†™åçš„ AOF æ–‡ä»¶ä¸­çš„æ•°æ®ä¸ä¸€è‡´ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ <strong>Redis å¢åŠ äº†ä¸€ä¸ª AOF é‡å†™ç¼“å­˜ï¼Œ è¿™ä¸ªç¼“å­˜åœ¨ fork å‡ºå­è¿›ç¨‹ä¹‹åå¼€å§‹å¯ç”¨ï¼Œ Redis ä¸»è¿›ç¨‹åœ¨æ¥åˆ°æ–°çš„å†™å‘½ä»¤ä¹‹åï¼Œ é™¤äº†ä¼šå°†è¿™ä¸ªå†™å‘½ä»¤çš„åè®®å†…å®¹è¿½åŠ åˆ°ç°æœ‰çš„ AOF æ–‡ä»¶ä¹‹å¤–ï¼Œ è¿˜ä¼šè¿½åŠ åˆ°è¿™ä¸ªé‡å†™ç¼“å­˜ä¸­</strong>, æ¢è¨€ä¹‹ï¼Œ å½“å­è¿›ç¨‹åœ¨æ‰§è¡Œ AOF é‡å†™æ—¶ï¼Œ ä¸»è¿›ç¨‹éœ€è¦æ‰§è¡Œä»¥ä¸‹ä¸‰ä¸ªå·¥ä½œï¼š  </p>
<ol>
<li>å¤„ç†å‘½ä»¤è¯·æ±‚ã€‚</li>
<li>å°†å†™å‘½ä»¤è¿½åŠ åˆ°ç°æœ‰çš„ AOF æ–‡ä»¶ä¸­ã€‚</li>
<li>å°†å†™å‘½ä»¤è¿½åŠ åˆ° AOF é‡å†™ç¼“å­˜ä¸­ã€‚</li>
</ol>
<p>å½“å­è¿›ç¨‹å®Œæˆ AOF é‡å†™ä¹‹åï¼Œ å®ƒä¼šå‘çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ªå®Œæˆä¿¡å·ï¼Œ çˆ¶è¿›ç¨‹åœ¨æ¥åˆ°å®Œæˆä¿¡å·ä¹‹åï¼Œ ä¼šè°ƒç”¨ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œ å¹¶å®Œæˆä»¥ä¸‹å·¥ä½œï¼š  </p>
<ol>
<li>å°† AOF é‡å†™ç¼“å­˜ä¸­çš„å†…å®¹å…¨éƒ¨å†™å…¥åˆ°æ–° AOF æ–‡ä»¶ä¸­ã€‚</li>
<li>å¯¹æ–°çš„ AOF æ–‡ä»¶è¿›è¡Œæ”¹å<code>rename</code>ï¼Œè¦†ç›–åŸæœ‰çš„ AOF æ–‡ä»¶ã€‚è¿™å°±æ˜¯aofçš„<a href="#å¦‚ä½•åšrdbå’Œaofçš„åŸå­æ›¿æ¢çš„">åŸå­æ›¿æ¢</a>.</li>
</ol>
<p>åœ¨æ•´ä¸ª AOF åå°é‡å†™è¿‡ç¨‹ä¸­ï¼Œ åªæœ‰æœ€åçš„å†™å…¥ç¼“å­˜å’Œæ”¹åæ“ä½œä¼šé€ æˆä¸»è¿›ç¨‹é˜»å¡ï¼Œ åœ¨å…¶ä»–æ—¶å€™ï¼Œ AOF åå°é‡å†™éƒ½ä¸ä¼šå¯¹ä¸»è¿›ç¨‹é€ æˆé˜»å¡ï¼Œ è¿™å°† AOF é‡å†™å¯¹æ€§èƒ½é€ æˆçš„å½±å“é™åˆ°äº†æœ€ä½ã€‚ä»¥ä¸Šå°±æ˜¯ AOF åå°é‡å†™ï¼Œ ä¹Ÿå³æ˜¯ BGREWRITEAOF å‘½ä»¤çš„å·¥ä½œåŸç†ã€‚</p>
<h3 id="å¦‚ä½•åšrdbå’Œaofçš„åŸå­æ›¿æ¢çš„"><a href="#å¦‚ä½•åšrdbå’Œaofçš„åŸå­æ›¿æ¢çš„" class="headerlink" title="å¦‚ä½•åšrdbå’Œaofçš„åŸå­æ›¿æ¢çš„"></a>å¦‚ä½•åšrdbå’Œaofçš„åŸå­æ›¿æ¢çš„</h3><p>æ¯”å¦‚æƒ³è¦å°†tempæ–‡ä»¶åŸå­æ›¿æ¢originæ–‡ä»¶, åˆ™ç›´æ¥<code>rename</code> tmpæ–‡ä»¶åˆ°originæ–‡ä»¶å³å¯å®ç°.<br><code>rename</code>é€šè¿‡æ¥è¯´, ç›´æ¥ä¿®æ”¹ file system metadata, å¦‚inodeä¿¡æ¯. <strong>åœ¨posixæ ‡å‡†é‡Œ, <code>rename</code>å®ç°æ˜¯åŸå­çš„</strong>, å³:  </p>
<ul>
<li><code>rename</code>æˆåŠŸ, åŸæ–‡ä»¶å æŒ‡å‘ temp æ–‡ä»¶; åŸæ–‡ä»¶å†…å®¹è¢«åˆ é™¤.</li>
<li><code>rename</code>å¤±è´¥, åŸæ–‡ä»¶å ä»æŒ‡å‘åŸæ¥çš„æ–‡ä»¶å†…å®¹.</li>
</ul>
<h2 id="redis-ä¸»ä»åŒæ­¥æ˜¯æ€æ ·çš„è¿‡ç¨‹ï¼Ÿ"><a href="#redis-ä¸»ä»åŒæ­¥æ˜¯æ€æ ·çš„è¿‡ç¨‹ï¼Ÿ" class="headerlink" title="redis ä¸»ä»åŒæ­¥æ˜¯æ€æ ·çš„è¿‡ç¨‹ï¼Ÿ"></a>redis ä¸»ä»åŒæ­¥æ˜¯æ€æ ·çš„è¿‡ç¨‹ï¼Ÿ</h2><ol>
<li>ä»rediså‘å‡ºsyncè¦æ±‚</li>
<li>ä¸»rediså¼€å§‹bgsave(å¹¶ä¸”ä¸€è¾¹å¼€å¯æŒ‡ä»¤bufferæ¥å­˜å‚¨bgsaveè¿‡ç¨‹ä¸­çš„å†™æŒ‡ä»¤ä»¬è®°ä¸º<code>cmd</code>)</li>
<li>ä¸»redisæŠŠbgsaveç”Ÿæˆçš„rdbå‘ç»™ä»redis</li>
<li>æŠŠ<code>cmd</code>å‘é€ç»™ä»redis</li>
<li>ä»æœåŠ¡å™¨å®Œæˆå¯¹å¿«ç…§çš„è½½å…¥ï¼Œå¼€å§‹æ¥æ”¶å‘½ä»¤è¯·æ±‚ï¼Œå¹¶æ‰§è¡Œæ¥è‡ªä¸»æœåŠ¡å™¨ç¼“å†²åŒºçš„å†™å‘½ä»¤</li>
</ol>
<p>æ€»ç»“:<br>ä¸»ä»åˆšåˆšè¿æ¥çš„æ—¶å€™ï¼Œè¿›è¡Œå…¨é‡åŒæ­¥ï¼›å…¨é‡åŒæ­¥ç»“æŸåï¼Œè¿›è¡Œå¢é‡åŒæ­¥ã€‚å½“ç„¶ï¼Œå¦‚æœæœ‰éœ€è¦ï¼Œslave åœ¨ä»»ä½•æ—¶å€™éƒ½å¯ä»¥å‘èµ·å…¨é‡åŒæ­¥ã€‚redis ç­–ç•¥æ˜¯ï¼Œæ— è®ºå¦‚ä½•ï¼Œé¦–å…ˆä¼šå°è¯•è¿›è¡Œå¢é‡åŒæ­¥ï¼Œå¦‚ä¸æˆåŠŸï¼Œè¦æ±‚ä»æœºè¿›è¡Œå…¨é‡åŒæ­¥ã€‚</p>
<h2 id="redis-key-çš„è¿‡æœŸç­–ç•¥"><a href="#redis-key-çš„è¿‡æœŸç­–ç•¥" class="headerlink" title="redis key çš„è¿‡æœŸç­–ç•¥"></a>redis key çš„è¿‡æœŸç­–ç•¥</h2><p>Redisé”®çš„è¿‡æœŸç­–ç•¥ï¼Œæ˜¯æœ‰å®šæœŸåˆ é™¤+æƒ°æ€§åˆ é™¤ä¸¤ç§ã€‚</p>
<ul>
<li>å®šæœŸå¥½ç†è§£ï¼Œé»˜è®¤100mså°± éšæœº æŠ½ä¸€äº›è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyï¼Œå»æ£€æŸ¥æ˜¯å¦è¿‡æœŸï¼Œè¿‡æœŸäº†å°±åˆ äº†ã€‚</li>
<li>æƒ°æ€§åˆ é™¤ï¼ŒæŸ¥è¯¢æ—¶å†åˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼Œè¿‡æœŸå°±åˆ é™¤é”®ä¸è¿”å›å€¼ã€‚</li>
</ul>
<h2 id="å†…å­˜æ·˜æ±°æœºåˆ¶"><a href="#å†…å­˜æ·˜æ±°æœºåˆ¶" class="headerlink" title="å†…å­˜æ·˜æ±°æœºåˆ¶"></a>å†…å­˜æ·˜æ±°æœºåˆ¶</h2><p>å½“æ–°å¢æ•°æ®å‘ç°å†…å­˜è¾¾åˆ°é™åˆ¶æ—¶ï¼ŒRedisè§¦å‘å†…å­˜æ·˜æ±°æœºåˆ¶ã€‚</p>
<ul>
<li>lru</li>
<li>lfu(least frequency used, redis 4æ–°å¢)</li>
<li>random</li>
<li>ttl</li>
</ul>
<h3 id="redisçš„LRUç®—æ³•è¯´ä¸€ä¸‹"><a href="#redisçš„LRUç®—æ³•è¯´ä¸€ä¸‹" class="headerlink" title="redisçš„LRUç®—æ³•è¯´ä¸€ä¸‹"></a>redisçš„LRUç®—æ³•è¯´ä¸€ä¸‹</h3><ul>
<li><strong>æ™®é€šçš„LRUç®—æ³•</strong>:<br>  <strong>ä¸€èˆ¬æ˜¯ç”¨å“ˆå¸Œè¡¨+åŒå‘é“¾è¡¨æ¥å®ç°çš„</strong>:<br>  <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/redis/lru_cache_algo.jpg" alt><br>  åŸºäº HashMap å’Œ åŒå‘é“¾è¡¨å®ç° LRU çš„æ•´ä½“çš„è®¾è®¡æ€è·¯æ˜¯ï¼Œå¯ä»¥ä½¿ç”¨ HashMap å­˜å‚¨ keyï¼Œè¿™æ ·å¯ä»¥åšåˆ° save å’Œ get keyçš„æ—¶é—´éƒ½æ˜¯ O(1)ï¼Œè€Œ HashMap çš„ Value æŒ‡å‘åŒå‘é“¾è¡¨å®ç°çš„ LRU çš„ Node èŠ‚ç‚¹. å…¶æ ¸å¿ƒæ“ä½œçš„æ­¥éª¤æ˜¯:  <ul>
<li>save(key, value):<br>é¦–å…ˆåœ¨ HashMap æ‰¾åˆ° Key å¯¹åº”çš„èŠ‚ç‚¹ï¼Œå¦‚æœèŠ‚ç‚¹å­˜åœ¨ï¼Œæ›´æ–°èŠ‚ç‚¹çš„å€¼ï¼Œå¹¶æŠŠè¿™ä¸ªèŠ‚ç‚¹ç§»åŠ¨é˜Ÿå¤´ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œéœ€è¦æ„é€ æ–°çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”å°è¯•æŠŠèŠ‚ç‚¹å¡åˆ°é˜Ÿå¤´ï¼Œå¦‚æœLRUç©ºé—´ä¸è¶³ï¼Œåˆ™é€šè¿‡ tail æ·˜æ±°æ‰é˜Ÿå°¾çš„èŠ‚ç‚¹ï¼ŒåŒæ—¶åœ¨ HashMap ä¸­ç§»é™¤ Keyã€‚</li>
<li>get(key):<br>é€šè¿‡ HashMap æ‰¾åˆ° LRU é“¾è¡¨èŠ‚ç‚¹ï¼Œå› ä¸ºæ ¹æ®LRU åŸç†ï¼Œè¿™ä¸ªèŠ‚ç‚¹æ˜¯æœ€æ–°è®¿é—®çš„ï¼Œæ‰€ä»¥è¦æŠŠèŠ‚ç‚¹æ’å…¥åˆ°é˜Ÿå¤´ï¼Œç„¶åè¿”å›ç¼“å­˜çš„å€¼ã€‚</li>
</ul>
</li>
<li><strong>Redisçš„LRUå®ç°</strong>:<ul>
<li>å¦‚æœæŒ‰ç…§HashMapå’ŒåŒå‘é“¾è¡¨å®ç°ï¼Œéœ€è¦é¢å¤–çš„å­˜å‚¨å­˜æ”¾ next å’Œ prev æŒ‡é’ˆï¼Œç‰ºç‰²æ¯”è¾ƒå¤§çš„å­˜å‚¨ç©ºé—´ï¼Œæ˜¾ç„¶æ˜¯ä¸åˆ’ç®—çš„ã€‚æ‰€ä»¥Redisé‡‡ç”¨äº†ä¸€ä¸ªè¿‘ä¼¼çš„åšæ³•ï¼Œå°±æ˜¯å®šæ—¶æ¯éš”ä¸€æ®µæ—¶é—´å°±éšæœºå–å‡ºè‹¥å¹²ä¸ªkeyï¼Œç„¶åæŒ‰ç…§è®¿é—®æ—¶é—´æ’åºåï¼Œæ·˜æ±°æ‰æœ€ä¸ç»å¸¸ä½¿ç”¨çš„.  </li>
<li>Redis 3.0ä¹‹ååˆæ”¹å–„äº†ç®—æ³•çš„æ€§èƒ½ï¼Œä¼šæä¾›ä¸€ä¸ªå¾…æ·˜æ±°å€™é€‰keyçš„poolï¼Œé‡Œé¢é»˜è®¤æœ‰16ä¸ªkeyï¼ŒæŒ‰ç…§ç©ºé—²æ—¶é—´æ’å¥½åºã€‚æ›´æ–°æ—¶ä»Redisé”®ç©ºé—´éšæœºé€‰æ‹©Nä¸ªkeyï¼Œåˆ†åˆ«è®¡ç®—å®ƒä»¬çš„ç©ºé—²æ—¶é—´ idleï¼Œkeyåªä¼šåœ¨poolä¸æ»¡æˆ–è€…ç©ºé—²æ—¶é—´å¤§äºpoolé‡Œæœ€å°çš„æ—¶ï¼Œæ‰ä¼šè¿›å…¥poolï¼Œç„¶åä»poolä¸­é€‰æ‹©ç©ºé—²æ—¶é—´æœ€å¤§çš„keyæ·˜æ±°æ‰ã€‚</li>
</ul>
</li>
</ul>
<h2 id="rediså“¨å…µ"><a href="#rediså“¨å…µ" class="headerlink" title="rediså“¨å…µ"></a>rediså“¨å…µ</h2><ul>
<li>Redis Sentinelæ˜¯Redisçš„é«˜å¯ç”¨å®ç°æ–¹æ¡ˆï¼šæ•…éšœå‘ç°ã€æ•…éšœè‡ªåŠ¨è½¬ç§»ã€é…ç½®ä¸­å¿ƒ å®¢æˆ·ç«¯é€šçŸ¥ã€‚ </li>
<li>Redis Sentinelä»Redis 2.8ç‰ˆæœ¬å¼€å§‹æ‰æ­£å¼ç”Ÿäº§å¯ç”¨ï¼Œä¹‹å‰ç‰ˆæœ¬ç”Ÿäº§ä¸å¯ç”¨ã€‚ </li>
<li>å°½å¯èƒ½åœ¨ä¸åŒç‰©ç†æœºä¸Šéƒ¨ç½²Redis Sentinelæ‰€æœ‰èŠ‚ç‚¹ã€‚ </li>
<li><strong>Redis Sentinelä¸­çš„SentinelèŠ‚ç‚¹ä¸ªæ•°åº”è¯¥ä¸ºå¤§äºç­‰äº3ä¸”æœ€å¥½ä¸ºå¥‡æ•°ã€‚</strong></li>
<li>Redis Sentinelä¸­çš„æ•°æ®èŠ‚ç‚¹ä¸æ™®é€šæ•°æ®èŠ‚ç‚¹æ²¡æœ‰åŒºåˆ«ã€‚</li>
<li><strong>å“¨å…µæ˜¯ä¸€ä¸ªé…ç½®æä¾›è€…ï¼Œè€Œä¸æ˜¯ä»£ç†ã€‚åœ¨å¼•å…¥å“¨å…µä¹‹åï¼Œå®¢æˆ·ç«¯ä¼šå…ˆè¿æ¥å“¨å…µï¼Œå†è·å–åˆ°ä¸»èŠ‚ç‚¹ä¹‹åï¼Œå®¢æˆ·ç«¯ä¼šå’Œä¸»èŠ‚ç‚¹ç›´æ¥é€šä¿¡ã€‚å¦‚æœå‘ç”Ÿäº†æ•…éšœè½¬ç§»ï¼Œå“¨å…µä¼šé€šçŸ¥åˆ°å®¢æˆ·ç«¯ã€‚æ‰€ä»¥è¿™ä¹Ÿéœ€è¦å®¢æˆ·ç«¯çš„å®ç°å¯¹å“¨å…µçš„æ˜¾å¼æ”¯æŒã€‚</strong> </li>
<li>Redis Sentinelé€šè¿‡ä¸‰ä¸ªå®šæ—¶ä»»åŠ¡å®ç°äº†SentinelèŠ‚ç‚¹å¯¹äºä¸»èŠ‚ç‚¹ã€ä»èŠ‚ç‚¹ã€å…¶ä½™ SentinelèŠ‚ç‚¹çš„ç›‘æ§ã€‚</li>
<li><strong>Redis Sentinelåœ¨å¯¹èŠ‚ç‚¹åšå¤±è´¥åˆ¤å®šæ—¶åˆ†ä¸ºä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿ã€‚</strong></li>
<li>Redis Sentinelå®ç°è¯»å†™åˆ†ç¦»é«˜å¯ç”¨å¯ä»¥ä¾èµ–SentinelèŠ‚ç‚¹çš„æ¶ˆæ¯é€šçŸ¥ï¼Œè·å–Redis æ•°æ®èŠ‚ç‚¹çš„çŠ¶æ€å˜åŒ–ã€‚ </li>
</ul>
<p>ç”¨æ–‡å­—æè¿°ä¸€ä¸‹æ•…éšœåˆ‡æ¢ï¼ˆfailoverï¼‰çš„è¿‡ç¨‹:</p>
<ul>
<li>å‡è®¾ä¸»æœåŠ¡å™¨å®•æœºï¼Œå“¨å…µ1å…ˆæ£€æµ‹åˆ°è¿™ä¸ªç»“æœï¼Œç³»ç»Ÿå¹¶ä¸ä¼šé©¬ä¸Šè¿›è¡Œfailoverè¿‡ç¨‹ï¼Œä»…ä»…æ˜¯å“¨å…µ1ä¸»è§‚çš„è®¤ä¸ºä¸»æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œè¿™ä¸ªç°è±¡æˆä¸º<strong>ä¸»è§‚ä¸‹çº¿</strong>ã€‚</li>
<li>å½“åé¢çš„å“¨å…µä¹Ÿæ£€æµ‹åˆ°ä¸»æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œå¹¶ä¸”æ•°é‡è¾¾åˆ°ä¸€å®šå€¼æ—¶ï¼Œå°±å¯¹è¿™ä¸ªä¸»èŠ‚ç‚¹æ•…éšœè¾¾æˆä¸€è‡´, è¿™ä¸ªè¿‡ç¨‹ç§°ä¸º<strong>å®¢è§‚ä¸‹çº¿</strong>ã€‚</li>
<li>è¿™æ ·å¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œä¸€åˆ‡éƒ½æ˜¯é€æ˜çš„ã€‚ç„¶åé€šè¿‡<strong>raftç®—æ³•</strong>ä»å“¨å…µä¸­é€‰å‡ºä¸€ä¸ªå“¨å…µæ¥æ‰§è¡Œ<strong>æ•…éšœè½¬ç§»</strong></li>
</ul>
<h2 id="redisé›†ç¾¤"><a href="#redisé›†ç¾¤" class="headerlink" title="redisé›†ç¾¤"></a>redisé›†ç¾¤</h2><p>redisé›†ç¾¤æ˜¯ä¸€ä¸ªç”±å¤šä¸ªä¸»ä»èŠ‚ç‚¹ç¾¤ç»„æˆçš„åˆ†å¸ƒå¼æœåŠ¡å™¨ç¾¤ï¼Œå®ƒå…·æœ‰å¤åˆ¶ã€é«˜å¯ç”¨å’Œåˆ†ç‰‡ç‰¹æ€§ã€‚Redisé›†ç¾¤ä¸éœ€è¦sentinelå“¨å…µä¹Ÿèƒ½å®ŒæˆèŠ‚ç‚¹ç§»é™¤å’Œæ•…éšœè½¬ç§»çš„åŠŸèƒ½ã€‚éœ€è¦å°†æ¯ä¸ªèŠ‚ç‚¹è®¾ç½®æˆé›†ç¾¤æ¨¡å¼ï¼Œè¿™ç§é›†ç¾¤æ¨¡å¼æ²¡æœ‰ä¸­å¿ƒèŠ‚ç‚¹ï¼Œå¯æ°´å¹³æ‰©å±•ï¼Œæ®å®˜æ–¹æ–‡æ¡£ç§°å¯ä»¥çº¿æ€§æ‰©å±•åˆ°ä¸Šä¸‡ä¸ªèŠ‚ç‚¹(å®˜æ–¹æ¨èä¸è¶…è¿‡1000ä¸ªèŠ‚ç‚¹)ã€‚redisé›†ç¾¤çš„æ€§èƒ½å’Œé«˜å¯ç”¨æ€§å‡ä¼˜äºä¹‹å‰ç‰ˆæœ¬çš„å“¨å…µæ¨¡å¼ï¼Œä¸”é›†ç¾¤é…ç½®éå¸¸ç®€å•ã€‚<br>é›†ç¾¤æ¨¡å¼æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š</p>
<ul>
<li>ç”±å¤šä¸ªRedisæœåŠ¡å™¨ç»„æˆçš„åˆ†å¸ƒå¼ç½‘ç»œæœåŠ¡é›†ç¾¤ï¼›</li>
<li>é›†ç¾¤ä¹‹ä¸­æœ‰å¤šä¸ªMasterä¸»èŠ‚ç‚¹ï¼Œæ¯ä¸€ä¸ªä¸»èŠ‚ç‚¹éƒ½å¯è¯»å¯å†™ï¼›</li>
<li>èŠ‚ç‚¹ä¹‹é—´ä¼šäº’ç›¸é€šä¿¡ï¼Œä¸¤ä¸¤ç›¸è¿, é‡‡ç”¨gossipåè®®æ¥é€šä¿¡ï¼›</li>
<li>Redisé›†ç¾¤æ— ä¸­å¿ƒèŠ‚ç‚¹ã€‚</li>
<li>é›†ç¾¤çš„ä¼¸ç¼©æœ¬è´¨æ˜¯: æ§½æ•°æ®åœ¨èŠ‚ç‚¹ä¸­çš„ç§»åŠ¨<ul>
<li><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/redis/slot_move.png" alt></li>
</ul>
</li>
</ul>
<h3 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h3><p>åœ¨å“¨å…µæ¨¡å¼ä¸­ï¼Œä»ç„¶åªæœ‰ä¸€ä¸ªMasterèŠ‚ç‚¹ã€‚å½“å¹¶å‘å†™è¯·æ±‚è¾ƒå¤§æ—¶ï¼Œå“¨å…µæ¨¡å¼å¹¶ä¸èƒ½ç¼“è§£å†™å‹åŠ›ã€‚ æˆ‘ä»¬çŸ¥é“åªæœ‰ä¸»èŠ‚ç‚¹æ‰å…·æœ‰å†™èƒ½åŠ›ï¼Œé‚£å¦‚æœåœ¨ä¸€ä¸ªé›†ç¾¤ä¸­ï¼Œèƒ½å¤Ÿé…ç½®å¤šä¸ªä¸»èŠ‚ç‚¹ï¼Œç¼“è§£å†™å‹åŠ›ï¼Œredis-clusteré›†ç¾¤æ¨¡å¼èƒ½è¾¾åˆ°æ­¤ç±»è¦æ±‚ã€‚</p>
<p>åœ¨Redis-Clusteré›†ç¾¤ä¸­ï¼Œå¯ä»¥ç»™æ¯ä¸€ä¸ªä¸»èŠ‚ç‚¹æ·»åŠ ä»èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ç›´æ¥éµå¾ªä¸»ä»æ¨¡å‹çš„ç‰¹æ€§ã€‚<br>å½“ç”¨æˆ·éœ€è¦å¤„ç†æ›´å¤šè¯»è¯·æ±‚çš„æ—¶å€™ï¼Œæ·»åŠ ä»èŠ‚ç‚¹å¼€å¯read-onlyæ¥è¯»å†™åˆ†ç¦»å¯ä»¥æ‰©å±•ç³»ç»Ÿçš„è¯»æ€§èƒ½ã€‚</p>
<h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><ul>
<li>Redis é›†ç¾¤ä¸æ”¯æŒé‚£äº›éœ€è¦åŒæ—¶å¤„ç†å¤šä¸ªé”®çš„ Redis å‘½ä»¤ï¼Œ å› ä¸ºæ‰§è¡Œè¿™äº›å‘½ä»¤éœ€è¦åœ¨å¤šä¸ª Redis èŠ‚ç‚¹ä¹‹é—´ç§»åŠ¨æ•°æ®ï¼Œ å¹¶ä¸”åœ¨é«˜è´Ÿè½½çš„æƒ…å†µä¸‹ï¼Œ è¿™äº›å‘½ä»¤å°†é™ä½ Redis é›†ç¾¤çš„æ€§èƒ½ï¼Œ å¹¶å¯¼è‡´ä¸å¯é¢„æµ‹çš„è¡Œä¸ºã€‚</li>
<li>ä¸èƒ½ç”¨redisäº‹åŠ¡æœºåˆ¶(ä¸è¿‡å°±ç®—ä¸ç”¨redisé›†ç¾¤ä¸€èˆ¬ä¹Ÿä¸æ¨èç”¨redisçš„äº‹åŠ¡, æ¯•ç«Ÿå‡äº‹åŠ¡æ— æ³•å›æ»šå˜›, æ¯”å¦‚multiä¹‹åé‚£äº›åœ¨ EXEC å‘½ä»¤æ‰§è¡Œä¹‹åæ‰€äº§ç”Ÿçš„é”™è¯¯ï¼Œ å¹¶æ²¡æœ‰å¯¹å®ƒä»¬è¿›è¡Œç‰¹åˆ«å¤„ç†ï¼š å³ä½¿äº‹åŠ¡ä¸­æœ‰æŸä¸ª/æŸäº›å‘½ä»¤åœ¨æ‰§è¡Œæ—¶äº§ç”Ÿäº†é”™è¯¯ï¼Œ äº‹åŠ¡ä¸­çš„å…¶ä»–å‘½ä»¤ä»ç„¶ä¼šç»§ç»­æ‰§è¡Œã€‚)ã€‚å› ä¸ºä¸€ä¸ªäº‹åŠ¡ä¸­æœ‰æ¶‰åŠåˆ°å¤šä¸ªkeyæ“ä½œçš„æ—¶å€™ï¼Œè¿™å¤šä¸ªkeyä¸ä¸€å®šéƒ½å­˜å‚¨åœ¨åŒä¸€ä¸ªredis-serverä¸Šã€‚</li>
</ul>
<h3 id="æ•…éšœè½¬ç§»"><a href="#æ•…éšœè½¬ç§»" class="headerlink" title="æ•…éšœè½¬ç§»"></a>æ•…éšœè½¬ç§»</h3><p>Redisé›†ç¾¤çš„ä¸»èŠ‚ç‚¹å†…ç½®äº†ç±»ä¼¼Redis Sentinelçš„èŠ‚ç‚¹æ•…éšœæ£€æµ‹å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»åŠŸèƒ½ï¼Œå½“é›†ç¾¤ä¸­çš„æŸä¸ªä¸»èŠ‚ç‚¹ä¸‹çº¿æ—¶ï¼Œé›†ç¾¤ä¸­çš„å…¶ä»–åœ¨çº¿ä¸»èŠ‚ç‚¹ä¼šæ³¨æ„åˆ°è¿™ä¸€ç‚¹ï¼Œå¹¶å¯¹å·²ä¸‹çº¿çš„ä¸»èŠ‚ç‚¹è¿›è¡Œæ•…éšœè½¬ç§»ã€‚<br>é›†ç¾¤è¿›è¡Œæ•…éšœè½¬ç§»çš„æ–¹æ³•å’ŒRedis Sentinelè¿›è¡Œæ•…éšœè½¬ç§»çš„æ–¹æ³•åŸºæœ¬ä¸€æ ·(ä¹Ÿæœ‰<code>ä¸»è§‚ä¸‹çº¿</code>å’Œ<code>å®¢è§‚ä¸‹çº¿</code>)ï¼Œä¸åŒçš„æ˜¯ï¼Œåœ¨é›†ç¾¤é‡Œé¢ï¼Œæ•…éšœè½¬ç§»çš„è¿‡ç¨‹æ˜¯:</p>
<ol>
<li>åœ¨é›†ç¾¤å†…å¹¿æ’­é€‰ä¸¾æ¶ˆæ¯</li>
<li>é›†ç¾¤ä¸­å…¶ä»–åœ¨çº¿çš„æŒæœ‰æ§½çš„ä¸»èŠ‚ç‚¹æŠ•ç¥¨åˆ°æ•…éšœä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ä»¬</li>
<li>è¢«é€‰å‡ºæ¥çš„ä»èŠ‚ç‚¹å˜æˆä¸»èŠ‚ç‚¹</li>
</ol>
<p>æ‰€ä»¥é›†ç¾¤ä¸å¿…å¦å¤–ä½¿ç”¨Redis Sentinelã€‚</p>
<h3 id="é›†ç¾¤åˆ†ç‰‡ç­–ç•¥"><a href="#é›†ç¾¤åˆ†ç‰‡ç­–ç•¥" class="headerlink" title="é›†ç¾¤åˆ†ç‰‡ç­–ç•¥"></a>é›†ç¾¤åˆ†ç‰‡ç­–ç•¥</h3><p>å¸¸è§çš„é›†ç¾¤åˆ†ç‰‡ç®—æ³•æœ‰ï¼š</p>
<ul>
<li>ä¸€èˆ¬å“ˆå¸Œç®—æ³•</li>
<li>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</li>
<li>Hash Slotç®—æ³•</li>
</ul>
<p>Redisé‡‡ç”¨çš„æ˜¯Hash Slot</p>
<h4 id="ä¸€èˆ¬å“ˆå¸Œç®—æ³•"><a href="#ä¸€èˆ¬å“ˆå¸Œç®—æ³•" class="headerlink" title="ä¸€èˆ¬å“ˆå¸Œç®—æ³•"></a>ä¸€èˆ¬å“ˆå¸Œç®—æ³•</h4><p>è®¡ç®—æ–¹å¼ï¼šhash(key)%N<br>ç¼ºç‚¹ï¼šå¦‚æœå¢åŠ ä¸€ä¸ªredisï¼Œæ˜ å°„å…¬å¼å˜æˆäº† hash(key)%(N+1)<br>â€‹     å¦‚æœä¸€ä¸ªrediså®•æœºäº†ï¼Œæ˜ å°„å…¬å¼å˜æˆäº† hash(key)%(N-1)<br>â€‹     åœ¨ä»¥ä¸Šä¸¤ç§æƒ…å†µä¸‹ï¼Œå‡ ä¹æ‰€æœ‰çš„ç¼“å­˜éƒ½å¤±æ•ˆäº†ã€‚</p>
<h4 id="ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•"><a href="#ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•" class="headerlink" title="ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•"></a>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</h4><p>å…ˆæ„é€ å‡ºä¸€ä¸ªé•¿åº¦ä¸º2^32æ•´æ•°ç¯ï¼Œæ ¹æ®èŠ‚ç‚¹åç§°çš„hashå€¼ï¼ˆåˆ†å¸ƒåœ¨[0,2^32-1]ï¼‰æ”¾åˆ°è¿™ä¸ªç¯ä¸Šã€‚ç°åœ¨è¦å­˜æ”¾èµ„æºï¼Œæ ¹æ®èµ„æºçš„Keyçš„Hashå€¼ï¼ˆä¹Ÿæ˜¯åˆ†å¸ƒåœ¨[0,2^32-1]ï¼‰ï¼Œåœ¨ç¯ä¸Šé¡ºæ—¶é’ˆçš„æ‰¾åˆ°ç¦»å®ƒæœ€è¿‘çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±å»ºç«‹äº†èµ„æºå’ŒèŠ‚ç‚¹çš„æ˜ å°„å…³ç³»ã€‚</p>
<ul>
<li>ä¼˜ç‚¹ï¼šä¸€ä¸ªèŠ‚ç‚¹å®•æœºæ—¶ï¼Œä¸Šé¢çš„æ•°æ®è½¬ç§»åˆ°é¡ºæ—¶é’ˆçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸­ï¼Œæ–°å¢ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¹Ÿåªéœ€è¦å°†éƒ¨åˆ†æ•°æ®è¿ç§»åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸­ï¼Œå¯¹å…¶ä»–èŠ‚ç‚¹çš„å½±å“å¾ˆå°</li>
<li>ç¼ºç‚¹ï¼š<ul>
<li>ç”±äºæ•°æ®åœ¨ç¯ä¸Šåˆ†å¸ƒä¸å‡ï¼Œå¯èƒ½å­˜åœ¨æŸä¸ªèŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®æ¯”è¾ƒå¤šï¼Œé‚£ä¹ˆå½“ä»–å®•æœºçš„æ—¶å€™ï¼Œä¼šå¯¼è‡´å¤§é‡æ•°æ®æ¶Œå…¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸­ï¼ŒæŠŠå¦ä¸€ä¸ªèŠ‚ç‚¹æ‰“æŒ‚äº†ï¼Œç„¶åæ‰€æœ‰èŠ‚ç‚¹éƒ½æŒ‚äº†</li>
<li>åœ¨å¢å‡èŠ‚ç‚¹æ—¶éœ€è¦å¢åŠ ä¸€å€æˆ–å‡å»ä¸€åŠèŠ‚ç‚¹æ‰èƒ½ä¿è¯æ•°æ®å’Œè´Ÿè½½çš„å‡è¡¡</li>
</ul>
</li>
<li>æ”¹è¿›ï¼šå¼•è¿›äº†è™šæ‹ŸèŠ‚ç‚¹çš„æ¦‚å¿µï¼Œæƒ³è±¡åœ¨è¿™ä¸ªç¯ä¸Šæœ‰å¾ˆå¤šâ€œè™šæ‹ŸèŠ‚ç‚¹â€ï¼Œæ•°æ®çš„å­˜å‚¨æ˜¯æ²¿ç€ç¯çš„é¡ºæ—¶é’ˆæ–¹å‘æ‰¾ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œæ¯ä¸ªè™šæ‹ŸèŠ‚ç‚¹éƒ½ä¼šå…³è”åˆ°ä¸€ä¸ªçœŸå®èŠ‚ç‚¹</li>
</ul>
<h4 id="HashSlotç®—æ³•"><a href="#HashSlotç®—æ³•" class="headerlink" title="HashSlotç®—æ³•"></a>HashSlotç®—æ³•</h4><p>Redisé‡‡ç”¨çš„æ˜¯Hash Slotåˆ†ç‰‡ç®—æ³•ï¼Œç”¨æ¥è®¡ç®—keyå­˜å‚¨ä½ç½®çš„ã€‚é›†ç¾¤å°†æ•´ä¸ªæ•°æ®åº“åˆ†ä¸º16384ä¸ªæ§½ä½slotï¼Œæ‰€æœ‰key-valueæ•°æ®éƒ½å­˜å‚¨åœ¨è¿™äº›slotä¸­çš„æŸä¸€ä¸ªä¸Šã€‚ä¸€ä¸ªslotæ§½ä½å¯ä»¥å­˜æ”¾å¤šä¸ªæ•°æ®ï¼Œkeyçš„æ§½ä½è®¡ç®—å…¬å¼ä¸ºï¼šslot_number=CRC16(key)%16384ï¼Œå…¶ä¸­CRC16ä¸º16ä½çš„å¾ªç¯å†—ä½™æ ¡éªŒå’Œå‡½æ•°ã€‚<br><strong>å®¢æˆ·ç«¯å¯èƒ½ä¼šæŒ‘é€‰ä»»æ„ä¸€ä¸ªrediså®ä¾‹å»å‘é€å‘½ä»¤ï¼Œæ¯ä¸ªrediså®ä¾‹æ¥æ”¶åˆ°å‘½ä»¤ï¼Œéƒ½ä¼šè®¡ç®—keyå¯¹åº”çš„hash slotï¼Œå¦‚æœåœ¨æœ¬åœ°å°±åœ¨æœ¬åœ°å¤„ç†ï¼Œå¦åˆ™è¿”å›movedç»™å®¢æˆ·ç«¯ï¼Œè®©å®¢æˆ·ç«¯è¿›è¡Œé‡å®šå‘åˆ°å¯¹åº”çš„èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤(å®ç°å¾—å¥½ä¸€ç‚¹çš„smartå®¢æˆ·ç«¯ä¼šç¼“å­˜é”®-slot-èŠ‚ç‚¹çš„æ˜ å°„å…³ç³»æ¥è·å¾—æ€§èƒ½æå‡).</strong></p>
<p><strong>é‚£ä¸ºä»€ä¹ˆæ˜¯16384ä¸ªæ§½å‘¢?</strong></p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/redis/redis_slot_hash.jpg" alt></p>
<p>ps:CRC16ç®—æ³•äº§ç”Ÿçš„hashå€¼æœ‰16bitï¼Œè¯¥ç®—æ³•å¯ä»¥äº§ç”Ÿ2^16-=65536ä¸ªå€¼ã€‚æ¢å¥è¯è¯´ï¼Œå€¼æ˜¯åˆ†å¸ƒåœ¨0~65535ä¹‹é—´ã€‚é‚£ä½œè€…åœ¨åšmodè¿ç®—çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆä¸mod65536ï¼Œè€Œé€‰æ‹©mod16384ï¼Ÿ<a href="https://github.com/redis/redis/issues/2576" target="_blank" rel="noopener">ä½œè€…è§£ç­”</a></p>
<ul>
<li>åœ¨redisèŠ‚ç‚¹å‘é€å¿ƒè·³åŒ…æ—¶éœ€è¦æŠŠæ‰€æœ‰çš„æ§½æ”¾åˆ°è¿™ä¸ªå¿ƒè·³åŒ…é‡Œï¼Œä»¥ä¾¿è®©èŠ‚ç‚¹çŸ¥é“å½“å‰é›†ç¾¤ä¿¡æ¯ï¼Œ16384=16kï¼Œåœ¨å‘é€å¿ƒè·³åŒ…æ—¶ä½¿ç”¨charè¿›è¡Œbitmapå‹ç¼©åæ˜¯<code>16384Ã·8Ã·1024=2kb</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ä½¿ç”¨2kçš„ç©ºé—´åˆ›å»ºäº†16kçš„æ§½æ•°ã€‚</li>
<li>è™½ç„¶ä½¿ç”¨CRC16ç®—æ³•æœ€å¤šå¯ä»¥åˆ†é…65535ï¼ˆ2^16-1ï¼‰ä¸ªæ§½ä½ï¼Œ65535=65kï¼Œå½“æ§½ä½ä¸º65536æ—¶ï¼Œè¿™å—çš„å¤§å°æ˜¯: <code>65536Ã·8Ã·1024=8kb</code>ï¼Œä¹Ÿå°±æ˜¯è¯´éœ€è¦éœ€è¦8kçš„å¿ƒè·³åŒ…ï¼Œä½œè€…è®¤ä¸ºè¿™æ ·åšä¸å¤ªå€¼å¾—ï¼›</li>
</ul>
<h2 id="Cacheå’ŒDBå¦‚ä½•ä¸€è‡´"><a href="#Cacheå’ŒDBå¦‚ä½•ä¸€è‡´" class="headerlink" title="Cacheå’ŒDBå¦‚ä½•ä¸€è‡´"></a>Cacheå’ŒDBå¦‚ä½•ä¸€è‡´</h2><p>è¯¦ç»†çš„è¯·å‚è€ƒ: <a href="https://segmentfault.com/a/1190000015804406" target="_blank" rel="noopener">https://segmentfault.com/a/1190000015804406</a><br>æœ¬åšå®¢ä¹Ÿæœ‰ä¸€ä»½: <a href="/cache_db_consistency/" title="Cacheå’ŒDBä¸€è‡´æ€§">Cacheå’ŒDBä¸€è‡´æ€§</a></p>
<p>æ€»ç»“:</p>
<ul>
<li>ä½¿ç”¨<code>cache aside pattern</code><ul>
<li>å¯¹äºè¯»è¯·æ±‚<br>  <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/cache_db_consistency/cache_db_consistency_9.png" alt title="è¯»è¯·æ±‚"><br>  å…ˆè¯» cacheï¼Œå†è¯» db<br>  å¦‚æœï¼Œcache hitï¼Œåˆ™ç›´æ¥è¿”å›æ•°æ®<br>  å¦‚æœï¼Œcache missï¼Œåˆ™è®¿é—® dbï¼Œå¹¶å°†æ•°æ® set å›ç¼“å­˜</li>
<li>å¯¹äºå†™è¯·æ±‚<br>  <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/cache_db_consistency/cache_db_consistency_1.png" alt title="å†™è¯·æ±‚"><br>  å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†æ·˜æ±°ç¼“å­˜ï¼ˆæ·˜æ±°ç¼“å­˜ï¼Œè€Œä¸æ˜¯æ›´æ–°ç¼“å­˜, å¦‚æœæ›´æ–°ç¼“å­˜ï¼Œåœ¨å¹¶å‘å†™æ—¶ï¼Œå¯èƒ½å‡ºç°æ•°æ®ä¸ä¸€è‡´ã€‚ï¼‰</li>
</ul>
</li>
<li>Cache Aside Pattern æ–¹æ¡ˆå­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿ<ul>
<li><strong>é—®é¢˜1</strong>: å¦‚æœå…ˆå†™æ•°æ®åº“ï¼Œå†æ·˜æ±°ç¼“å­˜ï¼Œåœ¨åŸå­æ€§è¢«ç ´åæ—¶ï¼š<ol>
<li>ä¿®æ”¹æ•°æ®åº“æˆåŠŸäº†</li>
<li>æ·˜æ±°ç¼“å­˜å¤±è´¥äº†<br>å¯¼è‡´ï¼Œæ•°æ®åº“ä¸ç¼“å­˜çš„æ•°æ®ä¸ä¸€è‡´ã€‚</li>
</ol>
<ul>
<li>å¦‚ä½•è§£å†³é—®é¢˜1?<ul>
<li>åœ¨æ·˜æ±°ç¼“å­˜çš„æ—¶å€™ï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™é‡è¯•ä¸€å®šçš„æ¬¡æ•°ã€‚å¦‚æœå¤±è´¥ä¸€å®šæ¬¡æ•°è¿˜ä¸è¡Œï¼Œé‚£å°±æ˜¯å…¶ä»–åŸå› äº†ã€‚æ¯”å¦‚è¯´ redis æ•…éšœã€å†…ç½‘å‡ºäº†é—®é¢˜ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>é—®é¢˜2</strong>: ä¸»ä»åŒæ­¥å»¶è¿Ÿå¯¼è‡´çš„ç¼“å­˜å’Œæ•°æ®ä¸ä¸€è‡´é—®é¢˜<ul>
<li>é—®é¢˜: å‘ç”Ÿå†™è¯·æ±‚åï¼ˆä¸ç®¡æ˜¯å…ˆæ“ä½œ DBï¼Œè¿˜æ˜¯å…ˆæ·˜æ±° Cacheï¼‰ï¼Œåœ¨ä¸»ä»æ•°æ®åº“åŒæ­¥å®Œæˆä¹‹å‰ï¼Œå¦‚æœæœ‰è¯»è¯·æ±‚ï¼Œéƒ½å¯èƒ½å‘ç”Ÿè¯» Cache Missï¼Œè¯»ä»åº“æŠŠæ—§æ•°æ®å­˜å…¥ç¼“å­˜çš„æƒ…å†µã€‚æ­¤æ—¶æ€ä¹ˆåŠå‘¢ï¼Ÿ</li>
<li>è§£å†³æ€è·¯: åœ¨ä¸»ä»æ—¶å»¶çš„æ—¶é—´æ®µå†…ï¼Œè¯»å–ä¿®æ”¹è¿‡çš„æ•°æ®çš„è¯ï¼Œå¼ºåˆ¶è¯»ä¸»ï¼Œå¹¶ä¸”æ›´æ–°ç¼“å­˜ï¼Œè¿™æ ·å­ç¼“å­˜å†…çš„æ•°æ®å°±æ˜¯æœ€æ–°ã€‚åœ¨ä¸»ä»æ—¶å»¶è¿‡åï¼Œè¿™éƒ¨åˆ†æ•°æ®ç»§ç»­è¯»ä»åº“ï¼Œä»è€Œç»§ç»­åˆ©ç”¨ä»åº“æé«˜è¯»å–èƒ½åŠ›ã€‚</li>
<li>å…·ä½“è§£å†³æ–¹æ¡ˆ: <ul>
<li>å†™è¯·æ±‚å‘ç”Ÿçš„æ—¶å€™: å°†å“ªä¸ªåº“ï¼Œå“ªä¸ªè¡¨ï¼Œå“ªä¸ªä¸»é”®ä¸‰ä¸ªä¿¡æ¯æ‹¼è£…ä¸€ä¸ª key è®¾ç½®åˆ° cache é‡Œï¼Œè¿™æ¡è®°å½•çš„è¶…æ—¶æ—¶é—´ï¼Œè®¾ç½®ä¸º â€œä¸»ä»åŒæ­¥æ—¶å»¶â€, PSï¼škey çš„æ ¼å¼ä¸º â€œdb:table:PKâ€ï¼Œå‡è®¾ä¸»ä»å»¶æ—¶ä¸º 1sï¼Œè¿™ä¸ª key çš„ cache è¶…æ—¶æ—¶é—´ä¹Ÿä¸º 1sã€‚</li>
<li>å½“è¯»è¯·æ±‚å‘ç”Ÿæ—¶ï¼šè¿™æ˜¯è¦è¯»å“ªä¸ªåº“ï¼Œå“ªä¸ªè¡¨ï¼Œå“ªä¸ªä¸»é”®çš„æ•°æ®å‘¢ï¼Œä¹Ÿå°†è¿™ä¸‰ä¸ªä¿¡æ¯æ‹¼è£…ä¸€ä¸ª keyï¼Œåˆ° cache é‡Œå»æŸ¥è¯¢ï¼Œå¦‚æœï¼Œ<ul>
<li>ï¼ˆ1ï¼‰cache é‡Œæœ‰è¿™ä¸ª keyï¼Œè¯´æ˜ 1s å†…åˆšå‘ç”Ÿè¿‡å†™è¯·æ±‚ï¼Œæ•°æ®åº“ä¸»ä»åŒæ­¥å¯èƒ½è¿˜æ²¡æœ‰å®Œæˆï¼Œæ­¤æ—¶å°±åº”è¯¥å»ä¸»åº“æŸ¥è¯¢ã€‚å¹¶ä¸”æŠŠä¸»åº“çš„æ•°æ® set åˆ°ç¼“å­˜ä¸­ï¼Œé˜²æ­¢ä¸‹ä¸€æ¬¡ cache missã€‚</li>
<li>ï¼ˆ2ï¼‰cache é‡Œæ²¡æœ‰è¿™ä¸ª keyï¼Œè¯´æ˜æœ€è¿‘æ²¡æœ‰å‘ç”Ÿè¿‡å†™è¯·æ±‚ï¼Œæ­¤æ—¶å°±å¯ä»¥å»ä»åº“æŸ¥è¯¢</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ç¼“å­˜é›ªå´©æ˜¯å•¥-å’‹å¤„ç†"><a href="#ç¼“å­˜é›ªå´©æ˜¯å•¥-å’‹å¤„ç†" class="headerlink" title="ç¼“å­˜é›ªå´©æ˜¯å•¥?å’‹å¤„ç†?"></a>ç¼“å­˜é›ªå´©æ˜¯å•¥?å’‹å¤„ç†?</h2><p>æ˜¯æŒ‡<strong>å¤§é¢ç§¯çš„ç¼“å­˜å¤±æ•ˆï¼Œæ‰“å´©äº†DB.</strong></p>
<p>å¦‚æœç¼“å­˜æŒ‚æ‰ï¼Œæ‰€æœ‰çš„è¯·æ±‚ä¼šå‹åˆ°æ•°æ®åº“ï¼Œå¦‚æœæœªæå‰åšå®¹é‡é¢„ä¼°ï¼Œå¯èƒ½ä¼šæŠŠæ•°æ®åº“å‹å®ï¼ˆåœ¨ç¼“å­˜æ¢å¤ä¹‹å‰ï¼Œæ•°æ®åº“å¯èƒ½ä¸€ç›´éƒ½èµ·ä¸æ¥ï¼‰ï¼Œå¯¼è‡´ç³»ç»Ÿæ•´ä½“ä¸å¯æœåŠ¡ã€‚<br>åˆæˆ–è€…æ‰“ä¸ªæ¯”æ–¹, å¦‚æœæ‰€æœ‰é¦–é¡µçš„Keyå¤±æ•ˆæ—¶é—´éƒ½æ˜¯12å°æ—¶ï¼Œä¸­åˆ12ç‚¹åˆ·æ–°çš„ï¼Œæˆ‘é›¶ç‚¹æœ‰ä¸ªç§’æ€æ´»åŠ¨å¤§é‡ç”¨æˆ·æ¶Œå…¥ï¼Œå‡è®¾å½“æ—¶æ¯ç§’ 6000 ä¸ªè¯·æ±‚ï¼Œæœ¬æ¥ç¼“å­˜åœ¨å¯ä»¥æ‰›ä½æ¯ç§’ 5000 ä¸ªè¯·æ±‚ï¼Œä½†æ˜¯ç¼“å­˜å½“æ—¶æ‰€æœ‰çš„Keyéƒ½å¤±æ•ˆäº†ã€‚æ­¤æ—¶ 1 ç§’ 6000 ä¸ªè¯·æ±‚å…¨éƒ¨è½æ•°æ®åº“ï¼Œæ•°æ®åº“å¿…ç„¶æ‰›ä¸ä½.</p>
<p>å¤„ç†æ–¹æ¡ˆ: </p>
<ul>
<li>keyéšæœºè¿‡æœŸ</li>
<li>keyæ°¸ä¸è¿‡æœŸ, æ¯”å¦‚å¼€ä¸ªå•ç‹¬çº¿ç¨‹å»å®šæ—¶æ›´æ–°ç¼“å­˜</li>
<li>é«˜å¯ç”¨, å¦‚æœRedisæ˜¯é›†ç¾¤éƒ¨ç½²ï¼Œå°†çƒ­ç‚¹æ•°æ®å‡åŒ€åˆ†å¸ƒåœ¨ä¸åŒçš„Redisåº“ä¸­ä¹Ÿèƒ½é¿å…å…¨éƒ¨å¤±æ•ˆçš„é—®é¢˜</li>
<li>éš”ç¦»æœåŠ¡, é™æµé™çº§</li>
</ul>
<h2 id="ç¼“å­˜ç©¿é€æ˜¯å•¥-å’‹å¤„ç†"><a href="#ç¼“å­˜ç©¿é€æ˜¯å•¥-å’‹å¤„ç†" class="headerlink" title="ç¼“å­˜ç©¿é€æ˜¯å•¥?å’‹å¤„ç†?"></a>ç¼“å­˜ç©¿é€æ˜¯å•¥?å’‹å¤„ç†?</h2><p>æ˜¯æŒ‡<strong>ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½æ²¡æœ‰çš„æ•°æ®ï¼Œè€Œç”¨æˆ·ä¸æ–­å‘èµ·è¯·æ±‚ï¼Œä¸¥é‡ä¼šå‡»å®æ•°æ®åº“</strong> </p>
<p>æˆ‘ä»¬æ•°æ®åº“çš„ id éƒ½æ˜¯1å¼€å§‹è‡ªå¢ä¸Šå»çš„ï¼Œå¦‚å‘èµ·ä¸ºidå€¼ä¸º -1 çš„æ•°æ®æˆ– id ä¸ºç‰¹åˆ«å¤§ä¸å­˜åœ¨çš„æ•°æ®ã€‚è¿™æ—¶çš„ç”¨æˆ·å¾ˆå¯èƒ½æ˜¯æ”»å‡»è€…ï¼Œæ”»å‡»ä¼šå¯¼è‡´æ•°æ®åº“å‹åŠ›è¿‡å¤§ï¼Œä¸¥é‡ä¼šå‡»å®æ•°æ®åº“ã€‚</p>
<p>å¤„ç†æ–¹æ¡ˆ:</p>
<ul>
<li>ç¼“å­˜ç©¿é€æˆ‘ä¼šåœ¨æ¥å£å±‚å¢åŠ æ ¡éªŒï¼Œæ¯”å¦‚ç”¨æˆ·é‰´æƒæ ¡éªŒï¼Œå‚æ•°åšæ ¡éªŒï¼Œä¸åˆæ³•çš„å‚æ•°ç›´æ¥ä»£ç Returnï¼Œæ¯”å¦‚ï¼šid åšåŸºç¡€æ ¡éªŒï¼Œid &lt;=0çš„ç›´æ¥æ‹¦æˆªç­‰ã€‚</li>
<li>å¸ƒéš†è¿‡æ»¤å™¨, æŠŠå­˜åœ¨çš„keyæå‰å­˜æ”¾å¥½åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­, å½“æŸ¥è¯¢çš„æ—¶å€™å¿«é€Ÿåˆ¤æ–­å‡ºä½ è¿™ä¸ªKeyæ˜¯å¦åœ¨æ•°æ®åº“ä¸­<strong>ä¸å­˜åœ¨æˆ–å¯èƒ½å­˜åœ¨</strong>, ä¸å­˜åœ¨åˆ™ç›´æ¥return. åŸç†å¦‚ä¸‹:<ul>
<li>å¦‚æœæˆ‘ä»¬è¦æ˜ å°„ä¸€ä¸ªå€¼åˆ°å¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å¤šä¸ªä¸åŒçš„å“ˆå¸Œå‡½æ•°ç”Ÿæˆå¤šä¸ªå“ˆå¸Œå€¼ï¼Œå¹¶å¯¹æ¯ä¸ªç”Ÿæˆçš„å“ˆå¸Œå€¼æŒ‡å‘çš„ bit ä½ç½® 1ï¼Œä¾‹å¦‚é’ˆå¯¹å€¼ â€œbaiduâ€ å’Œä¸‰ä¸ªä¸åŒçš„å“ˆå¸Œå‡½æ•°åˆ†åˆ«ç”Ÿæˆäº†å“ˆå¸Œå€¼ 1ã€4ã€7ï¼Œåˆ™æœ‰</li>
<li><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/redis/bloom_filter_1.jpg" alt></li>
<li>Okï¼Œæˆ‘ä»¬ç°åœ¨å†å­˜ä¸€ä¸ªå€¼ â€œtencentâ€ï¼Œå¦‚æœå“ˆå¸Œå‡½æ•°è¿”å› 3ã€4ã€8 çš„è¯ï¼Œå›¾ç»§ç»­å˜ä¸ºï¼š</li>
<li><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/redis/bloom_filter_2.jpg" alt></li>
<li>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ4 è¿™ä¸ª bit ä½ç”±äºä¸¤ä¸ªå€¼çš„å“ˆå¸Œå‡½æ•°éƒ½è¿”å›äº†è¿™ä¸ª bit ä½ï¼Œå› æ­¤å®ƒè¢«è¦†ç›–äº†ã€‚ç°åœ¨æˆ‘ä»¬å¦‚æœæƒ³æŸ¥è¯¢ â€œdianpingâ€ è¿™ä¸ªå€¼æ˜¯å¦å­˜åœ¨ï¼Œå“ˆå¸Œå‡½æ•°è¿”å›äº† 1ã€5ã€8ä¸‰ä¸ªå€¼ï¼Œç»“æœæˆ‘ä»¬å‘ç° 5 è¿™ä¸ª bit ä½ä¸Šçš„å€¼ä¸º 0ï¼Œè¯´æ˜æ²¡æœ‰ä»»ä½•ä¸€ä¸ªå€¼æ˜ å°„åˆ°è¿™ä¸ª bit ä½ä¸Šï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å¾ˆç¡®å®šåœ°è¯´ â€œdianpingâ€ è¿™ä¸ªå€¼ä¸å­˜åœ¨ã€‚è€Œå½“æˆ‘ä»¬éœ€è¦æŸ¥è¯¢ â€œbaiduâ€ è¿™ä¸ªå€¼æ˜¯å¦å­˜åœ¨çš„è¯ï¼Œé‚£ä¹ˆå“ˆå¸Œå‡½æ•°å¿…ç„¶ä¼šè¿”å› 1ã€4ã€7ï¼Œç„¶åæˆ‘ä»¬æ£€æŸ¥å‘ç°è¿™ä¸‰ä¸ª bit ä½ä¸Šçš„å€¼å‡ä¸º 1ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¯´ â€œbaiduâ€ å­˜åœ¨äº†ä¹ˆï¼Ÿç­”æ¡ˆæ˜¯ä¸å¯ä»¥ï¼Œåªèƒ½æ˜¯ â€œbaiduâ€ è¿™ä¸ªå€¼å¯èƒ½å­˜åœ¨ã€‚</li>
</ul>
</li>
</ul>
<h2 id="ç¼“å­˜å‡»ç©¿æ˜¯å•¥-å’‹å¤„ç†"><a href="#ç¼“å­˜å‡»ç©¿æ˜¯å•¥-å’‹å¤„ç†" class="headerlink" title="ç¼“å­˜å‡»ç©¿æ˜¯å•¥?å’‹å¤„ç†?"></a>ç¼“å­˜å‡»ç©¿æ˜¯å•¥?å’‹å¤„ç†?</h2><p>æ˜¯æŒ‡<strong>æŒç»­çš„å¤§å¹¶å‘çš„è®¿é—®ä¸€ä¸ªçƒ­ç‚¹æ•°æ®, å½“è¿™ä¸ªKeyåœ¨å¤±æ•ˆçš„ç¬é—´ï¼ŒæŒç»­çš„å¤§å¹¶å‘å°±ç©¿ç ´ç¼“å­˜ï¼Œç›´æ¥è¯·æ±‚æ•°æ®åº“</strong></p>
<p>è¿™ä¸ªè·Ÿç¼“å­˜é›ªå´©æœ‰ç‚¹åƒï¼Œä½†æ˜¯åˆæœ‰ä¸€ç‚¹ä¸ä¸€æ ·ï¼Œç¼“å­˜é›ªå´©æ˜¯å› ä¸ºå¤§é¢ç§¯çš„ç¼“å­˜å¤±æ•ˆï¼Œæ‰“å´©äº†DBï¼Œè€Œç¼“å­˜å‡»ç©¿ä¸åŒçš„æ˜¯ç¼“å­˜å‡»ç©¿æ˜¯æŒ‡ä¸€ä¸ªKeyéå¸¸<strong>çƒ­ç‚¹</strong>ï¼Œåœ¨ä¸åœçš„æ‰›ç€å¤§å¹¶å‘ï¼Œå¤§å¹¶å‘é›†ä¸­å¯¹è¿™ä¸€ä¸ªç‚¹è¿›è¡Œè®¿é—®ï¼Œå½“è¿™ä¸ªKeyåœ¨å¤±æ•ˆçš„ç¬é—´ï¼ŒæŒç»­çš„å¤§å¹¶å‘å°±ç©¿ç ´ç¼“å­˜ï¼Œç›´æ¥è¯·æ±‚æ•°æ®åº“ï¼Œå°±åƒåœ¨ä¸€ä¸ªå®Œå¥½æ— æŸçš„æ¡¶ä¸Šå‡¿å¼€äº†ä¸€ä¸ªæ´ã€‚</p>
<p>å¤„ç†æ–¹æ¡ˆ:</p>
<ul>
<li>keyæ°¸ä¸è¿‡æœŸ, æ¯”å¦‚å¼€ä¸ªå•ç‹¬çº¿ç¨‹å»å®šæ—¶æ›´æ–°ç¼“å­˜</li>
<li>äº’æ–¥é”, åœ¨keyå¤±æ•ˆçš„ç¬é—´, åªå…è®¸ä¸€ä¸ªæŸ¥è¯¢æ“ä½œçš„çº¿ç¨‹Aå»æŸ¥è¯¢æ•°æ®åº“å¹¶é‡å»ºç¼“å­˜å¹¶ä¸Šäº’æ–¥é”, å…¶ä»–çš„æŸ¥è¯¢æ“ä½œçº¿ç¨‹å…¨éƒ¨ç­‰å¾…çº¿ç¨‹Aæ“ä½œå®Œäº†å†ä»ç¼“å­˜é‡Œå–æ•°æ®</li>
</ul>
<h1 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h1><ul>
<li>etcd å‚è€ƒ <a href="https://wingsxdu.com/post/database/etcd/#gsc.tab=0" target="_blank" rel="noopener">https://wingsxdu.com/post/database/etcd/#gsc.tab=0</a></li>
<li>raft å‚è€ƒ <a href="https://www.jianshu.com/p/5aed73b288f7" target="_blank" rel="noopener">https://www.jianshu.com/p/5aed73b288f7</a></li>
<li><p>é‡ç‚¹å‚è€ƒ <a href="https://segmentfault.com/a/1190000022248118" target="_blank" rel="noopener">https://segmentfault.com/a/1190000022248118</a></p>
</li>
<li><p>etcd æ˜¯ä¸€ä¸ª Go è¯­è¨€ç¼–å†™çš„åˆ†å¸ƒå¼ã€é«˜å¯ç”¨çš„<strong>å¼ºä¸€è‡´æ€§</strong>é”®å€¼å­˜å‚¨ç³»ç»Ÿï¼Œç”¨äºæä¾›å¯é çš„åˆ†å¸ƒå¼é”®å€¼(key-value)å­˜å‚¨ã€é…ç½®å…±äº«å’ŒæœåŠ¡å‘ç°ç­‰åŠŸèƒ½ã€‚ etcdå¯ä»¥ç”¨äºå­˜å‚¨å…³é”®æ•°æ®å’Œå®ç°åˆ†å¸ƒå¼è°ƒåº¦ï¼Œå®ƒåœ¨ç°ä»£åŒ–çš„é›†ç¾¤è¿è¡Œä¸­èƒ½å¤Ÿèµ·åˆ°å…³é”®æ€§çš„ä½œç”¨ã€‚</p>
</li>
<li><p>Raftç”¨äºä¿è¯åˆ†å¸ƒå¼æ•°æ®çš„ä¸€è‡´æ€§ã€‚<a href="http://thesecretlivesofdata.com/raft/" target="_blank" rel="noopener">åŠ¨ç”»æ¼”ç¤ºRaft</a></p>
</li>
</ul>
<h2 id="Rafté€‰ä¸»è¿‡ç¨‹"><a href="#Rafté€‰ä¸»è¿‡ç¨‹" class="headerlink" title="Rafté€‰ä¸»è¿‡ç¨‹"></a>Rafté€‰ä¸»è¿‡ç¨‹</h2><video width="100%" controls="controls"><br><source src="/img/noodle_plan/etcd/leader_election.webm" type="video/mp4"><br></video>

<p><a href="http://thesecretlivesofdata.com/raft/#election" target="_blank" rel="noopener">åŠ¨ç”»æ¼”ç¤ºRafté€‰ä¸»</a><br>å‰æçŸ¥è¯†:  </p>
<ul>
<li><code>Election timeout</code>é€‰ä¸¾å‘¨æœŸ: The election timeout is the amount of time a follower waits until becoming a candidate.</li>
<li><code>heartbeat timeout</code>å¿ƒè·³æ—¶é—´é—´éš”</li>
</ul>
<p>é€‰ä¸»çš„å…·ä½“æµç¨‹å¦‚ä¸‹:  </p>
<ol>
<li>å‡è®¾ä¸‰ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œä¸‰ä¸ªèŠ‚ç‚¹ä¸Šå‡è¿è¡Œ ä¸€ä¸ªéšæœºé€‰ä¸¾å‘¨æœŸtimerï¼ˆæ¯ä¸ª Timer æŒç»­æ—¶é—´æ˜¯éšæœºçš„, ä¸€èˆ¬æ˜¯150~300msï¼‰ï¼ŒRaftç®—æ³•ä½¿ç”¨éšæœº Timer æ¥åˆå§‹åŒ– Leader é€‰ä¸¾æµç¨‹ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ç‡å…ˆå®Œæˆäº† Timerï¼Œé‚£å®ƒå°±è¦å˜æˆcandidateï¼Œç„¶åå¸¦ç€è‡ªèº«çš„æ•°æ®ç‰ˆæœ¬ä¿¡æ¯å‘èµ·vote</li>
<li>éšåå®ƒå°±ä¼šå‘å…¶ä»–ä¸¤ä¸ªèŠ‚ç‚¹å‘é€æˆä¸º Leader çš„è¯·æ±‚ï¼Œå…¶ä»–followerèŠ‚ç‚¹æ¥æ”¶åˆ°è¯·æ±‚åä¼šä»¥æŠ•ç¥¨å›åº”ç„¶åç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦è¢«é€‰ä¸¾ä¸º Leaderã€‚<ul>
<li>åœ¨æ¯ä¸€ä»»æœŸå†…ï¼Œæœ€å¤šå…è®¸ä¸€ä¸ªèŠ‚ç‚¹è¢«é€‰ä¸¾ä¸ºleader </li>
<li>æŠ•ç¥¨åå°±ä¼šé‡ç½®ä¸€ä¸‹é€‰ä¸¾å‘¨æœŸtimer, é‡æ–°è®¡æ—¶</li>
<li>æ£€æŸ¥æ˜¯å¦candidateçš„æ•°æ®ç‰ˆæœ¬æ¯”è‡ªå·±è¦æ–°, å¦‚æœæ¯”è‡ªå·±æ—§, é‚£å°±ä¼šæ— æƒ…æ‹’ç», </li>
<li>å¦‚æœæœ‰éƒ½å˜æˆäº†candidateçš„å¤šä¸ªèŠ‚ç‚¹ï¼Œfollowerä»¬é‡‡å–å“ªä¸ªcandidateå…ˆæ¥å…ˆæŠ•ç¥¨çš„ç­–ç•¥ã€‚</li>
<li>åœ¨ä¸€ä¸ªä»»æœŸå†…ï¼Œä¸€ä¸ªèŠ‚ç‚¹åªèƒ½æŠ•ä¸€ç¥¨</li>
<li>å¦‚æœè¶…è¿‡åŠæ•°çš„followeréƒ½è®¤ä¸ºä»–æ˜¯åˆé€‚åšé¢†å¯¼çš„ï¼Œé‚£ä¹ˆæ­å–œï¼Œæ–°çš„leaderäº§ç”Ÿäº†.</li>
</ul>
</li>
<li>æˆä¸º Leader åï¼Œè¯¥èŠ‚ç‚¹ä¼šä»¥å›ºå®šå¿ƒè·³æ—¶é—´é—´éš”<code>heartbeat timeout</code>å‘å…¶ä»–èŠ‚ç‚¹å‘é€é€šçŸ¥ç¡®ä¿è‡ªå·±ä»æ˜¯Leaderï¼Œfolloweræ”¶åˆ°äº†å¿ƒè·³åˆ™ä¼šé‡ç½®ä¸€ä¸‹é€‰ä¸¾å‘¨æœŸtimer, é‡æ–°è®¡æ—¶ã€‚</li>
<li>æœ‰äº›æƒ…å†µä¸‹å½“ Follower ä»¬æ”¶ä¸åˆ° Leader çš„é€šçŸ¥åï¼Œæ¯”å¦‚è¯´ Leader èŠ‚ç‚¹å®•æœºæˆ–è€…å¤±å»äº†è¿æ¥ï¼Œåˆ™å…¶ä»–èŠ‚ç‚¹å½“é€‰ä¸¾å‘¨æœŸtimeråˆ°æœŸåå°±ä¼šä¼šé‡å¤ä¹‹å‰é€‰ä¸¾è¿‡ç¨‹é€‰ä¸¾å‡ºæ–°çš„ Leaderã€‚</li>
<li>å¦‚æœå¤šä¸ªcandidateåŒæ—¶å‘èµ·äº†é€‰ä¸¾:  <ul>
<li>åªæœ‰followerèƒ½æŠ•ç¥¨ä¸”åªèƒ½æŠ•ä¸€æ¬¡(æŠ•äº†aå°±ä¸èƒ½æŠ•bäº†), candidate B æ˜¯ä¸èƒ½ç»™candidate A æŠ•ç¥¨çš„</li>
<li>å¦‚æœå…¶ä¸­ä¸€ä¸ªcandidateæ‹¿åˆ°äº†è¶…è¿‡åŠæ•°çš„é€‰ç¥¨ä¹Ÿå¯ä»¥æˆä¸ºleader</li>
<li>å¦‚æœæ‰€æœ‰candidateéƒ½æ²¡æœ‰è·å¾—å¤§å¤šæ•°é€‰ç¥¨æ—¶(å¾ˆå¯èƒ½å‘ç”Ÿè¿™ç§æƒ…å†µ, å› ä¸ºåœ¨ä¸€ä¸ªä»»æœŸå†…ï¼Œä¸€ä¸ªèŠ‚ç‚¹åªèƒ½æŠ•ä¸€ç¥¨, æŠ•äº†Aå°±ä¸èƒ½å†æŠ•Bäº†)ï¼Œåˆ™æ‰€æœ‰èŠ‚ç‚¹è¿˜æ˜¯è¿˜æ˜¯ç»§ç»­èµ°ä¸€ä¸ªéšæœºé€‰ä¸¾å‘¨æœŸtimerçš„é€‰ä¸¾æµç¨‹, ç­‰å¾…ä¸‹ä¸€æ¬¡æŸä¸ªèŠ‚ç‚¹çš„é€‰ä¸¾å‘¨æœŸtimerè§¦å‘åˆ™termåŠ 1è¿›è¡Œä¸‹ä¸€ä»»æœŸçš„é€‰ä¸¾</li>
</ul>
</li>
</ol>
<h2 id="æ•°æ®è¯»å†™æµç¨‹å¦‚ä½•ä¿è¯ä¸€è‡´æ€§çš„"><a href="#æ•°æ®è¯»å†™æµç¨‹å¦‚ä½•ä¿è¯ä¸€è‡´æ€§çš„" class="headerlink" title="æ•°æ®è¯»å†™æµç¨‹å¦‚ä½•ä¿è¯ä¸€è‡´æ€§çš„"></a>æ•°æ®è¯»å†™æµç¨‹å¦‚ä½•ä¿è¯ä¸€è‡´æ€§çš„</h2><video width="100%" controls="controls"><br><source src="/img/noodle_plan/etcd/log_replication.webm" type="video/mp4"><br></video>

<p><a href="http://thesecretlivesofdata.com/raft/#replication" target="_blank" rel="noopener">Raftçš„log entryçš„å¤åˆ¶æµç¨‹åŠ¨ç”»</a></p>
<h3 id="etcdå†™è¯·æ±‚æµç¨‹"><a href="#etcdå†™è¯·æ±‚æµç¨‹" class="headerlink" title="etcdå†™è¯·æ±‚æµç¨‹"></a>etcdå†™è¯·æ±‚æµç¨‹</h3><p>å†™è¯·æ±‚çš„è¿‡ç¨‹ç®€è¦æ€»ç»“:  </p>
<ul>
<li>åœ¨etcd-raftå®ç°ä¸­ï¼Œæ‰€æœ‰çš„å†™è¯·æ±‚éƒ½ä¼šç”±leaderæ‰§è¡Œå¹¶å°†è¯·æ±‚æ—¥å¿—åŒæ­¥åˆ°followerèŠ‚ç‚¹ï¼Œä¸”è‹¥followerèŠ‚ç‚¹æ”¶åˆ°å®¢æˆ·ç«¯çš„å†™è¯·æ±‚ï¼Œåˆ™æ˜¯æŠŠå†™è¯·æ±‚è½¬å‘ç»™leaderã€‚</li>
<li>å¾…è¯¥ å†™è¯·æ±‚ æ—¥å¿—è¢«å¤åˆ¶åˆ°é›†ç¾¤åŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹æ—¶ï¼Œè¯¥ å†™è¯·æ±‚ æ—¥å¿—ä¼šè¢« Leader èŠ‚ç‚¹ç¡®è®¤ä¸ºå·±æäº¤ï¼ŒLeader ä¼šå›å¤å®¢æˆ·ç«¯å†™è¯·æ±‚æ“ä½œæˆåŠŸ</li>
</ul>
<p>ä¸ºä»€ä¹ˆè¯´<strong>å³ä½¿å®Œæˆäº†ä¸€æ¬¡å†™è¯·æ±‚æµç¨‹ä¹Ÿæœ‰å¯èƒ½è¯»åˆ°è¿‡æœŸæ•°æ®</strong>?  etcdåˆæ˜¯å¦‚ä½•è§£å†³æ­¤é—®é¢˜çš„?(è§æ­¤<a href="#etcdçº¿æ€§ä¸€è‡´æ€§è¯»">etcdçº¿æ€§ä¸€è‡´æ€§è¯»</a>)</p>
<ul>
<li>å‰æçŸ¥è¯†: <ul>
<li>consensuså…±è¯†åœ¨å®ç°æœºåˆ¶ä¸Šå±äºå¤åˆ¶çŠ¶æ€æœº(Replicated State Machine)çš„èŒƒç•´ï¼Œå¤åˆ¶çŠ¶æ€æœºæ˜¯ä¸€ç§å¾ˆæœ‰æ•ˆçš„å®¹é”™æŠ€æœ¯ï¼ŒåŸºäºå¤åˆ¶æ—¥å¿—æ¥å®ç°ï¼Œæ¯ä¸ª Server å­˜å‚¨ç€ä¸€ä»½åŒ…å«å‘½ä»¤åºåˆ—çš„æ—¥å¿—æ–‡ä»¶ï¼ŒçŠ¶æ€æœºä¼šæŒ‰é¡ºåºæ‰§è¡Œè¿™äº›å‘½ä»¤ã€‚å› ä¸ºæ—¥å¿—ä¸­çš„å‘½ä»¤å’Œé¡ºåºéƒ½ç›¸åŒï¼Œå› æ­¤æ‰€æœ‰èŠ‚ç‚¹ä¼šå¾—åˆ°ç›¸åŒçš„æ•°æ®ã€‚å› æ­¤ä¿è¯ç³»ç»Ÿä¸€è‡´æ€§å°±ç®€åŒ–ä¸ºä¿è¯æ“ä½œæ—¥å¿—çš„ä¸€è‡´ï¼Œè¿™ç§å¤åˆ¶æ—¥å¿—çš„æ–¹å¼è¢«å¤§é‡è¿ç”¨ï¼Œå¦‚ GSFã€HDFSã€ZooKeeperå’Œ etcd éƒ½æ˜¯è¿™ç§æœºåˆ¶ã€‚</li>
<li>raftä¸­çš„æ—¥å¿—(log entry)å¹¶ä¸æ˜¯ç³»ç»ŸDebugæ—¥å¿—ï¼Œè€Œæ˜¯åºåˆ—åŒ–åçš„commandï¼Œè¿™äº›Commandå¤åˆ¶åˆ°å„ä¸ªèŠ‚ç‚¹åï¼Œé€šè¿‡åºåˆ—åŒ–å†…å®¹çš„è§£æå‡ºå‘½ä»¤åï¼Œåœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œå¹¶è¿”å›æ“ä½œç»“æœä»è€Œå®ç°å¤åˆ¶çŠ¶æ€æœº</li>
</ul>
</li>
<li>åŸå› :  <ul>
<li>etcd å°±å®Œæˆäº†ä¸€æ¬¡å†™æ“ä½œä»…ä»…ä»£è¡¨å†™è¯·æ±‚æ—¥å¿—æ“ä½œæˆåŠŸå®Œæ¯•äº†ï¼Œå†™æ“ä½œæˆåŠŸä»…ä»…æ„å‘³ç€æ—¥å¿—è¾¾æˆäº†ä¸€è‡´ï¼ˆå·²ç»è½ç›˜ï¼‰,å¹¶ä¸æ„å‘³ç€è¿™æ¡æ—¥å¿—è¢«åº”ç”¨åˆ°çŠ¶æ€æœº(çŠ¶æ€æœº apply æ—¥å¿—çš„è¡Œä¸ºåœ¨å¤§å¤šæ•° Raft ç®—æ³•çš„å®é™…å®ç°ä¸­éƒ½æ˜¯å¼‚æ­¥çš„, raftä¸ç®¡å…·ä½“çŠ¶æ€æœºå¦‚ä½•å®ç°, ä»–åªè§„å®šäº†æ—¥å¿—çš„å¤åˆ¶æµç¨‹ç®—æ³•æ ‡å‡†)ï¼Œè€Œå¹¶ä¸èƒ½ç¡®ä¿å½“å‰çŠ¶æ€æœºä¹Ÿå·²ç» apply äº†æ—¥å¿—ã€‚æ‰€ä»¥æ­¤æ—¶è¯»å–çŠ¶æ€æœºå¹¶ä¸èƒ½å‡†ç¡®ååº”æ•°æ®çš„çŠ¶æ€ï¼Œå¾ˆå¯èƒ½ä¼šè¯»åˆ°è¿‡æœŸæ•°æ®ã€‚</li>
<li>Leader åº”ç”¨äº†è¿™æ¡æ—¥å¿—ä¹Ÿä¸æ„å‘³ç€æ‰€æœ‰çš„ Follower éƒ½åº”ç”¨äº†è¿™æ¡æ—¥å¿—ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¼šç‹¬ç«‹åœ°å†³å®šåº”ç”¨æ—¥å¿—çš„æ—¶æœºï¼Œè¿™ä¸­é—´å¯èƒ½å­˜åœ¨ç€ä¸€å®šçš„å»¶è¿Ÿã€‚è™½ç„¶ etcd åº”ç”¨æ—¥å¿—çš„è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼Œä½†æ˜¯è¿™ç§æ‰¹å¤„ç†ç­–ç•¥èƒ½å¤Ÿä¸€æ¬¡æ‰¹é‡å†™å…¥å¤šæ¡æ—¥å¿—ï¼Œå¯ä»¥æå‡èŠ‚ç‚¹çš„ I/O æ€§èƒ½ã€‚</li>
</ul>
</li>
<li>etcd æœ‰é¢å¤–çš„æœºåˆ¶è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è¿™éƒ¨åˆ†å†…å®¹ä¼šåœ¨ä¸‹æ–‡çš„<a href="#etcdçº¿æ€§ä¸€è‡´æ€§è¯»">etcdçº¿æ€§ä¸€è‡´æ€§è¯»</a>ä»‹ç»åˆ°ã€‚</li>
</ul>
<h3 id="etcdçº¿æ€§ä¸€è‡´æ€§è¯»"><a href="#etcdçº¿æ€§ä¸€è‡´æ€§è¯»" class="headerlink" title="etcdçº¿æ€§ä¸€è‡´æ€§è¯»"></a>etcdçº¿æ€§ä¸€è‡´æ€§è¯»</h3><p>etcd ä¸¤ç§æ–¹æ¡ˆæ¥ä¿è¯çº¿æ€§ä¸€è‡´æ€§è¯»:  </p>
<ul>
<li>ReadIndex æ–¹æ¡ˆ<ul>
<li>ReadIndexæ˜¯etcd-raftçš„é»˜è®¤æ–¹æ¡ˆã€‚</li>
<li>è™½ç„¶çŠ¶æ€æœºåº”ç”¨æ—¥å¿—çš„è¡Œä¸ºæ˜¯å¼‚æ­¥çš„ï¼Œä½†æ˜¯å·²ç»æäº¤çš„æ—¥å¿—éƒ½æ»¡è¶³çº¿æ€§ä¸€è‡´ï¼Œé‚£ä¹ˆåªè¦ç­‰å¾…è¿™äº›æ—¥å¿—éƒ½åº”ç”¨åˆ°çŠ¶æ€æœºä¸­å†æ‰§è¡ŒæŸ¥è¯¢ï¼Œè¯»è¯·æ±‚ä¹Ÿå¯ä»¥æ»¡è¶³çº¿æ€§ä¸€è‡´ã€‚</li>
<li>ReadIndexæœºåˆ¶çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š<ul>
<li>ä» leaderèŠ‚ç‚¹è¯»:<br>  1. è¯»æ“ä½œæ‰§è¡Œå‰è®°å½•ã€æ­¤æ—¶ã€é›†ç¾¤çš„ CommittedIndex(commitIndexå³ä¸ºlogä¸­æœ€åä¸€ä¸ªè¢«æäº¤çš„indexå€¼. å› ä¸ºæ­¤æ—¶è‡ªå·±å°±æ˜¯leader, æ‰€ä»¥ä» leader è·å–åˆ°çš„ commited index å°±ä½œä¸ºæ­¤æ¬¡è¯»è¯·æ±‚çš„ ReadIndex)ï¼Œè®°ä¸ºReadIndexï¼›<br>  2. å‘ Follower å‘é€å¿ƒè·³æ¶ˆæ¯ï¼Œå¦‚æœè¶…è¿‡æ³•å®šäººæ•°çš„èŠ‚ç‚¹å“åº”äº†å¿ƒè·³æ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±èƒ½ä¿è¯ å½“å‰Leader èŠ‚ç‚¹è¿˜æ˜¯leader, ä¸»è¦æ˜¯é˜²æ­¢æœ¬leaderæ˜¯å·²ç»éš”ç¦»çš„äº†å°é›†ç¾¤é‡Œçš„leaderï¼Œè¿™æ ·å°±ç¡®ä¿äº† Leader èŠ‚ç‚¹çš„æ•°æ®éƒ½æ˜¯æœ€æ–°çš„<br>  3. ç­‰å¾…çŠ¶æ€æœºã€è‡³å°‘ã€åº”ç”¨åˆ°ReadIndexï¼Œå³ AppliedIndex &gt;= ReadIndexï¼›<br>  4. æ‰§è¡Œè¯»è¯·æ±‚ï¼Œå°†ç»“æœè¿”å›ç»™ Clientã€‚</li>
<li>ä» follower èŠ‚ç‚¹è¯»:<ul>
<li>Follower å…ˆå‘ Leader è¯¢é—® readIndexï¼ŒLeader æ”¶åˆ° Follower çš„è¯·æ±‚åä¾ç„¶è¦é€šè¿‡ ä¸Šè¿°çš„ç¬¬2æ­¥éª¤å¹¿æ’­å¿ƒè·³ç¡®è®¤è‡ªå·± Leader çš„èº«ä»½ï¼Œç„¶åè¿”å›å½“å‰çš„ commitIndex ä½œä¸º readIndexï¼ŒFollower æ‹¿åˆ° readIndex åï¼Œç­‰å¾…æœ¬åœ°çš„ applyIndex å¤§äºç­‰äº readIndex åï¼Œå³å¯è¯»å–çŠ¶æ€æœºä¸­çš„æ•°æ®è¿”å›ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>LeaseRead æ–¹æ¡ˆ<ul>
<li>etcd-raftä¸æ¨èé‡‡ç”¨æ­¤æ–¹æ¡ˆ</li>
<li>åŸºæœ¬çš„æ€è·¯æ˜¯ Leader å–ä¸€ä¸ªæ¯” <code>Election Timeout</code>é€‰ä¸¾å‘¨æœŸå°çš„ç§ŸæœŸï¼Œåœ¨ç§ŸæœŸä¸ä¼šå‘ç”Ÿé€‰ä¸¾ï¼Œç¡®ä¿ Leader ä¸ä¼šå˜ï¼Œæ‰€ä»¥å¯ä»¥è·³è¿‡ ReadIndex çš„ç¬¬äºŒæ­¥ï¼Œä¹Ÿå°±é™ä½äº†å»¶æ—¶ã€‚ </li>
<li>LeaseRead ä¸ ReadIndex ç±»ä¼¼ï¼Œä½†æ›´è¿›ä¸€æ­¥ï¼Œä¸ä»…çœå»äº† Logï¼Œè¿˜çœå»äº†ç½‘ç»œäº¤äº’ã€‚å®ƒå¯ä»¥å¤§å¹…æå‡è¯»çš„ååä¹Ÿèƒ½æ˜¾è‘—é™ä½å»¶æ—¶ã€‚</li>
<li>ç¼ºé™·: LeaseRead çš„æ­£ç¡®æ€§å’Œæ—¶é—´æŒ‚é’©ï¼Œå› æ­¤æ—¶é—´çš„å®ç°è‡³å…³é‡è¦ï¼Œå¦‚æœæ¼‚ç§»ä¸¥é‡ï¼Œè¿™å¥—æœºåˆ¶å°±ä¼šæœ‰é—®é¢˜ã€‚LeaseRead çš„æ­£ç¡®æ€§å’Œæ—¶é—´çš„å®ç°æŒ‚é’©ï¼Œç”±äºä¸åŒä¸»æœºçš„ CPU æ—¶é’Ÿæœ‰è¯¯å·®ï¼Œæ‰€ä»¥ä¹Ÿæœ‰å¯èƒ½è¯»å–åˆ°è¿‡æœŸçš„æ•°æ®ã€‚å†æ¬¡å¼ºè°ƒï¼Œè¿™ä¾èµ–äºæœºå™¨çš„æ—¶é’Ÿé£˜ç§»é€Ÿç‡ï¼Œæ¢è¨€ä¹‹ï¼Œè‹¥å„æœºå™¨ä¹‹é—´çš„æ—¶é’Ÿå·®åˆ«è¿‡å¤§ï¼Œåˆ™æ­¤ç§åŸºäºleaseçš„æœºåˆ¶å°±å¯èƒ½å‡ºç°é—®é¢˜</li>
</ul>
</li>
</ul>
<h2 id="etcdå­˜åœ¨è„‘è£‚æƒ…å†µå—"><a href="#etcdå­˜åœ¨è„‘è£‚æƒ…å†µå—" class="headerlink" title="etcdå­˜åœ¨è„‘è£‚æƒ…å†µå—"></a>etcdå­˜åœ¨è„‘è£‚æƒ…å†µå—</h2><p>etcdä¸å­˜åœ¨è„‘è£‚æƒ…å†µ.  </p>
<p>ä¼—æ‰€å‘¨çŸ¥ etcd ä½¿ç”¨ Raft åè®®æ¥è§£å†³æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚ä¸€ä¸ª Raft Group åªèƒ½æœ‰ä¸€ä¸ª Leader å­˜åœ¨ï¼Œå¦‚æœä¸€æ—¦å‘ç”Ÿç½‘ç»œåˆ†åŒºï¼ŒLeader åªä¼šåœ¨å¤šæ•°æ´¾ä¸€è¾¹è¢«é€‰ä¸¾å‡ºæ¥ï¼Œè€Œå°‘æ•°æ´¾åˆ™å…¨éƒ¨å¤„äº Follower æˆ– Candidate çŠ¶æ€ï¼Œæ‰€ä»¥ä¸€ä¸ªé•¿æœŸè¿è¡Œçš„é›†ç¾¤æ˜¯ä¸å­˜åœ¨è„‘è£‚é—®é¢˜çš„ã€‚etcd å®˜æ–¹æ–‡æ¡£ä¹Ÿæ˜ç¡®äº†è¿™ä¸€ç‚¹ï¼š  </p>
<blockquote>
<p>The majority side becomes the available cluster and the minority side is unavailable; there is no â€œsplit-brainâ€ in etcd.</p>
</blockquote>
<p>ä½†æ˜¯æœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œå‡å¦‚æ—§çš„ Leader å’Œé›†ç¾¤å…¶ä»–èŠ‚ç‚¹å‡ºç°äº†ç½‘ç»œåˆ†åŒºï¼Œå…¶ä»–èŠ‚ç‚¹é€‰å‡ºäº†æ–°çš„ Leaderï¼Œä½†æ˜¯æ—§ Leader å¹¶æ²¡æœ‰æ„ŸçŸ¥åˆ°æ–°çš„ Leaderï¼Œé‚£ä¹ˆæ­¤æ—¶é›†ç¾¤å¯èƒ½ä¼šå‡ºç°ä¸€ä¸ªçŸ­æš‚çš„ã€ŒåŒ Leaderã€çŠ¶æ€ã€‚è¿™ç§æƒ…å†µå¹¶ä¸èƒ½ç§°ä¹‹ä¸ºè„‘è£‚ï¼ŒåŸå› å¦‚ä¸‹ï¼š  è¿™ç§æƒ…å†µå¹¶ä¸èƒ½ç§°ä¹‹ä¸ºè„‘è£‚ï¼ŒåŸå› æœ‰äºŒï¼š</p>
<ul>
<li>è¿™ä¸æ˜¯ä¸€ä¸ªé•¿æœŸè¿è¡ŒçŠ¶æ€ï¼Œç»´æŒæ—¶é—´ä¸ä¼šè¶…è¿‡ä¸€ä¸ªæŠ•ç¥¨å‘¨æœŸ</li>
<li>etcdç½‘ç»œåˆ†åŒºæ—¶<ul>
<li>å¦‚æœleaderåœ¨å°‘æ•°æ´¾<ul>
<li>æ­¤æ—¶å¤šæ•°æ´¾ä¼šæœ‰followeré€‰ä¸¾å‘¨æœŸtimerè§¦å‘åˆ™ä»»æœŸtermå¢åŠ , å¹¶ä¸”ä¼šé€‰å‡ºå¤šæ•°æ´¾æ–°leader, </li>
<li>æ­¤æ—¶å°‘æ•°æ´¾leaderä¼šæ£€æŸ¥æ³•å®šäººæ•°æ˜¯å¦å¤§äºèŠ‚ç‚¹æ•°é‡ä¸€åŠ, æ£€æŸ¥ç¡®è®¤ååˆ™å°‘æ•°æ´¾é›†ç¾¤è¿›å…¥æ˜¯ä¸å¯ç”¨çŠ¶æ€ï¼Œå…¨éƒ¨å˜ä¸º Follower æˆ– Candidate çŠ¶æ€, ä¸æ”¯æŒraftè¯·æ±‚ï¼Œåªæ”¯æŒéä¸€è‡´æ€§è¯»è¯·æ±‚ã€‚ä¸€æ—¦ç½‘ç»œåˆ†åŒºæ¸…é™¤ï¼Œå°‘æ•°æ´¾å› ä¸ºä»»æœŸtermè¾ƒå°, åˆ™è¿™è¾¹ä¼šè‡ªåŠ¨æ‰¿è®¤æ¥è‡ªå¤šæ•°è¿™è¾¹çš„ leader å¹¶åŒæ­¥å¤šæ•°æ´¾çš„æ•°æ®çŠ¶æ€ã€‚</li>
</ul>
</li>
<li>å¦‚æœåœ¨leaderåœ¨å¤šæ•°æ´¾, åˆ™ä¸€åˆ‡ç…§æ—§</li>
</ul>
</li>
<li>ç½‘ç»œåˆ†åŒºæ—¶ etcd ä¹Ÿæœ‰ ReadIndexã€LeaseRead æœºåˆ¶æ¥è§£å†³è¿™ç§çŠ¶æ€ä¸‹çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜</li>
</ul>
<h2 id="æ–°Leaderä¼šæ— æ¡ä»¶æäº¤æ—§Leaderæ—¥å¿—å—"><a href="#æ–°Leaderä¼šæ— æ¡ä»¶æäº¤æ—§Leaderæ—¥å¿—å—" class="headerlink" title="æ–°Leaderä¼šæ— æ¡ä»¶æäº¤æ—§Leaderæ—¥å¿—å—"></a>æ–°Leaderä¼šæ— æ¡ä»¶æäº¤æ—§Leaderæ—¥å¿—å—</h2><p>å…¶å®è¿™é‡Œæœ‰ 4 ç§æƒ…å†µï¼š  </p>
<ol>
<li>Leader å¤åˆ¶ç»™å°‘æ•°èŠ‚ç‚¹ï¼Œç„¶åå®•æœº</li>
<li>Leader å¤åˆ¶ç»™å¤šæ•°èŠ‚ç‚¹ï¼Œç„¶åå®•æœº</li>
<li>Leader å¤åˆ¶ç»™å¤šæ•°èŠ‚ç‚¹ï¼Œæœ¬åœ°æäº¤æˆåŠŸï¼Œè¿”å›å®¢æˆ·ç«¯æˆåŠŸï¼Œç„¶åå®•æœº</li>
</ol>
<p>åœºæ™¯ 1-2 å‹æ ¹æ²¡æœ‰ç»™å®¢æˆ·ç«¯æ‰¿è¯ºï¼Œæ‰€ä»¥æ˜¯æ–° Leader ä¸ä¼šç«‹å³ commit å‰ä»» Leader çš„æ—¥å¿—ï¼›åœºæ™¯ 3 æ‰¿è¯ºäº†å®¢æˆ·ç«¯ï¼Œæ— è®ºå¦‚ä½•æ—¥å¿—æ˜¯ä¸å…è®¸ä¸¢çš„ï¼Œæ‰€ä»¥æ–° Leader ä¸€å®šä¼š commit æ—¥å¿—ã€‚</p>
<h2 id="etcdå¯ä»¥å¶æ•°ä¸ªéƒ¨ç½²å—"><a href="#etcdå¯ä»¥å¶æ•°ä¸ªéƒ¨ç½²å—" class="headerlink" title="etcdå¯ä»¥å¶æ•°ä¸ªéƒ¨ç½²å—"></a>etcdå¯ä»¥å¶æ•°ä¸ªéƒ¨ç½²å—</h2><p>å¯ä»¥, ä½†éå¸¸ä¸å»ºè®®.  </p>
<p>å¶æ•°ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤éä½†ä¸èƒ½æå‡å®¹é”™èƒ½åŠ›ï¼Œåè€Œä¼šå¸¦æ¥èµ„æºçš„æµªè´¹å¹¶å¯èƒ½ä½¿é€‰ä¸¾çš„æ—¶é—´å˜é•¿ã€‚åŒæ—¶åœ¨å¥‡æ•°ä¸ªé›†ç¾¤çš„æƒ…å†µä¸‹ï¼Œå³ä½¿äº§ç”Ÿç½‘ç»œåˆ†åŒºä¹Ÿèƒ½ä¿è¯å§‹ç»ˆæœ‰ä¸€æ–¹å æ®å¤§å¤šæ•°çš„èŠ‚ç‚¹ï¼Œè¿›è€Œé€‰ä¸¾å‡ºæ–°çš„ Leader æ¥ä¿è¯é›†ç¾¤çš„å¯ç”¨ã€‚è€Œå¶æ•°ä¸ªèŠ‚ç‚¹åˆ™å¯èƒ½ä¼šå‡ºç°å¯¹åŠåˆ†çš„åœºæ™¯ï¼Œè¿™æ ·ä»»æ„ä¸€æ–¹éƒ½æ— æ³•é€‰ä¸¾å‡º Leaderï¼Œå¯¼è‡´é›†ç¾¤çš„ä¸å¯ç”¨ã€‚</p>
<h2 id="ä¸èƒ½ç›´æ¥readè¿”å›å—"><a href="#ä¸èƒ½ç›´æ¥readè¿”å›å—" class="headerlink" title="ä¸èƒ½ç›´æ¥readè¿”å›å—"></a>ä¸èƒ½ç›´æ¥readè¿”å›å—</h2><p>ç–‘é—®ï¼šä¸ºä»€ä¹ˆ read è¯·æ±‚åˆ°è¾¾ leader ä¹‹åéœ€è¦è·å–æœ€æ–°çš„ commit indexï¼Œç„¶åå†ç­‰åˆ° applied index &gt;= commit index ä¹‹åå† read æ•°æ®è¿”å› ï¼Ÿä¸èƒ½ç›´æ¥ read è¿”å›å— ï¼Ÿ</p>
<p>ç­”æ¡ˆï¼šä¸å¯ä»¥ï¼Œå› ä¸ºé‚£æ ·ä¸æ»¡è¶³ linearizable readï¼Œå› ä¸ºè¦æƒ³æ»¡è¶³ linearizable read é‚£ä¹ˆå¿…é¡»ä¿è¯ï¼Œå·²ç»è¢« read åˆ°çš„æ•°æ®ï¼Œé‚£ä¹ˆåé¢çš„ read ï¼ˆéå¹¶å‘çš„ readï¼‰ éƒ½åº”è¯¥èƒ½ read åˆ°ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šå‡ºç° read åˆ°æ—§æ•°æ®ã€‚æˆ‘ä»¬å·² commit index ä¸ºä¾æ®å» readï¼Œå¯ä»¥ä¿è¯ read request åˆ°è¾¾ leader è¶Šæ™šï¼Œå…¶ commit index å¿…ç„¶è¶Šå¤§ï¼Œä¹Ÿå°±æ˜¯ r1 arrive time &lt;= r2 arrive timeï¼Œé‚£ä¹ˆ r1 commit index &lt;= r2 commit indexï¼Œé‚£ä¹ˆ r2 read åˆ°çš„æ•°æ®å°±è‡³å°‘å’Œ r1 ä¸€æ ·æ–°ï¼Œä»è€Œä¿è¯äº† linearizable readã€‚</p>
<p>ç›¸åï¼Œç›´æ¥ read è¿”å›ï¼Œç›¸å½“äºæ˜¯è®°å½•ä¸‹å½“å‰ applied indexï¼Œä½†æ˜¯ applied index å¹¶ä¸æ˜¯ä¸¥æ ¼çš„å•è°ƒçš„å¾€ä¸Šå¢åŠ çš„ï¼Œä¾‹å¦‚é›†ç¾¤ {Aï¼ŒBï¼ŒC}å¼€å§‹ A ä¸º leaderï¼Œè¿™ä¸ªæ—¶å€™ applied index ä¸º a1ï¼Œç„¶å A æŒ‚äº†ï¼ŒB é‡æ–°é€‰ä¸¾ä¸ºäº† leaderï¼Œè¿™ä¸ªæ—¶å€™ B çš„ applied index ä¸º a2ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¹¶ä¸èƒ½ä¿è¯ a2 &gt;= a1ï¼Œå› ä¸ºå¾ˆæœ‰å¯èƒ½ï¼ŒB ç”±äºæ—¥å¿—å¤åˆ¶å»¶è¿Ÿå¯¼è‡´æ—¥å¿—è™½ç„¶å¤åˆ¶è¿‡å»äº†ï¼ˆä¿è¯æ‹¥æœ‰æœ€æ–°çš„æ—¥å¿—ï¼Œèƒ½é€‰ä¸º leaderï¼‰ï¼Œä½†æ˜¯è¿˜æ²¡æ¥å¾—åŠ applyï¼Œé‚£ä¹ˆå¦‚æœä¸€ä¸ª read æ¥åˆ° Bï¼Œå¯èƒ½å°±ä¼š read åˆ°æ—§æ•°æ®ï¼Œå‡ºç° read çš„æ–°æ—§æ•°æ®åè½¬ï¼Œä»è€Œä¸æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§ã€‚</p>
<h2 id="etcdæ¶æ„åŠè§£æ"><a href="#etcdæ¶æ„åŠè§£æ" class="headerlink" title="etcdæ¶æ„åŠè§£æ"></a>etcdæ¶æ„åŠè§£æ</h2><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/etcd/etcd_architecture.jpeg" alt></p>
<p>ä» etcd çš„æ¶æ„å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œetcd ä¸»è¦åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ã€‚</p>
<ul>
<li>HTTP Serverï¼š ç”¨äºå¤„ç†ç”¨æˆ·å‘é€çš„ API è¯·æ±‚ä»¥åŠå…¶å®ƒ etcd èŠ‚ç‚¹çš„åŒæ­¥ä¸å¿ƒè·³ä¿¡æ¯è¯·æ±‚ã€‚</li>
<li>Storeï¼š ç”¨äºå¤„ç† etcd æ”¯æŒçš„å„ç±»åŠŸèƒ½çš„äº‹åŠ¡ï¼ŒåŒ…æ‹¬æ•°æ®ç´¢å¼•ã€èŠ‚ç‚¹çŠ¶æ€å˜æ›´ã€ç›‘æ§ä¸åé¦ˆã€äº‹ä»¶å¤„ç†ä¸æ‰§è¡Œç­‰ç­‰ï¼Œæ˜¯ etcd å¯¹ç”¨æˆ·æä¾›çš„å¤§å¤šæ•° API åŠŸèƒ½çš„å…·ä½“å®ç°ã€‚</li>
<li>Raftï¼š Raft å¼ºä¸€è‡´æ€§ç®—æ³•çš„å…·ä½“å®ç°ï¼Œæ˜¯ etcd çš„æ ¸å¿ƒã€‚</li>
<li>WALï¼š Write Ahead Logï¼ˆé¢„å†™å¼æ—¥å¿—ï¼‰ï¼Œæ˜¯ etcd çš„æ•°æ®å­˜å‚¨æ–¹å¼ã€‚é™¤äº†åœ¨å†…å­˜ä¸­å­˜æœ‰æ‰€æœ‰æ•°æ®çš„çŠ¶æ€ä»¥åŠèŠ‚ç‚¹çš„ç´¢å¼•ä»¥å¤–ï¼Œetcd å°±é€šè¿‡ WAL è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ã€‚WAL ä¸­ï¼Œæ‰€æœ‰çš„æ•°æ®æäº¤å‰éƒ½ä¼šäº‹å…ˆè®°å½•æ—¥å¿—ã€‚</li>
</ul>
<p>Snapshot æ˜¯ä¸ºäº†é˜²æ­¢æ•°æ®è¿‡å¤šè€Œè¿›è¡Œçš„çŠ¶æ€å¿«ç…§ï¼›Entry è¡¨ç¤ºå­˜å‚¨çš„å…·ä½“æ—¥å¿—å†…å®¹ã€‚</p>
<p>é€šå¸¸ï¼Œä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚å‘é€è¿‡æ¥ï¼Œä¼šç»ç”± HTTP Server è½¬å‘ç»™ Store è¿›è¡Œå…·ä½“çš„äº‹åŠ¡å¤„ç†ï¼Œå¦‚æœæ¶‰åŠåˆ°èŠ‚ç‚¹çš„ä¿®æ”¹ï¼Œåˆ™äº¤ç»™ Raft æ¨¡å—è¿›è¡ŒçŠ¶æ€çš„å˜æ›´ã€æ—¥å¿—çš„è®°å½•ï¼Œç„¶åå†åŒæ­¥ç»™åˆ«çš„ etcd èŠ‚ç‚¹ä»¥ç¡®è®¤æ•°æ®æäº¤ï¼Œæœ€åè¿›è¡Œæ•°æ®çš„æäº¤ï¼Œå†æ¬¡åŒæ­¥ã€‚</p>
<h2 id="etcdçš„ä½¿ç”¨åœºæ™¯"><a href="#etcdçš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="etcdçš„ä½¿ç”¨åœºæ™¯"></a>etcdçš„ä½¿ç”¨åœºæ™¯</h2><ul>
<li><a href="#æœåŠ¡å‘ç°æ˜¯æ€ä¹ˆå®ç°çš„">æœåŠ¡å‘ç°</a></li>
<li>è´Ÿè½½å‡è¡¡</li>
<li><a href="#åŸºäºetcdçš„åˆ†å¸ƒå¼é”">åˆ†å¸ƒå¼é”</a></li>
<li>åˆ†å¸ƒå¼é˜Ÿåˆ—<br>  ä¸Šé¢è¯´åˆ°etcdå¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°åˆ†å¸ƒå¼é”, é”æœåŠ¡æœ‰ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼Œä¸€æ˜¯ä¿æŒç‹¬å ï¼ŒäºŒæ˜¯æ§åˆ¶æ—¶åºã€‚é€šè¿‡æ§åˆ¶æ—¶åºï¼Œå³æ‰€æœ‰æƒ³è¦è·å¾—é”çš„ç”¨æˆ·éƒ½ä¼šè¢«å®‰æ’æ‰§è¡Œï¼Œä½†æ˜¯è·å¾—é”çš„é¡ºåºä¹Ÿæ˜¯å…¨å±€å”¯ä¸€çš„ï¼ŒåŒæ—¶å†³å®šäº†æ‰§è¡Œé¡ºåº, å°±å¯ä»¥å®ç°åˆ†å¸ƒå¼é˜Ÿåˆ—ã€‚etcd ä¸ºæ­¤ä¹Ÿæä¾›äº†ä¸€å¥— APIï¼ˆè‡ªåŠ¨åˆ›å»ºæœ‰åºé”®ï¼‰ï¼Œå¯¹ä¸€ä¸ªç›®å½•å»ºå€¼æ—¶æŒ‡å®šä¸ºPOSTåŠ¨ä½œï¼Œè¿™æ · etcd ä¼šè‡ªåŠ¨åœ¨ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªå½“å‰æœ€å¤§çš„å€¼ä¸ºé”®ï¼Œå­˜å‚¨è¿™ä¸ªæ–°çš„å€¼ï¼ˆå®¢æˆ·ç«¯ç¼–å·ï¼‰ã€‚åŒæ—¶è¿˜å¯ä»¥ä½¿ç”¨ API æŒ‰é¡ºåºåˆ—å‡ºæ‰€æœ‰å½“å‰ç›®å½•ä¸‹çš„é”®å€¼ã€‚æ­¤æ—¶è¿™äº›é”®çš„å€¼å°±æ˜¯å®¢æˆ·ç«¯çš„æ—¶åºï¼Œè€Œè¿™äº›é”®ä¸­å­˜å‚¨çš„å€¼å¯ä»¥æ˜¯ä»£è¡¨å®¢æˆ·ç«¯çš„ç¼–å·ã€‚</li>
</ul>
<h2 id="etcdæ¦‚å¿µæœ¯è¯­"><a href="#etcdæ¦‚å¿µæœ¯è¯­" class="headerlink" title="etcdæ¦‚å¿µæœ¯è¯­"></a>etcdæ¦‚å¿µæœ¯è¯­</h2><ul>
<li>Raftï¼š etcdæ‰€é‡‡ç”¨çš„ä¿è¯åˆ†å¸ƒå¼ç³»ç»Ÿå¼ºä¸€è‡´æ€§çš„ç®—æ³•ã€‚</li>
<li>Nodeï¼š ä¸€ä¸ªRaftçŠ¶æ€æœºå®ä¾‹ã€‚</li>
<li>Memberï¼š ä¸€ä¸ªetcdå®ä¾‹ã€‚å®ƒç®¡ç†ç€ä¸€ä¸ªNodeï¼Œå¹¶ä¸”å¯ä»¥ä¸ºå®¢æˆ·ç«¯è¯·æ±‚æä¾›æœåŠ¡ã€‚</li>
<li>Clusterï¼š ç”±å¤šä¸ªMemberæ„æˆå¯ä»¥ååŒå·¥ä½œçš„etcdé›†ç¾¤ã€‚</li>
<li>Peerï¼š å¯¹åŒä¸€ä¸ªetcdé›†ç¾¤ä¸­å¦å¤–ä¸€ä¸ªMemberçš„ç§°å‘¼ã€‚</li>
<li>Clientï¼š å‘etcdé›†ç¾¤å‘é€HTTPè¯·æ±‚çš„å®¢æˆ·ç«¯ã€‚</li>
<li>WALï¼š é¢„å†™å¼æ—¥å¿—ï¼Œetcdç”¨äºæŒä¹…åŒ–å­˜å‚¨çš„æ—¥å¿—æ ¼å¼ã€‚</li>
<li>snapshotï¼š etcdé˜²æ­¢WALæ–‡ä»¶è¿‡å¤šè€Œè®¾ç½®çš„å¿«ç…§ï¼Œå­˜å‚¨etcdæ•°æ®çŠ¶æ€ã€‚</li>
<li>Proxyï¼š etcdçš„ä¸€ç§æ¨¡å¼ï¼Œä¸ºetcdé›†ç¾¤æä¾›åå‘ä»£ç†æœåŠ¡ã€‚</li>
<li>Leaderï¼š Raftç®—æ³•ä¸­é€šè¿‡ç«é€‰è€Œäº§ç”Ÿçš„å¤„ç†æ‰€æœ‰æ•°æ®æäº¤çš„èŠ‚ç‚¹ã€‚</li>
<li>Followerï¼š ç«é€‰å¤±è´¥çš„èŠ‚ç‚¹ä½œä¸ºRaftä¸­çš„ä»å±èŠ‚ç‚¹ï¼Œä¸ºç®—æ³•æä¾›å¼ºä¸€è‡´æ€§ä¿è¯ã€‚</li>
<li>Candidateï¼š å½“Followerè¶…è¿‡ä¸€å®šæ—¶é—´æ¥æ”¶ä¸åˆ°Leaderçš„å¿ƒè·³æ—¶è½¬å˜ä¸ºCandidateå¼€å§‹ç«é€‰ã€‚</li>
<li>Termï¼š æŸä¸ªèŠ‚ç‚¹æˆä¸ºLeaderåˆ°ä¸‹ä¸€æ¬¡ç«é€‰æ—¶é—´ï¼Œç§°ä¸ºä¸€ä¸ªTermã€‚</li>
<li>Indexï¼š æ•°æ®é¡¹ç¼–å·ã€‚Raftä¸­é€šè¿‡Termå’ŒIndexæ¥å®šä½æ•°æ®ã€‚</li>
<li>Entry: è¡¨ç¤ºå­˜å‚¨çš„å…·ä½“æ—¥å¿—å†…å®¹ã€‚</li>
</ul>
<h2 id="etcdæ•°æ®å­˜å‚¨"><a href="#etcdæ•°æ®å­˜å‚¨" class="headerlink" title="etcdæ•°æ®å­˜å‚¨"></a>etcdæ•°æ®å­˜å‚¨</h2><p>etcd çš„å­˜å‚¨åˆ†ä¸ºå†…å­˜å­˜å‚¨å’ŒæŒä¹…åŒ–ï¼ˆç¡¬ç›˜ï¼‰å­˜å‚¨ä¸¤éƒ¨åˆ†ï¼Œå†…å­˜ä¸­çš„å­˜å‚¨é™¤äº†é¡ºåºåŒ–çš„è®°å½•ä¸‹æ‰€æœ‰ç”¨æˆ·å¯¹èŠ‚ç‚¹æ•°æ®å˜æ›´çš„è®°å½•å¤–ï¼Œè¿˜ä¼šå¯¹ç”¨æˆ·æ•°æ®è¿›è¡Œç´¢å¼•ã€å»ºå †ç­‰æ–¹ä¾¿æŸ¥è¯¢çš„æ“ä½œã€‚è€ŒæŒä¹…åŒ–åˆ™ä½¿ç”¨é¢„å†™å¼æ—¥å¿—ï¼ˆWALï¼šWrite Ahead Logï¼‰è¿›è¡Œè®°å½•å­˜å‚¨ã€‚</p>
<p>åœ¨ WAL çš„ä½“ç³»ä¸­ï¼Œæ‰€æœ‰çš„æ•°æ®åœ¨æäº¤ä¹‹å‰éƒ½ä¼šè¿›è¡Œæ—¥å¿—è®°å½•ã€‚åœ¨ etcd çš„æŒä¹…åŒ–å­˜å‚¨ç›®å½•ä¸­ï¼Œæœ‰ä¸¤ä¸ªå­ç›®å½•ã€‚ä¸€ä¸ªæ˜¯ WALï¼Œå­˜å‚¨ç€æ‰€æœ‰äº‹åŠ¡çš„å˜åŒ–è®°å½•ï¼›å¦ä¸€ä¸ªåˆ™æ˜¯ snapshotï¼Œç”¨äºå­˜å‚¨æŸä¸€ä¸ªæ—¶åˆ» etcd æ‰€æœ‰ç›®å½•çš„æ•°æ®ã€‚é€šè¿‡ WAL å’Œ snapshot ç›¸ç»“åˆçš„æ–¹å¼ï¼Œetcd å¯ä»¥æœ‰æ•ˆçš„è¿›è¡Œæ•°æ®å­˜å‚¨å’ŒèŠ‚ç‚¹æ•…éšœæ¢å¤ç­‰æ“ä½œã€‚</p>
<ul>
<li>WALï¼ˆWrite Ahead Logï¼‰æœ€å¤§çš„ä½œç”¨æ˜¯è®°å½•äº†æ•´ä¸ªæ•°æ®å˜åŒ–çš„å…¨éƒ¨å†ç¨‹ã€‚åœ¨ etcd ä¸­ï¼Œæ‰€æœ‰æ•°æ®çš„ä¿®æ”¹åœ¨æäº¤å‰ï¼Œéƒ½è¦å…ˆå†™å…¥åˆ° WAL ä¸­ã€‚ä½¿ç”¨ WAL è¿›è¡Œæ•°æ®çš„å­˜å‚¨ä½¿å¾— etcd æ‹¥æœ‰ä¸¤ä¸ªé‡è¦åŠŸèƒ½:  <ul>
<li>æ•…éšœå¿«é€Ÿæ¢å¤ï¼š å½“ä½ çš„æ•°æ®é­åˆ°ç ´åæ—¶ï¼Œå°±å¯ä»¥é€šè¿‡æ‰§è¡Œæ‰€æœ‰ WAL ä¸­è®°å½•çš„ä¿®æ”¹æ“ä½œï¼Œå¿«é€Ÿä»æœ€åŸå§‹çš„æ•°æ®æ¢å¤åˆ°æ•°æ®æŸåå‰çš„çŠ¶æ€ã€‚</li>
<li>æ•°æ®å›æ»šï¼ˆundoï¼‰/ é‡åšï¼ˆredoï¼‰ï¼šå› ä¸ºæ‰€æœ‰çš„ä¿®æ”¹æ“ä½œéƒ½è¢«è®°å½•åœ¨ WAL ä¸­ï¼Œéœ€è¦å›æ»šæˆ–é‡åšï¼Œåªéœ€è¦æ–¹å‘æˆ–æ­£å‘æ‰§è¡Œæ—¥å¿—ä¸­çš„æ“ä½œå³å¯ã€‚</li>
</ul>
</li>
<li><strong>WALçš„ç¼ºé™·</strong>: WAL æ˜¯ä¸€ç§ Append Only çš„æ—¥å¿—æ–‡ä»¶ï¼Œåªä¼šåœ¨æ–‡ä»¶ç»“å°¾ä¸æ–­åœ°æ·»åŠ æ–°æ—¥å¿—ï¼Œè¿™æ ·åšå¯ä»¥é¿å…å¤§é‡éšæœº I/O å¸¦æ¥çš„æ€§èƒ½æŸå¤±ï¼Œä½†æ˜¯éšç€ç¨‹åºçš„è¿è¡Œï¼ŒèŠ‚ç‚¹éœ€è¦å¤„ç†å®¢æˆ·ç«¯å’Œé›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹å‘æ¥çš„å¤§é‡è¯·æ±‚ï¼Œç›¸åº”çš„ WAL æ—¥å¿—é‡ä¹Ÿä¼šä¸æ–­å¢åŠ ï¼Œè¿™ä¼šå ç”¨å¤§é‡çš„ç£ç›˜ç©ºé—´ã€‚å½“èŠ‚ç‚¹å®•æœºåï¼Œå¦‚æœè¦æ¢å¤å…¶çŠ¶æ€ï¼Œåˆ™éœ€è¦ä»å¤´è¯»å–å…¨éƒ¨çš„ WAL æ—¥å¿—æ–‡ä»¶ï¼Œè¿™æ˜¾ç„¶æ˜¯éå¸¸è€—æ—¶çš„ã€‚</li>
<li><strong>WALçš„ç¼ºé™·çš„è§£å†³æ–¹æ¡ˆ: å¿«ç…§</strong>, ä¸ºäº†è§£å†³WALçš„è¿™ä¸ªç¼ºé™·ï¼Œetcd ä¼šå®šæœŸåˆ›å»ºå¿«ç…§ï¼Œå°†æ•´ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€è¿›è¡Œåºåˆ—åŒ–ï¼Œç„¶åå†™å…¥ç¨³å®šçš„å¿«ç…§æ–‡ä»¶ä¸­ï¼Œåœ¨è¯¥å¿«ç…§æ–‡ä»¶ä¹‹å‰çš„æ—¥å¿—è®°å½•å°±å¯ä»¥å…¨éƒ¨ä¸¢å¼ƒæ‰ã€‚åœ¨æ¢å¤èŠ‚ç‚¹çŠ¶æ€æ—¶ä¼šå…ˆåŠ è½½å¿«ç…§æ–‡ä»¶ï¼Œä½¿ç”¨å¿«ç…§æ•°æ®å°†èŠ‚ç‚¹æ¢å¤åˆ°å¯¹åº”çš„çŠ¶æ€ï¼Œä¹‹åä» WAL æ–‡ä»¶è¯»å–å¿«ç…§ä¹‹åçš„æ•°æ®ï¼Œå°†èŠ‚ç‚¹æ¢å¤åˆ°æ­£ç¡®çš„çŠ¶æ€ã€‚</li>
<li>etcd çš„å¿«ç…§æœ‰ä¸¤ç§:  <ul>
<li>ä¸€ç§æ˜¯ç”¨äºå­˜å‚¨æŸä¸€æ—¶åˆ» etcd çš„æ‰€æœ‰æ•°æ®çš„æ•°æ®å¿«ç…§ï¼Œ</li>
<li>å¦ä¸€ç§æ˜¯ç”¨äºé›†ç¾¤ä¸­è¾ƒæ…¢èŠ‚ç‚¹è¿½èµ¶æ•°æ®çš„ RPC å¿«ç…§ã€‚</li>
</ul>
</li>
</ul>
<h1 id="åˆ†å¸ƒå¼ç³»ç»Ÿ"><a href="#åˆ†å¸ƒå¼ç³»ç»Ÿ" class="headerlink" title="åˆ†å¸ƒå¼ç³»ç»Ÿ"></a>åˆ†å¸ƒå¼ç³»ç»Ÿ</h1><p>åˆ†å¸ƒå¼ç³»ç»Ÿçš„å°±å‡†å¤‡:  </p>
<ul>
<li>CAPç†è®º</li>
<li>BASEç†è®º</li>
<li><a href="#åˆ†å¸ƒå¼äº‹åŠ¡">åˆ†å¸ƒå¼äº‹åŠ¡</a></li>
<li><a href="#åˆ†å¸ƒå¼é”">åˆ†å¸ƒå¼é”</a></li>
<li>é™æµ</li>
<li>ç†”æ–­</li>
<li>ä¸€è‡´æ€§é€‰ä¸¾ç®—æ³•</li>
<li>ä¸»ä»æ¶æ„</li>
<li>é›†ç¾¤æ¶æ„</li>
<li>å¼‚åœ°å¤šæ´»</li>
<li>è´Ÿè½½å‡è¡¡</li>
<li>åˆ†å±‚æ¶æ„</li>
<li>å¾®æœåŠ¡, æœåŠ¡æ²»ç†</li>
<li>â€¦</li>
</ul>
<h2 id="å…±è¯†"><a href="#å…±è¯†" class="headerlink" title="å…±è¯†"></a>å…±è¯†</h2><p>consensus å‡†ç¡®çš„ç¿»è¯‘æ˜¯å…±è¯†ï¼Œå³å¤šä¸ªæè®®è€…è¾¾æˆå…±è¯†çš„è¿‡ç¨‹ï¼Œä¾‹å¦‚ Paxosï¼ŒRaft å°±æ˜¯å…±è¯†ç®—æ³•ï¼Œpaxos æ˜¯ä¸€ç§å…±è¯†ç†è®ºï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿæ˜¯ä»–çš„åœºæ™¯ï¼Œä¸€è‡´æ€§æ˜¯ä»–çš„ç›®æ ‡ã€‚</p>
<p>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰çš„å«ä¹‰æ¯”å…±è¯†ï¼ˆconsensusï¼‰è¦å®½æ³›ï¼Œä¸€è‡´æ€§æŒ‡çš„æ˜¯å¤šä¸ªå‰¯æœ¬å¯¹å¤–å‘ˆç°çš„çŠ¶æ€ã€‚åŒ…æ‹¬é¡ºåºä¸€è‡´æ€§ã€çº¿æ€§ä¸€è‡´æ€§ã€æœ€ç»ˆä¸€è‡´æ€§ç­‰ã€‚è€Œå…±è¯†ç‰¹æŒ‡è¾¾æˆä¸€è‡´çš„è¿‡ç¨‹ï¼Œä½†æ³¨æ„ï¼Œå…±è¯†å¹¶ä¸æ„å‘³ç€å®ç°äº†ä¸€è‡´æ€§ï¼Œä¸€äº›æƒ…å†µä¸‹ä»–æ˜¯åšä¸åˆ°çš„ã€‚</p>
<h2 id="ä¸€è‡´æ€§çš„ç±»åˆ«"><a href="#ä¸€è‡´æ€§çš„ç±»åˆ«" class="headerlink" title="ä¸€è‡´æ€§çš„ç±»åˆ«"></a>ä¸€è‡´æ€§çš„ç±»åˆ«</h2><p>æåˆ°åˆ†å¸ƒå¼æ¶æ„å°±ä¸€å®šç»•ä¸å¼€ â€œä¸€è‡´æ€§â€ é—®é¢˜ï¼Œè€Œ â€œä¸€è‡´æ€§â€ å…¶å®åˆåŒ…å«äº†<strong>æ•°æ®ä¸€è‡´æ€§</strong>å’Œ<strong>äº‹åŠ¡ä¸€è‡´æ€§</strong>ä¸¤ç§æƒ…å†µï¼Œæœ¬èŠ‚ä¸»è¦è®¨è®º<strong>æ•°æ®ä¸€è‡´æ€§</strong>ï¼ˆäº‹åŠ¡ä¸€è‡´æ€§æŒ‡ ACIDï¼‰ã€‚<strong>å¤åˆ¶</strong>æ˜¯å¯¼è‡´å‡ºç°<strong>æ•°æ®ä¸€è‡´æ€§</strong>é—®é¢˜çš„å”¯ä¸€åŸå› ã€‚</p>
<p>å…³äºå¼ºå’Œå¼±çš„å®šä¹‰ï¼Œå¯ä»¥å‚è€ƒå‰‘æ¡¥å¤§å­¦çš„ <a href="https://www.cl.cam.ac.uk/teaching/0910/ConcDistS/11a-cons-tx.pdf" target="_blank" rel="noopener">slide</a>.</p>
<ul>
<li>Strong consistency â€“ ensures that only consistent state can be seen: <ul>
<li>All replicas return the same value when queried for the attribute of an object * All replicas return the same value when queried for the attribute of an object. This may be achieved at a cost â€“ high latency.</li>
</ul>
</li>
<li>Weak consistency â€“ for when the â€œfast accessâ€ requirement dominates:  <ul>
<li>update some replica, e.g. the closest or some designated replica</li>
<li>the updated replica sends up date messages to all other replicas.</li>
<li>different replicas can return different values for the queried attribute of the object the value should be returned, or â€œnot knownâ€, with a timestamp</li>
<li>in the long term all updates must propagate to all replicas â€¦â€¦.</li>
</ul>
</li>
</ul>
<p>ä¸€è‡´æ€§çš„è¯¦ç»†åˆ†ç±»:  </p>
<ul>
<li>å¼ºä¸€è‡´æ€§<br>  å¼ºä¸€è‡´æ€§é›†ç¾¤ä¸­ï¼Œå¯¹ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹å‘èµ·è¯·æ±‚éƒ½ä¼šå¾—åˆ°ç›¸åŒçš„å›å¤ï¼Œä½†å¯èƒ½ä¼šäº§ç”Ÿç›¸å¯¹é«˜çš„å»¶è¿Ÿ<ul>
<li><a href="#çº¿æ€§ä¸€è‡´æ€§">çº¿æ€§ä¸€è‡´æ€§</a>Linearizability consistency, ä¹Ÿå«åŸå­ä¸€è‡´æ€§, <strong>å¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬è¯´å¼ºä¸€è‡´æ€§å…¶å®æ˜¯æŒ‡çº¿æ€§ä¸€è‡´æ€§</strong>, ä¸¤ä¸ªè¦æ±‚ï¼š<ul>
<li>ä»»ä½•ä¸€æ¬¡è¯»éƒ½èƒ½è¯»åˆ°æŸä¸ªæ•°æ®çš„æœ€è¿‘ä¸€æ¬¡å†™çš„æ•°æ®ã€‚</li>
<li>ç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹ï¼Œçœ‹åˆ°çš„æ“ä½œé¡ºåºï¼Œéƒ½å’Œå…¨å±€æ—¶é’Ÿä¸‹çš„é¡ºåºä¸€è‡´ã€‚</li>
</ul>
</li>
<li><a href="#é¡ºåºä¸€è‡´æ€§">é¡ºåºä¸€è‡´æ€§</a>Sequential consistency, æ¯”çº¿æ€§ä¸€è‡´æ€§ç¨å¼±, ä½†ä¹Ÿç®—æ˜¯å¼ºä¸€è‡´æ€§çš„ä¸€ç§, ä¸¤ä¸ªè¦æ±‚ï¼š<ul>
<li>ä»»ä½•ä¸€æ¬¡è¯»éƒ½èƒ½è¯»åˆ°æŸä¸ªæ•°æ®çš„æœ€è¿‘ä¸€æ¬¡å†™çš„æ•°æ®ã€‚</li>
<li>ç³»ç»Ÿçš„æ‰€æœ‰è¿›ç¨‹çš„é¡ºåºä¸€è‡´ï¼Œè€Œä¸”æ˜¯åˆç†çš„ã€‚å³ä¸éœ€è¦å’Œå…¨å±€æ—¶é’Ÿä¸‹çš„é¡ºåºä¸€è‡´ï¼Œé”™çš„è¯ä¸€èµ·é”™ï¼Œå¯¹çš„è¯ä¸€èµ·å¯¹ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>å¼±ä¸€è‡´æ€§<br>  å¼±ä¸€è‡´æ€§å…·æœ‰æ›´ä½çš„å“åº”å»¶è¿Ÿï¼Œä½†å¯èƒ½ä¼šå›å¤è¿‡æœŸçš„æ•°æ®, å¯¼è‡´å„ä¸ªèŠ‚ç‚¹æ‹¿åˆ°çš„æ•°æ®ä¸ä¸€è‡´ã€‚<ul>
<li>æœ€ç»ˆä¸€è‡´æ€§(Eventual consistency)<ul>
<li>å«ä¹‰: ç³»ç»Ÿä¼šä¿è¯åœ¨ä¸€å®šæ—¶é—´å†…ï¼Œèƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªæ•°æ®ä¸€è‡´çš„çŠ¶æ€ã€‚è¿™é‡Œä¹‹æ‰€ä»¥å°†æœ€ç»ˆä¸€è‡´æ€§å•ç‹¬æå‡ºæ¥ï¼Œæ˜¯å› ä¸ºå®ƒæ˜¯å¼±ä¸€è‡´æ€§ä¸­éå¸¸æ¨å´‡çš„ä¸€ç§ä¸€è‡´æ€§æ¨¡å‹ï¼Œä¹Ÿæ˜¯ä¸šç•Œåœ¨å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ•°æ®ä¸€è‡´æ€§ä¸Šæ¯”è¾ƒæ¨å´‡çš„æ¨¡å‹ã€‚</li>
</ul>
</li>
<li>å› æœä¸€è‡´æ€§(Causal consistency)<ul>
<li>å«ä¹‰: å¦‚æœä¸€ç³»åˆ—å†™å…¥æŒ‰æŸä¸ªé€»è¾‘é¡ºåºå‘ç”Ÿï¼Œé‚£ä¹ˆä»»ä½•äººè¯»å–è¿™äº›å†™å…¥æ—¶ï¼Œä¼šçœ‹è§å®ƒä»¬ä»¥æ­£ç¡®çš„é€»è¾‘é¡ºåºå‡ºç°ã€‚</li>
<li>å®ç°: ä¸€ç§æ–¹æ¡ˆæ˜¯åº”ç”¨ä¿è¯å°†é—®é¢˜å’Œå¯¹åº”çš„å›ç­”å†™å…¥ç›¸åŒçš„åˆ†åŒº</li>
</ul>
</li>
<li>è¯»å†™ä¸€è‡´æ€§:<ul>
<li>å«ä¹‰: å®ƒå¯ä»¥ä¿è¯ï¼Œå¦‚æœç”¨æˆ·åˆ·æ–°é¡µé¢ï¼Œä»–ä»¬æ€»ä¼šçœ‹åˆ°è‡ªå·±åˆšæäº¤çš„ä»»ä½•æ›´æ–°ã€‚å®ƒä¸ä¼šå¯¹å…¶ä»–ç”¨æˆ·çš„å†™å…¥åšå‡ºæ‰¿è¯ºï¼Œå…¶ä»–ç”¨æˆ·çš„æ›´æ–°å¯èƒ½ç¨ç­‰æ‰ä¼šçœ‹åˆ°ï¼Œä½†å®ƒä¿è¯ç”¨æˆ·è‡ªå·±æäº¤çš„æ•°æ®èƒ½é©¬ä¸Šè¢«è‡ªå·±çœ‹åˆ°ã€‚</li>
</ul>
</li>
<li>å•è°ƒè¯»: <ul>
<li>å«ä¹‰: å¦‚æœå…ˆå‰è¯»å–åˆ°è¾ƒæ–°çš„æ•°æ®ï¼Œåç»­è¯»å–ä¸ä¼šå¾—åˆ°æ›´æ—§çš„æ•°æ®.</li>
<li>å®ç°: å®ç°å•è°ƒè¯»å–çš„ä¸€ç§æ–¹å¼æ˜¯<strong>ç¡®ä¿æ¯ä¸ªç”¨æˆ·æ€»æ˜¯ä»åŒä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œè¯»å–</strong>ï¼ˆä¸åŒçš„ç”¨æˆ·å¯ä»¥ä»ä¸åŒçš„èŠ‚ç‚¹è¯»å–ï¼‰ï¼Œæ¯”å¦‚å¯ä»¥åŸºäºç”¨æˆ· ID çš„å“ˆå¸Œå€¼æ¥é€‰æ‹©èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯éšæœºé€‰æ‹©èŠ‚ç‚¹ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="çº¿æ€§ä¸€è‡´æ€§"><a href="#çº¿æ€§ä¸€è‡´æ€§" class="headerlink" title="çº¿æ€§ä¸€è‡´æ€§"></a>çº¿æ€§ä¸€è‡´æ€§</h3><p><a href="#etcd">etcd</a> è¯»å†™éƒ½åšäº†çº¿æ€§ä¸€è‡´ï¼Œå³ etcd æ˜¯æ ‡å‡†çš„å¼ºä¸€è‡´æ€§ä¿è¯ã€‚</p>
<p>çº¿æ€§ä¸€è‡´æ€§åˆè¢«ç§°ä¸ºå¼ºä¸€è‡´æ€§ã€ä¸¥æ ¼ä¸€è‡´æ€§ã€åŸå­ä¸€è‡´æ€§ã€‚æ˜¯ç¨‹åºèƒ½å®ç°çš„æœ€é«˜çš„ä¸€è‡´æ€§æ¨¡å‹ï¼Œä¹Ÿæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿç”¨æˆ·æœ€æœŸæœ›çš„ä¸€è‡´æ€§ã€‚CAP ä¸­çš„ C ä¸€èˆ¬å°±æŒ‡å®ƒ<br>é¡ºåºä¸€è‡´æ€§ä¸­è¿›ç¨‹åªå…³å¿ƒå¤§å®¶è®¤åŒçš„é¡ºåºä¸€æ ·å°±è¡Œï¼Œä¸éœ€è¦ä¸å…¨å±€æ—¶é’Ÿä¸€è‡´ï¼Œçº¿æ€§å°±æ›´ä¸¥æ ¼ï¼Œä»è¿™ç§ååºï¼ˆpartial orderï¼‰è¦è¾¾åˆ°å…¨åºï¼ˆtotal orderï¼‰</p>
<p>è¦æ±‚æ˜¯ï¼š  </p>
<ul>
<li>ä»»ä½•ä¸€æ¬¡è¯»éƒ½èƒ½è¯»åˆ°æŸä¸ªæ•°æ®çš„æœ€è¿‘ä¸€æ¬¡å†™çš„æ•°æ®ã€‚</li>
<li>ç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹ï¼Œçœ‹åˆ°çš„æ“ä½œé¡ºåºï¼Œéƒ½ä¸å…¨å±€æ—¶é’Ÿä¸‹çš„é¡ºåºä¸€è‡´ã€‚</li>
</ul>
<h3 id="é¡ºåºä¸€è‡´æ€§"><a href="#é¡ºåºä¸€è‡´æ€§" class="headerlink" title="é¡ºåºä¸€è‡´æ€§"></a>é¡ºåºä¸€è‡´æ€§</h3><p>ä¸¤ä¸ªè¦æ±‚ï¼š  </p>
<ul>
<li>ä»»ä½•ä¸€æ¬¡è¯»éƒ½èƒ½è¯»åˆ°æŸä¸ªæ•°æ®çš„æœ€è¿‘ä¸€æ¬¡å†™çš„æ•°æ®ã€‚</li>
<li>ç³»ç»Ÿçš„æ‰€æœ‰è¿›ç¨‹çš„é¡ºåºä¸€è‡´ï¼Œè€Œä¸”æ˜¯åˆç†çš„ã€‚å³ä¸éœ€è¦å’Œå…¨å±€æ—¶é’Ÿä¸‹çš„é¡ºåºä¸€è‡´ï¼Œé”™çš„è¯ä¸€èµ·é”™ï¼Œå¯¹çš„è¯ä¸€èµ·å¯¹ã€‚</li>
</ul>
<h4 id="ä¸¾ä¾‹è¯´æ˜1"><a href="#ä¸¾ä¾‹è¯´æ˜1" class="headerlink" title="ä¸¾ä¾‹è¯´æ˜1"></a>ä¸¾ä¾‹è¯´æ˜1</h4><p>ä¸‹é¢çš„å›¾æ»¡è¶³äº†é¡ºåºä¸€è‡´ï¼Œä½†ä¸æ»¡è¶³çº¿æ€§ä¸€è‡´ã€‚<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/consistency/consistency_1.jpg" alt>  </p>
<ul>
<li>x å’Œ y çš„åˆå§‹å€¼ä¸º 0</li>
<li>Write(x,4) ä»£è¡¨å†™å…¥ x=4ï¼ŒRead(y,2) ä¸ºè¯»å– y =2</li>
</ul>
<p>ä»å›¾ä¸Šçœ‹ï¼Œè¿›ç¨‹ P1ï¼ŒP2 çš„ä¸€è‡´æ€§å¹¶æ²¡æœ‰å†²çªã€‚å› ä¸ºä»è¿™ä¸¤ä¸ªè¿›ç¨‹çš„è§’åº¦æ¥çœ‹ï¼Œé¡ºåºåº”è¯¥æ˜¯è¿™æ ·çš„ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Write(y,2), Read(x,0), Write(x,4), Read(y,2)</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªé¡ºåºå¯¹äºä¸¤ä¸ªè¿›ç¨‹å†…éƒ¨çš„è¯»å†™é¡ºåºéƒ½æ˜¯åˆç†çš„ï¼Œåªæ˜¯è¿™ä¸ªé¡ºåºä¸å…¨å±€æ—¶é’Ÿä¸‹çœ‹åˆ°çš„é¡ºåºå¹¶ä¸ä¸€æ ·ã€‚åœ¨å…¨å±€æ—¶é’Ÿçš„è§‚ç‚¹æ¥çœ‹ï¼ŒP2 è¿›ç¨‹å¯¹å˜é‡ X çš„è¯»æ“ä½œåœ¨ P1 è¿›ç¨‹å¯¹å˜é‡ X çš„å†™æ“ä½œä¹‹åï¼Œç„¶è€Œ P2 è¯»å‡ºæ¥çš„å´æ˜¯æ—§çš„æ•°æ® 0</p>
<h4 id="ä¸¾ä¾‹è¯´æ˜2"><a href="#ä¸¾ä¾‹è¯´æ˜2" class="headerlink" title="ä¸¾ä¾‹è¯´æ˜2"></a>ä¸¾ä¾‹è¯´æ˜2</h4><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸ªåˆ†å¸ƒå¼ KV ç³»ç»Ÿï¼Œä»¥ä¸‹æ˜¯å››ä¸ªè¿›ç¨‹ å¯¹å…¶çš„æ“ä½œé¡ºåºå’Œç»“æœ:<br><code>--</code> è¡¨ç¤ºæŒç»­çš„æ—¶é—´ï¼Œå› ä¸ºä¸€æ¬¡å†™å…¥æˆ–è€…è¯»å–ï¼Œå®¢æˆ·ç«¯ä»å‘èµ·åˆ°å“åº”æ˜¯æœ‰æ—¶é—´çš„ï¼Œå‘èµ·æ—©çš„å®¢æˆ·ç«¯ï¼Œä¸ä¸€å®šæ‹¿åˆ°æ•°æ®å°±æ—©ï¼Œæœ‰å¯èƒ½å› ä¸ºç½‘ç»œå»¶è¿Ÿåè€Œä¼šæ›´æ™šã€‚<br>æƒ…å†µ 1ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A: --W(x,1)----------------------</span><br><span class="line">B:  --W(x,2)----------------------</span><br><span class="line">C:                      -R(x,1)-   --R(x,2)-</span><br><span class="line">D:                 -R(x,1)-      --R(x,2)--</span><br></pre></td></tr></table></figure></p>
<p>æƒ…å†µ 2ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A: --W(x,1)----------------------</span><br><span class="line">B:  --W(x,2)----------------------</span><br><span class="line">C:                      -R(x,2)-   --R(x,1)-</span><br><span class="line">D:                 -R(x,2)-      --R(x,1)--</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢æƒ…å†µ 1 å’Œ 2 éƒ½æ˜¯æ»¡è¶³é¡ºåºä¸€è‡´æ€§çš„ï¼ŒC å’Œ D æ‹¿çš„é¡ºåºéƒ½æ˜¯ 1-2ï¼Œæˆ– 2-1ï¼Œåªè¦ CD çš„é¡ºåºä¸€è‡´ï¼Œå°±æ˜¯æ»¡è¶³é¡ºåºä¸€è‡´æ€§ã€‚åªæ˜¯ä»å…¨å±€çœ‹æ¥ï¼Œæƒ…å†µ 1 æ›´çœŸå®ï¼Œæƒ…å†µ 2 å°±æ˜¾å¾—â€ é”™è¯¯ â€œäº†ï¼Œå› ä¸ºæƒ…å†µ 2 æ˜¯è¿™æ ·çš„é¡ºåº<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">B W(x,2) -&gt; A W(x,1) -&gt; C R(x,2) -&gt; D R(x,2) -&gt; C R(x,1) -&gt; D R(x,1)</span><br></pre></td></tr></table></figure></p>
<p><strong>ä¸è¿‡ä¸€è‡´æ€§ä¸ä¿è¯æ­£ç¡®æ€§ï¼Œæ‰€ä»¥è¿™ä»ç„¶æ˜¯ä¸€ä¸ªé¡ºåºä¸€è‡´</strong>ã€‚å†åŠ ä¸€ç§æƒ…å†µ 3ï¼š<br>æƒ…å†µ 3ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A: --W(x,1)----------------------</span><br><span class="line">B:  --W(x,2)----------------------</span><br><span class="line">C:                      -R(x,2)-   --R(x,1)-</span><br><span class="line">D:                 -R(x,1)-      --R(x,2)--</span><br></pre></td></tr></table></figure></p>
<p>æƒ…å†µ 3 å°±ä¸å±äºé¡ºåºä¸€è‡´äº†ï¼Œå› ä¸º C å’Œ D ä¸¤ä¸ªè¿›ç¨‹çš„è¯»å–é¡ºåºä¸åŒäº†ã€‚</p>
<h4 id="ä¸¾ä¾‹è¯´æ˜3"><a href="#ä¸¾ä¾‹è¯´æ˜3" class="headerlink" title="ä¸¾ä¾‹è¯´æ˜3"></a>ä¸¾ä¾‹è¯´æ˜3</h4><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/consistency/consistency_3.jpg" alt><br>è¿™ä¹Ÿæ˜¯é¡ºåºä¸€è‡´çš„, ä½†æ˜¯å¯èƒ½ä¸æ»¡è¶³äº§å“ç»ç†è¦æ±‚.  </p>
<p>ä»æ—¶é—´è½´ä¸Šå¯ä»¥çœ‹åˆ°ï¼ŒB0 å‘ç”Ÿåœ¨ A0 ä¹‹å‰ï¼Œè¯»å–åˆ°çš„ x å€¼ä¸º 0ã€‚B2 å‘ç”Ÿåœ¨ A0 ä¹‹åï¼Œè¯»å–åˆ°çš„ x å€¼ä¸º 1ã€‚è€Œè¯»æ“ä½œ B1ï¼ŒC0ï¼ŒC1 ä¸å†™æ“ä½œ A0 åœ¨æ—¶é—´è½´ä¸Šæœ‰é‡å ï¼Œå› æ­¤ä»–ä»¬å¯èƒ½è¯»å–åˆ°æ—§çš„å€¼ 0ï¼Œä¹Ÿå¯èƒ½è¯»å–åˆ°æ–°çš„å€¼ 1ã€‚æ³¨æ„ï¼ŒC1 å‘ç”Ÿåœ¨ B1 ä¹‹åï¼ˆäºŒè€…åœ¨æ—¶é—´è½´ä¸Šæ²¡æœ‰é‡å ï¼‰ï¼Œä½†æ˜¯ B1 çœ‹åˆ° x çš„æ–°å€¼ï¼ŒC1 åè€Œçœ‹åˆ°çš„æ˜¯æ—§å€¼ã€‚å³å¯¹ç”¨æˆ·æ¥è¯´ï¼Œx çš„å€¼å‘ç”Ÿäº†å›è·³ã€‚</p>
<h2 id="CAPç†è®º"><a href="#CAPç†è®º" class="headerlink" title="CAPç†è®º"></a>CAPç†è®º</h2><p>ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯èƒ½åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªåŸºæœ¬éœ€æ±‚ï¼Œæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³å…¶ä¸­ä¸¤é¡¹:</p>
<ul>
<li><p>ä¸€è‡´æ€§ï¼ˆCï¼šConsistency, <strong>CAPçš„CæŒ‡çš„æ˜¯å¼ºä¸€è‡´æ€§</strong>ï¼‰<br>  åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œä¸€è‡´æ€§æ˜¯æŒ‡æ•°æ®åœ¨å¤šä¸ªå‰¯æœ¬ä¹‹é—´èƒ½å¦ä¿æŒä¸€è‡´çš„ç‰¹æ€§ã€‚åœ¨ä¸€è‡´æ€§çš„éœ€æ±‚ä¸‹ï¼Œå½“ä¸€ä¸ªç³»ç»Ÿåœ¨æ•°æ®ä¸€è‡´çš„çŠ¶æ€ä¸‹æ‰§è¡Œæ›´æ–°æ“ä½œåï¼Œåº”è¯¥ä¿è¯ç³»ç»Ÿçš„æ•°æ®ä»ç„¶å¤„äºä¸€è‡´çš„çŠ¶æ€ã€‚</p>
<p>  å¯¹äºä¸€ä¸ªå°†æ•°æ®å‰¯æœ¬åˆ†å¸ƒåœ¨ä¸åŒåˆ†å¸ƒå¼èŠ‚ç‚¹ä¸Šçš„ç³»ç»Ÿæ¥è¯´ï¼Œå¦‚æœå¯¹ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®è¿›è¡Œäº†æ›´æ–°æ“ä½œå¹¶ä¸”æ›´æ–°æˆåŠŸåï¼Œå´æ²¡æœ‰ä½¿å¾—ç¬¬äºŒä¸ªèŠ‚ç‚¹ä¸Šçš„æ•°æ®å¾—åˆ°ç›¸åº”çš„æ›´æ–°ï¼Œäºæ˜¯åœ¨å¯¹ç¬¬äºŒä¸ªèŠ‚ç‚¹çš„æ•°æ®è¿›è¡Œè¯»å–æ“ä½œæ—¶ï¼Œè·å–çš„ä¾ç„¶æ˜¯è€æ•°æ®ï¼ˆæˆ–ç§°ä¸ºè„æ•°æ®ï¼‰ï¼Œè¿™å°±æ˜¯å…¸å‹çš„åˆ†å¸ƒå¼æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚æœèƒ½å¤Ÿåšåˆ°é’ˆå¯¹ä¸€ä¸ªæ•°æ®é¡¹çš„æ›´æ–°æ“ä½œæ‰§è¡ŒæˆåŠŸåï¼Œæ‰€æœ‰çš„ç”¨æˆ·éƒ½å¯ä»¥è¯»å–åˆ°å…¶æœ€æ–°çš„å€¼ï¼Œé‚£ä¹ˆè¿™æ ·çš„ç³»ç»Ÿå°±è¢«è®¤ä¸ºå…·æœ‰å¼ºä¸€è‡´æ€§ã€‚</p>
</li>
<li><p>å¯ç”¨æ€§ï¼ˆAï¼šAvailabilityï¼‰<br>å¯ç”¨æ€§æ˜¯æŒ‡ç³»ç»Ÿæä¾›çš„æœåŠ¡å¿…é¡»ä¸€ç›´å¤„äºå¯ç”¨çš„çŠ¶æ€ï¼Œå¯¹äºç”¨æˆ·çš„æ¯ä¸€ä¸ªæ“ä½œè¯·æ±‚æ€»æ˜¯èƒ½å¤Ÿåœ¨æœ‰é™çš„æ—¶é—´å†…è¿”å›ç»“æœã€‚è¿™é‡Œçš„é‡ç‚¹æ˜¯ â€œæœ‰é™æ—¶é—´å†…â€ å’Œ â€œè¿”å›ç»“æœâ€ã€‚</p>
<p>â€œæœ‰é™æ—¶é—´å†…â€ æ˜¯æŒ‡ï¼Œå¯¹äºç”¨æˆ·çš„ä¸€ä¸ªæ“ä½œè¯·æ±‚ï¼Œç³»ç»Ÿå¿…é¡»èƒ½å¤Ÿåœ¨æŒ‡å®šçš„æ—¶é—´å†…è¿”å›å¯¹åº”çš„å¤„ç†ç»“æœï¼Œå¦‚æœè¶…è¿‡äº†è¿™ä¸ªæ—¶é—´èŒƒå›´ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±è¢«è®¤ä¸ºæ˜¯ä¸å¯ç”¨çš„ã€‚å¦å¤–ï¼Œâ€æœ‰é™çš„æ—¶é—´å†…â€ æ˜¯æŒ‡ç³»ç»Ÿè®¾è®¡ä¹‹åˆå°±è®¾è®¡å¥½çš„è¿è¡ŒæŒ‡æ ‡ï¼Œé€šå¸¸ä¸åŒç³»ç»Ÿä¹‹é—´æœ‰å¾ˆå¤§çš„ä¸åŒï¼Œæ— è®ºå¦‚ä½•ï¼Œå¯¹äºç”¨æˆ·è¯·æ±‚ï¼Œç³»ç»Ÿå¿…é¡»å­˜åœ¨ä¸€ä¸ªåˆç†çš„å“åº”æ—¶é—´ï¼Œå¦åˆ™ç”¨æˆ·ä¾¿ä¼šå¯¹ç³»ç»Ÿæ„Ÿåˆ°å¤±æœ›ã€‚</p>
<p>â€œè¿”å›ç»“æœâ€ æ˜¯å¯ç”¨æ€§çš„å¦ä¸€ä¸ªéå¸¸é‡è¦çš„æŒ‡æ ‡ï¼Œå®ƒè¦æ±‚ç³»ç»Ÿåœ¨å®Œæˆå¯¹ç”¨æˆ·è¯·æ±‚çš„å¤„ç†åï¼Œè¿”å›ä¸€ä¸ªæ­£å¸¸çš„å“åº”ç»“æœã€‚æ­£å¸¸çš„å“åº”ç»“æœé€šå¸¸èƒ½å¤Ÿæ˜ç¡®åœ°åæ˜ å‡ºé˜Ÿè¯·æ±‚çš„å¤„ç†ç»“æœï¼Œå³æˆåŠŸæˆ–å¤±è´¥ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè®©ç”¨æˆ·æ„Ÿåˆ°å›°æƒ‘çš„è¿”å›ç»“æœã€‚</p>
</li>
<li><p>åˆ†åŒºå®¹é”™æ€§ï¼ˆPï¼šPartition toleranceï¼‰<br>ç³»ç»Ÿåº”è¯¥èƒ½æŒç»­æä¾›æœåŠ¡ï¼Œå³ä½¿ç³»ç»Ÿå†…éƒ¨æœ‰æ¶ˆæ¯ä¸¢å¤±ï¼ˆåˆ†åŒºï¼‰ã€‚</p>
<p>ç½‘ç»œåˆ†åŒºæ˜¯æŒ‡åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸åŒçš„èŠ‚ç‚¹åˆ†å¸ƒåœ¨ä¸åŒçš„å­ç½‘ç»œï¼ˆæœºæˆ¿æˆ–å¼‚åœ°ç½‘ç»œï¼‰ä¸­ï¼Œç”±äºä¸€äº›ç‰¹æ®Šçš„åŸå› å¯¼è‡´è¿™äº›å­ç½‘ç»œå‡ºç°ç½‘ç»œä¸è¿é€šçš„çŠ¶å†µï¼Œä½†å„ä¸ªå­ç½‘ç»œçš„å†…éƒ¨ç½‘ç»œæ˜¯æ­£å¸¸çš„ï¼Œä»è€Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿçš„ç½‘ç»œç¯å¢ƒè¢«åˆ‡åˆ†æˆäº†è‹¥å¹²ä¸ªå­¤ç«‹çš„åŒºåŸŸã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»„æˆä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ¯ä¸ªèŠ‚ç‚¹çš„åŠ å…¥ä¸é€€å‡ºéƒ½å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç½‘ç»œåˆ†åŒºã€‚</p>
</li>
</ul>
<h3 id="capé€šä¿—è€Œç²¾å‡†çš„è§£é‡Š"><a href="#capé€šä¿—è€Œç²¾å‡†çš„è§£é‡Š" class="headerlink" title="capé€šä¿—è€Œç²¾å‡†çš„è§£é‡Š"></a>capé€šä¿—è€Œç²¾å‡†çš„è§£é‡Š</h3><p>ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿé‡Œé¢ï¼ŒèŠ‚ç‚¹ç»„æˆçš„ç½‘ç»œæœ¬æ¥åº”è¯¥æ˜¯è¿é€šçš„ã€‚ç„¶è€Œå¯èƒ½å› ä¸ºä¸€äº›æ•…éšœï¼Œä½¿å¾—æœ‰äº›èŠ‚ç‚¹ä¹‹é—´ä¸è¿é€šäº†ï¼Œæ•´ä¸ªç½‘ç»œå°±åˆ†æˆäº†å‡ å—åŒºåŸŸã€‚æ•°æ®å°±æ•£å¸ƒåœ¨äº†è¿™äº›ä¸è¿é€šçš„åŒºåŸŸä¸­ã€‚è¿™å°±å«åˆ†åŒºã€‚</p>
<p>å½“ä½ ä¸€ä¸ªæ•°æ®é¡¹åªåœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸­ä¿å­˜ï¼Œé‚£ä¹ˆåˆ†åŒºå‡ºç°åï¼Œå’Œè¿™ä¸ªèŠ‚ç‚¹ä¸è¿é€šçš„éƒ¨åˆ†å°±è®¿é—®ä¸åˆ°è¿™ä¸ªæ•°æ®äº†ã€‚è¿™æ—¶åˆ†åŒºå°±æ˜¯æ— æ³•å®¹å¿çš„ã€‚</p>
<p>æé«˜åˆ†åŒºå®¹å¿æ€§çš„åŠæ³•å°±æ˜¯ä¸€ä¸ªæ•°æ®é¡¹å¤åˆ¶åˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆå‡ºç°åˆ†åŒºä¹‹åï¼Œè¿™ä¸€æ•°æ®é¡¹å°±å¯èƒ½åˆ†å¸ƒåˆ°å„ä¸ªåŒºé‡Œã€‚å®¹å¿æ€§å°±æé«˜äº†ã€‚</p>
<p>ç„¶è€Œï¼Œè¦æŠŠæ•°æ®å¤åˆ¶åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œå°±ä¼šå¸¦æ¥ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œå°±æ˜¯å¤šä¸ªèŠ‚ç‚¹ä¸Šé¢çš„æ•°æ®å¯èƒ½æ˜¯ä¸ä¸€è‡´çš„ã€‚è¦ä¿è¯ä¸€è‡´ï¼Œæ¯æ¬¡å†™æ“ä½œå°±éƒ½è¦ç­‰å¾…å…¨éƒ¨èŠ‚ç‚¹å†™æˆåŠŸï¼Œè€Œè¿™ç­‰å¾…åˆä¼šå¸¦æ¥å¯ç”¨æ€§çš„é—®é¢˜ã€‚æ€»çš„æ¥è¯´å°±æ˜¯ï¼Œæ•°æ®å­˜åœ¨çš„èŠ‚ç‚¹è¶Šå¤šï¼Œåˆ†åŒºå®¹å¿æ€§è¶Šé«˜ï¼Œä½†è¦å¤åˆ¶æ›´æ–°çš„æ•°æ®å°±è¶Šå¤šï¼Œä¸€è‡´æ€§å°±è¶Šéš¾ä¿è¯ã€‚ä¸ºäº†ä¿è¯ä¸€è‡´æ€§ï¼Œæ›´æ–°æ‰€æœ‰èŠ‚ç‚¹æ•°æ®æ‰€éœ€è¦çš„æ—¶é—´å°±è¶Šé•¿ï¼Œå¯ç”¨æ€§å°±ä¼šé™ä½ã€‚</p>
<h3 id="capçš„ä¸€äº›ç»„åˆä¾‹å­"><a href="#capçš„ä¸€äº›ç»„åˆä¾‹å­" class="headerlink" title="capçš„ä¸€äº›ç»„åˆä¾‹å­"></a>capçš„ä¸€äº›ç»„åˆä¾‹å­</h3><p>æ—¢ç„¶ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ— æ³•åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€åˆ†åŒºå®¹é”™æ€§ä¸‰ä¸ªç‰¹ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦æŠ›å¼ƒä¸€ä¸ªï¼š</p>
<table>
<thead>
<tr>
<th>é€‰æ‹©</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>CA</td>
<td>æ”¾å¼ƒåˆ†åŒºå®¹é”™æ€§ï¼ŒåŠ å¼ºä¸€è‡´æ€§å’Œå¯ç”¨æ€§ï¼Œå…¶å®å°±æ˜¯ä¼ ç»Ÿçš„å•æœºæ•°æ®åº“çš„é€‰æ‹©</td>
</tr>
<tr>
<td>AP</td>
<td>æ”¾å¼ƒä¸€è‡´æ€§ï¼ˆ<strong>è¿™é‡Œè¯´çš„ä¸€è‡´æ€§æ˜¯å¼ºä¸€è‡´æ€§</strong>ï¼‰ï¼Œè¿½æ±‚åˆ†åŒºå®¹é”™æ€§å’Œå¯ç”¨æ€§ï¼Œè¿™æ˜¯å¾ˆå¤šåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡æ—¶çš„é€‰æ‹©ï¼Œä¾‹å¦‚å¾ˆå¤š NoSQL ç³»ç»Ÿå°±æ˜¯å¦‚æ­¤</td>
</tr>
<tr>
<td>CP</td>
<td>æ”¾å¼ƒå¯ç”¨æ€§ï¼Œè¿½æ±‚ä¸€è‡´æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼ŒåŸºæœ¬ä¸ä¼šé€‰æ‹©ï¼Œç½‘ç»œé—®é¢˜ä¼šç›´æ¥è®©æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨, ä¾‹å¦‚ zookeeperå’Œ etcdéƒ½æ˜¯cpçš„</td>
</tr>
</tbody>
</table>
<p>éœ€è¦æ˜ç¡®çš„ä¸€ç‚¹æ˜¯ï¼Œ<strong>å¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿè€Œè¨€ï¼Œåˆ†åŒºå®¹é”™æ€§æ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„è¦æ±‚</strong>ã€‚å› ä¸ºæ—¢ç„¶æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œé‚£ä¹ˆåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ç»„ä»¶å¿…ç„¶éœ€è¦è¢«éƒ¨ç½²åˆ°ä¸åŒçš„èŠ‚ç‚¹ï¼Œå¦åˆ™ä¹Ÿå°±æ— æ‰€è°“åˆ†å¸ƒå¼ç³»ç»Ÿäº†ï¼Œå› æ­¤å¿…ç„¶å‡ºç°å­ç½‘ç»œã€‚è€Œå¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿè€Œè¨€ï¼Œç½‘ç»œé—®é¢˜åˆæ˜¯ä¸€ä¸ªå¿…å®šä¼šå‡ºç°çš„å¼‚å¸¸æƒ…å†µï¼Œå› æ­¤åˆ†åŒºå®¹é”™æ€§ä¹Ÿå°±æˆä¸ºäº†ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå¿…ç„¶éœ€è¦é¢å¯¹å’Œè§£å†³çš„é—®é¢˜ã€‚<strong>å› æ­¤ç³»ç»Ÿæ¶æ„å¸ˆå¾€å¾€éœ€è¦æŠŠç²¾åŠ›èŠ±åœ¨å¦‚ä½•æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹åœ¨ Cï¼ˆä¸€è‡´æ€§ï¼‰å’Œ Aï¼ˆå¯ç”¨æ€§ï¼‰ä¹‹é—´å¯»æ±‚å¹³è¡¡ã€‚</strong></p>
<h2 id="BASE-ç†è®º"><a href="#BASE-ç†è®º" class="headerlink" title="BASE ç†è®º"></a>BASE ç†è®º</h2><p>BASE æ˜¯  </p>
<ul>
<li>Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰</li>
<li>Soft stateï¼ˆè½¯çŠ¶æ€, å³ä¸­é—´çŠ¶æ€)</li>
<li>Eventually consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰</li>
</ul>
<p>ä¸‰ä¸ªçŸ­è¯­çš„ç¼©å†™ã€‚BASE ç†è®ºæ˜¯å¯¹ CAP ä¸­ä¸€è‡´æ€§å’Œå¯ç”¨æ€§æƒè¡¡çš„ç»“æœï¼Œå…¶æ¥æºäºå¯¹å¤§è§„æ¨¡äº’è”ç½‘ç³»ç»Ÿåˆ†å¸ƒå¼å®è·µçš„æ€»ç»“ï¼Œ æ˜¯åŸºäº CAP å®šç†é€æ­¥æ¼”åŒ–è€Œæ¥çš„ã€‚BASE ç†è®ºçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼Œä½†æ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹ç‚¹ï¼Œé‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ BASE ä¸­çš„ä¸‰è¦ç´ ï¼š  </p>
<ul>
<li>åŸºæœ¬å¯ç”¨<br>  åŸºæœ¬å¯ç”¨æ˜¯æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°ä¸å¯é¢„çŸ¥æ•…éšœçš„æ—¶å€™ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ã€‚æ³¨æ„ï¼Œè¿™ç»ä¸ç­‰ä»·äºç³»ç»Ÿä¸å¯ç”¨ã€‚æ¯”å¦‚ï¼š<ul>
<li>å“åº”æ—¶é—´ä¸Šçš„æŸå¤±ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåœ¨çº¿æœç´¢å¼•æ“éœ€è¦åœ¨ 0.5 ç§’ä¹‹å†…è¿”å›ç»™ç”¨æˆ·ç›¸åº”çš„æŸ¥è¯¢ç»“æœï¼Œä½†ç”±äºå‡ºç°æ•…éšœï¼ŒæŸ¥è¯¢ç»“æœçš„å“åº”æ—¶é—´å¢åŠ äº† 1~2 ç§’</li>
<li>ç³»ç»ŸåŠŸèƒ½ä¸Šçš„æŸå¤±ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œåœ¨ä¸€ä¸ªç”µå­å•†åŠ¡ç½‘ç«™ä¸Šè¿›è¡Œè´­ç‰©çš„æ—¶å€™ï¼Œæ¶ˆè´¹è€…å‡ ä¹èƒ½å¤Ÿé¡ºåˆ©å®Œæˆæ¯ä¸€ç¬”è®¢å•ï¼Œä½†æ˜¯åœ¨ä¸€äº›èŠ‚æ—¥å¤§ä¿ƒè´­ç‰©é«˜å³°çš„æ—¶å€™ï¼Œç”±äºæ¶ˆè´¹è€…çš„è´­ç‰©è¡Œä¸ºæ¿€å¢ï¼Œä¸ºäº†ä¿æŠ¤è´­ç‰©ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œéƒ¨åˆ†æ¶ˆè´¹è€…å¯èƒ½ä¼šè¢«å¼•å¯¼åˆ°ä¸€ä¸ªé™çº§é¡µé¢ã€‚</li>
</ul>
</li>
<li>è½¯çŠ¶æ€<br>  è½¯çŠ¶æ€æŒ‡å…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œå¹¶è®¤ä¸ºè¯¥ä¸­é—´çŠ¶æ€çš„å­˜åœ¨ä¸ä¼šå½±å“ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§ï¼Œå³å…è®¸ç³»ç»Ÿåœ¨ä¸åŒèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥çš„è¿‡ç¨‹å­˜åœ¨å»¶æ—¶ã€‚</li>
<li>æœ€ç»ˆä¸€è‡´æ€§<br>  æœ€ç»ˆä¸€è‡´æ€§å¼ºè°ƒçš„æ˜¯æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥ä¹‹åï¼Œæœ€ç»ˆéƒ½èƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚å› æ­¤ï¼Œæœ€ç»ˆä¸€è‡´æ€§çš„æœ¬è´¨æ˜¯éœ€è¦ç³»ç»Ÿä¿è¯æœ€ç»ˆæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ï¼Œè€Œä¸éœ€è¦å®æ—¶ä¿è¯ç³»ç»Ÿæ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚</li>
</ul>
<p>æ€»çš„æ¥è¯´ï¼ŒBASE ç†è®ºé¢å‘çš„æ˜¯å¤§å‹é«˜å¯ç”¨å¯æ‰©å±•çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå’Œä¼ ç»Ÿçš„äº‹ç‰© ACID ç‰¹æ€§æ˜¯ç›¸åçš„ï¼Œå®ƒå®Œå…¨ä¸åŒäº ACID çš„å¼ºä¸€è‡´æ€§æ¨¡å‹ï¼Œè€Œæ˜¯é€šè¿‡ç‰ºç‰²å¼ºä¸€è‡´æ€§æ¥è·å¾—å¯ç”¨æ€§ï¼Œå¹¶å…è®¸æ•°æ®åœ¨ä¸€æ®µæ—¶é—´å†…æ˜¯ä¸ä¸€è‡´çš„ï¼Œä½†æœ€ç»ˆè¾¾åˆ°ä¸€è‡´çŠ¶æ€ã€‚ä½†åŒæ—¶ï¼Œåœ¨å®é™…çš„åˆ†å¸ƒå¼åœºæ™¯ä¸­ï¼Œä¸åŒä¸šåŠ¡å•å…ƒå’Œç»„ä»¶å¯¹æ•°æ®ä¸€è‡´æ€§çš„è¦æ±‚æ˜¯ä¸åŒçš„ï¼Œå› æ­¤åœ¨å…·ä½“çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„è®¾è®¡è¿‡ç¨‹ä¸­ï¼ŒACID ç‰¹æ€§å’Œ BASE ç†è®ºå¾€å¾€åˆä¼šç»“åˆåœ¨ä¸€èµ·ã€‚</p>
<h2 id="æœåŠ¡æ²»ç†"><a href="#æœåŠ¡æ²»ç†" class="headerlink" title="æœåŠ¡æ²»ç†"></a>æœåŠ¡æ²»ç†</h2><p>æœåŠ¡æ²»ç†ä¸»è¦åŒ…æ‹¬:  </p>
<ul>
<li>æœåŠ¡æ³¨å†Œå‘ç°</li>
<li>é™æµ</li>
<li>ç›‘æ§</li>
<li>ç½‘å…³</li>
<li>è´Ÿè½½å‡è¡¡</li>
<li>æ—¥å¿—é‡‡é›†</li>
<li>é“¾è·¯è¿½è¸ª</li>
</ul>
<p>è¯¦ç»†å¦‚ä¸‹å›¾:<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/soa_governance_1.jpg" alt></p>
<h2 id="åˆ†å¸ƒå¼é”"><a href="#åˆ†å¸ƒå¼é”" class="headerlink" title="åˆ†å¸ƒå¼é”"></a>åˆ†å¸ƒå¼é”</h2><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/distributed_lock.jpg" alt></p>
<p>ä¸»è¦æœ‰:  </p>
<ul>
<li><a href="#åŸºäºetcdçš„åˆ†å¸ƒå¼é”">etcd/zookeeper(ä¸¥è°¨)</a></li>
<li><a href="#åŸºäºredisçš„åˆ†å¸ƒå¼é”">redis(é­åˆ°è´¨ç–‘, æé™æƒ…å†µæœ‰å¯èƒ½æœ‰é—®é¢˜, ä½†å› ä¸ºæ€§èƒ½è¾ƒé«˜ä¸”æé™æƒ…å†µä¸å®¹æ˜“å‘ç”Ÿ, ä¹Ÿæœ‰äººç”¨)</a></li>
</ul>
<h3 id="åˆ†å¸ƒå¼é”è¿‡æœŸæ—¶é—´åˆ°äº†ä½†ä¸šåŠ¡æ²¡æ‰§è¡Œå®Œæ€ä¹ˆåŠ"><a href="#åˆ†å¸ƒå¼é”è¿‡æœŸæ—¶é—´åˆ°äº†ä½†ä¸šåŠ¡æ²¡æ‰§è¡Œå®Œæ€ä¹ˆåŠ" class="headerlink" title="åˆ†å¸ƒå¼é”è¿‡æœŸæ—¶é—´åˆ°äº†ä½†ä¸šåŠ¡æ²¡æ‰§è¡Œå®Œæ€ä¹ˆåŠ"></a>åˆ†å¸ƒå¼é”è¿‡æœŸæ—¶é—´åˆ°äº†ä½†ä¸šåŠ¡æ²¡æ‰§è¡Œå®Œæ€ä¹ˆåŠ</h3><p>æ³¨å†Œä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”ä¸€å®šæ—¶é—´å°±å»å»¶é•¿é”è¶…æ—¶æ—¶é—´</p>
<h3 id="åŸºäºetcdçš„åˆ†å¸ƒå¼é”"><a href="#åŸºäºetcdçš„åˆ†å¸ƒå¼é”" class="headerlink" title="åŸºäºetcdçš„åˆ†å¸ƒå¼é”"></a>åŸºäºetcdçš„åˆ†å¸ƒå¼é”</h3><p>å› ä¸º etcd ä½¿ç”¨ Raft ç®—æ³•ä¿æŒäº†æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼ŒæŸæ¬¡æ“ä½œå­˜å‚¨åˆ°é›†ç¾¤ä¸­çš„å€¼å¿…ç„¶æ˜¯å…¨å±€ä¸€è‡´çš„ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å®ç°åˆ†å¸ƒå¼é”ã€‚é”æœåŠ¡æœ‰ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼Œä¸€æ˜¯ä¿æŒç‹¬å ï¼ŒäºŒæ˜¯æ§åˆ¶æ—¶åºã€‚  </p>
<p>ä¿æŒç‹¬å å³æ‰€æœ‰è·å–é”çš„ç”¨æˆ·æœ€ç»ˆåªæœ‰ä¸€ä¸ªå¯ä»¥å¾—åˆ°ã€‚etcd ä¸ºæ­¤æä¾›äº†ä¸€å¥—å®ç°åˆ†å¸ƒå¼é”åŸå­æ“ä½œ CASï¼ˆCompareAndSwapï¼‰çš„ APIã€‚é€šè¿‡è®¾ç½®prevExistå€¼ï¼Œå¯ä»¥ä¿è¯åœ¨å¤šä¸ªèŠ‚ç‚¹åŒæ—¶å»åˆ›å»ºæŸä¸ªç›®å½•æ—¶ï¼Œåªæœ‰ä¸€ä¸ªæˆåŠŸã€‚è€Œåˆ›å»ºæˆåŠŸçš„ç”¨æˆ·å°±å¯ä»¥è®¤ä¸ºæ˜¯è·å¾—äº†é”ã€‚</p>
<h3 id="åŸºäºredisçš„åˆ†å¸ƒå¼é”"><a href="#åŸºäºredisçš„åˆ†å¸ƒå¼é”" class="headerlink" title="åŸºäºredisçš„åˆ†å¸ƒå¼é”"></a>åŸºäºredisçš„åˆ†å¸ƒå¼é”</h3><ul>
<li>åˆ©ç”¨setnx+expireå‘½ä»¤ (é”™è¯¯çš„åšæ³•): setnxå’Œexpireæ˜¯åˆ†å¼€çš„ä¸¤æ­¥æ“ä½œï¼Œä¸å…·æœ‰åŸå­æ€§</li>
<li>ä½¿ç”¨Luaè„šæœ¬ï¼ˆåŒ…å«setnxå’Œexpireä¸¤æ¡æŒ‡ä»¤ï¼‰</li>
<li>ä½¿ç”¨ set key value [EX seconds][PX milliseconds][NX|XX] å‘½ä»¤ (<strong>æ­£ç¡®åšæ³•, æ¥ä¸‹æ¥ä»‹ç»è¿™ç§</strong>)</li>
</ul>
<p>Redis åœ¨ 2.6.12 ç‰ˆæœ¬å¼€å§‹ï¼Œä¸º SET å‘½ä»¤å¢åŠ ä¸€ç³»åˆ—é€‰é¡¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SET key value\[EX seconds\]\[PX milliseconds\]\[NX|XX\]</span><br></pre></td></tr></table></figure>
<ul>
<li>EX seconds: è®¾å®šè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’</li>
<li>PX milliseconds: è®¾å®šè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’</li>
<li>NX: ä»…å½“ key ä¸å­˜åœ¨æ—¶è®¾ç½®å€¼</li>
<li>XX: ä»…å½“ key å­˜åœ¨æ—¶è®¾ç½®å€¼</li>
</ul>
<p>value å¿…é¡»è¦å…·æœ‰å”¯ä¸€æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ UUID æ¥åšï¼Œè®¾ç½®éšæœºå­—ç¬¦ä¸²ä¿è¯å”¯ä¸€æ€§ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦ä¿è¯å”¯ä¸€æ€§ï¼Ÿå‡å¦‚ value ä¸æ˜¯éšæœºå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸€ä¸ªå›ºå®šå€¼ï¼Œé‚£ä¹ˆå°±å¯èƒ½å­˜åœ¨ä¸‹é¢çš„<strong>é—®é¢˜</strong>ï¼š</p>
<p>1. å®¢æˆ·ç«¯ 1 è·å–é”æˆåŠŸ<br>2. å®¢æˆ·ç«¯ 1 åœ¨æŸä¸ªæ“ä½œä¸Šé˜»å¡äº†å¤ªé•¿æ—¶é—´<br>3. è®¾ç½®çš„ key è¿‡æœŸäº†ï¼Œé”è‡ªåŠ¨é‡Šæ”¾äº†<br>4. å®¢æˆ·ç«¯ 2 è·å–åˆ°äº†å¯¹åº”åŒä¸€ä¸ªèµ„æºçš„é”<br>5. å®¢æˆ·ç«¯ 1 ä»é˜»å¡ä¸­æ¢å¤è¿‡æ¥ï¼Œå› ä¸º value å€¼ä¸€æ ·ï¼Œæ‰€ä»¥æ‰§è¡Œé‡Šæ”¾é”æ“ä½œæ—¶å°±ä¼šé‡Šæ”¾æ‰å®¢æˆ·ç«¯ 2 æŒæœ‰çš„é”ï¼Œè¿™æ ·å°±ä¼šé€ æˆé—®é¢˜</p>
<p>æ‰€ä»¥é€šå¸¸æ¥è¯´ï¼Œåœ¨<strong>é‡Šæ”¾é”</strong>æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ value è¿›è¡ŒéªŒè¯</p>
<p>é‡Šæ”¾é”æ—¶éœ€è¦éªŒè¯ value å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åœ¨è·å–é”çš„æ—¶å€™éœ€è¦è®¾ç½®ä¸€ä¸ª valueï¼Œä¸èƒ½ç›´æ¥ç”¨ del key è¿™ç§ç²—æš´çš„æ–¹å¼ï¼Œå› ä¸ºç›´æ¥ del key ä»»ä½•å®¢æˆ·ç«¯éƒ½å¯ä»¥è¿›è¡Œè§£é”äº†ï¼Œæ‰€ä»¥<strong>è§£é”æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­é”æ˜¯å¦æ˜¯è‡ªå·±çš„ï¼ŒåŸºäº value å€¼æ¥åˆ¤æ–­</strong>, è¿™é‡Œä½¿ç”¨ Lua è„šæœ¬çš„æ–¹å¼ï¼Œå°½é‡ä¿è¯åŸå­æ€§ã€‚</p>
<p><strong>è‡´å‘½ç¼ºé™·:</strong><br>ä½¿ç”¨ <code>set key value [EX seconds][PX milliseconds][NX|XX]</code> å‘½ä»¤ çœ‹ä¸Šå»å¾ˆ OKï¼Œå®é™…ä¸Šåœ¨æœ‰ Redis ä¸»ä»ç»“æ„çš„æ—¶å€™ä¹Ÿä¼šå‡ºç°é—®é¢˜ï¼Œæ¯”å¦‚è¯´ A å®¢æˆ·ç«¯åœ¨ Redis çš„ master èŠ‚ç‚¹ä¸Šæ‹¿åˆ°äº†é”ï¼Œä½†æ˜¯è¿™ä¸ªåŠ é”çš„ key è¿˜æ²¡æœ‰åŒæ­¥åˆ° slave èŠ‚ç‚¹ï¼Œmaster æ•…éšœï¼Œå‘ç”Ÿæ•…éšœè½¬ç§»ï¼Œä¸€ä¸ª slave èŠ‚ç‚¹å‡çº§ä¸º master èŠ‚ç‚¹ï¼ŒB å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥è·å–åŒä¸ª key çš„é”ï¼Œä½†å®¢æˆ·ç«¯ A ä¹Ÿå·²ç»æ‹¿åˆ°é”äº†ï¼Œè¿™å°±å¯¼è‡´å¤šä¸ªå®¢æˆ·ç«¯éƒ½æ‹¿åˆ°é”ã€‚</p>
<h4 id="RedLock"><a href="#RedLock" class="headerlink" title="RedLock"></a>RedLock</h4><p>å‚è€ƒ: <a href="https://zhuanlan.zhihu.com/p/100140241#RedLock" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/100140241#RedLock</a></p>
<p>ä½¿ç”¨äº†å¤šä¸ª Redis å®ä¾‹æ¥å®ç°åˆ†å¸ƒå¼é”ï¼Œè¿™æ˜¯ä¸ºäº†ä¿è¯åœ¨å‘ç”Ÿå•ç‚¹æ•…éšœæ—¶ä»ç„¶å¯ç”¨ã€‚</p>
<ul>
<li>å°è¯•ä» N ä¸ªäº’ç›¸ç‹¬ç«‹ Redis å®ä¾‹è·å–é”ï¼›</li>
<li>è®¡ç®—è·å–é”æ¶ˆè€—çš„æ—¶é—´ï¼Œåªæœ‰æ—¶é—´å°äºé”çš„è¿‡æœŸæ—¶é—´ï¼Œå¹¶ä¸”ä»å¤§å¤šæ•°ï¼ˆN / 2 + 1ï¼‰å®ä¾‹ä¸Šè·å–äº†é”ï¼Œæ‰è®¤ä¸ºè·å–é”æˆåŠŸï¼›</li>
<li>å¦‚æœè·å–é”å¤±è´¥ï¼Œå°±åˆ°æ¯ä¸ªå®ä¾‹ä¸Šé‡Šæ”¾é”</li>
</ul>
<h3 id="åˆ†å¸ƒå¼é”çš„é«˜å¹¶å‘ä¼˜åŒ–"><a href="#åˆ†å¸ƒå¼é”çš„é«˜å¹¶å‘ä¼˜åŒ–" class="headerlink" title="åˆ†å¸ƒå¼é”çš„é«˜å¹¶å‘ä¼˜åŒ–"></a>åˆ†å¸ƒå¼é”çš„é«˜å¹¶å‘ä¼˜åŒ–</h3><p>å…ˆè¯´ä¸€ä¸ª<strong>è¶…å–é—®é¢˜çš„æƒ…æ™¯</strong>, å‡è®¾è®¢å•ç³»ç»Ÿéƒ¨ç½²ä¸¤å°æœºå™¨ä¸Šï¼Œä¸åŒçš„ç”¨æˆ·éƒ½è¦åŒæ—¶ä¹°10å°iphoneï¼Œåˆ†åˆ«å‘äº†ä¸€ä¸ªè¯·æ±‚ç»™è®¢å•ç³»ç»Ÿã€‚<br>æ¥ç€æ¯ä¸ªè®¢å•ç³»ç»Ÿå®ä¾‹éƒ½å»æ•°æ®åº“é‡ŒæŸ¥äº†ä¸€ä¸‹ï¼Œå½“å‰iphoneåº“å­˜æ˜¯12å°ã€‚<br>ä¿©å¤§å…„å¼Ÿä¸€çœ‹ï¼Œä¹äº†ï¼Œ12å°åº“å­˜å¤§äºäº†è¦ä¹°çš„10å°æ•°é‡å•Šï¼<br>äºæ˜¯ä¹ï¼Œæ¯ä¸ªè®¢å•ç³»ç»Ÿå®ä¾‹éƒ½å‘é€SQLåˆ°æ•°æ®åº“é‡Œä¸‹å•ï¼Œç„¶åæ‰£å‡äº†10ä¸ªåº“å­˜ï¼Œå…¶ä¸­ä¸€ä¸ªå°†åº“å­˜ä»12å°æ‰£å‡ä¸º2å°ï¼Œå¦å¤–ä¸€ä¸ªå°†åº“å­˜ä»2å°æ‰£å‡ä¸º-8å°ã€‚<br>ç°åœ¨å®Œäº†ï¼Œåº“å­˜å‡ºç°äº†è´Ÿæ•°ï¼æ³ªå¥”å•Šï¼Œæ²¡æœ‰20å°iphoneå‘ç»™ä¸¤ä¸ªç”¨æˆ·å•Šï¼è¿™å¯å¦‚ä½•æ˜¯å¥½ã€‚</p>
<p><strong>ç”¨åˆ†å¸ƒå¼é”å¦‚ä½•è§£å†³åº“å­˜è¶…å–é—®é¢˜:</strong>  åªæœ‰ä¸€ä¸ªè®¢å•ç³»ç»Ÿå®ä¾‹å¯ä»¥æˆåŠŸåŠ åˆ†å¸ƒå¼é”ï¼Œç„¶ååªæœ‰ä»–ä¸€ä¸ªå®ä¾‹å¯ä»¥æŸ¥åº“å­˜ã€åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ã€ä¸‹å•æ‰£å‡åº“å­˜ï¼Œæ¥ç€é‡Šæ”¾é”ã€‚<br>é‡Šæ”¾é”ä¹‹åï¼Œå¦å¤–ä¸€ä¸ªè®¢å•ç³»ç»Ÿå®ä¾‹æ‰èƒ½åŠ é”ï¼Œæ¥ç€æŸ¥åº“å­˜ï¼Œä¸€ä¸‹å‘ç°åº“å­˜åªæœ‰2å°äº†ï¼Œåº“å­˜ä¸è¶³ï¼Œæ— æ³•è´­ä¹°ï¼Œä¸‹å•å¤±è´¥ã€‚ä¸ä¼šå°†åº“å­˜æ‰£å‡ä¸º-8çš„ã€‚</p>
<p><strong>åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</strong> åˆ†å¸ƒå¼é”ä¸€æ—¦åŠ äº†ä¹‹åï¼Œå¯¹åŒä¸€ä¸ªå•†å“çš„ä¸‹å•è¯·æ±‚ï¼Œä¼šå¯¼è‡´æ‰€æœ‰å®¢æˆ·ç«¯éƒ½å¿…é¡»å¯¹åŒä¸€ä¸ªå•†å“çš„åº“å­˜é”keyè¿›è¡ŒåŠ é”ã€‚æ¯”å¦‚ï¼Œå¯¹iphoneè¿™ä¸ªå•†å“çš„ä¸‹å•ï¼Œéƒ½å¿…å¯¹â€œiphone_stockâ€è¿™ä¸ªé”keyæ¥åŠ é”ã€‚è¿™æ ·ä¼šå¯¼è‡´å¯¹åŒä¸€ä¸ªå•†å“çš„ä¸‹å•è¯·æ±‚ï¼Œå°±å¿…é¡»ä¸²è¡ŒåŒ–ï¼Œä¸€ä¸ªæ¥ä¸€ä¸ªçš„å¤„ç†,<br>å‡è®¾åŠ é”ä¹‹åï¼Œé‡Šæ”¾é”ä¹‹å‰ï¼ŒæŸ¥åº“å­˜ -&gt; åˆ›å»ºè®¢å• -&gt; æ‰£å‡åº“å­˜ï¼Œè¿™ä¸ªè¿‡ç¨‹æ€§èƒ½å¾ˆé«˜å§ï¼Œç®—ä»–å…¨è¿‡ç¨‹20æ¯«ç§’ï¼Œè¿™åº”è¯¥ä¸é”™äº†ã€‚é‚£ä¹ˆ1ç§’æ˜¯1000æ¯«ç§’ï¼Œåªèƒ½å®¹çº³50ä¸ªå¯¹è¿™ä¸ªå•†å“çš„è¯·æ±‚ä¾æ¬¡ä¸²è¡Œå®Œæˆå¤„ç†ã€‚<strong>æ•ˆç‡ä½ä¸‹</strong>.</p>
<p><strong>å‡å¦‚ä¸‹å•æ—¶ï¼Œç”¨åˆ†å¸ƒå¼é”æ¥é˜²æ­¢åº“å­˜è¶…å–ï¼Œä½†æ˜¯æ˜¯æ¯ç§’ä¸Šåƒè®¢å•çš„é«˜å¹¶å‘åœºæ™¯ï¼Œå¦‚ä½•å¯¹åˆ†å¸ƒå¼é”è¿›è¡Œé«˜å¹¶å‘ä¼˜åŒ–æ¥åº”å¯¹è¿™ä¸ªåœºæ™¯ï¼Ÿ</strong><br><strong>è§£å†³æ–¹æ¡ˆ: åˆ†æ®µåŠ é”</strong></p>
<p>å…¶å®è¯´å‡ºæ¥ä¹Ÿå¾ˆç®€å•ï¼Œç›¸ä¿¡å¾ˆå¤šäººçœ‹è¿‡javaé‡Œçš„ConcurrentHashMapçš„æºç å’Œåº•å±‚åŸç†ï¼Œåº”è¯¥çŸ¥é“é‡Œé¢çš„æ ¸å¿ƒæ€è·¯ï¼Œå°±æ˜¯åˆ†æ®µåŠ é”ï¼</p>
<blockquote>
<p>åœ¨æŸäº›æƒ…å†µä¸‹æˆ‘ä»¬å¯ä»¥å°†é”åˆ†è§£æŠ€æœ¯è¿›ä¸€æ­¥æ‰©å±•ä¸ºä¸€ç»„ç‹¬ç«‹å¯¹è±¡ä¸Šçš„é”è¿›è¡Œåˆ†è§£ï¼Œè¿™æˆä¸ºåˆ†æ®µé”ã€‚å…¶å®è¯´çš„ç®€å•ä¸€ç‚¹å°±æ˜¯ï¼šå®¹å™¨é‡Œæœ‰å¤šæŠŠé”ï¼Œæ¯ä¸€æŠŠé”ç”¨äºé”å®¹å™¨å…¶ä¸­ä¸€éƒ¨åˆ†æ•°æ®ï¼Œé‚£ä¹ˆå½“å¤šçº¿ç¨‹è®¿é—®å®¹å™¨é‡Œä¸åŒæ•°æ®æ®µçš„æ•°æ®æ—¶ï¼Œçº¿ç¨‹é—´å°±ä¸ä¼šå­˜åœ¨é”ç«äº‰ï¼Œä»è€Œå¯ä»¥æœ‰æ•ˆçš„æé«˜å¹¶å‘è®¿é—®æ•ˆç‡ï¼Œè¿™å°±æ˜¯ConcurrentHashMapæ‰€ä½¿ç”¨çš„é”åˆ†æ®µæŠ€æœ¯ï¼Œé¦–å…ˆå°†æ•°æ®åˆ†æˆä¸€æ®µä¸€æ®µçš„å­˜å‚¨ï¼Œç„¶åç»™æ¯ä¸€æ®µæ•°æ®é…ä¸€æŠŠé”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å ç”¨é”è®¿é—®å…¶ä¸­ä¸€ä¸ªæ®µæ•°æ®çš„æ—¶å€™ï¼Œå…¶ä»–æ®µçš„æ•°æ®ä¹Ÿèƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ã€‚</p>
<p>æ¯”å¦‚ï¼šåœ¨ConcurrentHashMapä¸­ä½¿ç”¨äº†ä¸€ä¸ªåŒ…å«16ä¸ªé”çš„æ•°ç»„ï¼Œæ¯ä¸ªé”ä¿æŠ¤æ‰€æœ‰æ•£åˆ—æ¡¶çš„1/16ï¼Œå…¶ä¸­ç¬¬Nä¸ªæ•£åˆ—æ¡¶ç”±ç¬¬ï¼ˆN mod 16ï¼‰ä¸ªé”æ¥ä¿æŠ¤ã€‚å‡è®¾ä½¿ç”¨åˆç†çš„æ•£åˆ—ç®—æ³•ä½¿å…³é”®å­—èƒ½å¤Ÿå‡åŒ€çš„åˆ†éƒ¨ï¼Œé‚£ä¹ˆè¿™å¤§çº¦èƒ½ä½¿å¯¹é”çš„è¯·æ±‚å‡å°‘åˆ°è¶Šæ¥çš„1/16ã€‚ä¹Ÿæ­£æ˜¯è¿™é¡¹æŠ€æœ¯ä½¿å¾—ConcurrentHashMapæ”¯æŒå¤šè¾¾16ä¸ªå¹¶å‘çš„å†™å…¥çº¿ç¨‹ã€‚</p>
</blockquote>
<p>å‡å¦‚ä½ ç°åœ¨iphoneæœ‰1000ä¸ªåº“å­˜ï¼Œé‚£ä¹ˆä½ å®Œå…¨å¯ä»¥ç»™æ‹†æˆ20ä¸ªåº“å­˜æ®µï¼Œè¦æ˜¯ä½ æ„¿æ„ï¼Œå¯ä»¥åœ¨æ•°æ®åº“çš„è¡¨é‡Œå»º20ä¸ªåº“å­˜å­—æ®µï¼Œæ¯”å¦‚stock_01ï¼Œstock_02ï¼Œç±»ä¼¼è¿™æ ·çš„ï¼Œä¹Ÿå¯ä»¥åœ¨redisä¹‹ç±»çš„åœ°æ–¹æ”¾20ä¸ªåº“å­˜keyã€‚<br>æ€»ä¹‹ï¼Œå°±æ˜¯æŠŠä½ çš„1000ä»¶åº“å­˜ç»™ä»–æ‹†å¼€ï¼Œæ¯ä¸ªåº“å­˜æ®µæ˜¯50ä»¶åº“å­˜ï¼Œæ¯”å¦‚stock_01å¯¹åº”50ä»¶åº“å­˜ï¼Œstock_02å¯¹åº”50ä»¶åº“å­˜ã€‚<br>æ¥ç€ï¼Œæ¯ç§’1000ä¸ªè¯·æ±‚è¿‡æ¥äº†ï¼Œå¥½ï¼æ­¤æ—¶å…¶å®å¯ä»¥æ˜¯è‡ªå·±å†™ä¸€ä¸ªç®€å•çš„éšæœºç®—æ³•ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æ˜¯éšæœºåœ¨20ä¸ªåˆ†æ®µåº“å­˜é‡Œï¼Œé€‰æ‹©ä¸€ä¸ªè¿›è¡ŒåŠ é”ã€‚<br>è¿™æ ·å°±å¥½äº†ï¼ŒåŒæ—¶å¯ä»¥æœ‰æœ€å¤š20ä¸ªä¸‹å•è¯·æ±‚ä¸€èµ·æ‰§è¡Œï¼Œæ¯ä¸ªä¸‹å•è¯·æ±‚é”äº†ä¸€ä¸ªåº“å­˜åˆ†æ®µï¼Œç„¶ååœ¨ä¸šåŠ¡é€»è¾‘é‡Œé¢ï¼Œå°±å¯¹æ•°æ®åº“æˆ–è€…æ˜¯Redisä¸­çš„é‚£ä¸ªåˆ†æ®µåº“å­˜è¿›è¡Œæ“ä½œå³å¯ï¼ŒåŒ…æ‹¬æŸ¥åº“å­˜ -&gt; åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ -&gt; æ‰£å‡åº“å­˜ã€‚</p>
<p><strong>æœ‰ä¸€ä¸ªå‘å¤§å®¶ä¸€å®šè¦æ³¨æ„</strong>ï¼šå¦‚æœæŸä¸ªä¸‹å•è¯·æ±‚ï¼Œå’”åš“åŠ é”ï¼Œç„¶åå‘ç°è¿™ä¸ªåˆ†æ®µåº“å­˜é‡Œçš„åº“å­˜ä¸è¶³äº†ï¼Œæ­¤æ—¶å’‹åŠï¼Ÿ<br>è¿™æ—¶ä½ å¾—è‡ªåŠ¨é‡Šæ”¾é”ï¼Œç„¶åç«‹é©¬æ¢ä¸‹ä¸€ä¸ªåˆ†æ®µåº“å­˜ï¼Œå†æ¬¡å°è¯•åŠ é”åå°è¯•å¤„ç†ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸€å®šè¦å®ç°ã€‚</p>
<h2 id="åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ"></a>åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ</h2><p>å‚è€ƒ:  </p>
<ul>
<li><a href="https://www.cnblogs.com/mayundalao/p/11798502.html" target="_blank" rel="noopener">https://www.cnblogs.com/mayundalao/p/11798502.html</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/88226625" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/88226625</a></li>
<li><a href="https://xiaomi-info.github.io/2020/01/02/distributed-transaction/" target="_blank" rel="noopener">https://xiaomi-info.github.io/2020/01/02/distributed-transaction/</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/183753774" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/183753774</a></li>
</ul>
<p>äº‹åŠ¡æœ‰ä¸¤ç§:  </p>
<ul>
<li><strong>åˆšæ€§äº‹åŠ¡</strong>ï¼šéµå¾ªACIDåŸåˆ™ï¼Œå¼ºä¸€è‡´æ€§ã€‚</li>
<li><strong>æŸ”æ€§äº‹åŠ¡</strong>ï¼šéµå¾ªBASEç†è®ºï¼Œæœ€ç»ˆä¸€è‡´æ€§ï¼›ä¸åˆšæ€§äº‹åŠ¡ä¸åŒï¼ŒæŸ”æ€§äº‹åŠ¡å…è®¸ä¸€å®šæ—¶é—´å†…ï¼Œä¸åŒèŠ‚ç‚¹çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä½†è¦æ±‚æœ€ç»ˆä¸€è‡´ã€‚</li>
</ul>
<h3 id="äºŒé˜¶æ®µæäº¤2PC"><a href="#äºŒé˜¶æ®µæäº¤2PC" class="headerlink" title="äºŒé˜¶æ®µæäº¤2PC"></a>äºŒé˜¶æ®µæäº¤2PC</h3><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/transaction/XA-first.jpg" alt><br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/transaction/XA-second.jpg" alt></p>
<p>å¤§è‡´çš„æµç¨‹ï¼š</p>
<ul>
<li>ç¬¬ä¸€é˜¶æ®µï¼ˆprepareï¼‰ï¼šäº‹åŠ¡ç®¡ç†å™¨å‘æ‰€æœ‰æœ¬åœ°èµ„æºç®¡ç†å™¨å‘èµ·è¯·æ±‚ï¼Œè¯¢é—®æ˜¯å¦æ˜¯ ready çŠ¶æ€ï¼Œæ‰€æœ‰å‚ä¸è€…éƒ½å°†æœ¬äº‹åŠ¡èƒ½å¦æˆåŠŸçš„ä¿¡æ¯åé¦ˆå‘ç»™åè°ƒè€…ï¼›  </li>
<li>ç¬¬äºŒé˜¶æ®µ (commit/rollback)ï¼šäº‹åŠ¡ç®¡ç†å™¨æ ¹æ®æ‰€æœ‰æœ¬åœ°èµ„æºç®¡ç†å™¨çš„åé¦ˆï¼Œé€šçŸ¥æ‰€æœ‰æœ¬åœ°èµ„æºç®¡ç†å™¨ï¼Œæ­¥è°ƒä¸€è‡´åœ°åœ¨æ‰€æœ‰åˆ†æ”¯ä¸Šæäº¤æˆ–è€…å›æ»šã€‚</li>
</ul>
<p><strong>ç¼ºç‚¹:</strong>  </p>
<ul>
<li>åŒæ­¥é˜»å¡ï¼šå½“å‚ä¸äº‹åŠ¡è€…å­˜åœ¨å ç”¨å…¬å…±èµ„æºçš„æƒ…å†µï¼Œå…¶ä¸­ä¸€ä¸ªå ç”¨äº†èµ„æºï¼Œå…¶ä»–äº‹åŠ¡å‚ä¸è€…å°±åªèƒ½é˜»å¡ç­‰å¾…èµ„æºé‡Šæ”¾ï¼Œå¤„äºé˜»å¡çŠ¶æ€ã€‚</li>
<li>å•ç‚¹æ•…éšœï¼šä¸€æ—¦äº‹åŠ¡ç®¡ç†å™¨å‡ºç°æ•…éšœï¼Œæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨</li>
<li>æ•°æ®ä¸ä¸€è‡´ï¼šåœ¨é˜¶æ®µäºŒï¼Œå¦‚æœäº‹åŠ¡ç®¡ç†å™¨åªå‘é€äº†éƒ¨åˆ† commit æ¶ˆæ¯ï¼Œæ­¤æ—¶ç½‘ç»œå‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆåªæœ‰éƒ¨åˆ†å‚ä¸è€…æ¥æ”¶åˆ° commit æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰éƒ¨åˆ†å‚ä¸è€…æäº¤äº†äº‹åŠ¡ï¼Œä½¿å¾—ç³»ç»Ÿæ•°æ®ä¸ä¸€è‡´ã€‚</li>
<li>ä¸ç¡®å®šæ€§ï¼šå½“åäº‹åŠ¡ç®¡ç†å™¨å‘é€ commit ä¹‹åï¼Œå¹¶ä¸”æ­¤æ—¶åªæœ‰ä¸€ä¸ªå‚ä¸è€…æ”¶åˆ°äº† commitï¼Œé‚£ä¹ˆå½“è¯¥å‚ä¸è€…ä¸äº‹åŠ¡ç®¡ç†å™¨åŒæ—¶å®•æœºä¹‹åï¼Œé‡æ–°é€‰ä¸¾çš„äº‹åŠ¡ç®¡ç†å™¨æ— æ³•ç¡®å®šè¯¥æ¡æ¶ˆæ¯æ˜¯å¦æäº¤æˆåŠŸã€‚</li>
</ul>
<p><strong>å®æˆ˜:</strong><br>ç›®å‰æ”¯ä»˜å®ä½¿ç”¨ä¸¤é˜¶æ®µæäº¤æ€æƒ³å®ç°äº†åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ (Distributed Transaction Service, DTS) ï¼Œå®ƒæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼Œç”¨æ¥ä¿éšœåœ¨å¤§è§„æ¨¡åˆ†å¸ƒå¼ç¯å¢ƒä¸‹äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚å…·ä½“å¯å‚è€ƒæ”¯ä»˜å®å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://tech.antfin.com/docs/2/46887" target="_blank" rel="noopener">https://tech.antfin.com/docs/2/46887</a></p>
<h3 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a>TCC</h3><p>å…³äº TCCï¼ˆTry-Confirm-Cancelï¼‰çš„æ¦‚å¿µï¼Œæœ€æ—©æ˜¯ç”± Pat Helland äº 2007 å¹´å‘è¡¨çš„ä¸€ç¯‡åä¸ºã€ŠLife beyond Distributed Transactions:an Apostateâ€™s Opinionã€‹çš„è®ºæ–‡æå‡ºã€‚ TCC äº‹åŠ¡æœºåˆ¶ç›¸æ¯”äºä¸Šé¢ä»‹ç»çš„ XAï¼Œè§£å†³äº†å…¶å‡ ä¸ªç¼ºç‚¹ï¼š</p>
<ul>
<li>è§£å†³äº†åè°ƒè€…å•ç‚¹ï¼Œç”±ä¸»ä¸šåŠ¡æ–¹å‘èµ·å¹¶å®Œæˆè¿™ä¸ªä¸šåŠ¡æ´»åŠ¨ã€‚ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨ä¹Ÿå˜æˆå¤šç‚¹ï¼Œå¼•å…¥é›†ç¾¤ã€‚</li>
<li>åŒæ­¥é˜»å¡ï¼šå¼•å…¥è¶…æ—¶ï¼Œè¶…æ—¶åè¿›è¡Œè¡¥å¿ï¼Œå¹¶ä¸”ä¸ä¼šé”å®šæ•´ä¸ªèµ„æºï¼Œå°†èµ„æºè½¬æ¢ä¸ºä¸šåŠ¡é€»è¾‘å½¢å¼ï¼Œç²’åº¦å˜å°ã€‚</li>
<li>æ•°æ®ä¸€è‡´æ€§ï¼Œæœ‰äº†è¡¥å¿æœºåˆ¶ä¹‹åï¼Œç”±ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨æ§åˆ¶ä¸€è‡´æ€§</li>
</ul>
<p>TCC(Try Confirm Cancel)  </p>
<ol>
<li>Try é˜¶æ®µï¼šå°è¯•æ‰§è¡Œï¼Œå®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥ï¼ˆä¸€è‡´æ€§ï¼‰, é¢„ç•™å¿…é¡»ä¸šåŠ¡èµ„æºï¼ˆå‡†éš”ç¦»æ€§ï¼‰  </li>
<li>Confirm é˜¶æ®µï¼šç¡®è®¤æ‰§è¡ŒçœŸæ­£æ‰§è¡Œä¸šåŠ¡ï¼Œä¸ä½œä»»ä½•ä¸šåŠ¡æ£€æŸ¥ï¼Œåªä½¿ç”¨ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºï¼ŒConfirm æ“ä½œæ»¡è¶³å¹‚ç­‰æ€§ã€‚è¦æ±‚å…·å¤‡å¹‚ç­‰è®¾è®¡ï¼ŒConfirm å¤±è´¥åéœ€è¦è¿›è¡Œé‡è¯•ã€‚  </li>
<li>Cancel é˜¶æ®µï¼šå–æ¶ˆæ‰§è¡Œï¼Œé‡Šæ”¾ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æº Cancel æ“ä½œæ»¡è¶³å¹‚ç­‰æ€§ Cancel é˜¶æ®µçš„å¼‚å¸¸å’Œ Confirm é˜¶æ®µå¼‚å¸¸å¤„ç†æ–¹æ¡ˆåŸºæœ¬ä¸Šä¸€è‡´ã€‚</li>
</ol>
<p>åœ¨ Try é˜¶æ®µï¼Œæ˜¯å¯¹ä¸šåŠ¡ç³»ç»Ÿè¿›è¡Œæ£€æŸ¥åŠèµ„æºé¢„è§ˆï¼Œæ¯”å¦‚è®¢å•å’Œå­˜å‚¨æ“ä½œï¼Œéœ€è¦æ£€æŸ¥åº“å­˜å‰©ä½™æ•°é‡æ˜¯å¦å¤Ÿç”¨ï¼Œå¹¶è¿›è¡Œé¢„ç•™ï¼Œé¢„ç•™æ“ä½œçš„è¯å°±æ˜¯æ–°å»ºä¸€ä¸ªå¯ç”¨åº“å­˜æ•°é‡å­—æ®µï¼ŒTry é˜¶æ®µæ“ä½œæ˜¯å¯¹è¿™ä¸ªå¯ç”¨åº“å­˜æ•°é‡è¿›è¡Œæ“ä½œã€‚<br>åŸºäº TCC å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¼šå°†åŸæ¥åªéœ€è¦ä¸€ä¸ªæ¥å£å°±å¯ä»¥å®ç°çš„é€»è¾‘æ‹†åˆ†ä¸º Tryã€Confirmã€Cancel ä¸‰ä¸ªæ¥å£ï¼Œæ‰€ä»¥ä»£ç å®ç°å¤æ‚åº¦ç›¸å¯¹è¾ƒé«˜ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/transaction/tcc.jpg" alt></p>
<p><strong>ç¼ºç‚¹:</strong><br>TCC éœ€è¦äº‹åŠ¡æ¥å£æä¾› try, confirm, cancel ä¸‰ä¸ªæ¥å£ï¼Œæé«˜äº†ç¼–ç¨‹çš„å¤æ‚æ€§ã€‚ä¾èµ–äºä¸šåŠ¡æ–¹æ¥é…åˆæä¾›è¿™æ ·çš„æ¥å£ï¼Œæ¨è¡Œéš¾åº¦å¤§ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸æ¨èä½¿ç”¨è¿™ç§æ–¹å¼ã€‚</p>
<p><strong>å®æˆ˜:</strong><br>ä¸€èˆ¬æ¥è¯´å’Œé’±ç›¸å…³çš„æ”¯ä»˜ã€äº¤æ˜“ç­‰ç›¸å…³çš„åœºæ™¯ï¼Œä¹Ÿå¯ä»¥ç”¨TCCï¼Œä¸¥æ ¼ä¸¥æ ¼ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨è‡ªåŠ¨å›æ»šï¼Œä¸¥æ ¼ä¿è¯èµ„é‡‘çš„æ­£ç¡®æ€§!</p>
<h3 id="æœ¬åœ°æ¶ˆæ¯è¡¨"><a href="#æœ¬åœ°æ¶ˆæ¯è¡¨" class="headerlink" title="æœ¬åœ°æ¶ˆæ¯è¡¨"></a>æœ¬åœ°æ¶ˆæ¯è¡¨</h3><p>æœ¬åœ°æ¶ˆæ¯è¡¨è¿™ä¸ªæ–¹æ¡ˆæœ€åˆæ˜¯ ebay æ¶æ„å¸ˆ Dan Pritchett åœ¨ 2008 å¹´å‘è¡¨ç»™ ACM çš„æ–‡ç« ã€‚è¯¥æ–¹æ¡ˆä¸­ä¼šæœ‰æ¶ˆæ¯ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ä¸¤ä¸ªè§’è‰²ï¼Œå‡è®¾ç³»ç»Ÿ A æ˜¯æ¶ˆæ¯ç”Ÿäº§è€…ï¼Œç³»ç»Ÿ B æ˜¯æ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œå…¶å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/transaction/native-message.jpg" alt></p>
<ol>
<li>å½“ç³»ç»Ÿ A è¢«å…¶ä»–ç³»ç»Ÿè°ƒç”¨å‘ç”Ÿæ•°æ®åº“è¡¨æ›´æ“ä½œï¼Œé¦–å…ˆä¼šæ›´æ–°æ•°æ®åº“çš„ä¸šåŠ¡è¡¨ï¼Œå…¶æ¬¡ä¼šå¾€ç›¸åŒæ•°æ®åº“çš„æ¶ˆæ¯è¡¨ä¸­æ’å…¥ä¸€æ¡æ•°æ®ï¼Œä¸¤ä¸ªæ“ä½œå‘ç”Ÿåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­, å¦‚æœæœ¬æ­¥éª¤å‘ç”Ÿæ“ä½œå¤±è´¥, åˆ™ç›´æ¥äº‹åŠ¡å›æ»š</li>
<li>ç³»ç»Ÿ A çš„è„šæœ¬å®šæœŸè½®è¯¢æœ¬åœ°æ¶ˆæ¯å¾€ mq ä¸­å†™å…¥ä¸€æ¡æ¶ˆæ¯ï¼Œå¦‚æœæ¶ˆæ¯å‘é€å¤±è´¥ä¼šè¿›è¡Œé‡è¯•</li>
<li>ç³»ç»Ÿ B æ¶ˆè´¹ mq ä¸­çš„æ¶ˆæ¯ï¼Œå¹¶å¤„ç†ä¸šåŠ¡é€»è¾‘ã€‚å¦‚æœæœ¬åœ°äº‹åŠ¡å¤„ç†å¤±è´¥ï¼Œä¼šåœ¨ç»§ç»­æ¶ˆè´¹ mq ä¸­çš„æ¶ˆæ¯è¿›è¡Œé‡è¯•ï¼Œå¦‚æœä¸šåŠ¡ä¸Šçš„å¤±è´¥ï¼Œå¯ä»¥é€šçŸ¥ç³»ç»Ÿ A è¿›è¡Œå›æ»šæ“ä½œ</li>
</ol>
<p>æœ¬åœ°æ¶ˆæ¯è¡¨å®ç°çš„æ¡ä»¶ï¼š</p>
<ul>
<li>æ¶ˆè´¹è€…ä¸ç”Ÿæˆè€…çš„æ¥å£éƒ½è¦æ”¯æŒå¹‚ç­‰</li>
<li>ç”Ÿäº§è€…éœ€è¦é¢å¤–çš„åˆ›å»ºæ¶ˆæ¯è¡¨</li>
<li>éœ€è¦æä¾›è¡¥å¿é€»è¾‘ï¼Œå¦‚æœæ¶ˆè´¹è€…ä¸šåŠ¡å¤±è´¥ï¼Œéœ€è¦ç”Ÿäº§è€…æ”¯æŒå›æ»šæ“ä½œ</li>
</ul>
<p>æ­¤æ–¹æ¡ˆçš„æ ¸å¿ƒæ˜¯å°†éœ€è¦åˆ†å¸ƒå¼å¤„ç†çš„ä»»åŠ¡é€šè¿‡æ¶ˆæ¯æ—¥å¿—çš„æ–¹å¼æ¥å¼‚æ­¥æ‰§è¡Œã€‚æ¶ˆæ¯æ—¥å¿—å¯ä»¥å­˜å‚¨åˆ°æœ¬åœ°æ–‡æœ¬ã€æ•°æ®åº“æˆ–æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå†é€šè¿‡ä¸šåŠ¡è§„åˆ™è‡ªåŠ¨æˆ–äººå·¥å‘èµ·é‡è¯•ã€‚äººå·¥é‡è¯•æ›´å¤šçš„æ˜¯åº”ç”¨äºæ”¯ä»˜åœºæ™¯ï¼Œé€šè¿‡å¯¹è´¦ç³»ç»Ÿå¯¹äº‹åé—®é¢˜çš„å¤„ç†ã€‚</p>
<p><strong>ç¼ºç‚¹:</strong><br>æœ€å¤§çš„é—®é¢˜å°±åœ¨äºä¸¥é‡ä¾èµ–äºæ•°æ®åº“çš„æ¶ˆæ¯è¡¨æ¥ç®¡ç†äº‹åŠ¡,è¿™ä¸ªä¼šå¯¼è‡´é«˜å¹¶å‘åœºæ™¯æ— åŠ›,éš¾ä»¥æ‰©å±•,ä¸€èˆ¬å¾ˆå°‘ç”¨</p>
<p><strong>å®æˆ˜:</strong><br>è·¨è¡Œè½¬è´¦å¯é€šè¿‡è¯¥æ–¹æ¡ˆå®ç°ã€‚<br>ç”¨æˆ· A å‘ç”¨æˆ· B å‘èµ·è½¬è´¦ï¼Œé¦–å…ˆç³»ç»Ÿä¼šæ‰£æ‰ç”¨æˆ· A è´¦æˆ·ä¸­çš„é‡‘é¢ï¼Œå°†è¯¥è½¬è´¦æ¶ˆæ¯å†™å…¥æ¶ˆæ¯è¡¨ä¸­ï¼Œå¦‚æœäº‹åŠ¡æ‰§è¡Œå¤±è´¥åˆ™è½¬è´¦å¤±è´¥ï¼Œå¦‚æœè½¬è´¦æˆåŠŸï¼Œç³»ç»Ÿä¸­ä¼šæœ‰å®šæ—¶è½®è¯¢æ¶ˆæ¯è¡¨ï¼Œå¾€ mq ä¸­å†™å…¥è½¬è´¦æ¶ˆæ¯ï¼Œå¤±è´¥é‡è¯•ã€‚mq æ¶ˆæ¯ä¼šè¢«å®æ—¶æ¶ˆè´¹å¹¶å¾€ç”¨æˆ· B ä¸­è´¦æˆ·å¢åŠ è½¬è´¦é‡‘é¢ï¼Œæ‰§è¡Œå¤±è´¥ä¼šä¸æ–­é‡è¯•ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/transaction/bank-transfer.jpg" alt></p>
<p>å°ç±³æµ·å¤–å•†åŸç”¨æˆ·è®¢å•æ•°æ®çŠ¶æ€å˜æ›´ï¼Œä¼šå°†å˜æ›´çŠ¶æ€è®°å½•æ¶ˆæ¯è¡¨ä¸­ï¼Œè„šæœ¬å°†è®¢å•çŠ¶æ€æ¶ˆæ¯å†™å…¥ mqï¼Œæœ€ç»ˆæ¶ˆè´¹ mq ç»™ç”¨æˆ·å‘é€é‚®ä»¶ã€çŸ­ä¿¡ã€push ç­‰ã€‚</p>
<h3 id="å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§"><a href="#å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§" class="headerlink" title="å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§"></a>å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§</h3><p>å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/transaction/mq-message.jpg" alt></p>
<ol>
<li>A ç³»ç»Ÿå…ˆå‘ mq å‘é€ä¸€æ¡ prepare æ¶ˆæ¯ï¼Œå¦‚æœ prepare æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œåˆ™ç›´æ¥å–æ¶ˆæ“ä½œ</li>
<li>å¦‚æœæ¶ˆæ¯å‘é€æˆåŠŸï¼Œåˆ™æ‰§è¡Œæœ¬åœ°äº‹åŠ¡</li>
<li>å¦‚æœæœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œåˆ™å‘ mq å‘é€ä¸€æ¡ confirm æ¶ˆæ¯ï¼Œå¦‚æœå‘é€å¤±è´¥ï¼Œåˆ™å‘é€å›æ»šæ¶ˆæ¯</li>
<li>B ç³»ç»Ÿå®šæœŸæ¶ˆè´¹ mq ä¸­çš„ confirm æ¶ˆæ¯ï¼Œæ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œå¹¶å‘é€ ack æ¶ˆæ¯ã€‚å¦‚æœ B ç³»ç»Ÿä¸­çš„æœ¬åœ°äº‹åŠ¡å¤±è´¥ï¼Œä¼šä¸€ç›´ä¸æ–­é‡è¯•ï¼Œå¦‚æœæ˜¯ä¸šåŠ¡å¤±è´¥ï¼Œä¼šå‘ A ç³»ç»Ÿå‘èµ·å›æ»šè¯·æ±‚</li>
<li>mq ä¼šå®šæœŸè½®è¯¢æ‰€æœ‰ prepared æ¶ˆæ¯è°ƒç”¨ç³»ç»Ÿ A æä¾›çš„æ¥å£æŸ¥è¯¢æ¶ˆæ¯çš„å¤„ç†æƒ…å†µï¼Œå¦‚æœè¯¥ prepare æ¶ˆæ¯æœ¬åœ°äº‹åŠ¡å¤„ç†æˆåŠŸï¼Œåˆ™é‡æ–°å‘é€ confirm æ¶ˆæ¯ï¼Œå¦åˆ™ç›´æ¥å›æ»šè¯¥æ¶ˆæ¯</li>
</ol>
<p>è¯¥æ–¹æ¡ˆä¸æœ¬åœ°æ¶ˆæ¯æœ€å¤§çš„ä¸åŒæ˜¯å»æ‰äº†æœ¬åœ°æ¶ˆæ¯è¡¨ï¼Œå…¶æ¬¡æœ¬åœ°æ¶ˆæ¯è¡¨ä¾èµ–æ¶ˆæ¯è¡¨é‡è¯•å†™å…¥ mq è¿™ä¸€æ­¥ç”±æœ¬æ–¹æ¡ˆä¸­çš„è½®è¯¢ prepare æ¶ˆæ¯çŠ¶æ€æ¥é‡è¯•æˆ–è€…å›æ»šè¯¥æ¶ˆæ¯æ›¿ä»£ã€‚å…¶å®ç°æ¡ä»¶ä¸å®¹é”™æ–¹æ¡ˆåŸºæœ¬ä¸€è‡´ã€‚</p>
<p><strong>å®æˆ˜:</strong><br>ç›®å‰å¸‚é¢ä¸Šå®ç°è¯¥æ–¹æ¡ˆçš„åªæœ‰é˜¿é‡Œçš„ RocketMqã€‚</p>
<h3 id="å°½æœ€å¤§åŠªåŠ›é€šçŸ¥"><a href="#å°½æœ€å¤§åŠªåŠ›é€šçŸ¥" class="headerlink" title="å°½æœ€å¤§åŠªåŠ›é€šçŸ¥"></a>å°½æœ€å¤§åŠªåŠ›é€šçŸ¥</h3><p>æœ€å¤§åŠªåŠ›é€šçŸ¥å…¶å®å°±æ˜¯å®šæœŸæ ¡å¯¹, æ˜¯æœ€ç®€å•çš„ä¸€ç§æŸ”æ€§äº‹åŠ¡ï¼Œé€‚ç”¨äºä¸€äº›æœ€ç»ˆä¸€è‡´æ€§æ—¶é—´æ•æ„Ÿåº¦ä½çš„ä¸šåŠ¡ï¼Œä¸”è¢«åŠ¨æ–¹å¤„ç†ç»“æœ ä¸å½±å“ä¸»åŠ¨æ–¹çš„å¤„ç†ç»“æœã€‚</p>
<p>ä¸šåŠ¡æ´»åŠ¨çš„ä¸»åŠ¨æ–¹ï¼Œåœ¨å®Œæˆä¸šåŠ¡å¤„ç†ä¹‹åï¼Œå‘ä¸šåŠ¡æ´»åŠ¨çš„è¢«åŠ¨æ–¹å‘é€æ¶ˆæ¯ï¼Œå…è®¸æ¶ˆæ¯ä¸¢å¤±ã€‚ä¸»åŠ¨æ–¹å¯ä»¥è®¾ç½®æ—¶é—´é˜¶æ¢¯å‹é€šçŸ¥è§„åˆ™ï¼Œåœ¨é€šçŸ¥å¤±è´¥åæŒ‰è§„åˆ™é‡å¤é€šçŸ¥ï¼Œç›´åˆ°é€šçŸ¥Næ¬¡åä¸å†é€šçŸ¥ã€‚ä¸»åŠ¨æ–¹æä¾›æ ¡å¯¹æŸ¥è¯¢æ¥å£ç»™è¢«åŠ¨æ–¹æŒ‰éœ€æ ¡å¯¹æŸ¥è¯¢ï¼Œç”¨äºæ¢å¤ä¸¢å¤±çš„ä¸šåŠ¡æ¶ˆæ¯ã€‚ä¸šåŠ¡æ´»åŠ¨çš„è¢«åŠ¨æ–¹å¦‚æœæ­£å¸¸æ¥æ”¶äº†æ•°æ®ï¼Œå°±æ­£å¸¸è¿”å›å“åº”ï¼Œå¹¶ç»“æŸäº‹åŠ¡ã€‚å¦‚æœè¢«åŠ¨æ–¹æ²¡æœ‰æ­£å¸¸æ¥æ”¶ï¼Œæ ¹æ®å®šæ—¶ç­–ç•¥ï¼Œå‘ä¸šåŠ¡æ´»åŠ¨ä¸»åŠ¨æ–¹æŸ¥è¯¢ï¼Œæ¢å¤ä¸¢å¤±çš„ä¸šåŠ¡æ¶ˆæ¯</p>
<p>æœ€å¤§åŠªåŠ›é€šçŸ¥æ–¹æ¡ˆçš„ç‰¹ç‚¹:  </p>
<ul>
<li>ç”¨åˆ°çš„æœåŠ¡æ¨¡å¼ï¼šå¯æŸ¥è¯¢æ“ä½œã€å¹‚ç­‰æ“ä½œã€‚</li>
<li>è¢«åŠ¨æ–¹çš„å¤„ç†ç»“æœä¸å½±å“ä¸»åŠ¨æ–¹çš„å¤„ç†ç»“æœï¼›é€‚ç”¨äºå¯¹ä¸šåŠ¡æœ€ç»ˆä¸€è‡´æ€§çš„æ—¶é—´æ•æ„Ÿåº¦ä½çš„ç³»ç»Ÿ, æ¯”å¦‚é€‚åˆè·¨ä¼ä¸šçš„ç³»ç»Ÿé—´çš„æ“ä½œï¼Œæˆ–è€…ä¼ä¸šå†…éƒ¨æ¯”è¾ƒç‹¬ç«‹çš„ç³»ç»Ÿé—´çš„æ“ä½œï¼Œæ¯”å¦‚é“¶è¡Œé€šçŸ¥ã€å•†æˆ·é€šçŸ¥ç­‰ï¼›</li>
</ul>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/transaction/notify-callback.jpg" alt></p>
<p>è¿™ä¸ªæ–¹æ¡ˆçš„å¤§è‡´æ„æ€å°±æ˜¯ï¼š</p>
<ol>
<li>ç³»ç»Ÿ A æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå®Œä¹‹åï¼Œå‘é€ä¸ªæ¶ˆæ¯åˆ° MQï¼›</li>
<li>ä¼šæœ‰ä¸ªä¸“é—¨æ¶ˆè´¹ MQ çš„æœåŠ¡ notify_service(å³æœ€å¤§åŠªåŠ›é€šçŸ¥æœåŠ¡) ï¼Œè¿™ä¸ªæœåŠ¡ä¼šæ¶ˆè´¹ MQ å¹¶è°ƒç”¨ç³»ç»Ÿ B çš„æ¥å£ï¼›</li>
<li>è¦æ˜¯ç³»ç»Ÿ B æ‰§è¡ŒæˆåŠŸå°± ok äº†ï¼›è¦æ˜¯ç³»ç»Ÿ B æ‰§è¡Œå¤±è´¥äº†ï¼Œé‚£ä¹ˆ notify_service (å³æœ€å¤§åŠªåŠ›é€šçŸ¥æœåŠ¡)å°±å®šæ—¶å°è¯•é‡æ–°è°ƒç”¨ç³»ç»Ÿ B, åå¤ N æ¬¡ï¼Œæœ€åè¿˜æ˜¯ä¸è¡Œå°±æ”¾å¼ƒã€‚</li>
</ol>
<p><strong>å®æˆ˜:</strong><br>å°ç±³æµ·å¤–å•†åŸç›®å‰é™¤äº†æ”¯ä»˜å›è°ƒå¤–ï¼Œæœ€å¸¸ç”¨çš„åœºæ™¯æ˜¯è®¢å•æ•°æ®åŒæ­¥ã€‚ä¾‹å¦‚ç³»ç»Ÿ Aã€B è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œå½“ç³»ç»Ÿ A å‘ç”Ÿè®¢å•æ•°æ®å˜æ›´ï¼Œå…ˆå°†æ•°æ®å˜æ›´æ¶ˆæ¯å†™å…¥å°ç±³ notify ç³»ç»Ÿï¼ˆä½œç”¨ç­‰åŒ mqï¼‰ï¼Œç„¶å notify ç³»ç»Ÿå¼‚æ­¥å¤„ç†è¯¥æ¶ˆæ¯æ¥è°ƒç”¨ç³»ç»Ÿ B æä¾›çš„æ¥å£å¹¶è¿›è¡Œé‡è¯•åˆ°æœ€å¤§æ¬¡æ•°ã€‚</p>
<h2 id="è´Ÿè½½å‡è¡¡ç®—æ³•æœ‰å“ªäº›"><a href="#è´Ÿè½½å‡è¡¡ç®—æ³•æœ‰å“ªäº›" class="headerlink" title="è´Ÿè½½å‡è¡¡ç®—æ³•æœ‰å“ªäº›"></a>è´Ÿè½½å‡è¡¡ç®—æ³•æœ‰å“ªäº›</h2><ol>
<li>è½®è¯¢æ³•<br>ã€€ã€€å°†è¯·æ±‚æŒ‰é¡ºåºè½®æµåœ°åˆ†é…åˆ°åç«¯æœåŠ¡å™¨ä¸Šï¼Œå®ƒå‡è¡¡åœ°å¯¹å¾…åç«¯çš„æ¯ä¸€å°æœåŠ¡å™¨ï¼Œè€Œä¸å…³å¿ƒæœåŠ¡å™¨å®é™…çš„è¿æ¥æ•°å’Œå½“å‰çš„ç³»ç»Ÿè´Ÿè½½ã€‚</li>
<li>éšæœºæ³•<br>  é€šè¿‡ç³»ç»Ÿçš„éšæœºç®—æ³•ï¼Œæ ¹æ®åç«¯æœåŠ¡å™¨çš„åˆ—è¡¨å¤§å°å€¼æ¥éšæœºé€‰å–å…¶ä¸­çš„ä¸€å°æœåŠ¡å™¨è¿›è¡Œè®¿é—®ã€‚ç”±æ¦‚ç‡ç»Ÿè®¡ç†è®ºå¯ä»¥å¾—çŸ¥ï¼Œéšç€å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯çš„æ¬¡æ•°å¢å¤šï¼Œ<br>å…¶å®é™…æ•ˆæœè¶Šæ¥è¶Šæ¥è¿‘äºå¹³å‡åˆ†é…è°ƒç”¨é‡åˆ°åç«¯çš„æ¯ä¸€å°æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯è½®è¯¢çš„ç»“æœã€‚</li>
<li>æºåœ°å€å“ˆå¸Œæ³•<br>  æºåœ°å€å“ˆå¸Œçš„æ€æƒ³æ˜¯æ ¹æ®è·å–å®¢æˆ·ç«¯çš„ IP åœ°å€ï¼Œé€šè¿‡å“ˆå¸Œå‡½æ•°è®¡ç®—å¾—åˆ°çš„ä¸€ä¸ªæ•°å€¼ï¼Œç”¨è¯¥æ•°å€¼å¯¹æœåŠ¡å™¨åˆ—è¡¨çš„å¤§å°è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œå¾—åˆ°çš„ç»“æœä¾¿æ˜¯å®¢æœç«¯è¦è®¿é—®æœåŠ¡å™¨çš„åºå·ã€‚é‡‡ç”¨æºåœ°å€å“ˆå¸Œæ³•è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼ŒåŒä¸€ IP åœ°å€çš„å®¢æˆ·ç«¯ï¼Œå½“åç«¯æœåŠ¡å™¨åˆ—è¡¨ä¸å˜æ—¶ï¼Œå®ƒæ¯æ¬¡éƒ½ä¼šæ˜ å°„åˆ°åŒä¸€å°åç«¯æœåŠ¡å™¨è¿›è¡Œè®¿é—®ã€‚</li>
<li>åŠ æƒè½®è¯¢æ³•<br>ã€€ã€€ä¸åŒçš„åç«¯æœåŠ¡å™¨å¯èƒ½æœºå™¨çš„é…ç½®å’Œå½“å‰ç³»ç»Ÿçš„è´Ÿè½½å¹¶ä¸ç›¸åŒï¼Œå› æ­¤å®ƒä»¬çš„æŠ—å‹èƒ½åŠ›ä¹Ÿä¸ç›¸åŒã€‚ç»™é…ç½®é«˜ã€è´Ÿè½½ä½çš„æœºå™¨é…ç½®æ›´é«˜çš„æƒé‡ï¼Œè®©å…¶å¤„ç†æ›´å¤šçš„è¯·ï¼›è€Œé…ç½®ä½ã€è´Ÿè½½é«˜çš„æœºå™¨ï¼Œç»™å…¶åˆ†é…è¾ƒä½çš„æƒé‡ï¼Œé™ä½å…¶ç³»ç»Ÿè´Ÿè½½ï¼ŒåŠ æƒè½®è¯¢èƒ½å¾ˆå¥½åœ°å¤„ç†è¿™ä¸€é—®é¢˜ï¼Œå¹¶å°†è¯·æ±‚é¡ºåºä¸”æŒ‰ç…§æƒé‡åˆ†é…åˆ°åç«¯ã€‚åŠ æƒè½®è¯¢ç®—æ³•çš„ç»“æœï¼Œå°±æ˜¯è¦ç”Ÿæˆä¸€ä¸ªæœåŠ¡å™¨åºåˆ—ã€‚æ¯å½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶ï¼Œå°±ä¾æ¬¡ä»è¯¥åºåˆ—ä¸­å–å‡ºä¸‹ä¸€ä¸ªæœåŠ¡å™¨ç”¨äºå¤„ç†è¯¥è¯·æ±‚ã€‚æ¯”å¦‚é’ˆå¯¹<code>cæƒé‡4, bæƒé‡2, aæƒé‡1</code>çš„ä¾‹å­ï¼ŒåŠ æƒè½®è¯¢ç®—æ³•ä¼šç”Ÿæˆåºåˆ—<code>{c, c, b, c, a, b, c}</code>ä¹Ÿæœ‰å¯èƒ½æ˜¯<code>{a, a, a, a, a, b, c}</code>, æœ‰å¯èƒ½ä¸å‡åŒ€, å‰äº”ä¸ªè¯·æ±‚éƒ½ä¼šåˆ†é…ç»™æœåŠ¡å™¨aã€‚åœ¨Nginxæºç ä¸­ï¼Œå®ç°äº†ä¸€ç§å«åšå¹³æ»‘çš„åŠ æƒè½®è¯¢ï¼ˆsmooth weighted round-robin balancingï¼‰çš„ç®—æ³•ï¼Œå®ƒç”Ÿæˆçš„åºåˆ—æ›´åŠ å‡åŒ€ã€‚æ¯”å¦‚å‰é¢çš„ä¾‹å­ï¼Œå®ƒç”Ÿæˆçš„åºåˆ—ä¸º{ a, a, b, a, c, a, a}ï¼Œè½¬å‘ç»™åç«¯açš„5ä¸ªè¯·æ±‚ç°åœ¨åˆ†æ•£å¼€æ¥ï¼Œä¸å†æ˜¯è¿ç»­çš„ã€‚è¿™æ ·ï¼Œæ¯æ”¶åˆ°7ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä¼šæŠŠå…¶ä¸­çš„1ä¸ªè½¬å‘ç»™åç«¯aï¼ŒæŠŠå…¶ä¸­çš„2ä¸ªè½¬å‘ç»™åç«¯bï¼ŒæŠŠå…¶ä¸­çš„4ä¸ªè½¬å‘ç»™åç«¯cã€‚æ”¶åˆ°çš„ç¬¬8ä¸ªè¯·æ±‚ï¼Œé‡æ–°ä»è¯¥åºåˆ—çš„å¤´éƒ¨å¼€å§‹è½®è¯¢ã€‚<ul>
<li>æ™®é€šåŠ æƒè½®è¯¢æ³•</li>
<li><a href="#è´Ÿè½½å‡è¡¡çš„å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•æ€ä¹ˆå®ç°">å¹³æ»‘åŠ æƒè½®è¯¢æ³•</a></li>
</ul>
</li>
<li>åŠ æƒéšæœºæ³•<br>  ä¸åŠ æƒè½®è¯¢æ³•ä¸€æ ·ï¼ŒåŠ æƒéšæœºæ³•ä¹Ÿæ ¹æ®åç«¯æœºå™¨çš„é…ç½®ï¼Œç³»ç»Ÿçš„è´Ÿè½½åˆ†é…ä¸åŒçš„æƒé‡ã€‚ä¸åŒçš„æ˜¯ï¼Œå®ƒæ˜¯æŒ‰ç…§æƒé‡éšæœºè¯·æ±‚åç«¯æœåŠ¡å™¨ï¼Œè€Œéé¡ºåºã€‚</li>
<li>æœ€å°è¿æ¥æ•°æ³•<br>  æœ€å°è¿æ¥æ•°ç®—æ³•æ¯”è¾ƒçµæ´»å’Œæ™ºèƒ½ï¼Œç”±äºåç«¯æœåŠ¡å™¨çš„é…ç½®ä¸å°½ç›¸åŒï¼Œå¯¹äºè¯·æ±‚çš„å¤„ç†æœ‰å¿«æœ‰æ…¢ï¼Œå®ƒæ˜¯æ ¹æ®åç«¯æœåŠ¡å™¨å½“å‰çš„è¿æ¥æƒ…å†µï¼ŒåŠ¨æ€åœ°é€‰å–å…¶ä¸­å½“å‰ç§¯å‹è¿æ¥æ•°æœ€å°‘çš„ä¸€å°æœåŠ¡å™¨æ¥å¤„ç†å½“å‰çš„è¯·æ±‚ï¼Œå°½å¯èƒ½åœ°æé«˜åç«¯æœåŠ¡çš„åˆ©ç”¨æ•ˆç‡ï¼Œå°†è´Ÿè´£åˆç†åœ°åˆ†æµåˆ°æ¯ä¸€å°æœåŠ¡å™¨ã€‚</li>
</ol>
<h3 id="è´Ÿè½½å‡è¡¡çš„å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•æ€ä¹ˆå®ç°"><a href="#è´Ÿè½½å‡è¡¡çš„å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•æ€ä¹ˆå®ç°" class="headerlink" title="è´Ÿè½½å‡è¡¡çš„å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•æ€ä¹ˆå®ç°"></a>è´Ÿè½½å‡è¡¡çš„å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•æ€ä¹ˆå®ç°</h3><p>å½“æˆ‘ä»¬éœ€è¦æŠŠä¸€ä»½æ•°æ®å‘é€åˆ°ä¸€ä¸ªSetä¸­çš„ä»»æ„æœºå™¨çš„æ—¶å€™ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚ä½•æŒ‘Setä¸­çš„æœºå™¨ä½œä¸ºæ•°æ®çš„æ¥æ”¶æ–¹ï¼Ÿæ˜¾ç„¶ç®—æ³•éœ€è¦ç¬¦åˆä»¥ä¸‹è¦æ±‚ï¼š</p>
<ul>
<li>æ”¯æŒåŠ æƒï¼Œä»¥ä¾¿åœ¨æœºå™¨æ•…éšœæ—¶å¯ä»¥é™ä½å…¶æƒé‡</li>
<li>åœ¨åŠ æƒçš„å‰æä¸‹ï¼Œå°½å¯èƒ½åœ°æŠŠè¯·æ±‚å¹³æ‘Šåˆ°æ¯å°æœºå™¨ä¸Š</li>
</ul>
<p>ç¬¬ä¸€ç‚¹å¾ˆå¥½ç†è§£ï¼Œè€Œç¬¬äºŒç‚¹çš„æ„æ€æ˜¯ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬ç°åœ¨æœ‰a, b, cä¸‰ä¸ªé€‰æ‹©ï¼Œæƒé‡åˆ†åˆ«æ˜¯5, 1, 1ï¼Œæˆ‘ä»¬å¸Œæœ›è¾“å‡ºçš„ç»“æœæ˜¯ç±»ä¼¼äºa, a, b, a, c, a, aï¼Œè€Œä¸æ˜¯a, a, a, a, a, b, cã€‚</p>
<p>ä»Githubä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼ŒNginxä»¥å‰ä¹Ÿæ˜¯ä½¿ç”¨å’ŒLVSç±»ä¼¼çš„ç®—æ³•ï¼Œå¹¶åœ¨æŸä¸€æ¬¡æäº¤ä¸­ä¿®æ”¹ä¸ºå½“å‰çš„ç®—æ³•ï¼Œè¯¥ç®—æ³•å¤§è‡´æ€æƒ³å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Upstream: smooth weighted round-robin balancing.</span><br><span class="line"></span><br><span class="line">For edge case weights like &#123; 5, 1, 1 &#125; we now produce &#123; a, a, b, a, c, a, a &#125;</span><br><span class="line">sequence instead of &#123; c, b, a, a, a, a, a &#125; produced previously.</span><br><span class="line"></span><br><span class="line">Algorithm is as follows: on each peer selection we increase current_weight</span><br><span class="line">of each eligible peer by its weight, select peer with greatest current_weight</span><br><span class="line">and reduce its current_weight by total number of weight points distributed</span><br><span class="line">among peers.</span><br><span class="line"></span><br><span class="line">In case of &#123; 5, 1, 1 &#125; weights this gives the following sequence of</span><br><span class="line">current_weight&apos;s:</span><br><span class="line"></span><br><span class="line">     a  b  c</span><br><span class="line">     0  0  0  (initial state)</span><br><span class="line"></span><br><span class="line">     5  1  1  (a selected)</span><br><span class="line">    -2  1  1</span><br><span class="line"></span><br><span class="line">     3  2  2  (a selected)</span><br><span class="line">    -4  2  2</span><br><span class="line"></span><br><span class="line">     1  3  3  (b selected)</span><br><span class="line">     1 -4  3</span><br><span class="line"></span><br><span class="line">     6 -3  4  (a selected)</span><br><span class="line">    -1 -3  4</span><br><span class="line"></span><br><span class="line">     4 -2  5  (c selected)</span><br><span class="line">     4 -2 -2</span><br><span class="line"></span><br><span class="line">     9 -1 -1  (a selected)</span><br><span class="line">     2 -1 -1</span><br><span class="line"></span><br><span class="line">     7  0  0  (a selected)</span><br><span class="line">     0  0  0</span><br></pre></td></tr></table></figure></p>
<p>è¯¥ç®—æ³•é™¤äº†æœ‰æƒé‡weightï¼Œè¿˜å¼•å…¥äº†å¦ä¸€ä¸ªå˜é‡current_weightï¼Œåœ¨æ¯ä¸€æ¬¡éå†ä¸­ä¼šæŠŠcurrent_weightåŠ ä¸Šweightçš„å€¼ï¼Œå¹¶é€‰æ‹©current_weightæœ€å¤§çš„å…ƒç´ ï¼Œå¯¹äºè¢«é€‰æ‹©çš„å…ƒç´ ï¼Œå†æŠŠcurrent_weightå‡å»æ‰€æœ‰æƒé‡ä¹‹å’Œã€‚</p>
<p>å‡è®¾æœ‰ N å°æœåŠ¡å™¨ S = {S0, S1, S2, â€¦, Sn}ï¼Œé»˜è®¤æƒé‡ä¸º W = {W0, W1, W2, â€¦, Wn}ï¼Œå½“å‰æƒé‡ä¸º CW = {CW0, CW1, CW2, â€¦, CWn}ã€‚åœ¨è¯¥ç®—æ³•ä¸­æœ‰ä¸¤ä¸ªæƒé‡ï¼Œé»˜è®¤æƒé‡è¡¨ç¤ºæœåŠ¡å™¨çš„åŸå§‹æƒé‡ï¼Œå½“å‰æƒé‡è¡¨ç¤ºæ¯æ¬¡è®¿é—®åé‡æ–°è®¡ç®—çš„æƒé‡ï¼Œå½“å‰æƒé‡çš„å‡ºåˆå§‹å€¼ä¸ºé»˜è®¤æƒé‡å€¼ï¼Œå½“å‰æƒé‡å€¼æœ€å¤§çš„æœåŠ¡å™¨ä¸º maxWeightServerï¼Œæ‰€æœ‰é»˜è®¤æƒé‡ä¹‹å’Œä¸º weightSumï¼ŒæœåŠ¡å™¨åˆ—è¡¨ä¸º serverListï¼Œç®—æ³•å¯ä»¥æè¿°ä¸ºï¼š</p>
<ol>
<li>æ‰¾å‡ºå½“å‰æƒé‡å€¼æœ€å¤§çš„æœåŠ¡å™¨ maxWeightServerï¼›</li>
<li>è®¡ç®— {W0, W1, W2, â€¦, Wn} ä¹‹å’Œ weightSumï¼›</li>
<li>å°† maxWeightServer.CW = maxWeightServer.CW - weightSumï¼›</li>
<li>é‡æ–°è®¡ç®— {S0, S1, S2, â€¦, Sn} çš„å½“å‰æƒé‡ CWï¼Œè®¡ç®—å…¬å¼ä¸º Sn.CW = Sn.CW + Sn.Wn</li>
<li>è¿”å› maxWeightServer</li>
</ol>
<h2 id="æœåŠ¡å‘ç°æ˜¯æ€ä¹ˆå®ç°çš„"><a href="#æœåŠ¡å‘ç°æ˜¯æ€ä¹ˆå®ç°çš„" class="headerlink" title="æœåŠ¡å‘ç°æ˜¯æ€ä¹ˆå®ç°çš„"></a>æœåŠ¡å‘ç°æ˜¯æ€ä¹ˆå®ç°çš„</h2><p><a href="https://www.infoq.cn/article/etcd-interpretation-application-scenario-implement-principle" target="_blank" rel="noopener">å‚è€ƒ</a>  </p>
<p>æˆ‘ä»¬å¯ä»¥è€ƒè™‘ç”¨etcdæ¥åš,<br>æœåŠ¡å‘ç°è¦è§£å†³çš„ä¹Ÿæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æœ€å¸¸è§çš„é—®é¢˜ä¹‹ä¸€ï¼Œå³åœ¨åŒä¸€ä¸ªåˆ†å¸ƒå¼é›†ç¾¤ä¸­çš„è¿›ç¨‹æˆ–æœåŠ¡ï¼Œè¦å¦‚ä½•æ‰èƒ½æ‰¾åˆ°å¯¹æ–¹å¹¶å»ºç«‹è¿æ¥ã€‚æœ¬è´¨ä¸Šæ¥è¯´ï¼ŒæœåŠ¡å‘ç°å°±æ˜¯æƒ³è¦äº†è§£é›†ç¾¤ä¸­æ˜¯å¦æœ‰è¿›ç¨‹åœ¨ç›‘å¬ udp æˆ– tcp ç«¯å£ï¼Œå¹¶ä¸”é€šè¿‡åå­—å°±å¯ä»¥æŸ¥æ‰¾å’Œè¿æ¥ã€‚è¦è§£å†³æœåŠ¡å‘ç°çš„é—®é¢˜ï¼Œéœ€è¦æœ‰ä¸‹é¢ä¸‰å¤§æ”¯æŸ±ï¼Œç¼ºä¸€ä¸å¯ã€‚</p>
<ol>
<li><strong>ä¸€ä¸ªå¼ºä¸€è‡´æ€§ã€é«˜å¯ç”¨çš„æœåŠ¡å­˜å‚¨ç›®å½•</strong>ã€‚åŸºäº Raft ç®—æ³•çš„ etcd å¤©ç”Ÿå°±æ˜¯è¿™æ ·ä¸€ä¸ªå¼ºä¸€è‡´æ€§é«˜å¯ç”¨çš„æœåŠ¡å­˜å‚¨ç›®å½•ã€‚</li>
<li><strong>ä¸€ç§æä¾›æ–¹çš„æ³¨å†ŒæœåŠ¡</strong>ã€‚æä¾›æ–¹å¯ä»¥åœ¨ etcd ä¸­æ³¨å†ŒæœåŠ¡ï¼Œå¹¶ä¸”å¯¹æ³¨å†Œçš„æœåŠ¡è®¾ç½®<code>key TTL</code>ï¼Œå®šæ—¶ä¿æŒæœåŠ¡çš„å¿ƒè·³ä»¥è¾¾åˆ°ç›‘æ§å¥åº·çŠ¶æ€çš„æ•ˆæœ, æ¯”å¦‚æ¯éš” 30s å‘é€ä¸€æ¬¡å¿ƒè·³è®¾ç½®ä¸€ä¸‹è¿™ä¸ª<code>key</code>ä½¿ä»£è¡¨è¯¥æœºå™¨å­˜æ´»çš„èŠ‚ç‚¹ç»§ç»­å­˜åœ¨ï¼Œå¦åˆ™å½“etcd æ²¡æœ‰æ£€æµ‹åˆ°å¿ƒè·³è¿™ä¸ª<code>key</code>çš„ttlåˆ°äº†è¿‡æœŸäº†å°±ä¼šæŠŠè¿™ä¸ªé”®å€¼å¯¹åˆ äº†</li>
<li><strong>éœ€æ±‚æ–¹å¯ä»¥å³æ—¶æ›´æ–°æä¾›æ–¹æœåŠ¡çŠ¶æ€çš„æœºåˆ¶</strong>.éœ€æ±‚æ–¹é€šè¿‡watchæœºåˆ¶ç›‘å¬è‡ªå·±éœ€è¦ç”¨åˆ°çš„æä¾›æ–¹ä¿¡æ¯çš„æ”¹åŠ¨ï¼Œæä¾›æ–¹ç›¸å…³ä¿¡æ¯æœ‰å˜åŠ¨çš„æ—¶å€™éœ€æ±‚æ–¹å°±ä¼šæ”¶åˆ°æ¶ˆæ¯,åœ¨æ¥æ”¶åˆ°ä¿¡æ¯å˜åŠ¨çš„æ—¶å€™ç«‹å³ä»etcdè·å–ç›¸åº”æœ€æ–°çš„ä¿¡æ¯å³å¯, å®ç°æ–¹å¼é€šå¸¸æ˜¯è¿™æ ·ï¼šä¸åŒç³»ç»Ÿéƒ½åœ¨ etcd ä¸Šå¯¹åŒä¸€ä¸ªç›®å½•è¿›è¡Œæ³¨å†Œï¼ŒåŒæ—¶è®¾ç½® Watcher è§‚æµ‹è¯¥ç›®å½•çš„å˜åŒ–ï¼ˆå¦‚æœå¯¹å­ç›®å½•çš„å˜åŒ–ä¹Ÿæœ‰éœ€è¦ï¼Œå¯ä»¥è®¾ç½®é€’å½’æ¨¡å¼ï¼‰ï¼Œå½“æŸä¸ªç³»ç»Ÿæ›´æ–°äº† etcd çš„ç›®å½•ï¼Œé‚£ä¹ˆè®¾ç½®äº† Watcher çš„ç³»ç»Ÿå°±ä¼šæ”¶åˆ°é€šçŸ¥ï¼Œå¹¶ä½œå‡ºç›¸åº”å¤„ç†ã€‚<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/etcd/service_discovery.png" alt="æœåŠ¡å‘ç°ç¤ºæ„å›¾"><br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/etcd/1beabef5a1168cdc43766903e65f907d.jpg" alt="æœåŠ¡å‘ç°ç¤ºæ„å›¾"></li>
</ol>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹æœåŠ¡å‘ç°å¯¹åº”çš„å…·ä½“åœºæ™¯ã€‚<br><strong>å¾®æœåŠ¡ååŒå·¥ä½œæ¶æ„ä¸­ï¼ŒæœåŠ¡åŠ¨æ€æ·»åŠ </strong>ã€‚éšç€ Docker å®¹å™¨çš„æµè¡Œï¼Œå¤šç§å¾®æœåŠ¡å…±åŒåä½œï¼Œæ„æˆä¸€ä¸ªç›¸å¯¹åŠŸèƒ½å¼ºå¤§çš„æ¶æ„çš„æ¡ˆä¾‹è¶Šæ¥è¶Šå¤šã€‚é€æ˜åŒ–çš„åŠ¨æ€æ·»åŠ è¿™äº›æœåŠ¡çš„éœ€æ±‚ä¹Ÿæ—¥ç›Šå¼ºçƒˆã€‚é€šè¿‡æœåŠ¡å‘ç°æœºåˆ¶ï¼Œåœ¨ etcd ä¸­æ³¨å†ŒæŸä¸ªæœåŠ¡åå­—çš„ç›®å½•ï¼Œåœ¨è¯¥ç›®å½•ä¸‹å­˜å‚¨å¯ç”¨çš„æœåŠ¡èŠ‚ç‚¹çš„ IPã€‚åœ¨ä½¿ç”¨æœåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œåªè¦ä»æœåŠ¡ç›®å½•ä¸‹æŸ¥æ‰¾å¯ç”¨çš„æœåŠ¡èŠ‚ç‚¹å»ä½¿ç”¨å³å¯ã€‚<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/etcd/e7d6918c1c9b7c9f2829779966ffb5d8.jpg" alt="å¾®æœåŠ¡ååŒå·¥ä½œ"></p>
<h2 id="ç†”æ–­æ˜¯æ€ä¹ˆå®ç°çš„"><a href="#ç†”æ–­æ˜¯æ€ä¹ˆå®ç°çš„" class="headerlink" title="ç†”æ–­æ˜¯æ€ä¹ˆå®ç°çš„"></a>ç†”æ–­æ˜¯æ€ä¹ˆå®ç°çš„</h2><p>ä»€ä¹ˆæ˜¯æœåŠ¡ç†”æ–­å‘¢ï¼Ÿ æœåŠ¡ç†”æ–­ï¼šå½“ä¸‹æ¸¸çš„æœåŠ¡å› ä¸ºæŸç§åŸå› çªç„¶<strong>å˜å¾—ä¸å¯ç”¨</strong>æˆ–<strong>å“åº”è¿‡æ…¢</strong>ï¼Œä¸Šæ¸¸æœåŠ¡ä¸ºäº†ä¿è¯è‡ªå·±æ•´ä½“æœåŠ¡çš„å¯ç”¨æ€§ï¼Œä¸å†ç»§ç»­è°ƒç”¨ç›®æ ‡æœåŠ¡ï¼Œç›´æ¥è¿”å›ï¼Œå¿«é€Ÿé‡Šæ”¾èµ„æºã€‚å¦‚æœç›®æ ‡æœåŠ¡æƒ…å†µå¥½è½¬åˆ™æ¢å¤è°ƒç”¨ã€‚ éœ€è¦è¯´æ˜çš„æ˜¯ç†”æ–­å…¶å®æ˜¯ä¸€ä¸ªæ¡†æ¶çº§çš„å¤„ç†ï¼Œé‚£ä¹ˆè¿™å¥—ç†”æ–­æœºåˆ¶çš„è®¾è®¡ï¼ŒåŸºæœ¬ä¸Šä¸šå†…ç”¨çš„æ˜¯<code>æ–­è·¯å™¨æ¨¡å¼</code>:</p>
<ul>
<li>æœ€å¼€å§‹å¤„äº<code>closed</code>çŠ¶æ€ï¼Œä¸€æ—¦æ£€æµ‹åˆ°é”™è¯¯åˆ°è¾¾ä¸€å®šé˜ˆå€¼ï¼Œä¾¿è½¬ä¸º<code>open</code>çŠ¶æ€ï¼›</li>
<li>è¿™æ—¶å€™ä¼šæœ‰ä¸ª reset timeoutï¼Œåˆ°äº†è¿™ä¸ªæ—¶é—´äº†ï¼Œä¼šè½¬ç§»åˆ°<code>half open</code>çŠ¶æ€ï¼›</li>
<li>å°è¯•æ”¾è¡Œä¸€éƒ¨åˆ†è¯·æ±‚åˆ°åç«¯ï¼Œä¸€æ—¦æ£€æµ‹æˆåŠŸä¾¿å›å½’åˆ°<code>closed</code>çŠ¶æ€ï¼Œå³æ¢å¤æœåŠ¡ï¼›</li>
</ul>
<p>ä¸šå†…ç›®å‰æµè¡Œçš„ç†”æ–­å™¨å¾ˆå¤šï¼Œä¾‹å¦‚é˜¿é‡Œå‡ºçš„ <code>Sentinel</code>, ä»¥åŠæœ€å¤šäººä½¿ç”¨çš„ <code>Hystrix</code> åœ¨ <code>Hystrix</code> ä¸­ï¼Œå¯¹åº”é…ç½®å¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//æ»‘åŠ¨çª—å£çš„å¤§å°ï¼Œé»˜è®¤ä¸º20</span><br><span class="line">circuitBreaker.requestVolumeThreshold </span><br><span class="line">//è¿‡å¤šé•¿æ—¶é—´ï¼Œç†”æ–­å™¨å†æ¬¡æ£€æµ‹æ˜¯å¦å¼€å¯ï¼Œé»˜è®¤ä¸º5000ï¼Œå³5sé’Ÿ</span><br><span class="line">circuitBreaker.sleepWindowInMilliseconds </span><br><span class="line">//é”™è¯¯ç‡ï¼Œé»˜è®¤50%</span><br><span class="line">circuitBreaker.errorThresholdPercentage</span><br></pre></td></tr></table></figure></p>
<p>æ¯å½“ 20 ä¸ªè¯·æ±‚ä¸­ï¼Œæœ‰ 50% å¤±è´¥æ—¶ï¼Œç†”æ–­å™¨å°±ä¼šæ‰“å¼€ï¼Œæ­¤æ—¶å†è°ƒç”¨æ­¤æœåŠ¡ï¼Œå°†ä¼šç›´æ¥è¿”å›å¤±è´¥ï¼Œä¸å†è°ƒè¿œç¨‹æœåŠ¡ã€‚ç›´åˆ° 5s é’Ÿä¹‹åï¼Œé‡æ–°æ£€æµ‹è¯¥è§¦å‘æ¡ä»¶ï¼Œåˆ¤æ–­æ˜¯å¦æŠŠç†”æ–­å™¨å…³é—­ï¼Œæˆ–è€…ç»§ç»­æ‰“å¼€ã€‚<br>è¿™äº›å±äºæ¡†æ¶å±‚çº§çš„å®ç°ï¼Œæˆ‘ä»¬åªè¦å®ç°å¯¹åº”æ¥å£å°±å¥½ï¼</p>
<h2 id="æœåŠ¡é™çº§"><a href="#æœåŠ¡é™çº§" class="headerlink" title="æœåŠ¡é™çº§"></a>æœåŠ¡é™çº§</h2><ul>
<li><strong>é™çº§çš„æœ¬è´¨</strong>:  <ul>
<li>é™çº§å°±æ˜¯ä¸ºäº†è§£å†³èµ„æºä¸è¶³å’Œè®¿é—®é‡å¢åŠ çš„çŸ›ç›¾</li>
<li>åœ¨æœ‰é™çš„èµ„æºæƒ…å†µä¸‹ï¼Œä¸ºäº†èƒ½æŠ—ä½å¤§é‡çš„è¯·æ±‚ï¼Œå°±éœ€è¦å¯¹ç³»ç»Ÿåšå‡ºä¸€äº›ç‰ºç‰²ï¼Œæœ‰ç‚¹â€œå¼ƒå’ä¿å¸…â€çš„æ„æ€ã€‚æ”¾å¼ƒä¸€äº›åŠŸèƒ½ï¼Œä¿è¯æ•´ä¸ªç³»ç»Ÿèƒ½å¹³ç¨³è¿è¡Œ</li>
</ul>
</li>
<li><strong>é™çº§ç‰ºç‰²çš„æ˜¯</strong>: <ul>
<li>å¼ºä¸€è‡´æ€§å˜æˆæœ€ç»ˆä¸€è‡´æ€§<ul>
<li>å¤§å¤šæ•°çš„ç³»ç»Ÿæ˜¯ä¸éœ€è¦å¼ºä¸€è‡´æ€§çš„ã€‚</li>
<li>å¼ºä¸€è‡´æ€§å°±è¦æ±‚å¤šç§èµ„æºçš„å ç”¨ï¼Œå‡å°‘å¼ºä¸€è‡´æ€§å°±èƒ½é‡Šæ”¾æ›´å¤šèµ„æº</li>
<li>è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸€èˆ¬åˆ©ç”¨æ¶ˆæ¯ä¸­é—´ä»¶æ¥å‰Šå³°å¡«è°·ï¼Œå˜å¼ºä¸€è‡´æ€§ä¸ºæœ€ç»ˆä¸€è‡´æ€§ï¼Œä¹Ÿèƒ½è¾¾åˆ°æ•ˆæœ</li>
</ul>
</li>
<li>å¹²æ‰ä¸€äº›æ¬¡è¦åŠŸèƒ½<ul>
<li>åœæ­¢è®¿é—®ä¸é‡è¦çš„åŠŸèƒ½ï¼Œä»è€Œé‡Šæ”¾å‡ºæ›´å¤šçš„èµ„æº</li>
<li>ä¸¾ä¾‹æ¥è¯´ï¼Œæ¯”å¦‚ç”µå•†ç½‘ç«™ï¼Œè¯„è®ºåŠŸèƒ½æµé‡å¤§çš„æ—¶å€™å°±èƒ½åœæ‰ï¼Œå½“ç„¶èƒ½ä¸ç›´æ¥å¹²æ‰å°±åˆ«ç›´æ¥ï¼Œæœ€å¥½èƒ½ç®€åŒ–æµç¨‹æˆ–è€…é™æµæœ€å¥½ç®€åŒ–åŠŸèƒ½æµç¨‹ã€‚æŠŠä¸€äº›åŠŸèƒ½ç®€åŒ–æ‰</li>
</ul>
</li>
</ul>
</li>
<li><strong>é™çº§çš„æ³¨æ„ç‚¹</strong>:<ul>
<li>å¯¹ä¸šåŠ¡è¿›è¡Œä»”ç»†çš„æ¢³ç†å’Œåˆ†æ<ul>
<li>å“ªäº›æ˜¯æ ¸å¿ƒæµç¨‹å¿…é¡»ä¿è¯çš„ï¼Œå“ªäº›æ˜¯å¯ä»¥ç‰ºç‰²çš„</li>
</ul>
</li>
<li>ä»€ä¹ˆæŒ‡æ ‡ä¸‹èƒ½è¿›è¡Œé™çº§<ul>
<li>ååé‡ã€å“åº”æ—¶é—´ã€å¤±è´¥æ¬¡æ•°ç­‰è¾¾åˆ°ä¸€ä¸ªé˜ˆå€¼æ‰è¿›è¡Œé™çº§å¤„ç†</li>
</ul>
</li>
</ul>
</li>
<li><strong>å¦‚ä½•é™çº§</strong>:<ul>
<li>é™çº§æœ€ç®€å•çš„å°±æ˜¯åœ¨ä¸šåŠ¡ä»£ç ä¸­é…ç½®ä¸€ä¸ªå¼€å…³æˆ–è€…åšæˆé…ç½®ä¸­å¿ƒæ¨¡å¼ï¼Œç›´æ¥åœ¨é…ç½®ä¸­å¿ƒä¸Šæ›´æ”¹é…ç½®ï¼Œæ¨é€åˆ°ç›¸åº”çš„æœåŠ¡ã€‚</li>
</ul>
</li>
</ul>
<h2 id="é™æµ"><a href="#é™æµ" class="headerlink" title="é™æµ"></a>é™æµ</h2><p>é™æµå°±æ˜¯é€šè¿‡å¯¹å¹¶å‘è®¿é—®è¿›è¡Œé™é€Ÿã€‚é™æµçš„å®ç°æ–¹å¼: </p>
<ul>
<li>è®¡æ•°å™¨:<br>  æœ€ç®€å•çš„å®ç°æ–¹å¼ ï¼Œç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ¥ä¸€ä¸ªè¯·æ±‚è®¡æ•°åŠ ä¸€ï¼Œè¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œç›´æ¥æ‹’ç»è¯·æ±‚ã€‚<br>  ä¸€èˆ¬å®è·µä¸­ç”¨ ngnix + lua + redis è¿™ç§æ–¹å¼ï¼Œredis å­˜è®¡æ•°å€¼</li>
<li>æ¼æ–—æ¨¡å¼:<br>  æµé‡å°±åƒè¿›å…¥æ¼æ–—ä¸­çš„æ°´ä¸€æ ·ï¼Œè€Œå‡ºå»çš„æ°´å’Œæˆ‘ä»¬ç³»ç»Ÿå¤„ç†çš„è¯·æ±‚ä¸€æ ·ï¼Œå½“æµé‡å¤§äºæ¼æ–—çš„æµå‡ºé€Ÿåº¦ï¼Œå°±ä¼šå‡ºç°ç§¯æ°´ï¼Œæ°´å¤šäº†ä¼šæº¢å‡º,<br>  æ¼æ–—å¾ˆå¤šæ˜¯ç”¨ä¸€ä¸ªé˜Ÿåˆ—å®ç°çš„ï¼Œå½“æµé‡è¿‡å¤šæ—¶ï¼Œé˜Ÿåˆ—ä¼šå‡ºç°ç§¯å‹ï¼Œé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™å¼€å§‹æ‹’ç»è¯·æ±‚ã€‚</li>
<li>ä»¤ç‰Œæ¡¶:<br>  çœ‹å›¾ä¾‹ï¼Œä»¤ç‰Œé€šå’Œæ¼æ–—æ¨¡å¼å¾ˆåƒï¼Œä¸»è¦çš„åŒºåˆ«æ˜¯å¢åŠ äº†ä¸€ä¸ªä¸­é—´äººï¼Œè¿™ä¸ªä¸­é—´äººæŒ‰ç…§ä¸€å®šçš„é€Ÿç‡æ”¾å…¥ä¸€äº›tokenï¼Œç„¶åï¼Œå¤„ç†è¯·æ±‚æ—¶ï¼Œéœ€è¦å…ˆæ‹¿åˆ°tokenæ‰èƒ½å¤„ç†ï¼Œå¦‚æœæ¡¶é‡Œæ²¡æœ‰tokenå¯ä»¥è·å–ï¼Œåˆ™ä¸è¿›è¡Œå¤„ç†ã€‚</li>
</ul>
<h2 id="ç†”æ–­-é™çº§-é™æµä¸‰è€…çš„å…³ç³»"><a href="#ç†”æ–­-é™çº§-é™æµä¸‰è€…çš„å…³ç³»" class="headerlink" title="ç†”æ–­-é™çº§-é™æµä¸‰è€…çš„å…³ç³»"></a>ç†”æ–­-é™çº§-é™æµä¸‰è€…çš„å…³ç³»</h2><ul>
<li>ç†”æ–­å¼ºè°ƒçš„æ˜¯æœåŠ¡ä¹‹é—´çš„è°ƒç”¨èƒ½å®ç°è‡ªæˆ‘æ¢å¤çš„çŠ¶æ€ï¼›</li>
<li>é™æµæ˜¯ä»ç³»ç»Ÿçš„æµé‡å…¥å£è€ƒè™‘ï¼Œä»è¿›å…¥çš„æµé‡ä¸Šè¿›è¡Œé™åˆ¶ï¼Œè¾¾åˆ°ä¿æŠ¤ç³»ç»Ÿçš„ä½œç”¨ï¼›</li>
<li>é™çº§ï¼Œæ˜¯ä»ç³»ç»Ÿå†…éƒ¨çš„å¹³çº§æœåŠ¡æˆ–è€…ä¸šåŠ¡çš„ç»´åº¦è€ƒè™‘ï¼Œæµé‡å¤§äº†ï¼Œå¯ä»¥å¹²æ‰ä¸€äº›ï¼Œä¿æŠ¤å…¶ä»–æ­£å¸¸ä½¿ç”¨ï¼›</li>
</ul>
<p>ç†”æ–­æ˜¯é™çº§æ–¹å¼çš„ä¸€ç§ï¼›<br>é™çº§åˆæ˜¯é™æµçš„ä¸€ç§æ–¹å¼ï¼›<br>ä¸‰è€…éƒ½æ˜¯ä¸ºäº†é€šè¿‡ä¸€å®šçš„æ–¹å¼å»ä¿æŠ¤æµé‡è¿‡å¤§æ—¶ï¼Œä¿æŠ¤ç³»ç»Ÿçš„æ‰‹æ®µã€‚</p>
<h2 id="idç”Ÿæˆå™¨å¦‚ä½•å®ç°å…¨å±€é€’å¢"><a href="#idç”Ÿæˆå™¨å¦‚ä½•å®ç°å…¨å±€é€’å¢" class="headerlink" title="idç”Ÿæˆå™¨å¦‚ä½•å®ç°å…¨å±€é€’å¢"></a>idç”Ÿæˆå™¨å¦‚ä½•å®ç°å…¨å±€é€’å¢</h2><p><a href="https://tech.meituan.com/2017/04/21/mt-leaf.html" target="_blank" rel="noopener">å‚è€ƒ</a>  </p>
<p>ä»‹ç»ä¸€ä¸‹ç¾å›¢åœ¨ç”¨çš„å·¥ä¸šçº§ <strong>Leaf-snowflake æ–¹æ¡ˆ</strong>ã€‚<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/721ceeff.png" alt></p>
<ul>
<li>41-bitçš„æ—¶é—´æ˜¯æ¯«ç§’çº§æ—¶é—´, å¯ä»¥è¡¨ç¤º<code>(1L&lt;&lt;41)/(1000L*3600*24*365)=69</code>å¹´çš„æ—¶é—´ï¼Œ</li>
<li>10-bitæœºå™¨å¯ä»¥åˆ†åˆ«è¡¨ç¤º1024å°æœºå™¨ã€‚å¦‚æœæˆ‘ä»¬å¯¹IDCåˆ’åˆ†æœ‰éœ€æ±‚ï¼Œè¿˜å¯ä»¥å°†10-bitåˆ†5-bitç»™IDCï¼Œåˆ†5-bitç»™å·¥ä½œæœºå™¨ã€‚è¿™æ ·å°±å¯ä»¥è¡¨ç¤º32ä¸ªIDCï¼Œæ¯ä¸ªIDCä¸‹å¯ä»¥æœ‰32å°æœºå™¨ï¼Œå¯ä»¥æ ¹æ®è‡ªèº«éœ€æ±‚å®šä¹‰ã€‚</li>
<li>12ä¸ªè‡ªå¢åºåˆ—å·å¯ä»¥è¡¨ç¤º<code>2^12</code>ä¸ªIDï¼Œç†è®ºä¸Šsnowflakeæ–¹æ¡ˆçš„QPSçº¦ä¸º409.6w/sï¼Œ</li>
<li><p><strong>è¿™ç§åˆ†é…æ–¹å¼å¯ä»¥ä¿è¯åœ¨ä»»ä½•ä¸€ä¸ªIDCçš„ä»»ä½•ä¸€å°æœºå™¨åœ¨ä»»æ„æ¯«ç§’å†…ç”Ÿæˆçš„IDéƒ½æ˜¯ä¸åŒçš„</strong></p>
</li>
<li><p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ¯«ç§’æ•°åœ¨é«˜ä½ï¼Œè‡ªå¢åºåˆ—åœ¨ä½ä½ï¼Œæ•´ä¸ªIDéƒ½æ˜¯è¶‹åŠ¿é€’å¢çš„ã€‚</li>
<li>ä¸ä¾èµ–æ•°æ®åº“ç­‰ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼Œä»¥æœåŠ¡çš„æ–¹å¼éƒ¨ç½²ï¼Œç¨³å®šæ€§æ›´é«˜ï¼Œç”ŸæˆIDçš„æ€§èƒ½ä¹Ÿæ˜¯éå¸¸é«˜çš„ã€‚</li>
<li>å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹æ€§åˆ†é…bitä½ï¼Œéå¸¸çµæ´»ã€‚</li>
</ul>
</li>
<li>ç¼ºç‚¹ï¼šå¼ºä¾èµ–æœºå™¨æ—¶é’Ÿï¼Œå¦‚æœæœºå™¨ä¸Šæ—¶é’Ÿå›æ‹¨ï¼Œä¼šå¯¼è‡´å‘å·é‡å¤æˆ–è€…æœåŠ¡ä¼šå¤„äºä¸å¯ç”¨çŠ¶æ€ã€‚</li>
</ul>
<h3 id="è§£å†³æ—¶é’Ÿå›æ‹¨é—®é¢˜"><a href="#è§£å†³æ—¶é’Ÿå›æ‹¨é—®é¢˜" class="headerlink" title="è§£å†³æ—¶é’Ÿå›æ‹¨é—®é¢˜"></a>è§£å†³æ—¶é’Ÿå›æ‹¨é—®é¢˜</h3><p>è§£å†³æ–¹æ¡ˆ:   </p>
<ul>
<li>ç”±äºå¼ºä¾èµ–æ—¶é’Ÿï¼Œå¯¹æ—¶é—´çš„è¦æ±‚æ¯”è¾ƒæ•æ„Ÿï¼Œåœ¨æœºå™¨å·¥ä½œæ—¶ NTP åŒæ­¥ä¹Ÿä¼šé€ æˆç§’çº§åˆ«çš„å›é€€ï¼Œå»ºè®®å¯ä»¥ç›´æ¥å…³é—­ NTP åŒæ­¥ã€‚</li>
<li>åœ¨æ—¶é’Ÿå›æ‹¨çš„æ—¶å€™ç›´æ¥ä¸æä¾›æœåŠ¡ç›´æ¥è¿”å› ERROR_CODEï¼Œç­‰æ—¶é’Ÿè¿½ä¸Šå³å¯</li>
<li>åå·®åœ¨5ç§’ä¹‹å†…, æ¯”å¦‚å°±ç­‰å¾…2å€çš„åå·®æ—¶é—´(æ¯”å¦‚æ¯”ä¸Šæ¬¡çš„è¿˜å°3ç§’, é‚£æˆ‘å°±ç­‰6ç§’)ã€‚ç„¶ååšä¸€å±‚é‡è¯•, å¦‚æœè¿˜æ˜¯å°äºä¸Šæ¬¡çš„æ—¶é—´, å°±ä¸ŠæŠ¥æŠ¥è­¦ç³»ç»Ÿ</li>
<li>æ›´æˆ–è€…æ˜¯å‘ç°æœ‰æ—¶é’Ÿå›æ‹¨ä¹‹åè‡ªåŠ¨æ‘˜é™¤æœ¬èº«èŠ‚ç‚¹å¹¶æŠ¥è­¦</li>
</ul>
<p>ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å‘ç”Ÿäº†å›æ‹¨ï¼Œæ­¤åˆ»æ—¶é—´å°äºä¸Šæ¬¡å‘å·æ—¶é—´</span></span><br><span class="line"><span class="keyword">if</span> (timestamp &lt; lastTimestamp) &#123;</span><br><span class="line">    <span class="keyword">long</span> offset = lastTimestamp - timestamp;</span><br><span class="line">    <span class="keyword">if</span> (offset &lt;= <span class="number">5</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//æ—¶é—´åå·®å¤§å°å°äº5msï¼Œåˆ™ç­‰å¾…ä¸¤å€æ—¶é—´</span></span><br><span class="line">            wait(offset &lt;&lt; <span class="number">1</span>);<span class="comment">//wait</span></span><br><span class="line">            timestamp = timeGen();</span><br><span class="line">            <span class="keyword">if</span> (timestamp &lt; lastTimestamp) &#123;</span><br><span class="line">                <span class="comment">//è¿˜æ˜¯å°äºï¼ŒæŠ›å¼‚å¸¸å¹¶ä¸ŠæŠ¥</span></span><br><span class="line">                throwClockBackwardsEx(timestamp);</span><br><span class="line">              &#125;    </span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span>  e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//throw</span></span><br><span class="line">        throwClockBackwardsEx(timestamp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">//åˆ†é…ID</span></span><br></pre></td></tr></table></figure></p>
<p>ä»ä¸Šçº¿æƒ…å†µæ¥çœ‹ï¼Œåœ¨ 2017 å¹´é—°ç§’å‡ºç°é‚£ä¸€æ¬¡å‡ºç°è¿‡éƒ¨åˆ†æœºå™¨å›æ‹¨ï¼Œç”±äº Leaf-snowflake çš„ç­–ç•¥ä¿è¯ï¼ŒæˆåŠŸé¿å…äº†å¯¹ä¸šåŠ¡é€ æˆçš„å½±å“ã€‚<br>Leaf åœ¨ç¾å›¢ç‚¹è¯„å…¬å¸å†…éƒ¨æœåŠ¡åŒ…å«é‡‘èã€æ”¯ä»˜äº¤æ˜“ã€é¤é¥®ã€å¤–å–ã€é…’åº—æ—…æ¸¸ã€çŒ«çœ¼ç”µå½±ç­‰ä¼—å¤šä¸šåŠ¡çº¿ã€‚ç›®å‰ Leaf çš„æ€§èƒ½åœ¨ 4C8G çš„æœºå™¨ä¸Š QPS èƒ½å‹æµ‹åˆ°è¿‘ 5w/sï¼ŒTP999 1msï¼Œå·²ç»èƒ½å¤Ÿæ»¡è¶³å¤§éƒ¨åˆ†çš„ä¸šåŠ¡çš„éœ€æ±‚ã€‚æ¯å¤©æä¾›äº¿æ•°é‡çº§çš„è°ƒç”¨é‡ï¼Œä½œä¸ºå…¬å¸å†…éƒ¨å…¬å…±çš„åŸºç¡€æŠ€æœ¯è®¾æ–½ï¼Œå¿…é¡»ä¿è¯é«˜ SLA å’Œé«˜æ€§èƒ½çš„æœåŠ¡ï¼Œæˆ‘ä»¬ç›®å‰è¿˜ä»…ä»…è¾¾åˆ°äº†åŠæ ¼çº¿ï¼Œè¿˜æœ‰å¾ˆå¤šæé«˜çš„ç©ºé—´ã€‚</p>
<!-- 
**Leaf-snowflakeæ–¹æ¡ˆ**å®Œå…¨æ²¿ç”¨ snowflake æ–¹æ¡ˆçš„ bit ä½è®¾è®¡ï¼Œå³æ˜¯ â€œ1+41+10+12â€ çš„æ–¹å¼ç»„è£… ID å·ã€‚å¯¹äº workerID çš„åˆ†é…ï¼Œå½“æœåŠ¡é›†ç¾¤æ•°é‡è¾ƒå°çš„æƒ…å†µä¸‹ï¼Œå®Œå…¨å¯ä»¥æ‰‹åŠ¨é…ç½®ã€‚Leaf æœåŠ¡è§„æ¨¡è¾ƒå¤§ï¼ŒåŠ¨æ‰‹é…ç½®æˆæœ¬å¤ªé«˜ã€‚æ‰€ä»¥ä½¿ç”¨ Zookeeper æŒä¹…é¡ºåºèŠ‚ç‚¹çš„ç‰¹æ€§è‡ªåŠ¨å¯¹ snowflake èŠ‚ç‚¹é…ç½® wokerIDã€‚Leaf-snowflake æ˜¯æŒ‰ç…§ä¸‹é¢å‡ ä¸ªæ­¥éª¤å¯åŠ¨çš„ï¼š
1.  å¯åŠ¨ Leaf-snowflake æœåŠ¡ï¼Œè¿æ¥ Zookeeperï¼Œåœ¨ leaf_forever çˆ¶èŠ‚ç‚¹ä¸‹æ£€æŸ¥è‡ªå·±æ˜¯å¦å·²ç»æ³¨å†Œè¿‡ï¼ˆæ˜¯å¦æœ‰è¯¥é¡ºåºå­èŠ‚ç‚¹ï¼‰ã€‚
2.  å¦‚æœæœ‰æ³¨å†Œè¿‡ç›´æ¥å–å›è‡ªå·±çš„ workerIDï¼ˆzk é¡ºåºèŠ‚ç‚¹ç”Ÿæˆçš„ int ç±»å‹ ID å·ï¼‰ï¼Œå¯åŠ¨æœåŠ¡ã€‚
3.  å¦‚æœæ²¡æœ‰æ³¨å†Œè¿‡ï¼Œå°±åœ¨è¯¥çˆ¶èŠ‚ç‚¹ä¸‹é¢åˆ›å»ºä¸€ä¸ªæŒä¹…é¡ºåºèŠ‚ç‚¹ï¼Œåˆ›å»ºæˆåŠŸåå–å›é¡ºåºå·å½“åšè‡ªå·±çš„ workerID å·ï¼Œå¯åŠ¨æœåŠ¡ã€‚

![](/img/noodle_plan/distributed/a3f985a8.png)

#### å¼±ä¾èµ– ZooKeeper

é™¤äº†æ¯æ¬¡ä¼šå» ZK æ‹¿æ•°æ®ä»¥å¤–ï¼Œä¹Ÿä¼šåœ¨æœ¬æœºæ–‡ä»¶ç³»ç»Ÿä¸Šç¼“å­˜ä¸€ä¸ª workerID æ–‡ä»¶ã€‚å½“ ZooKeeper å‡ºç°é—®é¢˜ï¼Œæ°å¥½æœºå™¨å‡ºç°é—®é¢˜éœ€è¦é‡å¯æ—¶ï¼Œèƒ½ä¿è¯æœåŠ¡èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨ã€‚è¿™æ ·åšåˆ°äº†å¯¹ä¸‰æ–¹ç»„ä»¶çš„å¼±ä¾èµ–ã€‚ä¸€å®šç¨‹åº¦ä¸Šæé«˜äº† SLA


#### å¯åŠ¨æµç¨‹

å› ä¸ºè¿™ç§æ–¹æ¡ˆä¾èµ–æ—¶é—´ï¼Œå¦‚æœæœºå™¨çš„æ—¶é’Ÿå‘ç”Ÿäº†å›æ‹¨ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å¯èƒ½ç”Ÿæˆé‡å¤çš„ ID å·ï¼Œéœ€è¦è§£å†³æ—¶é’Ÿå›é€€çš„é—®é¢˜ã€‚
![](/img/noodle_plan/distributed/1453b4e9.png)

å‚è§ä¸Šå›¾æ•´ä¸ªå¯åŠ¨æµç¨‹å›¾ï¼ŒæœåŠ¡å¯åŠ¨æ—¶é¦–å…ˆæ£€æŸ¥è‡ªå·±æ˜¯å¦å†™è¿‡ ZooKeeper leaf_forever èŠ‚ç‚¹ï¼š
1.  è‹¥å†™è¿‡ï¼Œåˆ™ç”¨è‡ªèº«ç³»ç»Ÿæ—¶é—´ä¸ `leaf_forever/${self}` èŠ‚ç‚¹è®°å½•æ—¶é—´åšæ¯”è¾ƒï¼Œè‹¥å°äº `leaf_forever/${self}` æ—¶é—´åˆ™è®¤ä¸ºæœºå™¨æ—¶é—´å‘ç”Ÿäº†å¤§æ­¥é•¿å›æ‹¨ï¼ŒæœåŠ¡å¯åŠ¨å¤±è´¥å¹¶æŠ¥è­¦ã€‚
2.  è‹¥æœªå†™è¿‡ï¼Œè¯æ˜æ˜¯æ–°æœåŠ¡èŠ‚ç‚¹ï¼Œç›´æ¥åˆ›å»ºæŒä¹…èŠ‚ç‚¹ `leaf_forever/${self}`å¹¶å†™å…¥è‡ªèº«ç³»ç»Ÿæ—¶é—´ï¼Œæ¥ä¸‹æ¥ç»¼åˆå¯¹æ¯”å…¶ä½™ Leaf èŠ‚ç‚¹çš„ç³»ç»Ÿæ—¶é—´æ¥åˆ¤æ–­è‡ªèº«ç³»ç»Ÿæ—¶é—´æ˜¯å¦å‡†ç¡®ï¼Œå…·ä½“åšæ³•æ˜¯å– leaf_temporary ä¸‹çš„æ‰€æœ‰ä¸´æ—¶èŠ‚ç‚¹ (æ‰€æœ‰è¿è¡Œä¸­çš„ Leaf-snowflake èŠ‚ç‚¹) çš„æœåŠ¡ IPï¼šPortï¼Œç„¶åé€šè¿‡ RPC è¯·æ±‚å¾—åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ç³»ç»Ÿæ—¶é—´ï¼Œè®¡ç®— sum(time)/nodeSizeã€‚
3.  è‹¥ abs(ç³»ç»Ÿæ—¶é—´ - sum(time)/nodeSize ) < é˜ˆå€¼ï¼Œè®¤ä¸ºå½“å‰ç³»ç»Ÿæ—¶é—´å‡†ç¡®ï¼Œæ­£å¸¸å¯åŠ¨æœåŠ¡ï¼ŒåŒæ—¶å†™ä¸´æ—¶èŠ‚ç‚¹ leaf_temporary/${self} ç»´æŒç§Ÿçº¦ã€‚
4.  å¦åˆ™è®¤ä¸ºæœ¬æœºç³»ç»Ÿæ—¶é—´å‘ç”Ÿå¤§æ­¥é•¿åç§»ï¼Œå¯åŠ¨å¤±è´¥å¹¶æŠ¥è­¦ã€‚
5.  æ¯éš”ä¸€æ®µæ—¶é—´ (3s) ä¸ŠæŠ¥è‡ªèº«ç³»ç»Ÿæ—¶é—´å†™å…¥ `leaf_forever/${self}`ã€‚
 -->
<h1 id="æŒ–å‘"><a href="#æŒ–å‘" class="headerlink" title="æŒ–å‘"></a>æŒ–å‘</h1><ul>
<li>âœ“ ç†Ÿæ‚‰Python / ç†Ÿæ‚‰C++ / ä¼šç”¨Go </li>
<li>âœ“ ç†Ÿæ‚‰Linux  / ç†Ÿæ‚‰Redis / æŒæ¡MySQL / äº†è§£Nginx</li>
<li>âœ“ åˆ†å¸ƒå¼æ¶æ„è®¾è®¡ä¸å¼€å‘ç»éªŒ </li>
<li>âœ“ å¸¦é˜Ÿç®¡ç†ç»éªŒä¸€å¹´å¤š </li>
<li>âœ“ æŠ€æœ¯æ”¯æŒåŸ¹è®­åˆ†äº«ç»éªŒ </li>
<li>âœ“ æ€§èƒ½åˆ†æä¸ä¼˜åŒ–ç»éªŒ </li>
<li>âœ“ å¤šæ¬¾ä¸Šçº¿é¡¹ç›®çš„è¿è¥äº‹åŠ¡å¤„ç†ç»éªŒ </li>
<li>âœ“ å‰åç«¯ååŒå¼€å‘ç»éªŒ</li>
</ul>
<!-- â—¼ ç½‘æ˜“-çŒæ‰‹ä¹‹ç‹æ¸¸æˆé¡¹ç›®(2018.9-2020.9)  -->
<h2 id="çŒå¾·ä¹‹æ‰‹"><a href="#çŒå¾·ä¹‹æ‰‹" class="headerlink" title="çŒå¾·ä¹‹æ‰‹"></a>çŒå¾·ä¹‹æ‰‹</h2><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>ç½‘ç»œå»¶è¿Ÿ/æ—¶é—´è½®/äº‹ä»¶é©±åŠ¨æ¨¡å‹ä¸ç¡çœ æ¡ä»¶å˜é‡/ä¸å¡é¡¿gcè´Ÿè½½å‡è¡¡/ä¸­å¿ƒç®¡ç†è¿›ç¨‹æ— çŠ¶æ€å¤šç‚¹etcdåŸç†/é€šç”¨ç™»é™†æœå‡å°‘æ¸¸æˆæœèµ„æºå ç”¨/æ’é˜Ÿæœ/å®Œå–„æ–­çº¿é‡è¿å‰¥ç¦»namecard/</p>
<h3 id="å®¢æˆ·ç«¯è§’åº¦"><a href="#å®¢æˆ·ç«¯è§’åº¦" class="headerlink" title="å®¢æˆ·ç«¯è§’åº¦"></a>å®¢æˆ·ç«¯è§’åº¦</h3><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="http://www.plantuml.com/plantuml/svg/dPF1Qjj048RlUeevfc1R1PzgGY0nQLhQWa2-bM9sDukyTBKIkniRdKk2APHIA4aElHHwoCcN7f9BsgUHqhn5HxkLBJMcX-vfPdPc_cz6Ay9ifY4XAP_caXHSJvaKN5aW1bXmJ2oXn728Xq6WERD49P93Ok1r07XswLvrSrCjFrPVFkpKJSnSFt8t0ppEY0exonGiX9rXJv6nJ7DtqSVZZFqvgcXdth-xAfTdOzJdkWUnFQ71cxOmRGilBwlpYrgO4clbVqaVAYjiCO83rw47qKcUStiWrB6_SKalCqPaa-bXVLuFdigY1gq5EvnfYxFyiKB8yltNdTJycp7XSvnyst9YhkU28U0hOjbixNdijVi0W-HYmx4VFOSZOlc255s4kzjFvUdthcpvxHp3Tv-lgkNrhzNF-ulLpDhSZC8mUVAO98k14doWkENuE0OiIttHsUcMedLDNwW7PN_ZJeqVPeCDDVUV4RlSHvd4EdWscKGkWMiG2k8YpN6Z1OHmE8wxKqdn5jSaiqIe7fZXUcCCTllzFNpM8vYCeyQbwBuOHs4hX8GZS9l0I1s8XzuF0lmdN4fg0hencoXrPgT5wFlGxU7wqpMIpLA2zeAy-cy0">
<p>å…³ç³»å›¾å¦‚ä¸‹:<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="http://www.plantuml.com/plantuml/svg/bPHFQnD16CRlyoc6w7LP8I2wf84cWIeK36x4eqntnztHpSooEsd9JT13iRLwKamz6F4G4AfWfIcK-cMIRNBgL_2TcKtO3Jt4s_2yl_Tv_-pif7729CMtFT6DyGkIE2JnGjObajfA4fnoYT8SIccoopowmkLgYQB92kJJ4kD538nN6E99aI2q5F2jTjXFcKSYt3GyIN4JrseQhDTl95rJ7KWNI5CMq2BReLx8HII2FdxaKS8Lt6e0dKzITYxGRdKDQ7Ood9sUAy-OzDVWAvljXtWBr3tIhwYqhQUbh6BQPXn7CALaWkDASF-E3GwCMsRZEjdTLWeOBBzUkN3PuUuzEo7yfSby3ATr4w5qwYMKSckd5qLK6eU6Fl-FHzKawiMkcmHhxG9LchgjLrrqG4ri-MAFMtLOg8CVT3fj5y5g5w9Pb8DjqfDXAM2cW4XAkL-Ag0s17b3vJAqDeNnd1i2kWv_4lcfQoKXFLGn5WlZsDakbtQ9GWIBTzjBTmN1_8onun3Z5P5UMuws6Wnc7eINsXGT7AN2NfYa9Q8hWhbi92qAfGJsyigoQmNKhLY_EfHiwGN6n4oYhnWzPZ5140rW3ZkXpYQR7bvFBW-kB0Qhf1wFkO7Lv5mz0RV50W3xz_d7-UfHzUJTzEym3D04z6u-p_VT6dtuUAIFzQwkKas_P_jdLZvzeOmDblqTGPybDnaU5IfFpW_cdqwl1c_chmUJlyFhYSFhXCFjwDllpg_0p8UZRTFyF"></p>
<h3 id="å‘¨è¾¹æœåŠ¡è§’åº¦"><a href="#å‘¨è¾¹æœåŠ¡è§’åº¦" class="headerlink" title="å‘¨è¾¹æœåŠ¡è§’åº¦"></a>å‘¨è¾¹æœåŠ¡è§’åº¦</h3><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="http://www.plantuml.com/plantuml/svg/dLDDIyD04BtdLynH8TL3RoA5jjGl50lfJKGcoP0i9fkmkwtaB4WHn9jwyEBDa-UU_3Sj-2_Sx3PjGaNGERtPUPbvRxCJea8V9S5vGCW19QGPZp8dhCu5XKp2XGCwJaWnQT2E3WC62Kh5-XZ4v5okl_BQQqmg21r7KA2GHmb1LBNRzpkBsMmnVLoyFcn5c9ASYErc-s6Xuep33LEnriQo81Da2YqT1dGdUeumyElsVJwzwnDN95pmrDXlKiiHANACoF93lvv5g6X5qrvgYlswukdBukcvLEoZKic_D0-uOghOWvxfuC9mdEUaUeo7jc98frc0ISMqBYtFXOEaA1rM0_zgq0flManh5kUV7zhV_FvjAvM_sujeec_xfn_YaPYmG7ixGnN4gymwNgKR3gIjNAsqBW-QOZ5dQxNTuJ4i6pQ57cQ9fiFHQ3Gq11B0E7X5cclz1Up2eEyrfmlarouaMSIu2x9jzUd9vRnMgrE-wWhQBQaoioIEer_skkRNaxIUB6bcB_mQJZUnQVmD">
<ul>
<li>âš« è‹¹æœApp Storeé¦–é¡µå¤šæ—¥é‡ç£…æ¨è, 2.5Då³æ—¶å¤šäººæˆ˜æœ¯ç«æŠ€æ¸¸æˆ, ä¸»è¦è´Ÿè´£æ ¸å¿ƒæ¨¡å—çš„æ¶æ„è®¾è®¡å¼€å‘ä¸ä¼˜åŒ– </li>
</ul>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/g90/mobile_server/mobile_server.png" alt title="mobile_serveré›†ç¾¤ç¤ºæ„å›¾"></p>
<p>ä¸€èˆ¬çš„ï¼Œåœ¨å»¶è¿Ÿä¸æ•æ„Ÿçš„æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯é€šè¿‡è¿æ¥ gate æ¥è®¿é—® MobileServerã€‚gate è´Ÿè´£ä»£ç†è½¬å‘å®¢æˆ·ç«¯ä¸ game ä¹‹é—´çš„ç½‘ç»œé€šä¿¡æ•°æ®ã€‚ç”± gate è´Ÿè´£å®Œæˆå¯¹é€šä¿¡æ•°æ®åŠ å¯†è§£æã€å‹ç¼©è§£å‹æ“ä½œã€‚</p>
<p>æ–°ç‰ˆæœ¬çš„ gate åŸºäº TCP æˆ– KCP çš„ mobilerpc åè®®å¯¹å¤–æä¾›æœåŠ¡ã€‚gate å¯åŠ¨åä¼šä» etcd è·å–æ‰€æœ‰é›†ç¾¤å†…æ‰€æœ‰è¿›ç¨‹ä¿¡æ¯ï¼Œä¸»åŠ¨è¿æ¥æ‰€æœ‰çš„ gameã€game mangerã€‚</p>
<h3 id="äº‹ä»¶é©±åŠ¨æ¨¡å‹æ˜¯å’‹æ ·çš„"><a href="#äº‹ä»¶é©±åŠ¨æ¨¡å‹æ˜¯å’‹æ ·çš„" class="headerlink" title="äº‹ä»¶é©±åŠ¨æ¨¡å‹æ˜¯å’‹æ ·çš„"></a>äº‹ä»¶é©±åŠ¨æ¨¡å‹æ˜¯å’‹æ ·çš„</h3><ul>
<li>æœåŠ¡å™¨å¼•æ“åº•å±‚çš„ç½‘ç»œæ¨¡å—å¤šçº¿ç¨‹çš„: <ul>
<li>åº•å±‚ç½‘ç»œæ¨¡å—ä¸€ç›´æ­»å¾ªç¯åœ°åœ¨è·‘é€šè¿‡epoll waitä¼šæŠŠå·²ç»æ”¶åˆ°çš„æ•°æ®åŒ…æ”¾åˆ°ä¸€ä¸ªæ— é”é˜Ÿåˆ—FQé‡Œ</li>
</ul>
</li>
<li>ä¸šåŠ¡çº¿ç¨‹æ˜¯pythonçº¿ç¨‹:<ul>
<li>æ³¨å†Œä¸€ä¸ª15å¸§ä¾›tickæ¸¸æˆé€»è¾‘çš„å®šæ—¶å™¨</li>
<li>ä¼šä¸€ç›´æ­»å¾ªç¯çš„è·‘ <code>poll</code> å‡½æ•°<ul>
<li>å»æ£€æŸ¥æ˜¯å¦æœ‰å®šæ—¶å™¨æ˜¯å¦åˆ°æœŸ, åˆ°æœŸäº†åˆ™å¯¹åº”çš„å®šæ—¶å™¨å›è°ƒé€»è¾‘,<ul>
<li>æ¯”å¦‚ä¸Šè¿°çš„15å¸§çš„tické€»è¾‘, </li>
<li>æ¯”å¦‚æ¸¸æˆæŠ€èƒ½cdç»“æŸå›è°ƒç­‰ç­‰(ä¹Ÿå¯ä»¥æŠŠè¿™ç§æ¸¸æˆä¸šåŠ¡æœ¬èº«çš„é‚£ç§å®šæ—¶å™¨ä¸“é—¨åˆ†å¼€æ”¾åˆ°tické‡Œå»åšè¿™ç§æ¸¸æˆä¸šåŠ¡å®šæ—¶å™¨æ˜¯å¦åˆ°æœŸçš„æ£€æŸ¥, ä¸è¿‡è¿™æ ·çš„è¯, è¿™ç§æ¸¸æˆä¸šåŠ¡å¦‚æŠ€èƒ½çš„å®šæ—¶å™¨å°±æ²¡é‚£ä¹ˆç²¾å‡†äº†)</li>
</ul>
</li>
<li>å»æ£€æŸ¥æ˜¯å¦FQé‡Œæœ‰æ•°æ®æ¥äº†, æœ‰æ•°æ®æ¥äº†åˆ™æ‰§è¡Œå¯¹åº”çš„å›è°ƒé€»è¾‘ä¸€èˆ¬ä¼šæ‰§è¡Œå„ç§rpcå¯¹åº”çš„ä¸šåŠ¡é€»è¾‘</li>
<li>æ£€æŸ¥å®Œæ¯•, å°±å»æ‹¿ä¸‹ä¸€ä¸ªæœ€è¿‘çš„å®šæ—¶å™¨çš„æ—¶é—´nt, ç„¶åçº¿ç¨‹å°±åœ¨ä¸€ä¸ªæ¡ä»¶å˜é‡ä¸Šç¡çœ ç­‰å¾…ntçš„æ—¶é—´, <ul>
<li>ç¡çœ è¶…æ—¶å°±ä¼šç«‹é©¬é†’æ¥å¤„ç†ä¸‹ä¸€ä¸ªå®šæ—¶å™¨å›è°ƒ</li>
<li>å¦‚æœæœŸé—´æœ‰rpcç½‘ç»œæ•°æ®åˆ°æ¥ä¼šç«‹å³notifyè¿™ä¸ªæ¡ä»¶å˜é‡å”¤é†’pyçº¿ç¨‹æ¥å¤„ç†rpc</li>
<li>å¯ä»¥çœ‹å‡ºæˆ‘ä»¬çš„rpcå¤„ç†å’Œå®šæ—¶å™¨å›è°ƒå¤„ç†éƒ½æ˜¯å®æ—¶çš„, ç‹¬ç«‹äºé‚£ä¸ª15å¸§çš„tickå®šæ—¶å™¨, è¿™æ ·å¯ä»¥å‡å°‘rpcç½‘ç»œå»¶è¿Ÿ, å®šæ—¶å™¨ç²¾åº¦ä¹Ÿæ¯”è¾ƒå‡†ç¡®</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="åœ°å›¾å¤šå¤§æ‰¿è½½å¤šå°‘äºº"><a href="#åœ°å›¾å¤šå¤§æ‰¿è½½å¤šå°‘äºº" class="headerlink" title="åœ°å›¾å¤šå¤§æ‰¿è½½å¤šå°‘äºº"></a>åœ°å›¾å¤šå¤§æ‰¿è½½å¤šå°‘äºº</h3><ul>
<li>åœ°å›¾: 750*350</li>
<li>æ¸¸æˆå¤§å…æœæ‰¿è½½: 15ä¸ªè¿›ç¨‹, æ¯ä¸ªè¿›ç¨‹800äºº, åˆ™<code>15*800 = 12k</code>, ä¹Ÿå°±æ˜¯<strong>1ä¸‡äºº</strong>å·¦å³</li>
<li>æˆ˜æ–—æœæ‰¿è½½: 40ä¸ªè¿›ç¨‹, æ¯ä¸ªè¿›ç¨‹2åœºæˆ˜æ–—, æ¯åœºæˆ˜æ–—60äºº, åˆ™<code>40*2*60 = 5k</code>, ä¹Ÿå°±æ˜¯<strong>5åƒäºº</strong>å·¦å³</li>
</ul>
<h3 id="æœåŠ¡å™¨æ¶æ„çš„åˆ†å¸ƒå¼æ”¹é€ "><a href="#æœåŠ¡å™¨æ¶æ„çš„åˆ†å¸ƒå¼æ”¹é€ " class="headerlink" title="æœåŠ¡å™¨æ¶æ„çš„åˆ†å¸ƒå¼æ”¹é€ "></a>æœåŠ¡å™¨æ¶æ„çš„åˆ†å¸ƒå¼æ”¹é€ </h3><ul>
<li>ä¼˜åŒ– gameMgrè¿˜å¯ä»¥ä¸»å¤‡æ–¹æ¡ˆ, é‚£å°±æ¶‰åŠåˆ°ä¸»å¤‡åˆ‡æ¢<a href="#rafté€‰ä¸»è¿‡ç¨‹">é€‰ä¸»</a>çš„raftäº† </li>
<li>âš« æœåŠ¡å™¨æ¶æ„åŸºäºetcdçš„åˆ†å¸ƒå¼æ”¹é€ , è§£å†³å…¨å±€å•ç‚¹é—®é¢˜, é‡æ„å¹¿æ’­æ¡†æ¶, æ•´ä½“æ‰¿è½½æé«˜80% <ul>
<li>åšäº†å•¥å°±èƒ½æé«˜80%?<ul>
<li>å› ä¸ºåŸæ¥åœ¨ç”¨çš„å¼•æ“ç‰ˆæœ¬çš„gamemanageræœ‰å•ç‚¹é—®é¢˜, æ‰€æœ‰æœåŠ¡å™¨è¿›ç¨‹è¿åˆ°gmè¿›ç¨‹ä¸Šé¢ç®—æ˜¯ä¸€ä¸ªmbæ¸¸æˆæœ, ç°åœ¨æ˜¯æ‰€æœ‰æœåŠ¡å™¨é€šè¿‡ä»etcdä¸‹æ³¨å†Œå’Œç›‘æ§æ¥ç®¡ç†è¿æ¥</li>
<li>å¼•å…¥etcdåé€šè¿‡ttlä»¥åŠwatchæœºåˆ¶æ¥æœåŠ¡æ³¨å†Œä¸å‘ç°</li>
<li>æŠŠgmæ”¹é€ æˆæ— çŠ¶æ€å¤šç‚¹, ä¸å†è´Ÿè´£entityä¿¡æ¯çš„æ³¨å†Œä»¥åŠå„ç§è¿æ¥ä¿¡æ¯çš„ç®¡ç†, è€Œåªå‰©ä¸‹æ¶ˆæ¯è½¬å‘å’Œå¹¿æ’­å’Œå¼€æœ/å…³æœç­‰æ— çŠ¶æ€åŠŸèƒ½</li>
<li>ä¸etcdçš„äº¤äº’ä½¿ç”¨çš„æ˜¯å…¶V2ç‰ˆæœ¬çš„HTTP APIï¼Œå¦‚ä¸Šå›¾ï¼Œä¸ºäº†ä¿è¯æ¯ä¸€æ­¥éª¤çš„å¯é æ€§ï¼Œéƒ½åšäº†å¼‚å¸¸çš„é‡è¯•ã€‚å…³äºæ•°æ®å˜åŠ¨æ›´æ–°ï¼Œç»“åˆäº†å¢é‡æ›´æ–°ä¸å…¨å±€æ›´æ–°çš„ä¸¤ç§æ–¹å¼ï¼š<ul>
<li>å¢é‡æ›´æ–°ï¼šetcdçš„watchåŸºäºlongpollçš„æœºåˆ¶ï¼Œè¯·æ±‚åˆ°è¾¾etcdæœåŠ¡å™¨ä¹‹åï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•å˜åŠ¨ï¼Œetcdä¼šæŒ‚èµ·è¯¥è¯·æ±‚ï¼Œç›´åˆ°æœ‰å˜åŠ¨æ•°æ®ä¹‹åç«‹åˆ»å°†å˜åŠ¨æ•°æ®è¿”å›ï¼Œæœ¬åœ°å¯ä»¥æ ¹æ®æ”¶åˆ°çš„å˜åŠ¨æ•°æ®æƒ…å†µå¯¹æœ¬åœ°ç¼“å­˜åšå¢é‡çš„æ›´æ–°å³å¯ï¼Œå¾…æ•°æ®æ›´æ–°å®Œå†å‘etcdå‘èµ·watchè¯·æ±‚å³å¯ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸etcdçš„äº¤äº’æ¬¡æ•°ï¼Œé™ä½å…¶è´Ÿæ‹…ã€‚</li>
<li>å…¨é‡æ›´æ–°ï¼šæ­£å¸¸æƒ…å†µä¸‹å¢é‡æ›´æ–°å°±å¯ä»¥æ»¡è¶³æ•°æ®åŒæ­¥çš„éœ€æ±‚äº†ï¼Œä½†æ˜¯å…¶ä¼šæœ‰æƒŠç¾¤çš„é£é™©ï¼Œå‡å¦‚é›†ç¾¤ä¸­æœ‰2000ä¸ªèŠ‚ç‚¹ï¼Œåœ¨å¾ˆçŸ­çš„æ—¶é—´å†…æœ‰200ä¸ªèŠ‚ç‚¹çš„æ•°æ®æœ‰æ›´æ–°ï¼Œå¦‚æœæ‰€æœ‰èŠ‚ç‚¹éƒ½ä½¿ç”¨å¢é‡æ›´æ–°ï¼Œ<strong>å› ä¸ºæ¯æ¬¡watchè¯·æ±‚åªèƒ½è·å–åˆ°ä¸€ä¸ªæ›´æ”¹æƒ…å†µ</strong>ï¼Œæ‰€ä»¥æ•´ä¸ªé›†ç¾¤å°±éœ€è¦2000*200æ¬¡è¯·æ±‚ï¼ŒçŸ­æ—¶é—´å†…å°±ä¼šå¯¹etcdæœåŠ¡é€ æˆå¾ˆå¤§çš„å‹åŠ›ï¼Œå¯¹èŠ‚ç‚¹è¿›ç¨‹æœ¬èº«ä¹Ÿæœ‰ä¸å°çš„å¼€é”€ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ¯ä¸ªè¿›ç¨‹å°±å¯ä»¥é‡‡å–å»¶è¿Ÿä¸€å®šæ—¶é—´ä¹‹åå†ä¸€æ¬¡æ€§æ›´æ–°å…¨é‡æ•°æ®å³å¯ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ä¸ºå•¥é€‰etcdä¸é€‰zookeeper?<ul>
<li>ä¸¤ä¸ªåº”ç”¨å®ç°çš„ç›®çš„ä¸åŒã€‚etcdçš„ç›®çš„æ˜¯ä¸€ä¸ªé«˜å¯ç”¨çš„ Key/Value å­˜å‚¨ç³»ç»Ÿï¼Œä¸»è¦ç”¨äºåˆ†äº«é…ç½®å’ŒæœåŠ¡å‘ç°ï¼›zookeeperçš„ç›®çš„æ˜¯é«˜æœ‰æ•ˆå’Œå¯é çš„ååŒå·¥ä½œç³»ç»Ÿã€‚</li>
<li>æ¥å£è°ƒç”¨æ–¹å¼ä¸åŒã€‚etcdæ˜¯åŸºäºHTTP+JSONçš„APIï¼Œç›´æ¥ä½¿ç”¨curlå°±å¯ä»¥è½»æ¾ä½¿ç”¨ï¼Œæ–¹ä¾¿é›†ç¾¤ä¸­æ¯ä¸€ä¸ªä¸»æœºè®¿é—®ï¼›zookeeperåŸºäºTCPï¼Œéœ€è¦ä¸“é—¨çš„å®¢æˆ·ç«¯æ”¯æŒã€‚</li>
<li>åŠŸèƒ½å°±æ¯”è¾ƒç›¸ä¼¼äº†ã€‚etcdå’Œzookeeperéƒ½æ˜¯æä¾›äº†keyï¼Œvalueå­˜å‚¨æœåŠ¡ï¼Œé›†ç¾¤é˜Ÿåˆ—åŒæ­¥æœåŠ¡ï¼Œè§‚å¯Ÿä¸€ä¸ªkeyçš„æ•°å€¼å˜åŒ–ã€‚</li>
<li>éƒ¨ç½²æ–¹å¼ä¹Ÿæ˜¯å·®ä¸å¤šï¼šé‡‡ç”¨é›†ç¾¤çš„æ–¹å¼ï¼Œå¯ä»¥è¾¾åˆ°ä¸ŠåƒèŠ‚ç‚¹ã€‚åªæ˜¯etcdæ˜¯goå†™çš„ï¼Œç›´æ¥ç¼–è¯‘å¥½äºŒè¿›åˆ¶æ–‡ä»¶éƒ¨ç½²å®‰è£…å³å¯ï¼›zookeeperæ˜¯javaå†™çš„ï¼Œéœ€è¦ä¾èµ–äºjdkï¼Œéœ€è¦å…ˆéƒ¨ç½²jdkã€‚</li>
<li>å®ç°è¯­è¨€ï¼š go æ‹¥æœ‰å‡ ä¹ä¸è¾“äºCçš„æ•ˆç‡ï¼Œç‰¹åˆ«æ˜¯goè¯­è¨€æœ¬èº«å°±æ˜¯é¢å‘å¤šçº¿ç¨‹ï¼Œè¿›ç¨‹é€šä¿¡çš„è¯­è¨€ã€‚åœ¨å°è§„æ¨¡é›†ç¾¤ä¸­æ€§èƒ½éå¸¸çªå‡ºï¼›javaï¼Œå®ç°ä»£ç é‡è¦å¤šäºgoï¼Œåœ¨å°è§„æ¨¡é›†ç¾¤ä¸­æ€§èƒ½ä¸€èˆ¬ï¼Œä½†æ˜¯åœ¨å¤§è§„æ¨¡æƒ…å†µä¸‹ï¼Œä½¿ç”¨å¯¹å¤šçº¿ç¨‹çš„ä¼˜åŒ–åï¼Œä¹Ÿå’Œgoç›¸å·®ä¸å¤§ã€‚</li>
</ul>
</li>
<li>å•¥å•ç‚¹é—®é¢˜?<ul>
<li>MobileServerç°æœ‰çš„ç»“æ„ï¼ŒGameManagerè¿›ç¨‹ç»´æŠ¤äº†æ•´ä¸ªç³»ç»Ÿçš„å…ƒæ•°æ®ä»¥åŠä¸€äº›é€»è¾‘å±‚çš„entityæ³¨å†Œç­‰åŠ¨æ€æ•°æ®ç®¡ç†ï¼Œå®ƒçš„å¯é æ€§éå¸¸é‡è¦ï¼Œä½†æ˜¯ååå®ƒåˆæ˜¯ä¸€ä¸ªå•ç‚¹ï¼Œéšç€è§„æ¨¡çš„æ‰©å¤§ï¼Œé£é™©ä¹Ÿè¶Šæ¥è¶Šå¤§ã€‚     </li>
</ul>
</li>
<li>å¹¿æ’­æ¡†æ¶æ€ä¹ˆé‡æ„çš„?<ul>
<li>æ”¾å¼ƒåŸæ¥çš„æœ‰è·‘é©¬ç¯å¹¿æ’­å°±å®æ—¶å‘ç»™gmå†å‘ç»™gateçš„åšæ³•, å› ä¸ºä¸€æ¥è¿™æ ·ä¸ä»…ä¼šç»™gateæå¤§å‹åŠ›, å¦å¤–ç©å®¶å®¢æˆ·ç«¯çš„è·‘é©¬ç¯å‡ ä¹åœä¸ä¸‹æ¥â€¦</li>
<li>åœ¨gameå‡†å¤‡ä¸€ä¸ªå®šé•¿é˜Ÿåˆ—æ¥ä¿è¯ä¸çˆ†å†…å­˜</li>
<li>ç”¨ä¸¤ä¸ªå®šæ—¶å™¨æ¥æ§åˆ¶å‘é€å¹¿æ’­, Aå®šæ—¶å™¨ä¸º20min+éšæœº20minæ¥ä¿è¯ä¸€å®šä¼šæŠŠå½“å‰å¹¿æ’­é˜Ÿåˆ—é‡Œçš„ä¸œè¥¿å‘å‡ºå», Bå®šæ—¶å™¨æ¯éš”60ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦éœ€è¦flushå¹¿æ’­( å¯ç›´æ¥flushå¹¿æ’­çš„æ—¶é—´é—´éš”æš‚å®šä¸º30ç§’, å¦‚æœå¤§äºæ­¤å€¼åˆ™æ£€æŸ¥å®Œæ¯•, å‘é€å¹¿æ’­), åŸºæœ¬æ»¡è¶³ç­–åˆ’çš„äººå°‘å¿«å‘, äººå¤šæ…¢å‘çš„éœ€æ±‚.</li>
<li>è·‘é©¬ç¯å¹¿æ’­ç­–ç•¥<ul>
<li>å¯é€‚å½“ä¸¢å¼ƒ, è®¾ç½®ä¸€ä¸ªä¸­ç­‰å¤§å°çš„å®šé•¿é˜Ÿåˆ—, gameæœé€šè¿‡æ£€æµ‹ä¸ä¸Šæ¬¡çš„å‘é€æ—¶é—´é—´éš”æ¥å†³å®šæ˜¯å¦å³æ—¶å‘é€, ä¸å‘åˆ™æ‹¼æˆä¸€ä¸ªå¤§åŒ…, ç„¶åæ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥æ˜¯å¦ä¸ç¹å¿™äº†å°±éšæœºé€‰ä¸€ä¸ªgmè¿›ç¨‹å‘ç»™ä»–, </li>
<li>éšœçœ¼æ³•: ä¿è¯è‡ªå·±çš„åœ¨çº¿å¥½å‹ä¸å·¥ä¼šé˜Ÿå‘˜èƒ½å³æ—¶çœ‹åˆ°å³å¯</li>
<li>gmé‚£è¾¹ä¹Ÿå‡†å¤‡ä¸€ä¸ªå®šé•¿é˜Ÿåˆ—, ä»¥å¹³ç¨³çš„ç¼“æ…¢çš„é¢‘ç‡å‘é€ç»™å„ä¸ªgateå³å¯</li>
</ul>
</li>
</ul>
</li>
<li>åŸæ¥æ‰¿è½½å¤šå°‘äºº? å…­åƒå¤šå§, ç°åœ¨ä¸€ä¸‡å¤š</li>
</ul>
</li>
</ul>
<h3 id="å¦‚ä½•è¿›å…¥æˆ˜æ–—çš„"><a href="#å¦‚ä½•è¿›å…¥æˆ˜æ–—çš„" class="headerlink" title="å¦‚ä½•è¿›å…¥æˆ˜æ–—çš„"></a>å¦‚ä½•è¿›å…¥æˆ˜æ–—çš„</h3><p>ç”³è¯·æˆ˜æ–—æµç¨‹:<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="http://www.plantuml.com/plantuml/svg/AqWiAibCpYn8p2jHK0hApyyDJYqgoqnEZSdpJIn9pe3ob1GIYnMAkGgG53ibbfJaf4BbGT99N2c99Ob9YSMf2a6fAPd58B4YBgvY1LqxXIGhXSI2WfpA-2ImBWqzFJrDhYIGJ94LrAIWrCBIrE8IlUB4CeZyqxQPppfcF9is_SNwxSysDi6L9-VdbQHMbEZb59GMPsWuEOQ4-BZ61uQwXhh6Uxj6wYX0h8ZFJD440000"></p>
<p>åŒ¹é…æˆ˜æ–—æµç¨‹:<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="http://www.plantuml.com/plantuml/svg/VP2_Ri8m48TtFyM9gKJAqB8nL2BCB6LiKNHnJYMAROnzZLHL7RkL1-A167YBEhPI_WZXyNw_xxkJBSeMtmb6dbpNI2hD2Bu4XFUwG9RhPHgl03re8xw5iDU4laFecuJz9mfaLdIELBv7QcIiq1EyKDtuVkw4c7LXwY3FduDu2bason-p32GQIQhK_NAXTSnTYfz2N9CYfalQz74HQKVR3_8yuEQ45n5lJBYQHHIdlOVV_V5dnuriOttGpQFkBBoGpQDCRMHRCg7sR-OX7JOUQfLFlKdeeRNgiwpYv_m1"></p>
<p>ä¸ŠæŠ¥<code>puppet_dict</code>æµç¨‹:<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="http://www.plantuml.com/plantuml/svg/7Sen3i8m34RXtQVm20CvG0SasDWG7A3wanZ94cein-JyD5tVzr2YETy60ixe339uQ5735dn7n5VUuaEBJCvKzpEZ2x-aQf_DYS2NA-U5NQnvhFOparYhbZYbbCwKf_l2pmCUswUbZY47_W40"></p>
<p>åˆ†é…æˆ˜æ–—æµç¨‹å›¾1:<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="http://www.plantuml.com/plantuml/svg/TP6_JW914CRxVOefeV22XGs52PYhD2OY55QNlRk9kRZUhhkBiQIGH31Q2Z4aLYPQq15YWq_3BVWMxXt8VpVPBRxvpJUpCu9A7GMHeB66CjMQOOan7b3DvH766YLG1RuYOeixHtaR1PZ5IKWrzQb2g60OgLIJX33E1T2P7Nf-bkLPboi2zlYmTmYo206tPUwq8mKNkNAfMZrnlREQMtEzO_SYdw4oHVqYp2sYa6GoPNef9Vrkqll8zFHSIbuNu0d90rHgNdmHNQq_-qq5R-gejCCu3NEEu-JNs8q6v0pUYOWwO_OH0hKNHe7UhccXwR1fEiD9lvLyDrVOyLVRjDztPlmqMkRnSpfucuv6fjSOZvudh_VceMjUEgRtj2D5sSbAJ0SlyPelvhzEghbx1PNWiLf6CGx9PWkA8GeeE8NzB8JChdinVh1RF-Kn_fjrGFvyxVq5"></p>
<p>åˆ†é…æˆ˜æ–—æµç¨‹å›¾2:<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="http://www.plantuml.com/plantuml/svg/VL7DIiCm7B_dASAEXGs_3nu4zGtSqOwGfN-qh4j3aWv5X89UYZ1lEyXW5mzwLjXXz6rSkxs5ITk3srfxIE7t7I8e6z0RmAq-rJe0ijV23mYRx_gY0Cw386HKX_8Ik0RPmrJXFcMragwE-ZtqY93O2hrh2YqSPQJQC2gG8vy16MuvkoLUUjImriF_zN3hyQYcfXBm5NY-GcZvFba_VUHVYtmnm-tscSq-nLI8u9vKTp2B1owt9_5v1Reysa4aY51g8Y8XG1FFPzhbdKwdeS9nzXrdemWP71kwM6O51qOGY4ZT8bHWkF1oInqQIefGx117XbYDvylNIPR4sJHn-Pyzfe6N2oYpucCZNiT9zlAv-fwjqZIRnZ_fE7zxBWUfaNGvaq0r40d3qFogfSW4L475qfEc8FlCzHc_"></p>
<h3 id="æ–­çº¿é‡è¿æ€ä¹ˆåš"><a href="#æ–­çº¿é‡è¿æ€ä¹ˆåš" class="headerlink" title="æ–­çº¿é‡è¿æ€ä¹ˆåš?"></a>æ–­çº¿é‡è¿æ€ä¹ˆåš?</h3><ul>
<li>å®¢æˆ·ç«¯æ²¡æ€è¿›ç¨‹:<ul>
<li>æˆ˜æ–—ä¸­/å¤§å…ä¸­:<ul>
<li>KCP / TCP: å®¢æˆ·ç«¯é‡æ–°å‘èµ·æ­£å¸¸çš„kcpå†æ¬¡åŠ å¯†æ¡æ‰‹å»ºç«‹æ–°çš„ <code>kcp_conn</code>, ç„¶åç¬¬ä¸€ä¸ªæ¶ˆæ¯å°±æ˜¯å‘é€åŸæ¥çš„<code>session id</code>ä»¥åŠ <code>é‡è¿æ ‡è®°</code> ç»™æœåŠ¡å™¨, æœåŠ¡å™¨éªŒè¯ä¹‹åå°±çŸ¥é“å®¢æˆ·ç«¯æ˜¯é‡è¿äº†, ç„¶åæœåŠ¡å™¨æŠŠ åŸæ¥çš„ session åˆ†é…ç»™æ–°çš„ kcp_conn, ç„¶åé€šçŸ¥ ä¸šåŠ¡å±‚çš„ entity å®¢æˆ·ç«¯é‡è¿äº†å•Š(callä¸€ä¸‹<code>on_entity_reconn</code>æ–¹æ³•)</li>
<li>KCPå¯ä¼˜åŒ–ä¹‹å¤„: kcpçš„è¯è¿˜å¯ä»¥åšå¾—æ›´å¥½, å› ä¸ºä¸€æ¡kcpé“¾æ¥æ˜¯ç”¨ <code>conn id</code> æ ‡è¯†çš„è€Œä¸æ˜¯ç”¨ip/portæ ‡è¯†çš„, æ‰€ä»¥å¿ƒè·³è¶…æ—¶ä¹‹å, å¯ä»¥åªæ˜¯æŠŠè¿™æ¡kcpé“¾æ¥çš„çŠ¶æ€è®¾ç½®ä¸º<code>disconnected</code>ä½†æ˜¯ä¸closeè¿™æ¡é“¾æ¥, å½“é‡è¿çš„æ—¶å€™å¯ä»¥å‘é€åŸæ¥çš„<code>conn id</code>è€Œé<code>session id</code>, è¿™æ ·çš„è¯, åŸæ¥<code>kcp_conn</code>ç¼“å†²åŒºé‡Œè¿˜æ²¡ackçš„æ•°æ®å…¶å®å¯ä»¥ç›´æ¥é‡å‘</li>
</ul>
</li>
</ul>
</li>
<li>å®¢æˆ·ç«¯æ€äº†è¿›ç¨‹:<ul>
<li>æˆ˜æ–—ä¸­:  <a href="#æˆ˜æ–—ä¸­æ€è¿›ç¨‹æ‰çº¿é‡è¿è¿˜è¦æ’é˜Ÿä¹ˆ">ç‚¹æˆ‘</a></li>
<li>å¤§å…ä¸­: é‚£å°±é‡ç™»å½•å’¯</li>
</ul>
</li>
</ul>
<h3 id="æˆ˜æ–—ä¸­æ€è¿›ç¨‹æ‰çº¿é‡è¿è¿˜è¦æ’é˜Ÿä¹ˆ"><a href="#æˆ˜æ–—ä¸­æ€è¿›ç¨‹æ‰çº¿é‡è¿è¿˜è¦æ’é˜Ÿä¹ˆ" class="headerlink" title="æˆ˜æ–—ä¸­æ€è¿›ç¨‹æ‰çº¿é‡è¿è¿˜è¦æ’é˜Ÿä¹ˆ"></a>æˆ˜æ–—ä¸­æ€è¿›ç¨‹æ‰çº¿é‡è¿è¿˜è¦æ’é˜Ÿä¹ˆ</h3><p>ä¸éœ€è¦</p>
<ul>
<li>ç©å®¶åœ¨ç™»ä¸Šæ¸¸æˆæœçš„æ—¶å€™ä¼šç»™namecardå¾®æœåŠ¡(ä»¥ä¸‹ç®€ç§°nc)è®°å½•ä¸€ä¸ªåœ¨çº¿çŠ¶æ€</li>
<li>ç©å®¶ä¸»åŠ¨ä¸‹çº¿çš„æ—¶å€™ä¹Ÿä¼šè®©æ¸¸æˆæœç»™ncè®°å½•ä¸€ä¸ªä¸‹çº¿çŠ¶æ€, </li>
<li>å¦‚æœç©å®¶æ˜¯æ€è¿›ç¨‹çš„è¯<ul>
<li>å› ä¸ºå®¢æˆ·ç«¯è·Ÿæ¸¸æˆæœæœ‰åœ¨çº¿å¿ƒè·³, æ‰€ä»¥æ¸¸æˆæœçŸ¥é“ç©å®¶æ‰çº¿äº†, ä½†æ˜¯è¿™ç§æƒ…å†µä¼šä¸ºç©å®¶ä¿æŒ5åˆ†é’Ÿçš„avatarçŠ¶æ€, 5åˆ†é’Ÿè¿‡äº†, ç©å®¶è¿˜æ²¡æœ‰é‡è¿åˆ™é€šçŸ¥ncç©å®¶ä¸‹çº¿äº†</li>
<li>å¦‚æœç©å®¶5åˆ†é’Ÿå†…é‡æ–°æ‰“å¼€æ¸¸æˆ, æ­¤æ—¶å…ˆä¼šå…ˆå»æ¸ é“æ‹¿åˆ°token, ç„¶åè¿æ¥ç™»é™†å¾®æœåŠ¡(loginService, ä»¥ä¸‹ç®€ç§°ls), lsè¿™è¾¹å»è®¤è¯æœè®¤è¯ä¹‹åæ‹¿åˆ°aid, ç„¶åå…ˆå»ncé‡ŒæŸ¥è¯¢ä»–æ˜¯å¦å¤„äºåœ¨çº¿çŠ¶æ€, å› ä¸ºè¿˜åœ¨5åˆ†é’Ÿå†…, æ‰€ä»¥ncä¼šè¿”å›ç©å®¶è¿˜åœ¨çº¿, æ­¤æ—¶ç©å®¶ä¸éœ€è¦èµ°æ’é˜Ÿæµç¨‹, ç™»é™†æœç›´æ¥ç»™aidä»¥åŠéšæœºä¸€ä¸ªgateåœ°å€ç»™å®¢æˆ·ç«¯, ç„¶åå®¢æˆ·ç«¯å°±å»è¿gateè¿æ¸¸æˆæœäº†, <ul>
<li>å¯èƒ½å¹¶ä¸ä¼šè¿åˆ°åŸæ¥çš„æ¸¸æˆæœè¿›ç¨‹, æ­¤æ—¶å½“èµ°åˆ°avatarserviceé‡Œé¢çš„æ—¶å€™ï¼Œä¼šé€šçŸ¥åŸæ¥çš„æ¸¸æˆæœè¿›ç¨‹è®©åŸæ¥çš„avatarå…ˆä¸‹çº¿ï¼Œç„¶åå†åœ¨å½“å‰è¿ä¸Šçš„æ¸¸æˆæœä¸Šé¢åˆ›å»ºavatar</li>
<li>ä¸ºå•¥ä¸åšæˆä¸€å®šä¼šè¿å›åŸæ¥çš„æ¸¸æˆæœå‘¢? å› ä¸ºç©å®¶ä¸æ¸¸æˆæœä¹‹é—´è¿˜æœ‰ä¸ªgate, gateæ˜¯æ— çŠ¶æ€çš„(åªè´Ÿè´£è½¬å‘/å‹ç¼©è§£å‹/åŠ è§£å¯†), å°±ç®—ncé‡Œè®°å½•äº†åŸæ¥è¿çš„gateçš„addrä¹Ÿæ— æ³•è¿å›åŸæ¥çš„gsäº†</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>åœ¨ä¸Šè¿°åˆ†é…æˆ˜æ–—æµç¨‹å›¾ä¸­:  </p>
<ol>
<li>å½“ BattleAllocatorCenter é€šçŸ¥ BattleAllocatorStub åˆ†é…æˆ˜æ–— <code>create_remote_battle</code> æˆåŠŸå</li>
<li>è°ƒç”¨BattleAllocatorCenterçš„<code>create_battle_success</code></li>
<li>è°ƒç”¨BattleAllocatorCenterçš„<code>notify_avt_battle_create</code></li>
<li>BattleAllocatorCenterçš„<code>notify_avt_battle_create</code>å°±ä¼šé€šçŸ¥å¤§å…æœçš„avtè®°å½•<code>last_battle_info</code>åŒ…æ‹¬ip/ç«¯å£/hostnumå•¥çš„, å¹¶ä¸”<code>last_battle_info</code>ä¼šå­˜ç›˜</li>
</ol>
<p>å½“ç©å®¶é‡è¿çš„æ—¶å€™ç©å®¶æŠŠè¿™ä¸ª<code>last_battle_info</code>ä¿¡æ¯loadå‡ºæ¥å»ç›¸åº”çš„æˆ˜æ–—æœæŸ¥è¯¢æ˜¯å¦è¿˜æœ‰æˆ˜æ–—ç„¶åé‡è¿æˆ–è€…é€€å›å¤§å…å³å¯</p>
<h3 id="ç™»å½•å¾®æœåŠ¡å’Œæ’é˜Ÿå¾®æœåŠ¡"><a href="#ç™»å½•å¾®æœåŠ¡å’Œæ’é˜Ÿå¾®æœåŠ¡" class="headerlink" title="ç™»å½•å¾®æœåŠ¡å’Œæ’é˜Ÿå¾®æœåŠ¡"></a>ç™»å½•å¾®æœåŠ¡å’Œæ’é˜Ÿå¾®æœåŠ¡</h3><p>ç™»å½•åºåˆ—å›¾ sequence-diagram:<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="http://www.plantuml.com/plantuml/svg/bLPRJnj757xVNx5I7X9BlYXHsmSKLKA5Lb6RboPL7qfbBTu1Rp2pxkuw4MycOB2fBuIxkGIRGB12i558ZQ_up-pCxZxrB_IinzYmDYbPhLQpC-TyvphVZ2Pf8SGRsJffhfDQXiGtoSubfqv9E2memZG_BWIc9XKvWiKVv92iyFT-j9zHxhxPobgBIRsICj_F6ck5tuEIXjmysSdfbPhHV6Fb_w6x7ytQ2Tqg6TcccVZavesrVHfVDhRdmOIHMDGRsoIpPKKpT2lDtU-Pd9Qn70WgyZJYDIM2hY-fwAy8mW7q5AcgC8c6Gz8avWC8QqZXX8WcuyZqE0plzyPW7XpIQmlcuWUoL30Q6oHp0Ivmd13G81vIFA3n2-Ean8tRGGhAp5KoBejqDqMMybn03eLGG9DahF8qlM9jxLzVmveYXtXQgT1uXXmUatGCbZXHq8HnGKNyy4iOAS-Gyb8A80uybRGPtYpcpSzLQwvWRHPKy3Le5W_DqkmDnT-mz6paPrh9MREh7DTra_VySKz1uf_Vtn3WXpfUT-Hxue-PkCSftZRhVw7AU0m_O6iaiq4MQv0RwqCIlB7NzCed-BVz-UuRcckGHiOro1L7nW3UPyC3Cicyfkjd3uTuhBexIG8Pepx_P0IQfRtuwBepBiw91KR6Gn44LcxF6XWajJMpT0JL9kaw2vBcydOWhQnU-T0pq8V_k8Fl-H_ydRVaCCKFm_IlA1oQQVUF1CL5VVroMmIUGOaYrNDQVqEMSdHlpcmMpT81FL-dYKiIFzChV-kLA7X_CszGaEw488gAUmppndoPBAVfkoZTFwAdXps5xNamQMKNQFgOnCjwAqzdItPPth-sKxNytgX_fak7FlFWP5p0FfOuAxji7Up15pHyi7V9SegardqMkCb6Fprb0-Cq0Q_hwmAcIqjO9Il9RYRroYcuEVnaX2PMIJ863F7YbGO-GXoQF8MmJI3rRBVhW6letX40EA3rsg5UMm4aD_yjYIzOA_lFd__YSlDZ63I6Hv-HKjKuFeD4azA2KTo4BBDnrm_6JhqA-qTnG9a9QqYq4rO2n2EoMt1iTBswJzSkWLxiIjMRBav4j_O5P_Dek4CXnaw5nCxxKzThTmVLiDGDSe_N6pd8a4DUR-qPnVmO9jKoD9MrMMG5jtQZGDXCzWjxeTyu46y4-IKy8Jzu9KYQNn9zOLdrXH2Ur88-DOoGw1h4E_qTq4Ew6vVOvgviklcWfeNzGII8I1c2Hd7T7iJ0xckJ0kW1-rJB97v1DyxWxmkiCp0Joem_454Klwe9MaIzSix5URtURaWqLwMf8cckaaHARwOCsDp5I_YIuZRTB9DiWIPdZVfffpXjAsn_0iXNLQOpKqn2-xfvixK6N3MeJ-vMdJkZ8ImEF9SSEmGW1sdtwDDvT3hrFOCW7JEC-OQ02U5vwENfUO7EPx3QFlrJxMyQhYDqjmRxr5py_6yZQSssI2nbiqdyGc-sO43Y9zUvjNiGige0wR1aCIEFl9sxpe3Wx1jEco--J1PkXcG_D04JDyJDkIOzVMVaY-RnEzA8sZns9SncRBvlDpE9bHc5JWhJI1BPDk_4smPa8Tynh-m8QMEmGs6GterBZKFBofVXXkM6gzkCVqeAJFNfF_RqwPEp1LMSYaYYDnmIj0bPcVO6WWB6A4HEjqZiIB_SWSEGVipt6nh3RfwDZFegVRjhHRUD_QC7K7N6T6oDnZVCQ8oD0ScejMpNaEYN9oPki9PdG4xwuQ-pl4F-Fm00"></p>
<p>ç®€åŒ–ç‰ˆå¦‚ä¸‹:<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/g90/login_ms_1.jpg" alt title="ç®€åŒ–ç‰ˆç™»å½•åºåˆ—å›¾"></p>
<p>è¯·æ±‚ç™»å½•çš„æ•°æ®æ ¼å¼(ä»UniSDKå–å‡ºçš„éªŒè¯jsonä¸²çš„base64æ ¼å¼, <code>sauth_json</code>ä¿¡æ¯)å¤§è‡´å¦‚ä¸‹:<br><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AuthReq is sauth json struct</span></span><br><span class="line"><span class="keyword">type</span> AuthReq <span class="keyword">struct</span> &#123;</span><br><span class="line">    GameID       <span class="keyword">string</span> <span class="string">`json:"gameid"`</span></span><br><span class="line">    LoginChannel <span class="keyword">string</span> <span class="string">`json:"login_channel"`</span></span><br><span class="line">    AppChannel   <span class="keyword">string</span> <span class="string">`json:"app_channel"`</span></span><br><span class="line">    Platform     <span class="keyword">string</span> <span class="string">`json:"platform"`</span></span><br><span class="line">    SdkUID       <span class="keyword">string</span> <span class="string">`json:"sdkuid"`</span></span><br><span class="line">    Udid         <span class="keyword">string</span> <span class="string">`json:"udid"`</span></span><br><span class="line">    SessionID    <span class="keyword">string</span> <span class="string">`json:"sessionid"`</span></span><br><span class="line">    SdkVersion   <span class="keyword">string</span> <span class="string">`json:"sdk_version"`</span></span><br><span class="line">    DeviceID     <span class="keyword">string</span> <span class="string">`json:"deviceid"`</span></span><br><span class="line">    Step         <span class="keyword">string</span> <span class="string">`json:"step"`</span></span><br><span class="line">    HostID       <span class="keyword">int</span>    <span class="string">`json:"hostid"`</span></span><br><span class="line">    Raw          []<span class="keyword">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç™»å½•å›å¤çš„æ•°æ®æ ¼å¼<code>AuthReply</code>å¤§è‡´å¦‚ä¸‹:<br><figure class="highlight"><table><tr><td class="code"><pre><span class="line">// AuthReply sauth api reply</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="attr">"subcode"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"aid"</span>: <span class="number">127</span>,</span><br><span class="line">    <span class="attr">"username"</span>: <span class="string">"aebfgebpoqaabah4@ios.netease.win.163.com"</span>,</span><br><span class="line">    <span class="attr">"SN"</span>: <span class="string">"1271005435583216289"</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"eyJ1c2VyIjogeyJ1c2VybmFtZSI6ICJzYWlsb3IuZmVuZ0AxNjMuY29tIiwgImFjY291bnQiOiAic2FpbG9yLmZlbmdAMTYzLmNvbSIsICJyZWFsbmFtZV9zdGF0dXMiOiAxLCAiZXh0X3Rva2VuIjogImQ2NzQ1M2NjYjI5ZjcxYTBkZDhmMjFiOTc3MTcyMTYyIiwgImxvZ2luX3R5cGUiOiAxLCAibG9naW5fdGltZSI6IDE1MzkxMzkyMTJ9fQ=="</span>,</span><br><span class="line">    <span class="attr">"events"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"status"</span>: <span class="string">"ok"</span>,</span><br><span class="line">    <span class="attr">"unisdk_login_json"</span>: <span class="string">"eyJhaWQiOiIxMjciLCJzZGt1aWQiOiJhZWJmZ2VicG9xYWFiYWg0IiwiYWNjZXNzX3Rva2VuIjoiIiwiZXhwaXJlc19pbiI6IiIsInJlZnJlc2hfdG9rZW4iOiIifQ=="</span>,</span><br><span class="line">    <span class="attr">"data"</span>: &#123;</span><br><span class="line">        <span class="attr">"app_channel"</span>: <span class="string">"app_store"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"uidcount"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"newtm"</span>: <span class="number">1537947598</span>,</span><br><span class="line">    "req": &#123;  // è¿™ä¸ªæ˜¯sauth_jsonçš„æ‹·è´</span><br><span class="line">        "gameid": "g68",</span><br><span class="line">        "ip": "127.0.0.1",</span><br><span class="line">        "login_channel": "netease",</span><br><span class="line">        "app_channel": "app_store",</span><br><span class="line">        "platform": "ios",</span><br><span class="line">        "sdkuid": "aebfgebpoqaabah4",</span><br><span class="line">        "udid": "DB24AEEB-90CB-4CE7-8331-E4431D154C3C",</span><br><span class="line">        "sessionid": "1-eyJzIjogImQ2NzQ1M2NjYjI5ZjcxYTBkZDhmMjFiOTc3MTcyMTYyIiwgInQiOiAxfSAg",</span><br><span class="line">        "sdk_version": "3.3.2",</span><br><span class="line">        "deviceid": "aeavvs4dtnwhryzq-d",</span><br><span class="line">        "step": ""</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>âš« å†…éƒ¨å¼€æºçš„é€šç”¨ç™»å½•å¾®æœåŠ¡æ ¸å¿ƒå¼€å‘è€…, è¢«è¾ƒå¤šé¡¹ç›®æ¥å…¥ä½¿ç”¨, æä¾›ç™»é™†æ§åˆ¶ã€æ’é˜Ÿã€éªŒè¯ç­‰åŠŸèƒ½ <ul>
<li>sessionå„ç§æµç¨‹ææ¸…æ¥šï¼Œ æ˜¯å¦å¯ä»¥ç”¨åˆ«äººçš„ <code>AuthReply_Encrypted</code> æ¥ç™»é™†åˆ«äººçš„è´¦å·?<ul>
<li>æ ¹æ®ä¸Šé¢çš„æµç¨‹å›¾, å¦‚æœçœŸçš„æ‹¿åˆ°äº†åˆ«äººçš„<code>AuthReply_Encrypted</code>, ç¡®å®æ˜¯å¯ä»¥ç™»å½•åˆ«äººçš„è´¦å·çš„, ä½†æ˜¯ç©å®¶å®¢æˆ·ç«¯å’Œæ’é˜Ÿå¾®æœåŠ¡æ˜¯httpså®‰å…¨åŠ å¯†è¿æ¥çš„, æŒ‰é“ç†å³ä½¿åœ¨ç½‘ç»œé€”ä¸­æŠ“åˆ°åŒ…äº†ä¹Ÿæ˜¯æ— æ³•ä»httpsæ•°æ®ä¸­è§£å¯†æå–å‡º<code>AuthReply_Encrypted</code>çš„. æ‰€ä»¥è¿™ä¸€ç‚¹çš„å®‰å…¨æ€§ç”±httpsä¿è¯.</li>
<li>å³ä½¿çœŸçš„æŠŠ<code>AuthReply_Encrypted</code>æå–å‡ºæ¥äº†, æˆ‘ä»¬ä¹Ÿæ˜¯å¯ä»¥åœ¨æ¸¸æˆå¤§å…æœåšä¸€ä¸‹<code>AuthReply.req.ip</code>æˆ–è€…<code>AuthReply.req.deviceid</code>ç­‰ç­‰çš„æ ¡éªŒ, å› ä¸ºå®¢æˆ·ç«¯æ˜¯æ²¡æœ‰å­˜æ”¾è§£å¼€<code>AuthReply_Encrypted</code>çš„å¯†é’¥çš„, ä¹Ÿå°±æ˜¯è¯´å®¢æˆ·ç«¯æœ¬åœ°æ˜¯æ— æ³•æ›´æ”¹è¿™ä¸ª<code>AuthReply_Encrypted</code>é‡Œçš„ä¿¡æ¯çš„.è¿™ä¸ªå¯†é’¥åªåœ¨æ¸¸æˆå¤§å…æœå’Œç™»é™†å¾®æœåŠ¡å­˜æ”¾äº†.</li>
</ul>
</li>
<li>ç”¨çš„å•¥è¯­è¨€?<ul>
<li>goè¯­è¨€</li>
</ul>
</li>
<li>ç™»é™†æ§åˆ¶æ˜¯å•¥?<ul>
<li>é»‘ç™½åå•, GMåå•å¯æå‰è¿›å…¥æµ‹è¯•æ¸¸æˆ</li>
<li>ç‰¹å®šæ¸ é“çš„äººæ•°æ§åˆ¶</li>
<li>æ¿€æ´»ç </li>
</ul>
</li>
<li>æ¸¸æˆæœå’Œå®¢æˆ·ç«¯æ€ä¹ˆæ‹¿åˆ°ç™»å½•å¾®æœåŠ¡åœ°å€çš„?<ul>
<li>ä¸ç›´æ¥æ‹¿, è€Œæ˜¯é€šè¿‡ api-gateway è¿™ä¸ªç½‘å…³, è¿™ä¸ªapi-gatewayæ˜¯saè´Ÿè´£ç»´æŠ¤çš„, åŸºäºk8sçš„serviceå’Œingresså¼€å‘<ul>
<li>k8sçš„serviceä»‹ç»: å› ä¸ºå¾ˆå¤šè¿è¡Œçš„å®¹å™¨å­˜åœ¨åŠ¨æ€ã€å¼¹æ€§çš„å˜åŒ–ï¼ˆå®¹å™¨çš„é‡å¯IPåœ°å€ä¼šå˜åŒ–ï¼‰ï¼Œå› æ­¤ä¾¿äº§ç”Ÿäº†serviceï¼Œå…¶èµ„æºä¸ºæ­¤ç±»PODå¯¹è±¡æä¾›ä¸€ä¸ªå›ºå®šã€ç»Ÿä¸€çš„è®¿é—®æ¥å£åŠè´Ÿè½½å‡è¡¡èƒ½åŠ›ï¼Œå¹¶å€ŸåŠ©DNSç³»ç»Ÿçš„æœåŠ¡å‘ç°åŠŸèƒ½ï¼Œè§£å†³å®¢æˆ·ç«¯å‘ç°å®¹å™¨éš¾å¾—é—®é¢˜</li>
<li>k8sçš„ingressä»‹ç»: ä½œä¸ºHTTP(S)è´Ÿè½½å‡è¡¡å™¨</li>
</ul>
</li>
<li><a href="#å®¢æˆ·ç«¯è§’åº¦">å‚è€ƒè¿™é‡Œ</a></li>
<li>å¤–ç½‘å’Œå†…ç½‘ç”¨æˆ·è®¿é—®çš„api-gatewayåœ°å€ä¸åŒ</li>
</ul>
</li>
<li>æ’é˜Ÿéƒ¨åˆ†, æ€ä¹ˆåˆ¤æ–­afk? è°æ¥é…ç½®æµé€Ÿå’Œé™é¢? æ¸¸æˆæœå’Œæ’é˜Ÿå¾®æœåŠ¡ç›´è¿ä¹ˆ?æ¸¸æˆæœæ˜¯æ€ä¹ˆæ‹¿åˆ°æ’é˜Ÿå¾®æœåŠ¡çš„IPçš„?<ul>
<li>æœ‰ä¸€ä¸ªå«activeçš„rediså“ˆå¸Œè¡¨, ä¼šå­˜ä¸Šæ¬¡ç©å®¶çš„ query_pos_info çš„æ—¶é—´æˆ³ts, æ¯éš”ä¸€æ®µæ—¶é—´å°±å»è¿™ä¸ªå“ˆå¸Œè¡¨hscanæ‹¿100ä¸ªå‡ºæ¥çœ‹çœ‹ <code>now_ts -ts</code>æ˜¯ä¸æ˜¯å·²ç»å¤§äºafké˜ˆå€¼äº†</li>
<li>æ¸¸æˆæœå’Œæ’é˜Ÿå¾®æœåŠ¡ä¸ç›´è¿, æ˜¯æ¸¸æˆæœé€šè¿‡ä¸æ–­çš„æ£€æµ‹redisä¸­çš„å½“å‰åœ¨çº¿äººæ•°æ¥é…ç½®æµé€Ÿå’Œé™é¢çš„(æ¯”å¦‚é…ç½®çš„æœ€å¤§åœ¨çº¿ä¸º8käºº, å½“å‰åœ¨çº¿2käºº, é‚£å‘é€ç»™æ’é˜Ÿæœçš„é™é¢å°±æ˜¯6k), æ¸¸æˆæœé›†ç¾¤è¿™è¾¹çš„avatarServiceé€šè¿‡api-gatewayè¿™ä¸ªç½‘å…³çš„åç¼€åŠ ä¸Š<code>/queue</code>æ¥è®¿é—®æ’é˜Ÿå¾®æœåŠ¡</li>
</ul>
</li>
<li>æ’é˜Ÿæ€ä¹ˆå®ç°çš„?<ul>
<li>é€šè¿‡redisçš„zsetæ¥å­˜å‚¨å…¥é˜Ÿæ—¶é—´å’Œç”¨æˆ·id, ç„¶åç»™ç©å®¶ä¸€ä¸ªticket, ç„¶åæŒ‰ç…§é…ç½®å¥½çš„å‡ºé˜Ÿé€Ÿåº¦ä»¥åŠåé¢æ¥ä»é˜Ÿåˆ—ä¸­æŠ½å–ç©å®¶å‘æ”¾æ¸¸æˆæœè®¸å¯è¯</li>
<li>ç©å®¶éœ€è¦å®šæ—¶åˆ·æ–°ticket, ä¸ç„¶ä¼šè¢«æ”¾å…¥afké˜Ÿåˆ—</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="timer"><a href="#timer" class="headerlink" title="timer"></a>timer</h3><ul>
<li>âš« å¼€å‘å®šæ—¶å™¨åº“æ›¿æ¢ç½‘æ˜“æœåŠ¡å™¨å¼•æ“è‡ªå¸¦çš„å®šæ—¶å™¨åº“, å¹¶æš´éœ²ç»™Pythonè°ƒç”¨, æ€§èƒ½æå‡40% <ul>
<li>ç”¨pythonçš„åŸç”Ÿå®˜æ–¹Python APIï¼ˆåº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼‰æ¥åš, å› ä¸ºä»ç«ç„°å›¾çœ‹åˆ°boost.pythonå’Œpybind11æœ¬èº«ä¹Ÿæœ‰æ¶ˆè€—</li>
<li>å½“æ—¶æ‹¿åˆ°çš„å¼•æ“ç‰ˆæœ¬çš„å®šæ—¶å™¨åº“æ˜¯åŸºäºæœ€å°å †çš„</li>
</ul>
</li>
</ul>
<h3 id="ç½‘ç»œä¼˜åŒ–"><a href="#ç½‘ç»œä¼˜åŒ–" class="headerlink" title="ç½‘ç»œä¼˜åŒ–"></a>ç½‘ç»œä¼˜åŒ–</h3><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/g90/kcp_latency.png" alt></p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/g90/kcp_header.png" alt></p>
<h4 id="kcpçš„æ¶ˆæ¯æ¨¡å¼å’Œæµæ¨¡å¼"><a href="#kcpçš„æ¶ˆæ¯æ¨¡å¼å’Œæµæ¨¡å¼" class="headerlink" title="kcpçš„æ¶ˆæ¯æ¨¡å¼å’Œæµæ¨¡å¼"></a>kcpçš„æ¶ˆæ¯æ¨¡å¼å’Œæµæ¨¡å¼</h4><p>å›é¡¾ä¸€ä¸‹ KCP åè®®</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0               4   5   6       8 (BYTE)</span><br><span class="line">+---------------+---+---+-------+</span><br><span class="line">|     conv      |cmd|frg|  wnd  |</span><br><span class="line">+---------------+---+---+-------+   8</span><br><span class="line">|     ts        |     sn        |</span><br><span class="line">+---------------+---------------+  16</span><br><span class="line">|     una       |     len       |</span><br><span class="line">+---------------+---------------+  24</span><br><span class="line">|                               |</span><br><span class="line">|        DATA (optional)        |</span><br><span class="line">|                               |</span><br><span class="line">+-------------------------------+</span><br></pre></td></tr></table></figure>
<ul>
<li><code>frg</code> : åˆ†ç‰‡ï¼Œç”¨æˆ·æ•°æ®å¯èƒ½ä¼šè¢«åˆ†æˆå¤šä¸ª KCP åŒ…ï¼Œå‘é€å‡ºå»</li>
<li><code>sn</code> : åºåˆ—å·</li>
<li><code>len</code> : æ•°æ®é•¿åº¦ (DATA çš„é•¿åº¦)</li>
<li><code>data</code> : ç”¨æˆ·æ•°æ®</li>
</ul>
<h5 id="æ¶ˆæ¯æ¨¡å¼"><a href="#æ¶ˆæ¯æ¨¡å¼" class="headerlink" title="æ¶ˆæ¯æ¨¡å¼"></a>æ¶ˆæ¯æ¨¡å¼</h5><p>ç‰¹ç‚¹: </p>
<ul>
<li>åœ¨æ¶ˆæ¯æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ª KCP åŒ…æœ€å¤šåŒ…å«ä¸€ä¸ªä¸Šå±‚åº”ç”¨çš„æ¶ˆæ¯ã€‚</li>
<li>æ¶ˆæ¯æ¨¡å¼å‡å°‘äº†ä¸Šå±‚åº”ç”¨ä»æµä¸­æ‹†è§£å‡ºæ¶ˆæ¯çš„éº»çƒ¦ï¼Œä½†æ˜¯å®ƒå¯¹ç½‘ç»œçš„åˆ©ç”¨ç‡è¾ƒä½ã€‚Payload(æœ‰æ•ˆè½½è·) å°‘ï¼ŒKCP å¤´å æ¯”è¿‡å¤§ã€‚</li>
</ul>
<p>å‡å®šä¸€ä¸ªåœºæ™¯ï¼Œåœ¨ IM ä¸­ï¼ŒA å‘ B å‘é€äº†ä¸€ä¸ªæ¶ˆæ¯ï¼Œè¿™ä¸ªæ¶ˆæ¯å¯èƒ½æ˜¯æ–‡æœ¬æ¶ˆæ¯ï¼Œä¹Ÿå¯èƒ½æ˜¯å›¾ç‰‡æ¶ˆæ¯ã€‚é‚£ä¹ˆåº”ç”¨ç¨‹åºå‘é€çš„æ•°æ®æ˜¯æœ‰é€»è¾‘çš„ <code>æ¶ˆæ¯</code> çš„æ¦‚å¿µçš„ã€‚</p>
<p>kCP åè®®æä¾›äº†ä¸€ç§èƒ½åŠ›æŠŠä¸åŒçš„ <code>æ¶ˆæ¯</code> (åº”ç”¨ç¨‹åº) åˆ’åˆ†åœ¨ä¸åŒçš„ KCP åŒ…ä¸­ã€‚</p>
<p>KCP å®šä¹‰ <code>MSS</code> çš„é»˜è®¤å¤§å°ä¸º 1400 bytesï¼Œ <code>MSS</code> (maximum segment size) è¡¨ç¤ºæœ€å¤§æ®µå¤§å°ï¼Œå®ƒæœ¬èº«æ˜¯ TCP ä¸­çš„æ¦‚å¿µï¼Œè¡¨ç¤ºåŒ…å« TCP headerï¼Œæ•´ä¸ªæ•°æ®åŒ…çš„æœ€å¤§å¤§å°ã€‚åœ¨ KCP åè®®ä¸­ï¼Œæ¦‚å¿µç±»ä¼¼ï¼Œè¡¨ç¤ºåŒ…å« KCP header åœ¨å†…ï¼Œæ•´ä¸ª KCP åŒ…çš„æœ€å¤§å¤§å°ã€‚</p>
<p>è¶…è¿‡ <code>MSS</code> çš„æ•°æ®å°†ä¼šè¢«æ‹†åˆ†åˆ°æˆå¤šä¸ª KCP åŒ…ã€‚æ ¹æ®æ˜¯å¦æ‹†åŒ…å°†ä¼šåˆ†æˆ 2 ç§æƒ…å†µã€‚</p>
<ul>
<li>ä¸æ‹†åŒ…<ul>
<li><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/g90/kcp_no_stream_mode_1.png" alt></li>
<li>3 æ¡æ¶ˆæ¯ <code>Msg1</code> , <code>Msg2</code> , <code>Msg3</code> åˆ†åˆ«åŒ…å«åœ¨ <code>sn</code> ä¸º 90ã€91ã€92 çš„ KCP åŒ…ä¸­</li>
</ul>
</li>
<li>æ‹†åŒ…<ul>
<li>å‡å®šè¿™ä¸ªæ¶ˆæ¯æ˜¯ä¸ªå›¾ç‰‡æ¶ˆæ¯ï¼Œæ¯”è¾ƒå¤§ï¼Œå¤§å°ä¸º 3252 bytes</li>
<li><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/g90/kcp_no_stream_mode_2.png" alt></li>
<li>Msg è¢«æ‹†æˆäº† 3 éƒ¨åˆ†ï¼ŒåŒ…å«åœ¨ 3 ä¸ª KCP åŒ…ä¸­ã€‚ <strong>æ³¨æ„</strong> , <code>frg</code> çš„åºå·æ˜¯ä»å¤§åˆ°å°çš„ï¼Œä¸€ç›´åˆ° 0 ä¸ºæ­¢ã€‚è¿™æ ·æ¥æ”¶ç«¯æ”¶åˆ° KCP åŒ…æ—¶ï¼Œåªæœ‰æ‹¿åˆ° <code>frg</code> ä¸º 0 çš„åŒ…ï¼Œæ‰ä¼šè¿›è¡Œç»„è£…å¹¶äº¤ä»˜ç»™ä¸Šå±‚åº”ç”¨ç¨‹åºã€‚ç”±äº <code>frg</code> åœ¨ header ä¸­å  1 ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯æœ€å¤§èƒ½æ”¯æŒ <code>ï¼ˆ1400 â€“ 24ï¼‰ * 256 / 1024 = 344kB</code> çš„æ¶ˆæ¯</li>
</ul>
</li>
</ul>
<h5 id="æµæ¨¡å¼"><a href="#æµæ¨¡å¼" class="headerlink" title="æµæ¨¡å¼"></a>æµæ¨¡å¼</h5><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/g90/kcp_stream_mode.png" alt></p>
<p>åœ¨æµæ¨¡å¼ä¸‹ï¼ŒKCP è¯•å›¾è®©æ¯ä¸ª KCP åŒ…å°½å¯èƒ½è£…æ»¡ã€‚ä¸€ä¸ª KCP åŒ…ä¸­å¯èƒ½åŒ…å«å¤šä¸ª <code>æ¶ˆæ¯</code> ã€‚åœ¨ä¸Šå›¾ä¸­ï¼Œ <code>Msg1</code> ã€ <code>Msg2</code> ã€ <code>Msg3</code> çš„ä¸€éƒ¨åˆ†è¢«åŒ…å«åœ¨ <code>sn</code> ä¸º 234 çš„ KCP åŒ…ä¸­ã€‚ ä¸Šå±‚åº”ç”¨éœ€è¦è‡ªå·±æ¥åˆ¤æ–­æ¯ä¸ªæ¶ˆæ¯çš„è¾¹ç•Œã€‚</p>
<ul>
<li>âš« ç½‘ç»œä¼˜åŒ–, å¹³å‡é™ä½å»¶è¿Ÿ50%, å¢å¼ºå…¶æŠ—ç½‘ç»œæŠ–åŠ¨èƒ½åŠ›, ä½¿å…¶åœ¨70msçš„RTTå»¶è¿Ÿ30%ä¸¢åŒ…ç‡çš„ç¯å¢ƒä¸‹ä¾æ—§å¯ä»¥æµç•…è¿è¡Œä¸”æ­£å¸¸æ“ä½œ<ul>
<li>æ€ä¹ˆé™ä½å»¶è¿Ÿçš„? å¦‚ä½•æŠ—æŠ–åŠ¨? ä¸»è¦æ˜¯å†—ä½™ç­–ç•¥é™ä½ä¸¢åŒ…ç‡å¸¦æ¥çš„å½±å“<ul>
<li>FEC, è¯¦è§ <a href="/fec_intro/" title="FECä»‹ç»">FECä»‹ç»</a></li>
<li>å†—ä½™ç­–ç•¥<ul>
<li>åœ¨åŸæœ‰rudpåŸºç¡€ä¸ŠåŠ å…¥å†—ä½™åŒ…, </li>
<li>å¹¶ä¸”æ ¹æ®ä¸€æ®µæ—¶é—´å†…æ£€æµ‹çš„srttä¸ä¸¢åŒ…ç‡æ¥åŠ¨æ€å†—ä½™(100msä»¥ä¸‹æœ¬èº«è¡¨ç°è¾ƒå¥½ä¸ç”¨å†—ä½™äº†), </li>
<li><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/g90/kcp_rdc.png" alt></li>
<li>headéƒ¨åˆ†æŒ‡çš„æ˜¯é™¤äº†lenä¸rdc_lenä¹‹å¤–çš„æ‰€æœ‰åŒ…å¤´å†…å®¹ï¼ŒlenæŒ‡çš„æ˜¯bodyçš„é•¿åº¦ï¼Œrdc_lenæŒ‡çš„æ˜¯rdc_bodyçš„é•¿åº¦ã€‚å…¶ä¸­rdc_bodyæ˜¯ç”±ä¸€ä¸ªä¸ªrdc_dataç»„æˆçš„ï¼Œæ¯ä¸ªrdc_dataåˆåŒ…å«äº†rdc_snï¼Œdata_lenä¸dataä¸‰ä¸ªéƒ¨åˆ†ã€‚è¿™æ ·è®¾è®¡ä¸‹ï¼Œå¯ä»¥åŠ¨æ€çš„è°ƒèŠ‚æºå¸¦å†—ä½™çš„æ•°é‡ã€‚</li>
<li>å¦‚ä½•è®¾è®¡æˆåŠ¨æ€å†—ä½™çš„å‘¢? <ul>
<li>æ”¹é€ åŒ…å¤´åŠ å…¥<code>rdc_len</code>å’Œ<code>rdc_body</code>, <code>rdc_len</code>æŒ‡çš„æ˜¯<code>rdc_body</code>çš„é•¿åº¦ã€‚</li>
<li>å…¶ä¸­ <code>rdc_body</code> æ˜¯ç”±ä¸€ä¸ªä¸ª<code>rdc_data</code>ç»„æˆçš„, è€Œæ¯ä¸ª<code>rdc_data</code>åˆåŒ…å«äº†ä¸‰ä¸ªéƒ¨åˆ†:  <ul>
<li>rdc_sn</li>
<li>data_len</li>
<li>data</li>
</ul>
</li>
<li>å¯æ€»ç»“å¦‚ä¸‹:</li>
<li><code>rdc_body =</code>  <ul>
<li>rdc_data_1<ul>
<li>rdc_sn_1</li>
<li>data_len_1</li>
<li>data_1</li>
</ul>
</li>
<li>rdc_data_2<ul>
<li>rdc_sn_2</li>
<li>data_len_2</li>
<li>data_2</li>
</ul>
</li>
<li>â€¦</li>
<li>rdc_data_n<ul>
<li>rdc_sn_n</li>
<li>data_len_n</li>
<li>data_n</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>ä¸ºä»€ä¹ˆè¦è®¾ç½®å†—ä½™æ¬¡æ•°ï¼Ÿå› ä¸ºå½“ä¸€ä¸ªåŒ…è¢«å½“åšå†—ä½™æºå¸¦Næ¬¡éƒ½ä¸¢å¤±çš„è¯ï¼Œè¯æ˜æ¸¸æˆå·²ç»åˆ°äº†ä¸€ä¸ªæ¯”è¾ƒå¡çš„ç¨‹åº¦, å¯ä»¥é€šè¿‡é™åˆ¶å†—ä½™æ¬¡æ•°æ¥å‡å°‘æ— è°“çš„æµé‡æ¶ˆè€—, ä¸”KCPæœ¬èº«æœ‰å¿«é€Ÿé‡ä¼ çš„æœºåˆ¶ï¼Œ</li>
</ul>
</li>
<li>ç²¾ç®€åŒ…å¤´(32ä½æ”¹16ä½), å¹¶åˆæ‰¹æ•°æ®ä¸”å‹ç¼©(æ–¹ä¾¿å†—ä½™æ›´å¤š)<ul>
<li>é™ä½25%çš„åŒ…å¤´æ¶ˆè€—(24å­—èŠ‚-&gt;18)</li>
</ul>
</li>
<li>ackæœºåˆ¶ä¼˜åŒ–<ul>
<li><code>UNA</code>: åŒ…å¤´ä¸­çš„<code>UNA</code>è¡¨ç¤ºæ­¤ç¼–å·å‰æ‰€æœ‰åŒ…å·²æ”¶åˆ°</li>
<li>CMDä¸ºackç±»å‹çš„cmdæ—¶:<ul>
<li>æ™®é€šackæœºåˆ¶<ul>
<li><code>IKCP_CMD_ACK</code>: æ¯ä¸ªackåŒ…åªè¡¨ç¤ºæ”¶åˆ°äº†æŸä¸ªç¼–å·çš„åŒ…, ä¼šéå†<code>acklist</code>ç„¶åå…¶ä¸­çš„æ¯ä¸ªackéƒ½å¯¹åº”å‘ä¸€ä¸ªackåŒ…. <code>sn</code>ä¸ºæ”¶åˆ°äº†çš„åŒ…çš„åºå·,(æ³¨æ„, è¿™ä¸€ç‚¹å’Œtcpæ˜¯ä¸åŒçš„, tcpåŒ…å¤´æœ‰ä¸“é—¨çš„<code>ack_sn</code>, å½“ackæ ‡å¿—ä½ä¸º1æ—¶<code>ack_sn</code>å°±ç”Ÿæ•ˆ.) </li>
</ul>
</li>
<li>dupackæœºåˆ¶<ul>
<li><code>IKCP_CMD_DUPACK</code>: å½“<code>acklist</code>æ•°ç»„é‡Œéœ€è¦å‘é€çš„ackå°äºç­‰äº3æ—¶, ç”¨åŒ…å¤´ä¸­çš„len/rdc_len/snæ¥è¡¨ç¤ºæ”¶åˆ°äº†çš„åŒ…çš„åºå·</li>
<li><code>IKCP_CMD_DUPACKS</code>(å¯ä»¥ç†è§£ä¸ºå†—ä½™ackæœºåˆ¶): å½“<code>acklist</code>æ•°ç»„é‡Œéœ€è¦å‘é€çš„ackå¤§äº3æ—¶, bodyé‡Œä¼šåŒ…å«åˆå¹¶<code>acklist</code>çš„æ‰€æœ‰ackä»¥åŠä¹‹å‰å‘è¿‡çš„ack, ç›´åˆ°åŒ…å¤§å°åˆ°è¾¾mss.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>ä»€ä¹ˆæ—¶å€™æ¸…ç†<code>acklist</code>å‘¢?<ul>
<li>æ¯æ¬¡flushéƒ½ä¼šæŠŠ<code>acklist</code>çš„æ‰€æœ‰ackå‘å®Œ, ç„¶åå°±ä¼šæŠŠ<code>kcp-&gt;ackcount</code>ç½®ä¸º0, ç„¶åä¸‹å›å¯¹æ–¹å‘pushæ•°æ®åŒ…è¿‡æ¥åˆä»å¤´å¼€å§‹è¦†ç›–<code>acklist</code>å¾€é‡Œé¢åŠ å…¥ack, å¾ªç¯åˆ©ç”¨, è¿™å°±è¾¾åˆ°äº†æ¸…ç†acklistçš„æ•ˆæœ.</li>
</ul>
</li>
<li>ä¸éµå®ˆå…¬å¹³é€€è®©è§„åˆ™, KCPæ­£å¸¸æ¨¡å¼åŒTCPä¸€æ ·ä½¿ç”¨å…¬å¹³é€€è®©æ³•åˆ™ï¼Œå³å‘é€çª—å£å¤§å°ç”±ï¼šå‘é€ç¼“å­˜å¤§å°ã€æ¥æ”¶ç«¯å‰©ä½™æ¥æ”¶ç¼“å­˜å¤§å°ã€ä¸¢åŒ…é€€è®©(æ‹¥å¡é¿å…)åŠæ…¢å¯åŠ¨è¿™å››è¦ç´ å†³å®šã€‚ä½†ä¼ é€åŠæ—¶æ€§è¦æ±‚å¾ˆé«˜çš„å°æ•°æ®æ—¶ï¼Œå¯é€‰æ‹©é€šè¿‡é…ç½®è·³è¿‡åä¸¤æ­¥ï¼Œä»…ç”¨å‰ä¸¤é¡¹æ¥æ§åˆ¶å‘é€é¢‘ç‡ã€‚ä»¥ç‰ºç‰²éƒ¨åˆ†å…¬å¹³æ€§åŠå¸¦å®½åˆ©ç”¨ç‡ä¹‹ä»£ä»·ï¼Œæ¢å–äº†å¼€ç€BTéƒ½èƒ½æµç•…ä¼ è¾“çš„æ•ˆæœã€‚<!-- * åŠ å…¥çŠ¶æ€ç¼“å†²å™¨, å‡åŒ€æ”¾å‡ºæŒ‡ä»¤ -->
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="è§£å†³æœåŠ¡å™¨é—´æ­‡æ€§å¡é¡¿é—®é¢˜"><a href="#è§£å†³æœåŠ¡å™¨é—´æ­‡æ€§å¡é¡¿é—®é¢˜" class="headerlink" title="è§£å†³æœåŠ¡å™¨é—´æ­‡æ€§å¡é¡¿é—®é¢˜"></a>è§£å†³æœåŠ¡å™¨é—´æ­‡æ€§å¡é¡¿é—®é¢˜</h3><ul>
<li><p>âš« è§£å†³æœåŠ¡å™¨é—´æ­‡æ€§å¡é¡¿é—®é¢˜, å„ç§åœºæ™¯ä¸‹çš„å¡é¡¿é¢‘æ¬¡å¹³å‡é™ä½90%</p>
<ul>
<li>å‚è€ƒ <a href="https://www.cnblogs.com/xybaby/p/7491656.html#_label_9" target="_blank" rel="noopener">https://www.cnblogs.com/xybaby/p/7491656.html#_label_9</a></li>
<li><p>å¾ªç¯å¼•ç”¨ä»£ç æ£€æŸ¥æŠ¥è­¦å·¥å…·åˆ¶ä½œ(é€šè¿‡åœ¨tickæ’æ¡©ä»£ç <code>gc.set_debug</code>å’Œä»–çš„debug_flagå‚æ•°), ç±»ä¼¼ä»£ç å¦‚ä¸‹: </p>
  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> gc, time</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OBJ</span><span class="params">(object)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">    self.attr_a = <span class="keyword">None</span></span><br><span class="line">    self.attr_b = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_cycle_reference</span><span class="params">()</span>:</span></span><br><span class="line">    a, b = OBJ(), OBJ()</span><br><span class="line">    a.attr_b = <span class="number">1</span></span><br><span class="line">    b.attr_a = a</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_cycle_reference2</span><span class="params">()</span>:</span></span><br><span class="line">    a, b = OBJ(), OBJ()</span><br><span class="line">    a.attr_b = b</span><br><span class="line">    b.attr_a = a</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    gc.disable() <span class="comment"># è¿™é‡Œæ˜¯å¦disableäº‹å®ä¸Šæ— æ‰€è°“</span></span><br><span class="line">    gc.set_debug(gc.DEBUG_COLLECTABLE | gc.DEBUG_OBJECTS)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> xrange(<span class="number">1</span>):</span><br><span class="line">        show_cycle_reference()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"first gc.collect() result:"</span></span><br><span class="line">    gc.collect()</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"-------------------"</span></span><br><span class="line">    show_cycle_reference2()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"second gc.collect() result:"</span></span><br><span class="line">    gc.collect()</span><br></pre></td></tr></table></figure>
<p>  è¾“å‡ºå¦‚ä¸‹ï¼š</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">first gc.collect() result:</span><br><span class="line">-------------------</span><br><span class="line">second gc.collect() result:</span><br><span class="line">gc: collectable &lt;OBJ 03231A10&gt;</span><br><span class="line">gc: collectable &lt;OBJ 032319F0&gt;</span><br><span class="line">gc: collectable &lt;dict 03234DB0&gt;</span><br><span class="line">gc: collectable &lt;dict 03227E40&gt;</span><br></pre></td></tr></table></figure>
<p>  æ³¨æ„ï¼šåªæœ‰å½“å¯¹è±¡æ˜¯unreachableä¸”collectableçš„æ—¶å€™ï¼Œåœ¨collectçš„æ—¶å€™æ‰ä¼šè¢«è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ˜¯reachableï¼Œæ¯”å¦‚è¢«globalä½œç”¨åŸŸçš„å˜é‡å¼•ç”¨ï¼Œé‚£ä¹ˆä¹Ÿæ˜¯ä¸ä¼šè¾“å‡ºçš„ã€‚é€šè¿‡ä¸Šé¢çš„è¾“å‡ºï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“OBJç±»çš„å®ä¾‹å­˜åœ¨å¾ªç¯å¼•ç”¨ï¼Œ</p>
</li>
<li>å…³é—­pythonçš„gc</li>
<li>æ‰‹åŠ¨åƒåœ¾å›æ”¶, æ¸¸æˆç»“æŸçš„æ—¶å€™å›æ”¶, å¦‚æœæœ¬è¿›ç¨‹è¿˜æœ‰å…¶ä»–æˆ˜æ–—åˆ™è®©ä¸‹ä¸€åœºæˆ˜æ–—åˆ†é…åˆ°å…¶ä»–è¿›ç¨‹ä¸Š</li>
<li>è°ƒé«˜åƒåœ¾å›æ”¶é˜ˆå€¼, ä¾‹å¦‚ä¸€ä¸ªæ¸¸æˆå¯èƒ½åœ¨æŸä¸ªæ—¶åˆ»äº§ç”Ÿå¤§é‡çš„å­å¼¹å¯¹è±¡(å‡å¦‚æ˜¯2000ä¸ª). è€Œæ­¤æ—¶Pythonçš„åƒåœ¾å›æ”¶çš„threshold0ä¸º1000. åˆ™ä¸€æ¬¡åƒåœ¾å›æ”¶ä¼šè¢«è§¦å‘, ä½†è¿™2000ä¸ªå­å¼¹å¯¹è±¡å¹¶ä¸éœ€è¦è¢«å›æ”¶. å¦‚æœæ­¤æ—¶ Pythonçš„åƒåœ¾å›æ”¶çš„threshold0ä¸º10000, åˆ™ä¸ä¼šè§¦å‘åƒåœ¾å›æ”¶. è‹¥å¹²ç§’å, è¿™äº›å­å¼¹å‘½ä¸­ç›®æ ‡è¢«åˆ é™¤, å†…å­˜è¢«å¼•ç”¨è®¡æ•°æœºåˆ¶ è‡ªåŠ¨é‡Šæ”¾, ä¸€æ¬¡(å¯èƒ½å¾ˆè€—æ—¶çš„)åƒåœ¾å›æ”¶è¢«å®Œå…¨çš„é¿å…äº†.è°ƒé«˜é˜ˆå€¼çš„æ–¹æ³•èƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šé¿å…å†…å­˜æº¢å‡ºçš„é—®é¢˜(ä½†ä¸èƒ½å®Œå…¨é¿å…), åŒæ—¶å¯èƒ½å‡å°‘å¯è§‚çš„åƒåœ¾å›æ”¶å¼€é”€. æ ¹æ®å…·ä½“é¡¹ç›® çš„ä¸åŒ, ç”šè‡³æ˜¯ç¨‹åºè¾“å…¥çš„ä¸åŒ, åˆé€‚çš„é˜ˆå€¼ä¹Ÿä¸åŒ. å› æ­¤éœ€è¦åå¤æµ‹è¯•æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„é˜ˆå€¼, è¿™ä¹Ÿç®—è°ƒé«˜é˜ˆå€¼è¿™ç§æ‰‹æ®µ çš„ä¸€ä¸ªç¼ºç‚¹.</li>
<li>ä»£ç è§„èŒƒå°½é‡è‡ªå·±è§£å¼•ç”¨(<code>=None</code>å³å¯)</li>
<li>ä»£ç è§„èŒƒå°½é‡ç”¨å¼±å¼•ç”¨</li>
</ul>
</li>
</ul>
<h2 id="FlyNetæœåŠ¡å™¨å¼•æ“"><a href="#FlyNetæœåŠ¡å™¨å¼•æ“" class="headerlink" title="FlyNetæœåŠ¡å™¨å¼•æ“"></a>FlyNetæœåŠ¡å™¨å¼•æ“</h2><ul>
<li>âš« æ”¯æŒTCP/UDP/å¯é UDPçš„å¤šçº¿ç¨‹ç½‘ç»œåº“ <ul>
<li>ç½‘ç»œåº“ç”¨çš„ä»€ä¹ˆç½‘ç»œæ¨¡å‹? <ul>
<li>reactor, epollå¤šçº¿ç¨‹, æ°´å¹³è§¦å‘, <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/server_model_summary/11.jpg" alt></li>
<li>è¿™ç§æ–¹æ¡ˆçš„ç‰¹ç‚¹æ˜¯one loop per threadï¼Œæœ‰ä¸€ä¸ªmain Reactorè´Ÿè´£accept(2)è¿æ¥ï¼Œç„¶åæŠŠè¿æ¥æŒ‚åœ¨æŸä¸ªsub Reactorä¸­ï¼ˆmuduoé‡‡ç”¨round-robinçš„æ–¹å¼æ¥é€‰æ‹©sub Reactorï¼‰ï¼Œè¿™æ ·è¯¥è¿æ¥çš„æ‰€æœ‰æ“ä½œéƒ½åœ¨é‚£ä¸ªsub Reactoræ‰€å¤„çš„çº¿ç¨‹ä¸­å®Œæˆã€‚å¤šä¸ªè¿æ¥å¯èƒ½è¢«åˆ†æ´¾åˆ°å¤šä¸ªçº¿ç¨‹ä¸­ï¼Œä»¥å……åˆ†åˆ©ç”¨CPUã€‚</li>
<li><a href="#éé˜»å¡çš„connectå’Œaccept">éé˜»å¡çš„connect/acceptæœ‰å•¥ç”¨</a></li>
<li><a href="#é˜»å¡å’Œéé˜»å¡çš„sendå’Œrecvå’Œsendtoå’Œrecvfrom">é˜»å¡å’Œéé˜»å¡çš„sendå’Œsendtoå’Œrecvå’ŒrecvfromåŒºåˆ«?</a></li>
<li><a href="#reuseaddrå’Œreuseport">reuseaddrå’Œreuseport</a></li>
<li><a href="#timewaitå’Œclosewaitå¤ªå¤šå’‹åŠ">timewaitå’Œclosewaitå¤ªå¤šå’‹åŠ</a></li>
</ul>
</li>
<li>udpæ€ä¹ˆå’Œepollé…åˆ?<ul>
<li>å‚è€ƒ <a href="https://cloud.tencent.com/developer/article/1004555" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1004555</a></li>
<li>æœåŠ¡å™¨bindä¸€ä¸ªlisten_fdç„¶åæ”¾åˆ°epollä¸­ç›‘å¬å¯è¯»äº‹ä»¶</li>
<li>epoll_waitè¿”å›æ—¶ï¼Œå¦‚æœepoll_waitè¿”å›çš„äº‹ä»¶fdæ˜¯listen_fdï¼Œè°ƒç”¨recvfromæ¥æ”¶clientç¬¬ä¸€ä¸ªUDPåŒ…å¹¶æ ¹æ®recvfromè¿”å›çš„clientåœ°å€, åˆ›å»ºä¸€ä¸ªæ–°çš„socket(new_fd)ä¸ä¹‹å¯¹åº”ï¼Œè®¾ç½®new_fdä¸ºREUSEADDRå’ŒREUSEPORTã€åŒæ—¶bindæœ¬åœ°åœ°å€local_addrï¼Œç„¶åconnectä¸Šrecvfromè¿”å›çš„clientåœ°å€, å°†æ–°åˆ›å»ºçš„new_fdåŠ å…¥åˆ°epollä¸­å¹¶ç›‘å¬å…¶å¯è¯»ç­‰äº‹ä»¶</li>
<li>clientè¦ä½¿ç”¨å›ºå®šçš„ipå’Œç«¯å£å’Œserverç«¯é€šä¿¡ï¼Œä¹Ÿå°±æ˜¯clientéœ€è¦bindæœ¬åœ°local addressã€‚å¦‚æœclientæ²¡æœ‰bindæœ¬åœ°local addressï¼Œé‚£ä¹ˆåœ¨å‘é€UDPæ•°æ®åŒ…çš„æ—¶å€™ï¼Œå¯èƒ½æ˜¯ä¸åŒçš„Portäº†ï¼Œè¿™æ ·å¦‚æœserver ç«¯çš„<code>new_fd</code> connectçš„æ˜¯clientçš„Port_CAç«¯å£ï¼Œé‚£ä¹ˆå½“Clientçš„Port_CBç«¯å£çš„UDPæ•°æ®åŒ…æ¥åˆ°serveræ—¶ï¼Œå†…æ ¸ä¸ä¼šæŠ•é€’åˆ°new_fdï¼Œç›¸åæ˜¯æŠ•é€’åˆ°listen_fdã€‚</li>
</ul>
</li>
</ul>
</li>
<li>âš« æä¾›RPCã€äºŒè¿›åˆ¶åºåˆ—åŒ–åè®®ä¼ è¾“ã€å‹ç¼©åè®®åŒ…ã€åŠ è§£å¯†æ•°æ®ç­‰åŠŸèƒ½ <ul>
<li><strong>rpcçš„åŸç†</strong>å¤§æ¦‚æ˜¯å…ˆæŠŠå„ä¸ªå‡½æ•°åæ‰«æå‡ºæ¥, ç„¶åé€šè¿‡msgpackæ‰“åŒ…å‘é€, é€šè¿‡pythonçš„åå°„æ‰¾åˆ°ç›¸å…³å‡½æ•°æ‰§è¡Œ</li>
<li><strong>åŠ å¯†ç®—æ³•</strong>æ˜¯ RC4(å¯¹ç§°åŠ å¯†)ï¼Œåœ¨é€šä¿¡å¼€å§‹ä¼šæœ‰ç¡®å®šrc4åŠ å¯†ç§å­çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹æœ‰ç‚¹ç±»ä¼¼äºhttpsæ¡æ‰‹, å®¢æˆ·ç«¯å­˜äº†ä¸€ä»½æœåŠ¡å™¨çš„éå¯¹ç§°åŠ å¯†(rsa)çš„å…¬é’¥ç”¨æ¥åå•†åŠ å¯†ç§å­, åå•†å¥½äº†ä¹‹å, å¼€å§‹ç”¨è¿™ä¸ªåŠ å¯†ç§å­æ¥èµ°rc4åŠ å¯†é€šä¿¡ã€‚</li>
<li><strong>å‹ç¼©è§£å‹é€šè¿‡</strong> zlib å®Œæˆï¼Œ</li>
</ul>
</li>
<li>âš« æ”¯æŒæ•æ·å¼€å‘, æš´éœ²æ¥å£åˆ°è„šæœ¬å±‚, æ¶‰åŠåˆ°Pythonçƒ­æ›´æ–°ã€æ—¥å¿—ã€å®šæ—¶å™¨ã€æ•°æ®æŒä¹…åŒ–ç­‰æ–¹é¢<ul>
<li><strong>pythonçƒ­æ›´</strong>: <ul>
<li>pythonåŸç”Ÿ<code>reload</code>å‡½æ•°çš„é—®é¢˜?<ul>
<li>pythonæœ¬èº«æä¾›äº†reloadå‡½æ•°æ¥è¿›è¡Œæ¨¡å—çš„çƒ­æ›´ï¼Œä½†æ˜¯åªä¼šå¯¹reloadä¹‹ååˆ›å»ºçš„å¯¹è±¡ç”Ÿæ•ˆï¼Œæ—§å¯¹è±¡æ‰€è¿è¡Œçš„ä¾ç„¶æ˜¯æ—§ä»£ç </li>
</ul>
</li>
<li>çƒ­æ›´æµç¨‹:<br>  1. å‡†å¤‡æ–°çš„ä»£ç æ–‡ä»¶ï¼Œç›´æ¥æ›¿æ¢è¿›ç¨‹é›†ç¾¤çš„åŸæœ‰ä»£ç æ–‡ä»¶ï¼ˆå¤–ç½‘ç¯å¢ƒä¸€èˆ¬é€šè¿‡ luna å®Œæˆï¼‰<br>  2. æ‰§è¡Œ AdminClient.py è®© GameManager é€šçŸ¥é›†ç¾¤å†…æ‰€æœ‰ game è¿›ç¨‹è½½å…¥æ–°ä»£ç ï¼Œæ‰§è¡Œçƒ­æ›´æ–°æµç¨‹<pre><code>`python  -m %MOBILENAME%.tools.AdminClient --configfile %CONFIG% --runscript %SCRIPT% --script_args AvatarCenter`
</code></pre>  3. æ‰€æœ‰çš„ game è¿›ç¨‹æ”¶åˆ°çƒ­æ›´æ–°å‘½ä»¤ä¹‹åï¼Œæ‰§è¡Œ reload.py </li>
<li>çƒ­æ›´çš„å…·ä½“å®ç°:<br>  1. åè®®åœ¨ PEP320 ä¸­è¢«æå‡ºï¼Œæœ‰ä¸¤ä¸ªä¸»è¦çš„ç»„æˆæ¦‚å¿µï¼šfinder å’Œ loader ã€‚finder çš„ä»»åŠ¡æ˜¯ç¡®å®šèƒ½å¦æ ¹æ®å·²çŸ¥çš„ç­–ç•¥æ‰¾åˆ°è¯¥åç§°çš„æ¨¡å—ã€‚åŒæ—¶å®ç°äº† finder å’Œ loader æ¥å£çš„å¯¹è±¡å«åš importer<br>  2. æˆ‘ä»¬æ ¹æ®æ­¤åè®®å®ç°ä¸€ä¸ª åŒ…å« finder å’Œ loader çš„ importer æ¨¡å—, æˆ‘ä»¬åœ¨è¿™ä¸ªæ¨¡å—ä¸­ä¸»è¦æ˜¯åœ¨finderä¸­å®ç°å¯¹funcä¸propertyçš„æ›¿æ¢, èµ°çš„æ˜¯æ›¿æ¢func_codeçš„è·¯å­<br>  3. å¾€ sys.meta_path æ·»åŠ è¿™ä¸ª finder æ³¨å†Œ meta_hook(import hookçš„ä¸€ç§, ä½ å¯ä»¥åœ¨è¿™é‡Œé‡è½½å¯¹ sys.pathã€frozen module ç”šè‡³å†…ç½® module çš„å¤„ç†)<br>  4. ä»<code>sys.modules</code>ä¸­æŠŠæƒ³è¦çƒ­æ›´çš„moduleå…ˆpopå‡ºå»<br>  5. æ‰§è¡Œ<code>__import__(wanna_reload_module_name)</code> æ¥å¯¼å…¥ç›¸åº”æƒ³reloadçš„æ¨¡å—</li>
<li>æ›¿æ¢func_codeçš„è·¯å­:<ul>
<li>å¦‚æœæ˜¯propertyç±»çš„attr, åˆ™ç›´æ¥æ›¿æ¢</li>
<li>å¦‚æœæ˜¯func/methodç±»å‹çš„, åˆ™æ›¿æ¢func_code</li>
<li>å¦‚æœæœ‰è£…é¥°å™¨åˆ™æ³¨æ„é€’å½’æ›¿æ¢funcé‡Œçš„closureé‡Œçš„cellé‡Œçš„cell_content(å› ä¸ºç”¨äº†è£…é¥°å™¨çš„è¯, function objecté‡Œçš„func_closureé‡Œè¿˜æœ‰ function object)</li>
</ul>
</li>
<li>å¢é‡çƒ­æ›´/å…¨é‡çƒ­æ›´: å¢é‡çƒ­æ›´é€šè¿‡è®°å½•æ”¹åŠ¨äº†çš„æ–‡ä»¶æ¥åšçƒ­æ›´, ä½†æ˜¯å®¹æ˜“äº§ç”Ÿfromâ€¦importâ€¦çš„é‚£äº›æ²¡æœ‰æ›´åˆ°</li>
<li>å®šä¹‰å›è°ƒæ¥å£: <code>after_reload</code>/<code>on_reload</code>ç­‰</li>
</ul>
</li>
<li><strong>æ—¥å¿—</strong>: <ul>
<li>æ¸¸æˆä¸»çº¿ç¨‹å°†æ—¥å¿—æ•°æ®ä¿å­˜åœ¨æ®ç¼“å­˜é˜Ÿåˆ—ä¸­ï¼Œç”±ä¸“é—¨çš„æ—¥å¿—çº¿ç¨‹è´Ÿè´£æ‰§è¡Œå†™å…¥ç¡¬ç›˜ï¼Œä¿æŒä¸»çº¿ç¨‹ä¸é˜»å¡ç©æ³•é€»è¾‘çš„æ‰§è¡Œã€‚åœ¨æ¸¸æˆè¿›ç¨‹å‘ç”Ÿcrashçš„æ—¶å€™ï¼Œä¿å­˜åœ¨å†…å­˜ä¸­çš„æ•°æ®å¯èƒ½æ¥ä¸åŠå†™å…¥ç¡¬ç›˜è€Œä¸¢å¤±ã€‚ é»˜è®¤çš„ Linux ç¯å¢ƒä¸‹æ—¥å¿—ä¼šå†™å¾€æ ‡å‡†è¾“å‡ºï¼Œç”± SA è´Ÿè´£é‡å®šå‘åˆ°ç‰¹å®šçš„æ—¥å¿—æ–‡ä»¶</li>
<li>åŒç¼“å†²æŠ€æœ¯ï¼ŒåŸºæœ¬æ€è·¯æ˜¯å‡†å¤‡ä¸¤å—ç¼“å†²ï¼šAä¸Bï¼Œå‰ç«¯è´Ÿè´£å¾€buffer Aä¸­å¡«æ•°æ®ï¼ˆæ—¥å¿—æ¶ˆæ¯ï¼‰ï¼Œåç«¯çº¿ç¨‹ç­‰å¾…åœ¨æ¡ä»¶å˜é‡ä¸Šè´Ÿè´£å°†buffer Bä¸­çš„æ•°æ®å†™å…¥æ–‡ä»¶ã€‚å½“buffer Aå†™æ»¡ä¹‹åï¼Œäº¤æ¢Aä¸Bï¼Œç„¶ånotifyè¿™ä¸ªæ¡ä»¶å˜é‡å”¤é†’åç«¯å°†buffer Aä¸­çš„æ•°æ®å†™å…¥æ–‡ä»¶ï¼Œè€Œå‰ç«¯è´Ÿè´£å¾€buffer Bä¸­å¡«å…¥æ–°çš„æ—¥å¿—æ–‡ä»¶ã€‚å¦‚æ­¤å¾€å¤ã€‚</li>
<li>ç”¨ä¸¤ä¸ªbufferçš„å¥½å¤„æ˜¯åœ¨æ–°å»ºæ—¥å¿—æ¶ˆæ¯çš„æ—¶å€™ä¸å¿…ç­‰å¾…ç£ç›˜æ–‡ä»¶æ“ä½œï¼Œä¹Ÿé¿å…æ¯æ¡æ¶ˆæ¯éƒ½è§¦å‘ï¼ˆå”¤é†’ï¼‰äº†åç«¯æ—¥å¿—çº¿ç¨‹ã€‚æ¢è¨€ä¹‹ï¼Œå‰ç«¯ä¸æ˜¯å°†ä¸€æ¡æ¡æ¶ˆæ¯åˆ†åˆ«ä¼ é€ç»™åç«¯ï¼Œè€Œæ˜¯å°†å¤šä¸ªæ—¥å¿—æ¶ˆæ¯æ‹¼æˆä¸€ä¸ªå¤§çš„bufferä¼ é€ç»™åç«¯ï¼Œç›¸å½“äºæ‰¹å¤„ç†ï¼Œå‡å°‘äº†çº¿ç¨‹å”¤é†’çš„é¢‘ç‡ï¼Œé™ä½äº†å¼€é”€ã€‚å¦å¤–ï¼Œä¸ºäº†åŠæ—¶å°†æ¶ˆæ¯å†™å…¥æ–‡ä»¶ï¼Œå³ä½¿å‰ç«¯çš„buffer Aæœªå†™æ»¡ï¼Œæ—¥å¿—åº“ä¹Ÿä¼šæ¯ä¸‰ç§’(æ¡ä»¶å˜é‡çš„è¶…æ—¶æ—¶é—´ä¸º3ç§’)æ‰§è¡Œä¸€æ¬¡ä¸Šè¿°äº¤æ¢å†™å…¥æ“ä½œã€‚</li>
<li>å¦‚æœå‰ç«¯æ‹¼å‘½å†™æ¶ˆæ¯æ—¥å¿—, è¶…è¿‡äº†åç«¯çš„å¤„ç†è¾“å‡ºèƒ½åŠ›, åˆ™ç›´æ¥ä¸¢å¼ƒ</li>
</ul>
</li>
<li><strong>æ•°æ®æŒä¹…åŒ–</strong>: gameã€game manager ä¹‹ç±»éœ€è¦æ“ä½œæ•°æ®åº“çš„è¿›ç¨‹å¹¶ä¸ç›´æ¥è¿æ¥æ•°æ®åº“ï¼Œè€Œæ˜¯ db manager æä¾›æ•°æ®åº“è¯»å†™çš„æœåŠ¡ï¼Œä¾›å…¶ä»–è¿›ç¨‹è°ƒç”¨ã€‚çº¿ä¸Šæ•°æ®åº“å‡ºç°æœºå™¨æ•…éšœã€æ¢ä¸»æ—¶ï¼Œgame è¿›ç¨‹çš„ä»£ç æ— éœ€åšé”™è¯¯å¤„ç†ï¼Œdb mangaer ä¼šè´Ÿè´£è‡ªåŠ¨é‡è¯•ã€‚</li>
</ul>
</li>
</ul>
<h2 id="å‡†å¤‡å¥½ä¸€ä¸ªçº¿ä¸Šäº‹æ•…çš„å¤„ç†äº‹ä¾‹"><a href="#å‡†å¤‡å¥½ä¸€ä¸ªçº¿ä¸Šäº‹æ•…çš„å¤„ç†äº‹ä¾‹" class="headerlink" title="å‡†å¤‡å¥½ä¸€ä¸ªçº¿ä¸Šäº‹æ•…çš„å¤„ç†äº‹ä¾‹"></a>å‡†å¤‡å¥½ä¸€ä¸ªçº¿ä¸Šäº‹æ•…çš„å¤„ç†äº‹ä¾‹</h2><ul>
<li><a href="#ä½¿ç”¨straceå’ŒpstackæŸ¥è¯¢çº¿ä¸Šcpuçš„100é—®é¢˜"></a></li>
<li><a href="#å¦‚ä½•è§£å†³pythonè¿›ç¨‹cpuçš„100é—®é¢˜"></a></li>
<li><a href="#ç”¨ASANå¤„ç†å†…å­˜æ³„æ¼ä¸è¶Šç•Œç­‰é—®é¢˜"></a></li>
</ul>
<h2 id="å‡†å¤‡å¥½ä¸€ä¸ªéš¾å¿˜çš„ä¼˜åŒ–"><a href="#å‡†å¤‡å¥½ä¸€ä¸ªéš¾å¿˜çš„ä¼˜åŒ–" class="headerlink" title="å‡†å¤‡å¥½ä¸€ä¸ªéš¾å¿˜çš„ä¼˜åŒ–"></a>å‡†å¤‡å¥½ä¸€ä¸ªéš¾å¿˜çš„ä¼˜åŒ–</h2><p>å»ºè®®ä»æ¸¸æˆå¡é¡¿è¯´èµ·,</p>
<p>åç«¯å¡é¡¿ä¼˜åŒ–:  </p>
<ul>
<li>é«˜æ€§èƒ½æ—¶é—´è½®å®šæ—¶å™¨ä¹Ÿç®—æ˜¯</li>
<li>pyåƒåœ¾å›æ”¶å¡é¡¿ä¼˜åŒ–</li>
<li>rudpä¼˜åŒ–, dupackä¼˜åŒ–, åŠ¨æ€å†—ä½™, é€‰æ‹©æ€§é‡ä¼ , ä¸ä¸¢åŒ…é€€è®©, ç²¾ç®€åŒ…å¤´å¹¶åŠ å…¥rdcLen</li>
</ul>
<p>å‰ç«¯ä¼˜åŒ–:  </p>
<ul>
<li>çŠ¶æ€ç¼“å†²å™¨</li>
<li>å¹³æ»‘æ’å€¼</li>
<li>å‰ç«¯é¢„è¡¨ç°, åŠ å…¥å‰æ‘‡åæ‘‡æœºåˆ¶, æŠ€èƒ½å…ˆç , ç„¶åå»¶è¿Ÿè¡¥å¿, ç”±æœåŠ¡å™¨æ§åˆ¶é£˜è¡€</li>
<li>é¢„å…ˆè®¡ç®—æŠ€èƒ½moveè·¯çº¿, è®¡ç®—é™æ€ç¢°æ’, è®¡ç®—è½ç‚¹ä¸æ›²çº¿, åŠ¨æ€ç¢°æ’é€šè¿‡ç‰¹æ•ˆæ©ç›–</li>
</ul>
<h2 id="ä¸ªäººå¼€æº-realtime-serveræœåŠ¡å™¨æ¡†æ¶"><a href="#ä¸ªäººå¼€æº-realtime-serveræœåŠ¡å™¨æ¡†æ¶" class="headerlink" title="ä¸ªäººå¼€æº-realtime-serveræœåŠ¡å™¨æ¡†æ¶"></a>ä¸ªäººå¼€æº-realtime-serveræœåŠ¡å™¨æ¡†æ¶</h2><ul>
<li>âš« ç›®å‰åœ¨GitHubå·²æœ‰315ä¸ªstar </li>
<li>âš« ä¸ºè‘—åå¼€æºé¡¹ç›®kcpå¿«é€Ÿå¯é ä¼ è¾“åè®®è´¡çŒ®äº†é€šç”¨çš„å•å¤´æ–‡ä»¶çš„ä¼šè¯å®ç°, ä»¥åŠç§»åŠ¨å¼±ç½‘çš„é’ˆå¯¹æ€§æ”¹é€ , è¾¾åˆ°äº†ä»¥20%æµé‡æ¢å–ä»£ä»·æ¢å–35%çš„å»¶è¿Ÿé™ä½æ•ˆæœ </li>
<li><p>âš« ä¸ºè‘—åå¼€æºé¡¹ç›®muduoç½‘ç»œåº“è´¡çŒ®äº†æ·»åŠ äº†UDPæ‰©å±•æ”¯æŒ </p>
<ul>
<li><a href="/muduo_qa/" title="muduoçš„éš¾ç‚¹è¯¦è§£">muduoçš„éš¾ç‚¹è¯¦è§£</a></li>
<li>muduoä¸ºä»€ä¹ˆé‡‡ç”¨epollæ°´å¹³è§¦å‘?<ul>
<li>ä¸pollå…¼å®¹<ul>
<li>LTæ¨¡å¼ä¸ä¼šå‘ç”Ÿæ¼æ‰äº‹ä»¶çš„BUGï¼Œä½†POLLOUTäº‹ä»¶ä¸èƒ½ä¸€å¼€å§‹å°±å…³æ³¨ï¼Œå¦åˆ™ä¼šå‡ºç°busy loopï¼Œè€Œåº”è¯¥åœ¨writeæ— æ³•å®Œå…¨å†™å…¥å†…æ ¸ç¼“å†²åŒºçš„æ—¶å€™æ‰å…³æ³¨ï¼Œå°†æœªå†™å…¥å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ·»åŠ åˆ°åº”ç”¨å±‚output bufferï¼Œç›´åˆ°åº”ç”¨å±‚output bufferå†™å®Œï¼Œåœæ­¢å…³æ³¨POLLOUTäº‹ä»¶ã€‚</li>
<li>è¯»å†™çš„æ—¶å€™ä¸å¿…ç­‰å€™EAGAINï¼Œå¯ä»¥èŠ‚çœç³»ç»Ÿè°ƒç”¨æ¬¡æ•°ï¼Œé™ä½å»¶è¿Ÿã€‚ï¼ˆæ³¨ï¼šå¦‚æœç”¨ETæ¨¡å¼ï¼Œè¯»çš„æ—¶å€™è¯»åˆ°EAGAIN,å†™çš„æ—¶å€™ç›´åˆ°output bufferå†™å®Œæˆ–è€…EAGAINï¼‰æ‰€ä»¥å¯è§LTæ¨¡å¼ï¼ˆå¯ä»¥å°½å¯èƒ½å¤šè¯»å‡å°‘ç³»ç»Ÿè°ƒç”¨ï¼‰æ•ˆç‡ä¸ä¸€å®šæ¯”ETè¦ä½ï¼ˆå¤šäº†ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œæ£€æµ‹EAGAINï¼‰</li>
</ul>
</li>
</ul>
</li>
<li><p>muduoçš„bufferæ€ä¹ˆåšçš„, çœ‹muduoä¹¦å§</p>
<ul>
<li><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// +-------------------+------------------+------------------+</span></span><br><span class="line"><span class="comment">/// | prependable bytes |  readable bytes  |  writable bytes  |</span></span><br><span class="line"><span class="comment">/// |                   |     (CONTENT)    |                  |</span></span><br><span class="line"><span class="comment">/// +-------------------+------------------+------------------+</span></span><br><span class="line"><span class="comment">/// |                   |                  |                  |</span></span><br><span class="line"><span class="comment">/// 0      &lt;=      readerIndex   &lt;=   writerIndex    &lt;=     size</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨éé˜»å¡ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œå¦‚ä½•è®¾è®¡å¹¶ä½¿ç”¨ç¼“å†²åŒºï¼Ÿ<br>ä¸€æ–¹é¢å¸Œæœ›å‡å°‘ç³»ç»Ÿè°ƒç”¨ï¼Œä¸€æ¬¡è¯»å–çš„æ•°æ®è¶Šå¤šè¶Šåˆ’ç®—ï¼›å¦ä¸€æ–¹é¢å¸Œæœ›å‡å°‘å†…å­˜çš„å ç”¨ã€‚è¿™ä¸¤æ–¹é¢ä¼¼ä¹æ˜¯çŸ›ç›¾çš„ï¼Œå‡è®¾C10K ï¼Œæ¯ä¸ªè¿æ¥ä¸€å»ºç«‹å°±åˆ†é…50KB çš„å†…å­˜çš„è¯ï¼Œé‚£ä¹ˆå°†å ç”¨1GB å†…å­˜ï¼Œä½†æ˜¯å¤§å¤šæ•°çš„è¿æ¥å¹¶ä¸éœ€è¦è¿™ä¹ˆå¤šå†…å­˜ã€‚muduo å·§å¦™çš„ä½¿ç”¨äº†readv() ç»“åˆæ ˆä¸Šç©ºé—´å·§å¦™çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚<br>åœ¨æ ˆä¸Šå‡†å¤‡ä¸€ä¸ª64KBçš„extrabuf , ç„¶ååˆ©ç”¨readv() æ¥è¯»å–æ•°æ®ï¼Œiovecæœ‰ä¸¤å—ï¼Œç¬¬ä¸€å—æ˜¯æŒ‡å‘muduo Buffer ï¼ˆä¸ºæ¯ä¸ªè¿æ¥å‡†å¤‡1KBçš„bufï¼‰ä¸­çš„writeable å­—èŠ‚ï¼Œå¦ä¸€å—æ˜¯æŒ‡å‘extrabufã€‚è¿™æ ·å¦‚æœè¯»å…¥çš„æ•°æ®ä¸å¤šï¼Œç›´æ¥è¯»åˆ°å†…ç½®çš„bufï¼›å¦‚æœé•¿åº¦è¶…è¿‡å†…ç½®buf çš„å¤§å°ï¼Œå°±ä¼šè¯»åˆ°æ ˆä¸Šçš„extrabuf ä¸­ï¼Œç„¶åç¨‹åºå†æŠŠextrabuf é‡Œçš„æ•°æ®append() åˆ° buf ä¸­ã€‚</p>
</li>
<li>ä¸ºå•¥extrabufæ˜¯64KB?<ul>
<li>å› ä¸ºå¹³æ—¶ä¸€èˆ¬éƒ½é˜»å¡åœ¨pollä¸Š, æ¥äº†æ•°æ®é©¬ä¸Šå°±å¤„ç†çš„è¯ä¹Ÿå°±å‡ kè€Œå·², å³ä½¿æ˜¯åƒå…†ç½‘å¡100MB/s, 500å¾®ç§’ä¹Ÿå°±æ˜¯500/1000000ç§’ä¹Ÿå°±æ˜¯0.5æ¯«ç§’, <code>100MB/s * (500/1000000) = 50000B</code>, ä¹Ÿå°±æ˜¯è¯´0.5æ¯«ç§’å°±æ˜¯50000å­—èŠ‚çš„æ•°æ®, 64kå·²ç»è¶³å¤Ÿå®¹çº³åƒå…†ç½‘åœ¨0.5æ¯«ç§’å…¨é€Ÿæ”¶åˆ°çš„æ•°æ®äº†.   </li>
<li>ä¸€èˆ¬æ¥è¯´, ä¸€æ¬¡readvå°±èƒ½è¯»å®Œè¿™æ¬¡è¿‡æ¥çš„æ•°æ®äº†, å¦‚æœç”¨å®Œäº†writeableå’Œextrabufè¿˜æ˜¯ä¸å¤Ÿ, é‚£å°±å†readvä¸€æ¬¡å˜›</li>
</ul>
</li>
<li>muduoæ¯ä¸ªè¿æ¥éƒ½æœ‰ä¸€ä¸ªbufferä¹ˆ?åˆå§‹å¤§å°å¤šå¤§?ç¼©æ‰©å®¹çš„æ—¶æœºæ˜¯? <ul>
<li>æ˜¯çš„, æ¯ä¸ªè¿æ¥éƒ½æœ‰ä¸€ä¸ªsendçš„bufferå’Œreadçš„buffer, éƒ½æ˜¯åˆå§‹å¤§å°1024å­—èŠ‚(å³1KB), ä¸€èˆ¬ä¸ç¼©å®¹, åªæ‰©å®¹<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">makeSpace</span><span class="params">(<span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (writableBytes() + prependableBytes() &lt; len + kCheapPrepend)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">FIXME:</span> move readable data</span></span><br><span class="line">    buffer_.resize(writerIndex_+len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">// move readable data to the front, make space inside buffer</span></span><br><span class="line">    assert(kCheapPrepend &lt; readerIndex_);</span><br><span class="line">    <span class="keyword">size_t</span> readable = readableBytes();</span><br><span class="line">    <span class="built_in">std</span>::copy(begin()+readerIndex_,</span><br><span class="line">                begin()+writerIndex_,</span><br><span class="line">                begin()+kCheapPrepend);</span><br><span class="line">    readerIndex_ = kCheapPrepend;</span><br><span class="line">    writerIndex_ = readerIndex_ + readable;</span><br><span class="line">    assert(readable == readableBytes());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="æœ‰å•¥å¯ä»¥é—®ä»–çš„"><a href="#æœ‰å•¥å¯ä»¥é—®ä»–çš„" class="headerlink" title="æœ‰å•¥å¯ä»¥é—®ä»–çš„"></a>æœ‰å•¥å¯ä»¥é—®ä»–çš„</h2><p>æŠ€æœ¯:  </p>
<ul>
<li>æŠ€æœ¯æ ˆ</li>
<li>åå‘æœ‰æ‹›è˜æœ‰å“ªäº›ç»éªŒçš„? è§†é¢‘?éŸ³é¢‘?ç”µå•†å¼€å‘?(é—®å®Œä¹‹åå¯ä»¥å›å»å¥½å¥½äº†è§£ç›¸å…³é¢†åŸŸ)</li>
<li>å›¢é˜Ÿæˆå‘˜æ•°é‡ä¸å¹´é¾„ç»„æˆ</li>
</ul>
<p>äººäº‹:  </p>
<ul>
<li>èŒçº§ä½“ç³»/æ™‹å‡é€šé“</li>
<li>å…¬å¸æ¶æ„ä½“ç³», æœ‰å“ªäº›äº‹ä¸šéƒ¨</li>
</ul>
<h2 id="è­¦å‘Š"><a href="#è­¦å‘Š" class="headerlink" title="è­¦å‘Š"></a>è­¦å‘Š</h2><ul>
<li><strong>å°½é‡æŠŠç†Ÿæ‚‰çš„ä¸œè¥¿è¯´å¤šä¸€ç‚¹ï¼Œ èƒŒä¸‹æ¥ï¼Œ è¯´å…¨ä¸€ç‚¹ï¼Œ å¡«æ»¡æ•´ä¸ªé¢è¯•æ—¶é—´ï¼Œ ä»–å°±æ²¡æœ‰é‚£ä¹ˆå¤šé—®é¢˜è¦é—®ï¼Œ é—®äº†è¶Šå¤šï¼Œ è¨€å¤šå¿…å¤±</strong></li>
<li><strong>ä¸è¦è¯´è‡ªå·±ä¹‹å‰çš„å·¥ä½œå†…å®¹è·Ÿä»–ä»¬ç›®å‰çš„å·¥ä½œå†…å®¹ä¸ç›¸å…³ï¼Œ ä¸è¦æ‰¾å€Ÿå£å•¥çš„ï¼Œ åè€Œä¼šåŠ æ·±ä»–å²—ä½ä¸åŒ¹é…çš„å°è±¡</strong></li>
<li><strong>ä¸è¦é—®é¢å¾—æ€ä¹ˆæ ·ï¼Œ ä»–ä¸ä¼šå‘Šè¯‰ä½ çš„</strong></li>
</ul>
<h1 id="é¢ç­‹"><a href="#é¢ç­‹" class="headerlink" title="é¢ç­‹"></a>é¢ç­‹</h1><h2 id="æ¯”ç‹—"><a href="#æ¯”ç‹—" class="headerlink" title="æ¯”ç‹—"></a>æ¯”ç‹—</h2><ul>
<li>å¤§æ•°ç›¸åŠ </li>
<li>å…¨æ’åˆ—</li>
<li>mysqlè¯­å¥ orderby/limit </li>
<li>ä¸¥æ ¼é€’å¢çš„åˆ†å¸ƒå¼idç”Ÿæˆå™¨æ€ä¹ˆåš <a href="https://tech.meituan.com/2017/04/21/mt-leaf.html" target="_blank" rel="noopener">ç¾å›¢è¿™ç¯‡æ–‡ç« çš„â€Leaf-segmentæ•°æ®åº“æ–¹æ¡ˆâ€</a></li>
<li>å¼‚åœ°å¤šæ´» </li>
<li>ioçº¿ç¨‹å’Œä¸šåŠ¡çº¿ç¨‹è¦åˆ†å¼€å—? æ˜¯çš„</li>
<li>åˆå¹¶å­—ç¬¦ä¸²ä¸­çš„è¿ç»­ç©ºæ ¼ä¸ºä¸€ä¸ªå¦‚<code>&quot;^he^^^^ll^o^^&quot;</code> å¾—åˆ° <code>&quot;^he^ll^o^&quot;</code></li>
</ul>
<h2 id="è™¾"><a href="#è™¾" class="headerlink" title="è™¾"></a>è™¾</h2><h3 id="toc-one"><a href="#toc-one" class="headerlink" title="toc_one"></a>toc_one</h3><ul>
<li>pythonå®ç°<ul>
<li>ç»§æ‰¿</li>
<li>å­—å…¸</li>
</ul>
</li>
<li>linux<ul>
<li>å†…å­˜å¸ƒå±€(æ–‡åˆå †æ ˆ)<a href="#Linuxè™šæ‹Ÿåœ°å€ç©ºé—´å¦‚ä½•åˆ†å¸ƒ">Linuxè™šæ‹Ÿåœ°å€ç©ºé—´å¦‚ä½•åˆ†å¸ƒ</a><ul>
<li>åŠ¨æ€åº“æ”¾åœ¨å“ªå„¿</li>
</ul>
</li>
<li>é€šè¿‡è¿›ç¨‹æ‰¾ä»–æ­£åœ¨è¯»å†™çš„æ–‡ä»¶<ul>
<li>å¯èƒ½æ˜¯ <code>/proc</code>? <a href="#procæ–‡ä»¶å¤¹">procé‡Œæœ‰ä¸ªfd</a></li>
</ul>
</li>
<li>é€šè¿‡æ–‡ä»¶æ‰¾è¿›ç¨‹<ul>
<li>lsofä»€ä¹ˆå‚æ•° <a href="/linux_command_netstat_lsof/" title="Linuxå¸¸ç”¨è¿ç»´å‘½ä»¤(netstatå’Œlsof)ç¬”è®°æ•´ç†(äºŒ)">Linuxå¸¸ç”¨è¿ç»´å‘½ä»¤(netstatå’Œlsof)ç¬”è®°æ•´ç†(äºŒ)</a></li>
</ul>
</li>
<li><a href="#å†…æ ¸æ€ä¸ç”¨æˆ·æ€çš„åŒºåˆ«">å†…æ ¸æ€å’Œç”¨æˆ·æ€åŒºåˆ«</a></li>
</ul>
</li>
<li>å¿«æ’åŸå€æ’åºçš„è¯è¦ç”¨å‡ ä¸ªindexæ¥åš?<ul>
<li>å‚è€ƒ: <a href="/quick_sort_and_binary_search/" title="æ’åºç®—æ³•ä¸‰ä¹‹è°ˆä¸€è°ˆå¿«æ’ä¼˜åŒ–å’ŒäºŒåˆ†æŸ¥æ‰¾">æ’åºç®—æ³•ä¸‰ä¹‹è°ˆä¸€è°ˆå¿«æ’ä¼˜åŒ–å’ŒäºŒåˆ†æŸ¥æ‰¾</a></li>
<li>ä¸¤ä¸ª, ä¸€ä¸ªindexæŒ‡å‘æœ€åä¸€ä¸ªæ¯”pivotå°çš„å…ƒç´ , åˆå§‹åŒ–ä¸º-1, ä¸€ä¸ªæŒ‡å‘å°†è¦éå†çš„å…ƒç´ </li>
</ul>
</li>
<li><p>äºŒå‰æ ‘</p>
<ul>
<li><p>æ‰¾æœ€è¿‘å…¬å…±çˆ¶èŠ‚ç‚¹: </p>
<ul>
<li>å‚è€ƒ: <a href="https://leetcode-cn.com/problems/lowest-common-ancestor-of-a-binary-tree/solution/236-er-cha-shu-de-zui-jin-gong-gong-zu-xian-jian-j/" target="_blank" rel="noopener">https://leetcode-cn.com/problems/lowest-common-ancestor-of-a-binary-tree/solution/236-er-cha-shu-de-zui-jin-gong-gong-zu-xian-jian-j/</a></li>
<li>ä¸¤ä¸ªèŠ‚ç‚¹ p,q åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š<br>1) p å’Œ q åœ¨ç›¸åŒå­æ ‘ä¸­<br>2) p å’Œ q åœ¨ä¸åŒå­æ ‘ä¸­<br>ä»æ ¹èŠ‚ç‚¹éå†ï¼Œé€’å½’å‘å·¦å³å­æ ‘æŸ¥è¯¢èŠ‚ç‚¹ä¿¡æ¯<br>é€’å½’ç»ˆæ­¢æ¡ä»¶ï¼šå¦‚æœå½“å‰èŠ‚ç‚¹ä¸ºç©ºæˆ–ç­‰äº p æˆ– qï¼Œåˆ™è¿”å›å½“å‰èŠ‚ç‚¹<br>é€’å½’éå†å·¦å³å­æ ‘ï¼Œå› ä¸ºæ˜¯é€’å½’ï¼Œä½¿ç”¨å‡½æ•°åå¯è®¤ä¸ºå·¦å³å­æ ‘å·²ç»ç®—å‡ºç»“æœï¼Œè¿™å¥è¯è¦è®°ä½ï¼Œé“å‡ºäº†é€’å½’çš„ç²¾é«“,<br>å¦‚æœå·¦å³å­æ ‘æŸ¥åˆ°èŠ‚ç‚¹éƒ½ä¸ä¸ºç©ºï¼Œåˆ™è¡¨æ˜ p å’Œ q åˆ†åˆ«åœ¨å·¦å³å­æ ‘ä¸­ï¼Œå› æ­¤ï¼Œå½“å‰èŠ‚ç‚¹å³ä¸ºæœ€è¿‘å…¬å…±ç¥–å…ˆï¼›<br>å¦‚æœå·¦å³å­æ ‘å…¶ä¸­ä¸€ä¸ªä¸ä¸ºç©ºï¼Œåˆ™è¿”å›éç©ºèŠ‚ç‚¹ã€‚<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeNode* <span class="title">lowestCommonAncestor</span><span class="params">(TreeNode* root, TreeNode* p, TreeNode* q)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!root || root == p || root == q) <span class="keyword">return</span> root;</span><br><span class="line">        TreeNode *left = lowestCommonAncestor(root-&gt;left, p, q);</span><br><span class="line">        TreeNode *right = lowestCommonAncestor(root-&gt;right, p, q);</span><br><span class="line">        <span class="keyword">if</span> (left &amp;&amp; right) <span class="keyword">return</span> root;</span><br><span class="line">        <span class="keyword">return</span> left ? left : right;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>åˆ¤æ–­æ˜¯å¦ä¸ºä¸€ä¸ªäºŒå‰æœç´¢æ ‘</p>
<ul>
<li>è®°ä½ä¸€ç‚¹, å…¶ä¸­åºéå†æ˜¯ä¸€ä¸ªæœ‰åºæ•°ç»„</li>
<li>åˆ¤æ–­ä¸€æ£µæ ‘æ˜¯ä¸æ˜¯BSTæ ‘æ–¹æ³•ï¼šä½¿ç”¨ä¸­åºéå†<br>  1) å¯¹æ ‘è¿›è¡Œä¸­åºéå†ï¼Œå°†ç»“æœä¿å­˜åœ¨tempæ•°ç»„ä¸­ã€‚<br>  2) æ£€æµ‹tempæ•°ç»„ä¸­å…ƒç´ æ˜¯å¦ä¸ºå‡åºæ’åˆ—ã€‚å¦‚æœæ˜¯ï¼Œåˆ™è¿™æ£µæ ‘ä¸ºBST.</li>
</ul>
</li>
</ul>
</li>
<li><a href="#redisé›†ç¾¤">redisé›†ç¾¤</a><ul>
<li>æ€ä¹ˆæ‰©ç¼©å®¹</li>
<li><a href="#HashSlotç®—æ³•">å®¢æˆ·ç«¯æ€ä¹ˆæ‰¾åˆ°æŸä¸ªé”®æ‰€åœ¨çš„èŠ‚ç‚¹</a></li>
<li>æŒä¹…åŒ–æœ‰å“ªäº›<ul>
<li>rewrite_aofæ€ä¹ˆæ›¿æ¢åŸæ¥çš„aofæ–‡ä»¶çš„?<a href="#AOFé‡å†™çš„å®ç°">AOFé‡å†™çš„å®ç°</a></li>
</ul>
</li>
</ul>
</li>
<li>sendå’Œsendtoæ˜¯é˜»å¡çš„ä¹ˆ?é˜»å¡åˆ°åº•æ„å‘³ç€ä»€ä¹ˆ?<a href="#é˜»å¡å’Œéé˜»å¡çš„sendå’Œrecvå’Œsendtoå’Œrecvfrom">é˜»å¡å’Œéé˜»å¡çš„sendå’Œrecvå’Œsendtoå’Œrecvfrom</a><ul>
<li>sendè¿”å›å€¼æ„å‘³ç€å•¥?æ„å‘³ç€å¯¹æ–¹çœŸçš„å°±æ”¶åˆ°äº†å¤šå°‘æ•°æ®ä¹ˆ?</li>
</ul>
</li>
</ul>
<h3 id="infra-one"><a href="#infra-one" class="headerlink" title="infra_one"></a>infra_one</h3><ul>
<li>lsm-tree pending_fin</li>
<li>muduoçš„bufferæ€ä¹ˆåšçš„, çœ‹muduoä¹¦å§ <a href="#ä¸ªäººå¼€æº-realtime-serveræœåŠ¡å™¨æ¡†æ¶">ä¹Ÿå¯å‚è€ƒè¿™é‡Œ</a></li>
<li>è·³è¡¨å¢åŠ æ•°æ®çš„æ—¶å€™, ç´¢å¼•æ€ä¹ˆå˜åŒ–?<ul>
<li><a href="/algo_newbie/#è·³è¡¨å¢åŠ æ•°æ®æ—¶ç´¢å¼•æ€ä¹ˆå˜åŒ–">è·³è¡¨å¢åŠ æ•°æ®æ—¶ç´¢å¼•æ€ä¹ˆå˜åŒ–</a></li>
</ul>
</li>
<li>zsetä¸ºä»€ä¹ˆä¸ç”¨çº¢é»‘æ ‘, ç”¨è·³è¡¨? ç­”: <a href="#ä¸ºä»€ä¹ˆzsetç”¨è·³è¡¨ä¸ç”¨çº¢é»‘æ ‘">ä¸ºä»€ä¹ˆzsetç”¨è·³è¡¨ä¸ç”¨çº¢é»‘æ ‘</a></li>
<li>casçš„abaé—®é¢˜: ç»™æ•°æ®åŠ ç‰ˆæœ¬å·</li>
<li>ä¹è§‚é”æ€ä¹ˆå®ç°:<ul>
<li>åŠ ç‰ˆæœ¬å·</li>
<li>cas</li>
</ul>
</li>
<li>capçš„cæ˜¯å“ªç§ä¸€è‡´æ€§? çº¿æ€§ä¸€è‡´æ€§æ˜¯å•¥?<ul>
<li>cæ˜¯å¼ºä¸€è‡´æ€§</li>
<li>çº¿æ€§ä¸€è‡´æ€§æ˜¯æ€ä¹ˆåšåˆ°çš„? raftåè®®æ€ä¹ˆåšåˆ°? ç­”: <a href="#etcdçº¿æ€§ä¸€è‡´æ€§è¯»">etcdçº¿æ€§ä¸€è‡´æ€§è¯»</a></li>
</ul>
</li>
<li>åŒæ„é—®é¢˜, <a href="https://leetcode-cn.com/problems/isomorphic-strings/" target="_blank" rel="noopener">leetcode-isomorphic-strings</a></li>
</ul>
<h3 id="infra-two"><a href="#infra-two" class="headerlink" title="infra_two"></a>infra_two</h3><ul>
<li>åä¸ªå¹¶å‘è¯·æ±‚å†™æ—¥å¿—ï¼Œä¼ å…¥çš„ä¸¤ä¸ªå‚æ•°ï¼ˆå‚æ•°1æ—¶é—´æˆ³ï¼Œ å‚æ•°2å†…å®¹ï¼‰ï¼Œ ç„¶åæŒ‰ç…§ä¼ å…¥çš„å‚æ•°1çš„æ—¶é—´æˆ³æ’åºå†™æ—¥å¿—ï¼ˆæç¤ºï¼šhbaseå°±æœ‰è¿™ä¸ªç‰¹æ€§ï¼Œå…¨å±€æœ‰åºçš„å­˜å‚¨ï¼Ÿ ä¸ç”¨ä¸¥æ ¼æœ‰åºï¼Œ é˜¶æ®µæœ‰åº pending_fini</li>
<li>rpcæ¡†æ¶åŸç†,msgpackæ˜¯å•¥,å‡ºå¼‚å¸¸æ€ä¹ˆåŠï¼Ÿè¢«è°ƒç”¨æ–¹å‡ºäº†é—®é¢˜,è°ƒç”¨æ–¹æ€ä¹ˆåŠï¼Ÿ<ul>
<li><a href="http://www.voycn.com/article/fenbushifuwurpcfenbushixiaoxiduiliemqmianshitijingxuan" target="_blank" rel="noopener">http://www.voycn.com/article/fenbushifuwurpcfenbushixiaoxiduiliemqmianshitijingxuan</a></li>
</ul>
</li>
<li>åˆ†å¸ƒå¼äº‹åŠ¡: <a href="#åˆ†å¸ƒå¼äº‹åŠ¡">åˆ†å¸ƒå¼äº‹åŠ¡</a></li>
<li>ç™»å½•sessionçš„å®ç°, ç™»å½•å¾®æœåŠ¡/æ’é˜Ÿå¾®æœåŠ¡å„ç§æµç¨‹ææ¸…æ¥šï¼Œ aidæ˜¯å¹²å˜›çš„ <ul>
<li><a href="#ç™»å½•å¾®æœåŠ¡å’Œæ’é˜Ÿå¾®æœåŠ¡">ç™»å½•å¾®æœåŠ¡å’Œæ’é˜Ÿå¾®æœåŠ¡</a></li>
</ul>
</li>
<li>git rebaseåŸç†/git resetæ˜¯å•¥æ„æ€ï¼ŸåŸç†<ul>
<li>git rebase: <a href="/git_tutorial/#rebase">rebase</a></li>
<li>git reset: <a href="/git_tutorial/#æ’¤é”€ä¸å›é€€">reset</a></li>
</ul>
</li>
<li>åˆ†å¸ƒå¼å…¨å±€é€’å¢id: <a href="#idç”Ÿæˆå™¨å¦‚ä½•å®ç°å…¨å±€é€’å¢">idç”Ÿæˆå™¨å¦‚ä½•å®ç°å…¨å±€é€’å¢</a></li>
<li>åšç™»å½•çš„æ—¶å€™<code>OAuth2</code>ä¹ˆï¼Ÿ<code>OAuth</code>æ˜¯å•¥ï¼Ÿ<ul>
<li>å‚è€ƒ: <a href="https://www.ruanyifeng.com/blog/2019/04/oauth-grant-types.html" target="_blank" rel="noopener">https://www.ruanyifeng.com/blog/2019/04/oauth-grant-types.html</a></li>
<li>å‚è€ƒ: <a href="http://www.ruanyifeng.com/blog/2019/04/github-oauth.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2019/04/github-oauth.html</a></li>
<li>OAuth 2.0 è§„å®šäº†å››ç§è·å¾—ä»¤ç‰Œçš„æµç¨‹ã€‚ä½ å¯ä»¥é€‰æ‹©æœ€é€‚åˆè‡ªå·±çš„é‚£ä¸€ç§ï¼Œå‘ç¬¬ä¸‰æ–¹åº”ç”¨é¢å‘ä»¤ç‰Œã€‚ä¸‹é¢å°±æ˜¯è¿™å››ç§æˆæƒæ–¹å¼ã€‚<ul>
<li>æˆæƒç ï¼ˆauthorization-codeï¼‰</li>
<li>éšè—å¼ï¼ˆimplicitï¼‰</li>
<li>å¯†ç å¼ï¼ˆpasswordï¼‰ï¼š</li>
<li>å®¢æˆ·ç«¯å‡­è¯ï¼ˆclient credentialsï¼‰<br>æ³¨æ„ï¼Œä¸ç®¡å“ªä¸€ç§æˆæƒæ–¹å¼ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨ç”³è¯·ä»¤ç‰Œä¹‹å‰ï¼Œéƒ½å¿…é¡»å…ˆåˆ°ç³»ç»Ÿå¤‡æ¡ˆï¼Œè¯´æ˜è‡ªå·±çš„èº«ä»½ï¼Œç„¶åä¼šæ‹¿åˆ°ä¸¤ä¸ªèº«ä»½è¯†åˆ«ç ï¼šå®¢æˆ·ç«¯ IDï¼ˆclient IDï¼‰å’Œå®¢æˆ·ç«¯å¯†é’¥ï¼ˆclient secretï¼‰ã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢ä»¤ç‰Œè¢«æ»¥ç”¨ï¼Œæ²¡æœ‰å¤‡æ¡ˆè¿‡çš„ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œæ˜¯ä¸ä¼šæ‹¿åˆ°ä»¤ç‰Œçš„ã€‚</li>
</ul>
</li>
<li>ä¸¾ä¸ª<strong>OAuthæˆæƒç </strong>æ–¹å¼çš„ä¾‹å­,æˆæƒç ï¼ˆauthorization codeï¼‰æ–¹å¼ï¼ŒæŒ‡çš„æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨å…ˆç”³è¯·ä¸€ä¸ªæˆæƒç ï¼Œç„¶åå†ç”¨è¯¥ç è·å–ä»¤ç‰Œã€‚è¿™ç§æ–¹å¼æ˜¯æœ€å¸¸ç”¨çš„æµç¨‹ï¼Œå®‰å…¨æ€§ä¹Ÿæœ€é«˜ï¼Œå®ƒé€‚ç”¨äºé‚£äº›æœ‰åç«¯çš„ Web åº”ç”¨ã€‚æˆæƒç é€šè¿‡å‰ç«¯ä¼ é€ï¼Œä»¤ç‰Œåˆ™æ˜¯å‚¨å­˜åœ¨åç«¯ï¼Œè€Œä¸”æ‰€æœ‰ä¸èµ„æºæœåŠ¡å™¨çš„é€šä¿¡éƒ½åœ¨åç«¯å®Œæˆã€‚è¿™æ ·çš„å‰åç«¯åˆ†ç¦»ï¼Œå¯ä»¥é¿å…ä»¤ç‰Œæ³„æ¼ã€‚ æµç¨‹å¦‚ä¸‹:<br>  1. A ç½‘ç«™è®©ç”¨æˆ·è·³è½¬åˆ° GitHubã€‚<br>  2. GitHub è¦æ±‚ç”¨æˆ·ç™»å½•ï¼Œç„¶åè¯¢é—®â€A ç½‘ç«™è¦æ±‚è·å¾— xx æƒé™ï¼Œä½ æ˜¯å¦åŒæ„ï¼Ÿâ€<br>  3. ç”¨æˆ·åŒæ„ï¼ŒGitHub å°±ä¼šé‡å®šå‘å› A ç½‘ç«™ï¼ŒåŒæ—¶å‘å›ä¸€ä¸ªæˆæƒç ã€‚<br>  4. A ç½‘ç«™ä½¿ç”¨æˆæƒç ï¼Œå‘ GitHub è¯·æ±‚ä»¤ç‰Œã€‚<br>  5. GitHub è¿”å›ä»¤ç‰Œ.<br>  6. A ç½‘ç«™ä½¿ç”¨ä»¤ç‰Œï¼Œå‘ GitHub è¯·æ±‚ç”¨æˆ·æ•°æ®ã€‚</li>
</ul>
</li>
</ul>
<h1 id="ç®—æ³•ä¸æ•°æ®ç»“æ„"><a href="#ç®—æ³•ä¸æ•°æ®ç»“æ„" class="headerlink" title="ç®—æ³•ä¸æ•°æ®ç»“æ„"></a>ç®—æ³•ä¸æ•°æ®ç»“æ„</h1><ul>
<li>æ¨èå‚è€ƒ<strong>æœ¬åšå®¢æ€»ç»“</strong>çš„ <a href="/algo_newbie/" title="algo_newbie">algo_newbie</a></li>
<li><p>æ¨èå‚è€ƒ<strong>æœ¬åšå®¢æ€»ç»“</strong>çš„ <a href="/algo_practice/" title="ç®—æ³•ä¼ä¸šçœŸé¢˜å®æˆ˜ç»ƒä¹ ">ç®—æ³•ä¼ä¸šçœŸé¢˜å®æˆ˜ç»ƒä¹ </a></p>
</li>
<li><p>Aæ˜Ÿç®—æ³• pending_fin</p>
</li>
<li>dijkstraç®—æ³• pending_fin</li>
<li>åŠ¨æ€è§„åˆ’ä¸è´ªå¿ƒæœ‰ä»€ä¹ˆåŒºåˆ«:<ul>
<li>è´ªå¿ƒç€çœ¼ç°å®å½“ä¸‹ï¼ŒåŠ¨è§„è°¨è®°å†å²è¿›ç¨‹ã€‚</li>
<li>åŠ¨æ€è§„åˆ’å¸Œæœ›å¤ç”¨å­é—®é¢˜çš„è§£ï¼Œæœ€å¥½è¢«åå¤ä¾èµ–ã€‚å…¶æœ¬è´¨è¿˜æ˜¯ç©·ä¸¾ï¼Œæ‰€ä»¥å½“å‰å¹¶ä¸çŸ¥é“å“ªä¸ªå­é—®é¢˜çš„è§£ä¼šæ„æˆæœ€ç»ˆæœ€ä¼˜è§£ã€‚ä½†çŸ¥é“è¿™ä¸ªå­é—®é¢˜å¯èƒ½ä¼šè¢«åå¤è®¡ç®—ï¼Œæ‰€ä»¥æŠŠç»“æœç¼“å­˜èµ·æ¥ã€‚æ•´ä¸ªè¿‡ç¨‹æ˜¯æ ‘çŠ¶çš„æœç´¢è¿‡ç¨‹ã€‚</li>
<li>è´ªå¿ƒå¸Œæœ›æ¯æ¬¡éƒ½èƒ½æ’é™¤ä¸€å †å­é—®é¢˜ã€‚å®ƒä¸éœ€è¦å¤ç”¨å­é—®é¢˜çš„è§£ï¼Œå½“å‰æœ€ä¼˜è§£ä»å­é—®é¢˜æœ€ä¼˜è§£å³å¯å¾—å‡ºã€‚æ•´ä¸ªè¿‡ç¨‹æ˜¯çº¿æ€§çš„æ¨å¯¼è¿‡ç¨‹ã€‚</li>
</ul>
</li>
<li>å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå›¾æ˜¯å¦æœ‰ç¯</li>
<li>æ¡¶æ’åº/çº¿æ®µæ ‘/ç»Ÿè®¡æ ‘/æ’åºæ ‘</li>
</ul>
<p><strong>æµ·é‡é—®é¢˜</strong>: å¯å‚è€ƒ <a href="https://juejin.im/entry/6844903519640616967" target="_blank" rel="noopener">https://juejin.im/entry/6844903519640616967</a></p>
<ul>
<li>10ä¸ª1Gæ•°æ®, å†…å­˜200MB, å¦‚ä½•å»é‡ pending_fin</li>
</ul>
<h1 id="è®¾è®¡æ¨¡å¼"><a href="#è®¾è®¡æ¨¡å¼" class="headerlink" title="è®¾è®¡æ¨¡å¼"></a>è®¾è®¡æ¨¡å¼</h1><ul>
<li>å•ä¾‹æ¨¡å¼</li>
<li>é€‚é…å™¨æ¨¡å¼: å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå®¢æˆ·å¸Œæœ›çš„å¦å¤–ä¸€ä¸ªæ¥å£ã€‚é€‚é…å™¨æ¨¡å¼ä½¿å¾—åŸæœ¬ç”±äºæ¥å£ä¸å…¼å®¹è€Œä¸èƒ½ä¸€èµ·å·¥ä½œçš„é‚£äº›ç±»å¯ä»¥ä¸€èµ·å·¥ä½œã€‚ä¸»è¦è§£å†³çš„é—®é¢˜ï¼šä¸»è¦è§£å†³åœ¨è½¯ä»¶ç³»ç»Ÿä¸­ï¼Œå¸¸å¸¸è¦å°†ä¸€äº›â€ç°å­˜çš„å¯¹è±¡â€æ”¾åˆ°æ–°çš„ç¯å¢ƒä¸­ï¼Œè€Œæ–°ç¯å¢ƒè¦æ±‚çš„æ¥å£æ˜¯ç°å¯¹è±¡ä¸èƒ½æ»¡è¶³çš„ã€‚</li>
<li>å·¥å‚æ¨¡å¼</li>
<li>è§‚å¯Ÿè€…æ¨¡å¼</li>
<li>äº«å…ƒæ¨¡å¼: æ± çš„æ€æƒ³</li>
</ul>
<h1 id="å„ä¸ªè¯­è¨€ä¹‹é—´çš„BENCHMARKå¯¹æ¯”"><a href="#å„ä¸ªè¯­è¨€ä¹‹é—´çš„BENCHMARKå¯¹æ¯”" class="headerlink" title="å„ä¸ªè¯­è¨€ä¹‹é—´çš„BENCHMARKå¯¹æ¯”"></a>å„ä¸ªè¯­è¨€ä¹‹é—´çš„BENCHMARKå¯¹æ¯”</h1><p>ç»“è®º: luajitæ¯”luaå¿«10å€ â€¦æ¯”cpythonå¿«60å€, å’Œcæ…¢ä¸€ç‚¹ä¹Ÿå·®ä¸å¤ªå¤š</p>
<p><a href="https://github.com/DNS/benchmark-language" target="_blank" rel="noopener">https://github.com/DNS/benchmark-language</a></p>
<table>
<thead>
<tr>
<th style="text-align:center">è¯­è¨€</th>
<th style="text-align:center">è€—æ—¶</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">LUA 5.3.4</td>
<td style="text-align:center">6.87s total</td>
</tr>
<tr>
<td style="text-align:center">LUAC 5.3.4</td>
<td style="text-align:center">6.84s total</td>
</tr>
<tr>
<td style="text-align:center">LuaJIT 2.0.5</td>
<td style="text-align:center">0.67s total</td>
</tr>
<tr>
<td style="text-align:center">C (MSVC 18, VS 2013)</td>
<td style="text-align:center">0.56s total</td>
</tr>
<tr>
<td style="text-align:center">C (GCC 7.2.0)</td>
<td style="text-align:center">0.67s total</td>
</tr>
<tr>
<td style="text-align:center">C (CLANG LLVM 6.0.0)</td>
<td style="text-align:center">0.56s total</td>
</tr>
<tr>
<td style="text-align:center">C (CYGWIN GCC 10.2.0)</td>
<td style="text-align:center">0.68s total</td>
</tr>
<tr>
<td style="text-align:center">C (CYGWIN CLANG 8.0.1)</td>
<td style="text-align:center">0.59s total</td>
</tr>
<tr>
<td style="text-align:center">C (MINGW GCC 10.2.0)</td>
<td style="text-align:center">0.67s total</td>
</tr>
<tr>
<td style="text-align:center">C (MINGW CLANG 8.0.1)</td>
<td style="text-align:center">0.58s total</td>
</tr>
<tr>
<td style="text-align:center">C (Embarcadero C++ 6.60 for Win32)</td>
<td style="text-align:center">1.01s total</td>
</tr>
<tr>
<td style="text-align:center">Java JRE 1.8.0_20</td>
<td style="text-align:center">0.65s total</td>
</tr>
<tr>
<td style="text-align:center">Perl 5.26.1</td>
<td style="text-align:center">26.89s total</td>
</tr>
<tr>
<td style="text-align:center">Javascript (Node.js 4.4.6)</td>
<td style="text-align:center">2.49s total</td>
</tr>
<tr>
<td style="text-align:center">Python 3.7.1</td>
<td style="text-align:center">40.17s total</td>
</tr>
<tr>
<td style="text-align:center">C# .NET CLR (CSC 12)</td>
<td style="text-align:center">0.67s total</td>
</tr>
<tr>
<td style="text-align:center">C# Mono 5.18.0</td>
<td style="text-align:center">1.06s total</td>
</tr>
<tr>
<td style="text-align:center">C# Mono 5.18.0 (Interpreter)</td>
<td style="text-align:center">26.38s total</td>
</tr>
<tr>
<td style="text-align:center">Ruby 2.5.1</td>
<td style="text-align:center">12.97s total</td>
</tr>
<tr>
<td style="text-align:center">R 3.5.1</td>
<td style="text-align:center">15.56s total</td>
</tr>
</tbody>
</table>
<h1 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h1><ul>
<li>mroé—®é¢˜</li>
<li>æ€ä¹ˆå®ç°ä¸€ä¸ªåç¨‹åº“?</li>
<li>mockæ˜¯å•¥: <a href="https://zhuanlan.zhihu.com/p/30380243" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/30380243</a></li>
</ul>
<h2 id="æœ‰GILé‚£pyçš„å¤šçº¿ç¨‹è¿˜æœ‰ç”¨å—"><a href="#æœ‰GILé‚£pyçš„å¤šçº¿ç¨‹è¿˜æœ‰ç”¨å—" class="headerlink" title="æœ‰GILé‚£pyçš„å¤šçº¿ç¨‹è¿˜æœ‰ç”¨å—?"></a>æœ‰GILé‚£pyçš„å¤šçº¿ç¨‹è¿˜æœ‰ç”¨å—?</h2><p>åœ¨python2.xé‡Œï¼Œ<strong>GILçš„é‡Šæ”¾é€»è¾‘</strong>æ˜¯å½“å‰çº¿ç¨‹é‡è§IOæ“ä½œæˆ–è€…ticksè®¡æ•°è¾¾åˆ°100ï¼ˆtickså¯ä»¥çœ‹ä½œæ˜¯pythonè‡ªèº«çš„ä¸€ä¸ªè®¡æ•°å™¨ï¼Œä¸“é—¨åšç”¨äºGILï¼Œæ¯æ¬¡é‡Šæ”¾åå½’é›¶ï¼Œè¿™ä¸ªè®¡æ•°å¯ä»¥é€šè¿‡ sys.setcheckinterval æ¥è°ƒæ•´ï¼‰ï¼Œè¿›è¡Œé‡Šæ”¾ã€‚</p>
<p>è€Œæ¯æ¬¡é‡Šæ”¾GILé”ï¼Œçº¿ç¨‹è¿›è¡Œé”ç«äº‰ã€åˆ‡æ¢çº¿ç¨‹ï¼Œä¼šæ¶ˆè€—èµ„æºã€‚å¹¶ä¸”ç”±äºGILé”å­˜åœ¨ï¼Œpythoné‡Œä¸€ä¸ªè¿›ç¨‹æ°¸è¿œåªèƒ½åŒæ—¶æ‰§è¡Œä¸€ä¸ªçº¿ç¨‹(æ‹¿åˆ°GILçš„çº¿ç¨‹æ‰èƒ½æ‰§è¡Œ)ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨å¤šæ ¸CPUä¸Šï¼Œpythonçš„å¤šçº¿ç¨‹æ•ˆç‡å¹¶ä¸é«˜ã€‚</p>
<p>é‚£ä¹ˆæ˜¯ä¸æ˜¯<strong>pythonçš„å¤šçº¿ç¨‹å°±å®Œå…¨æ²¡ç”¨äº†å‘¢</strong>ï¼Ÿ</p>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬è¿›è¡Œåˆ†ç±»è®¨è®ºï¼š</p>
<ul>
<li><p>CPUå¯†é›†å‹ä»£ç (å„ç§å¾ªç¯å¤„ç†ã€è®¡æ•°ç­‰ç­‰)ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œticksè®¡æ•°å¾ˆå¿«å°±ä¼šè¾¾åˆ°é˜ˆå€¼ï¼Œç„¶åè§¦å‘GILçš„é‡Šæ”¾ä¸å†ç«äº‰ï¼ˆå¤šä¸ªçº¿ç¨‹æ¥å›åˆ‡æ¢å½“ç„¶æ˜¯éœ€è¦æ¶ˆè€—èµ„æºçš„ï¼‰ï¼Œæ‰€ä»¥pythonä¸‹çš„å¤šçº¿ç¨‹å¯¹CPUå¯†é›†å‹ä»£ç å¹¶ä¸å‹å¥½ã€‚(è€Œåœ¨python3.xä¸­ï¼ŒGILä¸ä½¿ç”¨ticksè®¡æ•°ï¼Œæ”¹ä¸ºä½¿ç”¨è®¡æ—¶å™¨ï¼ˆæ‰§è¡Œæ—¶é—´è¾¾åˆ°é˜ˆå€¼åï¼Œå½“å‰çº¿ç¨‹é‡Šæ”¾GILï¼‰ï¼Œè¿™æ ·å¯¹CPUå¯†é›†å‹ç¨‹åºæ›´åŠ å‹å¥½ï¼Œä½†ä¾ç„¶æ²¡æœ‰è§£å†³GILå¯¼è‡´çš„åŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªçº¿ç¨‹çš„é—®é¢˜ï¼Œæ‰€ä»¥æ•ˆç‡ä¾ç„¶ä¸å°½å¦‚äººæ„ã€‚)</p>
</li>
<li><p>IOå¯†é›†å‹ä»£ç (æ–‡ä»¶å¤„ç†ã€ç½‘ç»œçˆ¬è™«ç­‰)ï¼Œå¤šçº¿ç¨‹èƒ½å¤Ÿæœ‰æ•ˆæå‡æ•ˆç‡(å•çº¿ç¨‹ä¸‹æœ‰IOæ“ä½œä¼šè¿›è¡ŒIOç­‰å¾…ï¼Œé€ æˆä¸å¿…è¦çš„æ—¶é—´æµªè´¹ï¼Œè€Œå¼€å¯å¤šçº¿ç¨‹èƒ½åœ¨çº¿ç¨‹Aç­‰å¾…æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°çº¿ç¨‹Bï¼Œå¯ä»¥ä¸æµªè´¹CPUçš„èµ„æºï¼Œä»è€Œèƒ½æå‡ç¨‹åºæ‰§è¡Œæ•ˆç‡)ã€‚æ‰€ä»¥pythonçš„å¤šçº¿ç¨‹å¯¹IOå¯†é›†å‹ä»£ç æ¯”è¾ƒå‹å¥½ã€‚</p>
</li>
</ul>
<h2 id="åœ¨pythonç¨‹åºä¸­è°ƒç”¨cppçš„åº“åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦å—åˆ¶äºGIL"><a href="#åœ¨pythonç¨‹åºä¸­è°ƒç”¨cppçš„åº“åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦å—åˆ¶äºGIL" class="headerlink" title="åœ¨pythonç¨‹åºä¸­è°ƒç”¨cppçš„åº“åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦å—åˆ¶äºGIL?"></a>åœ¨pythonç¨‹åºä¸­è°ƒç”¨cppçš„åº“åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦å—åˆ¶äºGIL?</h2><p>é¦–å…ˆè¦ç†è§£ä»€ä¹ˆæ˜¯GIL.<br>Python çš„å¤šçº¿ç¨‹æ˜¯çœŸçš„å¤šçº¿ç¨‹ï¼Œåªä¸è¿‡åœ¨ä»»æ„æ—¶åˆ»ï¼Œå®ƒä»¬ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿå–å¾— GIL ä»è€Œè¢«å…è®¸æ‰§è¡Œ Python ä»£ç ã€‚å…¶å®ƒçº¿ç¨‹è¦ä¹ˆç­‰ç€ï¼Œè¦ä¹ˆå¹²åˆ«çš„å’Œ Python æ— å…³çš„äº‹æƒ…ï¼ˆæ¯”å¦‚ç­‰å¾…ç³»ç»Ÿ I/Oï¼Œæˆ–è€…ç®—ç‚¹ä»€ä¹ˆä¸œè¥¿ï¼‰ã€‚</p>
<p>é‚£å¦‚æœæ˜¯é€šè¿‡CPPæ‰©å±•åˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹ï¼Œå¯ä»¥æ‘†è„±è¿™ä¸ªé™åˆ¶ä¹ˆï¼Ÿ<br>å¾ˆç®€å•ï¼Œä¸è®¿é—® Python çš„æ•°æ®å’Œæ–¹æ³•ï¼Œå°±å’Œ GIL æ²¡ä»»ä½•å…³ç³»ã€‚å¦‚æœéœ€è¦è®¿é—® Pythonï¼Œè¿˜æ˜¯éœ€è¦å…ˆå–å¾— GIL.</p>
<p>GIL æ˜¯ä¸ºäº†ä¿æŠ¤ Python æ•°æ®ä¸è¢«å¹¶å‘è®¿é—®ç ´åï¼Œæ‰€ä»¥å½“ä½ ä¸è®¿é—® Python çš„æ•°æ®çš„æ—¶å€™è‡ªç„¶å°±å¯ä»¥é‡Šæ”¾ï¼ˆæˆ–è€…ä¸å–å¾—ï¼‰GILã€‚åè¿‡æ¥ï¼Œå¦‚æœéœ€è¦è®¿é—® Python çš„æ•°æ®ï¼Œå°±ä¸€å®šè¦å–å¾— GIL å†è®¿é—®ã€‚PyObject ç­‰ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¤šçº¿ç¨‹è®¿é—®ä»»ä½•éçº¿ç¨‹å®‰å…¨çš„æ•°æ®éƒ½éœ€è¦å…ˆå–å¾—å¯¹åº”çš„é”ã€‚Python æ‰€æœ‰çš„ PyObject ä»€ä¹ˆçš„éƒ½å…±äº«ä¸€ä¸ªé”ï¼Œå®ƒå°±å« GILã€‚</p>
<h2 id="ä½¿ç”¨objgraphè§£å†³å†…å­˜æ³„æ¼é—®é¢˜"><a href="#ä½¿ç”¨objgraphè§£å†³å†…å­˜æ³„æ¼é—®é¢˜" class="headerlink" title="ä½¿ç”¨objgraphè§£å†³å†…å­˜æ³„æ¼é—®é¢˜"></a>ä½¿ç”¨objgraphè§£å†³å†…å­˜æ³„æ¼é—®é¢˜</h2><p>å¯¹äº python è¿™ç§æ”¯æŒåƒåœ¾å›æ”¶çš„è¯­è¨€æ¥è¯´ï¼Œæ€ä¹ˆè¿˜ä¼šæœ‰å†…å­˜æ³„éœ²ï¼Ÿ æ¦‚æ‹¬æ¥è¯´ï¼Œæœ‰ä»¥ä¸‹ä¸‰ç§åŸå› ï¼š</p>
<p>æ‰€ç”¨åˆ°çš„ç”¨ C è¯­è¨€å¼€å‘çš„åº•å±‚æ¨¡å—ä¸­å‡ºç°äº†å†…å­˜æ³„éœ²ã€‚<br>ä»£ç ä¸­ç”¨åˆ°äº†å…¨å±€çš„ listã€ dict æˆ–å…¶å®ƒå®¹å™¨ï¼Œä¸åœçš„å¾€è¿™äº›å®¹å™¨ä¸­æ’å…¥å¯¹è±¡ï¼Œè€Œå¿˜è®°äº†åœ¨ä½¿ç”¨å®Œä¹‹åè¿›è¡Œåˆ é™¤å›æ”¶<br>ä»£ç ä¸­æœ‰â€œå¼•ç”¨å¾ªç¯â€ï¼Œå¹¶ä¸”è¢«å¾ªç¯å¼•ç”¨çš„å¯¹è±¡å®šä¹‰äº†<strong>del</strong>æ–¹æ³•ï¼Œå°±ä¼šå‘ç”Ÿå†…å­˜æ³„éœ²ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆå¾ªç¯å¼•ç”¨çš„å¯¹è±¡å®šä¹‰äº†<strong>del</strong>æ–¹æ³•åcollectå°±ä¸èµ·ä½œç”¨äº†å‘¢ï¼Ÿ</strong></p>
<p>gcæ¨¡å—æœ€å¸¸ä½¿ç”¨çš„æ–¹æ³•å°±æ˜¯gc.collect()æ–¹æ³•ï¼Œä½¿ç”¨collectæ–¹æ³•å¯¹å¾ªç¯å¼•ç”¨çš„å¯¹è±¡è¿›è¡Œåƒåœ¾å›æ”¶ã€‚<br>å¦‚æœæˆ‘ä»¬åœ¨ç±»ä¸­é‡è½½äº†<strong>del</strong>æ–¹æ³•ã€‚<strong>del</strong>æ–¹æ³•å®šä¹‰äº†åœ¨ç”¨delè¯­å¥åˆ é™¤å¯¹è±¡æ—¶é™¤äº†é‡Šæ”¾å†…å­˜ç©ºé—´ä»¥å¤–çš„æ“ä½œã€‚<br>ä¸€èˆ¬è€Œè¨€ï¼Œåœ¨ä½¿ç”¨äº†delè¯­å¥çš„æ—¶å€™è§£é‡Šå™¨é¦–å…ˆä¼šçœ‹è¦åˆ é™¤å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œå¦‚æœä¸º0ï¼Œé‚£ä¹ˆå°±é‡Šæ”¾å†…å­˜å¹¶æ‰§è¡Œdelæ–¹æ³•ã€‚<br>åœ¨è¿™é‡Œï¼Œé¦–å…ˆdelè¯­å¥å‡ºç°æ—¶æœ¬èº«å¼•ç”¨è®¡æ•°å°±ä¸ä¸º0ï¼ˆå› ä¸ºæœ‰å¾ªç¯å¼•ç”¨çš„å­˜åœ¨ï¼‰ï¼Œæ‰€ä»¥è§£é‡Šå™¨ä¸é‡Šæ”¾å†…å­˜ï¼›<br>å†è€…ï¼Œæ‰§è¡Œcollectæ–¹æ³•æ—¶åº”è¯¥ä¼šæ¸…é™¤å¾ªç¯å¼•ç”¨æ‰€äº§ç”Ÿçš„æ— æ•ˆå¼•ç”¨è®¡æ•°ä»è€Œè¾¾åˆ°delçš„ç›®çš„ï¼Œå¯¹äºè¿™ä¸¤ä¸ªå¾ªç¯å¼•ç”¨å¯¹è±¡è€Œè¨€ï¼Œ<br>pythonæ— æ³•åˆ¤æ–­è°ƒç”¨å®ƒä»¬çš„delæ–¹æ³•æ—¶ä¼šä¸ä¼šè¦ç”¨åˆ°å¯¹æ–¹é‚£ä¸ªå¯¹è±¡ï¼Œæ¯”å¦‚åœ¨è¿›è¡Œb.del()æ—¶å¯èƒ½ä¼šç”¨åˆ°b._aä¹Ÿå°±æ˜¯aï¼Œå¦‚æœåœ¨é‚£ä¹‹å‰aå·²ç»è¢«é‡Šæ”¾ï¼Œé‚£ä¹ˆå°±å½»åº•GGäº†ã€‚<br>ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œcollectæ–¹æ³•é»˜è®¤ä¸å¯¹é‡è½½äº†delæ–¹æ³•çš„å¾ªç¯å¼•ç”¨å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œè€Œå®ƒä»¬ä¿©çš„çŠ¶æ€ä¹Ÿä¼šä»unreachableè½¬å˜ä¸ºuncollectableã€‚ç”±äºæ˜¯uncollectableçš„ï¼Œè‡ªç„¶å°±ä¸ä¼šè¢«collectå¤„ç†ï¼Œæ‰€ä»¥å°±è¿›å…¥äº†garbageåˆ—è¡¨ã€‚</p>
<h3 id="å†…å­˜æ³„éœ²çš„è¯Šæ–­æ€è·¯"><a href="#å†…å­˜æ³„éœ²çš„è¯Šæ–­æ€è·¯" class="headerlink" title="å†…å­˜æ³„éœ²çš„è¯Šæ–­æ€è·¯"></a>å†…å­˜æ³„éœ²çš„è¯Šæ–­æ€è·¯</h3><p>æ— è®ºæ˜¯å“ªç§æ–¹å¼çš„å†…å­˜æ³„éœ²ï¼Œæœ€ç»ˆè¡¨ç°çš„å½¢å¼éƒ½æ˜¯æŸäº› python å¯¹è±¡åœ¨ä¸åœçš„å¢é•¿ï¼›å› æ­¤ï¼Œé¦–å…ˆæ˜¯è¦æ‰¾åˆ°è¿™äº›å¼‚å¸¸çš„å¯¹è±¡ã€‚</p>
<p>è¯Šæ–­æ­¥éª¤:<br>ç”¨åˆ°çš„å·¥å…·ï¼š gc æ¨¡å—å’Œ objgraph æ¨¡å—</p>
<p>gcæ¨¡å— æ˜¯Pythonçš„åƒåœ¾æ”¶é›†å™¨æ¨¡å—ï¼Œgcä½¿ç”¨æ ‡è®°æ¸…é™¤ç®—æ³•å›æ”¶åƒåœ¾</p>
<p>objgraph æ˜¯ä¸€ä¸ªç”¨äºè¯Šæ–­å†…å­˜é—®é¢˜çš„å·¥å…·</p>
<p>objgraphçš„å®ç°è°ƒç”¨äº†gcçš„è¿™å‡ ä¸ªå‡½æ•°ï¼šgc.get_objects(), gc.get_referents(), gc.get_referers()ï¼Œç„¶åæ„é€ å‡ºå¯¹è±¡ä¹‹é—´çš„å¼•ç”¨å…³ç³»ã€‚objgraphçš„ä»£ç å’Œæ–‡æ¡£éƒ½å†™å¾—æ¯”è¾ƒå¥½ï¼Œå»ºè®®ä¸€è¯»ã€‚</p>
<p>ä¸‹é¢å…ˆä»‹ç»å‡ ä¸ªååˆ†å®ç”¨çš„API<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">def <span class="title">count</span><span class="params">(<span class="keyword">typename</span>)</span></span></span><br></pre></td></tr></table></figure></p>
<p>è¿”å›è¯¥ç±»å‹å¯¹è±¡çš„æ•°ç›®ï¼Œå…¶å®å°±æ˜¯é€šè¿‡gc.get_objects()æ‹¿åˆ°æ‰€ç”¨çš„å¯¹è±¡ï¼Œç„¶åç»Ÿè®¡æŒ‡å®šç±»å‹çš„æ•°ç›®ã€‚<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">def <span class="title">by_type</span><span class="params">(<span class="keyword">typename</span>)</span></span></span><br></pre></td></tr></table></figure></p>
<p>è¿”å›è¯¥ç±»å‹çš„å¯¹è±¡åˆ—è¡¨ã€‚çº¿ä¸Šé¡¹ç›®ï¼Œå¯ä»¥ç”¨è¿™ä¸ªå‡½æ•°å¾ˆæ–¹ä¾¿æ‰¾åˆ°ä¸€ä¸ªå•ä¾‹å¯¹è±¡<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">def <span class="title">show_most_common_types</span><span class="params">(limits = <span class="number">10</span>)</span></span></span><br></pre></td></tr></table></figure></p>
<p>æ‰“å°å®ä¾‹æœ€å¤šçš„å‰Nï¼ˆlimitsï¼‰ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå‡½æ•°éå¸¸æœ‰ç”¨ã€‚åœ¨ã€ŠPythonå†…å­˜ä¼˜åŒ–ã€‹ä¸€æ–‡ä¸­ä¹Ÿæåˆ°ï¼Œè¯¥å‡½æ•°èƒ½å‘ç°å¯ä»¥ç”¨slotsè¿›è¡Œå†…å­˜ä¼˜åŒ–çš„å¯¹è±¡<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">def <span class="title">show_growth</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure></p>
<p>ç»Ÿè®¡è‡ªä¸Šæ¬¡è°ƒç”¨ä»¥æ¥å¢åŠ å¾—æœ€å¤šçš„å¯¹è±¡ï¼Œè¿™ä¸ªå‡½æ•°éå¸¸æœ‰åˆ©äºå‘ç°æ½œåœ¨çš„å†…å­˜æ³„éœ²ã€‚å‡½æ•°å†…éƒ¨è°ƒç”¨äº†gc.collect()ï¼Œå› æ­¤å³ä½¿æœ‰å¾ªç¯å¼•ç”¨ä¹Ÿä¸ä¼šå¯¹åˆ¤æ–­é€ æˆå½±å“ã€‚</p>
<p>æ­¥éª¤:<br>1ã€ åœ¨æœåŠ¡ç¨‹åºçš„å¾ªç¯é€»è¾‘ä¸­ï¼Œé€‰æ‹©å‡ºä¸€ä¸ªè¯Šæ–­ç‚¹<br>2ã€ åœ¨è¯Šæ–­ç‚¹ï¼Œæ’å…¥å¦‚ä¸‹è¯Šæ–­è¯­å¥ ã€€</p>
<p>ä¾‹å¦‚:<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gc</span><br><span class="line"><span class="keyword">import</span> objgraph</span><br><span class="line"></span><br><span class="line"><span class="comment">### å¼ºåˆ¶è¿›è¡Œåƒåœ¾å›æ”¶  </span></span><br><span class="line">gc.collect()  </span><br><span class="line"></span><br><span class="line"><span class="comment">### æ‰“å°å‡ºå¯¹è±¡æ•°ç›®æœ€å¤šçš„ 50 ä¸ªç±»å‹ä¿¡æ¯  </span></span><br><span class="line">objgraph.show_most_common_types(limit=<span class="number">50</span>)</span><br></pre></td></tr></table></figure></p>
<h2 id="å¦‚ä½•è§£å†³pythonè¿›ç¨‹cpuçš„100-é—®é¢˜"><a href="#å¦‚ä½•è§£å†³pythonè¿›ç¨‹cpuçš„100-é—®é¢˜" class="headerlink" title="å¦‚ä½•è§£å†³pythonè¿›ç¨‹cpuçš„100%é—®é¢˜"></a>å¦‚ä½•è§£å†³pythonè¿›ç¨‹cpuçš„100%é—®é¢˜</h2><p>ç›‘æ§ç³»ç»ŸæŠ¥è­¦æŸæœåŠ¡è¿›ç¨‹å‡ºç° CPU 100% æƒ…å†µï¼Œè¯¥ä¸šåŠ¡è¿›ç¨‹ä¸å“åº”ä»»ä½•è¯·æ±‚ï¼Œæ— æ—¥å¿—è¾“å‡ºï¼Œè¿›ç¨‹ IO å’Œå†…å­˜å ç”¨éƒ½æ­£å¸¸ã€‚</p>
<p>ä½†ç»è¿‡ä¸€ç•ªæ’æŸ¥ï¼ŒåŸæ¥æ˜¯ä»£ç  BUG å¯¼è‡´äº†æ­»å¾ªç¯ã€‚</p>
<p>å…·ä½“æŸ¥è¯è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<h3 id="top-æŸ¥çœ‹-CPU-å’Œå†…å­˜å ç”¨"><a href="#top-æŸ¥çœ‹-CPU-å’Œå†…å­˜å ç”¨" class="headerlink" title="top æŸ¥çœ‹ CPU å’Œå†…å­˜å ç”¨"></a>top æŸ¥çœ‹ CPU å’Œå†…å­˜å ç”¨</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># top -bn1p 6325</span><br><span class="line">Tasks: 608 total,   9 running, 596 sleeping,   0 stopped,   3 zombie</span><br><span class="line">%Cpu(s): 20.5 us,  6.3 sy,  0.0 ni, 72.3 id,  0.5 wa,  0.0 hi,  0.5 si,  0.0 st</span><br><span class="line">KiB Mem:  65983744 total, 65372892 used,   610852 free,   574684 buffers</span><br><span class="line">KiB Swap:  4194300 total,        0 used,  4194300 free. 42109148 cached Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 6325 cc        20   0 4840544 628972  69656 R 100.0  1.0 927:41.47 python2.7</span><br></pre></td></tr></table></figure>
<p>æ˜¾ç¤ºè¿›ç¨‹ CPU 100%ï¼Œå†…å­˜å ç”¨æ­£å¸¸ã€‚</p>
<h3 id="strace-æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨"><a href="#strace-æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="strace æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨"></a>strace æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># strace -p 6325</span><br></pre></td></tr></table></figure>
<p>ç»“æœä¸€ç›´å¡ä½ï¼Œæ— ä»»ä½•è¾“å‡ºï¼Œè¯´æ˜è¿›ç¨‹æ²¡æœ‰è¿›è¡Œä»»ä½•ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<h3 id="ltrace-æŸ¥çœ‹åº“å‡½æ•°è°ƒç”¨"><a href="#ltrace-æŸ¥çœ‹åº“å‡½æ•°è°ƒç”¨" class="headerlink" title="ltrace æŸ¥çœ‹åº“å‡½æ•°è°ƒç”¨"></a>ltrace æŸ¥çœ‹åº“å‡½æ•°è°ƒç”¨</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ltrace -cp 6325</span><br><span class="line">^C% time     seconds  usecs/call     calls      function</span><br><span class="line">------ ----------- ----------- --------- --------------------</span><br><span class="line"> 71.84   10.207067          81    124827 memset</span><br><span class="line"> 23.87    3.392006          81     41608 strchr</span><br><span class="line">  2.15    0.304948          82      3708 sem_wait</span><br><span class="line">  2.14    0.303884          81      3708 sem_post</span><br><span class="line">------ ----------- ----------- --------- --------------------</span><br><span class="line">100.00   14.207905                173851 total</span><br><span class="line"># ltrace -p 6325</span><br><span class="line">[pid 6325] memset(0x7f44e98309a8, &apos;\0&apos;, 8)                                = 0x7f44e98309a8</span><br><span class="line">[pid 6325] strchr(&quot;O|O:enumerate&quot;, &apos;:&apos;)                                   = &quot;:enumerate&quot;</span><br><span class="line">[pid 6325] memset(0x7f44e98309a8, &apos;\0&apos;, 8)                                = 0x7f44e98309a8</span><br><span class="line">[pid 6325] strchr(&quot;O|O:enumerate&quot;, &apos;:&apos;)                                   = &quot;:enumerate&quot;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>ç»“æœæ˜¾ç¤ºè¿›ç¨‹ä¸€ç›´åœ¨è°ƒç”¨<code>memset</code>å’Œ<code>strchr</code>ï¼Œææœ‰å¯èƒ½æ˜¯é‡åˆ°æ­»å¾ªç¯äº†ï¼Œè€Œä¸”æ­»å¾ªç¯é‡Œé¢é‡å¤æ‰§è¡Œ<code>enumerate</code>å‡½æ•°ã€‚</p>
<h3 id="gcoreç”Ÿæˆcoredumpæ–‡ä»¶"><a href="#gcoreç”Ÿæˆcoredumpæ–‡ä»¶" class="headerlink" title="gcoreç”Ÿæˆcoredumpæ–‡ä»¶"></a>gcoreç”Ÿæˆcoredumpæ–‡ä»¶</h3><p>ä¸ºäº†é¿å…<code>gdb attach</code>è¿›ç¨‹é€ æˆçš„å…¶ä»–å½±å“ï¼ˆæ¯”å¦‚å¯èƒ½å‡ºç°è¿›ç¨‹å¼‚å¸¸é€€å‡ºï¼Œæ­»é”çªç„¶æ¢å¤ï¼Œå½±å“çº¿ä¸ŠæœåŠ¡ç­‰ï¼‰ï¼Œæœ€å¥½å°†è¿›ç¨‹ç”Ÿæˆä¸€ä¸ª coredump æ–‡ä»¶ï¼Œç„¶åå†æ…¢æ…¢åˆ†æã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># gcore 6325</span><br><span class="line"># ls -lsh core.6325</span><br><span class="line">2.7G -rw-r--r-- 1 root root 2.7G 4æœˆ  14 00:56 core.6325</span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆå®Œ coredump æ–‡ä»¶ï¼Œå¦‚æœå‡ºé—®é¢˜è¿›ç¨‹æ— æ³•ä»çº¿ä¸Šæ‘˜é™¤ï¼Œåˆ™å¯ä»¥ç›´æ¥åœæ‰è¯¥è¿›ç¨‹äº†ã€‚</p>
<h3 id="gdb-åˆ†æ-coredump-æ–‡ä»¶"><a href="#gdb-åˆ†æ-coredump-æ–‡ä»¶" class="headerlink" title="gdb åˆ†æ coredump æ–‡ä»¶"></a>gdb åˆ†æ coredump æ–‡ä»¶</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># gdb python core.6325</span><br><span class="line">GNU gdb (Debian 7.7.1+dfsg-5) 7.7.1</span><br><span class="line">...</span><br><span class="line">Reading symbols from python...Reading symbols from /usr/lib/debug/usr/bin/python2.7...done.</span><br><span class="line">done.</span><br><span class="line">...</span><br><span class="line">Core was generated by `/xxx/service_xx/venv/bin/python2.7&apos;.</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥ç»§ç»­åˆ†æï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) info threads</span><br><span class="line">  Id   Target Id         Frame </span><br><span class="line">  25   Thread 0x7f8361666700 (LWP 6325) _PyCode_CheckLineNumber (bounds=&lt;optimized out&gt;, lasti=&lt;optimized out&gt;, co=&lt;optimized out&gt;) at ../Objects/codeobject.c:565</span><br><span class="line">  24   Thread 0x7f82f056a700 (LWP 7439) pthread_cond_timedwait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_timedwait.S:238</span><br><span class="line">  ...(çœç•¥)...</span><br><span class="line">  3    Thread 0x7f83161d4700 (LWP 6411) sem_wait () at ../nptl/sysdeps/unix/sysv/linux/x86_64/sem_wait.S:85</span><br><span class="line">  2    Thread 0x7f83159d3700 (LWP 6410) sem_wait () at ../nptl/sysdeps/unix/sysv/linux/x86_64/sem_wait.S:85</span><br><span class="line">* 1    Thread 0x7f83151d2700 (LWP 6405) sem_wait () at ../nptl/sysdeps/unix/sysv/linux/x86_64/sem_wait.S:85</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨<code>info threads</code>æŸ¥çœ‹å½“å‰è¿›ç¨‹çš„çº¿ç¨‹åˆ—è¡¨ï¼Œå‘ç°å¤§éƒ¨åˆ†éƒ½åœ¨<code>wait</code>ä¿¡å·ï¼Œåªæœ‰ 25 å·çº¿ç¨‹åœ¨åšå…¶ä»–äº‹æƒ…ï¼Œåˆ‡æ¢åˆ° 25 å·çº¿ç¨‹ï¼Œåˆ†æè°ƒç”¨æ ˆï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) thread 25</span><br><span class="line">[Switching to thread 25 (Thread 0x7f8361666700 (LWP 6325))]</span><br><span class="line">#0  _PyCode_CheckLineNumber (bounds=&lt;optimized out&gt;, lasti=&lt;optimized out&gt;, co=&lt;optimized out&gt;) at ../Objects/codeobject.c:565</span><br><span class="line">565     ../Objects/codeobject.c: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•.</span><br><span class="line"></span><br><span class="line">(gdb) py-bt</span><br><span class="line">Python Exception &lt;class &apos;gdb.MemoryError&apos;&gt; Cannot access memory at address 0x58: </span><br><span class="line">Error occurred in Python command: Cannot access memory at address 0x58</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨<code>py-bt</code>æŠ¥å†…å­˜è®¿é—®é”™è¯¯ï¼Œåªèƒ½ç”¨åŸå§‹<code>bt</code>æ¥åˆ†æäº†ï¼ˆæ·»åŠ <code>full</code>å‚æ•°å¯ä»¥çœ‹æ›´è¯¦ç»†çš„å†…å®¹ï¼‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(gdb) bt full</span><br><span class="line">#0  _PyCode_CheckLineNumber (bounds=&lt;optimized out&gt;, ...) at ../Objects/codeobject.c:565</span><br><span class="line">        size = 46</span><br><span class="line">        p = 0x7f82acb60f3c &quot;\006\001\006\001\r\001\006\001...&quot;</span><br><span class="line">#1  maybe_call_line_trace (instr_prev=&lt;optimized out&gt;, ...) at ../Python/ceval.c:3743        line = 79</span><br><span class="line">#2  PyEval_EvalFrameEx () at ../Python/ceval.c:1050</span><br><span class="line">        opcode = 6</span><br><span class="line">#3  0x00000000004c7a59 in PyEval_EvalCodeEx () at ../Python/ceval.c:3265</span><br><span class="line">        f = &lt;unknown at remote 0x849d0c8&gt;</span><br><span class="line">        retval = &lt;code at remote 0x7f835a1b5db0&gt;</span><br><span class="line">        fastlocals = 0x2e</span><br><span class="line">        tstate = 0xa2c0a0</span><br><span class="line">        u = &lt;unknown at remote 0xf2&gt;</span><br><span class="line">#4  0x00000000004cad3b in fast_function (nk=&lt;optimized out&gt;, ...) at ../Python/ceval.c:4129</span><br><span class="line">        co = 0x563c10 &lt;trace_trampoline&gt;</span><br><span class="line">        globals = &lt;unknown at remote 0xf2&gt;</span><br><span class="line">        argdefs = &lt;unknown at remote 0xf2&gt;</span><br><span class="line">#5  call_function (oparg=&lt;optimized out&gt;, pp_stack=&lt;optimized out&gt;) at ../Python/ceval.c:4054</span><br><span class="line">        func = &lt;function at remote 0x7f835a1dbb90&gt;</span><br><span class="line">        w = &lt;function at remote 0x7f835a1dbb90&gt;</span><br><span class="line">        nk = 682340552</span><br><span class="line">        n = 4</span><br><span class="line">        pfunc = 0x3276ea8</span><br><span class="line">#6  PyEval_EvalFrameEx () at ../Python/ceval.c:2679</span><br><span class="line">        sp = 0x3276ec8</span><br><span class="line">        opcode = 2</span><br><span class="line">#7  0x00000000004c996a in fast_function (nk=&lt;optimized out&gt;, ...) at ../Python/ceval.c:4119</span><br><span class="line">        f = Frame 0x3276cd0, for file ./service/recall/newuser.py, line 49, in get_gametype_anchor_by_sn (...(truncated)</span><br><span class="line">        tstate = 0xa2c0a0</span><br><span class="line">        stack = 0xf2</span><br><span class="line">        co = 0x563c10 &lt;trace_trampoline&gt;</span><br><span class="line">        globals = &lt;unknown at remote 0xf2&gt;</span><br><span class="line">        argdefs = &lt;unknown at remote 0xf2&gt;</span><br><span class="line">#8  call_function (oparg=&lt;optimized out&gt;, pp_stack=&lt;optimized out&gt;) at ../Python/ceval.c:4054</span><br><span class="line">        func = &lt;function at remote 0x7f835a1dbaa0&gt;</span><br><span class="line">        w = &lt;function at remote 0x7f835a1dbaa0&gt;</span><br><span class="line">        nk = 682340552</span><br><span class="line">        n = 7</span><br><span class="line">        pfunc = 0x5b971d8</span><br><span class="line">...(çœç•¥)...</span><br><span class="line">#43 0x00007f83243691b0 in ?? ()</span><br><span class="line">No symbol table info available.</span><br><span class="line">#44 0x0000000000000000 in ?? ()</span><br><span class="line">No symbol table info available.</span><br></pre></td></tr></table></figure>
<p>åˆ†æ<code>Frame # 7</code>å‘ç°å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œ<code>./service/recall/newuser.py, line 49, in get_gametype_anchor_by_sn</code>æ–¹æ³•ã€‚</p>
<p>æ‰¾åˆ°å¯¹åº”çš„æºä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def get_predict_gametype_anchor(self, gt_scores, limit):</span><br><span class="line">        ...</span><br><span class="line">        while pool_can_use and curr_sample_cnt &lt; sample_cnt:</span><br><span class="line">            for idx, ent in enumerate(gt_pool):</span><br><span class="line">                   ...</span><br></pre></td></tr></table></figure>
<p>æœç„¶ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ª<code>while</code>å¾ªç¯åµŒå¥—äº†<code>enumerate</code>è°ƒç”¨ã€‚é€šè¿‡ä»”ç»†åˆ†æä»£ç ï¼Œå‘ç°åœ¨æŸç§æƒ…å†µä¸‹ç¡®å®ä¼šå‡ºç°æ­»å¾ªç¯æƒ…å†µï¼Œè‡³æ­¤é—®é¢˜è§£å†³ã€‚</p>
<h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol>
<li>é‡åˆ°çº¿ä¸Šé—®é¢˜æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨ <code>gcore PID</code> æ¥ä¿å­˜ç°åœº</li>
<li>å† <a href="http://rdcqii.hundsun.com/portal/article/597.html" target="_blank" rel="noopener">ä½¿ç”¨ straceã€ltrace</a> å’Œ <code>gdb</code> åˆ†æ</li>
<li>å¦‚æœæ²¡æœ‰ä»€ä¹ˆçº¿ç´¢ï¼Œå¯ä»¥å°è¯• <a href="https://pyrasite.readthedocs.io/en/latest/Shell.html" target="_blank" rel="noopener">pyrasite-shell</a> æˆ– <a href="https://github.com/khamidou/lptrace" target="_blank" rel="noopener">lptrace</a></li>
<li><code>gdb</code> è°ƒè¯• <code>Python</code> è¿›ç¨‹çš„æ—¶å€™ï¼Œè¿è¡Œè¿›ç¨‹çš„ <code>Python</code> ç‰ˆæœ¬å’Œ python-dbg ä¸€å®šè¦åŒ¹é…</li>
</ol>
<h2 id="asyncioåç¨‹åŸç†"><a href="#asyncioåç¨‹åŸç†" class="headerlink" title="asyncioåç¨‹åŸç†"></a>asyncioåç¨‹åŸç†</h2><p>æœ‰ä¸€ä¸ªä»»åŠ¡è°ƒåº¦å™¨event loopï¼Œæˆ‘ä»¬å¯ä»¥æŠŠéœ€è¦æ‰§è¡Œçš„coroutineæ‰“åŒ…æˆtaskåŠ å…¥åˆ°event loopçš„è°ƒåº¦åˆ—è¡¨é‡Œé¢ï¼ˆä»¥Handleå½¢å¼ï¼‰ã€‚</p>
<p> åœ¨event loopçš„æ¯ä¸ª<a href="#asyncioåç¨‹æ ˆå¸§">å¸§</a>é‡Œé¢ï¼Œå®ƒä¼šæ£€æŸ¥éœ€è¦æ‰§è¡Œé‚£äº›taskï¼Œç„¶åè¿è¡Œè¿™äº›taskï¼Œå¯èƒ½æ‹¿åˆ°æœ€ç»ˆç»“æœï¼Œä¹Ÿå¯èƒ½æ‰§è¡Œä¸€åŠç»§ç»­awaitåˆ«çš„ä»»åŠ¡ï¼Œä»»åŠ¡ä¹‹é—´äº’ç›¸waitï¼Œé€šè¿‡å›è°ƒæ¥æŠŠä»»åŠ¡ä¸²è”èµ·æ¥</p>
<p>ä»»åŠ¡å¯èƒ½ä¼šä¾èµ–åˆ«çš„IOæ¶ˆæ¯ï¼Œåœ¨æ¯ä¸€<a href="#asyncioåç¨‹æ ˆå¸§">å¸§</a>ï¼Œevent loopéƒ½ä¼šç”¨selector(è¿™ä¸ªselectå°±æ˜¯ç±»ä¼¼æŸç§å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œæ¯”å¦‚selectï¼Œepollå’Œiocp)å¤„ç†ç›¸åº”çš„æ¶ˆæ¯ï¼Œæ‰§è¡Œç›¸åº”çš„callbackå‡½æ•°ã€‚</p>
<p>æˆ‘ä»¬å½“å‰çš„ä»‹ç»é‡Œï¼Œåªæœ‰ä¸€ä¸ªevent loopï¼Œè¿™ä¸ªevent loopè·‘åœ¨ä¸»çº¿ç¨‹é‡Œé¢ã€‚å½“ç„¶ï¼Œevent loopè¿˜å¯ä»¥å¼€çº¿ç¨‹æ± å¤„ç†åˆ«çš„ä»»åŠ¡ï¼Œæˆ–è€…ï¼Œå¤šä¸ªçº¿ç¨‹é‡Œæ‰§è¡Œå¤šä¸ªevent loopï¼Œä»–ä»¬ä¹‹é—´è¿˜æœ‰äº¤äº’ï¼Œæˆ‘ä»¬è¿™é‡Œä¸åœ¨ä»‹ç»ã€‚   </p>
<p>å•ä¸ªevent loopè·‘åœ¨å•ä¸ªçº¿ç¨‹æœ‰ä¸ªå¥½å¤„ï¼Œåªè¦è‡ªå·±ä¸ä¸»åŠ¨awaitï¼Œå°±ä¼šä¸€ç›´å æœ‰ä¸»çº¿ç¨‹ï¼Œæ¢å¥è¯è¯´ï¼ŒåŒæ­¥å‡½æ•°ä¸€å®šæ²¡æœ‰æ•°æ®å†²çªï¼ˆdata racingï¼‰ã€‚å¯¹æ¯”å¤šçº¿ç¨‹æ–¹æ¡ˆï¼Œå¦‚æœéœ€è¦å¤„ç†æ•°æ®å†²çªï¼Œå°±éœ€è¦åŠ é”äº†ï¼Œè¿™åœ¨å¾ˆå¤šæƒ…å†µä¸‹ä¼šé™ä½ç¨‹åºçš„æ€§èƒ½ã€‚æ‰€ä»¥åç¨‹è¿™ç§è®¾è®¡æ€è·¯ï¼Œéå¸¸é€‚åˆæœ‰å¤šä¸ªç”¨æˆ·ã€ä½†æ˜¯æ¯ä¸ªç”¨æˆ·ä¹‹é—´æ²¡æœ‰å…±äº«æ•°æ®çš„åœºæ™¯ã€‚å¦‚æœéœ€è¦å®ç°å¹¶è¡Œï¼Œå¤šå¼€å‡ ä¸ªè¿›ç¨‹å°±è¡Œäº†</p>
<h3 id="asyncioåç¨‹æ ˆå¸§"><a href="#asyncioåç¨‹æ ˆå¸§" class="headerlink" title="asyncioåç¨‹æ ˆå¸§"></a>asyncioåç¨‹æ ˆå¸§</h3><p>python ä¸­çš„ä¸Šä¸‹æ–‡ï¼Œè¢«å°è£…æˆäº†ä¸€ä¸ªå«åš PyFrameObject çš„ç»“æ„ï¼Œåˆç§°ä¹‹ä¸ºæ ˆå¸§ï¼Œçœ‹ä¸€ä¸‹ä»–çš„æºç ã€‚<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">frame</span> &#123;</span></span><br><span class="line">    PyObject_VAR_HEAD</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">frame</span> *<span class="title">f_back</span>;</span>      <span class="comment">/* previous frame, or NULL  ä¸Šä¸€ä¸ªæ ˆå¸§*/</span></span><br><span class="line">    PyCodeObject *f_code;       <span class="comment">/* code segment ä»£ç æ®µ*/</span></span><br><span class="line">    PyObject *f_builtins;       <span class="comment">/* builtin symbol table (PyDictObject) å†…å»ºå˜é‡è¡¨*/</span></span><br><span class="line">    PyObject *f_globals;        <span class="comment">/* global symbol table (PyDictObject)  å…¨å±€å˜é‡è¡¨*/</span></span><br><span class="line">    PyObject *f_locals;         <span class="comment">/* local symbol table (any mapping)  å±€éƒ¨å˜é‡è¡¨*/</span></span><br><span class="line">    PyObject **f_valuestack;    <span class="comment">/* points after the last local  æ ˆåº•*/</span></span><br><span class="line">    <span class="comment">/* Next free slot in f_valuestack.  Frame creation sets to f_valuestack.</span></span><br><span class="line"><span class="comment">       Frame evaluation usually NULLs it, but a frame that yields sets it</span></span><br><span class="line"><span class="comment">       to the current stack top. */</span></span><br><span class="line">    PyObject **f_stacktop;    <span class="comment">/*  æ ˆé¡¶ */</span></span><br><span class="line">    PyObject *f_trace;          <span class="comment">/* Trace function */</span></span><br><span class="line">    <span class="keyword">char</span> f_trace_lines;         <span class="comment">/* Emit per-line trace events? */</span></span><br><span class="line">    <span class="keyword">char</span> f_trace_opcodes;       <span class="comment">/* Emit per-opcode trace events? */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Borrowed reference to a generator, or NULL  ä¸“ä¸ºç”Ÿæˆå™¨è®¾è®¡çš„æŒ‡é’ˆ*/</span></span><br><span class="line">    PyObject *f_gen;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> f_lasti;                <span class="comment">/* Last instruction if called   è¿è¡Œçš„ä¸Šä¸€ä¸ªå­—èŠ‚ç ä½ç½®*/</span></span><br><span class="line">    <span class="comment">/* Call PyFrame_GetLineNumber() instead of reading this field</span></span><br><span class="line"><span class="comment">       directly.  As of 2.3 f_lineno is only valid when tracing is</span></span><br><span class="line"><span class="comment">       active (i.e. when f_trace is set).  At other times we use</span></span><br><span class="line"><span class="comment">       PyCode_Addr2Line to calculate the line from the current</span></span><br><span class="line"><span class="comment">       bytecode index. */</span></span><br><span class="line">    <span class="keyword">int</span> f_lineno;               <span class="comment">/* Current line number   è¿è¡Œå­—èŠ‚ç å¯¹åº”çš„pythonæºä»£ç çš„è¡Œæ•°*/</span></span><br><span class="line">    <span class="keyword">int</span> f_iblock;               <span class="comment">/* index in f_blockstack */</span></span><br><span class="line">    <span class="keyword">char</span> f_executing;           <span class="comment">/* whether the frame is still executing */</span></span><br><span class="line">    PyTryBlock f_blockstack[CO_MAXBLOCKS]; <span class="comment">/* for try and loop blocks */</span></span><br><span class="line">    PyObject *f_localsplus[<span class="number">1</span>];  <span class="comment">/* locals+stack, dynamically sized */</span></span><br><span class="line">&#125; PyFrameObject;</span><br></pre></td></tr></table></figure></p>
<h2 id="importæµç¨‹"><a href="#importæµç¨‹" class="headerlink" title="importæµç¨‹"></a>importæµç¨‹</h2><ul>
<li>å½“Pythonçš„è§£é‡Šå™¨é‡åˆ°importè¯­å¥æˆ–è€…å…¶ä»–ä¸Šè¿°å¯¼å…¥è¯­å¥æ—¶,å®ƒä¼šå…ˆå»æŸ¥çœ‹sys.modulesä¸­æ˜¯å¦å·²ç»æœ‰åŒåæ¨¡å—è¢«å¯¼å…¥äº†,</li>
<li>å¦‚æœæœ‰å°±ç›´æ¥å–æ¥ç”¨;æ²¡æœ‰å°±å»æŸ¥é˜…sys.pathé‡Œé¢æ‰€æœ‰å·²ç»å‚¨å­˜çš„ç›®å½•.<ul>
<li>sys.pathè¿™ä¸ªåˆ—è¡¨åˆå§‹åŒ–çš„æ—¶å€™,é€šå¸¸åŒ…å«ä¸€äº›æ¥è‡ªå¤–éƒ¨çš„åº“(external libraries)æˆ–è€…æ˜¯æ¥è‡ªæ“ä½œç³»ç»Ÿçš„ä¸€äº›åº“,å½“ç„¶ä¹Ÿä¼šæœ‰ä¸€äº›ç±»ä¼¼äºdist-packageçš„æ ‡å‡†åº“åœ¨é‡Œé¢.è¿™äº›ç›®å½•é€šå¸¸æ˜¯è¢«æŒ‰ç…§é¡ºåºæˆ–è€…æ˜¯ç›´æ¥å»æœç´¢æƒ³è¦çš„â€“å¦‚æœè¯´ä»–ä»¬å½“ä¸­çš„ä¸€ä¸ªåŒ…å«æœ‰æœŸæœ›çš„packageæˆ–è€…æ˜¯module,è¿™ä¸ªpackageæˆ–è€…æ˜¯moduleå°†ä¼šåœ¨æ•´ä¸ªè¿‡ç¨‹ç»“æŸçš„æ—¶å€™è¢«ç›´æ¥æå–å‡ºæ¥ä¿å­˜åœ¨sys.modulesä¸­(sys.modulesæ˜¯ä¸€ä¸ªæ¨¡å—å:æ¨¡å—å¯¹è±¡çš„å­—å…¸ç»“æ„).</li>
<li>å½“ç„¶ï¼Œè¿™ä¸ª sys.path æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼ˆæ­£å¦‚ä¸Šæ–‡æåˆ°çš„ä¸€ç§è§£å†³åŠæ³•ï¼‰ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå½“å‰ç›®å½•åŒ…å«æœ‰å’Œæ ‡å‡†åº“åŒåçš„æ¨¡å—ï¼Œä¼šç›´æ¥ä½¿ç”¨å½“å‰ç›®å½•çš„æ¨¡å—è€Œä¸æ˜¯æ ‡å‡†æ¨¡å—ã€‚</li>
<li>å½“åœ¨è¿™äº›ä¸ªåœ°å€ä¸­å®åœ¨æ˜¯æ‰¾ä¸ç€æ—¶,å®ƒå°±ä¼šæŠ›å‡ºä¸€ä¸ªModuleNotFoundErroré”™è¯¯.</li>
</ul>
</li>
<li>å½“æˆ‘ä»¬è¦å¯¼å…¥ä¸€ä¸ªæ¨¡å—ï¼ˆæ¯”å¦‚ foo ï¼‰æ—¶ï¼Œè§£é‡Šå™¨é¦–å…ˆä¼šæ ¹æ®å‘½åæŸ¥æ‰¾å†…ç½®æ¨¡å—ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå®ƒå°±ä¼šå»æŸ¥æ‰¾ sys.path åˆ—è¡¨ä¸­çš„ç›®å½•ï¼Œçœ‹ç›®å½•ä¸­æ˜¯å¦æœ‰ foo.py ã€‚sys.path çš„åˆå§‹å€¼æ¥è‡ªäºï¼š  <ul>
<li>è¿è¡Œè„šæœ¬æ‰€åœ¨çš„ç›®å½•ï¼ˆå¦‚æœæ‰“å¼€çš„æ˜¯äº¤äº’å¼è§£é‡Šå™¨åˆ™æ˜¯å½“å‰ç›®å½•ï¼‰</li>
<li>PYTHONPATH ç¯å¢ƒå˜é‡ï¼ˆç±»ä¼¼äº PATH å˜é‡ï¼Œä¹Ÿæ˜¯ä¸€ç»„ç›®å½•åç»„æˆï¼‰</li>
<li>Python å®‰è£…æ—¶çš„é»˜è®¤è®¾ç½®</li>
</ul>
</li>
</ul>
<h2 id="ä¸ºå•¥å­—ç¬¦ä¸²joinæ¯”åŠ å·è¿æ¥å¿«"><a href="#ä¸ºå•¥å­—ç¬¦ä¸²joinæ¯”åŠ å·è¿æ¥å¿«" class="headerlink" title="ä¸ºå•¥å­—ç¬¦ä¸²joinæ¯”åŠ å·è¿æ¥å¿«"></a>ä¸ºå•¥å­—ç¬¦ä¸²joinæ¯”åŠ å·è¿æ¥å¿«</h2><p>å­—ç¬¦ä¸²æ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œå½“ç”¨æ“ä½œç¬¦<code>+</code>è¿æ¥å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œæ¯æ‰§è¡Œä¸€æ¬¡<code>+</code>éƒ½ä¼šç”³è¯·ä¸€å—æ–°çš„å†…å­˜ï¼Œç„¶åå¤åˆ¶ä¸Šä¸€ä¸ª<code>+</code>æ“ä½œçš„ç»“æœå’Œæœ¬æ¬¡æ“ä½œçš„å³æ“ä½œç¬¦åˆ°è¿™å—å†…å­˜ç©ºé—´ï¼Œå› æ­¤ç”¨<code>+</code>è¿æ¥å­—ç¬¦ä¸²çš„æ—¶å€™ä¼šæ¶‰åŠå¥½å‡ æ¬¡å†…å­˜ç”³è¯·å’Œå¤åˆ¶ã€‚è€Œ<code>join</code>åœ¨è¿æ¥å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œä¼šå…ˆè®¡ç®—éœ€è¦å¤šå¤§çš„å†…å­˜å­˜æ”¾ç»“æœï¼Œç„¶åä¸€æ¬¡æ€§ç”³è¯·æ‰€éœ€å†…å­˜å¹¶å°†å­—ç¬¦ä¸²å¤åˆ¶è¿‡å»ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆ<code>join</code>çš„æ€§èƒ½ä¼˜äº<code>+</code>çš„åŸå› ã€‚æ‰€ä»¥åœ¨è¿æ¥å­—ç¬¦ä¸²æ•°ç»„çš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”è€ƒè™‘ä¼˜å…ˆä½¿ç”¨<code>join</code>ã€‚</p>
<h2 id="iså’Œ-çš„åŒºåˆ«"><a href="#iså’Œ-çš„åŒºåˆ«" class="headerlink" title="iså’Œ==çš„åŒºåˆ«"></a>iså’Œ==çš„åŒºåˆ«</h2><p>å®˜æ–¹æ–‡æ¡£ä¸­è¯´ is è¡¨ç¤ºçš„æ˜¯å¯¹è±¡æ ‡ç¤ºç¬¦ï¼ˆobject identityï¼‰ï¼Œè€Œ == è¡¨ç¤ºçš„æ˜¯ç›¸ç­‰ï¼ˆequalityï¼‰ã€‚is çš„ä½œç”¨æ˜¯ç”¨æ¥æ£€æŸ¥å¯¹è±¡çš„æ ‡ç¤ºç¬¦æ˜¯å¦ä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡åœ¨å†…å­˜ä¸­çš„åœ°å€æ˜¯å¦ä¸€æ ·ï¼Œè€Œ == æ˜¯ç”¨æ¥æ£€æŸ¥ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰ã€‚</p>
<p>æˆ‘ä»¬åœ¨æ£€æŸ¥ a is b çš„æ—¶å€™ï¼Œå…¶å®ç›¸å½“äºæ£€æŸ¥ id(a) == id(b)ã€‚è€Œæ£€æŸ¥ a == b çš„æ—¶å€™ï¼Œå®é™…æ˜¯è°ƒç”¨äº†å¯¹è±¡ a çš„ <strong>eq()</strong> æ–¹æ³•ï¼Œa == b ç›¸å½“äº a.<strong>eq</strong>(b)ã€‚</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœ a is b è¿”å›Trueçš„è¯ï¼Œå³ a å’Œ b æŒ‡å‘åŒä¸€å—å†…å­˜åœ°å€çš„è¯ï¼Œa == b ä¹Ÿè¿”å›Trueï¼Œå³ a å’Œ b çš„å€¼ä¹Ÿç›¸ç­‰ã€‚</p>
<h2 id="å…ƒç±»"><a href="#å…ƒç±»" class="headerlink" title="å…ƒç±»"></a>å…ƒç±»</h2><p>å‚è€ƒ: <a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017592449371072" target="_blank" rel="noopener">https://www.liaoxuefeng.com/wiki/1016959663602400/1017592449371072</a></p>
<p>pythonå…ƒç±»çš„ä½¿ç”¨åœºæ™¯, æ¯”å¦‚ormæ¡†æ¶, ORMå…¨ç§°â€œObject Relational Mappingâ€ï¼Œå³å¯¹è±¡-å…³ç³»æ˜ å°„ï¼Œå°±æ˜¯æŠŠå…³ç³»æ•°æ®åº“çš„ä¸€è¡Œæ˜ å°„ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªç±»å¯¹åº”ä¸€ä¸ªè¡¨ï¼Œè¿™æ ·ï¼Œå†™ä»£ç æ›´ç®€å•ï¼Œä¸ç”¨ç›´æ¥æ“ä½œSQLè¯­å¥ã€‚</p>
<p><code>type()</code>å‡½æ•°æ—¢å¯ä»¥è¿”å›ä¸€ä¸ªå¯¹è±¡çš„ç±»å‹ï¼Œåˆå¯ä»¥åˆ›å»ºå‡ºæ–°çš„ç±»å‹ï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>type()</code>å‡½æ•°åˆ›å»ºå‡º<code>Hello</code>ç±»ï¼Œè€Œæ— éœ€é€šè¿‡<code>class Hello(object)...</code>çš„å®šä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\&gt;&gt;&gt; def fn(self, name=&apos;world&apos;): # å…ˆå®šä¹‰å‡½æ•°</span><br><span class="line">...     print(&apos;Hello, %s.&apos; % name)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt; Hello = type(&apos;Hello&apos;, (object,), dict(hello=fn)) # åˆ›å»ºHello class</span><br><span class="line">&gt;&gt;&gt; h = Hello()</span><br><span class="line">&gt;&gt;&gt; h.hello()</span><br><span class="line">Hello, world.</span><br><span class="line">&gt;&gt;&gt; print(type(Hello))</span><br><span class="line">&lt;class &apos;type&apos;&gt;</span><br><span class="line">&gt;&gt;&gt; print(type(h))</span><br><span class="line">&lt;class &apos;__main__.Hello&apos;&gt;</span><br></pre></td></tr></table></figure>
<p>è¦åˆ›å»ºä¸€ä¸ª class å¯¹è±¡ï¼Œ<code>type()</code>å‡½æ•°ä¾æ¬¡ä¼ å…¥ 3 ä¸ªå‚æ•°ï¼š</p>
<ol>
<li>class çš„åç§°ï¼›</li>
<li>ç»§æ‰¿çš„çˆ¶ç±»é›†åˆï¼Œæ³¨æ„ Python æ”¯æŒå¤šé‡ç»§æ‰¿ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªçˆ¶ç±»ï¼Œåˆ«å¿˜äº† tuple çš„å•å…ƒç´ å†™æ³•ï¼›</li>
<li>class çš„æ–¹æ³•åç§°ä¸å‡½æ•°ç»‘å®šï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠå‡½æ•°<code>fn</code>ç»‘å®šåˆ°æ–¹æ³•å<code>hello</code>ä¸Šã€‚</li>
</ol>
<p><strong>é€šè¿‡<code>type()</code>å‡½æ•°åˆ›å»ºçš„ç±»å’Œç›´æ¥å†™ class æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œå› ä¸º Python è§£é‡Šå™¨é‡åˆ° class å®šä¹‰æ—¶ï¼Œä»…ä»…æ˜¯æ‰«æä¸€ä¸‹ class å®šä¹‰çš„è¯­æ³•ï¼Œç„¶åè°ƒç”¨<code>type()</code>å‡½æ•°åˆ›å»ºå‡º class</strong>ã€‚</p>
<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ç”¨<code>class Xxx...</code>æ¥å®šä¹‰ç±»ï¼Œä½†æ˜¯ï¼Œ<code>type()</code>å‡½æ•°ä¹Ÿå…è®¸æˆ‘ä»¬åŠ¨æ€åˆ›å»ºå‡ºç±»æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒåŠ¨æ€è¯­è¨€æœ¬èº«æ”¯æŒè¿è¡ŒæœŸåŠ¨æ€åˆ›å»ºç±»ï¼Œè¿™å’Œé™æ€è¯­è¨€æœ‰éå¸¸å¤§çš„ä¸åŒï¼Œè¦åœ¨é™æ€è¯­è¨€è¿è¡ŒæœŸåˆ›å»ºç±»ï¼Œå¿…é¡»æ„é€ æºä»£ç å­—ç¬¦ä¸²å†è°ƒç”¨ç¼–è¯‘å™¨ï¼Œæˆ–è€…å€ŸåŠ©ä¸€äº›å·¥å…·ç”Ÿæˆå­—èŠ‚ç å®ç°ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯åŠ¨æ€ç¼–è¯‘ï¼Œä¼šéå¸¸å¤æ‚ã€‚</p>
<h3 id="metaclass"><a href="#metaclass" class="headerlink" title="metaclass"></a>metaclass</h3><p>é™¤äº†ä½¿ç”¨<code>type()</code>åŠ¨æ€åˆ›å»ºç±»ä»¥å¤–ï¼Œè¦æ§åˆ¶ç±»çš„åˆ›å»ºè¡Œä¸ºï¼Œè¿˜å¯ä»¥ä½¿ç”¨ metaclassã€‚<br>metaclassï¼Œç›´è¯‘ä¸ºå…ƒç±»ï¼Œç®€å•çš„è§£é‡Šå°±æ˜¯ï¼š<br>å½“æˆ‘ä»¬å®šä¹‰äº†ç±»ä»¥åï¼Œå°±å¯ä»¥æ ¹æ®è¿™ä¸ªç±»åˆ›å»ºå‡ºå®ä¾‹ï¼Œæ‰€ä»¥ï¼šå…ˆå®šä¹‰ç±»ï¼Œç„¶ååˆ›å»ºå®ä¾‹ã€‚<br>ä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³åˆ›å»ºå‡ºç±»å‘¢ï¼Ÿé‚£å°±å¿…é¡»æ ¹æ® metaclass åˆ›å»ºå‡ºç±»ï¼Œæ‰€ä»¥ï¼šå…ˆå®šä¹‰ metaclassï¼Œç„¶ååˆ›å»ºç±»ã€‚<br>è¿æ¥èµ·æ¥å°±æ˜¯ï¼š<strong>å…ˆå®šä¹‰ metaclassï¼Œå°±å¯ä»¥åˆ›å»ºç±»ï¼Œæœ€ååˆ›å»ºå®ä¾‹ã€‚</strong><br>æ‰€ä»¥ï¼Œmetaclass å…è®¸ä½ åˆ›å»ºç±»æˆ–è€…ä¿®æ”¹ç±»ã€‚æ¢å¥è¯è¯´ï¼Œä½ å¯ä»¥æŠŠç±»çœ‹æˆæ˜¯ metaclass åˆ›å»ºå‡ºæ¥çš„ â€œå®ä¾‹â€ã€‚<br>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œè¿™ä¸ª metaclass å¯ä»¥ç»™æˆ‘ä»¬è‡ªå®šä¹‰çš„ MyList å¢åŠ ä¸€ä¸ª<code>add</code>æ–¹æ³•ï¼š<br>å®šä¹‰<code>ListMetaclass</code>ï¼ŒæŒ‰ç…§é»˜è®¤ä¹ æƒ¯ï¼Œmetaclass çš„ç±»åæ€»æ˜¯ä»¥ Metaclass ç»“å°¾ï¼Œä»¥ä¾¿æ¸…æ¥šåœ°è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª metaclassï¼š<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListMetaclass</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name, bases, attrs)</span>:</span></span><br><span class="line">        attrs\[<span class="string">'add'</span>\] = <span class="keyword">lambda</span> self, value: self.append(value)</span><br><span class="line">        <span class="keyword">return</span> type.__new__(cls, name, bases, attrs)</span><br></pre></td></tr></table></figure></p>
<p>æœ‰äº† ListMetaclassï¼Œæˆ‘ä»¬åœ¨å®šä¹‰ç±»çš„æ—¶å€™è¿˜è¦æŒ‡ç¤ºä½¿ç”¨ ListMetaclass æ¥å®šåˆ¶ç±»ï¼Œä¼ å…¥å…³é”®å­—å‚æ•°<code>metaclass</code>ï¼š<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyList</span><span class="params">(list, metaclass=ListMetaclass)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p>
<p>å½“æˆ‘ä»¬ä¼ å…¥å…³é”®å­—å‚æ•°<code>metaclass</code>æ—¶ï¼Œé­”æœ¯å°±ç”Ÿæ•ˆäº†ï¼Œå®ƒæŒ‡ç¤º Python è§£é‡Šå™¨åœ¨åˆ›å»º<code>MyList</code>æ—¶ï¼Œè¦é€šè¿‡<code>ListMetaclass.__new__()</code>æ¥åˆ›å»ºï¼Œåœ¨æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ç±»çš„å®šä¹‰ï¼Œæ¯”å¦‚ï¼ŒåŠ ä¸Šæ–°çš„æ–¹æ³•ï¼Œç„¶åï¼Œè¿”å›ä¿®æ”¹åçš„å®šä¹‰ã€‚</p>
<p><code>__new__()</code>æ–¹æ³•æ¥æ”¶åˆ°çš„å‚æ•°ä¾æ¬¡æ˜¯ï¼š</p>
<ol>
<li>å½“å‰å‡†å¤‡åˆ›å»ºçš„ç±»çš„å¯¹è±¡ï¼›</li>
<li>ç±»çš„åå­—ï¼›</li>
<li>ç±»ç»§æ‰¿çš„çˆ¶ç±»é›†åˆï¼›</li>
<li>ç±»çš„æ–¹æ³•é›†åˆã€‚</li>
</ol>
<p>æµ‹è¯•ä¸€ä¸‹<code>MyList</code>æ˜¯å¦å¯ä»¥è°ƒç”¨<code>add()</code>æ–¹æ³•ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\&gt;&gt;&gt; L = MyList()</span><br><span class="line">&gt;&gt;&gt; L.add(1)</span><br><span class="line">&gt;&gt; L</span><br><span class="line">\[1\]</span><br></pre></td></tr></table></figure></p>
<p>è€Œæ™®é€šçš„<code>list</code>æ²¡æœ‰<code>add()</code>æ–¹æ³•ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\&gt;&gt;&gt; L2 = list()</span><br><span class="line">&gt;&gt;&gt; L2.add(1)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">AttributeError: &apos;list&apos; object has no attribute &apos;add&apos;</span><br></pre></td></tr></table></figure></p>
<h2 id="è£…é¥°å™¨"><a href="#è£…é¥°å™¨" class="headerlink" title="è£…é¥°å™¨"></a>è£…é¥°å™¨</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kw)</span>:</span></span><br><span class="line">        print(<span class="string">'call %s():'</span> % func.__name__)</span><br><span class="line">        <span class="keyword">return</span> func(*args, **kw)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure>
<p>è§‚å¯Ÿä¸Šé¢çš„logï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªdecoratorï¼Œæ‰€ä»¥æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå‡½æ•°ã€‚æˆ‘ä»¬è¦å€ŸåŠ©Pythonçš„@è¯­æ³•ï¼ŒæŠŠdecoratorç½®äºå‡½æ•°çš„å®šä¹‰å¤„ï¼š<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@log</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">now</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'2015-3-25'</span>)</span><br></pre></td></tr></table></figure></p>
<p>è°ƒç”¨now()å‡½æ•°ï¼Œä¸ä»…ä¼šè¿è¡Œnow()å‡½æ•°æœ¬èº«ï¼Œè¿˜ä¼šåœ¨è¿è¡Œnow()å‡½æ•°å‰æ‰“å°ä¸€è¡Œæ—¥å¿—ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; now()</span><br><span class="line">call now():</span><br><span class="line">2015-3-25</span><br></pre></td></tr></table></figure>
<p>æŠŠ@logæ”¾åˆ°now()å‡½æ•°çš„å®šä¹‰å¤„ï¼Œç›¸å½“äºæ‰§è¡Œäº†è¯­å¥ï¼š<br><code>now = log(now)</code><br>ç”±äºlog()æ˜¯ä¸€ä¸ªdecoratorï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥ï¼ŒåŸæ¥çš„now()å‡½æ•°ä»ç„¶å­˜åœ¨ï¼Œåªæ˜¯ç°åœ¨åŒåçš„nowå˜é‡æŒ‡å‘äº†æ–°çš„å‡½æ•°ï¼Œäºæ˜¯è°ƒç”¨now()å°†æ‰§è¡Œæ–°å‡½æ•°ï¼Œå³åœ¨log()å‡½æ•°ä¸­è¿”å›çš„wrapper()å‡½æ•°ã€‚</p>
<p>wrapper()å‡½æ•°çš„å‚æ•°å®šä¹‰æ˜¯(<em>args, *</em>kw)ï¼Œå› æ­¤ï¼Œwrapper()å‡½æ•°å¯ä»¥æ¥å—ä»»æ„å‚æ•°çš„è°ƒç”¨ã€‚åœ¨wrapper()å‡½æ•°å†…ï¼Œé¦–å…ˆæ‰“å°æ—¥å¿—ï¼Œå†ç´§æ¥ç€è°ƒç”¨åŸå§‹å‡½æ•°ã€‚</p>
<p>å¦‚æœdecoratoræœ¬èº«éœ€è¦ä¼ å…¥å‚æ•°ï¼Œé‚£å°±éœ€è¦ç¼–å†™ä¸€ä¸ªè¿”å›decoratorçš„é«˜é˜¶å‡½æ•°ï¼Œå†™å‡ºæ¥ä¼šæ›´å¤æ‚ã€‚æ¯”å¦‚ï¼Œè¦è‡ªå®šä¹‰logçš„æ–‡æœ¬ï¼š<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(text)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(func)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kw)</span>:</span></span><br><span class="line">            print(<span class="string">'%s %s():'</span> % (text, func.__name__))</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kw)</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> decorator</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ª3å±‚åµŒå¥—çš„decoratorç”¨æ³•å¦‚ä¸‹ï¼š<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@log('execute')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">now</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'2015-3-25'</span>)</span><br></pre></td></tr></table></figure></p>
<p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; now()</span><br><span class="line">execute now():</span><br><span class="line">2015-3-25</span><br></pre></td></tr></table></figure></p>
<p>å’Œä¸¤å±‚åµŒå¥—çš„decoratorç›¸æ¯”ï¼Œ3å±‚åµŒå¥—çš„æ•ˆæœæ˜¯è¿™æ ·çš„ï¼š<br><code>now = log(&#39;execute&#39;)(now)</code><br>æˆ‘ä»¬æ¥å‰–æä¸Šé¢çš„è¯­å¥ï¼Œé¦–å…ˆæ‰§è¡Œlog(â€˜executeâ€™)ï¼Œè¿”å›çš„æ˜¯decoratorå‡½æ•°ï¼Œå†è°ƒç”¨è¿”å›çš„å‡½æ•°ï¼Œå‚æ•°æ˜¯nowå‡½æ•°ï¼Œè¿”å›å€¼æœ€ç»ˆæ˜¯wrapperå‡½æ•°ã€‚</p>
<h2 id="pythonå‘½ä»¤è¡Œå‚æ•°"><a href="#pythonå‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="pythonå‘½ä»¤è¡Œå‚æ•°"></a>pythonå‘½ä»¤è¡Œå‚æ•°</h2><ul>
<li>-uå‚æ•°çš„ä½¿ç”¨ï¼špythonå‘½ä»¤åŠ ä¸Š-uï¼ˆunbufferedï¼‰å‚æ•°åä¼šå¼ºåˆ¶å…¶æ ‡å‡†è¾“å‡ºä¹ŸåŒæ ‡å‡†é”™è¯¯ä¸€æ ·ä¸é€šè¿‡ç¼“å­˜ç›´æ¥æ‰“å°åˆ°å±å¹•ã€‚</li>
<li>-cå‚æ•°ï¼Œæ”¯æŒæ‰§è¡Œå•è¡Œå‘½ä»¤/è„šæœ¬ã€‚å¦‚: <code>python -c &quot;import os;print(&#39;hello&#39;),print(&#39;world&#39;)&quot;</code></li>
</ul>
<h3 id="python-m-test-folder-test-pyä¸python-test-folder-testæœ‰ä»€ä¹ˆä¸åŒ"><a href="#python-m-test-folder-test-pyä¸python-test-folder-testæœ‰ä»€ä¹ˆä¸åŒ" class="headerlink" title="python -m test_folder/test.pyä¸python test_folder/testæœ‰ä»€ä¹ˆä¸åŒ"></a><code>python -m test_folder/test.py</code>ä¸<code>python test_folder/test</code>æœ‰ä»€ä¹ˆä¸åŒ</h3><p>æ¡Œé¢çš„test_folderæ–‡ä»¶å¤¹ä¸‹æœ‰ä¸ªtest.py<br><figure class="highlight python"><figcaption><span>test.py</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">print(sys.path)</span><br></pre></td></tr></table></figure></p>
<p>è¿è¡Œçœ‹çœ‹:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hulinhong@GIH-D-14531 MINGW64 ~/Desktop</span><br><span class="line">$ python test_folder/test.py</span><br><span class="line">[&apos;C:\\Users\\hulinhong\\Desktop\\test_folder&apos;, &apos;C:\\Program Files\\Python37\\python37.zip&apos;, &apos;C:\\Program Files\\Python37\\DLLs&apos;, &apos;C:\\Program Files\\Python37\\lib&apos;, &apos;C:\\Program Files\\Python37&apos;, &apos;C:\\Program Files\\Python37\\lib\\site-packages&apos;, &apos;C:\\Program Files\\Python37\\lib\\site-packages\\redis_py_cluster-2.1.0-py3.7.egg&apos;]</span><br><span class="line"></span><br><span class="line">hulinhong@GIH-D-14531 MINGW64 ~/Desktop</span><br><span class="line">$ python -m test_folder.test</span><br><span class="line">[&apos;C:\\Users\\hulinhong\\Desktop&apos;, &apos;C:\\Program Files\\Python37\\python37.zip&apos;, &apos;C:\\Program Files\\Python37\\DLLs&apos;, &apos;C:\\Program Files\\Python37\\lib&apos;, &apos;C:\\Program Files\\Python37&apos;, &apos;C:\\Program Files\\Python37\\lib\\site-packages&apos;, &apos;C:\\Program Files\\Python37\\lib\\site-packages\\redis_py_cluster-2.1.0-py3.7.egg&apos;]</span><br></pre></td></tr></table></figure></p>
<p>ç»†å¿ƒçš„åŒå­¦ä¼šå‘ç°ï¼Œ<strong>åŒºåˆ«</strong>å°±æ˜¯åœ¨ç¬¬ä¸€ä¸ªè·¯å¾„:  </p>
<ul>
<li>pythonç›´æ¥å¯åŠ¨æ˜¯æŠŠtest.pyæ–‡ä»¶æ‰€åœ¨çš„ç›®å½•æ”¾åˆ°äº†sys.pathå±æ€§ä¸­ã€‚</li>
<li>æ¨¡å—å¯åŠ¨æ˜¯æŠŠä½ è¾“å…¥å‘½ä»¤çš„ç›®å½•ï¼ˆä¹Ÿå°±æ˜¯å½“å‰è·¯å¾„ï¼‰ï¼Œæ”¾åˆ°äº†sys.pathå±æ€§ä¸­</li>
</ul>
<p>æ‰€ä»¥å°±ä¼šæœ‰ä¸‹é¢çš„æƒ…å†µ:</p>
<p>ç›®å½•ç»“æ„å¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package/</span><br><span class="line">    __init__.py</span><br><span class="line">    mod1.py</span><br><span class="line">package2/</span><br><span class="line">    __init__.py</span><br><span class="line">    run.py</span><br></pre></td></tr></table></figure></p>
<p>run.py å†…å®¹å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> package <span class="keyword">import</span> mod1</span><br><span class="line">print(sys.path)</span><br></pre></td></tr></table></figure></p>
<p>å¦‚ä½•æ‰èƒ½å¯åŠ¨run.pyæ–‡ä»¶ï¼Ÿ</p>
<ul>
<li><p>ç›´æ¥å¯åŠ¨ï¼ˆå¤±è´¥ï¼‰</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ  test_import_project git:(master) âœ— python package2/run.py</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;package2/run.py&quot;, line 2, in &lt;module&gt;</span><br><span class="line">    from package import mod1</span><br><span class="line">ImportError: No module named package</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä»¥æ¨¡å—æ–¹å¼å¯åŠ¨ï¼ˆæˆåŠŸï¼‰</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ  test_import_project git:(master) âœ— python -m package2.run</span><br><span class="line">[&apos;C:\\Users\\hulinhong\\Desktop&apos;,</span><br><span class="line">&apos;/usr/local/Cellar/python/2.7.11/Frameworks/Python.framework/Versions/2.7/lib/python27.zip&apos;,</span><br><span class="line">...]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å½“éœ€è¦å¯åŠ¨çš„pyæ–‡ä»¶å¼•ç”¨äº†ä¸€ä¸ªæ¨¡å—ã€‚ä½ éœ€è¦æ³¨æ„ï¼šåœ¨å¯åŠ¨çš„æ—¶å€™éœ€è¦è€ƒè™‘sys.pathä¸­æœ‰æ²¡æœ‰ä½ importçš„æ¨¡å—çš„è·¯å¾„ï¼<br>è¿™ä¸ªæ—¶å€™ï¼Œåˆ°åº•æ˜¯ä½¿ç”¨ç›´æ¥å¯åŠ¨ï¼Œè¿˜æ˜¯ä»¥æ¨¡å—çš„å¯åŠ¨ï¼Ÿç›®çš„å°±æ˜¯æŠŠimportçš„é‚£ä¸ªæ¨¡å—çš„è·¯å¾„æ”¾åˆ°sys.pathä¸­ã€‚ä½ æ˜¯ä¸æ˜¯æ˜ç™½äº†å‘¢ï¼Ÿ</p>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£å‚è€ƒï¼š <a href="http://www.pythondoc.com/pythontutorial3/modules.html" target="_blank" rel="noopener">http://www.pythondoc.com/pythontutorial3/modules.html</a></p>
</blockquote>
<p>å¯¼å…¥ä¸€ä¸ªå« mod1 çš„æ¨¡å—æ—¶ï¼Œè§£é‡Šå™¨å…ˆåœ¨å½“å‰ç›®å½•ä¸­æœç´¢åä¸º mod1.py çš„æ–‡ä»¶ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°çš„è¯ï¼Œæ¥ç€ä¼šåˆ° sys.path å˜é‡ä¸­ç»™å‡ºçš„ç›®å½•åˆ—è¡¨ä¸­æŸ¥æ‰¾ã€‚ sys.path å˜é‡çš„åˆå§‹å€¼æ¥è‡ªå¦‚ä¸‹ï¼š</p>
<p>è¾“å…¥è„šæœ¬çš„ç›®å½•ï¼ˆå½“å‰ç›®å½•ï¼‰ã€‚</p>
<ul>
<li>ç¯å¢ƒå˜é‡ PYTHONPATH è¡¨ç¤ºçš„ç›®å½•åˆ—è¡¨ä¸­æœç´¢(è¿™å’Œ shell å˜é‡ PATH å…·æœ‰ä¸€æ ·çš„è¯­æ³•ï¼Œå³ä¸€ç³»åˆ—ç›®å½•åçš„åˆ—è¡¨)ã€‚</li>
<li>Python é»˜è®¤å®‰è£…è·¯å¾„ä¸­æœç´¢ã€‚</li>
<li>å®é™…ä¸Šï¼Œè§£é‡Šå™¨ç”± sys.path å˜é‡æŒ‡å®šçš„è·¯å¾„ç›®å½•æœç´¢æ¨¡å—ï¼Œè¯¥å˜é‡åˆå§‹åŒ–æ—¶é»˜è®¤åŒ…å«äº†è¾“å…¥è„šæœ¬ï¼ˆæˆ–è€…å½“å‰ç›®å½•ï¼‰ï¼Œ PYTHONPATH å’Œå®‰è£…ç›®å½•ã€‚è¿™æ ·å°±å…è®¸ Pythonç¨‹åºäº†è§£å¦‚ä½•ä¿®æ”¹æˆ–æ›¿æ¢æ¨¡å—æœç´¢ç›®å½•ã€‚</li>
</ul>
<h2 id="new-ä¸-del-ä¸-init"><a href="#new-ä¸-del-ä¸-init" class="headerlink" title="__new__ ä¸ __del__ ä¸ __init__"></a><code>__new__</code> ä¸ <code>__del__</code> ä¸ <code>__init__</code></h2><p>å…ˆæ¥çœ‹ä¸€ä¸ªå•ä¾‹æ¨¡å¼çš„å®ç°<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span>:</span></span><br><span class="line">    __isinstance = <span class="keyword">False</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cls.__isinstance:  <span class="comment"># å¦‚æœè¢«å®ä¾‹åŒ–äº†</span></span><br><span class="line">            cls.__isinstance = object.__new__(cls)  <span class="comment"># å¦åˆ™å®ä¾‹åŒ–</span></span><br><span class="line">        <span class="keyword">return</span> cls.__isinstance  <span class="comment"># è¿”å›å®ä¾‹åŒ–çš„å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        print(<span class="string">'my name is %s'</span>%(name))</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'886, %s'</span>%(self.name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">d1 = Demo(<span class="string">'Alice'</span>)</span><br><span class="line">d2 = Demo(<span class="string">'Anew'</span>)</span><br><span class="line">print(d1)</span><br><span class="line">print(d2)</span><br></pre></td></tr></table></figure></p>
<p>æ‰“å°:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">my name is Alice</span><br><span class="line">my name is Anew</span><br><span class="line">&lt;__main__.Demo object at 0x000001446604D3C8&gt;</span><br><span class="line">&lt;__main__.Demo object at 0x000001446604D3C8&gt;</span><br><span class="line">886, Anew</span><br></pre></td></tr></table></figure></p>
<p><code>__new__</code> æ˜¯è´Ÿè´£å¯¹å½“å‰ç±»è¿›è¡Œå®ä¾‹åŒ–ï¼Œå¹¶å°†å®ä¾‹è¿”å›ï¼Œå¹¶ä¼ ç»™<code>__init__</code>æ–¹æ³•ï¼Œ<code>__init__</code>æ–¹æ³•ä¸­çš„selfå°±æ˜¯æŒ‡ä»£<code>__new__</code>ä¼ è¿‡æ¥çš„å¯¹è±¡ï¼Œæ‰€ä»¥å†æ¬¡å¼ºè°ƒï¼Œ<code>__init__</code>æ˜¯å®ä¾‹åŒ–åè°ƒç”¨çš„ç¬¬ä¸€ä¸ªæ–¹æ³•ã€‚</p>
<p><code>__del__</code>åœ¨å¯¹è±¡é”€æ¯æ—¶è¢«è°ƒç”¨ï¼Œå¾€å¾€ç”¨äºæ¸…é™¤æ•°æ®æˆ–è¿˜åŸç¯å¢ƒç­‰æ“ä½œï¼Œæ¯”å¦‚åœ¨ç±»ä¸­çš„å…¶ä»–æ™®é€šæ–¹æ³•ä¸­å®ç°äº†æ’å…¥æ•°æ®åº“çš„è¯­å¥ï¼Œå½“å¯¹è±¡è¢«é”€æ¯æ—¶æˆ‘ä»¬éœ€è¦å°†æ•°æ®è¿˜åŸï¼Œé‚£ä¹ˆè¿™æ—¶å¯ä»¥åœ¨<code>__del__</code>æ–¹æ³•ä¸­å®ç°è¿˜åŸæ•°æ®åº“æ•°æ®çš„åŠŸèƒ½ã€‚<code>__del__</code>è¢«æˆä¸ºææ„æ–¹æ³•ï¼ŒåŒæ ·å’ŒC++ä¸­çš„ææ„æ–¹æ³•ç±»ä¼¼ã€‚</p>
<h2 id="pythonåƒåœ¾å›æ”¶"><a href="#pythonåƒåœ¾å›æ”¶" class="headerlink" title="pythonåƒåœ¾å›æ”¶"></a>pythonåƒåœ¾å›æ”¶</h2><p>æ€»ä½“æ¥è¯´ï¼Œåœ¨Pythonä¸­ï¼Œä¸»è¦é€šè¿‡å¼•ç”¨è®¡æ•°è¿›è¡Œåƒåœ¾å›æ”¶ï¼›é€šè¿‡ â€œæ ‡è®°-æ¸…é™¤â€ è§£å†³å®¹å™¨å¯¹è±¡å¯èƒ½äº§ç”Ÿçš„å¾ªç¯å¼•ç”¨é—®é¢˜ï¼›é€šè¿‡ â€œåˆ†ä»£å›æ”¶â€ ä»¥ç©ºé—´æ¢æ—¶é—´çš„æ–¹æ³•æé«˜åƒåœ¾å›æ”¶æ•ˆç‡ã€‚</p>
<ul>
<li>å¼•ç”¨è®¡æ•°</li>
<li>æ ‡è®°æ¸…é™¤(Mark and Sweep)</li>
<li>åˆ†ä»£å›æ”¶</li>
</ul>
<h3 id="æ ‡è®°æ¸…é™¤å’‹å¼„çš„"><a href="#æ ‡è®°æ¸…é™¤å’‹å¼„çš„" class="headerlink" title="æ ‡è®°æ¸…é™¤å’‹å¼„çš„"></a>æ ‡è®°æ¸…é™¤å’‹å¼„çš„</h3><p>å‚è€ƒ: <a href="https://zhuanlan.zhihu.com/p/83251959" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/83251959</a></p>
<p>Python é‡‡ç”¨äº† <strong>â€œæ ‡è®°-æ¸…é™¤â€(Mark and Sweep)</strong> ç®—æ³•ï¼Œè§£å†³å®¹å™¨å¯¹è±¡å¯èƒ½äº§ç”Ÿçš„å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚(æ³¨æ„ï¼Œåªæœ‰å®¹å™¨å¯¹è±¡æ‰ä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨çš„æƒ…å†µï¼Œæ¯”å¦‚åˆ—è¡¨ã€å­—å…¸ã€ç”¨æˆ·è‡ªå®šä¹‰ç±»çš„å¯¹è±¡ã€å…ƒç»„ç­‰ã€‚è€Œåƒæ•°å­—ï¼Œå­—ç¬¦ä¸²è¿™ç±»ç®€å•ç±»å‹ä¸ä¼šå‡ºç°å¾ªç¯å¼•ç”¨ã€‚ä½œä¸ºä¸€ç§ä¼˜åŒ–ç­–ç•¥ï¼Œå¯¹äºåªåŒ…å«ç®€å•ç±»å‹çš„å…ƒç»„ä¹Ÿä¸åœ¨æ ‡è®°æ¸…é™¤ç®—æ³•çš„è€ƒè™‘ä¹‹åˆ—)</p>
<p>è·Ÿå…¶åç§°ä¸€æ ·ï¼Œè¯¥ç®—æ³•åœ¨è¿›è¡Œåƒåœ¾å›æ”¶æ—¶åˆ†æˆäº†ä¸¤æ­¥ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>Aï¼‰æ ‡è®°é˜¶æ®µï¼Œéå†æ‰€æœ‰çš„å¯¹è±¡ï¼Œå¦‚æœæ˜¯å¯è¾¾çš„ï¼ˆreachableï¼‰ï¼Œä¹Ÿå°±æ˜¯è¿˜æœ‰å¯¹è±¡å¼•ç”¨å®ƒï¼Œé‚£ä¹ˆå°±æ ‡è®°è¯¥å¯¹è±¡ä¸ºå¯è¾¾ï¼›</li>
<li>Bï¼‰æ¸…é™¤é˜¶æ®µï¼Œå†æ¬¡éå†å¯¹è±¡ï¼Œå¦‚æœå‘ç°æŸä¸ªå¯¹è±¡æ²¡æœ‰æ ‡è®°ä¸ºå¯è¾¾ï¼Œåˆ™å°±å°†å…¶å›æ”¶ã€‚</li>
</ul>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨æ ‡è®°æ¸…é™¤ç®—æ³•ä¸­ï¼Œä¸ºäº†è¿½è¸ªå®¹å™¨å¯¹è±¡ï¼Œéœ€è¦æ¯ä¸ªå®¹å™¨å¯¹è±¡ç»´æŠ¤ä¸¤ä¸ªé¢å¤–çš„æŒ‡é’ˆï¼Œç”¨æ¥å°†å®¹å™¨å¯¹è±¡ç»„æˆä¸€ä¸ªåŒç«¯é“¾è¡¨ï¼ŒæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘å‰åä¸¤ä¸ªå®¹å™¨å¯¹è±¡ï¼Œæ–¹ä¾¿æ’å…¥å’Œåˆ é™¤æ“ä½œã€‚python è§£é‡Šå™¨ (Cpython) ç»´æŠ¤äº†ä¸¤ä¸ªè¿™æ ·çš„åŒç«¯é“¾è¡¨ï¼Œä¸€ä¸ªé“¾è¡¨å­˜æ”¾ç€éœ€è¦è¢«æ‰«æçš„å®¹å™¨å¯¹è±¡ï¼Œå¦ä¸€ä¸ªé“¾è¡¨å­˜æ”¾ç€ä¸´æ—¶ä¸å¯è¾¾å¯¹è±¡ã€‚åœ¨å›¾ä¸­ï¼Œè¿™ä¸¤ä¸ªé“¾è¡¨åˆ†åˆ«è¢«å‘½åä¸ºâ€Object to Scanâ€å’Œâ€Unreachableâ€ã€‚å›¾ä¸­ä¾‹å­æ˜¯è¿™ä¹ˆä¸€ä¸ªæƒ…å†µï¼šlink1,link2,link3 ç»„æˆäº†ä¸€ä¸ªå¼•ç”¨ç¯ï¼ŒåŒæ—¶ link1 è¿˜è¢«ä¸€ä¸ªå˜é‡ A(å…¶å®è¿™é‡Œç§°ä¸ºåç§° A æ›´å¥½)å¼•ç”¨ã€‚link4 è‡ªå¼•ç”¨ï¼Œä¹Ÿæ„æˆäº†ä¸€ä¸ªå¼•ç”¨ç¯ã€‚ä»å›¾ä¸­æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹é™¤äº†æœ‰ä¸€ä¸ªè®°å½•å½“å‰å¼•ç”¨è®¡æ•°çš„å˜é‡ ref_count è¿˜æœ‰ä¸€ä¸ª gc_ref å˜é‡ï¼Œè¿™ä¸ª gc_ref æ˜¯ ref_count çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œæ‰€ä»¥åˆå§‹å€¼ä¸º ref_count çš„å¤§å°ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/python/v2-0d5071093adaa02bc03fa3dfd91aa5bc_720w.jpg" alt></p>
<p>gc å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šé€ä¸ªéå†â€Object to Scanâ€ é“¾è¡¨ä¸­çš„å®¹å™¨å¯¹è±¡ï¼Œå¹¶ä¸”å°†å½“å‰å¯¹è±¡æ‰€å¼•ç”¨çš„æ‰€æœ‰å¯¹è±¡çš„ gc_ref å‡ä¸€ã€‚(æ‰«æåˆ° link1 çš„æ—¶å€™ï¼Œç”±äº link1 å¼•ç”¨äº† link2, æ‰€ä»¥ä¼šå°† link2 çš„ gc_ref å‡ä¸€ï¼Œæ¥ç€æ‰«æ link2, ç”±äº link2 å¼•ç”¨äº† link3, æ‰€ä»¥ä¼šå°† link3 çš„ gc_ref å‡ä¸€â€¦..) åƒè¿™æ ·å°†â€Objects to Scanâ€ é“¾è¡¨ä¸­çš„æ‰€æœ‰å¯¹è±¡è€ƒå¯Ÿä¸€éä¹‹åï¼Œä¸¤ä¸ªé“¾è¡¨ä¸­çš„å¯¹è±¡çš„ ref_count å’Œ gc_ref çš„æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚è¿™ä¸€æ­¥æ“ä½œå°±ç›¸å½“äºè§£é™¤äº†å¾ªç¯å¼•ç”¨å¯¹å¼•ç”¨è®¡æ•°çš„å½±å“ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="https://pic3.zhimg.com/v2-d7314ead6b303f08a91687577c045585_b.jpg" alt></p>
<p>æ¥ç€ï¼Œgc ä¼šå†æ¬¡æ‰«ææ‰€æœ‰çš„å®¹å™¨å¯¹è±¡ï¼Œå¦‚æœå¯¹è±¡çš„ gc_ref å€¼ä¸º 0ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±è¢«æ ‡è®°ä¸º GC_TENTATIVELY_UNREACHABLEï¼Œå¹¶ä¸”è¢«ç§»è‡³â€Unreachableâ€ é“¾è¡¨ä¸­ã€‚ä¸‹å›¾ä¸­çš„ link3 å’Œ link4 å°±æ˜¯è¿™æ ·ä¸€ç§æƒ…å†µã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="https://pic1.zhimg.com/v2-d3c3f52615fb704c26bd53dbb178767c_b.jpg" alt></p>
<p>å¦‚æœå¯¹è±¡çš„ gc_ref ä¸ä¸º 0ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±ä¼šè¢«æ ‡è®°ä¸º GC_REACHABLEã€‚åŒæ—¶å½“ gc å‘ç°æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¯è¾¾çš„ï¼Œé‚£ä¹ˆä»–ä¼šé€’å½’å¼çš„å°†ä»è¯¥èŠ‚ç‚¹å‡ºå‘å¯ä»¥åˆ°è¾¾çš„æ‰€æœ‰èŠ‚ç‚¹æ ‡è®°ä¸º GC_REACHABLE, è¿™å°±æ˜¯ä¸‹å›¾ä¸­ link2 å’Œ link3 æ‰€ç¢°åˆ°çš„æƒ…å½¢ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="https://pic1.zhimg.com/v2-510f4d2d37aabdbc8978d9e47630237d_b.jpg" alt></p>
<p>é™¤äº†å°†æ‰€æœ‰å¯è¾¾èŠ‚ç‚¹æ ‡è®°ä¸º GC_REACHABLE ä¹‹å¤–ï¼Œå¦‚æœè¯¥èŠ‚ç‚¹å½“å‰åœ¨â€Unreachableâ€ é“¾è¡¨ä¸­çš„è¯ï¼Œè¿˜éœ€è¦å°†å…¶ç§»å›åˆ°â€Object to Scanâ€ é“¾è¡¨ä¸­ï¼Œä¸‹å›¾å°±æ˜¯ link3 ç§»å›ä¹‹åçš„æƒ…å½¢ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/python/v2-6fd40c055a6633c654acaf05f472c1b2_720w.jpg" alt></p>
<p>ç¬¬äºŒæ¬¡éå†çš„æ‰€æœ‰å¯¹è±¡éƒ½éå†å®Œæˆä¹‹åï¼Œå­˜åœ¨äºâ€Unreachableâ€ é“¾è¡¨ä¸­çš„å¯¹è±¡å°±æ˜¯çœŸæ­£éœ€è¦è¢«é‡Šæ”¾çš„å¯¹è±¡ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ­¤æ—¶ link4 å­˜åœ¨äº Unreachable é“¾è¡¨ä¸­ï¼Œgc éšå³é‡Šæ”¾ä¹‹ã€‚</p>
<p><strong>ä¸Šé¢æè¿°çš„åƒåœ¾å›æ”¶çš„é˜¶æ®µï¼Œä¼šæš‚åœæ•´ä¸ªåº”ç”¨ç¨‹åºï¼Œç­‰å¾…æ ‡è®°æ¸…é™¤ç»“æŸåæ‰ä¼šæ¢å¤åº”ç”¨ç¨‹åºçš„è¿è¡Œã€‚</strong></p>
<h4 id="ä¸ºå•¥æ ‡è®°æ¸…é™¤å›æ”¶æ— æ³•å›æ”¶é‡å†™äº†-del-æ–¹æ³•çš„ç±»å¯¹è±¡"><a href="#ä¸ºå•¥æ ‡è®°æ¸…é™¤å›æ”¶æ— æ³•å›æ”¶é‡å†™äº†-del-æ–¹æ³•çš„ç±»å¯¹è±¡" class="headerlink" title="ä¸ºå•¥æ ‡è®°æ¸…é™¤å›æ”¶æ— æ³•å›æ”¶é‡å†™äº†__del__æ–¹æ³•çš„ç±»å¯¹è±¡"></a>ä¸ºå•¥æ ‡è®°æ¸…é™¤å›æ”¶æ— æ³•å›æ”¶é‡å†™äº†<code>__del__</code>æ–¹æ³•çš„ç±»å¯¹è±¡</h4><blockquote>
<p>Circular references which are garbage are detected when the option cycle detector is enabled (itâ€™s on by default), but can only be cleaned up if there are no Python-level <code>__del__</code>() methods involved.</p>
</blockquote>
<p>å®˜æ–¹æ–‡æ¡£ä¸­è¡¨æ˜å¯ç”¨å‘¨æœŸæ£€æµ‹å™¨æ—¶ä¼šæ£€æµ‹åˆ°åƒåœ¾çš„å¾ªç¯å¼•ç”¨ï¼ˆé»˜è®¤æƒ…å†µä¸‹å®ƒæ˜¯æ‰“å¼€çš„)ï¼Œä½†åªæœ‰åœ¨æ²¡æœ‰æ¶‰åŠ Python <code>__del__()</code> æ–¹æ³•çš„æƒ…å†µä¸‹æ‰èƒ½æ¸…é™¤ã€‚Python ä¸çŸ¥é“ç ´åå½¼æ­¤ä¿æŒå¾ªç¯å¼•ç”¨çš„å¯¹è±¡çš„å®‰å…¨é¡ºåºï¼Œå› æ­¤å®ƒåˆ™ä¸ä¼šä¸ºè¿™äº›æ–¹æ³•è°ƒç”¨ææ„å‡½æ•°ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå¦‚æœå®šä¹‰äº† <code>__del__</code> å‡½æ•°ï¼Œé‚£ä¹ˆåœ¨å¾ªç¯å¼•ç”¨ä¸­Pythonè§£é‡Šå™¨æ— æ³•åˆ¤æ–­ææ„å¯¹è±¡çš„é¡ºåºï¼Œå› æ­¤å°±ä¸åšå¤„ç†ã€‚</p>
<h3 id="åˆ†ä»£å›æ”¶"><a href="#åˆ†ä»£å›æ”¶" class="headerlink" title="åˆ†ä»£å›æ”¶"></a>åˆ†ä»£å›æ”¶</h3><p>åœ¨å¾ªç¯å¼•ç”¨å¯¹è±¡çš„å›æ”¶ä¸­ï¼Œæ•´ä¸ªåº”ç”¨ç¨‹åºä¼šè¢«æš‚åœï¼Œä¸ºäº†å‡å°‘åº”ç”¨ç¨‹åºæš‚åœçš„æ—¶é—´ï¼ŒPython é€šè¿‡â€œåˆ†ä»£å›æ”¶â€(Generational Collection)ä»¥ç©ºé—´æ¢æ—¶é—´çš„æ–¹æ³•æé«˜åƒåœ¾å›æ”¶æ•ˆç‡ã€‚</p>
<p>åˆ†ä»£å›æ”¶æ˜¯åŸºäºè¿™æ ·çš„ä¸€ä¸ªç»Ÿè®¡äº‹å®ï¼Œå¯¹äºç¨‹åºï¼Œå­˜åœ¨ä¸€å®šæ¯”ä¾‹çš„å†…å­˜å—çš„ç”Ÿå­˜å‘¨æœŸæ¯”è¾ƒçŸ­ï¼›è€Œå‰©ä¸‹çš„å†…å­˜å—ï¼Œç”Ÿå­˜å‘¨æœŸä¼šæ¯”è¾ƒé•¿ï¼Œç”šè‡³ä¼šä»ç¨‹åºå¼€å§‹ä¸€ç›´æŒç»­åˆ°ç¨‹åºç»“æŸã€‚ç”Ÿå­˜æœŸè¾ƒçŸ­å¯¹è±¡çš„æ¯”ä¾‹é€šå¸¸åœ¨ 80%ï½90% ä¹‹é—´ï¼Œè¿™ç§æ€æƒ³ç®€å•ç‚¹è¯´å°±æ˜¯ï¼šå¯¹è±¡å­˜åœ¨æ—¶é—´è¶Šé•¿ï¼Œè¶Šå¯èƒ½ä¸æ˜¯åƒåœ¾ï¼Œåº”è¯¥è¶Šå°‘å»æ”¶é›†ã€‚è¿™æ ·åœ¨æ‰§è¡Œæ ‡è®°-æ¸…é™¤ç®—æ³•æ—¶å¯ä»¥æœ‰æ•ˆå‡å°éå†çš„å¯¹è±¡æ•°ï¼Œä»è€Œæé«˜åƒåœ¾å›æ”¶çš„é€Ÿåº¦ã€‚</p>
<p>python gcç»™å¯¹è±¡å®šä¹‰äº†ä¸‰ç§ä¸–ä»£(0,1,2),æ¯ä¸€ä¸ªæ–°ç”Ÿå¯¹è±¡åœ¨generation zeroä¸­ï¼Œå¦‚æœå®ƒåœ¨ä¸€è½®gcæ‰«æä¸­æ´»äº†ä¸‹æ¥ï¼Œé‚£ä¹ˆå®ƒå°†è¢«ç§»è‡³generation one,åœ¨é‚£é‡Œä»–å°†è¾ƒå°‘çš„è¢«æ‰«æï¼Œå¦‚æœå®ƒåˆæ´»è¿‡äº†ä¸€è½®gc,å®ƒåˆå°†è¢«ç§»è‡³generation twoï¼Œåœ¨é‚£é‡Œå®ƒè¢«æ‰«æçš„æ¬¡æ•°å°†ä¼šæ›´å°‘ã€‚</p>
<p>gcçš„æ‰«æåœ¨ä»€ä¹ˆæ—¶å€™ä¼šè¢«è§¦å‘å‘¢?ç­”æ¡ˆæ˜¯å½“æŸä¸€ä¸–ä»£ä¸­è¢«åˆ†é…çš„å¯¹è±¡ä¸è¢«é‡Šæ”¾çš„å¯¹è±¡ä¹‹å·®è¾¾åˆ°æŸä¸€é˜ˆå€¼çš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘gcå¯¹æŸä¸€ä¸–ä»£çš„æ‰«æã€‚å€¼å¾—æ³¨æ„çš„æ˜¯å½“æŸä¸€ä¸–ä»£çš„æ‰«æè¢«è§¦å‘çš„æ—¶å€™ï¼Œæ¯”è¯¥ä¸–ä»£å¹´è½»çš„ä¸–ä»£ä¹Ÿä¼šè¢«æ‰«æã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸–ä»£2çš„gcæ‰«æè¢«è§¦å‘äº†ï¼Œé‚£ä¹ˆä¸–ä»£0,ä¸–ä»£1ä¹Ÿå°†è¢«æ‰«æï¼Œå¦‚æœä¸–ä»£1çš„gcæ‰«æè¢«è§¦å‘ï¼Œä¸–ä»£0ä¹Ÿä¼šè¢«æ‰«æã€‚</p>
<p>è¯¥é˜ˆå€¼å¯ä»¥é€šè¿‡ä¸‹é¢ä¸¤ä¸ªå‡½æ•°æŸ¥çœ‹å’Œè°ƒæ•´:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">gc.get_threshold() <span class="comment"># (threshold0, threshold1, threshold2).</span></span><br><span class="line">gc.set_threshold(threshold0[, threshold1[, threshold2]])</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢å¯¹set_threshold()ä¸­çš„ä¸‰ä¸ªå‚æ•°threshold0, threshold1, threshold2è¿›è¡Œä»‹ç»ã€‚gcä¼šè®°å½•è‡ªä»ä¸Šæ¬¡æ”¶é›†ä»¥æ¥æ–°åˆ†é…çš„å¯¹è±¡æ•°é‡ä¸é‡Šæ”¾çš„å¯¹è±¡æ•°é‡ï¼Œå½“ä¸¤è€…ä¹‹å·®è¶…è¿‡threshold0çš„å€¼æ—¶ï¼Œgcçš„æ‰«æå°±ä¼šå¯åŠ¨ï¼Œåˆå§‹çš„æ—¶å€™åªæœ‰ä¸–ä»£0è¢«æ£€æŸ¥ã€‚å¦‚æœè‡ªä»ä¸–ä»£1æœ€è¿‘ä¸€æ¬¡è¢«æ£€æŸ¥ä»¥æ¥ï¼Œä¸–ä»£0è¢«æ£€æŸ¥è¶…è¿‡threshold1æ¬¡ï¼Œé‚£ä¹ˆå¯¹ä¸–ä»£1çš„æ£€æŸ¥å°†è¢«è§¦å‘ã€‚ç›¸åŒçš„ï¼Œå¦‚æœè‡ªä»ä¸–ä»£2æœ€è¿‘ä¸€æ¬¡è¢«æ£€æŸ¥ä»¥æ¥ï¼Œä¸–ä»£1è¢«æ£€æŸ¥è¶…è¿‡threshold2æ¬¡ï¼Œé‚£ä¹ˆå¯¹ä¸–ä»£2çš„æ£€æŸ¥å°†è¢«è§¦å‘ã€‚get_threshold()æ˜¯è·å–ä¸‰è€…çš„å€¼ï¼Œé»˜è®¤å€¼ä¸º(700,10,10).</p>
<h1 id="CPP"><a href="#CPP" class="headerlink" title="CPP"></a>CPP</h1><p>å‚è€ƒ: çœ‹ä¹‹å‰ä¸€ä¸ªå“¥ä»¬æ€»ç»“çš„c++è¦ç‚¹ <a href="https://interview.huihut.com/" target="_blank" rel="noopener">https://interview.huihut.com/</a></p>
<ul>
<li><p><code>new</code> å’Œ <code>delete</code> ä¸ºä»€ä¹ˆè¦é…å¯¹ç”¨:</p>
<ul>
<li><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&#123;</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;;</span><br><span class="line">A *pa = <span class="keyword">new</span> A();</span><br><span class="line">A *pas = <span class="keyword">new</span> A[NUM]();</span><br></pre></td></tr></table></figure>
</li>
<li><p>delete []pas; //è¯¦ç»†æµç¨‹: delete[] pas ç”¨æ¥é‡Šæ”¾pasæŒ‡å‘çš„å†…å­˜ï¼ï¼è¿˜é€ä¸€è°ƒç”¨æ•°ç»„ä¸­æ¯ä¸ªå¯¹è±¡çš„destructorï¼ï¼</p>
</li>
<li>delete []pa; //ä¼šå‘ç”Ÿä»€ä¹ˆ, ç­”æ¡ˆæ˜¯è°ƒç”¨æœªçŸ¥æ¬¡æ•°çš„Açš„ææ„å‡½æ•°. å› ä¸ºdelete[]ä¼šå»é€šè¿‡pa+offsetæ‰¾ä¸€ä¸ªåŸºäºpaçš„åç§»é‡æ‰¾ä¸€ä¸ªå†…å­˜é‡Œçš„æ•°æ®, ä»–å‡å®šè¿™ä¸ªå†…å­˜é‡Œæ”¾äº†è¦è°ƒç”¨ææ„çš„æ¬¡æ•°nè¿™ä¸ªæ•°æ®, è€Œè¿™ä¸ªå†…å­˜é‡Œåˆ°åº•æ˜¯å¤šå°‘æ˜¯æœªçŸ¥çš„.</li>
<li>delete pas; //å“ªäº›æŒ‡é’ˆä¼šå˜æˆé‡æŒ‡é’ˆ, ç­”æ¡ˆæ˜¯paså’ŒA[0]ä¸­çš„æŒ‡é’ˆä¼šå˜æˆé‡æŒ‡é’ˆ. å› ä¸ºåªæœ‰è¿™ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜è¢«é‡Šæ”¾äº†, ä¹Ÿå°±æ˜¯è¯´, ä»…é‡Šæ”¾äº†pasæŒ‡é’ˆæŒ‡å‘çš„è¿™ä¸ªæ•°ç»„çš„å…¨éƒ¨å†…å­˜ç©ºé—´, ä»¥åŠåªè°ƒç”¨äº†a[0]å¯¹è±¡çš„ææ„å‡½æ•°</li>
</ul>
</li>
<li>cqq vec set map list<ul>
<li><a href="/stl_vector_string/" title="vectorå’Œstringçš„å†…å­˜åˆ†é…ä¸ä½¿ç”¨æ³¨æ„ç‚¹">vectorå’Œstringçš„å†…å­˜åˆ†é…ä¸ä½¿ç”¨æ³¨æ„ç‚¹</a></li>
<li><a href="/stll_set_map_tutorial/" title="stlå…³è”å®¹å™¨çš„ç‰¹æ€§">stlå…³è”å®¹å™¨çš„ç‰¹æ€§</a></li>
</ul>
</li>
<li>mapçš„<code>[]</code>å’Œinsertçš„åŒºåˆ«?<ul>
<li>insert å«ä¹‰æ˜¯ï¼šå¦‚æœkeyå­˜åœ¨ï¼Œåˆ™æ’å…¥å¤±è´¥ï¼Œå¦‚æœkeyä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºè¿™ä¸ªkeyï¼valueã€‚å®ä¾‹: <code>map.insert((key, value))</code></li>
<li>åˆ©ç”¨ä¸‹æ ‡æ“ä½œçš„å«ä¹‰æ˜¯ï¼šå¦‚æœè¿™ä¸ªkeyå­˜åœ¨ï¼Œå°±æ›´æ–°valueï¼›å¦‚æœkeyä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºè¿™ä¸ªkeyï¼valueå¯¹ å®ä¾‹ï¼š<code>map[key] = value</code></li>
</ul>
</li>
<li>vectorçš„resizeå’Œreserveçš„åŒºåˆ«?<ul>
<li>æ€»ç»“: <ul>
<li>resizeæ—¢åˆ†é…äº†ç©ºé—´ï¼Œä¹Ÿåˆ›å»ºäº†å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡ä¸‹æ ‡è®¿é—®ã€‚å½“new_sizeå¤§äºåŸsize, åˆ™resizeæ—¢ä¿®æ”¹capacityå¤§å°ï¼Œä¹Ÿä¿®æ”¹sizeå¤§å°ã€‚å¦åˆ™åªä¿®æ”¹sizeå¤§å°.</li>
<li>reserveåªåˆ†é…äº†ç©ºé—´, ä¹Ÿå°±æ˜¯è¯´å®ƒåªä¿®æ”¹capacityå¤§å°ï¼Œä¸ä¿®æ”¹sizeå¤§å°, è‹¥ new_cap å°äºç­‰äºå½“å‰çš„ capacity(), å®ƒå•¥ä¹Ÿä¸å¹².</li>
</ul>
</li>
<li>resize: é‡è®¾å®¹å™¨å¤§å°ä»¥å®¹çº³ count ä¸ªå…ƒç´ ã€‚<br>  è‹¥å½“å‰å¤§å°å¤§äº count ï¼Œåˆ™å‡å°å®¹å™¨ä¸ºå…¶é¦– count ä¸ªå…ƒç´ ã€‚<br>  è‹¥å½“å‰å¤§å°å°äº count:<ul>
<li>åˆ™åé™„é¢å¤–çš„é»˜è®¤æ’å…¥çš„å…ƒç´ </li>
<li>åˆ™åé™„é¢å¤–çš„ value çš„å‰¯æœ¬</li>
</ul>
</li>
<li>reserve: å¢åŠ  vector çš„å®¹é‡åˆ°å¤§äºæˆ–ç­‰äº new_cap çš„å€¼ã€‚è‹¥ new_cap å¤§äºå½“å‰çš„ capacity() ï¼Œåˆ™åˆ†é…æ–°å­˜å‚¨ï¼Œ<strong>å¦åˆ™è¯¥æ–¹æ³•ä¸åšä»»ä½•äº‹</strong>ã€‚reserve() ä¸æ›´æ”¹ vector çš„ size ã€‚è‹¥ new_cap å¤§äº capacity() ï¼Œåˆ™æ‰€æœ‰è¿­ä»£å™¨ï¼ŒåŒ…å«å°¾åè¿­ä»£å™¨å’Œæ‰€æœ‰åˆ°å…ƒç´ çš„å¼•ç”¨éƒ½è¢«éæ³•åŒ–ã€‚å¦åˆ™ï¼Œæ²¡æœ‰è¿­ä»£å™¨æˆ–å¼•ç”¨è¢«éæ³•åŒ–ã€‚</li>
</ul>
</li>
<li>å­—èŠ‚å¯¹é½<ul>
<li><a href="/sizeof_struct/" title="å¯¹è±¡æ¨¡å‹ä¹‹å†…å­˜å¯¹é½åŸºç¡€">å¯¹è±¡æ¨¡å‹ä¹‹å†…å­˜å¯¹é½åŸºç¡€</a></li>
</ul>
</li>
<li><p>å®šä½new </p>
<ul>
<li><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">512</span>];   <span class="comment">//chunk of memoryå†…å­˜æ± </span></span><br><span class="line">    <span class="keyword">int</span> *p2, *p3;</span><br><span class="line">    <span class="comment">//å®šä½new:</span></span><br><span class="line">    p2 = <span class="keyword">new</span> (buffer) <span class="keyword">int</span>[<span class="number">10</span>];</span><br><span class="line">    p2[<span class="number">0</span>] = <span class="number">99</span>;</span><br><span class="line">    p2[<span class="number">1</span>] = <span class="number">88</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"buffer = "</span> &lt;&lt;(<span class="keyword">void</span> *)buffer &lt;&lt; <span class="built_in">endl</span>; <span class="comment">//å†…å­˜æ± åœ°å€</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"p2 = "</span> &lt;&lt; p2 &lt;&lt; <span class="built_in">endl</span>;             <span class="comment">//å®šä½newæŒ‡å‘çš„åœ°å€</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"p2[0] = "</span> &lt;&lt; p2[<span class="number">0</span>] &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    p3 = <span class="keyword">new</span> (buffer) <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">    p3[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    p3[<span class="number">1</span>] = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"p3 = "</span> &lt;&lt; p3 &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"p2[0] = "</span> &lt;&lt; p2[<span class="number">0</span>] &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"p2[1] = "</span> &lt;&lt; p2[<span class="number">1</span>] &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"p2[2] = "</span> &lt;&lt; p2[<span class="number">2</span>] &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"p2[3] = "</span> &lt;&lt; p2[<span class="number">3</span>] &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»“æœå‘ç°p3å’Œp2è¿˜æœ‰bufferéƒ½æ˜¯ä½¿ç”¨åŒæ ·çš„å†…å­˜åœ°å€ï¼Œç¬¦åˆæŒ‡å®šåœ°å€çš„å†…å­˜å—ï¼Œè€Œä¸”p3åœ¨æŒ‡å®šä½ç½®è¦†ç›–äº†p2çš„å‰ä¸¤å¤„çš„å€¼ã€‚</p>
</li>
</ul>
</li>
<li>c++ä¸€ä¸ªç©ºç±»ä¼šç”Ÿæˆä»€ä¹ˆ (ç­”: é»˜è®¤æ„é€ /ææ„(éè™š)/èµ‹å€¼è¿ç®—ç¬¦/é»˜è®¤æ‹·è´/å–åœ°å€/constå–åœ°å€) </li>
<li><p>è™šå‡½æ•°ï¼ˆvirtualï¼‰å¯ä»¥æ˜¯å†…è”å‡½æ•°ï¼ˆinlineï¼‰å—ï¼Ÿ</p>
<ul>
<li>è™šå‡½æ•°å¯ä»¥æ˜¯å†…è”å‡½æ•°ï¼Œå†…è”æ˜¯å¯ä»¥ä¿®é¥°è™šå‡½æ•°çš„ï¼Œä½†æ˜¯å½“è™šå‡½æ•°è¡¨ç°å¤šæ€æ€§çš„æ—¶å€™ä¸èƒ½å†…è”ã€‚</li>
<li>å†…è”æ˜¯åœ¨ç¼–è¯‘å™¨å»ºè®®ç¼–è¯‘å™¨å†…è”ï¼Œè€Œè™šå‡½æ•°çš„å¤šæ€æ€§åœ¨è¿è¡ŒæœŸï¼Œç¼–è¯‘å™¨æ— æ³•çŸ¥é“è¿è¡ŒæœŸè°ƒç”¨å“ªä¸ªä»£ç ï¼Œå› æ­¤è™šå‡½æ•°è¡¨ç°ä¸ºå¤šæ€æ€§æ—¶ï¼ˆè¿è¡ŒæœŸï¼‰ä¸å¯ä»¥å†…è”ã€‚</li>
<li>inline virtual å”¯ä¸€å¯ä»¥å†…è”çš„æ—¶å€™æ˜¯ï¼šç¼–è¯‘å™¨çŸ¥é“æ‰€è°ƒç”¨çš„å¯¹è±¡æ˜¯å“ªä¸ªç±»ï¼ˆå¦‚ Base::who()ï¼‰ï¼Œè¿™åªæœ‰åœ¨ç¼–è¯‘å™¨å…·æœ‰å®é™…å¯¹è±¡è€Œä¸æ˜¯å¯¹è±¡çš„æŒ‡é’ˆæˆ–å¼•ç”¨æ—¶æ‰ä¼šå‘ç”Ÿã€‚<br>è™šå‡½æ•°å†…è”ä½¿ç”¨:<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ­¤å¤„çš„è™šå‡½æ•° who()ï¼Œæ˜¯é€šè¿‡ç±»ï¼ˆBaseï¼‰çš„å…·ä½“å¯¹è±¡ï¼ˆbï¼‰æ¥è°ƒç”¨çš„ï¼Œ</span></span><br><span class="line"><span class="comment">// ç¼–è¯‘æœŸé—´å°±èƒ½ç¡®å®šäº†ï¼Œæ‰€ä»¥å®ƒå¯ä»¥æ˜¯å†…è”çš„ï¼Œ</span></span><br><span class="line"><span class="comment">// ä½†æœ€ç»ˆæ˜¯å¦å†…è”å–å†³äºç¼–è¯‘å™¨ã€‚ </span></span><br><span class="line">Base b;</span><br><span class="line">b.who();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­¤å¤„çš„è™šå‡½æ•°æ˜¯é€šè¿‡æŒ‡é’ˆè°ƒç”¨çš„ï¼Œå‘ˆç°å¤šæ€æ€§ï¼Œ</span></span><br><span class="line"><span class="comment">// éœ€è¦åœ¨è¿è¡Œæ—¶æœŸé—´æ‰èƒ½ç¡®å®šï¼Œæ‰€ä»¥ä¸èƒ½ä¸ºå†…è”ã€‚  </span></span><br><span class="line">Base *ptr = <span class="keyword">new</span> Derived();</span><br><span class="line">ptr-&gt;who();</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>è™šå‡½æ•°æŒ‡é’ˆã€è™šå‡½æ•°è¡¨</p>
<ul>
<li>è™šå‡½æ•°æŒ‡é’ˆï¼šåœ¨å«æœ‰è™šå‡½æ•°ç±»çš„å¯¹è±¡ä¸­ï¼ŒæŒ‡å‘è™šå‡½æ•°è¡¨ï¼Œåœ¨è¿è¡Œæ—¶ç¡®å®šã€‚</li>
<li>è™šå‡½æ•°è¡¨ï¼šåœ¨ç¨‹åºå†…å­˜çš„<code>åªè¯»æ•°æ®æ®µ</code>ï¼ˆ.rodata sectionï¼Œè§ï¼š<a href="#CPPç›®æ ‡æ–‡ä»¶å†…å­˜å¸ƒå±€">CPPç›®æ ‡æ–‡ä»¶å†…å­˜å¸ƒå±€</a>ï¼‰ï¼Œå­˜æ”¾è™šå‡½æ•°æŒ‡é’ˆï¼Œå¦‚æœæ´¾ç”Ÿç±»å®ç°äº†åŸºç±»çš„æŸä¸ªè™šå‡½æ•°ï¼Œåˆ™åœ¨è™šè¡¨ä¸­è¦†ç›–åŸæœ¬åŸºç±»çš„é‚£ä¸ªè™šå‡½æ•°æŒ‡é’ˆï¼Œåœ¨ç¼–è¯‘æ—¶æ ¹æ®ç±»çš„å£°æ˜åˆ›å»ºã€‚</li>
<li>virtualä¿®é¥°ç¬¦:<br>  å¦‚æœä¸€ä¸ªç±»æ˜¯å±€éƒ¨å˜é‡åˆ™è¯¥ç±»æ•°æ®å­˜å‚¨åœ¨æ ˆåŒºï¼Œå¦‚æœä¸€ä¸ªç±»æ˜¯é€šè¿‡new/mallocåŠ¨æ€ç”³è¯·çš„ï¼Œåˆ™è¯¥ç±»æ•°æ®å­˜å‚¨åœ¨å †åŒºã€‚<br>  å¦‚æœè¯¥ç±»æ˜¯virutalç»§æ‰¿è€Œæ¥çš„å­ç±»ï¼Œåˆ™è¯¥ç±»çš„è™šå‡½æ•°è¡¨æŒ‡é’ˆå’Œè¯¥ç±»å…¶ä»–æˆå‘˜ä¸€èµ·å­˜å‚¨ã€‚è™šå‡½æ•°è¡¨æŒ‡é’ˆæŒ‡å‘åªè¯»æ•°æ®æ®µä¸­çš„ç±»è™šå‡½æ•°è¡¨ï¼Œè™šå‡½æ•°è¡¨ä¸­å­˜æ”¾ç€ä¸€ä¸ªä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå‡½æ•°æŒ‡é’ˆæŒ‡å‘ä»£ç æ®µä¸­çš„å…·ä½“å‡½æ•°ã€‚</li>
<li><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/cpp/virtual_func_1.jpg" alt></li>
</ul>
</li>
<li><p>å†…å­˜æ³„æ¼çš„å·¥å…· vargrid..? è¿˜æœ‰å•¥å·¥å…·</p>
</li>
<li>äº†è§£ASANæŸ¥æ‰¾å†…å­˜è¶Šç•Œé—®é¢˜ </li>
<li>cppæ‰¾æ‰¾å†°å·, å¤§æ¢¦é¾™å›¾çš„é¢è¯•é¢˜ï¼Œç½‘ä¸Šå¸¸ç”¨é¢˜</li>
<li>gdbæ€ä¹ˆåˆ‡æ¢çº¿ç¨‹</li>
<li>C++ çš„åŠ¨æ€å¤šæ€æ€ä¹ˆå®ç°çš„ï¼Ÿ</li>
<li>C++ çš„æ„é€ å‡½æ•°å¯ä»¥æ˜¯è™šå‡½æ•°å—ï¼Ÿ</li>
<li>æ— é”é˜Ÿåˆ—åŸç†æ˜¯å¦ä¸€å®šæ¯”æœ‰é”å¿«?(ä¸ä¸€å®š, å¦‚æœä¸´ç•ŒåŒºå°å› ä¸ºæœ‰ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ™mutexæ…¢, å†æ¥çœ‹lockfreeçš„spinï¼Œä¸€èˆ¬éƒ½éµå¾ªä¸€ä¸ªå›ºå®šçš„æ ¼å¼ï¼šå…ˆæŠŠä¸€ä¸ªä¸å˜çš„å€¼Xå­˜åˆ°æŸä¸ªå±€éƒ¨å˜é‡Aé‡Œï¼Œç„¶ååšä¸€äº›è®¡ç®—ï¼Œè®¡ç®—/ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œç„¶ååšä¸€ä¸ªCASæ“ä½œï¼Œåˆ¤æ–­Aå’ŒXè¿˜æ˜¯ä¸æ˜¯ç›¸ç­‰çš„ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆè¿™æ¬¡CASå°±ç®—æˆåŠŸäº†ï¼Œå¦åˆ™å†æ¥ä¸€éã€‚å¦‚æœä¸Šé¢è¿™ä¸ªloopé‡Œé¢â€œè®¡ç®—/ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡â€éå¸¸è€—æ—¶å¹¶ä¸”contentionå¾ˆä¸¥é‡ï¼Œé‚£ä¹ˆlockfreeæ€§èƒ½æœ‰æ—¶ä¼šæ¯”mutexå·®ã€‚å¦å¤–lockfreeä¸æ–­åœ°spinå¼•èµ·çš„CPUåŒæ­¥cachelineçš„å¼€é”€ä¹Ÿæ¯”mutexç‰ˆæœ¬çš„å¤§ã€‚å…³äºABAé—®é¢˜)</li>
</ul>
<h2 id="gcc-å‘½ä»¤çš„å¸¸ç”¨é€‰é¡¹"><a href="#gcc-å‘½ä»¤çš„å¸¸ç”¨é€‰é¡¹" class="headerlink" title="gcc å‘½ä»¤çš„å¸¸ç”¨é€‰é¡¹"></a>gcc å‘½ä»¤çš„å¸¸ç”¨é€‰é¡¹</h2><table><tbody><tr><th>é€‰é¡¹</th><th>è§£é‡Š</th></tr><tr><td>-ansi</td><td>åªæ”¯æŒ ANSI æ ‡å‡†çš„ C è¯­æ³•ã€‚è¿™ä¸€é€‰é¡¹å°†ç¦æ­¢ GNU C çš„æŸäº›ç‰¹è‰²ï¼Œ ä¾‹å¦‚ asm æˆ– typeof å…³é”®è¯ã€‚</td></tr><tr><td>-c</td><td>åªç¼–è¯‘å¹¶ç”Ÿæˆç›®æ ‡æ–‡ä»¶ã€‚</td></tr><tr><td>-DMACRO</td><td>ä»¥å­—ç¬¦ä¸² â€œ1â€ å®šä¹‰ MACRO å®ã€‚</td></tr><tr><td>-DMACRO=DEFN</td><td>ä»¥å­—ç¬¦ä¸² â€œDEFNâ€ å®šä¹‰ MACRO å®ã€‚</td></tr><tr><td>-E</td><td>åªè¿è¡Œ C é¢„ç¼–è¯‘å™¨ã€‚</td></tr><tr><td>-g</td><td>ç”Ÿæˆè°ƒè¯•ä¿¡æ¯ã€‚GNU è°ƒè¯•å™¨å¯åˆ©ç”¨è¯¥ä¿¡æ¯ã€‚</td></tr><tr><td>-IDIRECTORY</td><td>æŒ‡å®šé¢å¤–çš„å¤´æ–‡ä»¶æœç´¢è·¯å¾„ DIRECTORYã€‚</td></tr><tr><td>-LDIRECTORY</td><td>æŒ‡å®šé¢å¤–çš„å‡½æ•°åº“æœç´¢è·¯å¾„ DIRECTORYã€‚</td></tr><tr><td>-lLIBRARY</td><td>è¿æ¥æ—¶æœç´¢æŒ‡å®šçš„å‡½æ•°åº“ LIBRARYã€‚</td></tr><tr><td>-m486</td><td>é’ˆå¯¹ 486 è¿›è¡Œä»£ç ä¼˜åŒ–ã€‚</td></tr><tr><td>-o FILE</td><td>ç”ŸæˆæŒ‡å®šçš„è¾“å‡ºæ–‡ä»¶ã€‚ç”¨åœ¨ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶ã€‚</td></tr><tr><td>-O0</td><td>ä¸è¿›è¡Œä¼˜åŒ–å¤„ç†ã€‚</td></tr><tr><td>-O æˆ– -O1</td><td>ä¼˜åŒ–ç”Ÿæˆä»£ç ã€‚</td></tr><tr><td>-O2</td><td>è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚</td></tr><tr><td>-O3</td><td>æ¯” -O2 æ›´è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ŒåŒ…æ‹¬ inline å‡½æ•°ã€‚</td></tr><tr><td>-shared</td><td>ç”Ÿæˆå…±äº«ç›®æ ‡æ–‡ä»¶ã€‚é€šå¸¸ç”¨åœ¨å»ºç«‹å…±äº«åº“æ—¶ã€‚</td></tr><tr><td>-static</td><td>ç¦æ­¢ä½¿ç”¨å…±äº«è¿æ¥ã€‚</td></tr><tr><td>-UMACRO</td><td>å–æ¶ˆå¯¹ MACRO å®çš„å®šä¹‰ã€‚</td></tr><tr><td>-w</td><td>ä¸ç”Ÿæˆä»»ä½•è­¦å‘Šä¿¡æ¯ã€‚</td></tr><tr><td>-Wall</td><td>ç”Ÿæˆæ‰€æœ‰è­¦å‘Šä¿¡æ¯ã€‚</td></tr></tbody></table>


<h2 id="ä½¿ç”¨gcoreæˆ–straceå’ŒpstackæŸ¥è¯¢çº¿ä¸ŠCPUçš„100-é—®é¢˜"><a href="#ä½¿ç”¨gcoreæˆ–straceå’ŒpstackæŸ¥è¯¢çº¿ä¸ŠCPUçš„100-é—®é¢˜" class="headerlink" title="ä½¿ç”¨gcoreæˆ–straceå’ŒpstackæŸ¥è¯¢çº¿ä¸ŠCPUçš„100%é—®é¢˜"></a>ä½¿ç”¨gcoreæˆ–straceå’ŒpstackæŸ¥è¯¢çº¿ä¸ŠCPUçš„100%é—®é¢˜</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># top -bn1p 6325</span><br><span class="line">Tasks: 608 total,   9 running, 596 sleeping,   0 stopped,   3 zombie</span><br><span class="line">%Cpu(s): 20.5 us,  6.3 sy,  0.0 ni, 72.3 id,  0.5 wa,  0.0 hi,  0.5 si,  0.0 st</span><br><span class="line">KiB Mem:  65983744 total, 65372892 used,   610852 free,   574684 buffers</span><br><span class="line">KiB Swap:  4194300 total,        0 used,  4194300 free. 42109148 cached Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line"> 6325 cc        20   0 4840544 628972  69656 R 100.0  1.0 927:41.47 python2.7</span><br></pre></td></tr></table></figure>
<h3 id="å…ˆç”¨straceæŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨"><a href="#å…ˆç”¨straceæŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="å…ˆç”¨straceæŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨"></a>å…ˆç”¨straceæŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">strace -p 6325</span><br></pre></td></tr></table></figure>
<p>ç»“æœä¸€ç›´å¡ä½ï¼Œæ— ä»»ä½•è¾“å‡ºï¼Œè¯´æ˜è¿›ç¨‹æ²¡æœ‰è¿›è¡Œä»»ä½•ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<h3 id="ç”¨pstackæŸ¥çœ‹å½“å‰è°ƒç”¨å †æ ˆ"><a href="#ç”¨pstackæŸ¥çœ‹å½“å‰è°ƒç”¨å †æ ˆ" class="headerlink" title="ç”¨pstackæŸ¥çœ‹å½“å‰è°ƒç”¨å †æ ˆ"></a>ç”¨pstackæŸ¥çœ‹å½“å‰è°ƒç”¨å †æ ˆ</h3><p>å¯¹ä¸€ä¸ªæœåŠ¡ (room_status_server) è¿›è¡Œäº†ä¸€äº›ä¼˜åŒ–ï¼Œå¹¶é¡ºä¾¿ä¿®æ”¹äº†éƒ¨åˆ†é…ç½®æ–‡ä»¶ï¼Œé‡å¯åç”¨<code>topå‘½ä»¤</code>è§‚å¯Ÿï¼Œå‘ç°è¯¥ç¨‹åº<code>cpuå‡ ä¹å åˆ°äº†100%</code>ã€‚  </p>
<p>å‘ç°è¿™ä¸ªé—®é¢˜åï¼Œæƒ³åˆ°å‰ä¸¤å¤©è¿˜ä¸Šçº¿äº†è¯¥æœåŠ¡ï¼Œç«‹é©¬å»çº¿ä¸Šçœ‹äº†çœ‹ï¼Œè¿˜å¥½çº¿ä¸Šæ˜¯æ­£å¸¸çš„ã€‚é‚£ä¹ˆé—®é¢˜è‚¯å®šæ˜¯åˆšæ‰çš„ä¿®æ”¹å¯¼è‡´çš„ï¼<br>æŠŠçº¿ä¸Šçš„ç‰ˆæœ¬æ‹¿è¿‡æ¥è¿è¡Œï¼Œè¿˜æ˜¯<code>cpuå‡ ä¹å åˆ°äº†100%</code>ï¼Œé‚£å¾ˆå¤§å¯èƒ½æ˜¯é…ç½®æ–‡ä»¶å“ªé‡Œæ”¹é”™äº†ï¼ˆåé¢éªŒè¯è¡¨æ˜æˆ‘çš„çŒœæµ‹æ˜¯å¯¹çš„ï¼‰ã€‚</p>
<p>æƒ³åˆ°è¿™æ˜¯ä¸€ä¸ªå¥½çš„å­¦ä¹ çš„æœºä¼šï¼Œæˆ‘æƒ³è¿˜æ˜¯ä»è¿è¡Œçš„ç¨‹åºæ¥çœ‹çœ‹åˆ°åº•å‡ºäº†ä»€ä¹ˆäº‹ã€‚</p>
<p>æ€è·¯ï¼š</p>
<ol>
<li>ç¨‹åºå ç”¨ 100% çš„ cpuï¼Œç¨‹åºå³è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´è¿›ç¨‹å äº† 100% çš„ cpuï¼ˆä¸€ä¸ªæ ¸ï¼‰</li>
<li>ä¸€ä¸ªè¿›ç¨‹æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œç©¶ç«Ÿæ˜¯å“ªä¸€ä¸ªçº¿ç¨‹å äº† 100% çš„ cpuï¼Ÿ</li>
<li>è¿™ä¸ªçº¿ç¨‹åœ¨å¹²ä»€ä¹ˆï¼Ÿ</li>
</ol>
<h4 id="æŸ¥çœ‹ç¨‹åºçš„è¿›ç¨‹å·"><a href="#æŸ¥çœ‹ç¨‹åºçš„è¿›ç¨‹å·" class="headerlink" title="æŸ¥çœ‹ç¨‹åºçš„è¿›ç¨‹å·"></a>æŸ¥çœ‹ç¨‹åºçš„è¿›ç¨‹å·</h4><p>å‘½ä»¤ï¼š<code>top -c</code>ã€‚ è¾“å…¥<code>å¤§å†™P</code>ï¼Œtop çš„è¾“å‡ºä¼šæŒ‰ä½¿ç”¨ cpu å¤šå°‘æ’åºã€‚  </p>
<p><code>PID</code>å°±æ˜¯è¿›ç¨‹å·ï¼Œæˆ‘ç¨‹åºçš„è¿›ç¨‹å·æ˜¯<code>4918</code>ã€‚</p>
<h4 id="æŸ¥çœ‹è€—-CPU-çš„çº¿ç¨‹å·"><a href="#æŸ¥çœ‹è€—-CPU-çš„çº¿ç¨‹å·" class="headerlink" title="æŸ¥çœ‹è€— CPU çš„çº¿ç¨‹å·"></a>æŸ¥çœ‹è€— CPU çš„çº¿ç¨‹å·</h4><p>å‘½ä»¤ï¼š<code>top -Hp è¿›ç¨‹å·</code>ã€‚ åŒæ ·è¾“å…¥<code>å¤§å†™P</code>ï¼Œtop çš„è¾“å‡ºä¼šæŒ‰ä½¿ç”¨ cpu å¤šå°‘æ’åºã€‚</p>
<p>è¾“å…¥<code>top -Hp 4918</code>ï¼Œå±•ç¤ºå†…å®¹å¦‚å›¾ï¼š<br>å¯ä»¥çœ‹å‡º PID æ˜¯<code>4927</code>çš„çº¿ç¨‹å åˆ°äº† 100% çš„ cpuï¼Œæˆ‘çš„ä¸šåŠ¡æ—¥å¿—æ˜¯æ‰“å°çº¿ç¨‹å·çš„ï¼Œæ‰“å¼€æ—¥å¿—ï¼Œå“¦~~ åŸæ¥æ˜¯è¿™ä¸ªåŸå› ï¼ˆå…ˆå–ä¸ªå…³å­ä¸è¯´ï¼‰ã€‚</p>
<h4 id="æŸ¥çœ‹è€—-CPU-çš„ä»»åŠ¡"><a href="#æŸ¥çœ‹è€—-CPU-çš„ä»»åŠ¡" class="headerlink" title="æŸ¥çœ‹è€— CPU çš„ä»»åŠ¡"></a>æŸ¥çœ‹è€— CPU çš„ä»»åŠ¡</h4><p>ä¸Šé¢æ‰¾åˆ°äº†è€— CPU çš„çº¿ç¨‹ï¼Œé‚£è¿™ä¸ªçº¿ç¨‹åœ¨åšä»€ä¹ˆå‘¢ï¼Ÿ<br>çœ‹çº¿ç¨‹åœ¨å¹²ä»€ä¹ˆï¼Œå¯ä»¥çœ‹çº¿ç¨‹çš„å †æ ˆï¼Œå‘½ä»¤æ˜¯<code>pstack è¿›ç¨‹å·</code>ï¼Œä¼šè¾“å‡ºæ‰€æœ‰çº¿ç¨‹çš„å †æ ˆä¿¡æ¯ã€‚</p>
<p>è¾“å…¥<code>pstack 4918</code>ï¼Œå¹¶æœç´¢<code>çº¿ç¨‹4927</code>çš„å †æ ˆï¼Œå±•ç¤ºå†…å®¹å¦‚å›¾ï¼š<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/g90/pstack_info.png" alt></p>
<p>ä»å †æ ˆä¿¡æ¯çœ‹ï¼Œç¨‹åºåœ¨æ‰§è¡Œ boost åˆ›å»º socket ç›‘å¬ç­‰ä»»åŠ¡ï¼Œä¸ºä»€ä¹ˆä¸€ç›´æ‰§è¡Œè¿™ä¸ªå‘¢ï¼Ÿå› ä¸ºï¼Œæˆ‘çš„ç«¯å£å·é‡å¤ä½¿ç”¨äº†ã€‚</p>
<p>å…¶å®ä»å †æ ˆä¿¡æ¯å®šä½é—®é¢˜è¿˜æ˜¯æœ‰äº›æŠ½è±¡çš„ï¼Œä½†æ˜¯å¤§æ¦‚å¯ä»¥çœ‹å‡ºçº¿ç¨‹åœ¨åšä»€ä¹ˆï¼Œè‡³å°‘ç»™æ’æŸ¥é—®é¢˜æŒ‡æ˜äº†æ–¹å‘ã€‚</p>
<h3 id="ä½¿ç”¨gcoreæ¥å¤„ç†"><a href="#ä½¿ç”¨gcoreæ¥å¤„ç†" class="headerlink" title="ä½¿ç”¨gcoreæ¥å¤„ç†"></a>ä½¿ç”¨gcoreæ¥å¤„ç†</h3><p><a href="#gcoreç”Ÿæˆcoredumpæ–‡ä»¶"></a></p>
<p>å¤§è‡´æµç¨‹æ€»ç»“:  </p>
<ol>
<li>ä¸ºäº†é¿å…gdb attachå¯¹çº¿ä¸Šè¿›ç¨‹é€ æˆå½±æˆ,</li>
<li>å…ˆä½¿ç”¨gcoreç”Ÿæˆcoredumpæ–‡ä»¶, </li>
<li>ç„¶åå†ä½¿ç”¨gdbåˆ†æcoredumpæ–‡ä»¶, </li>
<li>ç„¶ååœ¨gdbå†…<code>info thread</code>æŸ¥çœ‹çº¿ç¨‹çŠ¶æ€</li>
<li>ç„¶å<code>thread çº¿ç¨‹å·</code>åˆ‡æ¢çº¿ç¨‹, </li>
<li>ç„¶å<code>bt</code>æŸ¥è°ƒç”¨å †æ ˆå¯ä»¥æŸ¥åˆ°äº†</li>
</ol>
<h2 id="ç”¨ASANå¤„ç†å†…å­˜æ³„æ¼ä¸è¶Šç•Œç­‰é—®é¢˜"><a href="#ç”¨ASANå¤„ç†å†…å­˜æ³„æ¼ä¸è¶Šç•Œç­‰é—®é¢˜" class="headerlink" title="ç”¨ASANå¤„ç†å†…å­˜æ³„æ¼ä¸è¶Šç•Œç­‰é—®é¢˜"></a>ç”¨ASANå¤„ç†å†…å­˜æ³„æ¼ä¸è¶Šç•Œç­‰é—®é¢˜</h2><p>ç”¨<code>-fsanitize=address</code>é€‰é¡¹ç¼–è¯‘å’Œé“¾æ¥ä½ çš„ç¨‹åº;<br>ç”¨<code>-fno-omit-frame-pointer</code>ç¼–è¯‘ï¼Œä»¥åœ¨é”™è¯¯æ¶ˆæ¯ä¸­æ·»åŠ æ›´å¥½çš„å †æ ˆè·Ÿè¸ªã€‚<br>å¢åŠ <code>-O1</code>ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚<br>ä¸‹é¢ä»¥ç®€å•çš„æµ‹è¯•ä»£ç leaktest.cä¸ºä¾‹<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// leaktest.c</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">leaktest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *x = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">10</span> * <span class="keyword">sizeof</span>(<span class="keyword">char</span>*));</span><br><span class="line">    <span class="keyword">return</span> x[<span class="number">5</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    leaktest();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨ç»ˆç«¯ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤ç¼–è¯‘leaktest.c<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gcc -fsanitize=address -fno-omit-frame-pointer -O1 -g leaktest.c -o leaktest</span><br></pre></td></tr></table></figure></p>
<p>è¿è¡Œleaktestï¼Œä¼šæ‰“å°ä¸‹é¢çš„é”™è¯¯ä¿¡æ¯ï¼š</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/cpp/asan_intro.jpg" alt></p>
<p>ç¬¬ä¸€éƒ¨åˆ†ï¼ˆERRORï¼‰ï¼ŒæŒ‡å‡ºé”™è¯¯ç±»å‹detected memory leaksï¼›<br>ç¬¬äºŒéƒ¨åˆ†ç»™å‡ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼šDirect leak of 80 byte(s) in 1 object(s)ï¼Œä»¥åŠå‘ç”Ÿé”™è¯¯çš„å¯¹è±¡å/æºæ–‡ä»¶ä½ç½®/è¡Œæ•°ï¼›<br>ç¬¬ä¸‰éƒ¨åˆ†æ˜¯ä»¥ä¸Šä¿¡æ¯çš„ä¸€ä¸ªæ€»ç»“ï¼ˆSUMMARYï¼‰ã€‚</p>
<h2 id="å·¦å€¼å³å€¼é€šç”¨å¼•ç”¨"><a href="#å·¦å€¼å³å€¼é€šç”¨å¼•ç”¨" class="headerlink" title="å·¦å€¼å³å€¼é€šç”¨å¼•ç”¨"></a>å·¦å€¼å³å€¼é€šç”¨å¼•ç”¨</h2><ul>
<li>å·¦å€¼æŒä¹…<ul>
<li>å˜é‡æ˜¯å·¦å€¼, å› ä¸ºå˜é‡æ˜¯æŒä¹…çš„ ç›´è‡³ç¦»å¼€ä½œç”¨åŸŸæ—¶æ‰è¢«é”€æ¯ã€‚</li>
<li>å‡¡æ˜¯å–åœ°å€ï¼ˆ&amp;ï¼‰æ“ä½œå¯ä»¥æˆåŠŸçš„éƒ½æ˜¯å·¦å€¼ï¼Œå…¶ä½™éƒ½æ˜¯å³å€¼</li>
</ul>
</li>
<li>å³å€¼çŸ­æš‚, å³å€¼è¦ä¹ˆæ˜¯å­—é¢å¸¸é‡ï¼Œè¦ä¹ˆæ˜¯åœ¨è¡¨è¾¾å¼æ±‚å€¼è¿‡ç¨‹ä¸­åˆ›å»ºçš„ä¸´æ—¶å¯¹è±¡<ul>
<li>æ‰€å¼•ç”¨çš„å¯¹è±¡å°†è¦è¢«é”€æ¯</li>
<li>è¯¥å¯¹è±¡æ²¡æœ‰å…¶ä»–ç”¨æˆ·</li>
<li>ä½¿ç”¨å³å€¼å¼•ç”¨çš„ä»£ç å¯ä»¥è‡ªç”±åœ°æ¥ç®¡æ‰€å¼•ç”¨çš„å¯¹è±¡çš„èµ„æº</li>
</ul>
</li>
<li><code>std::move</code> å¯ä»¥æ˜¾å¼åœ°å°†ä¸€ä¸ªå·¦å€¼è½¬æ¢ä¸ºå¯¹åº”çš„å³å€¼å¼•ç”¨ç±»å‹</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å½¢å‚æ˜¯ä¸ªå³å€¼å¼•ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span>&amp;&amp; right_value)</span> </span>&#123;</span><br><span class="line">    right_value = <span class="number">8</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">5</span>; <span class="comment">// aæ˜¯ä¸ªå·¦å€¼</span></span><br><span class="line">    <span class="keyword">int</span> &amp;ref_a_left = a; <span class="comment">// ref_a_leftæ˜¯ä¸ªå·¦å€¼å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">int</span> &amp;&amp;ref_a_right = <span class="built_in">std</span>::move(a); <span class="comment">// ref_a_rightæ˜¯ä¸ªå³å€¼å¼•ç”¨</span></span><br><span class="line"> </span><br><span class="line">    change(a); <span class="comment">// ç¼–è¯‘ä¸è¿‡ï¼Œaæ˜¯å·¦å€¼ï¼Œchangeå‚æ•°è¦æ±‚å³å€¼</span></span><br><span class="line">    change(ref_a_left); <span class="comment">// ç¼–è¯‘ä¸è¿‡ï¼Œå·¦å€¼å¼•ç”¨ref_a_leftæœ¬èº«ä¹Ÿæ˜¯ä¸ªå·¦å€¼</span></span><br><span class="line">    change(ref_a_right); <span class="comment">// ç¼–è¯‘ä¸è¿‡ï¼Œå³å€¼å¼•ç”¨ref_a_rightæœ¬èº«ä¹Ÿæ˜¯ä¸ªå·¦å€¼</span></span><br><span class="line">     </span><br><span class="line">    change(<span class="built_in">std</span>::move(a)); <span class="comment">// ç¼–è¯‘é€šè¿‡</span></span><br><span class="line">    change(<span class="built_in">std</span>::move(ref_a_right)); <span class="comment">// ç¼–è¯‘é€šè¿‡</span></span><br><span class="line">    change(<span class="built_in">std</span>::move(ref_a_left)); <span class="comment">// ç¼–è¯‘é€šè¿‡</span></span><br><span class="line"> </span><br><span class="line">    change(<span class="number">5</span>); <span class="comment">// å½“ç„¶å¯ä»¥ç›´æ¥æ¥å³å€¼ï¼Œç¼–è¯‘é€šè¿‡</span></span><br><span class="line">     </span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; &amp;a &lt;&lt; <span class="string">' '</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; &amp;ref_a_left &lt;&lt; <span class="string">' '</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; &amp;ref_a_right;</span><br><span class="line">    <span class="comment">// æ‰“å°è¿™ä¸‰ä¸ªå·¦å€¼çš„åœ°å€ï¼Œéƒ½æ˜¯ä¸€æ ·çš„</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="std-moveåº”ç”¨åœºæ™¯"><a href="#std-moveåº”ç”¨åœºæ™¯" class="headerlink" title="std::moveåº”ç”¨åœºæ™¯"></a>std::moveåº”ç”¨åœºæ™¯</h3><p>æŒ‰ä¸Šæ–‡åˆ†æï¼Œstd::moveåªæ˜¯ç±»å‹è½¬æ¢å·¥å…·ï¼Œä¸ä¼šå¯¹æ€§èƒ½æœ‰å¥½å¤„ï¼›å³å€¼å¼•ç”¨åœ¨ä½œä¸ºå‡½æ•°å½¢å‚æ—¶æ›´å…·çµæ´»æ€§ï¼Œçœ‹ä¸Šå»è¿˜æ˜¯æŒºé¸¡è‚‹çš„ã€‚ä»–ä»¬æœ‰ä»€ä¹ˆå®é™…åº”ç”¨åœºæ™¯å—ï¼Ÿ</p>
<p>åœ¨å®é™…åœºæ™¯ä¸­ï¼Œå³å€¼å¼•ç”¨å’Œstd::moveè¢«å¹¿æ³›ç”¨äºåœ¨STLå’Œè‡ªå®šä¹‰ç±»ä¸­å®ç°ç§»åŠ¨è¯­ä¹‰ï¼Œé¿å…æ‹·è´ï¼Œä»è€Œæå‡ç¨‹åºæ€§èƒ½ã€‚<br>è¯¥ç±»çš„æ‹·è´æ„é€ å‡½æ•°ã€èµ‹å€¼è¿ç®—ç¬¦é‡è½½å‡½æ•°å·²ç»é€šè¿‡ä½¿ç”¨å·¦å€¼å¼•ç”¨ä¼ å‚æ¥é¿å…ä¸€æ¬¡å¤šä½™æ‹·è´äº†ï¼Œä½†æ˜¯å†…éƒ¨å®ç°è¦æ·±æ‹·è´ï¼Œæ— æ³•é¿å…ã€‚</p>
<p>è¿™æ—¶ï¼Œæœ‰äººæå‡ºä¸€ä¸ªæƒ³æ³•ï¼šæ˜¯ä¸æ˜¯å¯ä»¥æä¾›ä¸€ä¸ªç§»åŠ¨æ„é€ å‡½æ•°ï¼ŒæŠŠè¢«æ‹·è´è€…çš„æ•°æ®ç§»åŠ¨è¿‡æ¥ï¼Œè¢«æ‹·è´è€…åè¾¹å°±ä¸è¦äº†ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…æ·±æ‹·è´äº†ï¼Œå¦‚ï¼š<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Array</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œå¯ä»¥æµ…æ‹·è´</span></span><br><span class="line">    Array(<span class="keyword">const</span> Array&amp; temp_array, <span class="keyword">bool</span> move) &#123;</span><br><span class="line">        data_ = temp_array.data_;</span><br><span class="line">        size_ = temp_array.size_;</span><br><span class="line">        <span class="comment">// ä¸ºé˜²æ­¢temp_arrayææ„æ—¶delete dataï¼Œæå‰ç½®ç©ºå…¶data_      </span></span><br><span class="line">        temp_array.data_ = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¹ˆåšæœ‰2ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>ä¸ä¼˜é›…ï¼Œè¡¨ç¤ºç§»åŠ¨è¯­ä¹‰è¿˜éœ€è¦ä¸€ä¸ªé¢å¤–çš„å‚æ•°(æˆ–è€…å…¶ä»–æ–¹å¼)ã€‚</li>
<li>æ— æ³•å®ç°ï¼temp_arrayæ˜¯ä¸ªconstå·¦å€¼å¼•ç”¨ï¼Œæ— æ³•è¢«ä¿®æ”¹ï¼Œæ‰€ä»¥temp<em>array.data</em> = nullptr;è¿™è¡Œä¼šç¼–è¯‘ä¸è¿‡ã€‚å½“ç„¶å‡½æ•°å‚æ•°å¯ä»¥æ”¹æˆéconstï¼šArray(Array&amp; temp_array, bool move){â€¦}ï¼Œè¿™æ ·ä¹Ÿæœ‰é—®é¢˜ï¼Œç”±äºå·¦å€¼å¼•ç”¨ä¸èƒ½æ¥å³å€¼ï¼ŒArray a = Array(Array(), true);è¿™ç§è°ƒç”¨æ–¹å¼å°±æ²¡æ³•ç”¨äº†ã€‚</li>
</ul>
<p>å¯ä»¥å‘ç°å·¦å€¼å¼•ç”¨çœŸæ˜¯ç”¨çš„å¾ˆä¸çˆ½ï¼Œå³å€¼å¼•ç”¨çš„å‡ºç°è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œåœ¨STLçš„å¾ˆå¤šå®¹å™¨ä¸­ï¼Œéƒ½å®ç°äº†ä»¥å³å€¼å¼•ç”¨ä¸ºå‚æ•°çš„ç§»åŠ¨æ„é€ å‡½æ•°å’Œç§»åŠ¨èµ‹å€¼é‡è½½å‡½æ•°ï¼Œæˆ–è€…å…¶ä»–å‡½æ•°ï¼Œæœ€å¸¸è§çš„å¦‚std::vectorçš„push_backå’Œemplace_backã€‚å‚æ•°ä¸ºå·¦å€¼å¼•ç”¨æ„å‘³ç€æ‹·è´ï¼Œä¸ºå³å€¼å¼•ç”¨æ„å‘³ç€ç§»åŠ¨ã€‚<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Array</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ä¼˜é›…</span></span><br><span class="line">    Array(Array&amp;&amp; temp_array) &#123;</span><br><span class="line">        data_ = temp_array.data_;</span><br><span class="line">        size_ = temp_array.size_;</span><br><span class="line">        <span class="comment">// ä¸ºé˜²æ­¢temp_arrayææ„æ—¶delete dataï¼Œæå‰ç½®ç©ºå…¶data_      </span></span><br><span class="line">        temp_array.data_ = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Array a;</span><br><span class="line">    <span class="comment">// å·¦å€¼aï¼Œç”¨std::moveè½¬åŒ–ä¸ºå³å€¼</span></span><br><span class="line">    Array b(std::move(a));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="é€šç”¨å¼•ç”¨"><a href="#é€šç”¨å¼•ç”¨" class="headerlink" title="é€šç”¨å¼•ç”¨"></a>é€šç”¨å¼•ç”¨</h3><p><strong>æ³¨æ„</strong>ï¼šåªæœ‰å½“å‘ç”Ÿè‡ªåŠ¨ç±»å‹æ¨æ–­æ—¶ï¼ˆå¦‚å‡½æ•°æ¨¡æ¿çš„ç±»å‹è‡ªåŠ¨æ¨å¯¼ï¼Œæˆ–autoå…³é”®å­—ï¼‰ï¼Œ&amp;&amp;æ‰æ˜¯ä¸€ä¸ªuniversal referencesã€‚</p>
<p>å½“å³å€¼å¼•ç”¨å’Œæ¨¡æ¿ç»“åˆçš„æ—¶å€™ï¼Œå°±å¤æ‚äº†ã€‚T&amp;&amp;å¹¶ä¸ä¸€å®šè¡¨ç¤ºå³å€¼å¼•ç”¨ï¼Œå®ƒå¯èƒ½æ˜¯ä¸ªå·¦å€¼å¼•ç”¨åˆå¯èƒ½æ˜¯ä¸ªå³å€¼å¼•ç”¨ã€‚ä¾‹å¦‚ï¼š<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">( T&amp;&amp; param)</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">f(<span class="number">10</span>);  <span class="comment">//10æ˜¯å³å€¼</span></span><br><span class="line"><span class="keyword">int</span> x = <span class="number">10</span>; <span class="comment">//</span></span><br><span class="line">f(x); <span class="comment">//xæ˜¯å·¦å€¼</span></span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœä¸Šé¢çš„å‡½æ•°æ¨¡æ¿è¡¨ç¤ºçš„æ˜¯å³å€¼å¼•ç”¨çš„è¯ï¼Œè‚¯å®šæ˜¯ä¸èƒ½ä¼ é€’å·¦å€¼çš„ï¼Œä½†æ˜¯äº‹å®å´æ˜¯å¯ä»¥ã€‚è¿™é‡Œçš„&amp;&amp;æ˜¯ä¸€ä¸ªæœªå®šä¹‰çš„å¼•ç”¨ç±»å‹ï¼Œç§°ä¸ºuniversal referencesï¼Œå®ƒå¿…é¡»è¢«åˆå§‹åŒ–ï¼Œå®ƒæ˜¯å·¦å€¼å¼•ç”¨è¿˜æ˜¯å³å€¼å¼•ç”¨å´å†³äºå®ƒçš„åˆå§‹åŒ–ï¼Œå¦‚æœå®ƒè¢«ä¸€ä¸ªå·¦å€¼åˆå§‹åŒ–ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªå·¦å€¼å¼•ç”¨ï¼›å¦‚æœè¢«ä¸€ä¸ªå³å€¼åˆå§‹åŒ–ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªå³å€¼å¼•ç”¨ã€‚</p>
<h3 id="std-forward"><a href="#std-forward" class="headerlink" title="std::forward"></a>std::forward</h3><p>å’Œstd::moveä¸€æ ·ï¼Œå®ƒçš„å…„å¼Ÿstd::forwardä¹Ÿå……æ»¡äº†è¿·æƒ‘æ€§ï¼Œè™½ç„¶åå­—å«ä¹‰æ˜¯è½¬å‘ï¼Œä½†ä»–å¹¶ä¸ä¼šåšè½¬å‘ï¼ŒåŒæ ·ä¹Ÿæ˜¯åšç±»å‹è½¬æ¢.</p>
<p>ä¸moveç›¸æ¯”ï¼Œforwardæ›´å¼ºå¤§ï¼Œmoveåªèƒ½è½¬å‡ºæ¥å³å€¼ï¼Œforwardéƒ½å¯ä»¥ã€‚</p>
<p>std::forward<t>(u)æœ‰ä¸¤ä¸ªå‚æ•°ï¼šTä¸ uã€‚ a. å½“Tä¸ºå·¦å€¼å¼•ç”¨ç±»å‹æ—¶ï¼Œuå°†è¢«è½¬æ¢ä¸ºTç±»å‹çš„å·¦å€¼ï¼› b. å¦åˆ™uå°†è¢«è½¬æ¢ä¸ºTç±»å‹å³å€¼ã€‚<br>ä¸¾ä¸ªä¾‹å­ï¼Œæœ‰mainï¼ŒAï¼ŒBä¸‰ä¸ªå‡½æ•°ï¼Œè°ƒç”¨å…³ç³»ä¸ºï¼šmain-&gt;A-&gt;Bï¼Œå»ºè®®å…ˆçœ‹æ‡‚2.3èŠ‚å¯¹å·¦å³å€¼å¼•ç”¨æœ¬èº«æ˜¯å·¦å€¼è¿˜æ˜¯å³å€¼çš„è®¨è®ºå†çœ‹è¿™é‡Œï¼š</t></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change2</span><span class="params">(<span class="keyword">int</span>&amp;&amp; ref_r)</span> </span>&#123;</span><br><span class="line">    ref_r = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change3</span><span class="params">(<span class="keyword">int</span>&amp; ref_l)</span> </span>&#123;</span><br><span class="line">    ref_l = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// changeçš„å…¥å‚æ˜¯å³å€¼å¼•ç”¨</span></span><br><span class="line"><span class="comment">// æœ‰åå­—çš„å³å€¼å¼•ç”¨æ˜¯ å·¦å€¼ï¼Œå› æ­¤ref_ræ˜¯å·¦å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span>&amp;&amp; ref_r)</span> </span>&#123;</span><br><span class="line">    change2(ref_r);  <span class="comment">// é”™è¯¯ï¼Œchange2çš„å…¥å‚æ˜¯å³å€¼å¼•ç”¨ï¼Œéœ€è¦æ¥å³å€¼ï¼Œref_ræ˜¯å·¦å€¼ï¼Œç¼–è¯‘å¤±è´¥</span></span><br><span class="line">     </span><br><span class="line">    change2(<span class="built_in">std</span>::move(ref_r)); <span class="comment">// okï¼Œstd::moveæŠŠå·¦å€¼è½¬ä¸ºå³å€¼ï¼Œç¼–è¯‘é€šè¿‡</span></span><br><span class="line">    change2(<span class="built_in">std</span>::forward&lt;<span class="keyword">int</span> &amp;&amp;&gt;(ref_r));  <span class="comment">// okï¼Œstd::forwardçš„Tæ˜¯å³å€¼å¼•ç”¨ç±»å‹(int &amp;&amp;)ï¼Œç¬¦åˆæ¡ä»¶bï¼Œå› æ­¤u(ref_r)ä¼šè¢«è½¬æ¢ä¸ºå³å€¼ï¼Œç¼–è¯‘é€šè¿‡</span></span><br><span class="line">     </span><br><span class="line">    change3(ref_r); <span class="comment">// okï¼Œchange3çš„å…¥å‚æ˜¯å·¦å€¼å¼•ç”¨ï¼Œéœ€è¦æ¥å·¦å€¼ï¼Œref_ræ˜¯å·¦å€¼ï¼Œç¼–è¯‘é€šè¿‡</span></span><br><span class="line">    change3(<span class="built_in">std</span>::forward&lt;<span class="keyword">int</span> &amp;&gt;(ref_r)); <span class="comment">// okï¼Œstd::forwardçš„Tæ˜¯å·¦å€¼å¼•ç”¨ç±»å‹(int &amp;)ï¼Œç¬¦åˆæ¡ä»¶aï¼Œå› æ­¤u(ref_r)ä¼šè¢«è½¬æ¢ä¸ºå·¦å€¼ï¼Œç¼–è¯‘é€šè¿‡</span></span><br><span class="line">    <span class="comment">// å¯è§ï¼Œforwardå¯ä»¥æŠŠå€¼è½¬æ¢ä¸ºå·¦å€¼æˆ–è€…å³å€¼</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">5</span>;</span><br><span class="line">    change(<span class="built_in">std</span>::move(a));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å®Œç¾è½¬å‘"><a href="#å®Œç¾è½¬å‘" class="headerlink" title="å®Œç¾è½¬å‘"></a>å®Œç¾è½¬å‘</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cout</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(T&amp; param)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"ä¼ å…¥çš„æ˜¯å·¦å€¼"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(T&amp;&amp; param)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"ä¼ å…¥çš„æ˜¯å³å€¼"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">warp</span><span class="params">(T&amp;&amp; param)</span> </span>&#123;</span><br><span class="line">    func(param);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> num = <span class="number">2019</span>;</span><br><span class="line">    warp(num);</span><br><span class="line">    warp(<span class="number">2019</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ä¼ å…¥çš„æ˜¯å·¦å€¼</span><br><span class="line">ä¼ å…¥çš„æ˜¯å·¦å€¼</span><br></pre></td></tr></table></figure></p>
<p>æ˜¯ä¸æ˜¯å’Œæˆ‘ä»¬é¢„æœŸçš„ä¸ä¸€æ ·ï¼Œä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹åŸå› ï¼š</p>
<ul>
<li>warp()å‡½æ•°æœ¬èº«çš„å½¢å‚æ˜¯ä¸€ä¸ªä¸‡èƒ½å¼•ç”¨ï¼Œå³å¯ä»¥æ¥å—å·¦å€¼åˆå¯ä»¥æ¥å—å³å€¼ï¼›</li>
<li>ç¬¬ä¸€ä¸ªwarp()å‡½æ•°è°ƒç”¨å®å‚æ˜¯å·¦å€¼ï¼Œæ‰€ä»¥ï¼Œwarp()å‡½æ•°ä¸­è°ƒç”¨func()ä¸­ä¼ å…¥çš„å‚æ•°ä¹Ÿåº”è¯¥æ˜¯å·¦å€¼ï¼›</li>
<li>ç¬¬äºŒä¸ªwarp()å‡½æ•°è°ƒç”¨å®å‚æ˜¯å³å€¼ï¼Œæ ¹æ®ä¸Šé¢æ‰€è¯´çš„å¼•ç”¨æŠ˜å è§„åˆ™ï¼Œwarp()å‡½æ•°æ¥æ”¶çš„å‚æ•°ç±»å‹æ˜¯å³å€¼å¼•ç”¨ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆå´è°ƒç”¨äº†è°ƒç”¨func()çš„å·¦å€¼ç‰ˆæœ¬äº†å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºåœ¨warp()å‡½æ•°å†…éƒ¨ï¼Œå³å€¼å¼•ç”¨ç±»å‹å˜ä¸ºäº†å·¦å€¼ï¼Œå› ä¸ºå‚æ•°æœ‰äº†åç§°ï¼Œæˆ‘ä»¬èƒ½é€šè¿‡å˜é‡åå–å¾—å˜é‡åœ°å€äº†ã€‚</li>
</ul>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ€ä¹ˆä¿æŒå‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œå˜é‡ç±»å‹çš„ä¸å˜å‘¢ï¼Ÿè¿™å°±æ˜¯æˆ‘ä»¬æ‰€è°“çš„â€œå®Œç¾è½¬å‘â€æŠ€æœ¯ï¼Œåœ¨C++11ä¸­é€šè¿‡<code>std::forward()</code>å‡½æ•°æ¥å®ç°ã€‚æˆ‘ä»¬ä¿®æ”¹æˆ‘ä»¬çš„<code>warp()</code>å‡½æ•°å¦‚ä¸‹ï¼š<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">warp</span><span class="params">(T&amp;&amp; param)</span> </span>&#123;</span><br><span class="line">    func(<span class="built_in">std</span>::forward&lt;T&gt;(param));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åˆ™å¯ä»¥è¾“å‡ºé¢„æœŸçš„ç»“æœã€‚</p>
<h2 id="å…³äºenable-shared-from-this"><a href="#å…³äºenable-shared-from-this" class="headerlink" title="å…³äºenable_shared_from_this"></a>å…³äºenable_shared_from_this</h2><p>å¦‚æœä¸€ä¸ªTç±»å‹çš„å¯¹è±¡tï¼Œæ˜¯è¢«std::shared_ptrç®¡ç†çš„ï¼Œä¸”ç±»å‹Tç»§æ‰¿è‡ªstd::enable_shared_from_thisï¼Œé‚£ä¹ˆTå°±æœ‰ä¸ªshared_from_thisçš„æˆå‘˜å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªæ–°çš„std::shared_ptrçš„å¯¹è±¡ï¼Œä¹ŸæŒ‡å‘å¯¹è±¡tã€‚</p>
<p>é‚£ä¹ˆè¿™ä¸ªç‰¹æ€§çš„åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸€ä¸ªä¸»è¦çš„åœºæ™¯æ˜¯ä¿è¯å¼‚æ­¥å›è°ƒå‡½æ•°ä¸­æ“ä½œçš„å¯¹è±¡ä»ç„¶æœ‰æ•ˆã€‚æ¯”å¦‚æœ‰è¿™æ ·ä¸€ä¸ªç±»ï¼š<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    void Bar(std::function&lt;void(Foo*)&gt; p_fnCallback) &#123;</span><br><span class="line">        <span class="comment">// async call p_fnCallback with this</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Foo::Baræ¥å—ä¸€ä¸ªå‡½æ•°å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡éœ€è¦ä¸€ä¸ªFoo*æŒ‡é’ˆï¼Œå…¶å®è¦çš„å°±æ˜¯Foo::Barçš„thisæŒ‡é’ˆï¼Œä½†æ˜¯è¿™ä¸ªå›è°ƒæ˜¯å¼‚æ­¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¯èƒ½åœ¨è°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°æ—¶ï¼ŒthisæŒ‡å‘çš„Fooå¯¹è±¡å·²ç»æå‰ææ„äº†ã€‚</p>
<p>é¦–å…ˆè‚¯å®šä¸èƒ½é‚£æ ·å†™<code>shared_ptr&lt; A &gt; ( this )</code>ï¼Œè¿™ä¼šè°ƒç”¨shared_ptræ™ºèƒ½æŒ‡é’ˆçš„æ„é€ å‡½æ•°ï¼Œå¯¹thisæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼Œåˆå»ºç«‹äº†ä¸€ä»½å¼•ç”¨è®¡æ•°å¯¹è±¡ï¼Œå·²ç»å¯¹è¿™ä¸ªAå¯¹è±¡å»ºç«‹çš„å¼•ç”¨è®¡æ•°å¯¹è±¡ï¼Œåˆæˆäº†ä¸¤ä¸ªå¼•ç”¨è®¡æ•°å¯¹è±¡ï¼Œå¯¹åŒä¸€ä¸ªèµ„æºéƒ½è®°å½•äº†å¼•ç”¨è®¡æ•°ï¼Œä¸º1ï¼Œæœ€ç»ˆä¸¤æ¬¡ææ„å¯¹è±¡é‡Šæ”¾å†…å­˜ï¼Œé”™è¯¯ï¼</p>
<p>è¿™æ—¶å€™ï¼Œstd::enable_shared_from_thiså°±æ´¾ä¸Šç”¨åœºäº†ã€‚ä¿®æ”¹åå¦‚ä¸‹ï¼š<br><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">class Foo &#123;</span><br><span class="line">public:</span><br><span class="line"><span class="deletion">-    void Bar(std::function&lt;void(Foo*)&gt; p_fnCallback) &#123;</span></span><br><span class="line"><span class="addition">+    void Bar(std::function&lt;void(std::shared_ptr&lt;Foo&gt;)&gt; p_fnCallback) &#123;</span></span><br><span class="line"><span class="addition">+       std::shared_ptr&lt;Foo&gt; _foo = shared_from_this();</span></span><br><span class="line">        // async call p_fnCallback with this</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ ·å°±å¯ä»¥ä¿è¯å¼‚æ­¥å›è°ƒæ—¶ï¼ŒFooå¯¹è±¡ä»ç„¶æœ‰æ•ˆã€‚</p>
<p>æ³¨æ„åˆ°cppreferenceä¸­è¯´é“ï¼Œå¿…é¡»è¦æ˜¯std::shared_ptrç®¡ç†çš„å¯¹è±¡ï¼Œè°ƒç”¨shared_from_thisæ‰æ˜¯æœ‰æ•ˆçš„ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™ä¸ªå°±éœ€è¦çœ‹çœ‹std::enable_shared_from_thisçš„å®ç°åŸç†äº†ï¼š</p>
<p>ä¸€ä¸ªç±»ç»§æ‰¿enable_shared_from_thisä¼šæ€ä¹ˆæ ·ï¼Ÿçœ‹çœ‹enable_shared_from_thisåŸºç±»çš„æˆå‘˜å˜é‡æœ‰ä»€ä¹ˆï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">class</span> <span class="title">enable_shared_from_this</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">shared_ptr</span>&lt;T&gt; shared_from_this()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">shared_ptr</span>&lt;T&gt; p( weak_this_ );  <span class="comment">// ä»åŸæ¥çš„å¼±æ™ºèƒ½æŒ‡é’ˆé‡Œå˜æˆå¼ºæ™ºèƒ½æŒ‡é’ˆ, åˆ™æ˜¯åœ¨åŸæ¥çš„å¼ºæ™ºèƒ½æŒ‡é’ˆä¸Šé¢å¼•ç”¨è®¡æ•°+1</span></span><br><span class="line">        BOOST_ASSERT( p.get() == <span class="keyword">this</span> );</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span>: <span class="comment">// actually private, but avoids compiler template friendship issues</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note: invoked automatically by shared_ptr; do not call</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">X</span>, <span class="title">class</span> <span class="title">Y</span>&gt; <span class="title">void</span> _<span class="title">internal_accept_owner</span>( <span class="title">shared_ptr</span>&lt;X&gt; <span class="title">const</span> * <span class="title">ppx</span>, <span class="title">Y</span> * <span class="title">py</span> ) <span class="title">const</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="keyword">if</span>( weak_this_.expired() )</span><br><span class="line">        &#123;</span><br><span class="line">            weak_this_ = <span class="built_in">shared_ptr</span>&lt;T&gt;( *ppx, py );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">mutable</span> weak_ptr&lt;T&gt; weak_this_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªç±»ç»§æ‰¿äº†enable_shared_from_thisï¼Œé‚£ä¹ˆå®ƒäº§ç”Ÿçš„å¯¹è±¡å°±ä¼šä»åŸºç±»enable_shared_from_thisç»§æ‰¿ä¸€ä¸ªæˆå‘˜å˜é‡_Wptrï¼Œå½“å®šä¹‰ç¬¬ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆå¯¹è±¡çš„æ—¶å€™shared_ptr&lt; A &gt; ptr1(new A())ï¼Œè°ƒç”¨shared_ptrçš„æ™®é€šæ„é€ å‡½æ•°ï¼Œå°±ä¼šåˆå§‹åŒ–Aå¯¹è±¡çš„æˆå‘˜å˜é‡_Wptrï¼Œä½œä¸ºè§‚å¯ŸAå¯¹è±¡èµ„æºçš„ä¸€ä¸ªå¼±æ™ºèƒ½æŒ‡é’ˆè§‚å¯Ÿè€…ï¼ˆåœ¨shared_ptrçš„æ„é€ å‡½æ•°ä¸­å®ç°ï¼Œå¦‚ä¸‹ä»£ç ç‰‡æ®µ, æœ‰å…´è¶£å¯ä»¥è‡ªå·±è°ƒè¯•è·Ÿè¸ªæºç å®ç°ï¼‰ã€‚<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">class</span> <span class="title">shared_ptr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">Y</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">explicit</span> <span class="title">shared_ptr</span>( <span class="title">Y</span> * <span class="title">p</span> ):</span> px( p ), pn() <span class="comment">// Y must be complete</span></span><br><span class="line">    &#123;</span><br><span class="line">        boost::detail::sp_pointer_construct( <span class="keyword">this</span>, p, pn );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt; <span class="class"><span class="keyword">class</span> <span class="title">T</span>, <span class="title">class</span> <span class="title">Y</span> &gt; <span class="title">inline</span> <span class="title">void</span> <span class="title">sp_pointer_construct</span>( <span class="title">boost</span>:</span>:<span class="built_in">shared_ptr</span>&lt; T &gt; * ppx, Y * p, boost::detail::shared_count &amp; pn )</span><br><span class="line">&#123;</span><br><span class="line">    boost::detail::shared_count( p ).swap( pn );</span><br><span class="line">    boost::detail::sp_enable_shared_from_this( ppx, p, p );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt; <span class="class"><span class="keyword">class</span> <span class="title">X</span>, <span class="title">class</span> <span class="title">Y</span>, <span class="title">class</span> <span class="title">T</span> &gt; <span class="title">inline</span> <span class="title">void</span> <span class="title">sp_enable_shared_from_this</span>( <span class="title">boost</span>:</span>:<span class="built_in">shared_ptr</span>&lt;X&gt; <span class="keyword">const</span> * ppx, Y <span class="keyword">const</span> * py, boost::enable_shared_from_this&lt; T &gt; <span class="keyword">const</span> * pe )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>( pe != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        pe-&gt;_internal_accept_owner( ppx, <span class="keyword">const_cast</span>&lt; Y* &gt;( py ) );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">sp_enable_shared_from_this</span><span class="params">( ... )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç»¼ä¸Šæ‰€è¯´ï¼Œæ‰€æœ‰è¿‡ç¨‹éƒ½æ²¡æœ‰å†ä½¿ç”¨shared_ptrçš„æ™®é€šæ„é€ å‡½æ•°ï¼Œæ²¡æœ‰åœ¨äº§ç”Ÿé¢å¤–çš„å¼•ç”¨è®¡æ•°å¯¹è±¡ï¼Œä¸ä¼šå­˜åœ¨æŠŠä¸€ä¸ªå†…å­˜èµ„æºï¼Œè¿›è¡Œå¤šæ¬¡è®¡æ•°çš„è¿‡ç¨‹ï¼›<br>å…³é”®çš„æ˜¯, weak_ptråˆ°shared_ptrçš„æå‡, é€šè¿‡åˆ¤æ–­èµ„æºçš„å¼•ç”¨è®¡æ•°æ˜¯å¦è¿˜åœ¨ï¼Œåˆ¤å®šå¯¹è±¡çš„å­˜æ´»çŠ¶æ€ï¼Œ  </p>
<ul>
<li>å¯¹è±¡å­˜æ´»ï¼Œæå‡æˆåŠŸï¼›</li>
<li>å¯¹è±¡ææ„ï¼Œæå‡å¤±è´¥ï¼</li>
</ul>
<h2 id="ç¼–è¯‘è¿‡ç¨‹"><a href="#ç¼–è¯‘è¿‡ç¨‹" class="headerlink" title="ç¼–è¯‘è¿‡ç¨‹"></a>ç¼–è¯‘è¿‡ç¨‹</h2><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="http://www.plantuml.com/plantuml/svg/YzQALT3LjLF8ICt9oTTBveg6yejBKZBpzJAueE8AkaMPwHabG8cNYrgUBcbvFg6D2we4h1mX2cSXj43Co5JWWZ7WCi_tJ7knVY8NX4BNa0XLduYGUBQn7QYM2qAXgy-7gi-7k6ZolcTzIxboCfEIGIOWH20KGdEYNdvf2G00">
<ol>
<li>é¢„å¤„ç†(Preprocessing): åšä¸€äº›ç±»ä¼¼äºå°†æ‰€æœ‰çš„<code>#define</code>åˆ é™¤ï¼Œå¹¶ä¸”å±•å¼€æ‰€æœ‰çš„å®å®šä¹‰çš„æ“ä½œ, ç„¶åç”Ÿæˆhello.i</li>
<li>ç¼–è¯‘(Compilation): ç¼–è¯‘è¿‡ç¨‹å°±æ˜¯æŠŠé¢„å¤„ç†å®Œçš„æ–‡ä»¶è¿›è¡Œä¸€ç³»åˆ—çš„è¯æ³•åˆ†æï¼Œè¯­æ³•åˆ†æï¼Œè¯­ä¹‰åˆ†æåŠä¼˜åŒ–åç”Ÿæˆç›¸åº”çš„æ±‡ç¼–ä»£ç ã€‚å¾—åˆ°hello.a</li>
<li>æ±‡ç¼–(Assembly): æ±‡ç¼–å™¨æ˜¯å°†æ±‡ç¼–ä»£ç è½¬å˜æˆæœºå™¨å¯ä»¥æ‰§è¡Œçš„å‘½ä»¤ï¼Œæ¯ä¸€ä¸ªæ±‡ç¼–è¯­å¥å‡ ä¹éƒ½å¯¹åº”ä¸€æ¡æœºå™¨æŒ‡ä»¤ã€‚æ±‡ç¼–ç›¸å¯¹äºç¼–è¯‘è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œæ ¹æ®æ±‡ç¼–æŒ‡ä»¤å’Œæœºå™¨æŒ‡ä»¤çš„å¯¹ç…§è¡¨ä¸€ä¸€ç¿»è¯‘å³å¯ã€‚å¾—åˆ°hello.o</li>
<li>é“¾æ¥(Linking): é€šè¿‡è°ƒç”¨é“¾æ¥å™¨ldæ¥é“¾æ¥ç¨‹åºè¿è¡Œéœ€è¦çš„ä¸€å¤§å †ç›®æ ‡æ–‡ä»¶ï¼Œä»¥åŠæ‰€ä¾èµ–çš„å…¶å®ƒåº“æ–‡ä»¶ï¼Œæœ€åç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶<ul>
<li>é™æ€é“¾æ¥: æŒ‡åœ¨ç¼–è¯‘é˜¶æ®µç›´æ¥æŠŠé™æ€åº“åŠ å…¥åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­å»ï¼Œè¿™æ ·å¯æ‰§è¡Œæ–‡ä»¶ä¼šæ¯”è¾ƒå¤§</li>
<li>åŠ¨æ€é“¾æ¥: æŒ‡é“¾æ¥é˜¶æ®µä»…ä»…åªåŠ å…¥ä¸€äº›æè¿°ä¿¡æ¯ï¼Œè€Œç¨‹åºæ‰§è¡Œæ—¶å†ä»ç³»ç»Ÿä¸­æŠŠç›¸åº”åŠ¨æ€åº“åŠ è½½åˆ°å†…å­˜ä¸­å»ã€‚</li>
</ul>
</li>
</ol>
<h2 id="ç›®æ ‡æ–‡ä»¶"><a href="#ç›®æ ‡æ–‡ä»¶" class="headerlink" title="ç›®æ ‡æ–‡ä»¶"></a>ç›®æ ‡æ–‡ä»¶</h2><p>ç¼–è¯‘å™¨ç¼–è¯‘æºä»£ç åç”Ÿæˆçš„æ–‡ä»¶å«åšç›®æ ‡æ–‡ä»¶ã€‚ç›®æ ‡æ–‡ä»¶ä»ç»“æ„ä¸Šè®²ï¼Œå®ƒæ˜¯å·²ç»ç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼Œåªæ˜¯è¿˜æ²¡æœ‰ç»è¿‡é“¾æ¥çš„è¿‡ç¨‹ï¼Œå…¶ä¸­å¯èƒ½æœ‰äº›ç¬¦å·æˆ–æœ‰äº›åœ°å€è¿˜æ²¡æœ‰è¢«è°ƒæ•´ã€‚</p>
<blockquote>
<p>å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆWindows çš„ <code>.exe</code> å’Œ Linux çš„ <code>ELF</code>ï¼‰ã€åŠ¨æ€é“¾æ¥åº“ï¼ˆWindows çš„ <code>.dll</code> å’Œ Linux çš„ <code>.so</code>ï¼‰ã€é™æ€é“¾æ¥åº“ï¼ˆWindows çš„ <code>.lib</code> å’Œ Linux çš„ <code>.a</code>ï¼‰éƒ½æ˜¯æŒ‰ç…§å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼å­˜å‚¨ï¼ˆWindows æŒ‰ç…§ PE-COFFï¼ŒLinux æŒ‰ç…§ ELFï¼‰</p>
</blockquote>
<p>ç›®æ ‡æ–‡ä»¶æ ¼å¼:  </p>
<ul>
<li>Windows çš„ PEï¼ˆPortable Executableï¼‰ï¼Œæˆ–ç§°ä¸º PE-COFFï¼Œ<code>.obj</code> æ ¼å¼</li>
<li>Linux çš„ ELFï¼ˆExecutable Linkable Formatï¼‰ï¼Œ<code>.o</code> æ ¼å¼</li>
<li>Intel/Microsoft çš„ OMFï¼ˆObject Module Formatï¼‰</li>
<li>Unix çš„ <code>a.out</code> æ ¼å¼</li>
<li>MS-DOS çš„ <code>.COM</code> æ ¼å¼</li>
</ul>
<blockquote>
<p>PE å’Œ ELF éƒ½æ˜¯ COFFï¼ˆCommon File Formatï¼‰çš„å˜ç§</p>
</blockquote>
<h3 id="CPPç›®æ ‡æ–‡ä»¶å†…å­˜å¸ƒå±€"><a href="#CPPç›®æ ‡æ–‡ä»¶å†…å­˜å¸ƒå±€" class="headerlink" title="CPPç›®æ ‡æ–‡ä»¶å†…å­˜å¸ƒå±€"></a>CPPç›®æ ‡æ–‡ä»¶å†…å­˜å¸ƒå±€</h3><table><thead><tr><th>æ®µ</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>File Header</td><td>æ–‡ä»¶å¤´ï¼Œæè¿°æ•´ä¸ªæ–‡ä»¶çš„æ–‡ä»¶å±æ€§ï¼ˆåŒ…æ‹¬æ–‡ä»¶æ˜¯å¦å¯æ‰§è¡Œã€æ˜¯é™æ€é“¾æ¥æˆ–åŠ¨æ€è¿æ¥åŠå…¥å£åœ°å€ã€ç›®æ ‡ç¡¬ä»¶ã€ç›®æ ‡æ“ä½œç³»ç»Ÿç­‰ï¼‰</td></tr><tr><td>.text section</td><td>ä»£ç æ®µï¼Œæ‰§è¡Œè¯­å¥ç¼–è¯‘æˆçš„æœºå™¨ä»£ç </td></tr><tr><td>.data section</td><td>æ•°æ®æ®µï¼Œå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡</td></tr><tr><td>.bss section</td><td>BSS æ®µï¼ˆBlock Started by Symbolï¼‰ï¼Œæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡ï¼ˆå› ä¸ºé»˜è®¤å€¼ä¸º 0ï¼Œæ‰€ä»¥åªæ˜¯åœ¨æ­¤é¢„ç•™ä½ç½®ï¼Œä¸å ç©ºé—´ï¼‰</td></tr><tr><td>.rodata section</td><td>åªè¯»æ•°æ®æ®µï¼Œå­˜æ”¾åªè¯»æ•°æ®ï¼Œä¸€èˆ¬æ˜¯ç¨‹åºé‡Œé¢çš„åªè¯»å˜é‡ï¼ˆå¦‚ const ä¿®é¥°çš„å˜é‡ï¼‰å’Œå­—ç¬¦ä¸²å¸¸é‡</td></tr><tr><td>.comment section</td><td>æ³¨é‡Šä¿¡æ¯æ®µï¼Œå­˜æ”¾ç¼–è¯‘å™¨ç‰ˆæœ¬ä¿¡æ¯</td></tr><tr><td>.note.GNU-stack section</td><td>å †æ ˆæç¤ºæ®µ</td></tr></tbody></table>


<h1 id="Go-pending-fin"><a href="#Go-pending-fin" class="headerlink" title="Go pending_fin"></a>Go pending_fin</h1><ul>
<li>defer: æ¨è¿Ÿæ‰§è¡Œ, ä¸€èˆ¬ç”¨äºåšä¸€äº›æ”¶å°¾å·¥ä½œ</li>
<li>syncåº“<ul>
<li>sync.Map: Go è¯­è¨€åŸç”Ÿ map å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯¹å®ƒè¿›è¡Œå¹¶å‘è¯»å†™æ“ä½œçš„æ—¶å€™ï¼Œéœ€è¦åŠ é”ã€‚è€Œsync.Mapæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¯»å–ï¼Œæ’å…¥ï¼Œåˆ é™¤ä¹Ÿéƒ½ä¿æŒç€å¸¸æ•°çº§çš„æ—¶é—´å¤æ‚åº¦ã€‚å…·ä½“å®ç°å¯å‚è€ƒ:<ul>
<li><a href="https://juejin.im/post/6844903895227957262" target="_blank" rel="noopener">https://juejin.im/post/6844903895227957262</a></li>
<li><a href="https://www.cnblogs.com/qcrao-2018/p/12833787.html" target="_blank" rel="noopener">https://www.cnblogs.com/qcrao-2018/p/12833787.html</a><ul>
<li>sync.Pool: ä¸´æ—¶å¯¹è±¡æ± , æä¾›put/getæ–¹æ³•, ä¸´æ—¶å¯¹è±¡æ±  sync.Pool éå¸¸é€‚ç”¨äºåœ¨å¹¶å‘ç¼–ç¨‹ä¸­ç”¨ä½œä¸´æ—¶å¯¹è±¡ç¼“å­˜ï¼Œå®ç°å¯¹è±¡çš„é‡å¤ä½¿ç”¨ï¼Œä¼˜åŒ– GCï¼Œæå‡ç³»ç»Ÿæ€§èƒ½ï¼Œä½†æ˜¯ç”±äºä¸èƒ½è®¾ç½®å¯¹è±¡æ± å¤§å°ï¼Œè€Œä¸”æ”¾è¿›å¯¹è±¡æ± çš„ä¸´æ—¶å¯¹è±¡æ¯æ¬¡ GC è¿è¡Œæ—¶ä¼šè¢«æ¸…é™¤ï¼Œæ‰€ä»¥åªèƒ½ç”¨ä½œç®€å•çš„ä¸´æ—¶å¯¹è±¡æ± ï¼Œä¸èƒ½ç”¨ä½œæŒä¹…åŒ–çš„é•¿è¿æ¥æ± ï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥æ± ã€Redis è¿æ¥æ± ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>sync.Mutex: äº’æ–¥é”</li>
<li>sync.RWMutex: è¯»å†™é”</li>
<li>sync.Once: ç±»ä¼¼pthread_once</li>
<li>sync.Atomic: åŸå­æ•°</li>
</ul>
</li>
<li>select: pending_fin</li>
<li>context: pending_fin<ul>
<li>æ¯”å¦‚æœ‰ä¸€ä¸ªç½‘ç»œè¯·æ±‚Requestï¼Œæ¯ä¸ªRequestéƒ½éœ€è¦å¼€å¯ä¸€ä¸ªgoroutineåšä¸€äº›äº‹æƒ…ï¼Œè¿™äº›goroutineåˆå¯èƒ½ä¼šå¼€å¯å…¶ä»–çš„goroutineã€‚è¿™æ ·çš„è¯ï¼Œ æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡Contextï¼Œæ¥è·Ÿè¸ªè¿™äº›goroutineï¼Œå¹¶ä¸”é€šè¿‡Contextæ¥æ§åˆ¶ä»–ä»¬çš„ç›®çš„ï¼Œè¿™å°±æ˜¯Goè¯­è¨€ä¸ºæˆ‘ä»¬æä¾›çš„Contextï¼Œä¸­æ–‡å¯ä»¥ç§°ä¹‹ä¸ºâ€œä¸Šä¸‹æ–‡â€ã€‚<br>å¦å¤–ä¸€ä¸ªå®é™…ä¾‹å­æ˜¯ï¼Œåœ¨GoæœåŠ¡å™¨ç¨‹åºä¸­ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½ä¼šæœ‰ä¸€ä¸ªgoroutineå»å¤„ç†ã€‚ç„¶è€Œï¼Œå¤„ç†ç¨‹åºå¾€å¾€è¿˜éœ€è¦åˆ›å»ºé¢å¤–çš„goroutineå»è®¿é—®åç«¯èµ„æºï¼Œæ¯”å¦‚æ•°æ®åº“ã€RPCæœåŠ¡ç­‰ã€‚ç”±äºè¿™äº›goroutineéƒ½æ˜¯åœ¨å¤„ç†åŒä¸€ä¸ªè¯·æ±‚ï¼Œæ‰€ä»¥å®ƒä»¬å¾€å¾€éœ€è¦è®¿é—®ä¸€äº›å…±äº«çš„èµ„æºï¼Œæ¯”å¦‚ç”¨æˆ·èº«ä»½ä¿¡æ¯ã€è®¤è¯tokenã€è¯·æ±‚æˆªæ­¢æ—¶é—´ç­‰ã€‚è€Œä¸”å¦‚æœè¯·æ±‚è¶…æ—¶æˆ–è€…è¢«å–æ¶ˆåï¼Œæ‰€æœ‰çš„goroutineéƒ½åº”è¯¥é©¬ä¸Šé€€å‡ºå¹¶ä¸”é‡Šæ”¾ç›¸å…³çš„èµ„æºã€‚è¿™ç§æƒ…å†µä¹Ÿéœ€è¦ç”¨Contextæ¥ä¸ºæˆ‘ä»¬å–æ¶ˆæ‰æ‰€æœ‰goroutine</li>
</ul>
</li>
</ul>
<h2 id="goroutineåç¨‹è°ƒåº¦"><a href="#goroutineåç¨‹è°ƒåº¦" class="headerlink" title="goroutineåç¨‹è°ƒåº¦"></a>goroutineåç¨‹è°ƒåº¦</h2><p>å‚è€ƒ:</p>
<ul>
<li><a href="https://studygolang.com/articles/26795" target="_blank" rel="noopener">https://studygolang.com/articles/26795</a></li>
<li><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-goroutine/#65-%E8%B0%83%E5%BA%A6%E5%99%A8" target="_blank" rel="noopener">https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-goroutine/#65-%E8%B0%83%E5%BA%A6%E5%99%A8</a></li>
</ul>
<p>Golang åˆ™å¼•å…¥äº† G/P/M æ¨¡å‹æ¥å®ç°è°ƒåº¦ï¼Œé‚£ä¹ˆ Golang çš„è¿è¡Œæ—¶ï¼ˆruntimeï¼‰å¦‚ä½•å®ç°å¯¹ goroutine çš„è°ƒåº¦ä»è€Œåˆç†åˆ†é… CPU èµ„æºå‘¢ï¼Ÿ</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/go/golang-routine-scheduler.png" alt></p>
<p>M:Næ¨¡å‹ï¼Œå†…æ ¸ç©ºé—´å¼€å¯Mä¸ªå†…æ ¸çº¿ç¨‹ï¼Œä¸€ä¸ªå†…æ ¸ç©ºé—´çº¿ç¨‹å¯¹åº”Nä¸ªç”¨æˆ·ç©ºé—´çº¿ç¨‹ã€‚æ•ˆç‡éå¸¸é«˜ï¼Œä½†æ˜¯ç®¡ç†å¤æ‚ã€‚</p>
<p>æœ¬è´¨ä¸Šgoroutineå°±æ˜¯åç¨‹ï¼Œä½†æ˜¯å®Œå…¨è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼Œå€Ÿé‰´äº†M:Næ¨¡å‹.<br>ç›¸æ¯”å…¶ä»–è¯­è¨€ï¼Œgolangé‡‡ç”¨äº†MPGæ¨¡å‹ç®¡ç†åç¨‹ï¼Œæ›´åŠ é«˜æ•ˆï¼Œä½†æ˜¯ç®¡ç†éå¸¸å¤æ‚ã€‚</p>
<ul>
<li>Mï¼šå†…æ ¸çº§çº¿ç¨‹</li>
<li>Gï¼šä»£è¡¨ä¸€ä¸ªgoroutine</li>
<li>Pï¼šProcessorï¼Œå¤„ç†å™¨ï¼Œç”¨æ¥ç®¡ç†å’Œæ‰§è¡Œgoroutineçš„ã€‚</li>
</ul>
<p><strong>G-M-Pä¸‰è€…çš„å…³ç³»ä¸ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li>Pçš„ä¸ªæ•°å–å†³äºè®¾ç½®çš„GOMAXPROCSï¼Œgoæ–°ç‰ˆæœ¬é»˜è®¤ä½¿ç”¨æœ€å¤§å†…æ ¸æ•°ï¼Œæ¯”å¦‚ä½ æœ‰8æ ¸å¤„ç†å™¨ï¼Œé‚£ä¹ˆPçš„æ•°é‡å°±æ˜¯8</li>
<li>Mçš„æ•°é‡å’ŒPä¸ä¸€å®šåŒ¹é…ï¼Œå¯ä»¥è®¾ç½®å¾ˆå¤šMï¼ŒMå’ŒPç»‘å®šåæ‰å¯è¿è¡Œï¼Œå¤šä½™çš„Må¤„äºä¼‘çœ çŠ¶æ€ã€‚</li>
<li>PåŒ…å«ä¸€ä¸ªLRQï¼ˆLocal Run Queueï¼‰æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ï¼Œè¿™é‡Œé¢ä¿å­˜ç€Péœ€è¦æ‰§è¡Œçš„åç¨‹Gçš„é˜Ÿåˆ—</li>
<li>é™¤äº†æ¯ä¸ªPè‡ªèº«ä¿å­˜çš„Gçš„é˜Ÿåˆ—å¤–ï¼Œè°ƒåº¦å™¨è¿˜æ‹¥æœ‰ä¸€ä¸ªå…¨å±€çš„Gé˜Ÿåˆ—GRQï¼ˆGlobal Run Queueï¼‰ï¼Œè¿™ä¸ªé˜Ÿåˆ—å­˜å‚¨çš„æ˜¯æ‰€æœ‰æœªåˆ†é…çš„åç¨‹Gã€‚</li>
</ul>
<p><strong>è®¾è®¡ç­–ç•¥</strong>:   </p>
<ul>
<li>å¤ç”¨çº¿ç¨‹ï¼šé¿å…é¢‘ç¹çš„åˆ›å»ºã€é”€æ¯çº¿ç¨‹ï¼Œè€Œæ˜¯å¯¹çº¿ç¨‹çš„å¤ç”¨ã€‚</li>
<li>work stealingæœºåˆ¶: å½“æœ¬çº¿ç¨‹æ— å¯è¿è¡Œçš„Gæ—¶ï¼Œå°è¯•ä»å…¶ä»–çº¿ç¨‹ç»‘å®šçš„På·å–Gï¼Œè€Œä¸æ˜¯é”€æ¯çº¿ç¨‹ã€‚</li>
<li>hand offæœºåˆ¶: å½“æœ¬çº¿ç¨‹å› ä¸ºGè¿›è¡Œç³»ç»Ÿè°ƒç”¨é˜»å¡æ—¶ï¼Œçº¿ç¨‹é‡Šæ”¾ç»‘å®šçš„Pï¼ŒæŠŠPè½¬ç§»ç»™å…¶ä»–ç©ºé—²çš„çº¿ç¨‹æ‰§è¡Œã€‚</li>
<li>åˆ©ç”¨å¹¶è¡Œï¼šGOMAXPROCSè®¾ç½®Pçš„æ•°é‡ï¼Œæœ€å¤šæœ‰GOMAXPROCSä¸ªçº¿ç¨‹åˆ†å¸ƒåœ¨å¤šä¸ªCPUä¸ŠåŒæ—¶è¿è¡Œã€‚GOMAXPROCSä¹Ÿé™åˆ¶äº†å¹¶å‘çš„ç¨‹åº¦ï¼Œæ¯”å¦‚GOMAXPROCS = æ ¸æ•°/2ï¼Œåˆ™æœ€å¤šåˆ©ç”¨äº†ä¸€åŠçš„CPUæ ¸è¿›è¡Œå¹¶è¡Œã€‚</li>
<li>æŠ¢å ï¼šåœ¨coroutineä¸­è¦ç­‰å¾…ä¸€ä¸ªåç¨‹ä¸»åŠ¨è®©å‡ºCPUæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªåç¨‹ï¼Œåœ¨Goä¸­ï¼Œä¸€ä¸ªgoroutineæœ€å¤šå ç”¨CPU 10msï¼Œé˜²æ­¢å…¶ä»–goroutineè¢«é¥¿æ­»ï¼Œè¿™å°±æ˜¯goroutineä¸åŒäºcoroutineçš„ä¸€ä¸ªåœ°æ–¹ã€‚</li>
<li>å…¨å±€Gé˜Ÿåˆ—ï¼šåœ¨æ–°çš„è°ƒåº¦å™¨ä¸­ä¾ç„¶æœ‰å…¨å±€Gé˜Ÿåˆ—ï¼Œä½†åŠŸèƒ½å·²ç»è¢«å¼±åŒ–äº†ï¼Œå½“Mæ‰§è¡Œwork stealingä»å…¶ä»–På·ä¸åˆ°Gæ—¶ï¼Œå®ƒå¯ä»¥ä»å…¨å±€Gé˜Ÿåˆ—è·å–Gã€‚</li>
</ul>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/go/golang-routine-scheduler_flow_diagram.png" alt="è°ƒåº¦æµç¨‹å›¾"></p>
<h1 id="ç½‘ç»œå®‰å…¨"><a href="#ç½‘ç»œå®‰å…¨" class="headerlink" title="ç½‘ç»œå®‰å…¨"></a>ç½‘ç»œå®‰å…¨</h1><p>æœ€åå°±æ˜¯ç½‘ç»œå®‰å…¨ï¼Œä¸»è¦è€ƒå¯Ÿä¹Ÿæ˜¯ WEB å®‰å…¨ï¼ŒåŒ…æ‹¬</p>
<ul>
<li><a href="#XSS">XSS</a></li>
<li><a href="#CSRF">CSRF</a></li>
<li>SQLæ³¨å…¥</li>
<li>â€¦</li>
</ul>
<h2 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a>XSS</h2><p>å‚è€ƒ: <a href="https://tech.meituan.com/2018/09/27/fe-security.html" target="_blank" rel="noopener">https://tech.meituan.com/2018/09/27/fe-security.html</a></p>
<p>ä»€ä¹ˆæ˜¯ XSS?  </p>
<p>Cross-Site Scriptingï¼ˆè·¨ç«™è„šæœ¬æ”»å‡»ï¼‰ç®€ç§° XSSï¼Œæ˜¯<strong>ä¸€ç§ä»£ç æ³¨å…¥æ”»å‡»</strong>ã€‚æ”»å‡»è€…é€šè¿‡åœ¨ç›®æ ‡ç½‘ç«™ä¸Šæ³¨å…¥æ¶æ„è„šæœ¬ï¼Œä½¿ä¹‹åœ¨ç”¨æˆ·çš„æµè§ˆå™¨ä¸Šè¿è¡Œã€‚åˆ©ç”¨è¿™äº›æ¶æ„è„šæœ¬ï¼Œæ”»å‡»è€…å¯è·å–ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯å¦‚ Cookieã€SessionID ç­‰ï¼Œè¿›è€Œå±å®³æ•°æ®å®‰å…¨ã€‚</p>
<p>ä¸ºäº†å’Œ CSS åŒºåˆ†ï¼Œè¿™é‡ŒæŠŠæ”»å‡»çš„ç¬¬ä¸€ä¸ªå­—æ¯æ”¹æˆäº† Xï¼Œäºæ˜¯å«åš XSSã€‚<br>XSS çš„æœ¬è´¨æ˜¯ï¼šæ¶æ„ä»£ç æœªç»è¿‡æ»¤ï¼Œä¸ç½‘ç«™æ­£å¸¸çš„ä»£ç æ··åœ¨ä¸€èµ·ï¼›æµè§ˆå™¨æ— æ³•åˆ†è¾¨å“ªäº›è„šæœ¬æ˜¯å¯ä¿¡çš„ï¼Œå¯¼è‡´æ¶æ„è„šæœ¬è¢«æ‰§è¡Œã€‚<br>è€Œç”±äºç›´æ¥åœ¨ç”¨æˆ·çš„ç»ˆç«¯æ‰§è¡Œï¼Œæ¶æ„ä»£ç èƒ½å¤Ÿç›´æ¥è·å–ç”¨æˆ·çš„ä¿¡æ¯ï¼Œæˆ–è€…åˆ©ç”¨è¿™äº›ä¿¡æ¯å†’å……ç”¨æˆ·å‘ç½‘ç«™å‘èµ·æ”»å‡»è€…å®šä¹‰çš„è¯·æ±‚ã€‚<br>åœ¨éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œç”±äºè¾“å…¥çš„é™åˆ¶ï¼Œæ³¨å…¥çš„æ¶æ„è„šæœ¬æ¯”è¾ƒçŸ­ã€‚ä½†å¯ä»¥é€šè¿‡å¼•å…¥å¤–éƒ¨çš„è„šæœ¬ï¼Œå¹¶ç”±æµè§ˆå™¨æ‰§è¡Œï¼Œæ¥å®Œæˆæ¯”è¾ƒå¤æ‚çš„æ”»å‡»ç­–ç•¥ã€‚</p>
<h3 id="XSSæ˜¯å¦‚ä½•æ³¨å…¥çš„"><a href="#XSSæ˜¯å¦‚ä½•æ³¨å…¥çš„" class="headerlink" title="XSSæ˜¯å¦‚ä½•æ³¨å…¥çš„"></a>XSSæ˜¯å¦‚ä½•æ³¨å…¥çš„</h3><p>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼šç”¨æˆ·æ˜¯é€šè¿‡å“ªç§æ–¹æ³•â€œæ³¨å…¥â€æ¶æ„è„šæœ¬çš„å‘¢ï¼Ÿ<br>ä¸ä»…ä»…æ˜¯ä¸šåŠ¡ä¸Šçš„â€œç”¨æˆ·çš„ UGC å†…å®¹â€å¯ä»¥è¿›è¡Œæ³¨å…¥ï¼ŒåŒ…æ‹¬ URL ä¸Šçš„å‚æ•°ç­‰éƒ½å¯ä»¥æ˜¯æ”»å‡»çš„æ¥æºã€‚åœ¨å¤„ç†è¾“å…¥æ—¶ï¼Œä»¥ä¸‹å†…å®¹éƒ½ä¸å¯ä¿¡ï¼š </p>
<ul>
<li>æ¥è‡ªç”¨æˆ·çš„ UGC ä¿¡æ¯</li>
<li>æ¥è‡ªç¬¬ä¸‰æ–¹çš„é“¾æ¥</li>
<li>URL å‚æ•°</li>
<li>POST å‚æ•°</li>
<li>Referer ï¼ˆå¯èƒ½æ¥è‡ªä¸å¯ä¿¡çš„æ¥æºï¼‰</li>
<li>Cookie ï¼ˆå¯èƒ½æ¥è‡ªå…¶ä»–å­åŸŸæ³¨å…¥ï¼‰</li>
</ul>
<p>ä¸¾ä¸ªç®€å•ä¾‹å­:<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">escape</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;script&gt;console.log("'</span>+s+<span class="string">'");&lt;/script&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœè¾“å…¥çš„<code>s</code> ä¸º <code>&quot;);alert(1);//</code> , åˆ™å°† return <code>&lt;script&gt;console.log(&quot;&quot;);alert(1);//&quot;);&lt;/script&gt;</code> , è¿™å°±ä¼šå¼¹å‡ºè­¦å‘Šçª—å£<code>alert(1)</code> è¿™å°±æ˜¯æ¶æ„è„šæœ¬æ³¨å…¥</p>
<p>å†ä¸¾ä¸ªçœŸå®çš„ä¾‹å­, <strong>æ–°æµªå¾®åšåäººå ‚åå°„å‹ XSS æ¼æ´</strong>:</p>
<p>æ”»å‡»è€…å‘ç° <code>http://weibo.com/pub/star/g/xyyyd</code> è¿™ä¸ª URL çš„å†…å®¹æœªç»è¿‡æ»¤ç›´æ¥è¾“å‡ºåˆ° HTML ä¸­ã€‚<br>äºæ˜¯æ”»å‡»è€…æ„å»ºå‡ºä¸€ä¸ª URLï¼Œç„¶åè¯±å¯¼ç”¨æˆ·å»ç‚¹å‡»ï¼š<br><code>http://weibo.com/pub/star/g/xyyyd&quot;&gt;&lt;script src=//xxxx.cn/image/t.js&gt;&lt;/script&gt;</code><br>ç”¨æˆ·ç‚¹å‡»è¿™ä¸ª URL æ—¶ï¼ŒæœåŠ¡ç«¯å–å‡ºè¯·æ±‚ URLï¼Œæ‹¼æ¥åˆ° HTML å“åº”ä¸­ï¼š<br><code>&lt;li&gt;&lt;a href=&quot;http://weibo.com/pub/star/g/xyyyd&quot;&gt;&lt;script src=//xxxx.cn/image/t.js&gt;&lt;/script&gt;&quot;&gt;æŒ‰åˆ†ç±»æ£€ç´¢&lt;/a&gt;&lt;/li&gt;</code><br>æµè§ˆå™¨æ¥æ”¶åˆ°å“åº”åå°±ä¼šåŠ è½½æ‰§è¡Œæ¶æ„è„šæœ¬ <code>//xxxx.cn/image/t.js</code>ï¼Œåœ¨æ¶æ„è„šæœ¬ä¸­åˆ©ç”¨ç”¨æˆ·çš„ç™»å½•çŠ¶æ€è¿›è¡Œå…³æ³¨ã€å‘å¾®åšã€å‘ç§ä¿¡ç­‰æ“ä½œï¼Œå‘å‡ºçš„å¾®åšå’Œç§ä¿¡å¯å†å¸¦ä¸Šæ”»å‡» URLï¼Œè¯±å¯¼æ›´å¤šäººç‚¹å‡»ï¼Œä¸æ–­æ”¾å¤§æ”»å‡»èŒƒå›´ã€‚è¿™ç§çªƒç”¨å—å®³è€…èº«ä»½å‘å¸ƒæ¶æ„å†…å®¹ï¼Œå±‚å±‚æ”¾å¤§æ”»å‡»èŒƒå›´çš„æ–¹å¼ï¼Œè¢«ç§°ä¸º â€œXSS è •è™«â€ã€‚</p>
<h3 id="å¦‚ä½•é˜²èŒƒXSS"><a href="#å¦‚ä½•é˜²èŒƒXSS" class="headerlink" title="å¦‚ä½•é˜²èŒƒXSS"></a>å¦‚ä½•é˜²èŒƒXSS</h3><p>è™½ç„¶å¾ˆéš¾é€šè¿‡æŠ€æœ¯æ‰‹æ®µå®Œå…¨é¿å… XSSï¼Œä½†æˆ‘ä»¬å¯ä»¥æ€»ç»“ä»¥ä¸‹åŸåˆ™å‡å°‘æ¼æ´çš„äº§ç”Ÿï¼š</p>
<ul>
<li>åˆ©ç”¨æ¨¡æ¿å¼•æ“ å¼€å¯æ¨¡æ¿å¼•æ“è‡ªå¸¦çš„ HTML è½¬ä¹‰åŠŸèƒ½ã€‚</li>
<li>é¿å…æ‹¼æ¥ HTML å‰ç«¯é‡‡ç”¨æ‹¼æ¥ HTML çš„æ–¹æ³•æ¯”è¾ƒå±é™©ï¼Œå¦‚æœæ¡†æ¶å…è®¸ï¼Œä½¿ç”¨ createElementã€setAttribute ä¹‹ç±»çš„æ–¹æ³•å®ç°ã€‚æˆ–è€…é‡‡ç”¨æ¯”è¾ƒæˆç†Ÿçš„æ¸²æŸ“æ¡†æ¶ï¼Œå¦‚ <code>Vue</code>/<code>React</code> ç­‰ã€‚</li>
<li>æ—¶åˆ»ä¿æŒè­¦æƒ• åœ¨æ’å…¥ä½ç½®ä¸º DOM å±æ€§ã€é“¾æ¥ç­‰ä½ç½®æ—¶ï¼Œè¦æ‰“èµ·ç²¾ç¥ï¼Œä¸¥åŠ é˜²èŒƒã€‚</li>
<li>å¢åŠ æ”»å‡»éš¾åº¦ï¼Œé™ä½æ”»å‡»åæœ é€šè¿‡ CSPã€è¾“å…¥é•¿åº¦é…ç½®ã€æ¥å£å®‰å…¨æªæ–½ç­‰æ–¹æ³•ï¼Œå¢åŠ æ”»å‡»çš„éš¾åº¦ï¼Œé™ä½æ”»å‡»çš„åæœã€‚</li>
<li>ä¸»åŠ¨æ£€æµ‹å’Œå‘ç° å¯ä½¿ç”¨ XSS æ”»å‡»å­—ç¬¦ä¸²å’Œè‡ªåŠ¨æ‰«æå·¥å…·å¯»æ‰¾æ½œåœ¨çš„ XSS æ¼æ´ã€‚</li>
</ul>
<p>ä¸¾ä¸ªä¾‹å­:</p>
<p>æŸå¤©ï¼Œå…¬å¸éœ€è¦ä¸€ä¸ªæœç´¢é¡µé¢ï¼Œæ ¹æ® URL å‚æ•°å†³å®šå…³é”®è¯çš„å†…å®¹ã€‚å°æ˜å¾ˆå¿«æŠŠé¡µé¢å†™å¥½å¹¶ä¸”ä¸Šçº¿ã€‚ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">"&lt;%= getParameter("</span><span class="attr">keyword</span>") %&gt;</span>"&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">button</span>&gt;</span>æœç´¢<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  æ‚¨æœç´¢çš„å…³é”®è¯æ˜¯ï¼š<span class="tag">&lt;<span class="name">%=</span> <span class="attr">getParameter</span>("<span class="attr">keyword</span>") %&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>ç„¶è€Œï¼Œåœ¨ä¸Šçº¿åä¸ä¹…ï¼Œå°æ˜å°±æ¥åˆ°äº†å®‰å…¨ç»„å‘æ¥çš„ä¸€ä¸ªç¥ç§˜é“¾æ¥ï¼š<br><code>http://xxx/search?keyword=&quot;&gt;&lt;script&gt;alert(&#39;XSS&#39;);&lt;/script&gt;</code><br>å°æ˜å¸¦ç€ä¸€ç§ä¸ç¥¥çš„é¢„æ„Ÿç‚¹å¼€äº†è¿™ä¸ªé“¾æ¥ [è¯·å‹¿æ¨¡ä»¿ï¼Œç¡®è®¤å®‰å…¨çš„é“¾æ¥æ‰èƒ½ç‚¹å¼€]ã€‚æœç„¶ï¼Œé¡µé¢ä¸­å¼¹å‡ºäº†å†™ç€â€XSSâ€ çš„å¯¹è¯æ¡†ã€‚</p>
<blockquote>
<p>å¯æ¶ï¼Œä¸­æ‹›äº†ï¼å°æ˜çœ‰å¤´ä¸€çš±ï¼Œå‘ç°äº†å…¶ä¸­çš„å¥¥ç§˜ï¼š  </p>
</blockquote>
<p>å½“æµè§ˆå™¨è¯·æ±‚ <code>http://xxx/search?keyword=&quot;&gt;&lt;script&gt;alert(&#39;XSS&#39;);&lt;/script&gt;</code> æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šè§£æå‡ºè¯·æ±‚å‚æ•° <code>keyword</code>ï¼Œå¾—åˆ° <code>&quot;&gt;&lt;script&gt;alert(&#39;XSS&#39;);&lt;/script&gt;</code>ï¼Œæ‹¼æ¥åˆ° HTML ä¸­è¿”å›ç»™æµè§ˆå™¨ã€‚å½¢æˆäº†å¦‚ä¸‹çš„ HTMLï¼š<br><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">'XSS'</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>"&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">button</span>&gt;</span>æœç´¢<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  æ‚¨æœç´¢çš„å…³é”®è¯æ˜¯ï¼š"&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">alert(<span class="string">'XSS'</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>æµè§ˆå™¨æ— æ³•åˆ†è¾¨å‡º <code>&lt;script&gt;alert(&#39;XSS&#39;);&lt;/script&gt;</code> æ˜¯æ¶æ„ä»£ç ï¼Œå› è€Œå°†å…¶æ‰§è¡Œã€‚<br>è¿™é‡Œä¸ä»…ä»… div çš„å†…å®¹è¢«æ³¨å…¥äº†ï¼Œè€Œä¸” input çš„ value å±æ€§ä¹Ÿè¢«æ³¨å…¥ï¼Œ alert ä¼šå¼¹å‡ºä¸¤æ¬¡ã€‚<br>é¢å¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•è¿›è¡Œé˜²èŒƒå‘¢ï¼Ÿ<br>å…¶å®ï¼Œè¿™åªæ˜¯æµè§ˆå™¨æŠŠç”¨æˆ·çš„è¾“å…¥å½“æˆäº†è„šæœ¬è¿›è¡Œäº†æ‰§è¡Œã€‚é‚£ä¹ˆåªè¦å‘Šè¯‰æµè§ˆå™¨è¿™æ®µå†…å®¹æ˜¯æ–‡æœ¬å°±å¯ä»¥äº†ã€‚<br>èªæ˜çš„å°æ˜å¾ˆå¿«æ‰¾åˆ°è§£å†³æ–¹æ³•ï¼ŒæŠŠè¿™ä¸ªæ¼æ´ä¿®å¤ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">"&lt;%= escapeHTML(getParameter("</span><span class="attr">keyword</span>")) %&gt;</span>"&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">button</span>&gt;</span>æœç´¢<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  æ‚¨æœç´¢çš„å…³é”®è¯æ˜¯ï¼š<span class="tag">&lt;<span class="name">%=</span> <span class="attr">escapeHTML</span>(<span class="attr">getParameter</span>("<span class="attr">keyword</span>")) %&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>escapeHTML()</code> æŒ‰ç…§å¦‚ä¸‹è§„åˆ™è¿›è¡Œè½¬ä¹‰ï¼š</p>
<p>| å­—ç¬¦ | è½¬ä¹‰åçš„å­—ç¬¦ | |-|-| |<code>&amp;</code>|<code>&amp;amp;</code>| |<code>&lt;</code>|<code>&amp;lt;</code>| |<code>&gt;</code>|<code>&amp;gt;</code>| |<code>&quot;</code>|<code>&amp;quot;</code>| |<code>&#39;</code>|<code>&amp;#x27;</code>| |<code>/</code>|<code>&amp;#x2F;</code>|</p>
<p>ç»è¿‡äº†è½¬ä¹‰å‡½æ•°çš„å¤„ç†åï¼Œæœ€ç»ˆæµè§ˆå™¨æ¥æ”¶åˆ°çš„å“åº”ä¸ºï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">"&amp;quot;&amp;gt;&amp;lt;script&amp;gt;alert(&amp;#x27;XSS&amp;#x27;);&amp;lt;&amp;#x2F;script&amp;gt;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span>&gt;</span>æœç´¢<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  æ‚¨æœç´¢çš„å…³é”®è¯æ˜¯ï¼š&amp;quot;&amp;gt;&amp;lt;script&amp;gt;alert(&amp;#x27;XSS&amp;#x27;);&amp;lt;&amp;#x2F;script&amp;gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>æ¶æ„ä»£ç éƒ½è¢«è½¬ä¹‰ï¼Œä¸å†è¢«æµè§ˆå™¨æ‰§è¡Œï¼Œè€Œä¸”æœç´¢è¯èƒ½å¤Ÿå®Œç¾çš„åœ¨é¡µé¢æ˜¾ç¤ºå‡ºæ¥ã€‚</p>
<h2 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h2><p>å‚è€ƒ: <a href="https://tech.meituan.com/2018/10/11/fe-security-csrf.html" target="_blank" rel="noopener">https://tech.meituan.com/2018/10/11/fe-security-csrf.html</a></p>
<p>CSRFï¼ˆCross-site request forgeryï¼‰è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼šæ”»å‡»è€…è¯±å¯¼å—å®³è€…è¿›å…¥ç¬¬ä¸‰æ–¹ç½‘ç«™ï¼Œåœ¨ç¬¬ä¸‰æ–¹ç½‘ç«™ä¸­ï¼Œå‘è¢«æ”»å‡»ç½‘ç«™å‘é€è·¨ç«™è¯·æ±‚ã€‚åˆ©ç”¨å—å®³è€…åœ¨è¢«æ”»å‡»ç½‘ç«™å·²ç»è·å–çš„æ³¨å†Œå‡­è¯ï¼Œç»•è¿‡åå°çš„ç”¨æˆ·éªŒè¯ï¼Œè¾¾åˆ°å†’å……ç”¨æˆ·å¯¹è¢«æ”»å‡»çš„ç½‘ç«™æ‰§è¡ŒæŸé¡¹æ“ä½œçš„ç›®çš„ã€‚</p>
<p>ä¸€ä¸ªå…¸å‹çš„CSRFæ”»å‡»æœ‰ç€å¦‚ä¸‹çš„æµç¨‹ï¼š</p>
<p>1) å—å®³è€…ç™»å½•a.comï¼Œå¹¶ä¿ç•™äº†ç™»å½•å‡­è¯ï¼ˆCookieï¼‰ã€‚<br>2) æ”»å‡»è€…å¼•è¯±å—å®³è€…è®¿é—®äº†b.comã€‚<br>3) b.com å‘ a.com å‘é€äº†ä¸€ä¸ªè¯·æ±‚ï¼ša.com/act=xxã€‚æµè§ˆå™¨ä¼šé»˜è®¤æºå¸¦a.comçš„Cookieã€‚<br>4) a.comæ¥æ”¶åˆ°è¯·æ±‚åï¼Œå¯¹è¯·æ±‚è¿›è¡ŒéªŒè¯ï¼Œå¹¶ç¡®è®¤æ˜¯å—å®³è€…çš„å‡­è¯ï¼Œè¯¯ä»¥ä¸ºæ˜¯å—å®³è€…è‡ªå·±å‘é€çš„è¯·æ±‚ã€‚<br>5) a.comä»¥å—å®³è€…çš„åä¹‰æ‰§è¡Œäº†act=xxã€‚<br>6) æ”»å‡»å®Œæˆï¼Œæ”»å‡»è€…åœ¨å—å®³è€…ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ï¼Œå†’å……å—å®³è€…ï¼Œè®©a.comæ‰§è¡Œäº†è‡ªå·±å®šä¹‰çš„æ“ä½œã€‚</p>
<h3 id="CSRF-çš„ç‰¹ç‚¹"><a href="#CSRF-çš„ç‰¹ç‚¹" class="headerlink" title="CSRF çš„ç‰¹ç‚¹"></a>CSRF çš„ç‰¹ç‚¹</h3><ul>
<li>æ”»å‡»ä¸€èˆ¬å‘èµ·åœ¨ç¬¬ä¸‰æ–¹ç½‘ç«™ï¼Œè€Œä¸æ˜¯è¢«æ”»å‡»çš„ç½‘ç«™ã€‚è¢«æ”»å‡»çš„ç½‘ç«™æ— æ³•é˜²æ­¢æ”»å‡»å‘ç”Ÿã€‚</li>
<li>æ”»å‡»åˆ©ç”¨å—å®³è€…åœ¨è¢«æ”»å‡»ç½‘ç«™çš„ç™»å½•å‡­è¯ï¼Œå†’å……å—å®³è€…æäº¤æ“ä½œï¼›è€Œä¸æ˜¯ç›´æ¥çªƒå–æ•°æ®ã€‚</li>
<li>æ•´ä¸ªè¿‡ç¨‹æ”»å‡»è€…å¹¶ä¸èƒ½è·å–åˆ°å—å®³è€…çš„ç™»å½•å‡­è¯ï¼Œä»…ä»…æ˜¯ â€œå†’ç”¨â€ã€‚</li>
<li>è·¨ç«™è¯·æ±‚å¯ä»¥ç”¨å„ç§æ–¹å¼ï¼šå›¾ç‰‡ URLã€è¶…é“¾æ¥ã€CORSã€Form æäº¤ç­‰ç­‰ã€‚éƒ¨åˆ†è¯·æ±‚æ–¹å¼å¯ä»¥ç›´æ¥åµŒå…¥åœ¨ç¬¬ä¸‰æ–¹è®ºå›ã€æ–‡ç« ä¸­ï¼Œéš¾ä»¥è¿›è¡Œè¿½è¸ªã€‚</li>
</ul>
<p>CSRF é€šå¸¸æ˜¯è·¨åŸŸçš„ï¼Œå› ä¸ºå¤–åŸŸé€šå¸¸æ›´å®¹æ˜“è¢«æ”»å‡»è€…æŒæ§ã€‚ä½†æ˜¯å¦‚æœæœ¬åŸŸä¸‹æœ‰å®¹æ˜“è¢«åˆ©ç”¨çš„åŠŸèƒ½ï¼Œæ¯”å¦‚å¯ä»¥å‘å›¾å’Œé“¾æ¥çš„è®ºå›å’Œè¯„è®ºåŒºï¼Œæ”»å‡»å¯ä»¥ç›´æ¥åœ¨æœ¬åŸŸä¸‹è¿›è¡Œï¼Œè€Œä¸”è¿™ç§æ”»å‡»æ›´åŠ å±é™©ã€‚</p>
<h3 id="é˜²æŠ¤ç­–ç•¥"><a href="#é˜²æŠ¤ç­–ç•¥" class="headerlink" title="é˜²æŠ¤ç­–ç•¥"></a>é˜²æŠ¤ç­–ç•¥</h3><p>CSRF é€šå¸¸ä»ç¬¬ä¸‰æ–¹ç½‘ç«™å‘èµ·ï¼Œè¢«æ”»å‡»çš„ç½‘ç«™æ— æ³•é˜²æ­¢æ”»å‡»å‘ç”Ÿï¼Œåªèƒ½é€šè¿‡å¢å¼ºè‡ªå·±ç½‘ç«™é’ˆå¯¹ CSRF çš„é˜²æŠ¤èƒ½åŠ›æ¥æå‡å®‰å…¨æ€§ã€‚</p>
<p>ä¸Šæ–‡ä¸­è®²äº† CSRF çš„ä¸¤ä¸ªç‰¹ç‚¹ï¼š</p>
<ul>
<li>CSRFï¼ˆé€šå¸¸ï¼‰å‘ç”Ÿåœ¨ç¬¬ä¸‰æ–¹åŸŸåã€‚</li>
<li>CSRF æ”»å‡»è€…ä¸èƒ½è·å–åˆ° Cookie ç­‰ä¿¡æ¯ï¼Œåªæ˜¯ä½¿ç”¨ã€‚</li>
</ul>
<p>é’ˆå¯¹è¿™ä¸¤ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸“é—¨åˆ¶å®šé˜²æŠ¤ç­–ç•¥ï¼Œå¦‚ä¸‹ï¼š</p>
<ul>
<li>é˜»æ­¢ä¸æ˜å¤–åŸŸçš„è®¿é—®<ul>
<li><em>åŒæºæ£€æµ‹, æ£€æŸ¥Refererå­—æ®µ</em> :<br>  HTTPå¤´ä¸­æœ‰ä¸€ä¸ªRefererå­—æ®µï¼Œè¿™ä¸ªå­—æ®µç”¨ä»¥æ ‡æ˜è¯·æ±‚æ¥æºäºå“ªä¸ªåœ°å€ã€‚åœ¨å¤„ç†æ•æ„Ÿæ•°æ®è¯·æ±‚æ—¶ï¼Œé€šå¸¸æ¥è¯´ï¼ŒRefererå­—æ®µåº”å’Œè¯·æ±‚çš„åœ°å€ä½äºåŒä¸€åŸŸåä¸‹ã€‚ä»¥ä¸Šæ–‡é“¶è¡Œæ“ä½œä¸ºä¾‹ï¼ŒRefererå­—æ®µåœ°å€é€šå¸¸åº”è¯¥æ˜¯è½¬è´¦æŒ‰é’®æ‰€åœ¨çš„ç½‘é¡µåœ°å€ï¼Œåº”è¯¥ä¹Ÿä½äºwww.examplebank.comä¹‹ä¸‹ã€‚è€Œå¦‚æœæ˜¯CSRFæ”»å‡»ä¼ æ¥çš„è¯·æ±‚ï¼ŒRefererå­—æ®µä¼šæ˜¯åŒ…å«æ¶æ„ç½‘å€çš„åœ°å€ï¼Œä¸ä¼šä½äºwww.examplebank.comä¹‹ä¸‹ï¼Œè¿™æ—¶å€™æœåŠ¡å™¨å°±èƒ½è¯†åˆ«å‡ºæ¶æ„çš„è®¿é—®ã€‚<br>  è¿™ç§åŠæ³•ç®€å•æ˜“è¡Œï¼Œå·¥ä½œé‡ä½ï¼Œä»…éœ€è¦åœ¨å…³é”®è®¿é—®å¤„å¢åŠ ä¸€æ­¥æ ¡éªŒã€‚ä½†è¿™ç§åŠæ³•ä¹Ÿæœ‰å…¶å±€é™æ€§ï¼Œå› å…¶å®Œå…¨ä¾èµ–æµè§ˆå™¨å‘é€æ­£ç¡®çš„Refererå­—æ®µã€‚è™½ç„¶httpåè®®å¯¹æ­¤å­—æ®µçš„å†…å®¹æœ‰æ˜ç¡®çš„è§„å®šï¼Œä½†å¹¶æ— æ³•ä¿è¯æ¥è®¿çš„æµè§ˆå™¨çš„å…·ä½“å®ç°ï¼Œäº¦æ— æ³•ä¿è¯æµè§ˆå™¨æ²¡æœ‰å®‰å…¨æ¼æ´å½±å“åˆ°æ­¤å­—æ®µã€‚å¹¶ä¸”ä¹Ÿå­˜åœ¨æ”»å‡»è€…æ”»å‡»æŸäº›æµè§ˆå™¨ï¼Œç¯¡æ”¹å…¶Refererå­—æ®µçš„å¯èƒ½ã€‚CSRFå¤§å¤šæ•°æƒ…å†µä¸‹æ¥è‡ªç¬¬ä¸‰æ–¹åŸŸåï¼Œä½†å¹¶ä¸èƒ½æ’é™¤æœ¬åŸŸå‘èµ·ã€‚å¦‚æœæ”»å‡»è€…æœ‰æƒé™åœ¨æœ¬åŸŸå‘å¸ƒè¯„è®ºï¼ˆå«é“¾æ¥ã€å›¾ç‰‡ç­‰ï¼Œç»Ÿç§°UGCï¼‰ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥ç›´æ¥åœ¨æœ¬åŸŸå‘èµ·æ”»å‡»ï¼Œè¿™ç§æƒ…å†µä¸‹åŒæºç­–ç•¥æ— æ³•è¾¾åˆ°é˜²æŠ¤çš„ä½œç”¨ã€‚</li>
<li><em>Samesite Cookie</em> :<br>  Chrome 51å¼€å§‹ï¼Œæµè§ˆå™¨çš„Cookieæ–°å¢åŠ äº†ä¸€ä¸ªSameSiteå±æ€§ï¼Œç”¨æ¥é˜²æ­¢CSRFæ”»å‡»å’Œç”¨æˆ·è¿½è¸ªã€‚Samesiteæœ‰ä¸‰ä¸ªå¯é€‰å€¼ï¼Œåˆ†åˆ«ä¸ºStrictã€Laxã€Noneã€‚<ul>
<li>Strictï¼šæœ€ä¸¥æ ¼æ¨¡å¼ï¼Œå®Œå…¨ç¦æ­¢ç¬¬ä¸‰æ–¹Cookieï¼Œè·¨ç«™ç‚¹è®¿é—®æ—¶ï¼Œä»»ä½•æƒ…å†µä¸‹éƒ½ä¸ä¼šå‘é€Cookieã€‚æ¢è¨€ä¹‹ï¼Œåªæœ‰å½“å‰ç½‘é¡µçš„ URLä¸è¯·æ±‚ç›®æ ‡ä¸€è‡´ï¼Œæ‰ä¼šå¸¦ä¸ŠCookieã€‚æ­¤æ–¹å¼è™½ç„¶å®‰å…¨ï¼Œä½†æ˜¯å­˜åœ¨ä¸¥é‡çš„æ˜“ç”¨æ€§é—®é¢˜ï¼Œç”¨æˆ·ä»ç¬¬ä¸‰æ–¹é¡µé¢è®¿é—®ä¸€ä¸ªå·²ç™»å½•çš„ç³»ç»Ÿæ—¶ï¼Œç”±äºæœªæºå¸¦Cookieï¼Œæ€»æ˜¯éœ€è¦é‡æ–°ç™»å½•ã€‚</li>
<li>Laxï¼šChromeé»˜è®¤æ¨¡å¼ï¼Œå¯¹äºä»ç¬¬ä¸‰æ–¹ç«™ç‚¹ä»¥linkæ ‡ç­¾ï¼Œaæ ‡ç­¾ï¼ŒGETå½¢å¼çš„Formæäº¤è¿™ä¸‰ç§æ–¹å¼è®¿é—®ç›®æ ‡ç³»ç»Ÿæ—¶ï¼Œä¼šå¸¦ä¸Šç›®æ ‡ç³»ç»Ÿçš„Cookieï¼Œå¯¹äºå…¶ä»–æ–¹å¼ï¼Œå¦‚ POSTå½¢å¼çš„Formæäº¤ã€AJAXå½¢å¼çš„GETã€imgçš„srcè®¿é—®ç›®æ ‡ç³»ç»Ÿæ—¶ï¼Œä¸åˆ°Cookieã€‚</li>
<li>Noneï¼šåŸå§‹æ–¹å¼ï¼Œä»»ä½•æƒ…å†µéƒ½æäº¤ç›®æ ‡ç³»ç»Ÿçš„Cookieã€‚ç”±äºSamesiteæ˜¯Googleæå‡ºæ¥çš„ï¼Œå…¶ä»–æµè§ˆå™¨ç›®å‰å¹¶æœªæ™®åŠï¼Œå­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼Œç›®å‰ä¸æ¨èä½¿ç”¨ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>æäº¤æ—¶è¦æ±‚é™„åŠ æœ¬åŸŸæ‰èƒ½è·å–çš„ä¿¡æ¯<ul>
<li><em>CSRF Token</em> : è€ŒCSRFæ”»å‡»ä¹‹æ‰€ä»¥èƒ½å¤ŸæˆåŠŸï¼Œæ˜¯å› ä¸ºæœåŠ¡å™¨è¯¯æŠŠæ”»å‡»è€…å‘é€çš„è¯·æ±‚å½“æˆäº†ç”¨æˆ·è‡ªå·±çš„è¯·æ±‚ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¦æ±‚æ‰€æœ‰çš„ç”¨æˆ·è¯·æ±‚éƒ½æºå¸¦ä¸€ä¸ªCSRFæ”»å‡»è€…æ— æ³•è·å–åˆ°çš„Tokenã€‚æœåŠ¡å™¨é€šè¿‡æ ¡éªŒè¯·æ±‚æ˜¯å¦æºå¸¦æ­£ç¡®çš„Tokenï¼Œæ¥æŠŠæ­£å¸¸çš„è¯·æ±‚å’Œæ”»å‡»çš„è¯·æ±‚åŒºåˆ†å¼€ï¼Œä¹Ÿå¯ä»¥é˜²èŒƒCSRFçš„æ”»å‡»ã€‚<br>  1. å°†CSRF Tokenè¾“å‡ºåˆ°é¡µé¢ä¸­(è¿™ä¸ªtokenä¸å­˜åœ¨sessionä¸­, ç”¨jwtæ¥åšè¿™ä¸ªtokenå³å¯)<br>  2. é¡µé¢æäº¤çš„è¯·æ±‚æºå¸¦è¿™ä¸ªToken<br>  3. æœåŠ¡å™¨éªŒè¯Tokenæ˜¯å¦æ­£ç¡®</li>
<li><em>åŒé‡ Cookie éªŒè¯</em> :<br>  1. åœ¨ç”¨æˆ·è®¿é—®ç½‘ç«™é¡µé¢æ—¶ï¼Œå‘è¯·æ±‚åŸŸåæ³¨å…¥ä¸€ä¸ªCookieï¼Œå†…å®¹ä¸ºéšæœºå­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚csrfcookie=v8g9e4ksfhwï¼‰ã€‚<br>  2. åœ¨å‰ç«¯å‘åç«¯å‘èµ·è¯·æ±‚æ—¶ï¼Œå–å‡ºCookieï¼Œå¹¶æ·»åŠ åˆ°URLçš„å‚æ•°ä¸­ï¼ˆæ¥ä¸Šä¾‹POST <a href="https://www.a.com/comment?csrfcookie=v8g9e4ksfhwï¼‰ã€‚" target="_blank" rel="noopener">https://www.a.com/comment?csrfcookie=v8g9e4ksfhwï¼‰ã€‚</a><br>  3. åç«¯æ¥å£éªŒè¯Cookieä¸­çš„å­—æ®µä¸URLå‚æ•°ä¸­çš„å­—æ®µæ˜¯å¦ä¸€è‡´ï¼Œä¸ä¸€è‡´åˆ™æ‹’ç»ã€‚</li>
</ul>
</li>
</ul>
<h1 id="ç¼–ç çŸ¥è¯†"><a href="#ç¼–ç çŸ¥è¯†" class="headerlink" title="ç¼–ç çŸ¥è¯†"></a>ç¼–ç çŸ¥è¯†</h1><h2 id="Base64-çš„åŸç†ï¼Ÿç¼–ç åæ¯”ç¼–ç å‰æ˜¯å¤§äº†è¿˜æ˜¯å°äº†ã€‚"><a href="#Base64-çš„åŸç†ï¼Ÿç¼–ç åæ¯”ç¼–ç å‰æ˜¯å¤§äº†è¿˜æ˜¯å°äº†ã€‚" class="headerlink" title="Base64 çš„åŸç†ï¼Ÿç¼–ç åæ¯”ç¼–ç å‰æ˜¯å¤§äº†è¿˜æ˜¯å°äº†ã€‚"></a>Base64 çš„åŸç†ï¼Ÿç¼–ç åæ¯”ç¼–ç å‰æ˜¯å¤§äº†è¿˜æ˜¯å°äº†ã€‚</h2><p>ç»“è®º:</p>
<p>å¤§äº†. å› ä¸ºBase64 ç¼–ç æœ¬è´¨ä¸Šæ˜¯ä¸€ç§å°†äºŒè¿›åˆ¶æ•°æ®è½¬æˆæ–‡æœ¬æ•°æ®çš„æ–¹æ¡ˆã€‚<strong>å¯¹äºéäºŒè¿›åˆ¶æ•°æ®ï¼Œæ˜¯å…ˆå°†å…¶è½¬æ¢æˆäºŒè¿›åˆ¶å½¢å¼ï¼Œç„¶åæ¯è¿ç»­ 6 æ¯”ç‰¹ï¼ˆ2 çš„ 6 æ¬¡æ–¹ = 64ï¼‰è®¡ç®—å…¶åè¿›åˆ¶å€¼ï¼Œæ ¹æ®è¯¥å€¼åœ¨ä¸Šé¢çš„ç´¢å¼•è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„å­—ç¬¦ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªæ–‡æœ¬å­—ç¬¦ä¸²ã€‚</strong>ä¹Ÿå°±æ˜¯è¯´, æ¯ 3 ä¸ªåŸå§‹å­—ç¬¦ç¼–ç æˆ 4 ä¸ªå­—ç¬¦ï¼Œå¦‚æœåŸå§‹å­—ç¬¦ä¸²é•¿åº¦ä¸èƒ½è¢« 3 æ•´é™¤ï¼Œé‚£æ€ä¹ˆåŠï¼Ÿä½¿ç”¨ 0 å€¼æ¥è¡¥å……åŸå§‹å­—ç¬¦ä¸²ã€‚</p>
<h3 id="base64çš„åŸç†"><a href="#base64çš„åŸç†" class="headerlink" title="base64çš„åŸç†"></a>base64çš„åŸç†</h3><p>Base64 ç¼–ç ä¹‹æ‰€ä»¥ç§°ä¸º Base64ï¼Œæ˜¯å› ä¸ºå…¶ä½¿ç”¨ 64 ä¸ªå­—ç¬¦æ¥å¯¹ä»»æ„æ•°æ®è¿›è¡Œç¼–ç ï¼ŒåŒç†æœ‰ Base32ã€Base16 ç¼–ç ã€‚æ ‡å‡† Base64 ç¼–ç ä½¿ç”¨çš„ 64 ä¸ªå­—ç¬¦ä¸ºï¼š<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/http/XHFMRvxfez4OVtr.jpg" alt></p>
<p>è¿™ 64 ä¸ªå­—ç¬¦æ˜¯å„ç§å­—ç¬¦ç¼–ç ï¼ˆæ¯”å¦‚ ASCII ç¼–ç ï¼‰æ‰€ä½¿ç”¨å­—ç¬¦çš„å­é›†ï¼ŒåŸºæœ¬ï¼Œå¹¶ä¸”å¯æ‰“å°ã€‚å”¯ä¸€æœ‰ç‚¹ç‰¹æ®Šçš„æ˜¯æœ€åä¸¤ä¸ªå­—ç¬¦ï¼Œå› å¯¹æœ€åä¸¤ä¸ªå­—ç¬¦çš„é€‰æ‹©ä¸åŒï¼ŒBase64 ç¼–ç åˆæœ‰å¾ˆå¤šå˜ç§ï¼Œæ¯”å¦‚ Base64 URL ç¼–ç ã€‚</p>
<p>Base64 ç¼–ç æœ¬è´¨ä¸Šæ˜¯ä¸€ç§å°†äºŒè¿›åˆ¶æ•°æ®è½¬æˆæ–‡æœ¬æ•°æ®çš„æ–¹æ¡ˆã€‚å¯¹äºéäºŒè¿›åˆ¶æ•°æ®ï¼Œæ˜¯å…ˆå°†å…¶è½¬æ¢æˆäºŒè¿›åˆ¶å½¢å¼ï¼Œç„¶åæ¯è¿ç»­ 6 æ¯”ç‰¹ï¼ˆ2 çš„ 6 æ¬¡æ–¹ = 64ï¼‰è®¡ç®—å…¶åè¿›åˆ¶å€¼ï¼Œæ ¹æ®è¯¥å€¼åœ¨ä¸Šé¢çš„ç´¢å¼•è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„å­—ç¬¦ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªæ–‡æœ¬å­—ç¬¦ä¸²ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬è¦å¯¹ <code>Hello!</code> è¿›è¡Œ Base64 ç¼–ç ï¼ŒæŒ‰ç…§ ASCII è¡¨ï¼Œå…¶è½¬æ¢è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/http/tJnClQsjc4WMGhB.jpg" alt></p>
<p>å¯çŸ¥ <code>Hello!</code> çš„ Base64 ç¼–ç ç»“æœä¸º <code>SGVsbG8h</code> ï¼ŒåŸå§‹å­—ç¬¦ä¸²é•¿åº¦ä¸º 6 ä¸ªå­—ç¬¦ï¼Œç¼–ç åé•¿åº¦ä¸º 8 ä¸ªå­—ç¬¦ï¼Œæ¯ 3 ä¸ªåŸå§‹å­—ç¬¦ç» Base64 ç¼–ç æˆ 4 ä¸ªå­—ç¬¦ï¼Œç¼–ç å‰åé•¿åº¦æ¯” 4/3ï¼Œè¿™ä¸ªé•¿åº¦æ¯”å¾ˆé‡è¦ - æ¯”åŸå§‹å­—ç¬¦ä¸²é•¿åº¦çŸ­ï¼Œåˆ™éœ€è¦ä½¿ç”¨æ›´å¤§çš„ç¼–ç å­—ç¬¦é›†ï¼Œè¿™å¹¶ä¸æˆ‘ä»¬æƒ³è¦çš„ï¼›é•¿åº¦æ¯”è¶Šå¤§ï¼Œåˆ™éœ€è¦ä¼ è¾“è¶Šå¤šçš„å­—ç¬¦ï¼Œä¼ è¾“æ—¶é—´è¶Šé•¿ã€‚Base64 åº”ç”¨å¹¿æ³›çš„åŸå› æ˜¯åœ¨å­—ç¬¦é›†å¤§å°ä¸é•¿åº¦æ¯”ä¹‹é—´å–å¾—ä¸€ä¸ªè¾ƒå¥½çš„å¹³è¡¡ï¼Œé€‚ç”¨äºå„ç§åœºæ™¯ã€‚</p>
<p>æ˜¯ä¸æ˜¯è§‰å¾— Base64 ç¼–ç åŸç†å¾ˆç®€å•ï¼Ÿ</p>
<p>ä½†è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸ªç‚¹ï¼šBase64 ç¼–ç æ˜¯æ¯ 3 ä¸ªåŸå§‹å­—ç¬¦ç¼–ç æˆ 4 ä¸ªå­—ç¬¦ï¼Œå¦‚æœåŸå§‹å­—ç¬¦ä¸²é•¿åº¦ä¸èƒ½è¢« 3 æ•´é™¤ï¼Œé‚£æ€ä¹ˆåŠï¼Ÿä½¿ç”¨ 0 å€¼æ¥è¡¥å……åŸå§‹å­—ç¬¦ä¸²ã€‚</p>
<p>ä»¥ <code>Hello!!</code> ä¸ºä¾‹ï¼Œå…¶è½¬æ¢è¿‡ç¨‹ä¸ºï¼š<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/http/5URB8nVis9ljwYe.jpg" alt></p>
<p><em>æ³¨ï¼šå›¾è¡¨ä¸­è“è‰²èƒŒæ™¯çš„äºŒè¿›åˆ¶ 0 å€¼æ˜¯é¢å¤–è¡¥å……çš„ã€‚</em></p>
<p><code>Hello!!</code> Base64 ç¼–ç çš„ç»“æœä¸º <code>SGVsbG8hIQAA</code> ã€‚æœ€å 2 ä¸ªé›¶å€¼åªæ˜¯ä¸ºäº† Base64 ç¼–ç è€Œè¡¥å……çš„ï¼Œåœ¨åŸå§‹å­—ç¬¦ä¸­å¹¶æ²¡æœ‰å¯¹åº”çš„å­—ç¬¦ï¼Œé‚£ä¹ˆ Base64 ç¼–ç ç»“æœä¸­çš„æœ€åä¸¤ä¸ªå­—ç¬¦ <code>AA</code> å®é™…ä¸å¸¦æœ‰æ•ˆä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œä»¥å…è§£ç é”™è¯¯ã€‚</p>
<p>æ ‡å‡† Base64 ç¼–ç é€šå¸¸ç”¨ <code>=</code> å­—ç¬¦æ¥æ›¿æ¢æœ€åçš„ <code>A</code>ï¼Œå³ç¼–ç ç»“æœä¸º <code>SGVsbG8hIQ==</code>ã€‚å› ä¸º <code>=</code> å­—ç¬¦å¹¶ä¸åœ¨ Base64 ç¼–ç ç´¢å¼•è¡¨ä¸­ï¼Œå…¶æ„ä¹‰åœ¨äºç»“æŸç¬¦å·ï¼Œåœ¨ Base64 è§£ç æ—¶é‡åˆ° <code>=</code> æ—¶å³å¯çŸ¥é“ä¸€ä¸ª Base64 ç¼–ç å­—ç¬¦ä¸²ç»“æŸã€‚</p>
<p>å¦‚æœ Base64 ç¼–ç å­—ç¬¦ä¸²ä¸ä¼šç›¸äº’æ‹¼æ¥å†ä¼ è¾“ï¼Œé‚£ä¹ˆæœ€åçš„ <code>=</code> ä¹Ÿå¯ä»¥çœç•¥ï¼Œè§£ç æ—¶å¦‚æœå‘ç° Base64 ç¼–ç å­—ç¬¦ä¸²é•¿åº¦ä¸èƒ½è¢« 4 æ•´é™¤ï¼Œåˆ™å…ˆè¡¥å…… <code>=</code> å­—ç¬¦ï¼Œå†è§£ç å³å¯ã€‚</p>
<p>è§£ç æ˜¯å¯¹ç¼–ç çš„é€†å‘æ“ä½œï¼Œä½†æ³¨æ„ä¸€ç‚¹ï¼š<strong>å¯¹äºæœ€åçš„ä¸¤ä¸ª <code>=</code> å­—ç¬¦ï¼Œè½¬æ¢æˆä¸¤ä¸ª <code>A</code> å­—ç¬¦ï¼Œå†è½¬æˆå¯¹åº”çš„ä¸¤ä¸ª 6 æ¯”ç‰¹äºŒè¿›åˆ¶ 0 å€¼ï¼Œæ¥ç€è½¬æˆåŸå§‹å­—ç¬¦ä¹‹å‰ï¼Œéœ€è¦å°†æœ€åçš„ä¸¤ä¸ª 6 æ¯”ç‰¹äºŒè¿›åˆ¶ 0 å€¼ä¸¢å¼ƒï¼Œå› ä¸ºå®ƒä»¬å®é™…ä¸Šä¸æºå¸¦æœ‰æ•ˆä¿¡æ¯</strong>ã€‚</p>
<h2 id="utf8ç¼–ç å’Œunicodeå­—ç¬¦é›†"><a href="#utf8ç¼–ç å’Œunicodeå­—ç¬¦é›†" class="headerlink" title="utf8ç¼–ç å’Œunicodeå­—ç¬¦é›†"></a>utf8ç¼–ç å’Œunicodeå­—ç¬¦é›†</h2><p>æ€»ç»“:  </p>
<ul>
<li>unicodeæ˜¯ä¸ªå­—ç¬¦é›†, åªæ˜¯ä¸€ä¸ªç¬¦å·å¯¹åº”è¡¨, å®ƒåªè§„å®šäº†ç¬¦å·çš„äºŒè¿›åˆ¶ä»£ç ï¼Œå´æ²¡æœ‰è§„å®šè¿™ä¸ªäºŒè¿›åˆ¶ä»£ç åº”è¯¥å¦‚ä½•å­˜å‚¨</li>
<li>utf8æ˜¯unicodeç¬¦å·å…·ä½“çš„ç¼–ç æ–¹å¼, è§„å®šäº†è¯¥æ€ä¹ˆå­˜å‚¨</li>
</ul>
<p>è¯´åˆ°utf8ï¼Œå°±ä¸å¾—ä¸è¯´ä¸€ä¸‹unicodeäº†ã€‚  Unicodeæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„é›†åˆï¼Œæ¯ä¸€ä¸ªunicodeå¯¹åº”ä¸€ä¸ªç¬¦å·ï¼Œä¸ç®¡æ˜¯ä¸­æ–‡çš„æ±‰å­—ï¼Œè‹±æ–‡å­—ç¬¦ï¼Œæ—¥æ–‡ï¼ŒéŸ©æ–‡ç­‰ç­‰ã€‚ç°åœ¨çš„è§„æ¨¡å¯ä»¥å®¹çº³100å¤šä¸‡ä¸ªç¬¦å·ã€‚æ¯ä¸ªç¬¦å·çš„ç¼–ç éƒ½ä¸ä¸€æ ·ï¼Œæ¯”å¦‚ï¼ŒU+0639è¡¨ç¤ºé˜¿æ‹‰ä¼¯å­—æ¯ Ainï¼ŒU+0041è¡¨ç¤ºè‹±è¯­çš„å¤§å†™å­—æ¯Aï¼ŒU+4E25è¡¨ç¤ºæ±‰å­—â€œä¸¥â€ã€‚å…·ä½“çš„ç¬¦å·å¯¹åº”è¡¨ï¼Œå¯ä»¥æŸ¥è¯¢unicode.orgï¼Œæˆ–è€…ä¸“é—¨çš„æ±‰å­—å¯¹åº”è¡¨ã€‚</p>
<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒUnicodeåªæ˜¯ä¸€ä¸ªç¬¦å·é›†ï¼Œå®ƒåªè§„å®šäº†ç¬¦å·çš„äºŒè¿›åˆ¶ä»£ç ï¼Œå´æ²¡æœ‰è§„å®šè¿™ä¸ªäºŒè¿›åˆ¶ä»£ç åº”è¯¥å¦‚ä½•å­˜å‚¨ã€‚</strong></p>
<p>æ¯”å¦‚ï¼Œæ±‰å­—â€œä¸¥â€çš„unicodeæ˜¯åå…­è¿›åˆ¶æ•°4E25ï¼Œè½¬æ¢æˆäºŒè¿›åˆ¶æ•°è¶³è¶³æœ‰15ä½ï¼ˆ100111000100101ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªç¬¦å·çš„è¡¨ç¤ºè‡³å°‘éœ€è¦2ä¸ªå­—èŠ‚ã€‚è¡¨ç¤ºå…¶ä»–æ›´å¤§çš„ç¬¦å·ï¼Œå¯èƒ½éœ€è¦3ä¸ªå­—èŠ‚æˆ–è€…4ä¸ªå­—èŠ‚ï¼Œç”šè‡³æ›´å¤šã€‚</p>
<p>è¿™é‡Œå°±æœ‰ä¸¤ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šå¦‚ä½•æ‰èƒ½åŒºåˆ«unicodeå’Œasciiï¼Ÿè®¡ç®—æœºæ€ä¹ˆçŸ¥é“ä¸‰ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªç¬¦å·ï¼Œè€Œä¸æ˜¯åˆ†åˆ«è¡¨ç¤ºä¸‰ä¸ªç¬¦å·å‘¢ï¼Ÿç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼šæˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œè‹±æ–‡å­—æ¯åªç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºå°±å¤Ÿäº†ï¼Œå¦‚æœunicodeç»Ÿä¸€è§„å®šï¼Œæ¯ä¸ªç¬¦å·ç”¨ä¸‰ä¸ªæˆ–å››ä¸ªå­—èŠ‚è¡¨ç¤ºï¼Œé‚£ä¹ˆæ¯ä¸ªè‹±æ–‡å­—æ¯å‰éƒ½å¿…ç„¶æœ‰äºŒåˆ°ä¸‰ä¸ªå­—èŠ‚æ˜¯0ï¼Œè¿™å¯¹äºå­˜å‚¨æ¥è¯´æ˜¯æå¤§çš„æµªè´¹ï¼Œæ–‡æœ¬æ–‡ä»¶çš„å¤§å°ä¼šå› æ­¤å¤§å‡ºäºŒä¸‰å€ï¼Œè¿™æ˜¯æ— æ³•æ¥å—çš„ã€‚</p>
<p>å®ƒä»¬é€ æˆçš„ç»“æœæ˜¯ï¼š</p>
<p>1ï¼‰å‡ºç°äº†unicodeçš„å¤šç§å­˜å‚¨æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰è®¸å¤šç§ä¸åŒçš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºunicodeã€‚</p>
<p>2ï¼‰unicodeåœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…æ— æ³•æ¨å¹¿ï¼Œç›´åˆ°äº’è”ç½‘çš„å‡ºç°ã€‚</p>
<h3 id="UTF-8"><a href="#UTF-8" class="headerlink" title="UTF-8"></a>UTF-8</h3><p>äº’è”ç½‘çš„æ™®åŠï¼Œå¼ºçƒˆè¦æ±‚å‡ºç°ä¸€ç§ç»Ÿä¸€çš„ç¼–ç æ–¹å¼ã€‚UTF-8å°±æ˜¯åœ¨äº’è”ç½‘ä¸Šä½¿ç”¨æœ€å¹¿çš„ä¸€ç§unicodeçš„å®ç°æ–¹å¼ã€‚å…¶ä»–å®ç°æ–¹å¼è¿˜åŒ…æ‹¬UTF-16å’ŒUTF-32ï¼Œä¸è¿‡åœ¨äº’è”ç½‘ä¸ŠåŸºæœ¬ä¸ç”¨ã€‚é‡å¤ä¸€éï¼Œè¿™é‡Œçš„å…³ç³»æ˜¯ï¼ŒUTF-8æ˜¯Unicodeçš„å®ç°æ–¹å¼ä¹‹ä¸€ã€‚</p>
<p>UTF-8æœ€å¤§çš„ä¸€ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯å®ƒæ˜¯ä¸€ç§å˜é•¿çš„ç¼–ç æ–¹å¼ã€‚å®ƒå¯ä»¥ä½¿ç”¨1~4ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªç¬¦å·ï¼Œæ ¹æ®ä¸åŒçš„ç¬¦å·è€Œå˜åŒ–å­—èŠ‚é•¿åº¦ã€‚</p>
<p>UTF-8çš„ç¼–ç è§„åˆ™å¾ˆç®€å•ï¼Œåªæœ‰äºŒæ¡ï¼š</p>
<ul>
<li><p>1ï¼‰å¯¹äºå•å­—èŠ‚çš„ç¬¦å·ï¼Œå­—èŠ‚çš„ç¬¬ä¸€ä½ï¼ˆå­—èŠ‚çš„æœ€é«˜ä½ï¼‰è®¾ä¸º0ï¼Œåé¢7ä½ä¸ºè¿™ä¸ªç¬¦å·çš„unicodeç ã€‚å› æ­¤å¯¹äºè‹±è¯­å­—æ¯ï¼ŒUTF-8ç¼–ç å’ŒASCIIç æ˜¯ç›¸åŒçš„ã€‚</p>
</li>
<li><p>2ï¼‰å¯¹äºnå­—èŠ‚çš„ç¬¦å·ï¼ˆn&gt;1ï¼‰ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚çš„å‰nä½éƒ½è®¾ä¸º1ï¼Œç¬¬n+1ä½è®¾ä¸º0ï¼Œåé¢å­—èŠ‚çš„å‰ä¸¤ä½ä¸€å¾‹è®¾ä¸º10ã€‚å‰©ä¸‹çš„æ²¡æœ‰æåŠçš„äºŒè¿›åˆ¶ä½ï¼Œå…¨éƒ¨ä¸ºè¿™ä¸ªç¬¦å·çš„unicodeç ã€‚</p>
</li>
</ul>
<p>ä¸‹è¡¨æ€»ç»“äº†ç¼–ç è§„åˆ™ï¼Œå­—æ¯xè¡¨ç¤ºå¯ç”¨ç¼–ç çš„ä½ã€‚</p>
<p>Unicodeç¬¦å·èŒƒå›´ UTF-8ç¼–ç æ–¹å¼(åå…­è¿›åˆ¶) | ï¼ˆäºŒè¿›åˆ¶ï¼‰<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">â€”â€”â€”â€”â€”+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span><br><span class="line">0000 0000-0000 007F | 0xxxxxxx</span><br><span class="line">0000 0080-0000 07FF | 110xxxxx 10xxxxxx</span><br><span class="line">0000 0800-0000 FFFF | 1110xxxx 10xxxxxx 10xxxxxx</span><br><span class="line">0001 0000-0010 FFFF | 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx</span><br></pre></td></tr></table></figure></p>
<p>ä¸‹é¢ï¼Œè¿˜æ˜¯ä»¥æ±‰å­—â€œä¸¥â€ä¸ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•å®ç°UTF-8ç¼–ç ï¼š<br>å·²çŸ¥â€œä¸¥â€çš„unicodeæ˜¯4E25ï¼ˆ100111000100101ï¼‰ï¼Œæ ¹æ®ä¸Šè¡¨ï¼Œå¯ä»¥å‘ç°4E25å¤„åœ¨ç¬¬ä¸‰è¡Œçš„èŒƒå›´å†…ï¼ˆ0000 0800-0000 FFFFï¼‰ï¼Œå› æ­¤â€œä¸¥â€çš„UTF-8ç¼–ç éœ€è¦ä¸‰ä¸ªå­—èŠ‚ï¼Œå³æ ¼å¼æ˜¯â€œ1110xxxx 10xxxxxx 10xxxxxxâ€ã€‚ç„¶åï¼Œä»â€œä¸¥â€çš„æœ€åä¸€ä¸ªäºŒè¿›åˆ¶ä½å¼€å§‹ï¼Œä¾æ¬¡ä»åå‘å‰å¡«å…¥æ ¼å¼ä¸­çš„xï¼Œå¤šå‡ºçš„ä½è¡¥0ã€‚è¿™æ ·å°±å¾—åˆ°äº†ï¼Œâ€œä¸¥â€çš„UTF-8ç¼–ç æ˜¯â€œ11100100 10111000 10100101â€ï¼Œè½¬æ¢æˆåå…­è¿›åˆ¶å°±æ˜¯E4B8A5ã€‚</p>
<h1 id="QUIC"><a href="#QUIC" class="headerlink" title="QUIC"></a>QUIC</h1><p>QUICçš„é€šè®¯è¿‡ç¨‹åœ¨åˆæ¬¡æ²¡æœ‰å»ºç«‹è¿‡è¿æ¥æ—¶ä½¿ç”¨1-RTTçš„æ¡æ‰‹æœºåˆ¶ï¼ŒåŒæ—¶ä¿è¯è¿æ¥çš„å»ºç«‹å’Œè¾¾åˆ°å®‰å…¨çš„ä¿éšœã€‚ä»¥ä¸‹æ˜¯QUICçš„1-RTTçš„æ¡æ‰‹è¿‡ç¨‹ï¼š</p>
<ol>
<li>Serverç«¯ä¼šæŒæœ‰0-RTTå…¬ç§é’¥å¯¹ï¼Œå¹¶ä¸”ç”ŸæˆSCFGï¼ˆæœåŠ¡ç«¯çš„é…ç½®ä¿¡æ¯å¯¹è±¡ï¼‰ï¼ŒæŠŠå…¬é’¥æ”¾å…¥SCFGä¸­ï¼›</li>
<li>å®¢æˆ·ç«¯åˆæ¬¡è¯·æ±‚æ—¶ï¼Œéœ€è¦å‘æœåŠ¡ç«¯è·å–0-RTTå…¬é’¥ï¼Œè¿™ä¸ªéœ€è¦æ¶ˆè€—ä¸€ä¸ªRTTï¼Œè¿™ä¹ŸQUICçš„1-RTTçš„æ‰€åœ¨ï¼›</li>
<li>å®¢æˆ·ç«¯åœ¨æ”¶åˆ°0-RTTå…¬é’¥ä»¥åä¼šç¼“å­˜èµ·æ¥ï¼ŒåŒæ—¶ç”Ÿæˆè‡ªå·±çš„ä¸´æ—¶å…¬ç§é’¥å¯¹ï¼Œç»è¿‡å‰é¢çš„ä¸€ä¸ªRTTåå®¢æˆ·ç«¯æŠŠè‡ªå·±çš„ä¸´æ—¶ç§é’¥ä¸æœåŠ¡ç«¯å‘è¿‡æ¥çš„0-RTTçš„å…¬é’¥æ ¹æ®DHç®—æ³•ç”Ÿæˆä¸€ä¸ªåŠ å¯†å¯†é’¥K1ï¼ŒåŒæ—¶ä½¿ç”¨K1åŠ å¯†æ•°æ®åŒæ—¶é™„é€è‡ªå·±çš„ä¸´æ—¶å…¬é’¥ä¸€èµ·å‘é€æœåŠ¡ç«¯ï¼Œæ­¤æ—¶å·²æœ‰ç”¨æˆ·æ•°æ®å‘é€ï¼›</li>
<li>åœ¨æœåŠ¡ç«¯æ”¶åˆ°ç”¨æˆ·ä½¿ç”¨K1åŠ å¯†çš„ç”¨æˆ·æ•°æ®å’Œå®¢æˆ·ç«¯å‘æ¥çš„ä¸´æ—¶å…¬é’¥ä»¥åï¼Œä¼šåšå¦‚ä¸‹å‡ ä»¶äº‹ï¼š</li>
<li>ä½¿ç”¨0-RTTç§é’¥ä¸å®¢æˆ·ç«¯å‘æ¥çš„ä¸´æ—¶å…¬é’¥é€šè¿‡DHç®—æ³•ç”ŸæˆK1è§£å¯†ç”¨æˆ·æ•°æ®å¹¶é€’äº¤åˆ°åº”ç”¨ï¼›</li>
<li>ç”ŸæˆæœåŠ¡ç«¯ä¸´æ—¶å…¬ç§é’¥å¯¹ï¼Œä½¿ç”¨ä¸´æ—¶å…¬ç§é’¥å¯¹çš„ç§é’¥ï¼Œä¸å®¢æˆ·ç«¯å‘æ¥çš„å®¢æˆ·ç«¯ä¸´æ—¶å…¬é’¥ï¼Œç”ŸæˆK2åŠ å¯†æœåŠ¡ç«¯è¦ä¼ è¾“çš„æ•°æ®</li>
<li>æŠŠæœåŠ¡ç«¯çš„ä¸´æ—¶å…¬é’¥å’Œä½¿ç”¨K2åŠ å¯†çš„åº”ç”¨æ•°æ®å‘é€åˆ°å®¢æˆ·ç«¯</li>
<li>å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯å‘é€çš„æœåŠ¡ç«¯ä¸´æ—¶å…¬é’¥å’Œä½¿ç”¨K2åŠ å¯†çš„åº”ç”¨æ•°æ®åä¼šå†æ¬¡ä½¿ç”¨DHç®—æ³•æŠŠæœåŠ¡ç«¯çš„ä¸´æ—¶å…¬é’¥å’Œå®¢æˆ·ç«¯åŸæ¥çš„ä¸´æ—¶ç§é’¥é‡æ–°ç”ŸæˆK2è§£å¯†æ•°æ®ï¼Œå¹¶ä¸”ä»æ­¤ä»¥åä½¿ç”¨K2è¿›è¡Œæ•°æ®å±‚çš„åŠ è§£å¯†</li>
</ol>
<p>å¤‡æ³¨ï¼šè¿™é‡ŒæœåŠ¡ç«¯ä¸ºä»€ä¹ˆè¦é‡æ–°å†ç”Ÿæˆä¸´æ—¶å…¬ç§é’¥å¯¹å†ä½¿ç”¨DHç®—æ³•æ¥ç”ŸæˆåŠ å¯†å¯†é’¥K2å‘¢ï¼Ÿ</p>
<p>å…¶æ ¸å¿ƒè€ƒè™‘åˆ°çš„æ˜¯å®‰å…¨æ€§ï¼Œå¦‚æœæ²¡æœ‰æœåŠ¡ç«¯çš„ä¸´æ—¶å…¬ç§é’¥å’ŒK2ï¼Œé‚£ä¹ˆåœ¨é€šè®¯è¿‡ç¨‹ä¸­ä½¿ç”¨çš„K1æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºæœåŠ¡ç«¯çš„SCFGä¸­çš„0-RTTå…¬ç§é’¥æ˜¯å¯¹æ‰€æœ‰å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”é•¿æœŸä¿æŒç›´åˆ°è¿‡æœŸï¼Œè€Œä¸”è¿™ä¸ªè¿‡æœŸæ—¶é—´ä¸€èˆ¬ä¼šæ¯”è¾ƒé•¿ã€‚ä¸€æ—¦æœåŠ¡ç«¯çš„0-RTTç§é’¥æ³„éœ²åˆ™æ‰€æœ‰å®¢æˆ·ç«¯çš„é€šè®¯éƒ½æ— æ³•ç¡®ä¿å‰å‘å®‰å…¨æ€§äº†ã€‚æ”»å‡»è€…åªéœ€è¦æŠŠåŒ…æŠ“ä¸‹æ¥ï¼Œè·å–åˆ°0-RTTç§é’¥å³å¯ç ´è§£æ‰€æœ‰é€šè®¯æ•°æ®ã€‚</p>
<h2 id="QUICæ¡æ‰‹æµç¨‹å›¾"><a href="#QUICæ¡æ‰‹æµç¨‹å›¾" class="headerlink" title="QUICæ¡æ‰‹æµç¨‹å›¾"></a>QUICæ¡æ‰‹æµç¨‹å›¾</h2><p>QUICçš„0-RTTæ¡æ‰‹æ•ˆç‡æå¤§æå‡<br>0-RTTæ˜¯QUICä¸€ä¸ªå¾ˆå…³é”®çš„å±æ€§ï¼Œèƒ½å¤Ÿåœ¨è¿æ¥çš„ç¬¬ä¸€ä¸ªæ•°æ®æŠ¥æ–‡å°±å¯ä»¥æºå¸¦ç”¨æˆ·æ•°æ®ã€‚ä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°å¦‚æœå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä»æ¥æ²¡æœ‰é€šè®¯è¿‡ï¼Œé‚£ä¹ˆæ˜¯ä¸å­˜åœ¨0-RTTçš„ï¼Œéœ€è¦ä¸€ä¸ªå®Œæˆçš„RTTä¹‹åæ‰èƒ½æ‰¿è½½ç”¨æˆ·æ•°æ®ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/quic/quic_1.jpg" alt></p>
<p>è¿™ä¸ªæ˜¯QUICçš„1-RTTè¿‡ç¨‹ï¼Œé‚£ä¹ˆä»–çš„0-RTTåˆæ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿå…¶å®å¾ˆæ˜æ˜¾ï¼Œå®¢æˆ·ç«¯æŠŠ0-RTTçš„æ¡æ‰‹å…¬é’¥å’Œç›¸å…³ä¿¡æ¯ä¿å­˜èµ·æ¥ï¼Œåç»­å†å»ºè¿æ¥çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ä¹‹å‰ä¿å­˜çš„æ•°æ®äº†ï¼Œåªè¦è¿™ä¸ªæ•°æ®æ²¡æœ‰è¿‡æœŸï¼ŒæœåŠ¡ç«¯éƒ½ä¼šæ‰¿è®¤çš„ã€‚å› æ­¤å¯ä»¥é¿å…æ‰å…¬é’¥å‘é€çš„è¿™ä¸€ä¸ªRTTï¼Œç›´æ¥ç”ŸæˆK1åŠ å¯†ç”¨æˆ·æ•°æ®ä¼ è¾“ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/quic/quic_2.jpg" alt></p>
<h2 id="QUICå¦‚ä½•é˜²æ­¢ä¸­é—´äººæ”»å‡»"><a href="#QUICå¦‚ä½•é˜²æ­¢ä¸­é—´äººæ”»å‡»" class="headerlink" title="QUICå¦‚ä½•é˜²æ­¢ä¸­é—´äººæ”»å‡»"></a>QUICå¦‚ä½•é˜²æ­¢ä¸­é—´äººæ”»å‡»</h2><p>ä»å‰é¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°SCFGçš„é‡è¦æ€§éå¸¸å…³é”®ï¼Œåœ¨0-RTTçš„åœºæ™¯å®Œå…¨ä¾é è¿™ä¸ªæ•°æ®æ¥è·å¾—0-RTTæ¡æ‰‹å…¬é’¥ï¼Œè€Œä¸”éœ€è¦åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¼ è¾“æµè½¬ã€‚é‚£ä¹ˆå®ƒçš„å®‰å…¨å¯ä¿¡å°±éå¸¸é‡è¦ï¼ŒQUICæ˜¯å¦‚ä½•ä¿éšœå‘¢ï¼Œå¦‚ä½•é˜²æ­¢ä¸­é—´äººæ”»å‡»å‘¢ï¼Œæ˜¯å¦ä¼šå¸¦æ¥å…¶ä»–å®‰å…¨é£é™©ï¼Ÿ</p>
<ul>
<li>åœ¨QUICä¸­ç»™è¿™ä¸ªæ•°æ®å¢åŠ äº†ä¸€ä¸ªç­¾åæœºåˆ¶ï¼Œç­¾åæ˜¯é€šè¿‡å…¬æœ‰è¯ä¹¦çš„ç§é’¥æ¥ç­¾çš„ï¼Œåœ¨å®¢æˆ·ç«¯éœ€è¦å¯¹è¯ä¹¦è¿›è¡Œè®¤è¯ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿æ— æ³•å®ç°ä¸­é—´äººæ”»å‡», ç±»ä¼¼HTTPS</li>
<li>åŒæ—¶ä¹Ÿè®¾ç½®äº†è¿‡æœŸæ—¶é—´æ¥ä¿éšœå®‰å…¨æ€§ã€‚SCFGçš„è¿‡æœŸæ—¶é—´ä¹Ÿå¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šç¼“è§£SCFGè¢«æ¶æ„æ”¶é›†ã€‚</li>
</ul>
<h2 id="QUICçš„é‡æ”¾æ”»å‡»é—®é¢˜"><a href="#QUICçš„é‡æ”¾æ”»å‡»é—®é¢˜" class="headerlink" title="QUICçš„é‡æ”¾æ”»å‡»é—®é¢˜"></a>QUICçš„é‡æ”¾æ”»å‡»é—®é¢˜</h2><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/quic/quic_3.jpg" alt></p>
<p>å¯¹äºå®‰å…¨æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„ä¸šåŠ¡æ“ä½œï¼Œä¾‹å¦‚å…·å¤‡æœ‰POSTæˆ–è€…PUTæ“ä½œæ—¶ä¸ºäº†ç¡®ä¿å®‰å…¨æ€§é€šå¸¸ä¼šæŠŠ0-RTTå…³é—­ï¼ŒåŒ…æ‹¬åƒfacebookæˆ–è€…cloudflareä¹Ÿéƒ½æ˜¯åœ¨ä¸€äº›å…³é”®æ“ä½œä¸Šç¦ç”¨0-RTTåŠŸèƒ½ï¼Œåªæœ‰å¹‚ç­‰æ“ä½œï¼ˆå¦‚GETã€HEADç­‰ï¼‰æ‰ä½¿ç”¨0-RTTã€‚</p>
<h1 id="AOI"><a href="#AOI" class="headerlink" title="AOI"></a>AOI</h1><p>æ¥ä¸‹æ¥æ‰“ç®—åšä¸€ä¸ªå›½æˆ˜ç±»çš„MMOæ‰‹æ¸¸ï¼Œå›½æˆ˜ç±»æ‰‹æ¸¸é¦–ç›¸è¦è§£å†³çš„å°±æ˜¯å¤šäººåŒå±AOIé—®é¢˜ã€‚ç¨å¾®çœ‹äº†ä¸€ä¸‹ä¸»æµçš„è§£å†³æ–¹æ¡ˆï¼Œä¸‹é¢å°±æŠŠMMORPGæ‰‹æ¸¸AOIè§£å†³æ–¹æ¡ˆç®€å•è®°å½•ä¸‹ï¼Œ å¸Œæœ›èƒ½å¸®åˆ°å¤§å®¶ã€‚</p>
<p>ç›®å‰æœ€å¸¸è§çš„æ˜¯æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œä¹å®«æ ¼å’Œåå­—é“¾è¡¨ã€‚</p>
<h2 id="ä¹å®«æ ¼"><a href="#ä¹å®«æ ¼" class="headerlink" title="ä¹å®«æ ¼"></a>ä¹å®«æ ¼</h2><p>ä¸»è¦æ€è·¯æ˜¯è®²åœºæ™¯åœ°å›¾åˆ†æˆå¤šä¸ªæ ¼å­ï¼Œæ¯ä¸ªæ ¼å­è®°å½•å…¶å‘¨å›´çš„æ ¼å­ä¿¡æ¯ã€‚</p>
<p>ä¹å®«æ ¼AOIç®—æ³•æ ¸å¿ƒæ˜¯æŠŠæ•´ä¸ªåœ°å›¾åˆ’åˆ†æˆå¤§å°ç›¸ç­‰çš„æ­£æ–¹å½¢æ ¼å­ï¼Œæ¯ä¸ªæ ¼å­ç”¨ä¸€ä¸ªæ•°ç»„å­˜å‚¨åœ¨æ ¼å­é‡Œçš„ç©å®¶ï¼Œç©å®¶çš„è§†é‡å³ä¸Šå›¾ä¸­æ ‡äº†æ•°å­—çš„ä¹ä¸ªæ ¼å­ï¼ˆå¦‚æœè§†é‡å¤§å°ä¸º2ä¸ªæ ¼å­ï¼Œå†å¾€å¤–æ‰©ä¸€åœˆå³å¯ï¼Œä¾æ­¤ç±»æ¨ï¼‰ã€‚</p>
<p>1.<strong>è¿›å…¥</strong><br>è§’è‰²è¿›å…¥åœºæ™¯ï¼Œæ ¹æ®å…¶åæ ‡ï¼Œå°†å…¶ç½®äºä¸€ä¸ªæ ¼å­ä¹‹ä¸­ï¼›<br>ç„¶åå‘è§’è‰²æ‰€åœ¨æ ¼å­åŠå…¶å‘¨å›´æ ¼å­ä¸­çš„æ‰€æœ‰ç©å®¶å‘é€addæ¶ˆæ¯ã€‚</p>
<p>2.<strong>ç§»åŠ¨</strong><br>è®¾ç©å®¶ç§»åŠ¨ä¹‹å‰çš„ä¹å®«æ ¼é›†åˆä¸ºold_setï¼Œç§»åŠ¨ä¹‹åçš„é›†åˆä¸ºnew_setï¼Œåˆ™<br>å‘(old_set - new_set)é›†åˆä¸­ç©å®¶å‘é€leaveæ¶ˆæ¯ï¼›<br>å‘(new_set - old_set)é›†åˆä¸­ç©å®¶å‘é€addæ¶ˆæ¯ï¼›<br>å‘ï¼ˆold_set &amp; old_setï¼‰é›†åˆä¸­ç©å®¶å‘é€moveæ¶ˆæ¯ï¼›</p>
<p>3.<strong>ç¦»å¼€</strong><br>è§’è‰²ç¦»å¼€åœºæ™¯ï¼Œå‘è§’è‰²æ‰€åœ¨æ ¼å­åŠå…¶å‘¨å›´æ ¼å­ä¸­çš„æ‰€æœ‰ç©å®¶å‘é€leaveæ¶ˆæ¯ã€‚</p>
<p><strong>ä¼˜ç¼ºç‚¹</strong>:</p>
<ul>
<li>cpuæ¶ˆè€—å°, å®«æ ¼çš„ä¼˜ç‚¹æ˜¯æ•ˆç‡é«˜ï¼Œæ‹¿åˆ°åæ ‡åå³å¯è·³è½¬åˆ°å¯¹åº”çš„æ ¼å­ï¼Œè§†é‡èŒƒå›´å†…éœ€è¦éå†çš„æ ¼å­ä¹Ÿä¸å¤šï¼Œé…åˆç»å…¸çš„æ ¼å­åœ°å›¾ï¼ˆtile mapï¼‰å†åˆé€‚ä¸è¿‡ï¼Œéƒ½ä¸éœ€è¦æŠŠåƒç´ åæ ‡è½¬æ ¼å­åæ ‡ã€‚</li>
<li>å…¶ç¼ºç‚¹æ˜¯å ç”¨å†…å­˜æœ‰ç‚¹å¤§ï¼Œå› ä¸ºå¿…é¡»ä¸ºæ‰€æœ‰æ ¼å­é¢„ç•™ä¸€ä¸ªæ•°ç»„ï¼Œå³ä½¿æ˜¯ä¸€ä¸ªæ•°ç»„æŒ‡é’ˆï¼Œé•¿å®½ä¸º1024çš„ä¸€ä¸ªåœ°å›¾ä¹Ÿè¦1024 <em> 1024 </em> 8 = 8Må†…å­˜ï¼Œè¿™è¿˜ä¸ç®—çœŸæ­£è¦å­˜æ•°æ®çš„ç»“æ„ï¼Œä»…ä»…æ˜¯å¿…é¡»é¢„ç•™çš„ã€‚</li>
<li>å†…å­˜å¼€é”€å¤§,å†…å­˜æ¶ˆè€—ä¸ä»…å’Œå®ä½“æ•°æœ‰å…³,è¿˜å’Œåœºæ™¯å¤§å°æˆæ­£æ¯”</li>
<li>æ ¼å­è¶Šå¤§, åŒ…å«çš„å¤šä½™çš„å®ä½“å°±è¶Šå¤š, è¿˜å¾—é€šè¿‡åŠå¾„è®¡ç®—æ¥å‰”é™¤è¿™äº›å¤šä½™çš„å®ä½“, ä½†æ˜¯æ ¼å­è¶Šå°, ç²¾åº¦è™½ç„¶è¶Šé«˜, å¤šä½™çš„å®ä½“è¶Šå°‘, åŒç­‰åŠå¾„ä¸‹è¦è®¡ç®—çš„æ ¼å­å°±è¶Šå¤š, cpuæ¶ˆè€—é«˜</li>
</ul>
<h2 id="åå­—é“¾è¡¨"><a href="#åå­—é“¾è¡¨" class="headerlink" title="åå­—é“¾è¡¨"></a>åå­—é“¾è¡¨</h2><p>é¦–ç›¸ï¼Œæ ¹æ®åœºæ™¯ä¸­æ‰€æœ‰è§’è‰²çš„xåæ ‡æ’åºï¼Œå°†å…¶æ”¾å…¥ä¸€ä¸ªé“¾è¡¨x_listä¸­ï¼›<br>ç„¶åï¼Œæ ¹æ®åœºæ™¯ä¸­æ‰€æœ‰è§’è‰²çš„yåæ ‡æ’åºï¼Œå°†å…¶æ”¾å…¥ä¸€ä¸ªé“¾è¡¨y_listä¸­ã€‚<br>è¿™æ ·ï¼Œæ‰€æœ‰çš„è§’è‰²åŒæ—¶ä½äºä¸¤ä¸ªé“¾è¡¨ä¸­ã€‚</p>
<p>1.<strong>è¿›å…¥</strong><br>ç©å®¶è¿›å…¥æ—¶ï¼Œæ ¹æ®xã€yåæ ‡æ’åºï¼Œåˆ†åˆ«æ’å…¥åˆ°x_list,y_listä¸­ã€‚<br>åŒæ—¶ï¼Œæ ¹æ®å¯è§†è·ç¦»ï¼Œå¾—åˆ°x_listä¸­å¯è§†çš„è§’è‰²é›†åˆx_setï¼Œy_setä¸­å¯è§†çš„è§’è‰²é›†åˆy_list,<br>é‚£ä¹ˆ(x_set &amp; y_set)å°±æ˜¯çœŸæ­£å¯è§†çš„è§’è‰²é›†åˆï¼Œå‘å…¶å‘é€addæ¶ˆæ¯</p>
<p>2.<strong>ç§»åŠ¨</strong><br>æ ¹æ®è§’è‰²ä¹‹å‰çš„ä½ç½®å¯ä»¥å¾—åˆ°old_setï¼›<br>ç§»åŠ¨ä¹‹åï¼Œéœ€è¦æ ¹æ®æ–°çš„xã€yåæ ‡ï¼Œé‡æ–°æ‰¾åˆ°è§’è‰²åœ¨x_listï¼Œy_listä¸­çš„ä½ç½®ï¼Œ<br>ç„¶åå¾—åˆ°æ–°çš„å¯è§è§’è‰²é›†åˆä¸ºnew_setï¼Œåˆ™<br>å‘(old_set - new_set)é›†åˆä¸­ç©å®¶å‘é€leaveæ¶ˆæ¯ï¼›<br>å‘(new_set - old_set)é›†åˆä¸­ç©å®¶å‘é€addæ¶ˆæ¯ï¼›<br>å‘ï¼ˆold_set &amp; old_setï¼‰é›†åˆä¸­ç©å®¶å‘é€moveæ¶ˆæ¯ï¼›</p>
<p>3.<strong>ç¦»å¼€</strong><br>å‘å½“å‰çœŸæ­£å¯è§†çš„è§’è‰²å‘é€leveaæ¶ˆæ¯ï¼Œç„¶åä»x_listå’Œy_listä¸­åˆ é™¤å³å¯ã€‚</p>
<p><strong>ä¼˜ç¼ºç‚¹</strong>:</p>
<ul>
<li>æ¯æ¬¡ç§»åŠ¨éœ€è¦é‡æ–°æ›´æ–°è§’è‰²åœ¨é“¾è¡¨ä¸­çš„ä½ç½®ï¼Œç„¶åå†è®¡ç®—æ–°çš„å¯è§é›†åˆ, è€Œä¹å®«æ ¼ä¸éœ€è¦ æµªè´¹CPU</li>
</ul>
<h1 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h1><ul>
<li>etcdæ€ä¹ˆé€‰ä¸»çš„? <a href="#etcdæ‰¼è¦æ€»ç»“å…¶ä»–ç»†èŠ‚å¯ä»¥ä¸ç”¨çœ‹äº†">etcdçš„leaderé€‰ä¸¾è¿‡ç¨‹</a></li>
<li>é˜¿é‡Œå·´å·´é¢è¯•å®˜æ‰‹å†Œ<ul>
<li>æ¶ˆæ¯é˜Ÿåˆ—åŸç†</li>
<li>ç§’æ€</li>
<li>åˆ†å¸ƒå¼äº‹åŠ¡</li>
<li>æ—¥å¿—è®°å½•</li>
<li>LRUç¼“å­˜</li>
<li>åˆ†å¸ƒå¼é”</li>
<li>HRé¢è¯•</li>
</ul>
</li>
<li>javaçš„hashmap æ˜¯æ€æ ·å®ç°çš„ï¼Ÿ</li>
<li>ç§’æ€ç³»ç»Ÿçš„å®ç°? </li>
<li>cgiæ˜¯å•¥? pending_fin</li>
<li>ç ”ç©¶ä¸€ä¸‹å¡å¤«å¡çš„çƒ­ç‚¹é¢è¯•é¢˜ pending_fin</li>
<li>dnsç”¨çš„ä»€ä¹ˆåè®®<ul>
<li>DNSå ç”¨53å·ç«¯å£ï¼ŒåŒæ—¶ä½¿ç”¨TCPå’ŒUDPåè®®ã€‚é‚£ä¹ˆDNSåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨è¿™ä¸¤ç§åè®®ï¼Ÿ<br>DNSåœ¨åŒºåŸŸä¼ è¾“çš„æ—¶å€™ä½¿ç”¨TCPåè®®ï¼Œå…¶ä»–æ—¶å€™ä½¿ç”¨UDPåè®®ã€‚<ul>
<li>DNSåŒºåŸŸä¼ è¾“çš„æ—¶å€™ä½¿ç”¨TCPåè®®:  <ul>
<li>è¾…åŸŸåæœåŠ¡å™¨ä¼šå®šæ—¶ï¼ˆä¸€èˆ¬3å°æ—¶ï¼‰å‘ä¸»åŸŸåæœåŠ¡å™¨è¿›è¡ŒæŸ¥è¯¢ä»¥ä¾¿äº†è§£æ•°æ®æ˜¯å¦æœ‰å˜åŠ¨ã€‚å¦‚æœ‰å˜åŠ¨ï¼Œä¼šæ‰§è¡Œä¸€æ¬¡åŒºåŸŸä¼ é€ï¼Œè¿›è¡Œæ•°æ®åŒæ­¥ã€‚åŒºåŸŸä¼ é€ä½¿ç”¨TCPè€Œä¸æ˜¯UDPï¼Œå› ä¸ºæ•°æ®åŒæ­¥ä¼ é€çš„æ•°æ®é‡æ¯”ä¸€ä¸ªè¯·æ±‚åº”ç­”çš„æ•°æ®é‡è¦å¤šå¾—å¤šã€‚</li>
<li>TCPæ˜¯ä¸€ç§å¯é è¿æ¥ï¼Œä¿è¯äº†æ•°æ®çš„å‡†ç¡®æ€§ã€‚</li>
</ul>
</li>
<li>åŸŸåè§£ææ—¶ä½¿ç”¨UDPåè®®ï¼š<br>å®¢æˆ·ç«¯å‘DNSæœåŠ¡å™¨æŸ¥è¯¢åŸŸåï¼Œä¸€èˆ¬è¿”å›çš„å†…å®¹éƒ½ä¸è¶…è¿‡512å­—èŠ‚ï¼Œç”¨UDPä¼ è¾“å³å¯ã€‚ä¸ç”¨ç»è¿‡ä¸‰æ¬¡æ¡æ‰‹ï¼Œè¿™æ ·DNSæœåŠ¡å™¨è´Ÿè½½æ›´ä½ï¼Œå“åº”æ›´å¿«ã€‚ç†è®ºä¸Šè¯´ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥æŒ‡å®šå‘DNSæœåŠ¡å™¨æŸ¥è¯¢æ—¶ç”¨TCPï¼Œä½†äº‹å®ä¸Šï¼Œå¾ˆå¤šDNSæœåŠ¡å™¨è¿›è¡Œé…ç½®çš„æ—¶å€™ï¼Œä»…æ”¯æŒUDPæŸ¥è¯¢åŒ…ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ä¸ºä»€ä¹ˆè®¡ç®—æœºç”¨è¡¥ç è¡¨ç¤ºè´Ÿæ•°?<ul>
<li><a href="https://www.ruanyifeng.com/blog/2009/08/twos_complement.html" target="_blank" rel="noopener">å‚è€ƒ</a></li>
<li>ä»€ä¹ˆæ˜¯è¡¥ç ï¼Ÿ ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å–ååŠ 1<br>å®ƒæ˜¯ä¸€ç§æ•°å€¼çš„è½¬æ¢æ–¹æ³•ï¼Œè¦åˆ†äºŒæ­¥å®Œæˆï¼š<br>ç¬¬ä¸€æ­¥ï¼Œæ¯ä¸€ä¸ªäºŒè¿›åˆ¶ä½éƒ½å–ç›¸åå€¼ï¼Œ0å˜æˆ1ï¼Œ1å˜æˆ0ã€‚æ¯”å¦‚ï¼Œ00001000çš„ç›¸åå€¼å°±æ˜¯11110111ã€‚<br>ç¬¬äºŒæ­¥ï¼Œå°†ä¸Šä¸€æ­¥å¾—åˆ°çš„å€¼åŠ 1ã€‚11110111å°±å˜æˆ11111000ã€‚<br>æ‰€ä»¥ï¼Œ00001000çš„2çš„è¡¥ç å°±æ˜¯11111000ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ-8åœ¨è®¡ç®—æœºï¼ˆ8ä½æœºï¼‰ä¸­å°±æ˜¯ç”¨11111000è¡¨ç¤ºã€‚</li>
<li>è¡¥ç çš„å¥½å¤„?<ul>
<li>åœ¨æ­£å¸¸çš„åŠ æ³•è§„åˆ™ä¸‹ï¼Œå¯ä»¥åˆ©ç”¨2çš„è¡¥ç å¾—åˆ°æ­£æ•°ä¸è´Ÿæ•°ç›¸åŠ çš„æ­£ç¡®ç»“æœã€‚æ¢è¨€ä¹‹ï¼Œè®¡ç®—æœºåªè¦éƒ¨ç½²åŠ æ³•ç”µè·¯å’Œè¡¥ç ç”µè·¯ï¼Œå°±å¯ä»¥å®Œæˆæ‰€æœ‰æ•´æ•°çš„åŠ æ³•ã€‚</li>
<li>å¦‚æœä¸ç”¨è¡¥ç , åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ­£å¸¸çš„åŠ æ³•è§„åˆ™ä¸é€‚ç”¨äºæ­£æ•°ä¸è´Ÿæ•°çš„åŠ æ³•ï¼Œå› æ­¤å¿…é¡»åˆ¶å®šä¸¤å¥—è¿ç®—è§„åˆ™ï¼Œä¸€å¥—ç”¨äºæ­£æ•°åŠ æ­£æ•°ï¼Œè¿˜æœ‰ä¸€å¥—ç”¨äºæ­£æ•°åŠ è´Ÿæ•°ã€‚ä»ç”µè·¯ä¸Šè¯´ï¼Œå°±æ˜¯å¿…é¡»ä¸ºåŠ æ³•è¿ç®—åšä¸¤ç§ç”µè·¯ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h2><ul>
<li><strong>nginxæ¶æ„å›¾</strong>: <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/nginx/nginx_architecture.png" alt="æ¶æ„å›¾"></li>
<li>å¤šè¿›ç¨‹çš„å·¥ä½œæ¨¡å¼</li>
<li>master è¿›ç¨‹ä¸»è¦å·¥ä½œ:<ul>
<li>è¯» nginx.conf é…ç½®ã€</li>
<li>åˆ›å»ºã€ç»‘å®šã€å…³é—­ Socket</li>
<li>åˆ›å»ºã€ç®¡ç†ã€å…³é—­ worker è¿›ç¨‹</li>
<li>å…¶ä»–ç®¡ç†å·¥ä½œ</li>
</ul>
</li>
<li>worker è¿›ç¨‹ä¸»è¦å·¥ä½œ:<ul>
<li>å¤„ç†ç½‘ç»œäº‹ä»¶</li>
<li>ä¸€ä¸ªè¿æ¥è¯·æ±‚è¿‡æ¥ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰å¯èƒ½å¤„ç†è¿™ä¸ªè¿æ¥ï¼Œæ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿé¦–å…ˆï¼Œæ¯ä¸ªworkerè¿›ç¨‹éƒ½æ˜¯ä»masterè¿›ç¨‹forkè¿‡æ¥ï¼Œåœ¨masterè¿›ç¨‹é‡Œé¢ï¼Œå…ˆå»ºç«‹å¥½éœ€è¦listençš„socketï¼ˆlistenfdï¼‰ä¹‹åï¼Œç„¶åå†forkå‡ºå¤šä¸ªworkerè¿›ç¨‹ã€‚æ‰€æœ‰workerè¿›ç¨‹çš„listenfdä¼šåœ¨æ–°è¿æ¥åˆ°æ¥æ—¶å˜å¾—å¯è¯»ï¼Œä¸ºä¿è¯åªæœ‰ä¸€ä¸ªè¿›ç¨‹å¤„ç†è¯¥è¿æ¥ï¼Œ<strong>æ‰€æœ‰workerè¿›ç¨‹åœ¨æ³¨å†Œlistenfdè¯»äº‹ä»¶å‰æŠ¢accept_mutex</strong>ï¼ŒæŠ¢åˆ°äº’æ–¥é”çš„é‚£ä¸ªè¿›ç¨‹æ³¨å†Œlistenfdè¯»äº‹ä»¶ï¼Œåœ¨è¯»äº‹ä»¶é‡Œè°ƒç”¨acceptæ¥å—è¯¥è¿æ¥ã€‚å½“ä¸€ä¸ªworkerè¿›ç¨‹åœ¨acceptè¿™ä¸ªè¿æ¥ä¹‹åï¼Œå°±å¼€å§‹è¯»å–è¯·æ±‚ï¼Œè§£æè¯·æ±‚ï¼Œå¤„ç†è¯·æ±‚ï¼Œäº§ç”Ÿæ•°æ®åï¼Œå†è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæœ€åæ‰æ–­å¼€è¿æ¥ï¼Œè¿™æ ·ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚å°±æ˜¯è¿™æ ·çš„äº†ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªè¯·æ±‚ï¼Œå®Œå…¨ç”±workerè¿›ç¨‹æ¥å¤„ç†ï¼Œè€Œä¸”åªåœ¨ä¸€ä¸ªworkerè¿›ç¨‹ä¸­å¤„ç†ã€‚</li>
</ul>
</li>
<li>Nginx å¤šè¿›ç¨‹æ¨¡å‹æ˜¯å¦‚ä½•å®ç°é«˜å¹¶å‘çš„ï¼Ÿ<ul>
<li>æ¯è¿›æ¥ä¸€ä¸ªrequestï¼Œä¼šæœ‰ä¸€ä¸ªworkerè¿›ç¨‹å»å¤„ç†ã€‚ä½†ä¸æ˜¯å…¨ç¨‹çš„å¤„ç†ï¼Œå¤„ç†åˆ°ä»€ä¹ˆç¨‹åº¦å‘¢ï¼Ÿå¤„ç†åˆ°å¯èƒ½å‘ç”Ÿé˜»å¡çš„åœ°æ–¹ï¼Œæ¯”å¦‚å‘ä¸Šæ¸¸ï¼ˆåç«¯ï¼‰æœåŠ¡å™¨è½¬å‘requestï¼Œå¹¶ç­‰å¾…è¯·æ±‚è¿”å›ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªå¤„ç†çš„workerä¸ä¼šè¿™ä¹ˆå‚»ç­‰ç€ï¼Œä»–ä¼šåœ¨å‘é€å®Œè¯·æ±‚åï¼Œæ³¨å†Œä¸€ä¸ªäº‹ä»¶ï¼šâ€œå¦‚æœupstreamè¿”å›äº†ï¼Œå‘Šè¯‰æˆ‘ä¸€å£°ï¼Œæˆ‘å†æ¥ç€å¹²â€ã€‚äºæ˜¯ä»–å°±ä¼‘æ¯å»äº†ã€‚</li>
<li>æ­¤æ—¶ï¼Œå¦‚æœå†æœ‰request è¿›æ¥ï¼Œä»–å°±å¯ä»¥å¾ˆå¿«å†æŒ‰è¿™ç§æ–¹å¼å¤„ç†ã€‚è€Œä¸€æ—¦ä¸Šæ¸¸æœåŠ¡å™¨è¿”å›äº†ï¼Œå°±ä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶ï¼Œworkeræ‰ä¼šæ¥æ¥æ‰‹ï¼Œè¿™ä¸ªrequestæ‰ä¼šæ¥ç€å¾€ä¸‹èµ°ã€‚ç”±äºweb serverçš„å·¥ä½œæ€§è´¨å†³å®šäº†æ¯ä¸ªrequestçš„å¤§éƒ¨ä»½ç”Ÿå‘½éƒ½æ˜¯åœ¨ç½‘ç»œä¼ è¾“ä¸­ï¼Œå®é™…ä¸ŠèŠ±è´¹åœ¨serveræœºå™¨ä¸Šçš„æ—¶é—´ç‰‡ä¸å¤šã€‚è¿™æ˜¯å‡ ä¸ªè¿›ç¨‹å°±è§£å†³é«˜å¹¶å‘çš„ç§˜å¯†æ‰€åœ¨ã€‚webserveråˆšå¥½å±äºç½‘ç»œioå¯†é›†å‹åº”ç”¨ï¼Œä¸ç®—æ˜¯è®¡ç®—å¯†é›†å‹ã€‚</li>
</ul>
</li>
</ul>
<!-- 


--------------------------------------------------------


# ä»¥ä¸‹æ˜¯åºŸå¼ƒçš„ä¸ç”¨çœ‹äº†


# å®æ“å·¥å…·ç±»

1. [ ] å¯èƒ½ä¼šé—®docker, éœ€è¦æŠŠè‡ªå·±çš„é¡¹ç›®dockeråŒ–ä¸€æ³¢
2. [x] etcd


# å®æ“å†™ä»£ç ç±»

5. [ ] ç”¨asio+msgpack_rpcå’Œå‚è€ƒäº†asiocoreçš„kcppæ¥ä¼˜åŒ–ä¸€æ³¢realtime-server
6. [ ] å®Œæˆjiffy

2. [x] ç®—æ³•å¤ä¹ åšå®¢ä¸­çš„
4. [x] kcp rdc æ¡æ‰‹ åŒé€šé“


# é˜…è¯»ä¹¦ç±ç±»

* [ ] malloc 
* [ ] makefile 
* [ ] mysql
* [ ] bin log
* [ ] æ¨¡æ¿å¤´æ–‡ä»¶å¯ä»¥æ”¾åœ¨cppé‡Œä¹ˆ? å¯ä»¥ä½†æ˜¯cppé‡Œå¿…é¡»ç”¨åˆ°å•¥ç±»å‹å°±è¦æ˜¾ç¤ºå®ä¾‹åŒ–å•¥ç±»å‹ 
* [ ] map insert å’Œä¸­æ‹¬å· 
* [ ] text blob
* [ ] è™šæ‹Ÿå†…å­˜, é¡µæ˜¯å•¥æ„æ€ 
* [ ] æŸ¥è„‰è„‰2.3 3.1è–ªèµ„ 
* [ ] ä¸ºä»€ä¹ˆåˆ†ä»£ç æ®µå’Œæ•°æ®æ®µ 
* [ ] çƒ­å¤‡å†·å¤‡ 
* [ ] å¦‚ä½•æŸ¥çœ‹å¤šä¸ªæ–‡ä»¶çš„åŒä¸ªå­—ç¬¦ä¸²? grep -r 
* [ ] å®¹å™¨åˆ é™¤è¦æ³¨æ„ä»€ä¹ˆ? è¿­ä»£å™¨å¤±æ•ˆé—®é¢˜ 
* [ ] å…±äº«å†…å­˜, å¦‚æœcoreäº†ä¼šå’‹æ ·
* [ ] ç«ç„°å›¾å·¥å…·æ€ä¹ˆåšçš„? ptrace ä¹ˆ? ptraceæ˜¯å•¥? perf
* [ ] å®šä½new 
* [ ] c++ä¸€ä¸ªç©ºç±»ä¼šç”Ÿæˆä»€ä¹ˆ (é»˜è®¤æ„é€ /ææ„(éè™š)/èµ‹å€¼è¿ç®—ç¬¦/é»˜è®¤æ‹·è´/å–åœ°å€/constå–åœ°å€) 

* LinuxçŸ¥è¯†: SIGINT, SIGTERM, SIGSR1, SIGABRT, SIGSEGV,  
* è¿›ç¨‹çŠ¶æ€(åƒµå°¸/å­¤å„¿), linuxçº¿ç¨‹æœ¬è´¨(LWP), é¡µè¡¨ 
* æœåŠ¡å™¨ç¯å¢ƒ: å¸¸ç”¨ç³»ç»Ÿè·¯å¾„ä½œç”¨(/etc, /usr, /proc/), aptåŒ…ç®¡ç†ä½¿ç”¨(debian), 
* HTTP: getå’ŒpoståŒºåˆ«.  
* query string æ ¼å¼ä¸ç¼–ç ; 
* curlçš„ä½¿ç”¨. 
* è®¤è¯†å¸¸è§http header; ç¨å¾®äº†è§£httpsæ¡æ‰‹è¿‡ç¨‹ 


## å¼€å‘ç¯å¢ƒä¸å·¥å…·

* Makefileäº†è§£ï¼Œèƒ½ç¼–å†™æœ‰å¤šä¸ªæ–‡ä»¶çš„ç®€å•Makefile
* CMakeçš„ä½¿ç”¨. 
* ç¼–è¯‘, é“¾æ¥è¿‡ç¨‹åŸç†; é™æ€åº“/åŠ¨æ€åº“åŒºåˆ«;  C++ name mangling,
* ABIå…¼å®¹æ¦‚å¿µï¼› lddå‘½ä»¤(åˆ—å‡ºä¾èµ–åº“), nmå‘½ä»¤(åˆ—å‡ºç¬¦å·è¡¨), objdumpå‘½ä»¤(åç¼–è¯‘å•¥çš„)
* coredumpæœ¬è´¨æ˜¯å•¥(å‡ºäº‹å¾—æ—¶å€™å¾—ç¨‹åºå†…å­˜å¿«ç…§)
* è¦-gæ‰èƒ½ç”¨gdbæŸ¥çœ‹coredump.  
* gdbçš„bt, p XXX, info XXX, frame XXX, thread...

* gccç¼–è¯‘å¸¸ç”¨é€‰é¡¹:
    -D(Dé€‰é¡¹æ˜¯ç”¨æ¥åœ¨ä½¿ç”¨gcc/g++ç¼–è¯‘çš„æ—¶å€™å®šä¹‰å®çš„, gcc -DNAME=Peter -D åé¢è·Ÿ key=value è¡¨ç¤ºå®šä¹‰keyè¿™ä¸ªå®ï¼Œå®ƒçš„å†…å®¹æ˜¯value)
    -I(æŒ‡å®šå¤´æ–‡ä»¶è·¯å¾„, åœ¨ä½ æ˜¯ç”¨ #include "file" çš„æ—¶å€™, gcc/g++ ä¼šå…ˆåœ¨å½“å‰ç›®å½•æŸ¥æ‰¾ä½ æ‰€åˆ¶å®šçš„å¤´æ–‡ä»¶, å¦‚æœæ²¡æœ‰æ‰¾åˆ°, ä»–å›åˆ°é»˜è®¤çš„å¤´æ–‡ä»¶ç›®å½•æ‰¾, å¦‚æœä½¿ç”¨ -I åˆ¶å®šäº† ç›®å½•,ä»–ä¼šå…ˆåœ¨ä½ æ‰€åˆ¶å®šçš„ç›®å½•æŸ¥æ‰¾, ç„¶åå†æŒ‰å¸¸è§„çš„é¡ºåºå»æ‰¾ã€‚å¯¹äº #include<file>, gcc/g++ ä¼šåˆ° -I åˆ¶å®šçš„ç›®å½•æŸ¥æ‰¾, æŸ¥æ‰¾ä¸åˆ°, ç„¶åå°†åˆ°ç³»ç»Ÿçš„é»˜è®¤çš„å¤´æ–‡ä»¶ç›®å½•æŸ¥æ‰¾ ã€‚)
    -L(åˆ¶å®šç¼–è¯‘çš„æ—¶å€™ï¼Œæœç´¢åº“çš„è·¯å¾„) ...
    -l(é€‰æ‹©é“¾æ¥å¾—library)
    -w(å°å†™w)çš„æ„æ€æ˜¯å…³é—­ç¼–è¯‘æ—¶çš„è­¦å‘Šï¼Œä¹Ÿå°±æ˜¯ç¼–è¯‘åä¸æ˜¾ç¤ºä»»ä½•warningï¼Œå› ä¸ºæœ‰æ—¶åœ¨ç¼–è¯‘ä¹‹åç¼–è¯‘å™¨ä¼šæ˜¾ç¤ºä¸€äº›ä¾‹å¦‚æ•°æ®è½¬æ¢ä¹‹ç±»çš„è­¦å‘Šï¼Œè¿™äº›è­¦å‘Šæ˜¯æˆ‘ä»¬å¹³æ—¶å¯ä»¥å¿½ç•¥çš„ã€‚
    -Wallé€‰é¡¹æ„æ€æ˜¯ç¼–è¯‘åæ˜¾ç¤ºæ‰€æœ‰è­¦å‘Šã€‚
    -Wé€‰é¡¹ç±»ä¼¼-Wallï¼Œä¼šæ˜¾ç¤ºè­¦å‘Šï¼Œä½†æ˜¯åªæ˜¾ç¤ºç¼–è¯‘å™¨è®¤ä¸ºä¼šå‡ºç°é”™è¯¯çš„è­¦å‘Šã€‚

* vscodeçš„ä½¿ç”¨ï¼ŒæŒæ¡remoteæ’ä»¶ä½¿ç”¨(è¿œç¨‹è¿æœåŠ¡å™¨å¼€å‘è°ƒè¯•)

## C/C++è¿›é˜¶

* RAIIçš„ç”¨æ³•(å„ç§guard)  
* C++11: move, 
* lambda(è¯­æ³•åŠå˜é‡æ•æ‰, ç”Ÿå‘½å‘¨æœŸ), 
* shared_from_this åŸç† 
* unordered_mapä½¿ç”¨,  
* functionå¯¹è±¡, shared_ptr, weak_ptr 
* dynamic_cast, reinterpret_cast, static_cast, const_cast. 
* çº¿ç¨‹ç›¸å…³: thread, mutex, atomicå˜é‡ 
* SIGSEGVä¿¡å·--segment faultå¸¸è§åŸå›  
* å­—èŠ‚æµæŒ‡é’ˆè§£å¼•ç”¨. 
* è·¨å¹³å°å­—èŠ‚å¯¹é½é—®é¢˜(SIGBUS) 
* profileå·¥å…·: tcmallocçš„heap profiler, gperf.  
* äº†è§£ASANæŸ¥æ‰¾å†…å­˜è¶Šç•Œé—®é¢˜ 
* æŸ¥å†…å­˜æ³„æ¼å·¥å…· 


## æ•°æ®åº“

* mongoæ˜¯ç›´æ¥å­˜åœ¨å†…å­˜é‡Œçš„å˜›? æ€ä¹ˆæŒä¹…åŒ–çš„?
* mongoé«˜å¯ç”¨?
* MongoDBçš„CRUDåŸºæœ¬ä½¿ç”¨. ï¼ˆå®˜æ–¹æ–‡æ¡£æ•™ç¨‹ï¼‰
* ç´¢å¼•çš„ä½¿ç”¨åŠåŸºæœ¬åŸç†. 
* MongoDBçš„shardingåŸç†, shard keyçš„ç±»å‹åŠæ•°å€¼åˆ†å¸ƒå¯¹å…¶å½±å“:
    MongoDBæ”¯æŒä¸¤ç§ç±»å‹çš„shard keyï¼š
      - Hashedï¼Œæ•°æ®åº“æ ¹æ®æŒ‡å®šçš„å­—æ®µå€¼ï¼Œç®—å‡ºä¸€ä¸ªå“ˆå¸Œå€¼ï¼Œç„¶åæ ¹æ®è¿™ä¸ªå“ˆå¸Œå€¼æŠŠæ•°æ®å†™å…¥ç›¸åº”çš„æœåŠ¡å™¨ä¸­ã€‚å®ƒçš„å¥½å¤„æ˜¯æ•°æ®ä¼šåˆ†å¸ƒçš„æ¯”è¾ƒå‡åŒ€ï¼Œä½†æ˜¯å®ƒåªèƒ½æŠŠä¸€ä¸ªå­—æ®µæŒ‡å®šä¸ºshard keyï¼Œå¦å¤–å¯¹äºèŒƒå›´çš„æ“ä½œï¼Œå®ƒæ›´å¤šæ˜¯ä¸€ä¸ªå¹¿æ’­çš„æ“ä½œï¼Œæ²¡æœ‰ç²¾ç¡®åœ°è·¯ç”±ã€‚
      - Rangedï¼ŒæŒ‰ç…§æŒ‡å®šå­—æ®µçš„å€¼çš„èŒƒå›´è¿›è¡Œåˆ’åˆ†ï¼Œæ”¯æŒå¤åˆshard keyã€‚è¿™ä¸ªå°±è¦æ±‚å¯¹å­—æ®µå€¼çš„èŒƒå›´æœ‰æ¯”è¾ƒæ·±å…¥çš„äº†è§£ï¼Œå¯¹æœªæ¥ä¹Ÿæœ‰ä¸€ä¸ªç›¸å¯¹æ¸…æ™°çš„æŠŠæ¡ã€‚ç›¸å¯¹å“ˆå¸Œï¼Œè¿™ç§æ–¹å¼å°±å¯ä»¥æœ‰æ¯”è¾ƒç²¾ç¡®çš„è·¯ç”±ã€‚ä½†æ˜¯å®ƒä¹Ÿå¯èƒ½ä¼šå¸¦æ¥æ•°æ®åˆ†å¸ƒä¸å‡åŒ€ï¼Œè´Ÿè½½ä¸èƒ½å®Œå…¨å‡è¡¡çš„é—®é¢˜ã€‚
* redisåŸºæœ¬ä½¿ç”¨. å¸¸ç”¨æ•°æ®ç»“æ„çš„åº”ç”¨åœºåˆ.


- çœ‹go, å†™ä¸Šç™»é™†å¤«
- [ ] å…¨çƒåŒ¹é…æ€ä¹ˆåš?
- [ ] gdb coreæ€ä¹ˆå¼„
- [ ] å…¨çƒåŒæœæ€ä¹ˆåš?
- [ ] æ ¹æ®ç™»å…¥ç™»å‡ºæ—¥å¿—ç”»å‡ºåœ¨çº¿æ›²çº¿?

- [ ] äº†è§£å®å¯æ¢¦/ä½¿å‘½å¬å”¤çš„å†å²å’Œç©æ³•, çœ‹çœ‹æ¸¸æˆå’ŒåŠ¨ç”»è§†é¢‘å•¥çš„
- [ ] æ¡¶æ’åº/çº¿æ®µæ ‘/ç»Ÿè®¡æ ‘/æ’åºæ ‘

- [x] æ–‡ä»¶å¤¹è¯»å†™æ‰§è¡Œæƒé™(æ–‡ä»¶å¤¹å¾—æ‰§è¡Œæƒé™ä¼šå½±å“å…¶è¯»æƒé™å’Œå†™æƒé™, è¿›éƒ½è¿›ä¸å»è¿˜æƒ³è¯»å†™?)
- [x] æ— é”é˜Ÿåˆ—åŸç†æ˜¯å¦ä¸€å®šæ¯”æœ‰é”å¿«?(ä¸ä¸€å®š, å¦‚æœä¸´ç•ŒåŒºå°å› ä¸ºæœ‰ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ™mutexæ…¢, å†æ¥çœ‹lockfreeçš„spinï¼Œä¸€èˆ¬éƒ½éµå¾ªä¸€ä¸ªå›ºå®šçš„æ ¼å¼ï¼šå…ˆæŠŠä¸€ä¸ªä¸å˜çš„å€¼Xå­˜åˆ°æŸä¸ªå±€éƒ¨å˜é‡Aé‡Œï¼Œç„¶ååšä¸€äº›è®¡ç®—ï¼Œè®¡ç®—/ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œç„¶ååšä¸€ä¸ªCASæ“ä½œï¼Œåˆ¤æ–­Aå’ŒXè¿˜æ˜¯ä¸æ˜¯ç›¸ç­‰çš„ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆè¿™æ¬¡CASå°±ç®—æˆåŠŸäº†ï¼Œå¦åˆ™å†æ¥ä¸€éã€‚å¦‚æœä¸Šé¢è¿™ä¸ªloopé‡Œé¢â€œè®¡ç®—/ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡â€éå¸¸è€—æ—¶å¹¶ä¸”contentionå¾ˆä¸¥é‡ï¼Œé‚£ä¹ˆlockfreeæ€§èƒ½æœ‰æ—¶ä¼šæ¯”mutexå·®ã€‚å¦å¤–lockfreeä¸æ–­åœ°spinå¼•èµ·çš„CPUåŒæ­¥cachelineçš„å¼€é”€ä¹Ÿæ¯”mutexç‰ˆæœ¬çš„å¤§ã€‚å…³äºABAé—®é¢˜)
- [x] msgpack pb å¯¹æ¯”
- [x] mock
- [x] jitç¼–è¯‘å™¨çš„åŸç†
7. [x] lockfree é˜Ÿåˆ—åŸç†
- [x] æ€ä¹ˆå®ç°ä¸€ä¸ªåç¨‹åº“?å‚è€ƒgevent, åç¨‹æ± åˆæ˜¯å•¥
- [x] å…¶ä»–çº¿ç¨‹èƒ½çœ‹åˆ°å¦ä¸€ä¸ªçº¿ç¨‹newå‡ºæ¥çš„å †ä¸Šä¸œè¥¿
- [x] çº¿ç¨‹æ˜¯æ€ä¹ˆåˆ‡æ¢çš„ï¼Œä¸Šä¸‹æ–‡æ˜¯å•¥ï¼Ÿ
- [x] å‡½æ•°æ ˆå¸§åŸç†
- [x] é€‚é…å™¨æ¨¡å¼
- [x] çº åˆ ç (Erasure Coding)
- [x] pchæ˜¯å•¥, æ€ä¹ˆæé«˜ç¼–è¯‘é€Ÿåº¦çš„?
- [x] qosæ˜¯å•¥?é™é€Ÿ?ç­”æ¡ˆ: ä»å›½å¤–ä¼šå›½å†…ä¹Ÿæœ‰å¾ˆå¤šæ¡è·¯ï¼Œå‡è®¾ aws æ—¥æœ¬åˆ°å›½å†…ï¼Œä½ ç»™çš„é’±å¤šï¼Œqos å°±æŠŠä½ æ”¾åˆ°è´¨é‡å¥½çš„é“¾è·¯ï¼›ä½ å…è´¹ï¼Œqos å°±æŠŠä½ æ”¾åˆ°å¸¸è§„çš„é“¾è·¯ä¸Šï¼Œé«˜å³°æœŸä¸¢åŒ…ï¼Œä¸­é—´è¿è¥å•†çˆ±å‡ºæ•…éšœ
8. [x] pythonè¿›é˜¶ï¼Œä»–çš„gcå’Œï¼Œä¸ºå•¥ä¸é‡Šæ”¾å†…å­˜ï¼ŸæŸ¥é˜…äº†å…³äºpythonçš„å†…å­˜æœºåˆ¶çš„æ–‡ç« , äº†è§£äº†åƒåœ¾å›æ”¶çš„åˆ†ä»£å›æ”¶/å¼•ç”¨è®¡æ•°/å¤„ç†å¾ªç¯å¼•ç”¨æœºåˆ¶ä»¥åŠé€šè¿‡gc moduleå’ŒobjgraphæŸ¥è¯¢å†…å­˜æ³„æ¼å’Œå¾ªç¯å¼•ç”¨çš„æ–¹æ³•
8. [x] å¤šè¿›ç¨‹èƒ½åˆ©ç”¨ä¸Šå¤šæ ¸cpuä¹ˆ?
1. [x] pytho gcå¡é¡¿
1. [x] shared_ptræ˜¯å¦ä¸ºçº¿ç¨‹å®‰å…¨çš„, ä»–çš„å¼•ç”¨è®¡æ•°æ˜¯å®‰å…¨çš„, ä½†æ˜¯shared_ptrçš„è¯»å†™åˆ™ä¸æ˜¯, éœ€è¦åŠ é”æ“ä½œ
2. [x] å®¢æˆ·ç«¯å¦‚ä½•åŒæ­¥æœåŠ¡å™¨æ—¶é—´
8. [x] pythonä¸ºå•¥ä¸æ˜¯çœŸçš„å¤šçº¿ç¨‹: ä»–æ˜¯çœŸçš„å¤šçº¿ç¨‹, ä¸è¿‡åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‹¿åˆ°global interpreter lock(GIL), æ‰€ä»¥çœ‹èµ·æ¥å°±åƒæ˜¯å•çº¿ç¨‹ä¸€æ ·
- [x] åšå®¢ä¸­noodleçš„æ–‡ç« 
3. [x] mongodb
1. [x] è¡Œä¸ºæ ‘
5. [x] çŠ¶æ€æœº
1. [x] æŠ€èƒ½ç¼–è¾‘å™¨
- [x] æœåŠ¡å‘ç°åŸç†
- [x] å¤šçº¿ç¨‹ç¼–ç¨‹é˜²æ­¢æ­»é”: é¡ºåºåŠ é”, å¯ä»¥å…ˆé‡Šæ”¾å æœ‰çš„é”ï¼Œç„¶åè¿‡ä¸€æ®µæ—¶é—´å†è¯•
9. [x] mroé—®é¢˜
6. [x] ç™»å½•æµç¨‹, å¹¶å¯¹æ¯”å¸‚é¢å…¶ä»–çš„tokenç™»å½•æµç¨‹
2. [x] redis, è¿æ¥æ± è¿˜æ²¡çœ‹
4. [x] æ’è¡Œæ¦œ, å››äº¿ç©å®¶çš„å®æ—¶æ’è¡Œæ¦œæ€ä¹ˆæ’¸?
10. [x] http post form


# é˜…è¯»ä»£ç ç±»

3. [  ] æ—¶é—´è½®, æœ€å°å †å®šæ—¶å™¨æ˜¯å•¥? çœ‹çœ‹muduoçš„å®šæ—¶å™¨æ˜¯å•¥æ ·çš„, è·Ÿæœ€å°å †å®ç°æœ‰å•¥ä¼˜åŠ¿?æœ€å°å †æ˜¯å•¥
6. [ ] æ’é˜ŸæœåŠ¡

7. [ ] msgpack rpc, æ¨¡æ¿å¤ä¹ 

- [x] asiocore æ€ä¹ˆåŠ å¯†å†…å®¹çš„? keyåœ¨å“ªå„¿? ç­”æ¡ˆ: ç±»ä¼¼äºhttpsé‚£ä¸€å¥—
5. [x] epollé‚£ä¸€å¥—å¯èƒ½è¦çœ‹ä¸€å“ˆ, æ°´å¹³è§¦å‘/è¾¹ç¼˜è§¦å‘å•¥çš„, è¦å¼„æ¸…æ¥šæ°´å¹³è§¦å‘å’Œè¾¹ç¼˜è§¦å‘çš„çœŸæ­£åŒºåˆ«
- [x] asiocoreæ€ä¹ˆæ£€æŸ¥è¶…æ—¶çš„?é«˜æ•ˆä¹ˆ?
6. [x] æŠ½ç©ºçœ‹ä¸€æ³¢muduo, çœ‹çœ‹ä»–æ€ä¹ˆå®ç°ç±»ä¼¼boostçš„strandçš„, ä¸ç„¶ç®€å†å†™ç½‘ç»œåº“æœ‰ç‚¹è™š, ä¸ç„¶loggerä¿åºè¾“å‡ºæœ‰ç‚¹è™š
2. [x] battle tickçš„fpsæ˜¯20? ä¼šä¸ä¼šå—åˆ°pollå½±å“?
3. [x] å®¢æˆ·ç«¯é€»è¾‘å¸§ç‡æ˜¯å¤šå°‘?è·ŸæœåŠ¡å™¨å¸§ç‡ä¸åŒä¼šæœ‰ä»€ä¹ˆé—®é¢˜? ç­”:å®¢æˆ·ç«¯è‹¥é«˜åˆ™ç­‰, è‹¥ä½åˆ™è¡¥å¸§
4. [x] å®¢æˆ·ç«¯æ¯”å¦‚åƒåŒæ£çš„ç»•ç€è½¬çš„æŠ€èƒ½, æ˜¯å®Œå…¨é æœåŠ¡å™¨åŒæ­¥posçš„å˜›?
5. [x] pythonå ç”¨æ¯”æ€ä¹ˆç®—çš„?
4. [x] å¤ä¹ c++æœ¬èº«æ‰¾ç‚¹é¢˜æ¥åš
2. [x] service gate
1. [x] aoi,  å¯çŸ¥ä¹å®«æ ¼å†…å¹¿æ’­å¯¹è±¡é›†åˆæ˜¯å›ºå®šçš„ï¼Œæ¯æ¬¡ AOI äº‹ä»¶ä¸éœ€è¦æµªè´¹ CPU è®¡ç®—é›†åˆï¼Œé“¾è¡¨çš„ æ’å…¥åˆ é™¤åœ¨ O(1)å†…å®Œæˆï¼Œä½†ä¹å®«æ ¼èŒƒå›´æ¯”avatarçš„å®é™…è§†é‡è¦å¤§ï¼Œéœ€è¦å‘é€è§†é‡å¤–çš„é¢å¤–çš„ avatar å¯¹è±¡æ¶ˆæ¯ï¼Œæµªè´¹å¸¦å®½ï¼Œåœ¨è¾¹ç•Œå¤„å¾€è¿”ç§»åŠ¨å°¤ä¸ºæ˜æ˜¾ã€‚

      åå­—é“¾è¡¨æ³•çš„ä¼˜ç‚¹åœ¨äºå¯ä»¥è¾ƒå‡†ç¡®è®¡ç®—æœ‰æ•ˆçš„AOI èŒƒå›´å¯¹è±¡é›†åˆï¼Œå¤§å¤§å‡å°‘è§†é‡å¤–çš„æ— æ•ˆ AOI æ¶ˆæ¯ï¼ŒèŠ‚çœç½‘ç»œå°åŒ…é‡ã€‚ç¼ºç‚¹åœ¨äºæ¯æ¬¡æ’å…¥å’Œç§»åŠ¨æ—¶ï¼Œéœ€è¦è®¡ç®—AOIå¯¹è±¡é›†åˆï¼Œæ¯”è¾ƒ æ¶ˆè€— CPUã€‚è®¡ç®—æ¶ˆè€—å–å†³äºè§†é‡èŒƒå›´å†…çš„æ´»åŠ¨çš„avatar å¯¹è±¡æ•°é‡ï¼Œä»¥åŠè¿›å‡ºåœºæ™¯çš„é¢‘ç¹ç¨‹ åº¦ã€‚æ¯”è¾ƒé€‚åˆæ´»åŠ¨avatarä¸å¤šï¼Œç§»åŠ¨å’Œè¿›å‡ºåœºæ™¯ä¸é¢‘ç¹ï¼Œå›ºå®šNPC ä¸ºä¸»çš„PVE å‘æ¸¸æˆã€‚è€Œä¹å®«æ ¼æ³•å‡ ä¹ä¸éœ€è¦è®¡ç®—ï¼Œç¼ºç‚¹å°±æ˜¯è§†é‡èŒƒå›´å¤–çš„æ— æ•ˆå°åŒ…é‡å¾ˆå¤šã€‚
2. [x] asiocoreçš„kcpæ€ä¹ˆå¤„ç†ä¸»åŠ¨disconnectçš„?ç»æŸ¥è¯, æ˜¯ç›´æ¥è®¾ç½®ä¸¤ä¸ªå·²disconnectedçš„æ ‡å¿—ä½, ç„¶åå…¶ä»–åœ°æ–¹å†åˆ¤æ–­ä¹‹ååšç›¸åº”çš„é€»è¾‘


# ç®€å†å†…å®¹

- [ ] ç®€å†æ¯ä¸ªå¯èƒ½æ€ç»´æ‰©æ•£å¾—å¯¹ç­–æå‰å†™

2. [x] wxå’Œmyçš„kmæ–‡ç« ä¹Ÿè¦å†™, æ¯”å¦‚aoiå•¥çš„
3. [x] pyæ‰¾æ‰¾å§œçš„é¢è¯•é¢˜ï¼Œç½‘ä¸Šå¸¸ç”¨é¢˜
5. [x] å†™ä¸Šzcç»éªŒ
6. [x] kcpå¼±ç½‘ç»œç¯å¢ƒæå‡æ–¹æ¡ˆ: dupackä»¥åŠdupacksä»¥åŠå†—ä½™rdc_data
4. [x] å¼‚æ­¥æ—¥å¿—å¯ä»¥çœ‹ä¸€ä¸‹, æŠŠwxçš„ä¼˜åŒ–å†™ä¸Š
9. [x] æŸ¥çœ‹g90docçœ‹çœ‹wxä»–ä»¬å†™çš„ä¸œè¥¿, å……ä½œzcç»éªŒ, çœ‹çœ‹èƒ½å¦å¼„åˆ°ç®€å†
1. [x] æŠŠwxä¼˜åŒ–å†™è¿›å»å»¶è¿Ÿä¼˜åŒ–ormå•¥çš„- [x] æŠŠæ™‹å‡ç”³è¯·çš„æ–‡æ¡£æ¢³ç†ä»¥ä¸‹æ”¾åˆ°ç®€å†é‡Œ
3. [x] cppæ‰¾æ‰¾å†°å·, å¤§æ¢¦é¾™å›¾çš„é¢è¯•é¢˜ï¼Œç½‘ä¸Šå¸¸ç”¨é¢˜


# é¡¹ç›®ç›¸å…³çš„é˜…è¯»

4. [ ] é¡¹ç›®ä¸­çš„å…¨å±€æœç´¢æ€ä¹ˆåšçš„?æ¨¡ç³Šæœç´¢ç®—æ³•åˆæ˜¯å•¥?

1. [ ] gateå’ŒgameManagerå’Œdbmanageræœ‰å•¥ç”¨
4. [ ] #6937 æœåŠ¡ç«¯è‡ªä¸»-æˆ˜æ–—æœã€å¾®æœåŠ¡ rolling restartè®¾è®¡
5. [ ] è¿è¥æŒ‡ä»¤é‚£ä¸€å¥—æ˜¯æ€ä¹ˆæ’¸çš„

3. [x] ç³»ç»Ÿä¸åŠŸèƒ½ #21253 ç½‘ç»œå»¶è¿Ÿç¨³å®šå®šä½åŠä¼˜åŒ–
1. [x] 90çš„è§‚æˆ˜å’Œå½•åƒæ˜¯æ€ä¹ˆåšçš„?æ˜¯æŒ‡ä»¤é‡æ”¾å—?è¿˜æ˜¯å•¥?
2. [x] 90å½•åƒæ€ä¹ˆä¼ ä¸Šå»çš„?é‚£ä¹ˆå¤§
2. [x] åœ¨ç±»é‡Œé¢æ–°åŠ ä¸€ä¸ªå˜é‡reloadåè€çš„å¯¹è±¡æ˜¯æ²¡æœ‰è¿™ä¸ªæ–°çš„æˆå‘˜å˜é‡çš„é‚£æ–°çš„å¯¹è±¡å‘¢ï¼Ÿæ¯”å¦‚åœ¨CompCastSkillä¸ŠåŠ ä¸ªæˆå‘˜å˜é‡test_reload = 1, ç„¶ååœ¨start_castä¸Šä¸Šprint test_reload , reloadååœ¨è®­ç»ƒåœºé‡ŒåŠ å…¥ä¸€ä¸ªæ–°ç©å®¶, çœ‹çœ‹ä»–ä¼šä¸ä¼šprint 1; ç»æŸ¥è¯, æ–°ç©å®¶æ˜¯ä¼šæ‰“å°1çš„, è€ç©å®¶ä¼šæŠ¥trackbackæ²¡æœ‰test_reloadè¿™ä¸ªæˆå‘˜

-------------------------------------------------------------------------------------------

# ä»¥ä¸‹çš†ä¸ºæ‚é¡¹å¾…å½’çº³

- [ ] ç³»ç»Ÿä¸åŠŸèƒ½ #21253 ç½‘ç»œå»¶è¿Ÿç¨³å®šå®šä½åŠä¼˜åŒ– 
- [ ] #21733 [å‹æµ‹ä¿®å¤] å¥½å‹å‹æµ‹é—®é¢˜ä¿®å¤

- [x] #21256é—®é¢˜ä¿®å¤ - apply_friendæ—¶redisè¿æ¥è€—å°½é—®é¢˜
- [ ] #18061 MongoDBæŠ¥é”™ä¼˜åŒ–
- [ ] #18060 MongoDBå­˜ç›˜æŠ¥è­¦
- [x] #14793 å‹æµ‹ä¼˜åŒ– - å¾®æœåŠ¡ç¯å¢ƒä¸‹çš„MongoDBè¿æ¥ä¼˜åŒ–
- [x] #14547 å‹æµ‹ä¿®å¤ - FriendService redisè¿æ¥é—®é¢˜

- [ ] #6937 æœåŠ¡ç«¯è‡ªä¸»-æˆ˜æ–—æœã€å¾®æœåŠ¡ rolling restartè®¾è®¡
- [ ] #6935 æœåŠ¡ç«¯è‡ªä¸»-ç™»å½•æœè®¾è®¡
- [ ] #6936 æœåŠ¡ç«¯è‡ªä¸»-æ¸¸æˆæœã€æˆ˜æ–—æœã€å¾®æœåŠ¡å¼¹æ€§æ‰©ç¼©å®¹è®¾è®¡
- [ ] #9761 MatchServiceæ•ˆç‡ä¼˜åŒ–

- [ ] #15678Flyer C++åŒ– æœåŠ¡å™¨åŒæ­¥ä¿®æ”¹

- [ ] #15252 åä½œå¼Šæœºåˆ¶ - å½•åƒè®°å½•
- [ ] #15262 åä½œå¼Šæœºåˆ¶ - ç¦»çº¿åˆ†æåŠŸèƒ½
- [ ] #15804 åä½œå¼Šæœºåˆ¶ - ç¦»çº¿åˆ†æåŠŸèƒ½ - ç¦»çº¿æ’­æ”¾åŠŸèƒ½é¢„ç ”


<img  src=http://www.plantuml.com/plantuml/svg/AyhBBqbLo2zBBL9mLB1ISFRn3tPruIf2Y3e1HNqyWqDS_RWS5NJjmFpWI3zRGns5ujH2smfajOuGkVXWLxyGT3D0ua6kpc50KsnqaKrnTFQshT266bU9i0GaNgbjY6w-Qt28enFGGHwOpaII0W00>
<img  src=http://www.plantuml.com/plantuml/svg/AyhBBqbLo2zBBL9mLB1IS0qESNJoyGpsS7NXAa98EQ59EIhese45tJpzR0rr58fJ2sqha3KuGkJYmnqzGmpHJNBsyGzs1Ki13RBH1OivEdlRLcWRuZB32A4IoSfATEKXdhvGWz6iz74C3ea7se5mESZ2IctiRdD1D_Vvsiwd-rgDV8Dz5FJqzD1b8Ne0>
<h2 id="scanåŸç†ä¸ºå•¥ä¸€å®šèƒ½éå†å®Œ"><a href="#scanåŸç†ä¸ºå•¥ä¸€å®šèƒ½éå†å®Œ" class="headerlink" title="scanåŸç†ä¸ºå•¥ä¸€å®šèƒ½éå†å®Œ"></a>scanåŸç†ä¸ºå•¥ä¸€å®šèƒ½éå†å®Œ</h2><h3 id="å…ˆè¯´ä¸ºå•¥scanå¯èƒ½ä¼šé‡å¤"><a href="#å…ˆè¯´ä¸ºå•¥scanå¯èƒ½ä¼šé‡å¤" class="headerlink" title="å…ˆè¯´ä¸ºå•¥scanå¯èƒ½ä¼šé‡å¤"></a>å…ˆè¯´ä¸ºå•¥scanå¯èƒ½ä¼šé‡å¤</h3><p>æ€»ç»“: ä¸»è¦æ˜¯å› ä¸ºå­—å…¸rehashçš„é—®é¢˜, å½“sizeå˜çš„æ—¶å€™, æœ‰ä¸€äº›æ•°æ®åœ¨<code>ht[0]</code>æœ‰ä¸€äº›åœ¨<code>ht[1]</code>, å¯¼è‡´æ¸¸æ ‡å¯¹åº”çš„bucketå˜äº†</p>
<p>å­—å…¸rehashæ—¶ä¼šä½¿ç”¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œé¦–å…ˆä¸º<code>ht[1]</code>åˆ†é…ç©ºé—´ï¼Œå¦‚æœæ˜¯æ‰©å±•æ“ä½œï¼Œ<code>ht[1]</code>çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äº2å€<code>ht[0]</code>.usedçš„2nï¼Œå¦‚æœæ˜¯æ”¶ç¼©æ“ä½œï¼Œ<code>ht[1]</code>çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äº<code>ht[0]</code>.usedçš„2nã€‚ç„¶åå°†<code>ht[0]</code>çš„æ‰€æœ‰é”®å€¼å¯¹rehashåˆ°<code>ht[1]</code>ä¸­ï¼Œæœ€åé‡Šæ”¾<code>ht[0]</code>ï¼Œå°†<code>ht[1]</code>è®¾ç½®ä¸º<code>ht[0]</code>ï¼Œæ–°åˆ›å»ºä¸€ä¸ªç©ºç™½å“ˆå¸Œè¡¨å½“åš<code>ht[1]</code>ã€‚rehashä¸æ˜¯ä¸€æ¬¡å®Œæˆçš„ï¼Œè€Œæ˜¯åˆ†å¤šæ¬¡ã€æ¸è¿›å¼åœ°å®Œæˆã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œç°åœ¨å°†ä¸€ä¸ªsizeä¸º4çš„å“ˆå¸Œè¡¨<code>ht[0]</code>(sizemaskä¸º11, index = hash &amp; 0b11)rehashè‡³ä¸€ä¸ªsizeä¸º8çš„å“ˆå¸Œè¡¨<code>ht[1]</code>(sizemaskä¸º111, index = hash &amp; 0b111)ã€‚</p>
<p><code>ht[0]</code>ä¸­å¤„äºbucket0ä½ç½®çš„keyçš„å“ˆå¸Œå€¼ä½ä¸¤ä½ä¸º00ï¼Œé‚£ä¹ˆrehashè‡³<code>ht[1]</code>æ—¶indexå–ä½ä¸‰ä½å¯èƒ½ä¸º000(0)å’Œ100(4)ã€‚ä¹Ÿå°±æ˜¯<code>ht[0]</code>ä¸­bucket0ä¸­çš„å…ƒç´ rehashä¹‹ååˆ†æ•£äº<code>ht[1]</code>çš„bucket0ä¸bucket4ï¼Œä»¥æ­¤ç±»æ¨ï¼Œå¯¹åº”å…³ç³»ä¸ºï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">`ht[0]`  -&gt;  `ht[1]`</span><br><span class="line">----------------</span><br><span class="line">  0    -&gt;   0,4 </span><br><span class="line">  1    -&gt;   1,5</span><br><span class="line">  2    -&gt;   2,6</span><br><span class="line">  3    -&gt;   3,7</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœSCANå‘½ä»¤é‡‡å–0-&gt;1-&gt;2-&gt;3çš„é¡ºåºè¿›è¡Œéå†ï¼Œå°±ä¼šå‡ºç°å¦‚ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>æ‰©å±•æ“ä½œä¸­ï¼Œå¦‚æœè¿”å›æ¸¸æ ‡1æ—¶æ­£åœ¨è¿›è¡Œrehashï¼Œ<code>ht[0]</code>ä¸­çš„bucket0ä¸­çš„éƒ¨åˆ†æ•°æ®å¯èƒ½å·²ç»rehashåˆ°<code>ht[1]</code>ä¸­çš„bucket[0]æˆ–è€…bucket[4]ï¼Œåœ¨<code>ht[1]</code>ä¸­ä»bucket1å¼€å§‹éå†ï¼Œéå†è‡³bucket4æ—¶ï¼Œå…¶ä¸­çš„å…ƒç´ å·²ç»åœ¨<code>ht[0]</code>ä¸­çš„bucket0ä¸­éå†è¿‡ï¼Œè¿™å°±äº§ç”Ÿäº†é‡å¤é—®é¢˜ã€‚</li>
<li>ç¼©å°æ“ä½œä¸­ï¼Œå½“è¿”å›æ¸¸æ ‡5ï¼Œä½†ç¼©å°åå“ˆå¸Œè¡¨çš„sizeåªæœ‰4ï¼Œå¦‚ä½•é‡ç½®æ¸¸æ ‡ï¼Ÿ</li>
</ul>
<h3 id="scanå¦‚ä½•ä¿è¯éå†å®Œä¸é—æ¼"><a href="#scanå¦‚ä½•ä¿è¯éå†å®Œä¸é—æ¼" class="headerlink" title="scanå¦‚ä½•ä¿è¯éå†å®Œä¸é—æ¼"></a>scanå¦‚ä½•ä¿è¯éå†å®Œä¸é—æ¼</h3><p>æ€»ç»“: </p>
<ul>
<li>redis ä½¿ç”¨äº†ä¸€ç§å«åš reverse binary iteration çš„æ–¹æ³•.</li>
<li>redis é‡Œè¾¹ rehash ä»å°åˆ°å¤§æ—¶ï¼Œscan ç³»åˆ—å‘½ä»¤ä¸ä¼šé‡å¤ä¹Ÿä¸ä¼šé—æ¼. è€Œä»å¤§åˆ°å°æ—¶, æœ‰å¯èƒ½ä¼šé€ æˆé‡å¤ä½†ä¸ä¼šé—æ¼.</li>
</ul>
<p>å‚è€ƒ:  </p>
<ul>
<li><a href="https://segmentfault.com/a/1190000018218584">https://segmentfault.com/a/1190000018218584</a></li>
<li><a href="https://www.cnblogs.com/linxiyue/p/11262969.html">https://www.cnblogs.com/linxiyue/p/11262969.html</a><br>â€“&gt;</li>
</ul>
-->
      


      

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/noodle/" rel="tag"><i class="fa fa-tag"></i> noodle</a>
            
          </div>
        

        
        
        

        
          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/zen_åœ¨æè´¨é‡Œé¢ç©¿å€¼ç»™GBuffer/" rel="next" title="åœ¨æè´¨ä¼ å€¼ç»™GBuffer">
                  <i class="fa fa-chevron-left"></i> 
                  <p class="post-nav-pre-next-title">
                    åœ¨æè´¨ä¼ å€¼ç»™GBuffer
                  </p> 
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/fd_inode/" rel="prev" title="æ–‡ä»¶æè¿°ç¬¦FDä¸Inode">
                <p class="post-nav-pre-next-title">
                    æ–‡ä»¶æè¿°ç¬¦FDä¸Inode
                </p> 
                <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        

        
        
      </footer>
      
    </div>
    
    
    

    

    

    

  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  

  <aside id="sidebar" class="sidebar">

    
      
        <div id="sidebar-dimmer"></div>
      
    

    <div class="sidebar-inner">
    
      <div class="sidebar-toggle-inside motion-element">
        <div class="sidebar-toggle-line-wrap">
          <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
          <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
          <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
        </div>
      </div>

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a href="/" class="site-author-image" rel="start" style="border:none">
            <img class="site-author-image" itemprop="image" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/uploads/avatar.png" alt="Mike">
          </a>
          <p class="site-author-name" itemprop="name">Mike</p>
           
              <p class="site-description motion-element" itemprop="description">ğŸš™ ğŸš— ğŸ’¨ ğŸ’¨ If you want to create a blog like this, just follow my open-source project, "hexo-theme-neo", click the GitHub button below and check it out ^_^ . It is recommended to use Chrome, Safari, or Edge to read this blog since this blog was developed on Edge (Chromium kernel version) and tested on Safari.</p>
          
        </div>

        <nav class="site-state motion-element">

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">298</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">111</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

          <div class="site-state-item site-state-about">
            <a href="/about/">
              <span class="site-state-item-about fa fa-fw fa-user"></span>
              <span class="site-state-item-name">about</span>
            </a>
          </div>
          
        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/no5ix" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://open.spotify.com/user/313duq77ekebrfyak3xijqewzss4?si=e7653b829a9747bf" target="_blank" title="Spotify">
                  
                    <i class="fa fa-fw fa-spotify"></i>
                  
                    
                      Spotify
                    
                </a>
              </span>
            
          
          
          <!-- ç½‘æ˜“äº‘éŸ³ä¹ -->
            <!-- <div class="netease-cloud-music"> -->
              <!-- <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=110 src="//music.163.com/outchain/player?type=0&id=992743594&auto=0&height=90"></iframe> -->
            <!-- </div> -->
          <!-- ç½‘æ˜“äº‘éŸ³ä¹ -->

        </div>

        
        

        
        

        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#pending-fini"><span class="nav-text">pending_fini</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Linuxå®šæ—¶å™¨å®ç°åŸç†"><span class="nav-text">Linuxå®šæ—¶å™¨å®ç°åŸç†</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#æ—¶é—´è½®å®šæ—¶å™¨-ä½åˆ†è¾¨ç‡å®ç°"><span class="nav-text">æ—¶é—´è½®å®šæ—¶å™¨-ä½åˆ†è¾¨ç‡å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ—¶é—´è½®ç®—æ³•æ€æƒ³"><span class="nav-text">æ—¶é—´è½®ç®—æ³•æ€æƒ³</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ—¶é—´è½®æœ‰ä»€ä¹ˆç¼ºç‚¹"><span class="nav-text">æ—¶é—´è½®æœ‰ä»€ä¹ˆç¼ºç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ—¶é—´è½®æ ¸å¿ƒä»£ç "><span class="nav-text">æ—¶é—´è½®æ ¸å¿ƒä»£ç </span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#çº¢é»‘æ ‘å®šæ—¶å™¨-é«˜ç²¾åº¦å®ç°"><span class="nav-text">çº¢é»‘æ ‘å®šæ—¶å™¨-é«˜ç²¾åº¦å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸æ—¶é—´è½®çš„åŒºåˆ«"><span class="nav-text">ä¸æ—¶é—´è½®çš„åŒºåˆ«</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hrtimerçš„å·¥ä½œåŸç†"><span class="nav-text">hrtimerçš„å·¥ä½œåŸç†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¦‚ä½•åœ¨é«˜ç²¾åº¦æ¨¡å¼ä¸‹æ¨¡æ‹Ÿtick"><span class="nav-text">å¦‚ä½•åœ¨é«˜ç²¾åº¦æ¨¡å¼ä¸‹æ¨¡æ‹Ÿtick</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Linuxæ–‡ä»¶ç³»ç»Ÿ"><span class="nav-text">Linuxæ–‡ä»¶ç³»ç»Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ç³»ç»Ÿç›®å½•ç»“æ„"><span class="nav-text">ç³»ç»Ÿç›®å½•ç»“æ„</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#inode"><span class="nav-text">inode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è½¯é“¾æ¥ä¸ç¡¬é“¾æ¥"><span class="nav-text">è½¯é“¾æ¥ä¸ç¡¬é“¾æ¥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ç¡¬é“¾æ¥"><span class="nav-text">ç¡¬é“¾æ¥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è½¯é“¾æ¥"><span class="nav-text">è½¯é“¾æ¥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux-ä¸ºä»€ä¹ˆå¤šè¿›ç¨‹èƒ½å¤Ÿè¯»å†™æ­£åœ¨åˆ é™¤çš„æ–‡ä»¶"><span class="nav-text">Linux ä¸ºä»€ä¹ˆå¤šè¿›ç¨‹èƒ½å¤Ÿè¯»å†™æ­£åœ¨åˆ é™¤çš„æ–‡ä»¶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ–‡ä»¶æ“ä½œåç§»lseek"><span class="nav-text">æ–‡ä»¶æ“ä½œåç§»lseek</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ–‡ä»¶ç©ºæ´"><span class="nav-text">æ–‡ä»¶ç©ºæ´</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¹ é¢˜"><span class="nav-text">ä¹ é¢˜</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#procæ–‡ä»¶å¤¹"><span class="nav-text">procæ–‡ä»¶å¤¹</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Linuxè¿›ç¨‹ç®¡ç†"><span class="nav-text">Linuxè¿›ç¨‹ç®¡ç†</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#è¯»è€…-å†™è€…é—®é¢˜"><span class="nav-text">è¯»è€…-å†™è€…é—®é¢˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å“²å­¦å®¶å°±é¤é—®é¢˜"><span class="nav-text">å“²å­¦å®¶å°±é¤é—®é¢˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ´»é”"><span class="nav-text">æ´»é”</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ­»é”"><span class="nav-text">æ­»é”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å¿…è¦æ¡ä»¶"><span class="nav-text">å¿…è¦æ¡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ­»é”å¤„ç†æ–¹æ³•å¤§çº²"><span class="nav-text">æ­»é”å¤„ç†æ–¹æ³•å¤§çº²</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é¸µé¸Ÿç­–ç•¥"><span class="nav-text">é¸µé¸Ÿç­–ç•¥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ­»é”æ£€æµ‹ä¸æ­»é”æ¢å¤"><span class="nav-text">æ­»é”æ£€æµ‹ä¸æ­»é”æ¢å¤</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#æ¯ç§ç±»å‹ä¸€ä¸ªèµ„æºçš„æ­»é”æ£€æµ‹"><span class="nav-text">æ¯ç§ç±»å‹ä¸€ä¸ªèµ„æºçš„æ­»é”æ£€æµ‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æ¯ç§ç±»å‹å¤šä¸ªèµ„æºçš„æ­»é”æ£€æµ‹"><span class="nav-text">æ¯ç§ç±»å‹å¤šä¸ªèµ„æºçš„æ­»é”æ£€æµ‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æ­»é”æ¢å¤"><span class="nav-text">æ­»é”æ¢å¤</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ­»é”é¢„é˜²"><span class="nav-text">æ­»é”é¢„é˜²</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ­»é”é¿å…"><span class="nav-text">æ­»é”é¿å…</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#å®‰å…¨çŠ¶æ€çš„æ£€æµ‹"><span class="nav-text">å®‰å…¨çŠ¶æ€çš„æ£€æµ‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å•ä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•"><span class="nav-text">å•ä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å¤šä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•"><span class="nav-text">å¤šä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#linuxè¿›ç¨‹è°ƒåº¦"><span class="nav-text">linuxè¿›ç¨‹è°ƒåº¦</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å…¬å¹³è°ƒåº¦CFS"><span class="nav-text">å…¬å¹³è°ƒåº¦CFS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å®æ—¶è°ƒåº¦"><span class="nav-text">å®æ—¶è°ƒåº¦</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#linuxè½»é‡çº§è¿›ç¨‹LWP"><span class="nav-text">linuxè½»é‡çº§è¿›ç¨‹LWP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LWPå¦‚ä½•åˆ›å»ºå‡ºæ¥"><span class="nav-text">LWPå¦‚ä½•åˆ›å»ºå‡ºæ¥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¤šæ ¸CPUæ˜¯å¦èƒ½åŒæ—¶æ‰§è¡Œå¤šä¸ªè¿›ç¨‹ï¼Ÿ"><span class="nav-text">å¤šæ ¸CPUæ˜¯å¦èƒ½åŒæ—¶æ‰§è¡Œå¤šä¸ªè¿›ç¨‹ï¼Ÿ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹çš„æ­¥éª¤"><span class="nav-text">åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹çš„æ­¥éª¤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è¿›ç¨‹ç»„"><span class="nav-text">è¿›ç¨‹ç»„</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¼šè¯"><span class="nav-text">ä¼šè¯</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ€æ­»è¿›ç¨‹ç»„æˆ–ä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹"><span class="nav-text">æ€æ­»è¿›ç¨‹ç»„æˆ–ä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SIGHUP"><span class="nav-text">SIGHUP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SIGCHLDä¸åƒµæ­»è¿›ç¨‹"><span class="nav-text">SIGCHLDä¸åƒµæ­»è¿›ç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å­¤å„¿è¿›ç¨‹ä¸åƒµå°¸è¿›ç¨‹"><span class="nav-text">å­¤å„¿è¿›ç¨‹ä¸åƒµå°¸è¿›ç¨‹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SIGPIPE"><span class="nav-text">SIGPIPE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å†…æ ¸æ€ä¸ç”¨æˆ·æ€çš„åŒºåˆ«"><span class="nav-text">å†…æ ¸æ€ä¸ç”¨æˆ·æ€çš„åŒºåˆ«</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Linuxç½‘ç»œç¼–ç¨‹"><span class="nav-text">Linuxç½‘ç»œç¼–ç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#select"><span class="nav-text">select</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#epoll"><span class="nav-text">epoll</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ°´å¹³è§¦å‘ä¸è¾¹ç¼˜è§¦å‘çš„åŒºåˆ«"><span class="nav-text">æ°´å¹³è§¦å‘ä¸è¾¹ç¼˜è§¦å‘çš„åŒºåˆ«</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ°´å¹³è§¦å‘éœ€è¦å¤„ç†çš„é—®é¢˜"><span class="nav-text">æ°´å¹³è§¦å‘éœ€è¦å¤„ç†çš„é—®é¢˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#epollå®ç°ç»†èŠ‚"><span class="nav-text">epollå®ç°ç»†èŠ‚</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#select-å’Œ-epollçš„åŒºåˆ«"><span class="nav-text">select å’Œ epollçš„åŒºåˆ«</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#éé˜»å¡çš„connectå’Œaccept"><span class="nav-text">éé˜»å¡çš„connectå’Œaccept</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é˜»å¡å’Œéé˜»å¡çš„sendå’Œrecvå’Œsendtoå’Œrecvfrom"><span class="nav-text">é˜»å¡å’Œéé˜»å¡çš„sendå’Œrecvå’Œsendtoå’Œrecvfrom</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reuseaddrå’Œreuseport"><span class="nav-text">reuseaddrå’Œreuseport</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Linuxå†…å­˜ç®¡ç†"><span class="nav-text">Linuxå†…å­˜ç®¡ç†</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿå†…å­˜"><span class="nav-text">ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿå†…å­˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MMUå·¥ä½œåŸç†"><span class="nav-text">MMUå·¥ä½œåŸç†</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¸»æœºå­—èŠ‚åº"><span class="nav-text">ä¸»æœºå­—èŠ‚åº</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç½‘ç»œå­—èŠ‚åº"><span class="nav-text">ç½‘ç»œå­—èŠ‚åº</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linuxè™šæ‹Ÿåœ°å€ç©ºé—´å¦‚ä½•åˆ†å¸ƒ"><span class="nav-text">Linuxè™šæ‹Ÿåœ°å€ç©ºé—´å¦‚ä½•åˆ†å¸ƒ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#brkå‡½æ•°"><span class="nav-text">brkå‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mmap"><span class="nav-text">mmap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mallocå’ŒfreeåŸç†"><span class="nav-text">mallocå’ŒfreeåŸç†</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vmallocå’Œkmallocå’Œmallocçš„åŒºåˆ«"><span class="nav-text">vmallocå’Œkmallocå’Œmallocçš„åŒºåˆ«</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Buddyï¼ˆä¼™ä¼´ï¼‰åˆ†é…ç®—æ³•"><span class="nav-text">Buddyï¼ˆä¼™ä¼´ï¼‰åˆ†é…ç®—æ³•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Slabåˆ†é…å™¨"><span class="nav-text">Slabåˆ†é…å™¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#forkå†…å­˜è¯­ä¹‰"><span class="nav-text">forkå†…å­˜è¯­ä¹‰</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é›¶-CPU-æ‹·è´"><span class="nav-text">é›¶(CPU)æ‹·è´</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¼ ç»Ÿè¯»æ“ä½œ"><span class="nav-text">ä¼ ç»Ÿè¯»æ“ä½œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¼ ç»Ÿå†™æ“ä½œ"><span class="nav-text">ä¼ ç»Ÿå†™æ“ä½œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sendfile"><span class="nav-text">sendfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sendfile-DMA-gather-copy"><span class="nav-text">sendfile + DMA gather copy</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#TCP"><span class="nav-text">TCP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¸‰æ¬¡æ¡æ‰‹"><span class="nav-text">ä¸‰æ¬¡æ¡æ‰‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å¦‚æœç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„ackä¸¢å¤±äº†å’‹åŠ"><span class="nav-text">å¦‚æœç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„ackä¸¢å¤±äº†å’‹åŠ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SYN-Floodä¸SYN-Cookie"><span class="nav-text">SYN-Floodä¸SYN-Cookie</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å››æ¬¡æŒ¥æ‰‹"><span class="nav-text">å››æ¬¡æŒ¥æ‰‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#timewaitçš„æ„ä¹‰"><span class="nav-text">timewaitçš„æ„ä¹‰</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#timewaitå’Œclosewaitå¤ªå¤šå’‹åŠ"><span class="nav-text">timewaitå’Œclosewaitå¤ªå¤šå’‹åŠ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tcpæ‹¥å¡æ§åˆ¶"><span class="nav-text">tcpæ‹¥å¡æ§åˆ¶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tcpæ»‘åŠ¨çª—å£"><span class="nav-text">tcpæ»‘åŠ¨çª—å£</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#é›¶çª—å£ä¸TCPæŒç»­è®¡æ—¶å™¨"><span class="nav-text">é›¶çª—å£ä¸TCPæŒç»­è®¡æ—¶å™¨</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nagleç®—æ³•ä¸CORKç®—æ³•åŒºåˆ«"><span class="nav-text">Nagleç®—æ³•ä¸CORKç®—æ³•åŒºåˆ«</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ACKå»¶è¿Ÿç¡®è®¤æœºåˆ¶"><span class="nav-text">ACKå»¶è¿Ÿç¡®è®¤æœºåˆ¶</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HTTPä¸HTTPS"><span class="nav-text">HTTPä¸HTTPS</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#å®¢æˆ·ç«¯è¯·æ±‚æ¶ˆæ¯"><span class="nav-text">å®¢æˆ·ç«¯è¯·æ±‚æ¶ˆæ¯</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æœåŠ¡å™¨å“åº”æ¶ˆæ¯"><span class="nav-text">æœåŠ¡å™¨å“åº”æ¶ˆæ¯</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#https"><span class="nav-text">https</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å¯¹ç§°åŠ å¯†"><span class="nav-text">å¯¹ç§°åŠ å¯†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#éå¯¹ç§°åŠ å¯†"><span class="nav-text">éå¯¹ç§°åŠ å¯†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#https-åŠ å¯†æ–¹å¼"><span class="nav-text">https åŠ å¯†æ–¹å¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¯ä¹¦"><span class="nav-text">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¯ä¹¦</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cookie"><span class="nav-text">cookie</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sessionå¦‚ä½•ä¿å­˜è¾ƒå¥½"><span class="nav-text">sessionå¦‚ä½•ä¿å­˜è¾ƒå¥½</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cookieå’Œsessionå’Œtokençš„åŒºåˆ«"><span class="nav-text">cookieå’Œsessionå’Œtokençš„åŒºåˆ«</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JWT"><span class="nav-text">JWT</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#jwtè¿‡æœŸäº†å¦‚ä½•åˆ·æ–°"><span class="nav-text">jwtè¿‡æœŸäº†å¦‚ä½•åˆ·æ–°</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¸¸è§çš„HTTPç›¸åº”çŠ¶æ€ç "><span class="nav-text">å¸¸è§çš„HTTPç›¸åº”çŠ¶æ€ç </span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#getå’Œpostçš„æœ¬è´¨åŒºåˆ«"><span class="nav-text">getå’Œpostçš„æœ¬è´¨åŒºåˆ«</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Connection-keep-alive"><span class="nav-text">Connection: keep-alive</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#urlç¼–ç urlencodeæ˜¯ä»€ä¹ˆ"><span class="nav-text">urlç¼–ç urlencodeæ˜¯ä»€ä¹ˆ</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MySQL"><span class="nav-text">MySQL</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚è€ƒç½‘å€"><span class="nav-text">å‚è€ƒç½‘å€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mysqlä¸€æ¡è¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹"><span class="nav-text">mysqlä¸€æ¡è¯­å¥çš„æ‰§è¡Œè¿‡ç¨‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#charå’Œvarcharçš„åŒºåˆ«æ˜¯ä»€ä¹ˆ"><span class="nav-text">charå’Œvarcharçš„åŒºåˆ«æ˜¯ä»€ä¹ˆ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redo-logä¸binlogä¸undo-logçš„åŒºåˆ«"><span class="nav-text">redo logä¸binlogä¸undo logçš„åŒºåˆ«</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#redo-log"><span class="nav-text">redo log</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#binlog"><span class="nav-text">binlog</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undo-log"><span class="nav-text">undo log</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undologå’Œbinlogå’Œredologä¸åŒä¹‹å¤„æ€»ç»“"><span class="nav-text">undologå’Œbinlogå’Œredologä¸åŒä¹‹å¤„æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#äºŒé˜¶æ®µæäº¤"><span class="nav-text">äºŒé˜¶æ®µæäº¤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸¤é˜¶æ®µæäº¤æœºåˆ¶çš„å¿…è¦æ€§"><span class="nav-text">ä¸¤é˜¶æ®µæäº¤æœºåˆ¶çš„å¿…è¦æ€§</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç´¢å¼•"><span class="nav-text">ç´¢å¼•</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸ºä»€ä¹ˆè¯´Bç±»æ ‘æ›´é€‚åˆæ•°æ®åº“ç´¢å¼•"><span class="nav-text">ä¸ºä»€ä¹ˆè¯´Bç±»æ ‘æ›´é€‚åˆæ•°æ®åº“ç´¢å¼•</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mysqlå…¨æ–‡ç´¢å¼•-pending-fin"><span class="nav-text">mysqlå…¨æ–‡ç´¢å¼• pending_fin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mysql-æœ‰é‚£äº›å­˜å‚¨å¼•æ“ï¼Œæœ‰å“ªäº›åŒºåˆ«"><span class="nav-text">mysql æœ‰é‚£äº›å­˜å‚¨å¼•æ“ï¼Œæœ‰å“ªäº›åŒºåˆ«</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mysql-ä¸»ä»åŒæ­¥åˆ†å“ªå‡ ä¸ªè¿‡ç¨‹"><span class="nav-text">mysql ä¸»ä»åŒæ­¥åˆ†å“ªå‡ ä¸ªè¿‡ç¨‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¸»ä»åŒæ­¥å»¶è¿Ÿä¸åŒæ­¥æ•°æ®ä¸¢å¤±é—®é¢˜"><span class="nav-text">ä¸»ä»åŒæ­¥å»¶è¿Ÿä¸åŒæ­¥æ•°æ®ä¸¢å¤±é—®é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#åŠåŒæ­¥å¤åˆ¶ï¼ˆSemisynchronous-replicationï¼‰"><span class="nav-text">åŠåŒæ­¥å¤åˆ¶ï¼ˆSemisynchronous replicationï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åº“å¹¶è¡Œå¤åˆ¶"><span class="nav-text">åº“å¹¶è¡Œå¤åˆ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¼‚æ­¥å¤åˆ¶ï¼ˆAsynchronous-replicationï¼‰"><span class="nav-text">å¼‚æ­¥å¤åˆ¶ï¼ˆAsynchronous replicationï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å…¨åŒæ­¥å¤åˆ¶ï¼ˆFully-synchronous-replicationï¼‰"><span class="nav-text">å…¨åŒæ­¥å¤åˆ¶ï¼ˆFully synchronous replicationï¼‰</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¹è§‚é”ä¸æ‚²è§‚é”çš„åŒºåˆ«ï¼Ÿ"><span class="nav-text">ä¹è§‚é”ä¸æ‚²è§‚é”çš„åŒºåˆ«ï¼Ÿ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å®ç°äº‹åŠ¡é‡‡å–äº†å“ªäº›æŠ€æœ¯ä»¥åŠæ€æƒ³ï¼Ÿ"><span class="nav-text">å®ç°äº‹åŠ¡é‡‡å–äº†å“ªäº›æŠ€æœ¯ä»¥åŠæ€æƒ³ï¼Ÿ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mysqlå››ä¸ªäº‹åŠ¡éš”ç¦»çº§åˆ«"><span class="nav-text">mysqlå››ä¸ªäº‹åŠ¡éš”ç¦»çº§åˆ«</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#äº‹åŠ¡å¹¶å‘å¯èƒ½å‡ºç°çš„æƒ…å†µ"><span class="nav-text">äº‹åŠ¡å¹¶å‘å¯èƒ½å‡ºç°çš„æƒ…å†µ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å„ä¸ªéš”ç¦»çº§åˆ«çš„è¯¦ç»†è¯´æ˜"><span class="nav-text">å„ä¸ªéš”ç¦»çº§åˆ«çš„è¯¦ç»†è¯´æ˜</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mvccæ˜¯å•¥"><span class="nav-text">mvccæ˜¯å•¥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ReadView"><span class="nav-text">ReadView</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mysqlåœ¨å¯é‡å¤è¯»RRçš„éš”ç¦»çº§åˆ«ä¸‹å¦‚ä½•é¿å…å¹»è¯»çš„"><span class="nav-text">mysqlåœ¨å¯é‡å¤è¯»RRçš„éš”ç¦»çº§åˆ«ä¸‹å¦‚ä½•é¿å…å¹»è¯»çš„</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ­£ç¡®ç†è§£InnoDBå¼•æ“RRéš”ç¦»çº§åˆ«è§£å†³äº†å¹»è¯»è¿™ä»¶äº‹"><span class="nav-text">æ­£ç¡®ç†è§£InnoDBå¼•æ“RRéš”ç¦»çº§åˆ«è§£å†³äº†å¹»è¯»è¿™ä»¶äº‹</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Redis"><span class="nav-text">Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#redis-æ•°æ®ç»“æ„æœ‰å“ªäº›ï¼Ÿåˆ†åˆ«æ€ä¹ˆå®ç°çš„ï¼Ÿ"><span class="nav-text">redis æ•°æ®ç»“æ„æœ‰å“ªäº›ï¼Ÿåˆ†åˆ«æ€ä¹ˆå®ç°çš„ï¼Ÿ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#zsetå„ç§é—®é¢˜"><span class="nav-text">zsetå„ç§é—®é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸ºä»€ä¹ˆzsetç”¨è·³è¡¨ä¸ç”¨çº¢é»‘æ ‘"><span class="nav-text">ä¸ºä»€ä¹ˆzsetç”¨è·³è¡¨ä¸ç”¨çº¢é»‘æ ‘</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zsetæ˜¯æ€ä¹ˆæ”¯æŒæŸ¥è¯¢æ’åçš„"><span class="nav-text">zsetæ˜¯æ€ä¹ˆæ”¯æŒæŸ¥è¯¢æ’åçš„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å»¶æ—¶é˜Ÿåˆ—ç”¨redisæ€ä¹ˆåš"><span class="nav-text">å»¶æ—¶é˜Ÿåˆ—ç”¨redisæ€ä¹ˆåš</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ZSETåšæ’è¡Œæ¦œæ—¶è¦å®ç°åˆ†æ•°ç›¸åŒæ—¶æŒ‰æ—¶é—´é¡ºåºæ’åºæ€ä¹ˆå®ç°"><span class="nav-text">ZSETåšæ’è¡Œæ¦œæ—¶è¦å®ç°åˆ†æ•°ç›¸åŒæ—¶æŒ‰æ—¶é—´é¡ºåºæ’åºæ€ä¹ˆå®ç°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å“ˆå¸Œè¡¨æ¸è¿›å¼rehash"><span class="nav-text">å“ˆå¸Œè¡¨æ¸è¿›å¼rehash</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redis-æŒä¹…åŒ–æœ‰å“ªå‡ ç§æ–¹å¼ï¼Œæ€ä¹ˆé€‰ï¼Ÿ"><span class="nav-text">redis æŒä¹…åŒ–æœ‰å“ªå‡ ç§æ–¹å¼ï¼Œæ€ä¹ˆé€‰ï¼Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#bgsaveæµç¨‹è¯´ä¸€ä¸‹"><span class="nav-text">bgsaveæµç¨‹è¯´ä¸€ä¸‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#aofæµç¨‹è¯´ä¸€ä¸‹ä»¥åŠaofè¿½åŠ é˜»å¡æ˜¯å•¥"><span class="nav-text">aofæµç¨‹è¯´ä¸€ä¸‹ä»¥åŠaofè¿½åŠ é˜»å¡æ˜¯å•¥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AOFé‡å†™çš„å®ç°"><span class="nav-text">AOFé‡å†™çš„å®ç°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¦‚ä½•åšrdbå’Œaofçš„åŸå­æ›¿æ¢çš„"><span class="nav-text">å¦‚ä½•åšrdbå’Œaofçš„åŸå­æ›¿æ¢çš„</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redis-ä¸»ä»åŒæ­¥æ˜¯æ€æ ·çš„è¿‡ç¨‹ï¼Ÿ"><span class="nav-text">redis ä¸»ä»åŒæ­¥æ˜¯æ€æ ·çš„è¿‡ç¨‹ï¼Ÿ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redis-key-çš„è¿‡æœŸç­–ç•¥"><span class="nav-text">redis key çš„è¿‡æœŸç­–ç•¥</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å†…å­˜æ·˜æ±°æœºåˆ¶"><span class="nav-text">å†…å­˜æ·˜æ±°æœºåˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#redisçš„LRUç®—æ³•è¯´ä¸€ä¸‹"><span class="nav-text">redisçš„LRUç®—æ³•è¯´ä¸€ä¸‹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rediså“¨å…µ"><span class="nav-text">rediså“¨å…µ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redisé›†ç¾¤"><span class="nav-text">redisé›†ç¾¤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¼˜ç‚¹"><span class="nav-text">ä¼˜ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç¼ºç‚¹"><span class="nav-text">ç¼ºç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ•…éšœè½¬ç§»"><span class="nav-text">æ•…éšœè½¬ç§»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é›†ç¾¤åˆ†ç‰‡ç­–ç•¥"><span class="nav-text">é›†ç¾¤åˆ†ç‰‡ç­–ç•¥</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ä¸€èˆ¬å“ˆå¸Œç®—æ³•"><span class="nav-text">ä¸€èˆ¬å“ˆå¸Œç®—æ³•</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•"><span class="nav-text">ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HashSlotç®—æ³•"><span class="nav-text">HashSlotç®—æ³•</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cacheå’ŒDBå¦‚ä½•ä¸€è‡´"><span class="nav-text">Cacheå’ŒDBå¦‚ä½•ä¸€è‡´</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç¼“å­˜é›ªå´©æ˜¯å•¥-å’‹å¤„ç†"><span class="nav-text">ç¼“å­˜é›ªå´©æ˜¯å•¥?å’‹å¤„ç†?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç¼“å­˜ç©¿é€æ˜¯å•¥-å’‹å¤„ç†"><span class="nav-text">ç¼“å­˜ç©¿é€æ˜¯å•¥?å’‹å¤„ç†?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç¼“å­˜å‡»ç©¿æ˜¯å•¥-å’‹å¤„ç†"><span class="nav-text">ç¼“å­˜å‡»ç©¿æ˜¯å•¥?å’‹å¤„ç†?</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#etcd"><span class="nav-text">etcd</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Rafté€‰ä¸»è¿‡ç¨‹"><span class="nav-text">Rafté€‰ä¸»è¿‡ç¨‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ•°æ®è¯»å†™æµç¨‹å¦‚ä½•ä¿è¯ä¸€è‡´æ€§çš„"><span class="nav-text">æ•°æ®è¯»å†™æµç¨‹å¦‚ä½•ä¿è¯ä¸€è‡´æ€§çš„</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#etcdå†™è¯·æ±‚æµç¨‹"><span class="nav-text">etcdå†™è¯·æ±‚æµç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#etcdçº¿æ€§ä¸€è‡´æ€§è¯»"><span class="nav-text">etcdçº¿æ€§ä¸€è‡´æ€§è¯»</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcdå­˜åœ¨è„‘è£‚æƒ…å†µå—"><span class="nav-text">etcdå­˜åœ¨è„‘è£‚æƒ…å†µå—</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ–°Leaderä¼šæ— æ¡ä»¶æäº¤æ—§Leaderæ—¥å¿—å—"><span class="nav-text">æ–°Leaderä¼šæ— æ¡ä»¶æäº¤æ—§Leaderæ—¥å¿—å—</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcdå¯ä»¥å¶æ•°ä¸ªéƒ¨ç½²å—"><span class="nav-text">etcdå¯ä»¥å¶æ•°ä¸ªéƒ¨ç½²å—</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¸èƒ½ç›´æ¥readè¿”å›å—"><span class="nav-text">ä¸èƒ½ç›´æ¥readè¿”å›å—</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcdæ¶æ„åŠè§£æ"><span class="nav-text">etcdæ¶æ„åŠè§£æ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcdçš„ä½¿ç”¨åœºæ™¯"><span class="nav-text">etcdçš„ä½¿ç”¨åœºæ™¯</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcdæ¦‚å¿µæœ¯è¯­"><span class="nav-text">etcdæ¦‚å¿µæœ¯è¯­</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#etcdæ•°æ®å­˜å‚¨"><span class="nav-text">etcdæ•°æ®å­˜å‚¨</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#åˆ†å¸ƒå¼ç³»ç»Ÿ"><span class="nav-text">åˆ†å¸ƒå¼ç³»ç»Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#å…±è¯†"><span class="nav-text">å…±è¯†</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¸€è‡´æ€§çš„ç±»åˆ«"><span class="nav-text">ä¸€è‡´æ€§çš„ç±»åˆ«</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#çº¿æ€§ä¸€è‡´æ€§"><span class="nav-text">çº¿æ€§ä¸€è‡´æ€§</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é¡ºåºä¸€è‡´æ€§"><span class="nav-text">é¡ºåºä¸€è‡´æ€§</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ä¸¾ä¾‹è¯´æ˜1"><span class="nav-text">ä¸¾ä¾‹è¯´æ˜1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ä¸¾ä¾‹è¯´æ˜2"><span class="nav-text">ä¸¾ä¾‹è¯´æ˜2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ä¸¾ä¾‹è¯´æ˜3"><span class="nav-text">ä¸¾ä¾‹è¯´æ˜3</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CAPç†è®º"><span class="nav-text">CAPç†è®º</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#capé€šä¿—è€Œç²¾å‡†çš„è§£é‡Š"><span class="nav-text">capé€šä¿—è€Œç²¾å‡†çš„è§£é‡Š</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#capçš„ä¸€äº›ç»„åˆä¾‹å­"><span class="nav-text">capçš„ä¸€äº›ç»„åˆä¾‹å­</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BASE-ç†è®º"><span class="nav-text">BASE ç†è®º</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æœåŠ¡æ²»ç†"><span class="nav-text">æœåŠ¡æ²»ç†</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åˆ†å¸ƒå¼é”"><span class="nav-text">åˆ†å¸ƒå¼é”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆ†å¸ƒå¼é”è¿‡æœŸæ—¶é—´åˆ°äº†ä½†ä¸šåŠ¡æ²¡æ‰§è¡Œå®Œæ€ä¹ˆåŠ"><span class="nav-text">åˆ†å¸ƒå¼é”è¿‡æœŸæ—¶é—´åˆ°äº†ä½†ä¸šåŠ¡æ²¡æ‰§è¡Œå®Œæ€ä¹ˆåŠ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åŸºäºetcdçš„åˆ†å¸ƒå¼é”"><span class="nav-text">åŸºäºetcdçš„åˆ†å¸ƒå¼é”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åŸºäºredisçš„åˆ†å¸ƒå¼é”"><span class="nav-text">åŸºäºredisçš„åˆ†å¸ƒå¼é”</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RedLock"><span class="nav-text">RedLock</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆ†å¸ƒå¼é”çš„é«˜å¹¶å‘ä¼˜åŒ–"><span class="nav-text">åˆ†å¸ƒå¼é”çš„é«˜å¹¶å‘ä¼˜åŒ–</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ"><span class="nav-text">åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#äºŒé˜¶æ®µæäº¤2PC"><span class="nav-text">äºŒé˜¶æ®µæäº¤2PC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCC"><span class="nav-text">TCC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æœ¬åœ°æ¶ˆæ¯è¡¨"><span class="nav-text">æœ¬åœ°æ¶ˆæ¯è¡¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§"><span class="nav-text">å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å°½æœ€å¤§åŠªåŠ›é€šçŸ¥"><span class="nav-text">å°½æœ€å¤§åŠªåŠ›é€šçŸ¥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è´Ÿè½½å‡è¡¡ç®—æ³•æœ‰å“ªäº›"><span class="nav-text">è´Ÿè½½å‡è¡¡ç®—æ³•æœ‰å“ªäº›</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#è´Ÿè½½å‡è¡¡çš„å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•æ€ä¹ˆå®ç°"><span class="nav-text">è´Ÿè½½å‡è¡¡çš„å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•æ€ä¹ˆå®ç°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æœåŠ¡å‘ç°æ˜¯æ€ä¹ˆå®ç°çš„"><span class="nav-text">æœåŠ¡å‘ç°æ˜¯æ€ä¹ˆå®ç°çš„</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç†”æ–­æ˜¯æ€ä¹ˆå®ç°çš„"><span class="nav-text">ç†”æ–­æ˜¯æ€ä¹ˆå®ç°çš„</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æœåŠ¡é™çº§"><span class="nav-text">æœåŠ¡é™çº§</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é™æµ"><span class="nav-text">é™æµ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç†”æ–­-é™çº§-é™æµä¸‰è€…çš„å…³ç³»"><span class="nav-text">ç†”æ–­-é™çº§-é™æµä¸‰è€…çš„å…³ç³»</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#idç”Ÿæˆå™¨å¦‚ä½•å®ç°å…¨å±€é€’å¢"><span class="nav-text">idç”Ÿæˆå™¨å¦‚ä½•å®ç°å…¨å±€é€’å¢</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#è§£å†³æ—¶é’Ÿå›æ‹¨é—®é¢˜"><span class="nav-text">è§£å†³æ—¶é’Ÿå›æ‹¨é—®é¢˜</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#æŒ–å‘"><span class="nav-text">æŒ–å‘</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#çŒå¾·ä¹‹æ‰‹"><span class="nav-text">çŒå¾·ä¹‹æ‰‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ€»ç»“"><span class="nav-text">æ€»ç»“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å®¢æˆ·ç«¯è§’åº¦"><span class="nav-text">å®¢æˆ·ç«¯è§’åº¦</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å‘¨è¾¹æœåŠ¡è§’åº¦"><span class="nav-text">å‘¨è¾¹æœåŠ¡è§’åº¦</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#äº‹ä»¶é©±åŠ¨æ¨¡å‹æ˜¯å’‹æ ·çš„"><span class="nav-text">äº‹ä»¶é©±åŠ¨æ¨¡å‹æ˜¯å’‹æ ·çš„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åœ°å›¾å¤šå¤§æ‰¿è½½å¤šå°‘äºº"><span class="nav-text">åœ°å›¾å¤šå¤§æ‰¿è½½å¤šå°‘äºº</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æœåŠ¡å™¨æ¶æ„çš„åˆ†å¸ƒå¼æ”¹é€ "><span class="nav-text">æœåŠ¡å™¨æ¶æ„çš„åˆ†å¸ƒå¼æ”¹é€ </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¦‚ä½•è¿›å…¥æˆ˜æ–—çš„"><span class="nav-text">å¦‚ä½•è¿›å…¥æˆ˜æ–—çš„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ–­çº¿é‡è¿æ€ä¹ˆåš"><span class="nav-text">æ–­çº¿é‡è¿æ€ä¹ˆåš?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æˆ˜æ–—ä¸­æ€è¿›ç¨‹æ‰çº¿é‡è¿è¿˜è¦æ’é˜Ÿä¹ˆ"><span class="nav-text">æˆ˜æ–—ä¸­æ€è¿›ç¨‹æ‰çº¿é‡è¿è¿˜è¦æ’é˜Ÿä¹ˆ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç™»å½•å¾®æœåŠ¡å’Œæ’é˜Ÿå¾®æœåŠ¡"><span class="nav-text">ç™»å½•å¾®æœåŠ¡å’Œæ’é˜Ÿå¾®æœåŠ¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#timer"><span class="nav-text">timer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç½‘ç»œä¼˜åŒ–"><span class="nav-text">ç½‘ç»œä¼˜åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#kcpçš„æ¶ˆæ¯æ¨¡å¼å’Œæµæ¨¡å¼"><span class="nav-text">kcpçš„æ¶ˆæ¯æ¨¡å¼å’Œæµæ¨¡å¼</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#æ¶ˆæ¯æ¨¡å¼"><span class="nav-text">æ¶ˆæ¯æ¨¡å¼</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#æµæ¨¡å¼"><span class="nav-text">æµæ¨¡å¼</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è§£å†³æœåŠ¡å™¨é—´æ­‡æ€§å¡é¡¿é—®é¢˜"><span class="nav-text">è§£å†³æœåŠ¡å™¨é—´æ­‡æ€§å¡é¡¿é—®é¢˜</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FlyNetæœåŠ¡å™¨å¼•æ“"><span class="nav-text">FlyNetæœåŠ¡å™¨å¼•æ“</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‡†å¤‡å¥½ä¸€ä¸ªçº¿ä¸Šäº‹æ•…çš„å¤„ç†äº‹ä¾‹"><span class="nav-text">å‡†å¤‡å¥½ä¸€ä¸ªçº¿ä¸Šäº‹æ•…çš„å¤„ç†äº‹ä¾‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‡†å¤‡å¥½ä¸€ä¸ªéš¾å¿˜çš„ä¼˜åŒ–"><span class="nav-text">å‡†å¤‡å¥½ä¸€ä¸ªéš¾å¿˜çš„ä¼˜åŒ–</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¸ªäººå¼€æº-realtime-serveræœåŠ¡å™¨æ¡†æ¶"><span class="nav-text">ä¸ªäººå¼€æº-realtime-serveræœåŠ¡å™¨æ¡†æ¶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æœ‰å•¥å¯ä»¥é—®ä»–çš„"><span class="nav-text">æœ‰å•¥å¯ä»¥é—®ä»–çš„</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è­¦å‘Š"><span class="nav-text">è­¦å‘Š</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#é¢ç­‹"><span class="nav-text">é¢ç­‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#æ¯”ç‹—"><span class="nav-text">æ¯”ç‹—</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è™¾"><span class="nav-text">è™¾</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#toc-one"><span class="nav-text">toc_one</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#infra-one"><span class="nav-text">infra_one</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#infra-two"><span class="nav-text">infra_two</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ç®—æ³•ä¸æ•°æ®ç»“æ„"><span class="nav-text">ç®—æ³•ä¸æ•°æ®ç»“æ„</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#è®¾è®¡æ¨¡å¼"><span class="nav-text">è®¾è®¡æ¨¡å¼</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#å„ä¸ªè¯­è¨€ä¹‹é—´çš„BENCHMARKå¯¹æ¯”"><span class="nav-text">å„ä¸ªè¯­è¨€ä¹‹é—´çš„BENCHMARKå¯¹æ¯”</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Python"><span class="nav-text">Python</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#æœ‰GILé‚£pyçš„å¤šçº¿ç¨‹è¿˜æœ‰ç”¨å—"><span class="nav-text">æœ‰GILé‚£pyçš„å¤šçº¿ç¨‹è¿˜æœ‰ç”¨å—?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åœ¨pythonç¨‹åºä¸­è°ƒç”¨cppçš„åº“åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦å—åˆ¶äºGIL"><span class="nav-text">åœ¨pythonç¨‹åºä¸­è°ƒç”¨cppçš„åº“åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦å—åˆ¶äºGIL?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä½¿ç”¨objgraphè§£å†³å†…å­˜æ³„æ¼é—®é¢˜"><span class="nav-text">ä½¿ç”¨objgraphè§£å†³å†…å­˜æ³„æ¼é—®é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å†…å­˜æ³„éœ²çš„è¯Šæ–­æ€è·¯"><span class="nav-text">å†…å­˜æ³„éœ²çš„è¯Šæ–­æ€è·¯</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¦‚ä½•è§£å†³pythonè¿›ç¨‹cpuçš„100-é—®é¢˜"><span class="nav-text">å¦‚ä½•è§£å†³pythonè¿›ç¨‹cpuçš„100%é—®é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#top-æŸ¥çœ‹-CPU-å’Œå†…å­˜å ç”¨"><span class="nav-text">top æŸ¥çœ‹ CPU å’Œå†…å­˜å ç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#strace-æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨"><span class="nav-text">strace æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ltrace-æŸ¥çœ‹åº“å‡½æ•°è°ƒç”¨"><span class="nav-text">ltrace æŸ¥çœ‹åº“å‡½æ•°è°ƒç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gcoreç”Ÿæˆcoredumpæ–‡ä»¶"><span class="nav-text">gcoreç”Ÿæˆcoredumpæ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gdb-åˆ†æ-coredump-æ–‡ä»¶"><span class="nav-text">gdb åˆ†æ coredump æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ€»ç»“-1"><span class="nav-text">æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#asyncioåç¨‹åŸç†"><span class="nav-text">asyncioåç¨‹åŸç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#asyncioåç¨‹æ ˆå¸§"><span class="nav-text">asyncioåç¨‹æ ˆå¸§</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#importæµç¨‹"><span class="nav-text">importæµç¨‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¸ºå•¥å­—ç¬¦ä¸²joinæ¯”åŠ å·è¿æ¥å¿«"><span class="nav-text">ä¸ºå•¥å­—ç¬¦ä¸²joinæ¯”åŠ å·è¿æ¥å¿«</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iså’Œ-çš„åŒºåˆ«"><span class="nav-text">iså’Œ==çš„åŒºåˆ«</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å…ƒç±»"><span class="nav-text">å…ƒç±»</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#metaclass"><span class="nav-text">metaclass</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è£…é¥°å™¨"><span class="nav-text">è£…é¥°å™¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pythonå‘½ä»¤è¡Œå‚æ•°"><span class="nav-text">pythonå‘½ä»¤è¡Œå‚æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#python-m-test-folder-test-pyä¸python-test-folder-testæœ‰ä»€ä¹ˆä¸åŒ"><span class="nav-text">python -m test_folder/test.pyä¸python test_folder/testæœ‰ä»€ä¹ˆä¸åŒ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#new-ä¸-del-ä¸-init"><span class="nav-text">__new__ ä¸ __del__ ä¸ __init__</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pythonåƒåœ¾å›æ”¶"><span class="nav-text">pythonåƒåœ¾å›æ”¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ ‡è®°æ¸…é™¤å’‹å¼„çš„"><span class="nav-text">æ ‡è®°æ¸…é™¤å’‹å¼„çš„</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ä¸ºå•¥æ ‡è®°æ¸…é™¤å›æ”¶æ— æ³•å›æ”¶é‡å†™äº†-del-æ–¹æ³•çš„ç±»å¯¹è±¡"><span class="nav-text">ä¸ºå•¥æ ‡è®°æ¸…é™¤å›æ”¶æ— æ³•å›æ”¶é‡å†™äº†__del__æ–¹æ³•çš„ç±»å¯¹è±¡</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆ†ä»£å›æ”¶"><span class="nav-text">åˆ†ä»£å›æ”¶</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CPP"><span class="nav-text">CPP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#gcc-å‘½ä»¤çš„å¸¸ç”¨é€‰é¡¹"><span class="nav-text">gcc å‘½ä»¤çš„å¸¸ç”¨é€‰é¡¹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä½¿ç”¨gcoreæˆ–straceå’ŒpstackæŸ¥è¯¢çº¿ä¸ŠCPUçš„100-é—®é¢˜"><span class="nav-text">ä½¿ç”¨gcoreæˆ–straceå’ŒpstackæŸ¥è¯¢çº¿ä¸ŠCPUçš„100%é—®é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å…ˆç”¨straceæŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨"><span class="nav-text">å…ˆç”¨straceæŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç”¨pstackæŸ¥çœ‹å½“å‰è°ƒç”¨å †æ ˆ"><span class="nav-text">ç”¨pstackæŸ¥çœ‹å½“å‰è°ƒç”¨å †æ ˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#æŸ¥çœ‹ç¨‹åºçš„è¿›ç¨‹å·"><span class="nav-text">æŸ¥çœ‹ç¨‹åºçš„è¿›ç¨‹å·</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æŸ¥çœ‹è€—-CPU-çš„çº¿ç¨‹å·"><span class="nav-text">æŸ¥çœ‹è€— CPU çš„çº¿ç¨‹å·</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æŸ¥çœ‹è€—-CPU-çš„ä»»åŠ¡"><span class="nav-text">æŸ¥çœ‹è€— CPU çš„ä»»åŠ¡</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä½¿ç”¨gcoreæ¥å¤„ç†"><span class="nav-text">ä½¿ç”¨gcoreæ¥å¤„ç†</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç”¨ASANå¤„ç†å†…å­˜æ³„æ¼ä¸è¶Šç•Œç­‰é—®é¢˜"><span class="nav-text">ç”¨ASANå¤„ç†å†…å­˜æ³„æ¼ä¸è¶Šç•Œç­‰é—®é¢˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å·¦å€¼å³å€¼é€šç”¨å¼•ç”¨"><span class="nav-text">å·¦å€¼å³å€¼é€šç”¨å¼•ç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#std-moveåº”ç”¨åœºæ™¯"><span class="nav-text">std::moveåº”ç”¨åœºæ™¯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é€šç”¨å¼•ç”¨"><span class="nav-text">é€šç”¨å¼•ç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#std-forward"><span class="nav-text">std::forward</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å®Œç¾è½¬å‘"><span class="nav-text">å®Œç¾è½¬å‘</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å…³äºenable-shared-from-this"><span class="nav-text">å…³äºenable_shared_from_this</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç¼–è¯‘è¿‡ç¨‹"><span class="nav-text">ç¼–è¯‘è¿‡ç¨‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç›®æ ‡æ–‡ä»¶"><span class="nav-text">ç›®æ ‡æ–‡ä»¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CPPç›®æ ‡æ–‡ä»¶å†…å­˜å¸ƒå±€"><span class="nav-text">CPPç›®æ ‡æ–‡ä»¶å†…å­˜å¸ƒå±€</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Go-pending-fin"><span class="nav-text">Go pending_fin</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#goroutineåç¨‹è°ƒåº¦"><span class="nav-text">goroutineåç¨‹è°ƒåº¦</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ç½‘ç»œå®‰å…¨"><span class="nav-text">ç½‘ç»œå®‰å…¨</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#XSS"><span class="nav-text">XSS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#XSSæ˜¯å¦‚ä½•æ³¨å…¥çš„"><span class="nav-text">XSSæ˜¯å¦‚ä½•æ³¨å…¥çš„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¦‚ä½•é˜²èŒƒXSS"><span class="nav-text">å¦‚ä½•é˜²èŒƒXSS</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CSRF"><span class="nav-text">CSRF</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CSRF-çš„ç‰¹ç‚¹"><span class="nav-text">CSRF çš„ç‰¹ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é˜²æŠ¤ç­–ç•¥"><span class="nav-text">é˜²æŠ¤ç­–ç•¥</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ç¼–ç çŸ¥è¯†"><span class="nav-text">ç¼–ç çŸ¥è¯†</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Base64-çš„åŸç†ï¼Ÿç¼–ç åæ¯”ç¼–ç å‰æ˜¯å¤§äº†è¿˜æ˜¯å°äº†ã€‚"><span class="nav-text">Base64 çš„åŸç†ï¼Ÿç¼–ç åæ¯”ç¼–ç å‰æ˜¯å¤§äº†è¿˜æ˜¯å°äº†ã€‚</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#base64çš„åŸç†"><span class="nav-text">base64çš„åŸç†</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#utf8ç¼–ç å’Œunicodeå­—ç¬¦é›†"><span class="nav-text">utf8ç¼–ç å’Œunicodeå­—ç¬¦é›†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UTF-8"><span class="nav-text">UTF-8</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#QUIC"><span class="nav-text">QUIC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#QUICæ¡æ‰‹æµç¨‹å›¾"><span class="nav-text">QUICæ¡æ‰‹æµç¨‹å›¾</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#QUICå¦‚ä½•é˜²æ­¢ä¸­é—´äººæ”»å‡»"><span class="nav-text">QUICå¦‚ä½•é˜²æ­¢ä¸­é—´äººæ”»å‡»</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#QUICçš„é‡æ”¾æ”»å‡»é—®é¢˜"><span class="nav-text">QUICçš„é‡æ”¾æ”»å‡»é—®é¢˜</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AOI"><span class="nav-text">AOI</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¹å®«æ ¼"><span class="nav-text">ä¹å®«æ ¼</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åå­—é“¾è¡¨"><span class="nav-text">åå­—é“¾è¡¨</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#misc"><span class="nav-text">misc</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx"><span class="nav-text">nginx</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mike</span>
</div>



        

        
      </div>
    </footer>

    <!--
    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      
        <span id="scrollpercent"><span>0</span>%</span>
      
    </div>
    -->

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>










  















  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/mediumzoom/medium-zoom.js?v=1.1.0"></script>





  




  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>


  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  

    <script src="/js/src/local-search.js"></script>





  

  

  

  

  

  


  <script type="text/javascript" src="/lib/wobble_window/wobblewindow.js"> </script>
<script type="text/javascript" src="/js/src/custom.js"></script>
</body>
</html>






<script type="text/javascript" src="/js/src/headroom.js"></script>

<!-- ä»£ç å—å¤åˆ¶åŠŸèƒ½ -->
<script type="text/javascript" src="/js/src/code-highlight-modification.js"></script>

<!-- Flashcards Script -->
<script type="text/javascript" src="/js/src/flashcards.js"></script>
