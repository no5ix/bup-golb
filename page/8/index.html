<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


  <meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)">

<script>
    (function(){
        if(''){
            let localStoragePasswdKey = '' + '_last_passwd';
            let tryCnt = 0;
            function checkPassword(password) {
                password = password == null ? null : password.trim();
                if (password !== '') {
                    if (password != null) {
                        // å¦‚æœç”¨æˆ·ç‚¹å‡»äº†ç¡®è®¤è€Œä¸”å¯†ç é”™è¯¯çš„æ—¶å€™, å› ä¸ºå½“password == nullçš„æ—¶å€™è¯´æ˜ç”¨æˆ·ç‚¹äº†å–æ¶ˆ
                        alert('Error!');
                        if (++tryCnt < 3) {
                            password = prompt('Open Sesame');
                            checkPassword(password);
                            return;
                        }
                    }

                    // if (history.length > 1) {
                    //     alert('back!');
                    //     history.back();
                    // } else {
                        // alert('blankkkk!');
                    //     window.location.href = "about:blank";
                    // }
                    if (document.referrer) {
                        window.location.href = document.referrer;
                    } else {
                        window.location.href = "about:blank";; // fallback if no referrer
                    }

                } else {
                    localStorage.setItem(localStoragePasswdKey, password);
                }
            }

            var password_verify_on_local = false;
            const hostname = window.location.hostname;
            if (password_verify_on_local || (!(hostname === "localhost" || hostname === "127.0.0.1" || hostname === "::1" || hostname.startsWith("192")))) {
                const lspk = localStorage.getItem(localStoragePasswdKey) || "";
                if (lspk !== '') {
                    var password = prompt('Open Sesame');
                    checkPassword(password);
                }
            }
        }
    })();
</script>








<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">





















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2">






<meta name="description" content="ğŸš™ ğŸš— ğŸ’¨ ğŸ’¨ If you want to create a blog like this, just follow my open-source project, &quot;hexo-theme-neo&quot;, click the GitHub button below and check it out ^_^ . It is recommended to use Chrome, Safari,">
<meta property="og:type" content="website">
<meta property="og:title" content="ğŸš™">
<meta property="og:url" content="https://hulinhong.com/page/8/index.html">
<meta property="og:site_name" content="ğŸš™">
<meta property="og:description" content="ğŸš™ ğŸš— ğŸ’¨ ğŸ’¨ If you want to create a blog like this, just follow my open-source project, &quot;hexo-theme-neo&quot;, click the GitHub button below and check it out ^_^ . It is recommended to use Chrome, Safari,">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ğŸš™">
<meta name="twitter:description" content="ğŸš™ ğŸš— ğŸ’¨ ğŸ’¨ If you want to create a blog like this, just follow my open-source project, &quot;hexo-theme-neo&quot;, click the GitHub button below and check it out ^_^ . It is recommended to use Chrome, Safari,">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":12,"scrollpercent":true,"onmobile":true,"dimmer":true,"body_content_height":0,"display_duration":150},
    local_search: {"enable":true,"trigger":"auto","top_n_per_article":1},
    fancybox: false,
    mediumzoom: true,
    darkmode_js: false,
    tabs: true,
    motion: {"enable":true,"async":false,"duration":188,"transition":{"header":"fadeIn","menu":"fadeIn","logo":"fadeIn","post_block_else":"fadeIn","post_header":"fadeIn","post_body":"fadeIn","coll_header":"fadeIn","footer":"fadeIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>








  <title>ğŸš™ - ğŸ’¨ ğŸ’¨ ğŸ’¨</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ğŸš™</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">ğŸ’¨ ğŸ’¨ ğŸ’¨</p>
      
  </div>

  <div class="menu-item sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div class="menu-item site-search">
    
  
  <div class="site-search-div">
    <button class="search-icon" id="search-button">
      <i class="fa fa-search"></i>
    </button>
    <input type="text" id="local-search-input" class="st-search-input">
    <i id="local-search-close">Ã—</i>
  </div>


<script type="text/javascript" id="local.search.active">
    {/* var inputArea       = document.querySelector("#local-search-input");
    inputArea.onclick   = function(){ getSearchFile(); this.focus(); }
    inputArea.onkeydown = function(){ if(event.keyCode == 13) return false } */}
</script>



  </div>
  <div id="local-search-result-pc" class="local-search-result-cls"></div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      

       
    </ul>
  

  
    
  
</nav>



 </div>
    </header>

    <div id="local-search-result-mobile" class="local-search-result-cls"></div>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      
        

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hulinhong.com/cpp_func_traits_intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mike">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ğŸš™">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/cpp_func_traits_intro/" itemprop="url">rpclibæºç é˜…è¯»ç¬”è®°ä¹‹æµ…è°ˆcpp func traits</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-18T01:59:01+00:00">
                04-18-2021
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Misc/" itemprop="url" rel="index">
                    <span itemprop="name">Misc</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    




    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      

      
      
        <div class="post-eof"></div>
      

      
      

      
        
          
            <p><a href="https://light-city.club/2019/10/07/traits/#!" target="_blank" rel="noopener">åŸæ–‡å‡ºå¤„</a></p>
<hr>
<h2 id="0-å¯¼è¯­"><a href="#0-å¯¼è¯­" class="headerlink" title="0. å¯¼è¯­"></a><strong>0. å¯¼è¯­</strong></h2><p>å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å…‰åŸï¼Œæ¬¢è¿å…³æ³¨å…¬ä¼—å·ï¼š<strong>guangcity</strong>ã€‚åœ¨ STL ç¼–ç¨‹ä¸­ï¼Œå®¹å™¨å’Œç®—æ³•æ˜¯ç‹¬ç«‹è®¾è®¡çš„ï¼Œå³æ•°æ®ç»“æ„å’Œç®—æ³•æ˜¯ç‹¬ç«‹è®¾è®¡çš„ï¼Œè¿æ¥å®¹å™¨å’Œç®—æ³•çš„æ¡¥æ¢å°±æ˜¯è¿­ä»£å™¨äº†ï¼Œè¿­ä»£å™¨ä½¿å…¶ç‹¬ç«‹è®¾è®¡æˆä¸ºå¯èƒ½ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p>ä¸Šå›¾ç»™å‡ºäº† STL çš„ç›®æ ‡å°±æ˜¯è¦æŠŠæ•°æ®å’Œç®—æ³•åˆ†å¼€ï¼Œåˆ†åˆ«å¯¹å…¶è¿›è¡Œè®¾è®¡ï¼Œä¹‹åé€šè¿‡ä¸€ç§åä¸º iterator çš„ä¸œè¥¿ï¼ŒæŠŠè¿™äºŒè€…å†ç²˜æ¥åˆ°ä¸€èµ·ã€‚</p>
<p>è®¾è®¡æ¨¡å¼ä¸­ï¼Œå…³äº iterator çš„æè¿°ä¸ºï¼š<strong>ä¸€ç§èƒ½å¤Ÿé¡ºåºè®¿é—®å®¹å™¨ä¸­æ¯ä¸ªå…ƒç´ çš„æ–¹æ³•ï¼Œä½¿ç”¨è¯¥æ–¹æ³•ä¸èƒ½æš´éœ²å®¹å™¨å†…éƒ¨çš„è¡¨è¾¾æ–¹å¼ã€‚è€Œç±»å‹èƒå–æŠ€æœ¯å°±æ˜¯ä¸ºäº†è¦è§£å†³å’Œ iterator æœ‰å…³çš„é—®é¢˜çš„ã€‚</strong></p>
<p>å®ƒå°†èŒƒå‹ç®—æ³• (find, count, find_if) ç”¨äºæŸä¸ªå®¹å™¨ä¸­, æœ€é‡è¦çš„æ˜¯è¦ç»™ç®—æ³•æä¾›ä¸€ä¸ªè®¿é—®å®¹å™¨å…ƒç´ çš„å·¥å…·ï¼Œiterator å°±æ‰®æ¼”ç€è¿™ä¸ªé‡è¦çš„è§’è‰²ã€‚</p>
<p>è€Œåœ¨ç®—æ³•ä¸­æˆ‘ä»¬å¯èƒ½ä¼šå®šä¹‰ç®€å•çš„ä¸­é—´å˜é‡æˆ–è€…è®¾å®šç®—æ³•çš„è¿”å›å˜é‡ç±»å‹ï¼Œè¿™æ—¶å€™éœ€è¦çŸ¥é“è¿­ä»£å™¨æ‰€æŒ‡å…ƒç´ çš„ç±»å‹æ˜¯ä»€ä¹ˆï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰ typeof è¿™ç±»åˆ¤æ–­ç±»å‹çš„å‡½æ•°, æˆ‘ä»¬æ— æ³•ç›´æ¥è·å–ï¼Œé‚£è¯¥å¦‚ä½•æ˜¯å¥½ï¼Ÿæœ¬æ–‡å°±æ¥å…·ä½“é˜è¿°ã€‚</p>
<p>å¯¹äºè¿­ä»£å™¨æ¥è¯´å°±æ˜¯ä¸€ç§æ™ºèƒ½æŒ‡é’ˆï¼Œå› æ­¤ï¼Œå®ƒä¹Ÿå°±æ‹¥æœ‰äº†ä¸€èˆ¬æŒ‡é’ˆçš„æ‰€æœ‰ç‰¹ç‚¹â€”â€”èƒ½å¤Ÿå¯¹å…¶è¿›è¡Œ * å’Œ -&gt; æ“ä½œã€‚ä½†æ˜¯åœ¨éå†å®¹å™¨çš„æ—¶å€™ï¼Œä¸å¯é¿å…çš„è¦å¯¹éå†çš„å®¹å™¨å†…éƒ¨æœ‰æ‰€äº†è§£ï¼Œæ‰€ä»¥ï¼Œå¹²è„†æŠŠè¿­ä»£å™¨çš„å¼€å‘å·¥ä½œäº¤ç»™å®¹å™¨çš„è®¾è®¡è€…å¥½äº†ï¼Œå¦‚æ­¤ä»¥æ¥ï¼Œæ‰€æœ‰å®ç°ç»†èŠ‚åè€Œå¾—ä»¥å°è£…èµ·æ¥ä¸è¢«ä½¿ç”¨è€…çœ‹åˆ°ï¼Œè¿™æ­£æ˜¯ä¸ºä»€ä¹ˆæ¯ä¸€ç§ STL å®¹å™¨éƒ½æä¾›æœ‰ä¸“å±è¿­ä»£å™¨çš„ç¼˜æ•…ã€‚</p>
<p>è€Œ Traits åœ¨<code>bits/stl_iterator_base_types.h</code>ä¸­ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> _<span class="title">Tp</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">struct</span> <span class="title">iterator_traits</span>&lt;_Tp*&gt;</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">ptrdiff_t</span> difference_type;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> _Tp::value_type value_type;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> _Tp::pointer pointer;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> _Tp::reference reference;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> _Tp::iterator_category iterator_category;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>çœ‹çš„ä¸€è„¸æ‡µé€¼å§ï¼Œæ²¡äº‹ï¼Œçœ‹å®Œæœ¬èŠ‚ï¼Œå…¥é—¨ STLï¼Œå“ˆå“ˆ~</p>
<h2 id="1-template-å‚æ•°æ¨å¯¼"><a href="#1-template-å‚æ•°æ¨å¯¼" class="headerlink" title="1.template å‚æ•°æ¨å¯¼"></a><strong>1.template å‚æ•°æ¨å¯¼</strong></h2><p>é¦–å…ˆï¼Œåœ¨ç®—æ³•ä¸­è¿ç”¨è¿­ä»£å™¨æ—¶ï¼Œå¾ˆå¯èƒ½ä¼šç”¨åˆ°<strong>å…¶ç›¸åº”å‹åˆ«ï¼ˆassociated typeï¼‰</strong>ï¼ˆè¿­ä»£å™¨æ‰€æŒ‡ä¹‹ç‰©çš„å‹åˆ«ï¼‰ã€‚å‡è®¾ç®—æ³•ä¸­æœ‰å¿…è¦å£°æ˜ä¸€ä¸ªå˜é‡ï¼Œä»¥ â€œè¿­ä»£å™¨æ‰€æŒ‡å¯¹è±¡çš„å‹åˆ«â€ ä¸ºå‹åˆ«ï¼Œè¯¥<strong>æ€ä¹ˆåŠå‘¢ï¼Ÿ</strong></p>
<p><strong>è§£å†³æ–¹æ³•æ˜¯ï¼šåˆ©ç”¨ function template çš„å‚æ•°æ¨å¯¼æœºåˆ¶ã€‚</strong></p>
<p>ä¾‹å¦‚ï¼š</p>
<p>å¦‚æœ T æ˜¯æŸä¸ªæŒ‡å‘ç‰¹å®šå¯¹è±¡çš„æŒ‡é’ˆï¼Œé‚£ä¹ˆåœ¨ func ä¸­éœ€è¦æŒ‡é’ˆæ‰€æŒ‡å‘å¯¹è±¡çš„å‹åˆ«çš„æ—¶å€™ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿè¿™ä¸ªè¿˜æ¯”è¾ƒå®¹æ˜“ï¼Œæ¨¡æ¿çš„å‚æ•°æ¨å¯¼æœºåˆ¶å¯ä»¥å®Œæˆä»»åŠ¡ï¼Œ</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">I</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">inline</span></span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">func</span>(<span class="title">I</span> <span class="title">iter</span>) &#123;</span></span><br><span class="line">    func_impl(iter, *iter); <span class="comment">// ä¼ å…¥iterå’Œiteræ‰€æŒ‡çš„å€¼ï¼Œclassè‡ªåŠ¨æ¨å¯¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡æ¨¡æ¿çš„æ¨å¯¼æœºåˆ¶ï¼Œæˆ‘ä»¬è½»è€Œæ˜“ä¸¾çš„æˆ–å¾—äº†æŒ‡é’ˆæ‰€æŒ‡å‘çš„å¯¹è±¡çš„ç±»å‹ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">I</span>, <span class="title">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">func_impl</span>(<span class="title">I</span> <span class="title">iter</span>, <span class="title">T</span> <span class="title">t</span>) &#123;</span></span><br><span class="line">        T tmp; <span class="comment">// è¿™é‡Œå°±æ˜¯è¿­ä»£å™¨æ‰€æŒ‡ç‰©çš„ç±»åˆ«</span></span><br><span class="line">        <span class="comment">// ... åŠŸèƒ½å®ç°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    func(&amp;i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ï¼Œ<strong>å‡½æ•°çš„ â€œtemplate å‚æ•°æ¨å¯¼æœºåˆ¶â€ æ¨å¯¼çš„åªæ˜¯å‚æ•°ï¼Œæ— æ³•æ¨å¯¼å‡½æ•°çš„è¿”å›å€¼ç±»å‹ã€‚ä¸‡ä¸€éœ€è¦æ¨å¯¼å‡½æ•°çš„ä¼ å›å€¼ï¼Œå°±æ— èƒ½ä¸ºåŠ›äº†</strong>ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¼•å‡ºä¸‹é¢çš„æ–¹æ³•ã€‚</p>
<h2 id="2-å£°æ˜å†…åµŒå‹åˆ«"><a href="#2-å£°æ˜å†…åµŒå‹åˆ«" class="headerlink" title="2. å£°æ˜å†…åµŒå‹åˆ«"></a><strong>2. å£°æ˜å†…åµŒå‹åˆ«</strong></h2><p><strong>è¿­ä»£å™¨æ‰€æŒ‡å¯¹è±¡çš„å‹åˆ«ï¼Œç§°ä¹‹ä¸ºè¿­ä»£å™¨çš„ value typeã€‚</strong></p>
<p>å°½ç®¡åœ¨ func_impl ä¸­æˆ‘ä»¬å¯ä»¥æŠŠ T ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ï¼Œä½†æ˜¯é—®é¢˜æ˜¯ç”¨æˆ·éœ€è¦è°ƒç”¨çš„æ˜¯ funcã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">I</span>, <span class="title">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">T</span> <span class="title">func_impl</span>(<span class="title">I</span> <span class="title">iter</span>, <span class="title">T</span> <span class="title">t</span>) &#123;</span></span><br><span class="line">        T tmp; <span class="comment">// è¿™é‡Œå°±æ˜¯è¿­ä»£å™¨æ‰€æŒ‡ç‰©çš„ç±»åˆ«</span></span><br><span class="line">        <span class="comment">// ... åŠŸèƒ½å®ç°</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class">(*<span class="title">T</span>) <span class="title">func</span>(<span class="title">T</span> <span class="title">t</span>) &#123;</span> <span class="comment">// !!!Wrong code</span></span><br><span class="line">    <span class="keyword">return</span> func_impl(t, *t); <span class="comment">// forward the task to func_impl</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i  =<span class="number">10</span>;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;func(&amp;i)&lt;&lt;<span class="built_in">endl</span>; <span class="comment">// !!! Canâ€™t pass compile</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœå»ç¼–è¯‘ä¸Šè¿°ä»£ç ï¼Œç¼–è¯‘å¤±è´¥ï¼</p>
<p>è¿™ä¸ªé—®é¢˜è§£å†³èµ·æ¥ä¹Ÿä¸éš¾ï¼Œå£°æ˜å†…åµŒå‹åˆ«ä¼¼ä¹æ˜¯ä¸ªå¥½ä¸»æ„ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è·å–ã€‚åªè¦åšä¸€ä¸ª iteratorï¼Œç„¶ååœ¨å®šä¹‰çš„æ—¶å€™ä¸ºå…¶æŒ‡å‘çš„å¯¹è±¡ç±»å‹åˆ¶å®šä¸€ä¸ªåˆ«åï¼Œå°±å¥½äº†ï¼Œåƒä¸‹é¢è¿™æ ·ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">struct</span> <span class="title">MyIter</span> &#123;</span></span><br><span class="line">    <span class="keyword">typedef</span> T value_type; <span class="comment">// å†…åµŒå‹åˆ«å£°æ˜</span></span><br><span class="line">    T* ptr;</span><br><span class="line">    MyIter(T* p = <span class="number">0</span>) : ptr(p) &#123;&#125;</span><br><span class="line">    T&amp; <span class="keyword">operator</span>*() <span class="keyword">const</span> &#123; <span class="keyword">return</span> *ptr; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">I</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">typename</span> <span class="title">I</span>:</span>:value_type</span><br><span class="line">func(I ite) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"class version"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> *ite;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    MyIter&lt;<span class="keyword">int</span>&gt; ite(<span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">8</span>));</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; func(ite);    <span class="comment">// è¾“å‡º8</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¾ˆæ¼‚äº®çš„è§£å†³æ–¹æ¡ˆï¼Œçœ‹ä¸Šå»ä¸€åˆ‡éƒ½å¾ˆå®Œç¾ã€‚ä½†æ˜¯ï¼Œå®é™…ä¸Šè¿˜æ˜¯æœ‰é—®é¢˜ï¼Œå› ä¸º func å¦‚æœæ˜¯ä¸€ä¸ªæ³›å‹ç®—æ³•ï¼Œé‚£ä¹ˆå®ƒä¹Ÿç»å¯¹è¦æ¥å—ä¸€ä¸ªåŸç”ŸæŒ‡é’ˆä½œä¸ºè¿­ä»£å™¨ï¼Œä½†æ˜¯æ˜¾ç„¶ï¼Œä½ æ— æ³•è®©ä¸‹é¢çš„ä»£ç ç¼–è¯‘é€šè¿‡ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> *p = <span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">5</span>);</span><br><span class="line"><span class="built_in">cout</span>&lt;&lt;func(p)&lt;&lt;<span class="built_in">endl</span>; <span class="comment">// error</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çš„ func æ— æ³•æ”¯æŒåŸç”ŸæŒ‡é’ˆï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸èƒ½æ¥å—çš„ã€‚æ­¤æ—¶ï¼Œtemplate partial specialization å°±æ´¾ä¸Šäº†ç”¨åœºã€‚</p>
<h2 id="3-æ•‘ä¸–ä¸»-Traits"><a href="#3-æ•‘ä¸–ä¸»-Traits" class="headerlink" title="3. æ•‘ä¸–ä¸» Traits"></a><strong>3. æ•‘ä¸–ä¸» Traits</strong></h2><p>å‰é¢ä¹Ÿæåˆ°äº†ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨<code>typename I::value_type</code>ï¼Œç®—æ³•å°±æ— æ³•æ¥æ”¶åŸç”ŸæŒ‡é’ˆï¼Œå› ä¸ºåŸç”ŸæŒ‡é’ˆæ ¹æœ¬å°±æ²¡æœ‰ value_type è¿™ä¸ªå†…åµŒç±»å‹ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åŠ å…¥ä¸€ä¸ªä¸­é—´å±‚å¯¹å…¶è¿›è¡Œåˆ¤æ–­ï¼Œçœ‹å®ƒæ˜¯ä¸æ˜¯åŸç”ŸæŒ‡é’ˆï¼Œæ³¨æ„ï¼Œè¿™å°±æ˜¯ traits æŠ€æ³•çš„å¦™å¤„æ‰€åœ¨ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬åªä½¿ç”¨ä¸Šé¢çš„åšæ³•ï¼Œä¹Ÿå°±æ˜¯å†…åµŒ value_typeï¼Œé‚£ä¹ˆå¯¹äºæ²¡æœ‰ value_type çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬åªèƒ½å¯¹å…¶è¿›è¡Œåç‰¹åŒ–ï¼Œè¿™ç§åç‰¹åŒ–æ˜¯é’ˆå¯¹å¯è°ƒç”¨å‡½æ•° func çš„åç‰¹åŒ–ï¼Œå‡å¦‚ func æœ‰ 100 ä¸‡è¡Œè¡Œä»£ç ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆæå¤§çš„è§†è§‰æ±¡æŸ“ã€‚</p>
<p><strong>ï¼ˆ1ï¼‰å‡½æ•°åç‰¹åŒ–</strong></p>
<p>å‡½æ•°åç‰¹åŒ–ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">struct</span> <span class="title">MyIter</span> &#123;</span></span><br><span class="line">    <span class="keyword">typedef</span> T value_type; <span class="comment">// å†…åµŒå‹åˆ«å£°æ˜</span></span><br><span class="line">    T* ptr;</span><br><span class="line">    MyIter(T* p = <span class="number">0</span>) : ptr(p) &#123;&#125;</span><br><span class="line">    T&amp; <span class="keyword">operator</span>*() <span class="keyword">const</span> &#123; <span class="keyword">return</span> *ptr; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">I</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">typename</span> <span class="title">I</span>:</span>:value_type</span><br><span class="line">func(I ite) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"class version"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> *ite;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">I</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">I</span></span></span><br><span class="line"><span class="class"><span class="title">func</span>(<span class="title">I</span>* <span class="title">ite</span>) &#123;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"pointer version"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> *ite;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">I</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">I</span> <span class="title">func</span>(<span class="title">const</span> <span class="title">I</span>* <span class="title">ite</span>) &#123;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"const pointer version"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> *ite;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    MyIter&lt;<span class="keyword">int</span>&gt; ite(<span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">8</span>));</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; func(ite)&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">int</span> *p = <span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">52</span>);</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;func(p)&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> k = <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;func(&amp;k)&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class version</span><br><span class="line">8</span><br><span class="line">pointer version</span><br><span class="line">52</span><br><span class="line">const pointer version</span><br><span class="line">3</span><br></pre></td></tr></table></figure>
<p><strong>ï¼ˆ2ï¼‰åŠ å…¥ä¸­é—´å±‚</strong></p>
<p>åœ¨ STL ä¸­ Traits æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿçœ‹ä¸‹å›¾ï¼š</p>
<p>åˆ©ç”¨ä¸€ä¸ªä¸­é—´å±‚<code>iterator_traits</code>å›ºå®šäº†<code>func</code>çš„å½¢å¼ï¼Œä½¿å¾—é‡å¤çš„ä»£ç å¤§é‡å‡å°‘ï¼Œå”¯ä¸€è¦åšçš„å°±æ˜¯ç¨ç¨ç‰¹åŒ–ä¸€ä¸‹ iterator_tartis ä½¿å…¶æ”¯æŒ pointer å’Œ const pointer:)</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">struct</span> <span class="title">MyIter</span> &#123;</span></span><br><span class="line">    <span class="keyword">typedef</span> T value_type; <span class="comment">// å†…åµŒå‹åˆ«å£°æ˜</span></span><br><span class="line">    T* ptr;</span><br><span class="line">    MyIter(T* p = <span class="number">0</span>) : ptr(p) &#123;&#125;</span><br><span class="line">    T&amp; <span class="keyword">operator</span>*() <span class="keyword">const</span> &#123; <span class="keyword">return</span> *ptr; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// class type</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">struct</span> <span class="title">iterator_traits</span> &#123;</span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> T::value_type value_type;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// åç‰¹åŒ–1</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">struct</span> <span class="title">iterator_traits</span>&lt;T*&gt; &#123;</span></span><br><span class="line">    <span class="keyword">typedef</span> T value_type;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// åç‰¹åŒ–2</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">struct</span> <span class="title">iterator_traits</span>&lt;const T*&gt; &#123;</span></span><br><span class="line">    <span class="keyword">typedef</span> T value_type;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">I</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">typename</span> <span class="title">iterator_traits</span>&lt;I&gt;:</span>:value_type</span><br><span class="line"><span class="comment">// é¦–å…ˆè¯¢é—®iterator_traits&lt;I&gt;::value_type,å¦‚æœä¼ é€’çš„Iä¸ºæŒ‡é’ˆ,åˆ™è¿›å…¥ç‰¹åŒ–ç‰ˆæœ¬,iterator_traitsç›´æ¥å›ç­”;å¦‚æœä¼ é€’è¿›æ¥çš„Iä¸ºclass type,å°±å»è¯¢é—®T::value_type.</span></span><br><span class="line">func(I ite) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"normal version"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> *ite;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    MyIter&lt;<span class="keyword">int</span>&gt; ite(<span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">8</span>));</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; func(ite)&lt;&lt;<span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">int</span> *p = <span class="keyword">new</span> <span class="keyword">int</span>(<span class="number">52</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;func(p)&lt;&lt;<span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> k = <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;func(&amp;k)&lt;&lt;<span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°çš„è¿‡ç¨‹æ˜¯é¦–å…ˆè¯¢é—®<code>iterator_traits&lt;I&gt;::value_type</code>ï¼Œå¦‚æœä¼ é€’çš„ I ä¸ºæŒ‡é’ˆ, åˆ™è¿›å…¥ç‰¹åŒ–ç‰ˆæœ¬,<code>iterator_traits</code>ç›´æ¥å›ç­”<code>T</code>; å¦‚æœä¼ é€’è¿›æ¥çš„<code>I</code>ä¸º<code>class type</code>, å°±å»è¯¢é—®<code>T::value_type</code>.</p>
<p>ä¸Šè¿°çš„é€šä¿—è§£é‡Šä¸ºç®—æ³• (func) é—® iterator_traits(æˆ‘)ï¼Œä½†æ˜¯ iterator_traits(æˆ‘)å‘ç°æ‰‹ä¸Šæ˜¯æŒ‡é’ˆçš„æ—¶å€™ï¼Œå°±ç”±æˆ‘æ¥æ›¿å®ƒå›ç­”ã€‚å¦‚æœæ˜¯ class typeï¼Œiterator_traits(æˆ‘)å°±ç»§ç»­é—®(ä»– â€”T::value_type)ã€‚</p>
<p><strong>æ€»ç»“ï¼šé€šè¿‡å®šä¹‰å†…åµŒç±»å‹ï¼Œæˆ‘ä»¬è·å¾—äº†çŸ¥æ™“ iterator æ‰€æŒ‡å…ƒç´ ç±»å‹çš„æ–¹æ³•ï¼Œé€šè¿‡ traits æŠ€æ³•ï¼Œæˆ‘ä»¬å°†å‡½æ•°æ¨¡æ¿å¯¹äºåŸç”ŸæŒ‡é’ˆå’Œè‡ªå®šä¹‰ iterator çš„å®šä¹‰éƒ½ç»Ÿä¸€èµ·æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ traits æŠ€æ³•ä¸»è¦æ˜¯ä¸ºäº†è§£å†³åŸç”ŸæŒ‡é’ˆå’Œè‡ªå®šä¹‰ iterator ä¹‹é—´çš„ä¸åŒæ‰€é€ æˆçš„ä»£ç å†—ä½™ï¼Œè¿™å°±æ˜¯ traits æŠ€æ³•çš„å¦™å¤„æ‰€åœ¨ã€‚</strong></p>
<p>å­¦ä¹ ä¹¦ç±ï¼š</p>
<blockquote>
<p>ä¾¯æ·ã€Š STL æºç å‰–æã€‹  </p>
</blockquote>
<p>å­¦ä¹ æ–‡ç« ï¼š</p>
<blockquote>
<p><a href="https://link.zhihu.com/?target=https%3A//juejin.im/post/5b1a43fb51882513bf1795c6" target="_blank" rel="noopener">https://juejin.im/post/5b1a43fb51882513bf1795c6</a><br><a href="https://link.zhihu.com/?target=https%3A//www.cnblogs.com/mangoyuan/p/6446046.html" target="_blank" rel="noopener">https://www.cnblogs.com/mangoyuan/p/6446046.html</a><br><a href="https://link.zhihu.com/?target=http%3A//www.cppblog.com/nacci/archive/2005/11/03/911.aspx" target="_blank" rel="noopener">http://www.cppblog.com/nacci/archive/2005/11/03/911.aspx</a>  </p>
</blockquote>

          
        
      


      

    
      <footer class="post-footer">
        

        

        

        
        
          <div class="post-eof"></div>
        
      </footer>
      
    </div>
    
    
    

    

    

    

  </div>
  
  
  
  </article>


      
    
      
        

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hulinhong.com/self_cultivation_python/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mike">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ğŸš™">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/self_cultivation_python/" itemprop="url">æœåŠ¡å™¨å¼€å‘è‡ªæˆ‘ä¿®å…»ä¸“æ -Pythonç²¾è¦</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-27T19:08:06+00:00">
                03-27-2021
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Self-cultivation/" itemprop="url" rel="index">
                    <span itemprop="name">Self-cultivation</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    




    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      

      
      
        <div class="post-eof"></div>
      

      
      

      
        
          
            <h1 id="python"><a href="#python" class="headerlink" title="python"></a>python</h1><ul>
<li>mroé—®é¢˜</li>
<li>æ€ä¹ˆå®ç°ä¸€ä¸ªåç¨‹åº“?</li>
<li>mockæ˜¯å•¥: <a href="https://zhuanlan.zhihu.com/p/30380243" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/30380243</a></li>
</ul>
<h2 id="importæµç¨‹"><a href="#importæµç¨‹" class="headerlink" title="importæµç¨‹"></a>importæµç¨‹</h2><ul>
<li>å½“Pythonçš„è§£é‡Šå™¨é‡åˆ°importè¯­å¥æˆ–è€…å…¶ä»–ä¸Šè¿°å¯¼å…¥è¯­å¥æ—¶,å®ƒä¼šå…ˆå»æŸ¥çœ‹sys.modulesä¸­æ˜¯å¦å·²ç»æœ‰åŒåæ¨¡å—è¢«å¯¼å…¥äº†,</li>
<li>å¦‚æœæœ‰å°±ç›´æ¥å–æ¥ç”¨;æ²¡æœ‰å°±å»æŸ¥é˜…sys.pathé‡Œé¢æ‰€æœ‰å·²ç»å‚¨å­˜çš„ç›®å½•.<ul>
<li>sys.pathè¿™ä¸ªåˆ—è¡¨åˆå§‹åŒ–çš„æ—¶å€™,é€šå¸¸åŒ…å«ä¸€äº›æ¥è‡ªå¤–éƒ¨çš„åº“(external libraries)æˆ–è€…æ˜¯æ¥è‡ªæ“ä½œç³»ç»Ÿçš„ä¸€äº›åº“,å½“ç„¶ä¹Ÿä¼šæœ‰ä¸€äº›ç±»ä¼¼äºdist-packageçš„æ ‡å‡†åº“åœ¨é‡Œé¢.è¿™äº›ç›®å½•é€šå¸¸æ˜¯è¢«æŒ‰ç…§é¡ºåºæˆ–è€…æ˜¯ç›´æ¥å»æœç´¢æƒ³è¦çš„â€“å¦‚æœè¯´ä»–ä»¬å½“ä¸­çš„ä¸€ä¸ªåŒ…å«æœ‰æœŸæœ›çš„packageæˆ–è€…æ˜¯module,è¿™ä¸ªpackageæˆ–è€…æ˜¯moduleå°†ä¼šåœ¨æ•´ä¸ªè¿‡ç¨‹ç»“æŸçš„æ—¶å€™è¢«ç›´æ¥æå–å‡ºæ¥ä¿å­˜åœ¨sys.modulesä¸­(sys.modulesæ˜¯ä¸€ä¸ªæ¨¡å—å:æ¨¡å—å¯¹è±¡çš„å­—å…¸ç»“æ„).</li>
<li>å½“ç„¶ï¼Œè¿™ä¸ª sys.path æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼ˆæ­£å¦‚ä¸Šæ–‡æåˆ°çš„ä¸€ç§è§£å†³åŠæ³•ï¼‰ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœå½“å‰ç›®å½•åŒ…å«æœ‰å’Œæ ‡å‡†åº“åŒåçš„æ¨¡å—ï¼Œä¼šç›´æ¥ä½¿ç”¨å½“å‰ç›®å½•çš„æ¨¡å—è€Œä¸æ˜¯æ ‡å‡†æ¨¡å—ã€‚</li>
<li>å½“åœ¨è¿™äº›ä¸ªåœ°å€ä¸­å®åœ¨æ˜¯æ‰¾ä¸ç€æ—¶,å®ƒå°±ä¼šæŠ›å‡ºä¸€ä¸ªModuleNotFoundErroré”™è¯¯.</li>
</ul>
</li>
<li>å½“æˆ‘ä»¬è¦å¯¼å…¥ä¸€ä¸ªæ¨¡å—ï¼ˆæ¯”å¦‚ foo ï¼‰æ—¶ï¼Œè§£é‡Šå™¨é¦–å…ˆä¼šæ ¹æ®å‘½åæŸ¥æ‰¾å†…ç½®æ¨¡å—ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå®ƒå°±ä¼šå»æŸ¥æ‰¾ sys.path åˆ—è¡¨ä¸­çš„ç›®å½•ï¼Œçœ‹ç›®å½•ä¸­æ˜¯å¦æœ‰ foo.py ã€‚sys.path çš„åˆå§‹å€¼æ¥è‡ªäºï¼š  <ul>
<li>è¿è¡Œè„šæœ¬æ‰€åœ¨çš„ç›®å½•ï¼ˆå¦‚æœæ‰“å¼€çš„æ˜¯äº¤äº’å¼è§£é‡Šå™¨åˆ™æ˜¯å½“å‰ç›®å½•ï¼‰</li>
<li>PYTHONPATH ç¯å¢ƒå˜é‡ï¼ˆç±»ä¼¼äº PATH å˜é‡ï¼Œä¹Ÿæ˜¯ä¸€ç»„ç›®å½•åç»„æˆï¼‰</li>
<li>Python å®‰è£…æ—¶çš„é»˜è®¤è®¾ç½®</li>
</ul>
</li>
</ul>
<h2 id="ä¸ºå•¥å­—ç¬¦ä¸²joinæ¯”åŠ å·è¿æ¥å¿«"><a href="#ä¸ºå•¥å­—ç¬¦ä¸²joinæ¯”åŠ å·è¿æ¥å¿«" class="headerlink" title="ä¸ºå•¥å­—ç¬¦ä¸²joinæ¯”åŠ å·è¿æ¥å¿«"></a>ä¸ºå•¥å­—ç¬¦ä¸²joinæ¯”åŠ å·è¿æ¥å¿«</h2><p>å­—ç¬¦ä¸²æ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œå½“ç”¨æ“ä½œç¬¦<code>+</code>è¿æ¥å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œæ¯æ‰§è¡Œä¸€æ¬¡<code>+</code>éƒ½ä¼šç”³è¯·ä¸€å—æ–°çš„å†…å­˜ï¼Œç„¶åå¤åˆ¶ä¸Šä¸€ä¸ª<code>+</code>æ“ä½œçš„ç»“æœå’Œæœ¬æ¬¡æ“ä½œçš„å³æ“ä½œç¬¦åˆ°è¿™å—å†…å­˜ç©ºé—´ï¼Œå› æ­¤ç”¨<code>+</code>è¿æ¥å­—ç¬¦ä¸²çš„æ—¶å€™ä¼šæ¶‰åŠå¥½å‡ æ¬¡å†…å­˜ç”³è¯·å’Œå¤åˆ¶ã€‚è€Œ<code>join</code>åœ¨è¿æ¥å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œä¼šå…ˆè®¡ç®—éœ€è¦å¤šå¤§çš„å†…å­˜å­˜æ”¾ç»“æœï¼Œç„¶åä¸€æ¬¡æ€§ç”³è¯·æ‰€éœ€å†…å­˜å¹¶å°†å­—ç¬¦ä¸²å¤åˆ¶è¿‡å»ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆ<code>join</code>çš„æ€§èƒ½ä¼˜äº<code>+</code>çš„åŸå› ã€‚æ‰€ä»¥åœ¨è¿æ¥å­—ç¬¦ä¸²æ•°ç»„çš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”è€ƒè™‘ä¼˜å…ˆä½¿ç”¨<code>join</code>ã€‚</p>
<h2 id="iså’Œ-çš„åŒºåˆ«"><a href="#iså’Œ-çš„åŒºåˆ«" class="headerlink" title="iså’Œ==çš„åŒºåˆ«"></a>iså’Œ==çš„åŒºåˆ«</h2><p>å®˜æ–¹æ–‡æ¡£ä¸­è¯´ is è¡¨ç¤ºçš„æ˜¯å¯¹è±¡æ ‡ç¤ºç¬¦ï¼ˆobject identityï¼‰ï¼Œè€Œ == è¡¨ç¤ºçš„æ˜¯ç›¸ç­‰ï¼ˆequalityï¼‰ã€‚is çš„ä½œç”¨æ˜¯ç”¨æ¥æ£€æŸ¥å¯¹è±¡çš„æ ‡ç¤ºç¬¦æ˜¯å¦ä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡åœ¨å†…å­˜ä¸­çš„åœ°å€æ˜¯å¦ä¸€æ ·ï¼Œè€Œ == æ˜¯ç”¨æ¥æ£€æŸ¥ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰ã€‚</p>
<p>æˆ‘ä»¬åœ¨æ£€æŸ¥ a is b çš„æ—¶å€™ï¼Œå…¶å®ç›¸å½“äºæ£€æŸ¥ id(a) == id(b)ã€‚è€Œæ£€æŸ¥ a == b çš„æ—¶å€™ï¼Œå®é™…æ˜¯è°ƒç”¨äº†å¯¹è±¡ a çš„ <strong>eq()</strong> æ–¹æ³•ï¼Œa == b ç›¸å½“äº a.<strong>eq</strong>(b)ã€‚</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœ a is b è¿”å›Trueçš„è¯ï¼Œå³ a å’Œ b æŒ‡å‘åŒä¸€å—å†…å­˜åœ°å€çš„è¯ï¼Œa == b ä¹Ÿè¿”å›Trueï¼Œå³ a å’Œ b çš„å€¼ä¹Ÿç›¸ç­‰ã€‚</p>
<h2 id="å…ƒç±»"><a href="#å…ƒç±»" class="headerlink" title="å…ƒç±»"></a>å…ƒç±»</h2><p>å‚è€ƒ: <a href="https://www.liaoxuefeng.com/wiki/1016959663602400/1017592449371072" target="_blank" rel="noopener">https://www.liaoxuefeng.com/wiki/1016959663602400/1017592449371072</a></p>
<p>pythonå…ƒç±»çš„ä½¿ç”¨åœºæ™¯, æ¯”å¦‚ormæ¡†æ¶, ORMå…¨ç§°â€œObject Relational Mappingâ€ï¼Œå³å¯¹è±¡-å…³ç³»æ˜ å°„ï¼Œå°±æ˜¯æŠŠå…³ç³»æ•°æ®åº“çš„ä¸€è¡Œæ˜ å°„ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªç±»å¯¹åº”ä¸€ä¸ªè¡¨ï¼Œè¿™æ ·ï¼Œå†™ä»£ç æ›´ç®€å•ï¼Œä¸ç”¨ç›´æ¥æ“ä½œSQLè¯­å¥ã€‚</p>
<p><code>type()</code>å‡½æ•°æ—¢å¯ä»¥è¿”å›ä¸€ä¸ªå¯¹è±¡çš„ç±»å‹ï¼Œåˆå¯ä»¥åˆ›å»ºå‡ºæ–°çš„ç±»å‹ï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>type()</code>å‡½æ•°åˆ›å»ºå‡º<code>Hello</code>ç±»ï¼Œè€Œæ— éœ€é€šè¿‡<code>class Hello(object)...</code>çš„å®šä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\&gt;&gt;&gt; def fn(self, name=&apos;world&apos;): # å…ˆå®šä¹‰å‡½æ•°</span><br><span class="line">...     print(&apos;Hello, %s.&apos; % name)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt; Hello = type(&apos;Hello&apos;, (object,), dict(hello=fn)) # åˆ›å»ºHello class</span><br><span class="line">&gt;&gt;&gt; h = Hello()</span><br><span class="line">&gt;&gt;&gt; h.hello()</span><br><span class="line">Hello, world.</span><br><span class="line">&gt;&gt;&gt; print(type(Hello))</span><br><span class="line">&lt;class &apos;type&apos;&gt;</span><br><span class="line">&gt;&gt;&gt; print(type(h))</span><br><span class="line">&lt;class &apos;__main__.Hello&apos;&gt;</span><br></pre></td></tr></table></figure>
<p>è¦åˆ›å»ºä¸€ä¸ª class å¯¹è±¡ï¼Œ<code>type()</code>å‡½æ•°ä¾æ¬¡ä¼ å…¥ 3 ä¸ªå‚æ•°ï¼š</p>
<ol>
<li>class çš„åç§°ï¼›</li>
<li>ç»§æ‰¿çš„çˆ¶ç±»é›†åˆï¼Œæ³¨æ„ Python æ”¯æŒå¤šé‡ç»§æ‰¿ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªçˆ¶ç±»ï¼Œåˆ«å¿˜äº† tuple çš„å•å…ƒç´ å†™æ³•ï¼›</li>
<li>class çš„æ–¹æ³•åç§°ä¸å‡½æ•°ç»‘å®šï¼Œè¿™é‡Œæˆ‘ä»¬æŠŠå‡½æ•°<code>fn</code>ç»‘å®šåˆ°æ–¹æ³•å<code>hello</code>ä¸Šã€‚</li>
</ol>
<p><strong>é€šè¿‡<code>type()</code>å‡½æ•°åˆ›å»ºçš„ç±»å’Œç›´æ¥å†™ class æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œå› ä¸º Python è§£é‡Šå™¨é‡åˆ° class å®šä¹‰æ—¶ï¼Œä»…ä»…æ˜¯æ‰«æä¸€ä¸‹ class å®šä¹‰çš„è¯­æ³•ï¼Œç„¶åè°ƒç”¨<code>type()</code>å‡½æ•°åˆ›å»ºå‡º class</strong>ã€‚</p>
<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ç”¨<code>class Xxx...</code>æ¥å®šä¹‰ç±»ï¼Œä½†æ˜¯ï¼Œ<code>type()</code>å‡½æ•°ä¹Ÿå…è®¸æˆ‘ä»¬åŠ¨æ€åˆ›å»ºå‡ºç±»æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒåŠ¨æ€è¯­è¨€æœ¬èº«æ”¯æŒè¿è¡ŒæœŸåŠ¨æ€åˆ›å»ºç±»ï¼Œè¿™å’Œé™æ€è¯­è¨€æœ‰éå¸¸å¤§çš„ä¸åŒï¼Œè¦åœ¨é™æ€è¯­è¨€è¿è¡ŒæœŸåˆ›å»ºç±»ï¼Œå¿…é¡»æ„é€ æºä»£ç å­—ç¬¦ä¸²å†è°ƒç”¨ç¼–è¯‘å™¨ï¼Œæˆ–è€…å€ŸåŠ©ä¸€äº›å·¥å…·ç”Ÿæˆå­—èŠ‚ç å®ç°ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯åŠ¨æ€ç¼–è¯‘ï¼Œä¼šéå¸¸å¤æ‚ã€‚</p>
<h3 id="metaclass"><a href="#metaclass" class="headerlink" title="metaclass"></a>metaclass</h3><p>é™¤äº†ä½¿ç”¨<code>type()</code>åŠ¨æ€åˆ›å»ºç±»ä»¥å¤–ï¼Œè¦æ§åˆ¶ç±»çš„åˆ›å»ºè¡Œä¸ºï¼Œè¿˜å¯ä»¥ä½¿ç”¨ metaclassã€‚<br>metaclassï¼Œç›´è¯‘ä¸ºå…ƒç±»ï¼Œç®€å•çš„è§£é‡Šå°±æ˜¯ï¼š<br>å½“æˆ‘ä»¬å®šä¹‰äº†ç±»ä»¥åï¼Œå°±å¯ä»¥æ ¹æ®è¿™ä¸ªç±»åˆ›å»ºå‡ºå®ä¾‹ï¼Œæ‰€ä»¥ï¼šå…ˆå®šä¹‰ç±»ï¼Œç„¶ååˆ›å»ºå®ä¾‹ã€‚<br>ä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³åˆ›å»ºå‡ºç±»å‘¢ï¼Ÿé‚£å°±å¿…é¡»æ ¹æ® metaclass åˆ›å»ºå‡ºç±»ï¼Œæ‰€ä»¥ï¼šå…ˆå®šä¹‰ metaclassï¼Œç„¶ååˆ›å»ºç±»ã€‚<br>è¿æ¥èµ·æ¥å°±æ˜¯ï¼š<strong>å…ˆå®šä¹‰ metaclassï¼Œå°±å¯ä»¥åˆ›å»ºç±»ï¼Œæœ€ååˆ›å»ºå®ä¾‹ã€‚</strong><br>æ‰€ä»¥ï¼Œmetaclass å…è®¸ä½ åˆ›å»ºç±»æˆ–è€…ä¿®æ”¹ç±»ã€‚æ¢å¥è¯è¯´ï¼Œä½ å¯ä»¥æŠŠç±»çœ‹æˆæ˜¯ metaclass åˆ›å»ºå‡ºæ¥çš„ â€œå®ä¾‹â€ã€‚<br>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œè¿™ä¸ª metaclass å¯ä»¥ç»™æˆ‘ä»¬è‡ªå®šä¹‰çš„ MyList å¢åŠ ä¸€ä¸ª<code>add</code>æ–¹æ³•ï¼š<br>å®šä¹‰<code>ListMetaclass</code>ï¼ŒæŒ‰ç…§é»˜è®¤ä¹ æƒ¯ï¼Œmetaclass çš„ç±»åæ€»æ˜¯ä»¥ Metaclass ç»“å°¾ï¼Œä»¥ä¾¿æ¸…æ¥šåœ°è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª metaclassï¼š<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListMetaclass</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, name, bases, attrs)</span>:</span></span><br><span class="line">        attrs\[<span class="string">'add'</span>\] = <span class="keyword">lambda</span> self, value: self.append(value)</span><br><span class="line">        <span class="keyword">return</span> type.__new__(cls, name, bases, attrs)</span><br></pre></td></tr></table></figure></p>
<p>æœ‰äº† ListMetaclassï¼Œæˆ‘ä»¬åœ¨å®šä¹‰ç±»çš„æ—¶å€™è¿˜è¦æŒ‡ç¤ºä½¿ç”¨ ListMetaclass æ¥å®šåˆ¶ç±»ï¼Œä¼ å…¥å…³é”®å­—å‚æ•°<code>metaclass</code>ï¼š<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyList</span><span class="params">(list, metaclass=ListMetaclass)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></p>
<p>å½“æˆ‘ä»¬ä¼ å…¥å…³é”®å­—å‚æ•°<code>metaclass</code>æ—¶ï¼Œé­”æœ¯å°±ç”Ÿæ•ˆäº†ï¼Œå®ƒæŒ‡ç¤º Python è§£é‡Šå™¨åœ¨åˆ›å»º<code>MyList</code>æ—¶ï¼Œè¦é€šè¿‡<code>ListMetaclass.__new__()</code>æ¥åˆ›å»ºï¼Œåœ¨æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ç±»çš„å®šä¹‰ï¼Œæ¯”å¦‚ï¼ŒåŠ ä¸Šæ–°çš„æ–¹æ³•ï¼Œç„¶åï¼Œè¿”å›ä¿®æ”¹åçš„å®šä¹‰ã€‚</p>
<p><code>__new__()</code>æ–¹æ³•æ¥æ”¶åˆ°çš„å‚æ•°ä¾æ¬¡æ˜¯ï¼š</p>
<ol>
<li>å½“å‰å‡†å¤‡åˆ›å»ºçš„ç±»çš„å¯¹è±¡ï¼›</li>
<li>ç±»çš„åå­—ï¼›</li>
<li>ç±»ç»§æ‰¿çš„çˆ¶ç±»é›†åˆï¼›</li>
<li>ç±»çš„æ–¹æ³•é›†åˆã€‚</li>
</ol>
<p>æµ‹è¯•ä¸€ä¸‹<code>MyList</code>æ˜¯å¦å¯ä»¥è°ƒç”¨<code>add()</code>æ–¹æ³•ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\&gt;&gt;&gt; L = MyList()</span><br><span class="line">&gt;&gt;&gt; L.add(1)</span><br><span class="line">&gt;&gt; L</span><br><span class="line">\[1\]</span><br></pre></td></tr></table></figure></p>
<p>è€Œæ™®é€šçš„<code>list</code>æ²¡æœ‰<code>add()</code>æ–¹æ³•ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">\&gt;&gt;&gt; L2 = list()</span><br><span class="line">&gt;&gt;&gt; L2.add(1)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">AttributeError: &apos;list&apos; object has no attribute &apos;add&apos;</span><br></pre></td></tr></table></figure></p>
<h2 id="è£…é¥°å™¨"><a href="#è£…é¥°å™¨" class="headerlink" title="è£…é¥°å™¨"></a>è£…é¥°å™¨</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kw)</span>:</span></span><br><span class="line">        print(<span class="string">'call %s():'</span> % func.__name__)</span><br><span class="line">        <span class="keyword">return</span> func(*args, **kw)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure>
<p>è§‚å¯Ÿä¸Šé¢çš„logï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªdecoratorï¼Œæ‰€ä»¥æ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå‡½æ•°ã€‚æˆ‘ä»¬è¦å€ŸåŠ©Pythonçš„@è¯­æ³•ï¼ŒæŠŠdecoratorç½®äºå‡½æ•°çš„å®šä¹‰å¤„ï¼š<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@log</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">now</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'2015-3-25'</span>)</span><br></pre></td></tr></table></figure></p>
<p>è°ƒç”¨now()å‡½æ•°ï¼Œä¸ä»…ä¼šè¿è¡Œnow()å‡½æ•°æœ¬èº«ï¼Œè¿˜ä¼šåœ¨è¿è¡Œnow()å‡½æ•°å‰æ‰“å°ä¸€è¡Œæ—¥å¿—ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; now()</span><br><span class="line">call now():</span><br><span class="line">2015-3-25</span><br></pre></td></tr></table></figure>
<p>æŠŠ@logæ”¾åˆ°now()å‡½æ•°çš„å®šä¹‰å¤„ï¼Œç›¸å½“äºæ‰§è¡Œäº†è¯­å¥ï¼š<br><code>now = log(now)</code><br>ç”±äºlog()æ˜¯ä¸€ä¸ªdecoratorï¼Œè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥ï¼ŒåŸæ¥çš„now()å‡½æ•°ä»ç„¶å­˜åœ¨ï¼Œåªæ˜¯ç°åœ¨åŒåçš„nowå˜é‡æŒ‡å‘äº†æ–°çš„å‡½æ•°ï¼Œäºæ˜¯è°ƒç”¨now()å°†æ‰§è¡Œæ–°å‡½æ•°ï¼Œå³åœ¨log()å‡½æ•°ä¸­è¿”å›çš„wrapper()å‡½æ•°ã€‚</p>
<p>wrapper()å‡½æ•°çš„å‚æ•°å®šä¹‰æ˜¯(<em>args, *</em>kw)ï¼Œå› æ­¤ï¼Œwrapper()å‡½æ•°å¯ä»¥æ¥å—ä»»æ„å‚æ•°çš„è°ƒç”¨ã€‚åœ¨wrapper()å‡½æ•°å†…ï¼Œé¦–å…ˆæ‰“å°æ—¥å¿—ï¼Œå†ç´§æ¥ç€è°ƒç”¨åŸå§‹å‡½æ•°ã€‚</p>
<p>å¦‚æœdecoratoræœ¬èº«éœ€è¦ä¼ å…¥å‚æ•°ï¼Œé‚£å°±éœ€è¦ç¼–å†™ä¸€ä¸ªè¿”å›decoratorçš„é«˜é˜¶å‡½æ•°ï¼Œå†™å‡ºæ¥ä¼šæ›´å¤æ‚ã€‚æ¯”å¦‚ï¼Œè¦è‡ªå®šä¹‰logçš„æ–‡æœ¬ï¼š<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span><span class="params">(text)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(func)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kw)</span>:</span></span><br><span class="line">            print(<span class="string">'%s %s():'</span> % (text, func.__name__))</span><br><span class="line">            <span class="keyword">return</span> func(*args, **kw)</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> decorator</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ª3å±‚åµŒå¥—çš„decoratorç”¨æ³•å¦‚ä¸‹ï¼š<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@log('execute')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">now</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'2015-3-25'</span>)</span><br></pre></td></tr></table></figure></p>
<p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; now()</span><br><span class="line">execute now():</span><br><span class="line">2015-3-25</span><br></pre></td></tr></table></figure></p>
<p>å’Œä¸¤å±‚åµŒå¥—çš„decoratorç›¸æ¯”ï¼Œ3å±‚åµŒå¥—çš„æ•ˆæœæ˜¯è¿™æ ·çš„ï¼š<br><code>now = log(&#39;execute&#39;)(now)</code><br>æˆ‘ä»¬æ¥å‰–æä¸Šé¢çš„è¯­å¥ï¼Œé¦–å…ˆæ‰§è¡Œlog(â€˜executeâ€™)ï¼Œè¿”å›çš„æ˜¯decoratorå‡½æ•°ï¼Œå†è°ƒç”¨è¿”å›çš„å‡½æ•°ï¼Œå‚æ•°æ˜¯nowå‡½æ•°ï¼Œè¿”å›å€¼æœ€ç»ˆæ˜¯wrapperå‡½æ•°ã€‚</p>
<h2 id="pythonå‘½ä»¤è¡Œå‚æ•°"><a href="#pythonå‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="pythonå‘½ä»¤è¡Œå‚æ•°"></a>pythonå‘½ä»¤è¡Œå‚æ•°</h2><ul>
<li>-uå‚æ•°çš„ä½¿ç”¨ï¼špythonå‘½ä»¤åŠ ä¸Š-uï¼ˆunbufferedï¼‰å‚æ•°åä¼šå¼ºåˆ¶å…¶æ ‡å‡†è¾“å‡ºä¹ŸåŒæ ‡å‡†é”™è¯¯ä¸€æ ·ä¸é€šè¿‡ç¼“å­˜ç›´æ¥æ‰“å°åˆ°å±å¹•ã€‚</li>
<li>-cå‚æ•°ï¼Œæ”¯æŒæ‰§è¡Œå•è¡Œå‘½ä»¤/è„šæœ¬ã€‚å¦‚: <code>python -c &quot;import os;print(&#39;hello&#39;),print(&#39;world&#39;)&quot;</code></li>
</ul>
<h3 id="python-m-test-folder-test-pyä¸python-test-folder-testæœ‰ä»€ä¹ˆä¸åŒ"><a href="#python-m-test-folder-test-pyä¸python-test-folder-testæœ‰ä»€ä¹ˆä¸åŒ" class="headerlink" title="python -m test_folder/test.pyä¸python test_folder/testæœ‰ä»€ä¹ˆä¸åŒ"></a><code>python -m test_folder/test.py</code>ä¸<code>python test_folder/test</code>æœ‰ä»€ä¹ˆä¸åŒ</h3><p>æ¡Œé¢çš„test_folderæ–‡ä»¶å¤¹ä¸‹æœ‰ä¸ªtest.py<br><figure class="highlight python"><figcaption><span>test.py</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">print(sys.path)</span><br></pre></td></tr></table></figure></p>
<p>è¿è¡Œçœ‹çœ‹:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hulinhong@GIH-D-14531 MINGW64 ~/Desktop</span><br><span class="line">$ python test_folder/test.py</span><br><span class="line">[&apos;C:\\Users\\hulinhong\\Desktop\\test_folder&apos;, &apos;C:\\Program Files\\Python37\\python37.zip&apos;, &apos;C:\\Program Files\\Python37\\DLLs&apos;, &apos;C:\\Program Files\\Python37\\lib&apos;, &apos;C:\\Program Files\\Python37&apos;, &apos;C:\\Program Files\\Python37\\lib\\site-packages&apos;, &apos;C:\\Program Files\\Python37\\lib\\site-packages\\redis_py_cluster-2.1.0-py3.7.egg&apos;]</span><br><span class="line"></span><br><span class="line">hulinhong@GIH-D-14531 MINGW64 ~/Desktop</span><br><span class="line">$ python -m test_folder.test</span><br><span class="line">[&apos;C:\\Users\\hulinhong\\Desktop&apos;, &apos;C:\\Program Files\\Python37\\python37.zip&apos;, &apos;C:\\Program Files\\Python37\\DLLs&apos;, &apos;C:\\Program Files\\Python37\\lib&apos;, &apos;C:\\Program Files\\Python37&apos;, &apos;C:\\Program Files\\Python37\\lib\\site-packages&apos;, &apos;C:\\Program Files\\Python37\\lib\\site-packages\\redis_py_cluster-2.1.0-py3.7.egg&apos;]</span><br></pre></td></tr></table></figure></p>
<p>ç»†å¿ƒçš„åŒå­¦ä¼šå‘ç°ï¼Œ<strong>åŒºåˆ«</strong>å°±æ˜¯åœ¨ç¬¬ä¸€ä¸ªè·¯å¾„:  </p>
<ul>
<li>pythonç›´æ¥å¯åŠ¨æ˜¯æŠŠtest.pyæ–‡ä»¶æ‰€åœ¨çš„ç›®å½•æ”¾åˆ°äº†sys.pathå±æ€§ä¸­ã€‚</li>
<li>æ¨¡å—å¯åŠ¨æ˜¯æŠŠä½ è¾“å…¥å‘½ä»¤çš„ç›®å½•ï¼ˆä¹Ÿå°±æ˜¯å½“å‰è·¯å¾„ï¼‰ï¼Œæ”¾åˆ°äº†sys.pathå±æ€§ä¸­</li>
</ul>
<p>æ‰€ä»¥å°±ä¼šæœ‰ä¸‹é¢çš„æƒ…å†µ:</p>
<p>ç›®å½•ç»“æ„å¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">package/</span><br><span class="line">    __init__.py</span><br><span class="line">    mod1.py</span><br><span class="line">package2/</span><br><span class="line">    __init__.py</span><br><span class="line">    run.py</span><br></pre></td></tr></table></figure></p>
<p>run.py å†…å®¹å¦‚ä¸‹<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> package <span class="keyword">import</span> mod1</span><br><span class="line">print(sys.path)</span><br></pre></td></tr></table></figure></p>
<p>å¦‚ä½•æ‰èƒ½å¯åŠ¨run.pyæ–‡ä»¶ï¼Ÿ</p>
<ul>
<li><p>ç›´æ¥å¯åŠ¨ï¼ˆå¤±è´¥ï¼‰</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ  test_import_project git:(master) âœ— python package2/run.py</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;package2/run.py&quot;, line 2, in &lt;module&gt;</span><br><span class="line">    from package import mod1</span><br><span class="line">ImportError: No module named package</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä»¥æ¨¡å—æ–¹å¼å¯åŠ¨ï¼ˆæˆåŠŸï¼‰</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ  test_import_project git:(master) âœ— python -m package2.run</span><br><span class="line">[&apos;C:\\Users\\hulinhong\\Desktop&apos;,</span><br><span class="line">&apos;/usr/local/Cellar/python/2.7.11/Frameworks/Python.framework/Versions/2.7/lib/python27.zip&apos;,</span><br><span class="line">...]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å½“éœ€è¦å¯åŠ¨çš„pyæ–‡ä»¶å¼•ç”¨äº†ä¸€ä¸ªæ¨¡å—ã€‚ä½ éœ€è¦æ³¨æ„ï¼šåœ¨å¯åŠ¨çš„æ—¶å€™éœ€è¦è€ƒè™‘sys.pathä¸­æœ‰æ²¡æœ‰ä½ importçš„æ¨¡å—çš„è·¯å¾„ï¼<br>è¿™ä¸ªæ—¶å€™ï¼Œåˆ°åº•æ˜¯ä½¿ç”¨ç›´æ¥å¯åŠ¨ï¼Œè¿˜æ˜¯ä»¥æ¨¡å—çš„å¯åŠ¨ï¼Ÿç›®çš„å°±æ˜¯æŠŠimportçš„é‚£ä¸ªæ¨¡å—çš„è·¯å¾„æ”¾åˆ°sys.pathä¸­ã€‚ä½ æ˜¯ä¸æ˜¯æ˜ç™½äº†å‘¢ï¼Ÿ</p>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£å‚è€ƒï¼š <a href="http://www.pythondoc.com/pythontutorial3/modules.html" target="_blank" rel="noopener">http://www.pythondoc.com/pythontutorial3/modules.html</a></p>
</blockquote>
<p>å¯¼å…¥ä¸€ä¸ªå« mod1 çš„æ¨¡å—æ—¶ï¼Œè§£é‡Šå™¨å…ˆåœ¨å½“å‰ç›®å½•ä¸­æœç´¢åä¸º mod1.py çš„æ–‡ä»¶ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°çš„è¯ï¼Œæ¥ç€ä¼šåˆ° sys.path å˜é‡ä¸­ç»™å‡ºçš„ç›®å½•åˆ—è¡¨ä¸­æŸ¥æ‰¾ã€‚ sys.path å˜é‡çš„åˆå§‹å€¼æ¥è‡ªå¦‚ä¸‹ï¼š</p>
<p>è¾“å…¥è„šæœ¬çš„ç›®å½•ï¼ˆå½“å‰ç›®å½•ï¼‰ã€‚</p>
<ul>
<li>ç¯å¢ƒå˜é‡ PYTHONPATH è¡¨ç¤ºçš„ç›®å½•åˆ—è¡¨ä¸­æœç´¢(è¿™å’Œ shell å˜é‡ PATH å…·æœ‰ä¸€æ ·çš„è¯­æ³•ï¼Œå³ä¸€ç³»åˆ—ç›®å½•åçš„åˆ—è¡¨)ã€‚</li>
<li>Python é»˜è®¤å®‰è£…è·¯å¾„ä¸­æœç´¢ã€‚</li>
<li>å®é™…ä¸Šï¼Œè§£é‡Šå™¨ç”± sys.path å˜é‡æŒ‡å®šçš„è·¯å¾„ç›®å½•æœç´¢æ¨¡å—ï¼Œè¯¥å˜é‡åˆå§‹åŒ–æ—¶é»˜è®¤åŒ…å«äº†è¾“å…¥è„šæœ¬ï¼ˆæˆ–è€…å½“å‰ç›®å½•ï¼‰ï¼Œ PYTHONPATH å’Œå®‰è£…ç›®å½•ã€‚è¿™æ ·å°±å…è®¸ Pythonç¨‹åºäº†è§£å¦‚ä½•ä¿®æ”¹æˆ–æ›¿æ¢æ¨¡å—æœç´¢ç›®å½•ã€‚</li>
</ul>
<h2 id="åœ¨pythonç¨‹åºä¸­è°ƒç”¨cppçš„åº“åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦å—åˆ¶äºGIL"><a href="#åœ¨pythonç¨‹åºä¸­è°ƒç”¨cppçš„åº“åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦å—åˆ¶äºGIL" class="headerlink" title="åœ¨pythonç¨‹åºä¸­è°ƒç”¨cppçš„åº“åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦å—åˆ¶äºGIL?"></a>åœ¨pythonç¨‹åºä¸­è°ƒç”¨cppçš„åº“åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦å—åˆ¶äºGIL?</h2><p>é¦–å…ˆè¦ç†è§£ä»€ä¹ˆæ˜¯GIL.<br>Python çš„å¤šçº¿ç¨‹æ˜¯çœŸçš„å¤šçº¿ç¨‹ï¼Œåªä¸è¿‡åœ¨ä»»æ„æ—¶åˆ»ï¼Œå®ƒä»¬ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿå–å¾— GIL ä»è€Œè¢«å…è®¸æ‰§è¡Œ Python ä»£ç ã€‚å…¶å®ƒçº¿ç¨‹è¦ä¹ˆç­‰ç€ï¼Œè¦ä¹ˆå¹²åˆ«çš„å’Œ Python æ— å…³çš„äº‹æƒ…ï¼ˆæ¯”å¦‚ç­‰å¾…ç³»ç»Ÿ I/Oï¼Œæˆ–è€…ç®—ç‚¹ä»€ä¹ˆä¸œè¥¿ï¼‰ã€‚</p>
<p>é‚£å¦‚æœæ˜¯é€šè¿‡CPPæ‰©å±•åˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹ï¼Œå¯ä»¥æ‘†è„±è¿™ä¸ªé™åˆ¶ä¹ˆï¼Ÿ<br>å¾ˆç®€å•ï¼Œä¸è®¿é—® Python çš„æ•°æ®å’Œæ–¹æ³•ï¼Œå°±å’Œ GIL æ²¡ä»»ä½•å…³ç³»ã€‚å¦‚æœéœ€è¦è®¿é—® Pythonï¼Œè¿˜æ˜¯éœ€è¦å…ˆå–å¾— GIL.</p>
<p>GIL æ˜¯ä¸ºäº†ä¿æŠ¤ Python æ•°æ®ä¸è¢«å¹¶å‘è®¿é—®ç ´åï¼Œæ‰€ä»¥å½“ä½ ä¸è®¿é—® Python çš„æ•°æ®çš„æ—¶å€™è‡ªç„¶å°±å¯ä»¥é‡Šæ”¾ï¼ˆæˆ–è€…ä¸å–å¾—ï¼‰GILã€‚åè¿‡æ¥ï¼Œå¦‚æœéœ€è¦è®¿é—® Python çš„æ•°æ®ï¼Œå°±ä¸€å®šè¦å–å¾— GIL å†è®¿é—®ã€‚PyObject ç­‰ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¤šçº¿ç¨‹è®¿é—®ä»»ä½•éçº¿ç¨‹å®‰å…¨çš„æ•°æ®éƒ½éœ€è¦å…ˆå–å¾—å¯¹åº”çš„é”ã€‚Python æ‰€æœ‰çš„ PyObject ä»€ä¹ˆçš„éƒ½å…±äº«ä¸€ä¸ªé”ï¼Œå®ƒå°±å« GILã€‚</p>
<h2 id="new-ä¸-del-ä¸-init"><a href="#new-ä¸-del-ä¸-init" class="headerlink" title="__new__ ä¸ __del__ ä¸ __init__"></a><code>__new__</code> ä¸ <code>__del__</code> ä¸ <code>__init__</code></h2><p>å…ˆæ¥çœ‹ä¸€ä¸ªå•ä¾‹æ¨¡å¼çš„å®ç°<br><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span>:</span></span><br><span class="line">    __isinstance = <span class="keyword">False</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cls.__isinstance:  <span class="comment"># å¦‚æœè¢«å®ä¾‹åŒ–äº†</span></span><br><span class="line">            cls.__isinstance = object.__new__(cls)  <span class="comment"># å¦åˆ™å®ä¾‹åŒ–</span></span><br><span class="line">        <span class="keyword">return</span> cls.__isinstance  <span class="comment"># è¿”å›å®ä¾‹åŒ–çš„å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        print(<span class="string">'my name is %s'</span>%(name))</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'886, %s'</span>%(self.name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">d1 = Demo(<span class="string">'Alice'</span>)</span><br><span class="line">d2 = Demo(<span class="string">'Anew'</span>)</span><br><span class="line">print(d1)</span><br><span class="line">print(d2)</span><br></pre></td></tr></table></figure></p>
<p>æ‰“å°:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">my name is Alice</span><br><span class="line">my name is Anew</span><br><span class="line">&lt;__main__.Demo object at 0x000001446604D3C8&gt;</span><br><span class="line">&lt;__main__.Demo object at 0x000001446604D3C8&gt;</span><br><span class="line">886, Anew</span><br></pre></td></tr></table></figure></p>
<p><code>__new__</code> æ˜¯è´Ÿè´£å¯¹å½“å‰ç±»è¿›è¡Œå®ä¾‹åŒ–ï¼Œå¹¶å°†å®ä¾‹è¿”å›ï¼Œå¹¶ä¼ ç»™<code>__init__</code>æ–¹æ³•ï¼Œ<code>__init__</code>æ–¹æ³•ä¸­çš„selfå°±æ˜¯æŒ‡ä»£<code>__new__</code>ä¼ è¿‡æ¥çš„å¯¹è±¡ï¼Œæ‰€ä»¥å†æ¬¡å¼ºè°ƒï¼Œ<code>__init__</code>æ˜¯å®ä¾‹åŒ–åè°ƒç”¨çš„ç¬¬ä¸€ä¸ªæ–¹æ³•ã€‚</p>
<p><code>__del__</code>åœ¨å¯¹è±¡é”€æ¯æ—¶è¢«è°ƒç”¨ï¼Œå¾€å¾€ç”¨äºæ¸…é™¤æ•°æ®æˆ–è¿˜åŸç¯å¢ƒç­‰æ“ä½œï¼Œæ¯”å¦‚åœ¨ç±»ä¸­çš„å…¶ä»–æ™®é€šæ–¹æ³•ä¸­å®ç°äº†æ’å…¥æ•°æ®åº“çš„è¯­å¥ï¼Œå½“å¯¹è±¡è¢«é”€æ¯æ—¶æˆ‘ä»¬éœ€è¦å°†æ•°æ®è¿˜åŸï¼Œé‚£ä¹ˆè¿™æ—¶å¯ä»¥åœ¨<code>__del__</code>æ–¹æ³•ä¸­å®ç°è¿˜åŸæ•°æ®åº“æ•°æ®çš„åŠŸèƒ½ã€‚<code>__del__</code>è¢«æˆä¸ºææ„æ–¹æ³•ï¼ŒåŒæ ·å’ŒC++ä¸­çš„ææ„æ–¹æ³•ç±»ä¼¼ã€‚</p>
<h2 id="pythonåƒåœ¾å›æ”¶"><a href="#pythonåƒåœ¾å›æ”¶" class="headerlink" title="pythonåƒåœ¾å›æ”¶"></a>pythonåƒåœ¾å›æ”¶</h2><p>æ€»ä½“æ¥è¯´ï¼Œåœ¨Pythonä¸­ï¼Œä¸»è¦é€šè¿‡å¼•ç”¨è®¡æ•°è¿›è¡Œåƒåœ¾å›æ”¶ï¼›é€šè¿‡ â€œæ ‡è®°-æ¸…é™¤â€ è§£å†³å®¹å™¨å¯¹è±¡å¯èƒ½äº§ç”Ÿçš„å¾ªç¯å¼•ç”¨é—®é¢˜ï¼›é€šè¿‡ â€œåˆ†ä»£å›æ”¶â€ ä»¥ç©ºé—´æ¢æ—¶é—´çš„æ–¹æ³•æé«˜åƒåœ¾å›æ”¶æ•ˆç‡ã€‚</p>
<ul>
<li>å¼•ç”¨è®¡æ•°</li>
<li>æ ‡è®°æ¸…é™¤(Mark and Sweep)</li>
<li>åˆ†ä»£å›æ”¶</li>
</ul>
<h3 id="æ ‡è®°æ¸…é™¤å’‹å¼„çš„"><a href="#æ ‡è®°æ¸…é™¤å’‹å¼„çš„" class="headerlink" title="æ ‡è®°æ¸…é™¤å’‹å¼„çš„"></a>æ ‡è®°æ¸…é™¤å’‹å¼„çš„</h3><p>å‚è€ƒ: <a href="https://zhuanlan.zhihu.com/p/83251959" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/83251959</a></p>
<p>Python é‡‡ç”¨äº† <strong>â€œæ ‡è®°-æ¸…é™¤â€(Mark and Sweep)</strong> ç®—æ³•ï¼Œè§£å†³å®¹å™¨å¯¹è±¡å¯èƒ½äº§ç”Ÿçš„å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚(æ³¨æ„ï¼Œåªæœ‰å®¹å™¨å¯¹è±¡æ‰ä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨çš„æƒ…å†µï¼Œæ¯”å¦‚åˆ—è¡¨ã€å­—å…¸ã€ç”¨æˆ·è‡ªå®šä¹‰ç±»çš„å¯¹è±¡ã€å…ƒç»„ç­‰ã€‚è€Œåƒæ•°å­—ï¼Œå­—ç¬¦ä¸²è¿™ç±»ç®€å•ç±»å‹ä¸ä¼šå‡ºç°å¾ªç¯å¼•ç”¨ã€‚ä½œä¸ºä¸€ç§ä¼˜åŒ–ç­–ç•¥ï¼Œå¯¹äºåªåŒ…å«ç®€å•ç±»å‹çš„å…ƒç»„ä¹Ÿä¸åœ¨æ ‡è®°æ¸…é™¤ç®—æ³•çš„è€ƒè™‘ä¹‹åˆ—)</p>
<p>è·Ÿå…¶åç§°ä¸€æ ·ï¼Œè¯¥ç®—æ³•åœ¨è¿›è¡Œåƒåœ¾å›æ”¶æ—¶åˆ†æˆäº†ä¸¤æ­¥ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>Aï¼‰æ ‡è®°é˜¶æ®µï¼Œéå†æ‰€æœ‰çš„å¯¹è±¡ï¼Œå¦‚æœæ˜¯å¯è¾¾çš„ï¼ˆreachableï¼‰ï¼Œä¹Ÿå°±æ˜¯è¿˜æœ‰å¯¹è±¡å¼•ç”¨å®ƒï¼Œé‚£ä¹ˆå°±æ ‡è®°è¯¥å¯¹è±¡ä¸ºå¯è¾¾ï¼›</li>
<li>Bï¼‰æ¸…é™¤é˜¶æ®µï¼Œå†æ¬¡éå†å¯¹è±¡ï¼Œå¦‚æœå‘ç°æŸä¸ªå¯¹è±¡æ²¡æœ‰æ ‡è®°ä¸ºå¯è¾¾ï¼Œåˆ™å°±å°†å…¶å›æ”¶ã€‚</li>
</ul>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨æ ‡è®°æ¸…é™¤ç®—æ³•ä¸­ï¼Œä¸ºäº†è¿½è¸ªå®¹å™¨å¯¹è±¡ï¼Œéœ€è¦æ¯ä¸ªå®¹å™¨å¯¹è±¡ç»´æŠ¤ä¸¤ä¸ªé¢å¤–çš„æŒ‡é’ˆï¼Œç”¨æ¥å°†å®¹å™¨å¯¹è±¡ç»„æˆä¸€ä¸ªåŒç«¯é“¾è¡¨ï¼ŒæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘å‰åä¸¤ä¸ªå®¹å™¨å¯¹è±¡ï¼Œæ–¹ä¾¿æ’å…¥å’Œåˆ é™¤æ“ä½œã€‚python è§£é‡Šå™¨ (Cpython) ç»´æŠ¤äº†ä¸¤ä¸ªè¿™æ ·çš„åŒç«¯é“¾è¡¨ï¼Œä¸€ä¸ªé“¾è¡¨å­˜æ”¾ç€éœ€è¦è¢«æ‰«æçš„å®¹å™¨å¯¹è±¡ï¼Œå¦ä¸€ä¸ªé“¾è¡¨å­˜æ”¾ç€ä¸´æ—¶ä¸å¯è¾¾å¯¹è±¡ã€‚åœ¨å›¾ä¸­ï¼Œè¿™ä¸¤ä¸ªé“¾è¡¨åˆ†åˆ«è¢«å‘½åä¸ºâ€Object to Scanâ€å’Œâ€Unreachableâ€ã€‚å›¾ä¸­ä¾‹å­æ˜¯è¿™ä¹ˆä¸€ä¸ªæƒ…å†µï¼šlink1,link2,link3 ç»„æˆäº†ä¸€ä¸ªå¼•ç”¨ç¯ï¼ŒåŒæ—¶ link1 è¿˜è¢«ä¸€ä¸ªå˜é‡ A(å…¶å®è¿™é‡Œç§°ä¸ºåç§° A æ›´å¥½)å¼•ç”¨ã€‚link4 è‡ªå¼•ç”¨ï¼Œä¹Ÿæ„æˆäº†ä¸€ä¸ªå¼•ç”¨ç¯ã€‚ä»å›¾ä¸­æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹é™¤äº†æœ‰ä¸€ä¸ªè®°å½•å½“å‰å¼•ç”¨è®¡æ•°çš„å˜é‡ ref_count è¿˜æœ‰ä¸€ä¸ª gc_ref å˜é‡ï¼Œè¿™ä¸ª gc_ref æ˜¯ ref_count çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œæ‰€ä»¥åˆå§‹å€¼ä¸º ref_count çš„å¤§å°ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/python/v2-0d5071093adaa02bc03fa3dfd91aa5bc_720w.jpg" alt></p>
<p>gc å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šé€ä¸ªéå†â€Object to Scanâ€ é“¾è¡¨ä¸­çš„å®¹å™¨å¯¹è±¡ï¼Œå¹¶ä¸”å°†å½“å‰å¯¹è±¡æ‰€å¼•ç”¨çš„æ‰€æœ‰å¯¹è±¡çš„ gc_ref å‡ä¸€ã€‚(æ‰«æåˆ° link1 çš„æ—¶å€™ï¼Œç”±äº link1 å¼•ç”¨äº† link2, æ‰€ä»¥ä¼šå°† link2 çš„ gc_ref å‡ä¸€ï¼Œæ¥ç€æ‰«æ link2, ç”±äº link2 å¼•ç”¨äº† link3, æ‰€ä»¥ä¼šå°† link3 çš„ gc_ref å‡ä¸€â€¦..) åƒè¿™æ ·å°†â€Objects to Scanâ€ é“¾è¡¨ä¸­çš„æ‰€æœ‰å¯¹è±¡è€ƒå¯Ÿä¸€éä¹‹åï¼Œä¸¤ä¸ªé“¾è¡¨ä¸­çš„å¯¹è±¡çš„ ref_count å’Œ gc_ref çš„æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚è¿™ä¸€æ­¥æ“ä½œå°±ç›¸å½“äºè§£é™¤äº†å¾ªç¯å¼•ç”¨å¯¹å¼•ç”¨è®¡æ•°çš„å½±å“ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="https://pic3.zhimg.com/v2-d7314ead6b303f08a91687577c045585_b.jpg" alt></p>
<p>æ¥ç€ï¼Œgc ä¼šå†æ¬¡æ‰«ææ‰€æœ‰çš„å®¹å™¨å¯¹è±¡ï¼Œå¦‚æœå¯¹è±¡çš„ gc_ref å€¼ä¸º 0ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±è¢«æ ‡è®°ä¸º GC_TENTATIVELY_UNREACHABLEï¼Œå¹¶ä¸”è¢«ç§»è‡³â€Unreachableâ€ é“¾è¡¨ä¸­ã€‚ä¸‹å›¾ä¸­çš„ link3 å’Œ link4 å°±æ˜¯è¿™æ ·ä¸€ç§æƒ…å†µã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="https://pic1.zhimg.com/v2-d3c3f52615fb704c26bd53dbb178767c_b.jpg" alt></p>
<p>å¦‚æœå¯¹è±¡çš„ gc_ref ä¸ä¸º 0ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±ä¼šè¢«æ ‡è®°ä¸º GC_REACHABLEã€‚åŒæ—¶å½“ gc å‘ç°æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¯è¾¾çš„ï¼Œé‚£ä¹ˆä»–ä¼šé€’å½’å¼çš„å°†ä»è¯¥èŠ‚ç‚¹å‡ºå‘å¯ä»¥åˆ°è¾¾çš„æ‰€æœ‰èŠ‚ç‚¹æ ‡è®°ä¸º GC_REACHABLE, è¿™å°±æ˜¯ä¸‹å›¾ä¸­ link2 å’Œ link3 æ‰€ç¢°åˆ°çš„æƒ…å½¢ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="https://pic1.zhimg.com/v2-510f4d2d37aabdbc8978d9e47630237d_b.jpg" alt></p>
<p>é™¤äº†å°†æ‰€æœ‰å¯è¾¾èŠ‚ç‚¹æ ‡è®°ä¸º GC_REACHABLE ä¹‹å¤–ï¼Œå¦‚æœè¯¥èŠ‚ç‚¹å½“å‰åœ¨â€Unreachableâ€ é“¾è¡¨ä¸­çš„è¯ï¼Œè¿˜éœ€è¦å°†å…¶ç§»å›åˆ°â€Object to Scanâ€ é“¾è¡¨ä¸­ï¼Œä¸‹å›¾å°±æ˜¯ link3 ç§»å›ä¹‹åçš„æƒ…å½¢ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/python/v2-6fd40c055a6633c654acaf05f472c1b2_720w.jpg" alt></p>
<p>ç¬¬äºŒæ¬¡éå†çš„æ‰€æœ‰å¯¹è±¡éƒ½éå†å®Œæˆä¹‹åï¼Œå­˜åœ¨äºâ€Unreachableâ€ é“¾è¡¨ä¸­çš„å¯¹è±¡å°±æ˜¯çœŸæ­£éœ€è¦è¢«é‡Šæ”¾çš„å¯¹è±¡ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ­¤æ—¶ link4 å­˜åœ¨äº Unreachable é“¾è¡¨ä¸­ï¼Œgc éšå³é‡Šæ”¾ä¹‹ã€‚</p>
<p><strong>ä¸Šé¢æè¿°çš„åƒåœ¾å›æ”¶çš„é˜¶æ®µï¼Œä¼šæš‚åœæ•´ä¸ªåº”ç”¨ç¨‹åºï¼Œç­‰å¾…æ ‡è®°æ¸…é™¤ç»“æŸåæ‰ä¼šæ¢å¤åº”ç”¨ç¨‹åºçš„è¿è¡Œã€‚</strong></p>
<h4 id="ä¸ºå•¥æ ‡è®°æ¸…é™¤å›æ”¶æ— æ³•å›æ”¶é‡å†™äº†-del-æ–¹æ³•çš„ç±»å¯¹è±¡"><a href="#ä¸ºå•¥æ ‡è®°æ¸…é™¤å›æ”¶æ— æ³•å›æ”¶é‡å†™äº†-del-æ–¹æ³•çš„ç±»å¯¹è±¡" class="headerlink" title="ä¸ºå•¥æ ‡è®°æ¸…é™¤å›æ”¶æ— æ³•å›æ”¶é‡å†™äº†__del__æ–¹æ³•çš„ç±»å¯¹è±¡"></a>ä¸ºå•¥æ ‡è®°æ¸…é™¤å›æ”¶æ— æ³•å›æ”¶é‡å†™äº†<code>__del__</code>æ–¹æ³•çš„ç±»å¯¹è±¡</h4><blockquote>
<p>Circular references which are garbage are detected when the option cycle detector is enabled (itâ€™s on by default), but can only be cleaned up if there are no Python-level <code>__del__</code>() methods involved.</p>
</blockquote>
<p>å®˜æ–¹æ–‡æ¡£ä¸­è¡¨æ˜å¯ç”¨å‘¨æœŸæ£€æµ‹å™¨æ—¶ä¼šæ£€æµ‹åˆ°åƒåœ¾çš„å¾ªç¯å¼•ç”¨ï¼ˆé»˜è®¤æƒ…å†µä¸‹å®ƒæ˜¯æ‰“å¼€çš„)ï¼Œä½†åªæœ‰åœ¨æ²¡æœ‰æ¶‰åŠ Python <code>__del__()</code> æ–¹æ³•çš„æƒ…å†µä¸‹æ‰èƒ½æ¸…é™¤ã€‚Python ä¸çŸ¥é“ç ´åå½¼æ­¤ä¿æŒå¾ªç¯å¼•ç”¨çš„å¯¹è±¡çš„å®‰å…¨é¡ºåºï¼Œå› æ­¤å®ƒåˆ™ä¸ä¼šä¸ºè¿™äº›æ–¹æ³•è°ƒç”¨ææ„å‡½æ•°ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå¦‚æœå®šä¹‰äº† <code>__del__</code> å‡½æ•°ï¼Œé‚£ä¹ˆåœ¨å¾ªç¯å¼•ç”¨ä¸­Pythonè§£é‡Šå™¨æ— æ³•åˆ¤æ–­ææ„å¯¹è±¡çš„é¡ºåºï¼Œå› æ­¤å°±ä¸åšå¤„ç†ã€‚</p>
<h3 id="åˆ†ä»£å›æ”¶"><a href="#åˆ†ä»£å›æ”¶" class="headerlink" title="åˆ†ä»£å›æ”¶"></a>åˆ†ä»£å›æ”¶</h3><p>åœ¨å¾ªç¯å¼•ç”¨å¯¹è±¡çš„å›æ”¶ä¸­ï¼Œæ•´ä¸ªåº”ç”¨ç¨‹åºä¼šè¢«æš‚åœï¼Œä¸ºäº†å‡å°‘åº”ç”¨ç¨‹åºæš‚åœçš„æ—¶é—´ï¼ŒPython é€šè¿‡â€œåˆ†ä»£å›æ”¶â€(Generational Collection)ä»¥ç©ºé—´æ¢æ—¶é—´çš„æ–¹æ³•æé«˜åƒåœ¾å›æ”¶æ•ˆç‡ã€‚</p>
<p>åˆ†ä»£å›æ”¶æ˜¯åŸºäºè¿™æ ·çš„ä¸€ä¸ªç»Ÿè®¡äº‹å®ï¼Œå¯¹äºç¨‹åºï¼Œå­˜åœ¨ä¸€å®šæ¯”ä¾‹çš„å†…å­˜å—çš„ç”Ÿå­˜å‘¨æœŸæ¯”è¾ƒçŸ­ï¼›è€Œå‰©ä¸‹çš„å†…å­˜å—ï¼Œç”Ÿå­˜å‘¨æœŸä¼šæ¯”è¾ƒé•¿ï¼Œç”šè‡³ä¼šä»ç¨‹åºå¼€å§‹ä¸€ç›´æŒç»­åˆ°ç¨‹åºç»“æŸã€‚ç”Ÿå­˜æœŸè¾ƒçŸ­å¯¹è±¡çš„æ¯”ä¾‹é€šå¸¸åœ¨ 80%ï½90% ä¹‹é—´ï¼Œè¿™ç§æ€æƒ³ç®€å•ç‚¹è¯´å°±æ˜¯ï¼šå¯¹è±¡å­˜åœ¨æ—¶é—´è¶Šé•¿ï¼Œè¶Šå¯èƒ½ä¸æ˜¯åƒåœ¾ï¼Œåº”è¯¥è¶Šå°‘å»æ”¶é›†ã€‚è¿™æ ·åœ¨æ‰§è¡Œæ ‡è®°-æ¸…é™¤ç®—æ³•æ—¶å¯ä»¥æœ‰æ•ˆå‡å°éå†çš„å¯¹è±¡æ•°ï¼Œä»è€Œæé«˜åƒåœ¾å›æ”¶çš„é€Ÿåº¦ã€‚</p>
<p>python gcç»™å¯¹è±¡å®šä¹‰äº†ä¸‰ç§ä¸–ä»£(0,1,2),æ¯ä¸€ä¸ªæ–°ç”Ÿå¯¹è±¡åœ¨generation zeroä¸­ï¼Œå¦‚æœå®ƒåœ¨ä¸€è½®gcæ‰«æä¸­æ´»äº†ä¸‹æ¥ï¼Œé‚£ä¹ˆå®ƒå°†è¢«ç§»è‡³generation one,åœ¨é‚£é‡Œä»–å°†è¾ƒå°‘çš„è¢«æ‰«æï¼Œå¦‚æœå®ƒåˆæ´»è¿‡äº†ä¸€è½®gc,å®ƒåˆå°†è¢«ç§»è‡³generation twoï¼Œåœ¨é‚£é‡Œå®ƒè¢«æ‰«æçš„æ¬¡æ•°å°†ä¼šæ›´å°‘ã€‚</p>
<p>gcçš„æ‰«æåœ¨ä»€ä¹ˆæ—¶å€™ä¼šè¢«è§¦å‘å‘¢?ç­”æ¡ˆæ˜¯å½“æŸä¸€ä¸–ä»£ä¸­è¢«åˆ†é…çš„å¯¹è±¡ä¸è¢«é‡Šæ”¾çš„å¯¹è±¡ä¹‹å·®è¾¾åˆ°æŸä¸€é˜ˆå€¼çš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘gcå¯¹æŸä¸€ä¸–ä»£çš„æ‰«æã€‚å€¼å¾—æ³¨æ„çš„æ˜¯å½“æŸä¸€ä¸–ä»£çš„æ‰«æè¢«è§¦å‘çš„æ—¶å€™ï¼Œæ¯”è¯¥ä¸–ä»£å¹´è½»çš„ä¸–ä»£ä¹Ÿä¼šè¢«æ‰«æã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸–ä»£2çš„gcæ‰«æè¢«è§¦å‘äº†ï¼Œé‚£ä¹ˆä¸–ä»£0,ä¸–ä»£1ä¹Ÿå°†è¢«æ‰«æï¼Œå¦‚æœä¸–ä»£1çš„gcæ‰«æè¢«è§¦å‘ï¼Œä¸–ä»£0ä¹Ÿä¼šè¢«æ‰«æã€‚</p>
<p>è¯¥é˜ˆå€¼å¯ä»¥é€šè¿‡ä¸‹é¢ä¸¤ä¸ªå‡½æ•°æŸ¥çœ‹å’Œè°ƒæ•´:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">gc.get_threshold() <span class="comment"># (threshold0, threshold1, threshold2).</span></span><br><span class="line">gc.set_threshold(threshold0[, threshold1[, threshold2]])</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢å¯¹set_threshold()ä¸­çš„ä¸‰ä¸ªå‚æ•°threshold0, threshold1, threshold2è¿›è¡Œä»‹ç»ã€‚gcä¼šè®°å½•è‡ªä»ä¸Šæ¬¡æ”¶é›†ä»¥æ¥æ–°åˆ†é…çš„å¯¹è±¡æ•°é‡ä¸é‡Šæ”¾çš„å¯¹è±¡æ•°é‡ï¼Œå½“ä¸¤è€…ä¹‹å·®è¶…è¿‡threshold0çš„å€¼æ—¶ï¼Œgcçš„æ‰«æå°±ä¼šå¯åŠ¨ï¼Œåˆå§‹çš„æ—¶å€™åªæœ‰ä¸–ä»£0è¢«æ£€æŸ¥ã€‚å¦‚æœè‡ªä»ä¸–ä»£1æœ€è¿‘ä¸€æ¬¡è¢«æ£€æŸ¥ä»¥æ¥ï¼Œä¸–ä»£0è¢«æ£€æŸ¥è¶…è¿‡threshold1æ¬¡ï¼Œé‚£ä¹ˆå¯¹ä¸–ä»£1çš„æ£€æŸ¥å°†è¢«è§¦å‘ã€‚ç›¸åŒçš„ï¼Œå¦‚æœè‡ªä»ä¸–ä»£2æœ€è¿‘ä¸€æ¬¡è¢«æ£€æŸ¥ä»¥æ¥ï¼Œä¸–ä»£1è¢«æ£€æŸ¥è¶…è¿‡threshold2æ¬¡ï¼Œé‚£ä¹ˆå¯¹ä¸–ä»£2çš„æ£€æŸ¥å°†è¢«è§¦å‘ã€‚get_threshold()æ˜¯è·å–ä¸‰è€…çš„å€¼ï¼Œé»˜è®¤å€¼ä¸º(700,10,10).</p>

          
        
      


      

    
      <footer class="post-footer">
        

        

        

        
        
          <div class="post-eof"></div>
        
      </footer>
      
    </div>
    
    
    

    

    

    

  </div>
  
  
  
  </article>


      
    
      
        

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hulinhong.com/coroutine_illustrated/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mike">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ğŸš™">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/coroutine_illustrated/" itemprop="url">åŸºäºucontextå®ç°åç¨‹</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-17T02:47:54+00:00">
                03-17-2021
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Misc/" itemprop="url" rel="index">
                    <span itemprop="name">Misc</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    




    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      

      
      
        <div class="post-eof"></div>
      

      
      

      
        
          <h1 id="å¹²è´§å†™åœ¨å‰é¢"><a href="#å¹²è´§å†™åœ¨å‰é¢" class="headerlink" title="å¹²è´§å†™åœ¨å‰é¢"></a>å¹²è´§å†™åœ¨å‰é¢</h1><hr>
<p>åç¨‹çš„æ¦‚å¿µå°±ä¸è¯¦ç»†ä»‹ç»äº†,ä¸æ¸…æ¥šçš„åŒå­¦å¯ä»¥è‡ªå·±google,windowså’Œunix likeç³»ç»Ÿ<br>æœ¬èº«å°±æä¾›äº†åç¨‹çš„æ”¯æŒ,windowsä¸‹å«fiber,unix likeç³»ç»Ÿä¸‹å«ucontext.</p>
<p>åç¨‹æ˜¯ä¸€ç§ç”¨æˆ·æ€çš„è½»é‡çº§çº¿ç¨‹ã€‚æœ¬ç¯‡ä¸»è¦ç ”ç©¶åç¨‹çš„ C/C++ çš„å®ç°ã€‚<br>é¦–å…ˆæˆ‘ä»¬å¯ä»¥çœ‹çœ‹æœ‰å“ªäº›è¯­è¨€å·²ç»å…·å¤‡åç¨‹è¯­ä¹‰ï¼š</p>
<ul>
<li>æ¯”è¾ƒé‡é‡çº§çš„æœ‰ C#ã€erlangã€golang*</li>
<li>è½»é‡çº§æœ‰ pythonã€luaã€javascriptã€ruby</li>
<li>è¿˜æœ‰å‡½æ•°å¼çš„ scalaã€scheme ç­‰ã€‚</li>
</ul>
<p>c/c++ ä¸ç›´æ¥æ”¯æŒåç¨‹è¯­ä¹‰ï¼Œä½†æœ‰ä¸å°‘å¼€æºçš„åç¨‹åº“ï¼Œå¦‚ï¼š<br>Protothreadsï¼š<a href="http://coolshell.cn/articles/10975.html" target="_blank" rel="noopener">ä¸€ä¸ª â€œè‡é‡çº§â€ C è¯­è¨€åç¨‹åº“</a><br>libco: <a href="http://www.cnblogs.com/bangerlee/p/4003160.html" target="_blank" rel="noopener">æ¥è‡ªè…¾è®¯çš„å¼€æºåç¨‹åº“ libco ä»‹ç»</a>ï¼Œ<a href="http://code.tencent.com/libco.html" target="_blank" rel="noopener">å®˜ç½‘</a><br>coroutine: <a href="https://github.com/cloudwu/coroutine/" target="_blank" rel="noopener">äº‘é£çš„ä¸€ä¸ª C è¯­è¨€åŒæ­¥åç¨‹åº“</a>, <a href="http://blog.codingnow.com/2012/07/c_coroutine.html" target="_blank" rel="noopener">è¯¦ç»†ä¿¡æ¯</a></p>
<p>ç›®å‰çœ‹åˆ°å¤§æ¦‚æœ‰å››ç§å®ç°åç¨‹çš„æ–¹å¼ï¼š</p>
<ul>
<li>ç¬¬ä¸€ç§ï¼šåˆ©ç”¨ glibc çš„ ucontext ç»„ä»¶ (äº‘é£çš„åº“)</li>
<li>ç¬¬äºŒç§ï¼šä½¿ç”¨æ±‡ç¼–ä»£ç æ¥åˆ‡æ¢ä¸Šä¸‹æ–‡ (<a href="http://www.cnblogs.com/sniperHW/archive/2012/06/19/2554574.html" target="_blank" rel="noopener">å®ç° c åç¨‹</a>)</li>
<li>ç¬¬ä¸‰ç§ï¼šåˆ©ç”¨ C è¯­è¨€è¯­æ³• switch-case çš„å¥‡æ·«æŠ€å·§æ¥å®ç°ï¼ˆProtothreads)</li>
<li>ç¬¬å››ç§ï¼šåˆ©ç”¨äº† C è¯­è¨€çš„ setjmp å’Œ longjmpï¼ˆ <a href="http://www.cnblogs.com/Pony279/p/3903048.html" target="_blank" rel="noopener">ä¸€ç§åç¨‹çš„ C/C++ å®ç°</a>, è¦æ±‚å‡½æ•°é‡Œé¢ä½¿ç”¨ static local çš„å˜é‡æ¥ä¿å­˜åç¨‹å†…éƒ¨çš„æ•°æ®ï¼‰</li>
</ul>
<p>æœ¬ç¯‡ä¸»è¦ä½¿ç”¨ ucontext æ¥å®ç°ç®€å•çš„åç¨‹åº“ã€‚</p>
<p><strong>. . .</strong>
          <!--noindex-->
          
          <!--/noindex-->
        
      


      

    
      <footer class="post-footer">
        

        

        

        
        
          <div class="post-eof"></div>
        
      </footer>
      
    </p></div>
    
    
    

    

    

    

  </div>
  
  
  
  </article>


      
    
      
        

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hulinhong.com/self_cultivation_distributed_system/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mike">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ğŸš™">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/self_cultivation_distributed_system/" itemprop="url">æœåŠ¡å™¨å¼€å‘è‡ªæˆ‘ä¿®å…»ä¸“æ -åˆ†å¸ƒå¼ç³»ç»Ÿ</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-15T19:08:06+00:00">
                03-15-2021
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Self-cultivation/" itemprop="url" rel="index">
                    <span itemprop="name">Self-cultivation</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    




    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      

      
      
        <div class="post-eof"></div>
      

      
      

      
        
          
            <h1 id="åˆ†å¸ƒå¼ç³»ç»Ÿ"><a href="#åˆ†å¸ƒå¼ç³»ç»Ÿ" class="headerlink" title="åˆ†å¸ƒå¼ç³»ç»Ÿ"></a>åˆ†å¸ƒå¼ç³»ç»Ÿ</h1><p>åˆ†å¸ƒå¼ç³»ç»Ÿçš„å°±å‡†å¤‡:  </p>
<ul>
<li>CAPç†è®º</li>
<li>BASEç†è®º</li>
<li><a href="#åˆ†å¸ƒå¼äº‹åŠ¡">åˆ†å¸ƒå¼äº‹åŠ¡</a></li>
<li><a href="#åˆ†å¸ƒå¼é”">åˆ†å¸ƒå¼é”</a></li>
<li>é™æµ</li>
<li>ç†”æ–­</li>
<li>ä¸€è‡´æ€§é€‰ä¸¾ç®—æ³•</li>
<li>ä¸»ä»æ¶æ„</li>
<li>é›†ç¾¤æ¶æ„</li>
<li>å¼‚åœ°å¤šæ´»</li>
<li>è´Ÿè½½å‡è¡¡</li>
<li>åˆ†å±‚æ¶æ„</li>
<li>å¾®æœåŠ¡, æœåŠ¡æ²»ç†</li>
<li>â€¦</li>
</ul>
<h2 id="å…±è¯†"><a href="#å…±è¯†" class="headerlink" title="å…±è¯†"></a>å…±è¯†</h2><p>consensus å‡†ç¡®çš„ç¿»è¯‘æ˜¯å…±è¯†ï¼Œå³å¤šä¸ªæè®®è€…è¾¾æˆå…±è¯†çš„è¿‡ç¨‹ï¼Œä¾‹å¦‚ Paxosï¼ŒRaft å°±æ˜¯å…±è¯†ç®—æ³•ï¼Œpaxos æ˜¯ä¸€ç§å…±è¯†ç†è®ºï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿæ˜¯ä»–çš„åœºæ™¯ï¼Œä¸€è‡´æ€§æ˜¯ä»–çš„ç›®æ ‡ã€‚</p>
<p>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰çš„å«ä¹‰æ¯”å…±è¯†ï¼ˆconsensusï¼‰è¦å®½æ³›ï¼Œä¸€è‡´æ€§æŒ‡çš„æ˜¯å¤šä¸ªå‰¯æœ¬å¯¹å¤–å‘ˆç°çš„çŠ¶æ€ã€‚åŒ…æ‹¬é¡ºåºä¸€è‡´æ€§ã€çº¿æ€§ä¸€è‡´æ€§ã€æœ€ç»ˆä¸€è‡´æ€§ç­‰ã€‚è€Œå…±è¯†ç‰¹æŒ‡è¾¾æˆä¸€è‡´çš„è¿‡ç¨‹ï¼Œä½†æ³¨æ„ï¼Œå…±è¯†å¹¶ä¸æ„å‘³ç€å®ç°äº†ä¸€è‡´æ€§ï¼Œä¸€äº›æƒ…å†µä¸‹ä»–æ˜¯åšä¸åˆ°çš„ã€‚</p>
<h2 id="ä¸€è‡´æ€§çš„ç±»åˆ«"><a href="#ä¸€è‡´æ€§çš„ç±»åˆ«" class="headerlink" title="ä¸€è‡´æ€§çš„ç±»åˆ«"></a>ä¸€è‡´æ€§çš„ç±»åˆ«</h2><p>æåˆ°åˆ†å¸ƒå¼æ¶æ„å°±ä¸€å®šç»•ä¸å¼€ â€œä¸€è‡´æ€§â€ é—®é¢˜ï¼Œè€Œ â€œä¸€è‡´æ€§â€ å…¶å®åˆåŒ…å«äº†<strong>æ•°æ®ä¸€è‡´æ€§</strong>å’Œ<strong>äº‹åŠ¡ä¸€è‡´æ€§</strong>ä¸¤ç§æƒ…å†µï¼Œæœ¬èŠ‚ä¸»è¦è®¨è®º<strong>æ•°æ®ä¸€è‡´æ€§</strong>ï¼ˆäº‹åŠ¡ä¸€è‡´æ€§æŒ‡ ACIDï¼‰ã€‚<strong>å¤åˆ¶</strong>æ˜¯å¯¼è‡´å‡ºç°<strong>æ•°æ®ä¸€è‡´æ€§</strong>é—®é¢˜çš„å”¯ä¸€åŸå› ã€‚</p>
<p>å…³äºå¼ºå’Œå¼±çš„å®šä¹‰ï¼Œå¯ä»¥å‚è€ƒå‰‘æ¡¥å¤§å­¦çš„ <a href="https://www.cl.cam.ac.uk/teaching/0910/ConcDistS/11a-cons-tx.pdf" target="_blank" rel="noopener">slide</a>.</p>
<ul>
<li>Strong consistency â€“ ensures that only consistent state can be seen: <ul>
<li>All replicas return the same value when queried for the attribute of an object * All replicas return the same value when queried for the attribute of an object. This may be achieved at a cost â€“ high latency.</li>
</ul>
</li>
<li>Weak consistency â€“ for when the â€œfast accessâ€ requirement dominates:  <ul>
<li>update some replica, e.g. the closest or some designated replica</li>
<li>the updated replica sends up date messages to all other replicas.</li>
<li>different replicas can return different values for the queried attribute of the object the value should be returned, or â€œnot knownâ€, with a timestamp</li>
<li>in the long term all updates must propagate to all replicas â€¦â€¦.</li>
</ul>
</li>
</ul>
<p>ä¸€è‡´æ€§çš„è¯¦ç»†åˆ†ç±»:  </p>
<ul>
<li>å¼ºä¸€è‡´æ€§<br>  å¼ºä¸€è‡´æ€§é›†ç¾¤ä¸­ï¼Œå¯¹ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹å‘èµ·è¯·æ±‚éƒ½ä¼šå¾—åˆ°ç›¸åŒçš„å›å¤ï¼Œä½†å¯èƒ½ä¼šäº§ç”Ÿç›¸å¯¹é«˜çš„å»¶è¿Ÿ<ul>
<li><a href="#çº¿æ€§ä¸€è‡´æ€§">çº¿æ€§ä¸€è‡´æ€§(Linearizability consistency, ä¹Ÿå«åŸå­ä¸€è‡´æ€§, <strong>å¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬è¯´å¼ºä¸€è‡´æ€§å…¶å®æ˜¯æŒ‡çº¿æ€§ä¸€è‡´æ€§</strong>)</a></li>
<li><a href="#é¡ºåºä¸€è‡´æ€§">é¡ºåºä¸€è‡´æ€§(Sequential consistency, æ¯”çº¿æ€§ä¸€è‡´æ€§ç¨å¼±, ä½†ä¹Ÿç®—æ˜¯å¼ºä¸€è‡´æ€§çš„ä¸€ç§)</a></li>
</ul>
</li>
<li>å¼±ä¸€è‡´æ€§<br>  å¼±ä¸€è‡´æ€§å…·æœ‰æ›´ä½çš„å“åº”å»¶è¿Ÿï¼Œä½†å¯èƒ½ä¼šå›å¤è¿‡æœŸçš„æ•°æ®, å¯¼è‡´å„ä¸ªèŠ‚ç‚¹æ‹¿åˆ°çš„æ•°æ®ä¸ä¸€è‡´ã€‚<ul>
<li>æœ€ç»ˆä¸€è‡´æ€§(Eventual consistency)<ul>
<li>å«ä¹‰: ç³»ç»Ÿä¼šä¿è¯åœ¨ä¸€å®šæ—¶é—´å†…ï¼Œèƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªæ•°æ®ä¸€è‡´çš„çŠ¶æ€ã€‚è¿™é‡Œä¹‹æ‰€ä»¥å°†æœ€ç»ˆä¸€è‡´æ€§å•ç‹¬æå‡ºæ¥ï¼Œæ˜¯å› ä¸ºå®ƒæ˜¯å¼±ä¸€è‡´æ€§ä¸­éå¸¸æ¨å´‡çš„ä¸€ç§ä¸€è‡´æ€§æ¨¡å‹ï¼Œä¹Ÿæ˜¯ä¸šç•Œåœ¨å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ•°æ®ä¸€è‡´æ€§ä¸Šæ¯”è¾ƒæ¨å´‡çš„æ¨¡å‹ã€‚</li>
</ul>
</li>
<li>å› æœä¸€è‡´æ€§(Causal consistency)<ul>
<li>å«ä¹‰: å¦‚æœä¸€ç³»åˆ—å†™å…¥æŒ‰æŸä¸ªé€»è¾‘é¡ºåºå‘ç”Ÿï¼Œé‚£ä¹ˆä»»ä½•äººè¯»å–è¿™äº›å†™å…¥æ—¶ï¼Œä¼šçœ‹è§å®ƒä»¬ä»¥æ­£ç¡®çš„é€»è¾‘é¡ºåºå‡ºç°ã€‚</li>
<li>å®ç°: ä¸€ç§æ–¹æ¡ˆæ˜¯åº”ç”¨ä¿è¯å°†é—®é¢˜å’Œå¯¹åº”çš„å›ç­”å†™å…¥ç›¸åŒçš„åˆ†åŒº</li>
</ul>
</li>
<li>è¯»å†™ä¸€è‡´æ€§:<ul>
<li>å«ä¹‰: å®ƒå¯ä»¥ä¿è¯ï¼Œå¦‚æœç”¨æˆ·åˆ·æ–°é¡µé¢ï¼Œä»–ä»¬æ€»ä¼šçœ‹åˆ°è‡ªå·±åˆšæäº¤çš„ä»»ä½•æ›´æ–°ã€‚å®ƒä¸ä¼šå¯¹å…¶ä»–ç”¨æˆ·çš„å†™å…¥åšå‡ºæ‰¿è¯ºï¼Œå…¶ä»–ç”¨æˆ·çš„æ›´æ–°å¯èƒ½ç¨ç­‰æ‰ä¼šçœ‹åˆ°ï¼Œä½†å®ƒä¿è¯ç”¨æˆ·è‡ªå·±æäº¤çš„æ•°æ®èƒ½é©¬ä¸Šè¢«è‡ªå·±çœ‹åˆ°ã€‚</li>
</ul>
</li>
<li>å•è°ƒè¯»: <ul>
<li>å«ä¹‰: å¦‚æœå…ˆå‰è¯»å–åˆ°è¾ƒæ–°çš„æ•°æ®ï¼Œåç»­è¯»å–ä¸ä¼šå¾—åˆ°æ›´æ—§çš„æ•°æ®.</li>
<li>å®ç°: å®ç°å•è°ƒè¯»å–çš„ä¸€ç§æ–¹å¼æ˜¯<strong>ç¡®ä¿æ¯ä¸ªç”¨æˆ·æ€»æ˜¯ä»åŒä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œè¯»å–</strong>ï¼ˆä¸åŒçš„ç”¨æˆ·å¯ä»¥ä»ä¸åŒçš„èŠ‚ç‚¹è¯»å–ï¼‰ï¼Œæ¯”å¦‚å¯ä»¥åŸºäºç”¨æˆ· ID çš„å“ˆå¸Œå€¼æ¥é€‰æ‹©èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯éšæœºé€‰æ‹©èŠ‚ç‚¹ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="çº¿æ€§ä¸€è‡´æ€§"><a href="#çº¿æ€§ä¸€è‡´æ€§" class="headerlink" title="çº¿æ€§ä¸€è‡´æ€§"></a>çº¿æ€§ä¸€è‡´æ€§</h3><p><a href="#etcd">etcd</a> è¯»å†™éƒ½åšäº†çº¿æ€§ä¸€è‡´ï¼Œå³ etcd æ˜¯æ ‡å‡†çš„å¼ºä¸€è‡´æ€§ä¿è¯ã€‚</p>
<p>çº¿æ€§ä¸€è‡´æ€§åˆè¢«ç§°ä¸ºå¼ºä¸€è‡´æ€§ã€ä¸¥æ ¼ä¸€è‡´æ€§ã€åŸå­ä¸€è‡´æ€§ã€‚æ˜¯ç¨‹åºèƒ½å®ç°çš„æœ€é«˜çš„ä¸€è‡´æ€§æ¨¡å‹ï¼Œä¹Ÿæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿç”¨æˆ·æœ€æœŸæœ›çš„ä¸€è‡´æ€§ã€‚CAP ä¸­çš„ C ä¸€èˆ¬å°±æŒ‡å®ƒ<br>é¡ºåºä¸€è‡´æ€§ä¸­è¿›ç¨‹åªå…³å¿ƒå¤§å®¶è®¤åŒçš„é¡ºåºä¸€æ ·å°±è¡Œï¼Œä¸éœ€è¦ä¸å…¨å±€æ—¶é’Ÿä¸€è‡´ï¼Œçº¿æ€§å°±æ›´ä¸¥æ ¼ï¼Œä»è¿™ç§ååºï¼ˆpartial orderï¼‰è¦è¾¾åˆ°å…¨åºï¼ˆtotal orderï¼‰</p>
<p>è¦æ±‚æ˜¯ï¼š  </p>
<ul>
<li>ä»»ä½•ä¸€æ¬¡è¯»éƒ½èƒ½è¯»åˆ°æŸä¸ªæ•°æ®çš„æœ€è¿‘ä¸€æ¬¡å†™çš„æ•°æ®ã€‚</li>
<li>ç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹ï¼Œçœ‹åˆ°çš„æ“ä½œé¡ºåºï¼Œéƒ½ä¸å…¨å±€æ—¶é’Ÿä¸‹çš„é¡ºåºä¸€è‡´ã€‚</li>
</ul>
<p>ä»¥ä¸‹å›¾è®¨è®º,<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/cache_db_consistency/cache_db_consistency_3.png" alt>  </p>
<p>B1 çœ‹åˆ° x çš„æ–°å€¼ï¼ŒC1 åè€Œçœ‹åˆ°çš„æ˜¯æ—§å€¼ã€‚å³å¯¹ç”¨æˆ·æ¥è¯´ï¼Œx çš„å€¼å‘ç”Ÿäº†å›è·³ã€‚</p>
<p>åœ¨çº¿æ€§ä¸€è‡´çš„ç³»ç»Ÿä¸­ï¼Œå¦‚æœ B1 çœ‹åˆ°çš„ x å€¼ä¸º 1ï¼Œåˆ™ C1 çœ‹åˆ°çš„å€¼ä¹Ÿä¸€å®šä¸º 1ã€‚ä»»ä½•æ“ä½œåœ¨è¯¥ç³»ç»Ÿç”Ÿæ•ˆçš„æ—¶åˆ»éƒ½å¯¹åº”æ—¶é—´è½´ä¸Šçš„ä¸€ä¸ªç‚¹ã€‚å¦‚æœæˆ‘ä»¬æŠŠè¿™äº›æ—¶åˆ»è¿æ¥èµ·æ¥ï¼Œå¦‚ä¸‹å›¾ä¸­ç´«çº¿æ‰€ç¤ºï¼Œåˆ™è¿™æ¡çº¿ä¼šä¸€ç›´æ²¿æ—¶é—´è½´å‘å‰ï¼Œä¸ä¼šåå‘å›è·³ã€‚æ‰€ä»¥ä»»ä½•æ“ä½œéƒ½éœ€è¦äº’ç›¸æ¯”è¾ƒå†³å®šï¼Œè°å‘ç”Ÿåœ¨å‰ï¼Œè°å‘ç”Ÿåœ¨åã€‚ä¾‹å¦‚ B1 å‘ç”Ÿåœ¨ A0 å‰ï¼ŒC1 å‘ç”Ÿåœ¨ A0 åã€‚è€Œåœ¨å‰é¢é¡ºåºä¸€è‡´æ€§æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬æ— æ³•æ¯”è¾ƒè¯¸å¦‚ B1 å’Œ A0 çš„å…ˆåå…³ç³»ã€‚<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/cache_db_consistency/cache_db_consistency_4.png" alt>  </p>
<h3 id="é¡ºåºä¸€è‡´æ€§"><a href="#é¡ºåºä¸€è‡´æ€§" class="headerlink" title="é¡ºåºä¸€è‡´æ€§"></a>é¡ºåºä¸€è‡´æ€§</h3><h4 id="ä¸¾ä¾‹è¯´æ˜1"><a href="#ä¸¾ä¾‹è¯´æ˜1" class="headerlink" title="ä¸¾ä¾‹è¯´æ˜1"></a>ä¸¾ä¾‹è¯´æ˜1</h4><p>ä¸‹é¢çš„å›¾æ»¡è¶³äº†é¡ºåºä¸€è‡´ï¼Œä½†ä¸æ»¡è¶³çº¿æ€§ä¸€è‡´ã€‚<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/consistency/consistency_1.jpg" alt>  </p>
<ul>
<li>x å’Œ y çš„åˆå§‹å€¼ä¸º 0</li>
<li>Write(x,4) ä»£è¡¨å†™å…¥ x=4ï¼ŒRead(y,2) ä¸ºè¯»å– y =2</li>
</ul>
<p>ä»å›¾ä¸Šçœ‹ï¼Œè¿›ç¨‹ P1ï¼ŒP2 çš„ä¸€è‡´æ€§å¹¶æ²¡æœ‰å†²çªã€‚å› ä¸ºä»è¿™ä¸¤ä¸ªè¿›ç¨‹çš„è§’åº¦æ¥çœ‹ï¼Œé¡ºåºåº”è¯¥æ˜¯è¿™æ ·çš„ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Write(y,2), Read(x,0), Write(x,4), Read(y,2)</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªé¡ºåºå¯¹äºä¸¤ä¸ªè¿›ç¨‹å†…éƒ¨çš„è¯»å†™é¡ºåºéƒ½æ˜¯åˆç†çš„ï¼Œåªæ˜¯è¿™ä¸ªé¡ºåºä¸å…¨å±€æ—¶é’Ÿä¸‹çœ‹åˆ°çš„é¡ºåºå¹¶ä¸ä¸€æ ·ã€‚åœ¨å…¨å±€æ—¶é’Ÿçš„è§‚ç‚¹æ¥çœ‹ï¼ŒP2 è¿›ç¨‹å¯¹å˜é‡ X çš„è¯»æ“ä½œåœ¨ P1 è¿›ç¨‹å¯¹å˜é‡ X çš„å†™æ“ä½œä¹‹åï¼Œç„¶è€Œ P2 è¯»å‡ºæ¥çš„å´æ˜¯æ—§çš„æ•°æ® 0</p>
<h4 id="ä¸¾ä¾‹è¯´æ˜2"><a href="#ä¸¾ä¾‹è¯´æ˜2" class="headerlink" title="ä¸¾ä¾‹è¯´æ˜2"></a>ä¸¾ä¾‹è¯´æ˜2</h4><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸ªåˆ†å¸ƒå¼ KV ç³»ç»Ÿï¼Œä»¥ä¸‹æ˜¯å››ä¸ªè¿›ç¨‹ å¯¹å…¶çš„æ“ä½œé¡ºåºå’Œç»“æœ:<br><code>--</code> è¡¨ç¤ºæŒç»­çš„æ—¶é—´ï¼Œå› ä¸ºä¸€æ¬¡å†™å…¥æˆ–è€…è¯»å–ï¼Œå®¢æˆ·ç«¯ä»å‘èµ·åˆ°å“åº”æ˜¯æœ‰æ—¶é—´çš„ï¼Œå‘èµ·æ—©çš„å®¢æˆ·ç«¯ï¼Œä¸ä¸€å®šæ‹¿åˆ°æ•°æ®å°±æ—©ï¼Œæœ‰å¯èƒ½å› ä¸ºç½‘ç»œå»¶è¿Ÿåè€Œä¼šæ›´æ™šã€‚<br>æƒ…å†µ 1ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A: --W(x,1)----------------------</span><br><span class="line">B:  --W(x,2)----------------------</span><br><span class="line">C:                      -R(x,1)-   --R(x,2)-</span><br><span class="line">D:                 -R(x,1)-      --R(x,2)--</span><br></pre></td></tr></table></figure></p>
<p>æƒ…å†µ 2ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A: --W(x,1)----------------------</span><br><span class="line">B:  --W(x,2)----------------------</span><br><span class="line">C:                      -R(x,2)-   --R(x,1)-</span><br><span class="line">D:                 -R(x,2)-      --R(x,1)--</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢æƒ…å†µ 1 å’Œ 2 éƒ½æ˜¯æ»¡è¶³é¡ºåºä¸€è‡´æ€§çš„ï¼ŒC å’Œ D æ‹¿çš„é¡ºåºéƒ½æ˜¯ 1-2ï¼Œæˆ– 2-1ï¼Œåªè¦ CD çš„é¡ºåºä¸€è‡´ï¼Œå°±æ˜¯æ»¡è¶³é¡ºåºä¸€è‡´æ€§ã€‚åªæ˜¯ä»å…¨å±€çœ‹æ¥ï¼Œæƒ…å†µ 1 æ›´çœŸå®ï¼Œæƒ…å†µ 2 å°±æ˜¾å¾—â€ é”™è¯¯ â€œäº†ï¼Œå› ä¸ºæƒ…å†µ 2 æ˜¯è¿™æ ·çš„é¡ºåº<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">B W(x,2) -&gt; A W(x,1) -&gt; C R(x,2) -&gt; D R(x,2) -&gt; C R(x,1) -&gt; D R(x,1)</span><br></pre></td></tr></table></figure></p>
<p><strong>ä¸è¿‡ä¸€è‡´æ€§ä¸ä¿è¯æ­£ç¡®æ€§ï¼Œæ‰€ä»¥è¿™ä»ç„¶æ˜¯ä¸€ä¸ªé¡ºåºä¸€è‡´</strong>ã€‚å†åŠ ä¸€ç§æƒ…å†µ 3ï¼š<br>æƒ…å†µ 3ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A: --W(x,1)----------------------</span><br><span class="line">B:  --W(x,2)----------------------</span><br><span class="line">C:                      -R(x,2)-   --R(x,1)-</span><br><span class="line">D:                 -R(x,1)-      --R(x,2)--</span><br></pre></td></tr></table></figure></p>
<p>æƒ…å†µ 3 å°±ä¸å±äºé¡ºåºä¸€è‡´äº†ï¼Œå› ä¸º C å’Œ D ä¸¤ä¸ªè¿›ç¨‹çš„è¯»å–é¡ºåºä¸åŒäº†ã€‚</p>
<h4 id="ä¸¾ä¾‹è¯´æ˜3"><a href="#ä¸¾ä¾‹è¯´æ˜3" class="headerlink" title="ä¸¾ä¾‹è¯´æ˜3"></a>ä¸¾ä¾‹è¯´æ˜3</h4><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/cache_db_consistency/cache_db_consistency_3.png" alt><br>è¿™ä¹Ÿæ˜¯é¡ºåºä¸€è‡´çš„, ä½†æ˜¯å¯èƒ½ä¸æ»¡è¶³äº§å“ç»ç†è¦æ±‚.  </p>
<p>ä»æ—¶é—´è½´ä¸Šå¯ä»¥çœ‹åˆ°ï¼ŒB0 å‘ç”Ÿåœ¨ A0 ä¹‹å‰ï¼Œè¯»å–åˆ°çš„ x å€¼ä¸º 0ã€‚B2 å‘ç”Ÿåœ¨ A0 ä¹‹åï¼Œè¯»å–åˆ°çš„ x å€¼ä¸º 1ã€‚è€Œè¯»æ“ä½œ B1ï¼ŒC0ï¼ŒC1 ä¸å†™æ“ä½œ A0 åœ¨æ—¶é—´è½´ä¸Šæœ‰é‡å ï¼Œå› æ­¤ä»–ä»¬å¯èƒ½è¯»å–åˆ°æ—§çš„å€¼ 0ï¼Œä¹Ÿå¯èƒ½è¯»å–åˆ°æ–°çš„å€¼ 1ã€‚æ³¨æ„ï¼ŒC1 å‘ç”Ÿåœ¨ B1 ä¹‹åï¼ˆäºŒè€…åœ¨æ—¶é—´è½´ä¸Šæ²¡æœ‰é‡å ï¼‰ï¼Œä½†æ˜¯ B1 çœ‹åˆ° x çš„æ–°å€¼ï¼ŒC1 åè€Œçœ‹åˆ°çš„æ˜¯æ—§å€¼ã€‚å³å¯¹ç”¨æˆ·æ¥è¯´ï¼Œx çš„å€¼å‘ç”Ÿäº†å›è·³ã€‚</p>
<h2 id="CAPç†è®º"><a href="#CAPç†è®º" class="headerlink" title="CAPç†è®º"></a>CAPç†è®º</h2><p>ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯èƒ½åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªåŸºæœ¬éœ€æ±‚ï¼Œæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³å…¶ä¸­ä¸¤é¡¹:</p>
<ul>
<li><p>ä¸€è‡´æ€§ï¼ˆCï¼šConsistency, <strong>CAPçš„CæŒ‡çš„æ˜¯å¼ºä¸€è‡´æ€§</strong>ï¼‰<br>  åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œä¸€è‡´æ€§æ˜¯æŒ‡æ•°æ®åœ¨å¤šä¸ªå‰¯æœ¬ä¹‹é—´èƒ½å¦ä¿æŒä¸€è‡´çš„ç‰¹æ€§ã€‚åœ¨ä¸€è‡´æ€§çš„éœ€æ±‚ä¸‹ï¼Œå½“ä¸€ä¸ªç³»ç»Ÿåœ¨æ•°æ®ä¸€è‡´çš„çŠ¶æ€ä¸‹æ‰§è¡Œæ›´æ–°æ“ä½œåï¼Œåº”è¯¥ä¿è¯ç³»ç»Ÿçš„æ•°æ®ä»ç„¶å¤„äºä¸€è‡´çš„çŠ¶æ€ã€‚</p>
<p>  å¯¹äºä¸€ä¸ªå°†æ•°æ®å‰¯æœ¬åˆ†å¸ƒåœ¨ä¸åŒåˆ†å¸ƒå¼èŠ‚ç‚¹ä¸Šçš„ç³»ç»Ÿæ¥è¯´ï¼Œå¦‚æœå¯¹ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®è¿›è¡Œäº†æ›´æ–°æ“ä½œå¹¶ä¸”æ›´æ–°æˆåŠŸåï¼Œå´æ²¡æœ‰ä½¿å¾—ç¬¬äºŒä¸ªèŠ‚ç‚¹ä¸Šçš„æ•°æ®å¾—åˆ°ç›¸åº”çš„æ›´æ–°ï¼Œäºæ˜¯åœ¨å¯¹ç¬¬äºŒä¸ªèŠ‚ç‚¹çš„æ•°æ®è¿›è¡Œè¯»å–æ“ä½œæ—¶ï¼Œè·å–çš„ä¾ç„¶æ˜¯è€æ•°æ®ï¼ˆæˆ–ç§°ä¸ºè„æ•°æ®ï¼‰ï¼Œè¿™å°±æ˜¯å…¸å‹çš„åˆ†å¸ƒå¼æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚æœèƒ½å¤Ÿåšåˆ°é’ˆå¯¹ä¸€ä¸ªæ•°æ®é¡¹çš„æ›´æ–°æ“ä½œæ‰§è¡ŒæˆåŠŸåï¼Œæ‰€æœ‰çš„ç”¨æˆ·éƒ½å¯ä»¥è¯»å–åˆ°å…¶æœ€æ–°çš„å€¼ï¼Œé‚£ä¹ˆè¿™æ ·çš„ç³»ç»Ÿå°±è¢«è®¤ä¸ºå…·æœ‰å¼ºä¸€è‡´æ€§ã€‚</p>
</li>
<li><p>å¯ç”¨æ€§ï¼ˆAï¼šAvailabilityï¼‰<br>å¯ç”¨æ€§æ˜¯æŒ‡ç³»ç»Ÿæä¾›çš„æœåŠ¡å¿…é¡»ä¸€ç›´å¤„äºå¯ç”¨çš„çŠ¶æ€ï¼Œå¯¹äºç”¨æˆ·çš„æ¯ä¸€ä¸ªæ“ä½œè¯·æ±‚æ€»æ˜¯èƒ½å¤Ÿåœ¨æœ‰é™çš„æ—¶é—´å†…è¿”å›ç»“æœã€‚è¿™é‡Œçš„é‡ç‚¹æ˜¯ â€œæœ‰é™æ—¶é—´å†…â€ å’Œ â€œè¿”å›ç»“æœâ€ã€‚</p>
<p>â€œæœ‰é™æ—¶é—´å†…â€ æ˜¯æŒ‡ï¼Œå¯¹äºç”¨æˆ·çš„ä¸€ä¸ªæ“ä½œè¯·æ±‚ï¼Œç³»ç»Ÿå¿…é¡»èƒ½å¤Ÿåœ¨æŒ‡å®šçš„æ—¶é—´å†…è¿”å›å¯¹åº”çš„å¤„ç†ç»“æœï¼Œå¦‚æœè¶…è¿‡äº†è¿™ä¸ªæ—¶é—´èŒƒå›´ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±è¢«è®¤ä¸ºæ˜¯ä¸å¯ç”¨çš„ã€‚å¦å¤–ï¼Œâ€æœ‰é™çš„æ—¶é—´å†…â€ æ˜¯æŒ‡ç³»ç»Ÿè®¾è®¡ä¹‹åˆå°±è®¾è®¡å¥½çš„è¿è¡ŒæŒ‡æ ‡ï¼Œé€šå¸¸ä¸åŒç³»ç»Ÿä¹‹é—´æœ‰å¾ˆå¤§çš„ä¸åŒï¼Œæ— è®ºå¦‚ä½•ï¼Œå¯¹äºç”¨æˆ·è¯·æ±‚ï¼Œç³»ç»Ÿå¿…é¡»å­˜åœ¨ä¸€ä¸ªåˆç†çš„å“åº”æ—¶é—´ï¼Œå¦åˆ™ç”¨æˆ·ä¾¿ä¼šå¯¹ç³»ç»Ÿæ„Ÿåˆ°å¤±æœ›ã€‚</p>
<p>â€œè¿”å›ç»“æœâ€ æ˜¯å¯ç”¨æ€§çš„å¦ä¸€ä¸ªéå¸¸é‡è¦çš„æŒ‡æ ‡ï¼Œå®ƒè¦æ±‚ç³»ç»Ÿåœ¨å®Œæˆå¯¹ç”¨æˆ·è¯·æ±‚çš„å¤„ç†åï¼Œè¿”å›ä¸€ä¸ªæ­£å¸¸çš„å“åº”ç»“æœã€‚æ­£å¸¸çš„å“åº”ç»“æœé€šå¸¸èƒ½å¤Ÿæ˜ç¡®åœ°åæ˜ å‡ºé˜Ÿè¯·æ±‚çš„å¤„ç†ç»“æœï¼Œå³æˆåŠŸæˆ–å¤±è´¥ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªè®©ç”¨æˆ·æ„Ÿåˆ°å›°æƒ‘çš„è¿”å›ç»“æœã€‚</p>
</li>
<li><p>åˆ†åŒºå®¹é”™æ€§ï¼ˆPï¼šPartition toleranceï¼‰<br>ç³»ç»Ÿåº”è¯¥èƒ½æŒç»­æä¾›æœåŠ¡ï¼Œå³ä½¿ç³»ç»Ÿå†…éƒ¨æœ‰æ¶ˆæ¯ä¸¢å¤±ï¼ˆåˆ†åŒºï¼‰ã€‚</p>
<p>ç½‘ç»œåˆ†åŒºæ˜¯æŒ‡åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸åŒçš„èŠ‚ç‚¹åˆ†å¸ƒåœ¨ä¸åŒçš„å­ç½‘ç»œï¼ˆæœºæˆ¿æˆ–å¼‚åœ°ç½‘ç»œï¼‰ä¸­ï¼Œç”±äºä¸€äº›ç‰¹æ®Šçš„åŸå› å¯¼è‡´è¿™äº›å­ç½‘ç»œå‡ºç°ç½‘ç»œä¸è¿é€šçš„çŠ¶å†µï¼Œä½†å„ä¸ªå­ç½‘ç»œçš„å†…éƒ¨ç½‘ç»œæ˜¯æ­£å¸¸çš„ï¼Œä»è€Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿçš„ç½‘ç»œç¯å¢ƒè¢«åˆ‡åˆ†æˆäº†è‹¥å¹²ä¸ªå­¤ç«‹çš„åŒºåŸŸã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»„æˆä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿçš„æ¯ä¸ªèŠ‚ç‚¹çš„åŠ å…¥ä¸é€€å‡ºéƒ½å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç½‘ç»œåˆ†åŒºã€‚</p>
</li>
</ul>
<h3 id="capé€šä¿—è€Œç²¾å‡†çš„è§£é‡Š"><a href="#capé€šä¿—è€Œç²¾å‡†çš„è§£é‡Š" class="headerlink" title="capé€šä¿—è€Œç²¾å‡†çš„è§£é‡Š"></a>capé€šä¿—è€Œç²¾å‡†çš„è§£é‡Š</h3><p>ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿé‡Œé¢ï¼ŒèŠ‚ç‚¹ç»„æˆçš„ç½‘ç»œæœ¬æ¥åº”è¯¥æ˜¯è¿é€šçš„ã€‚ç„¶è€Œå¯èƒ½å› ä¸ºä¸€äº›æ•…éšœï¼Œä½¿å¾—æœ‰äº›èŠ‚ç‚¹ä¹‹é—´ä¸è¿é€šäº†ï¼Œæ•´ä¸ªç½‘ç»œå°±åˆ†æˆäº†å‡ å—åŒºåŸŸã€‚æ•°æ®å°±æ•£å¸ƒåœ¨äº†è¿™äº›ä¸è¿é€šçš„åŒºåŸŸä¸­ã€‚è¿™å°±å«åˆ†åŒºã€‚</p>
<p>å½“ä½ ä¸€ä¸ªæ•°æ®é¡¹åªåœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸­ä¿å­˜ï¼Œé‚£ä¹ˆåˆ†åŒºå‡ºç°åï¼Œå’Œè¿™ä¸ªèŠ‚ç‚¹ä¸è¿é€šçš„éƒ¨åˆ†å°±è®¿é—®ä¸åˆ°è¿™ä¸ªæ•°æ®äº†ã€‚è¿™æ—¶åˆ†åŒºå°±æ˜¯æ— æ³•å®¹å¿çš„ã€‚</p>
<p>æé«˜åˆ†åŒºå®¹å¿æ€§çš„åŠæ³•å°±æ˜¯ä¸€ä¸ªæ•°æ®é¡¹å¤åˆ¶åˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆå‡ºç°åˆ†åŒºä¹‹åï¼Œè¿™ä¸€æ•°æ®é¡¹å°±å¯èƒ½åˆ†å¸ƒåˆ°å„ä¸ªåŒºé‡Œã€‚å®¹å¿æ€§å°±æé«˜äº†ã€‚</p>
<p>ç„¶è€Œï¼Œè¦æŠŠæ•°æ®å¤åˆ¶åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼Œå°±ä¼šå¸¦æ¥ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œå°±æ˜¯å¤šä¸ªèŠ‚ç‚¹ä¸Šé¢çš„æ•°æ®å¯èƒ½æ˜¯ä¸ä¸€è‡´çš„ã€‚è¦ä¿è¯ä¸€è‡´ï¼Œæ¯æ¬¡å†™æ“ä½œå°±éƒ½è¦ç­‰å¾…å…¨éƒ¨èŠ‚ç‚¹å†™æˆåŠŸï¼Œè€Œè¿™ç­‰å¾…åˆä¼šå¸¦æ¥å¯ç”¨æ€§çš„é—®é¢˜ã€‚æ€»çš„æ¥è¯´å°±æ˜¯ï¼Œæ•°æ®å­˜åœ¨çš„èŠ‚ç‚¹è¶Šå¤šï¼Œåˆ†åŒºå®¹å¿æ€§è¶Šé«˜ï¼Œä½†è¦å¤åˆ¶æ›´æ–°çš„æ•°æ®å°±è¶Šå¤šï¼Œä¸€è‡´æ€§å°±è¶Šéš¾ä¿è¯ã€‚ä¸ºäº†ä¿è¯ä¸€è‡´æ€§ï¼Œæ›´æ–°æ‰€æœ‰èŠ‚ç‚¹æ•°æ®æ‰€éœ€è¦çš„æ—¶é—´å°±è¶Šé•¿ï¼Œå¯ç”¨æ€§å°±ä¼šé™ä½ã€‚</p>
<h3 id="capçš„ä¸€äº›ç»„åˆä¾‹å­"><a href="#capçš„ä¸€äº›ç»„åˆä¾‹å­" class="headerlink" title="capçš„ä¸€äº›ç»„åˆä¾‹å­"></a>capçš„ä¸€äº›ç»„åˆä¾‹å­</h3><p>æ—¢ç„¶ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ— æ³•åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€åˆ†åŒºå®¹é”™æ€§ä¸‰ä¸ªç‰¹ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦æŠ›å¼ƒä¸€ä¸ªï¼š</p>
<table>
<thead>
<tr>
<th>é€‰æ‹©</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>CA</td>
<td>æ”¾å¼ƒåˆ†åŒºå®¹é”™æ€§ï¼ŒåŠ å¼ºä¸€è‡´æ€§å’Œå¯ç”¨æ€§ï¼Œå…¶å®å°±æ˜¯ä¼ ç»Ÿçš„å•æœºæ•°æ®åº“çš„é€‰æ‹©</td>
</tr>
<tr>
<td>AP</td>
<td>æ”¾å¼ƒä¸€è‡´æ€§ï¼ˆ<strong>è¿™é‡Œè¯´çš„ä¸€è‡´æ€§æ˜¯å¼ºä¸€è‡´æ€§</strong>ï¼‰ï¼Œè¿½æ±‚åˆ†åŒºå®¹é”™æ€§å’Œå¯ç”¨æ€§ï¼Œè¿™æ˜¯å¾ˆå¤šåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡æ—¶çš„é€‰æ‹©ï¼Œä¾‹å¦‚å¾ˆå¤š NoSQL ç³»ç»Ÿå°±æ˜¯å¦‚æ­¤</td>
</tr>
<tr>
<td>CP</td>
<td>æ”¾å¼ƒå¯ç”¨æ€§ï¼Œè¿½æ±‚ä¸€è‡´æ€§å’Œåˆ†åŒºå®¹é”™æ€§ï¼ŒåŸºæœ¬ä¸ä¼šé€‰æ‹©ï¼Œç½‘ç»œé—®é¢˜ä¼šç›´æ¥è®©æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨, ä¾‹å¦‚ zookeeperå’Œ etcdéƒ½æ˜¯cpçš„</td>
</tr>
</tbody>
</table>
<p>éœ€è¦æ˜ç¡®çš„ä¸€ç‚¹æ˜¯ï¼Œ<strong>å¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿè€Œè¨€ï¼Œåˆ†åŒºå®¹é”™æ€§æ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„è¦æ±‚</strong>ã€‚å› ä¸ºæ—¢ç„¶æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œé‚£ä¹ˆåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ç»„ä»¶å¿…ç„¶éœ€è¦è¢«éƒ¨ç½²åˆ°ä¸åŒçš„èŠ‚ç‚¹ï¼Œå¦åˆ™ä¹Ÿå°±æ— æ‰€è°“åˆ†å¸ƒå¼ç³»ç»Ÿäº†ï¼Œå› æ­¤å¿…ç„¶å‡ºç°å­ç½‘ç»œã€‚è€Œå¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿè€Œè¨€ï¼Œç½‘ç»œé—®é¢˜åˆæ˜¯ä¸€ä¸ªå¿…å®šä¼šå‡ºç°çš„å¼‚å¸¸æƒ…å†µï¼Œå› æ­¤åˆ†åŒºå®¹é”™æ€§ä¹Ÿå°±æˆä¸ºäº†ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå¿…ç„¶éœ€è¦é¢å¯¹å’Œè§£å†³çš„é—®é¢˜ã€‚<strong>å› æ­¤ç³»ç»Ÿæ¶æ„å¸ˆå¾€å¾€éœ€è¦æŠŠç²¾åŠ›èŠ±åœ¨å¦‚ä½•æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹åœ¨ Cï¼ˆä¸€è‡´æ€§ï¼‰å’Œ Aï¼ˆå¯ç”¨æ€§ï¼‰ä¹‹é—´å¯»æ±‚å¹³è¡¡ã€‚</strong></p>
<h2 id="BASE-ç†è®º"><a href="#BASE-ç†è®º" class="headerlink" title="BASE ç†è®º"></a>BASE ç†è®º</h2><p>BASE æ˜¯  </p>
<ul>
<li>Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰</li>
<li>Soft stateï¼ˆè½¯çŠ¶æ€, å³ä¸­é—´çŠ¶æ€)</li>
<li>Eventually consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰</li>
</ul>
<p>ä¸‰ä¸ªçŸ­è¯­çš„ç¼©å†™ã€‚BASE ç†è®ºæ˜¯å¯¹ CAP ä¸­ä¸€è‡´æ€§å’Œå¯ç”¨æ€§æƒè¡¡çš„ç»“æœï¼Œå…¶æ¥æºäºå¯¹å¤§è§„æ¨¡äº’è”ç½‘ç³»ç»Ÿåˆ†å¸ƒå¼å®è·µçš„æ€»ç»“ï¼Œ æ˜¯åŸºäº CAP å®šç†é€æ­¥æ¼”åŒ–è€Œæ¥çš„ã€‚BASE ç†è®ºçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼Œä½†æ¯ä¸ªåº”ç”¨éƒ½å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹ç‚¹ï¼Œé‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ BASE ä¸­çš„ä¸‰è¦ç´ ï¼š  </p>
<ul>
<li>åŸºæœ¬å¯ç”¨<br>  åŸºæœ¬å¯ç”¨æ˜¯æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°ä¸å¯é¢„çŸ¥æ•…éšœçš„æ—¶å€™ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ã€‚æ³¨æ„ï¼Œè¿™ç»ä¸ç­‰ä»·äºç³»ç»Ÿä¸å¯ç”¨ã€‚æ¯”å¦‚ï¼š<ul>
<li>å“åº”æ—¶é—´ä¸Šçš„æŸå¤±ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåœ¨çº¿æœç´¢å¼•æ“éœ€è¦åœ¨ 0.5 ç§’ä¹‹å†…è¿”å›ç»™ç”¨æˆ·ç›¸åº”çš„æŸ¥è¯¢ç»“æœï¼Œä½†ç”±äºå‡ºç°æ•…éšœï¼ŒæŸ¥è¯¢ç»“æœçš„å“åº”æ—¶é—´å¢åŠ äº† 1~2 ç§’</li>
<li>ç³»ç»ŸåŠŸèƒ½ä¸Šçš„æŸå¤±ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œåœ¨ä¸€ä¸ªç”µå­å•†åŠ¡ç½‘ç«™ä¸Šè¿›è¡Œè´­ç‰©çš„æ—¶å€™ï¼Œæ¶ˆè´¹è€…å‡ ä¹èƒ½å¤Ÿé¡ºåˆ©å®Œæˆæ¯ä¸€ç¬”è®¢å•ï¼Œä½†æ˜¯åœ¨ä¸€äº›èŠ‚æ—¥å¤§ä¿ƒè´­ç‰©é«˜å³°çš„æ—¶å€™ï¼Œç”±äºæ¶ˆè´¹è€…çš„è´­ç‰©è¡Œä¸ºæ¿€å¢ï¼Œä¸ºäº†ä¿æŠ¤è´­ç‰©ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œéƒ¨åˆ†æ¶ˆè´¹è€…å¯èƒ½ä¼šè¢«å¼•å¯¼åˆ°ä¸€ä¸ªé™çº§é¡µé¢ã€‚</li>
</ul>
</li>
<li>è½¯çŠ¶æ€<br>  è½¯çŠ¶æ€æŒ‡å…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œå¹¶è®¤ä¸ºè¯¥ä¸­é—´çŠ¶æ€çš„å­˜åœ¨ä¸ä¼šå½±å“ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§ï¼Œå³å…è®¸ç³»ç»Ÿåœ¨ä¸åŒèŠ‚ç‚¹çš„æ•°æ®å‰¯æœ¬ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥çš„è¿‡ç¨‹å­˜åœ¨å»¶æ—¶ã€‚</li>
<li>æœ€ç»ˆä¸€è‡´æ€§<br>  æœ€ç»ˆä¸€è‡´æ€§å¼ºè°ƒçš„æ˜¯æ‰€æœ‰çš„æ•°æ®å‰¯æœ¬ï¼Œåœ¨ç»è¿‡ä¸€æ®µæ—¶é—´çš„åŒæ­¥ä¹‹åï¼Œæœ€ç»ˆéƒ½èƒ½å¤Ÿè¾¾åˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚å› æ­¤ï¼Œæœ€ç»ˆä¸€è‡´æ€§çš„æœ¬è´¨æ˜¯éœ€è¦ç³»ç»Ÿä¿è¯æœ€ç»ˆæ•°æ®èƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´ï¼Œè€Œä¸éœ€è¦å®æ—¶ä¿è¯ç³»ç»Ÿæ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚</li>
</ul>
<p>æ€»çš„æ¥è¯´ï¼ŒBASE ç†è®ºé¢å‘çš„æ˜¯å¤§å‹é«˜å¯ç”¨å¯æ‰©å±•çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå’Œä¼ ç»Ÿçš„äº‹ç‰© ACID ç‰¹æ€§æ˜¯ç›¸åçš„ï¼Œå®ƒå®Œå…¨ä¸åŒäº ACID çš„å¼ºä¸€è‡´æ€§æ¨¡å‹ï¼Œè€Œæ˜¯é€šè¿‡ç‰ºç‰²å¼ºä¸€è‡´æ€§æ¥è·å¾—å¯ç”¨æ€§ï¼Œå¹¶å…è®¸æ•°æ®åœ¨ä¸€æ®µæ—¶é—´å†…æ˜¯ä¸ä¸€è‡´çš„ï¼Œä½†æœ€ç»ˆè¾¾åˆ°ä¸€è‡´çŠ¶æ€ã€‚ä½†åŒæ—¶ï¼Œåœ¨å®é™…çš„åˆ†å¸ƒå¼åœºæ™¯ä¸­ï¼Œä¸åŒä¸šåŠ¡å•å…ƒå’Œç»„ä»¶å¯¹æ•°æ®ä¸€è‡´æ€§çš„è¦æ±‚æ˜¯ä¸åŒçš„ï¼Œå› æ­¤åœ¨å…·ä½“çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„è®¾è®¡è¿‡ç¨‹ä¸­ï¼ŒACID ç‰¹æ€§å’Œ BASE ç†è®ºå¾€å¾€åˆä¼šç»“åˆåœ¨ä¸€èµ·ã€‚</p>
<h2 id="æœåŠ¡æ²»ç†"><a href="#æœåŠ¡æ²»ç†" class="headerlink" title="æœåŠ¡æ²»ç†"></a>æœåŠ¡æ²»ç†</h2><p>æœåŠ¡æ²»ç†ä¸»è¦åŒ…æ‹¬:  </p>
<ul>
<li>æœåŠ¡æ³¨å†Œå‘ç°</li>
<li>é™æµ</li>
<li>ç›‘æ§</li>
<li>ç½‘å…³</li>
<li>è´Ÿè½½å‡è¡¡</li>
<li>æ—¥å¿—é‡‡é›†</li>
<li>é“¾è·¯è¿½è¸ª</li>
</ul>
<p>è¯¦ç»†å¦‚ä¸‹å›¾:<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/soa_governance_1.jpg" alt></p>
<h2 id="åˆ†å¸ƒå¼é”"><a href="#åˆ†å¸ƒå¼é”" class="headerlink" title="åˆ†å¸ƒå¼é”"></a>åˆ†å¸ƒå¼é”</h2><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/distributed_lock.jpg" alt></p>
<p>ä¸»è¦æœ‰:  </p>
<ul>
<li><a href="#åŸºäºetcdçš„åˆ†å¸ƒå¼é”">etcd/zookeeper(ä¸¥è°¨)</a></li>
<li><a href="#åŸºäºredisçš„åˆ†å¸ƒå¼é”">redis(é­åˆ°è´¨ç–‘, æé™æƒ…å†µæœ‰å¯èƒ½æœ‰é—®é¢˜, ä½†å› ä¸ºæ€§èƒ½è¾ƒé«˜ä¸”æé™æƒ…å†µä¸å®¹æ˜“å‘ç”Ÿ, ä¹Ÿæœ‰äººç”¨)</a></li>
</ul>
<h3 id="åˆ†å¸ƒå¼é”è¿‡æœŸæ—¶é—´åˆ°äº†ä½†ä¸šåŠ¡æ²¡æ‰§è¡Œå®Œæ€ä¹ˆåŠ"><a href="#åˆ†å¸ƒå¼é”è¿‡æœŸæ—¶é—´åˆ°äº†ä½†ä¸šåŠ¡æ²¡æ‰§è¡Œå®Œæ€ä¹ˆåŠ" class="headerlink" title="åˆ†å¸ƒå¼é”è¿‡æœŸæ—¶é—´åˆ°äº†ä½†ä¸šåŠ¡æ²¡æ‰§è¡Œå®Œæ€ä¹ˆåŠ"></a>åˆ†å¸ƒå¼é”è¿‡æœŸæ—¶é—´åˆ°äº†ä½†ä¸šåŠ¡æ²¡æ‰§è¡Œå®Œæ€ä¹ˆåŠ</h3><p>æ³¨å†Œä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”ä¸€å®šæ—¶é—´å°±å»å»¶é•¿é”è¶…æ—¶æ—¶é—´</p>
<h3 id="åŸºäºetcdçš„åˆ†å¸ƒå¼é”"><a href="#åŸºäºetcdçš„åˆ†å¸ƒå¼é”" class="headerlink" title="åŸºäºetcdçš„åˆ†å¸ƒå¼é”"></a>åŸºäºetcdçš„åˆ†å¸ƒå¼é”</h3><p>å› ä¸º etcd ä½¿ç”¨ Raft ç®—æ³•ä¿æŒäº†æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼ŒæŸæ¬¡æ“ä½œå­˜å‚¨åˆ°é›†ç¾¤ä¸­çš„å€¼å¿…ç„¶æ˜¯å…¨å±€ä¸€è‡´çš„ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å®ç°åˆ†å¸ƒå¼é”ã€‚é”æœåŠ¡æœ‰ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼Œä¸€æ˜¯ä¿æŒç‹¬å ï¼ŒäºŒæ˜¯æ§åˆ¶æ—¶åºã€‚  </p>
<p>ä¿æŒç‹¬å å³æ‰€æœ‰è·å–é”çš„ç”¨æˆ·æœ€ç»ˆåªæœ‰ä¸€ä¸ªå¯ä»¥å¾—åˆ°ã€‚etcd ä¸ºæ­¤æä¾›äº†ä¸€å¥—å®ç°åˆ†å¸ƒå¼é”åŸå­æ“ä½œ CASï¼ˆCompareAndSwapï¼‰çš„ APIã€‚é€šè¿‡è®¾ç½®prevExistå€¼ï¼Œå¯ä»¥ä¿è¯åœ¨å¤šä¸ªèŠ‚ç‚¹åŒæ—¶å»åˆ›å»ºæŸä¸ªç›®å½•æ—¶ï¼Œåªæœ‰ä¸€ä¸ªæˆåŠŸã€‚è€Œåˆ›å»ºæˆåŠŸçš„ç”¨æˆ·å°±å¯ä»¥è®¤ä¸ºæ˜¯è·å¾—äº†é”ã€‚</p>
<h3 id="åŸºäºredisçš„åˆ†å¸ƒå¼é”"><a href="#åŸºäºredisçš„åˆ†å¸ƒå¼é”" class="headerlink" title="åŸºäºredisçš„åˆ†å¸ƒå¼é”"></a>åŸºäºredisçš„åˆ†å¸ƒå¼é”</h3><ul>
<li>åˆ©ç”¨setnx+expireå‘½ä»¤ (é”™è¯¯çš„åšæ³•): setnxå’Œexpireæ˜¯åˆ†å¼€çš„ä¸¤æ­¥æ“ä½œï¼Œä¸å…·æœ‰åŸå­æ€§</li>
<li>ä½¿ç”¨Luaè„šæœ¬ï¼ˆåŒ…å«setnxå’Œexpireä¸¤æ¡æŒ‡ä»¤ï¼‰</li>
<li>ä½¿ç”¨ set key value [EX seconds][PX milliseconds][NX|XX] å‘½ä»¤ (<strong>æ­£ç¡®åšæ³•, æ¥ä¸‹æ¥ä»‹ç»è¿™ç§</strong>)</li>
</ul>
<p>Redis åœ¨ 2.6.12 ç‰ˆæœ¬å¼€å§‹ï¼Œä¸º SET å‘½ä»¤å¢åŠ ä¸€ç³»åˆ—é€‰é¡¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SET key value\[EX seconds\]\[PX milliseconds\]\[NX|XX\]</span><br></pre></td></tr></table></figure>
<ul>
<li>EX seconds: è®¾å®šè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’</li>
<li>PX milliseconds: è®¾å®šè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’</li>
<li>NX: ä»…å½“ key ä¸å­˜åœ¨æ—¶è®¾ç½®å€¼</li>
<li>XX: ä»…å½“ key å­˜åœ¨æ—¶è®¾ç½®å€¼</li>
</ul>
<p>value å¿…é¡»è¦å…·æœ‰å”¯ä¸€æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ UUID æ¥åšï¼Œè®¾ç½®éšæœºå­—ç¬¦ä¸²ä¿è¯å”¯ä¸€æ€§ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦ä¿è¯å”¯ä¸€æ€§ï¼Ÿå‡å¦‚ value ä¸æ˜¯éšæœºå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸€ä¸ªå›ºå®šå€¼ï¼Œé‚£ä¹ˆå°±å¯èƒ½å­˜åœ¨ä¸‹é¢çš„<strong>é—®é¢˜</strong>ï¼š</p>
<p>1. å®¢æˆ·ç«¯ 1 è·å–é”æˆåŠŸ<br>2. å®¢æˆ·ç«¯ 1 åœ¨æŸä¸ªæ“ä½œä¸Šé˜»å¡äº†å¤ªé•¿æ—¶é—´<br>3. è®¾ç½®çš„ key è¿‡æœŸäº†ï¼Œé”è‡ªåŠ¨é‡Šæ”¾äº†<br>4. å®¢æˆ·ç«¯ 2 è·å–åˆ°äº†å¯¹åº”åŒä¸€ä¸ªèµ„æºçš„é”<br>5. å®¢æˆ·ç«¯ 1 ä»é˜»å¡ä¸­æ¢å¤è¿‡æ¥ï¼Œå› ä¸º value å€¼ä¸€æ ·ï¼Œæ‰€ä»¥æ‰§è¡Œé‡Šæ”¾é”æ“ä½œæ—¶å°±ä¼šé‡Šæ”¾æ‰å®¢æˆ·ç«¯ 2 æŒæœ‰çš„é”ï¼Œè¿™æ ·å°±ä¼šé€ æˆé—®é¢˜</p>
<p>æ‰€ä»¥é€šå¸¸æ¥è¯´ï¼Œåœ¨<strong>é‡Šæ”¾é”</strong>æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ value è¿›è¡ŒéªŒè¯</p>
<p>é‡Šæ”¾é”æ—¶éœ€è¦éªŒè¯ value å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åœ¨è·å–é”çš„æ—¶å€™éœ€è¦è®¾ç½®ä¸€ä¸ª valueï¼Œä¸èƒ½ç›´æ¥ç”¨ del key è¿™ç§ç²—æš´çš„æ–¹å¼ï¼Œå› ä¸ºç›´æ¥ del key ä»»ä½•å®¢æˆ·ç«¯éƒ½å¯ä»¥è¿›è¡Œè§£é”äº†ï¼Œæ‰€ä»¥<strong>è§£é”æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­é”æ˜¯å¦æ˜¯è‡ªå·±çš„ï¼ŒåŸºäº value å€¼æ¥åˆ¤æ–­</strong>, è¿™é‡Œä½¿ç”¨ Lua è„šæœ¬çš„æ–¹å¼ï¼Œå°½é‡ä¿è¯åŸå­æ€§ã€‚</p>
<p><strong>è‡´å‘½ç¼ºé™·:</strong><br>ä½¿ç”¨ <code>set key value [EX seconds][PX milliseconds][NX|XX]</code> å‘½ä»¤ çœ‹ä¸Šå»å¾ˆ OKï¼Œå®é™…ä¸Šåœ¨æœ‰ Redis ä¸»ä»ç»“æ„çš„æ—¶å€™ä¹Ÿä¼šå‡ºç°é—®é¢˜ï¼Œæ¯”å¦‚è¯´ A å®¢æˆ·ç«¯åœ¨ Redis çš„ master èŠ‚ç‚¹ä¸Šæ‹¿åˆ°äº†é”ï¼Œä½†æ˜¯è¿™ä¸ªåŠ é”çš„ key è¿˜æ²¡æœ‰åŒæ­¥åˆ° slave èŠ‚ç‚¹ï¼Œmaster æ•…éšœï¼Œå‘ç”Ÿæ•…éšœè½¬ç§»ï¼Œä¸€ä¸ª slave èŠ‚ç‚¹å‡çº§ä¸º master èŠ‚ç‚¹ï¼ŒB å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥è·å–åŒä¸ª key çš„é”ï¼Œä½†å®¢æˆ·ç«¯ A ä¹Ÿå·²ç»æ‹¿åˆ°é”äº†ï¼Œè¿™å°±å¯¼è‡´å¤šä¸ªå®¢æˆ·ç«¯éƒ½æ‹¿åˆ°é”ã€‚</p>
<h4 id="RedLock"><a href="#RedLock" class="headerlink" title="RedLock"></a>RedLock</h4><p>å‚è€ƒ: <a href="https://zhuanlan.zhihu.com/p/100140241#RedLock" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/100140241#RedLock</a></p>
<p>ä½¿ç”¨äº†å¤šä¸ª Redis å®ä¾‹æ¥å®ç°åˆ†å¸ƒå¼é”ï¼Œè¿™æ˜¯ä¸ºäº†ä¿è¯åœ¨å‘ç”Ÿå•ç‚¹æ•…éšœæ—¶ä»ç„¶å¯ç”¨ã€‚</p>
<ul>
<li>å°è¯•ä» N ä¸ªäº’ç›¸ç‹¬ç«‹ Redis å®ä¾‹è·å–é”ï¼›</li>
<li>è®¡ç®—è·å–é”æ¶ˆè€—çš„æ—¶é—´ï¼Œåªæœ‰æ—¶é—´å°äºé”çš„è¿‡æœŸæ—¶é—´ï¼Œå¹¶ä¸”ä»å¤§å¤šæ•°ï¼ˆN / 2 + 1ï¼‰å®ä¾‹ä¸Šè·å–äº†é”ï¼Œæ‰è®¤ä¸ºè·å–é”æˆåŠŸï¼›</li>
<li>å¦‚æœè·å–é”å¤±è´¥ï¼Œå°±åˆ°æ¯ä¸ªå®ä¾‹ä¸Šé‡Šæ”¾é”</li>
</ul>
<h3 id="åˆ†å¸ƒå¼é”çš„é«˜å¹¶å‘ä¼˜åŒ–"><a href="#åˆ†å¸ƒå¼é”çš„é«˜å¹¶å‘ä¼˜åŒ–" class="headerlink" title="åˆ†å¸ƒå¼é”çš„é«˜å¹¶å‘ä¼˜åŒ–"></a>åˆ†å¸ƒå¼é”çš„é«˜å¹¶å‘ä¼˜åŒ–</h3><p>å…ˆè¯´ä¸€ä¸ª<strong>è¶…å–é—®é¢˜çš„æƒ…æ™¯</strong>, å‡è®¾è®¢å•ç³»ç»Ÿéƒ¨ç½²ä¸¤å°æœºå™¨ä¸Šï¼Œä¸åŒçš„ç”¨æˆ·éƒ½è¦åŒæ—¶ä¹°10å°iphoneï¼Œåˆ†åˆ«å‘äº†ä¸€ä¸ªè¯·æ±‚ç»™è®¢å•ç³»ç»Ÿã€‚<br>æ¥ç€æ¯ä¸ªè®¢å•ç³»ç»Ÿå®ä¾‹éƒ½å»æ•°æ®åº“é‡ŒæŸ¥äº†ä¸€ä¸‹ï¼Œå½“å‰iphoneåº“å­˜æ˜¯12å°ã€‚<br>ä¿©å¤§å…„å¼Ÿä¸€çœ‹ï¼Œä¹äº†ï¼Œ12å°åº“å­˜å¤§äºäº†è¦ä¹°çš„10å°æ•°é‡å•Šï¼<br>äºæ˜¯ä¹ï¼Œæ¯ä¸ªè®¢å•ç³»ç»Ÿå®ä¾‹éƒ½å‘é€SQLåˆ°æ•°æ®åº“é‡Œä¸‹å•ï¼Œç„¶åæ‰£å‡äº†10ä¸ªåº“å­˜ï¼Œå…¶ä¸­ä¸€ä¸ªå°†åº“å­˜ä»12å°æ‰£å‡ä¸º2å°ï¼Œå¦å¤–ä¸€ä¸ªå°†åº“å­˜ä»2å°æ‰£å‡ä¸º-8å°ã€‚<br>ç°åœ¨å®Œäº†ï¼Œåº“å­˜å‡ºç°äº†è´Ÿæ•°ï¼æ³ªå¥”å•Šï¼Œæ²¡æœ‰20å°iphoneå‘ç»™ä¸¤ä¸ªç”¨æˆ·å•Šï¼è¿™å¯å¦‚ä½•æ˜¯å¥½ã€‚</p>
<p><strong>ç”¨åˆ†å¸ƒå¼é”å¦‚ä½•è§£å†³åº“å­˜è¶…å–é—®é¢˜:</strong>  åªæœ‰ä¸€ä¸ªè®¢å•ç³»ç»Ÿå®ä¾‹å¯ä»¥æˆåŠŸåŠ åˆ†å¸ƒå¼é”ï¼Œç„¶ååªæœ‰ä»–ä¸€ä¸ªå®ä¾‹å¯ä»¥æŸ¥åº“å­˜ã€åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ã€ä¸‹å•æ‰£å‡åº“å­˜ï¼Œæ¥ç€é‡Šæ”¾é”ã€‚<br>é‡Šæ”¾é”ä¹‹åï¼Œå¦å¤–ä¸€ä¸ªè®¢å•ç³»ç»Ÿå®ä¾‹æ‰èƒ½åŠ é”ï¼Œæ¥ç€æŸ¥åº“å­˜ï¼Œä¸€ä¸‹å‘ç°åº“å­˜åªæœ‰2å°äº†ï¼Œåº“å­˜ä¸è¶³ï¼Œæ— æ³•è´­ä¹°ï¼Œä¸‹å•å¤±è´¥ã€‚ä¸ä¼šå°†åº“å­˜æ‰£å‡ä¸º-8çš„ã€‚</p>
<p><strong>åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</strong> åˆ†å¸ƒå¼é”ä¸€æ—¦åŠ äº†ä¹‹åï¼Œå¯¹åŒä¸€ä¸ªå•†å“çš„ä¸‹å•è¯·æ±‚ï¼Œä¼šå¯¼è‡´æ‰€æœ‰å®¢æˆ·ç«¯éƒ½å¿…é¡»å¯¹åŒä¸€ä¸ªå•†å“çš„åº“å­˜é”keyè¿›è¡ŒåŠ é”ã€‚æ¯”å¦‚ï¼Œå¯¹iphoneè¿™ä¸ªå•†å“çš„ä¸‹å•ï¼Œéƒ½å¿…å¯¹â€œiphone_stockâ€è¿™ä¸ªé”keyæ¥åŠ é”ã€‚è¿™æ ·ä¼šå¯¼è‡´å¯¹åŒä¸€ä¸ªå•†å“çš„ä¸‹å•è¯·æ±‚ï¼Œå°±å¿…é¡»ä¸²è¡ŒåŒ–ï¼Œä¸€ä¸ªæ¥ä¸€ä¸ªçš„å¤„ç†,<br>å‡è®¾åŠ é”ä¹‹åï¼Œé‡Šæ”¾é”ä¹‹å‰ï¼ŒæŸ¥åº“å­˜ -&gt; åˆ›å»ºè®¢å• -&gt; æ‰£å‡åº“å­˜ï¼Œè¿™ä¸ªè¿‡ç¨‹æ€§èƒ½å¾ˆé«˜å§ï¼Œç®—ä»–å…¨è¿‡ç¨‹20æ¯«ç§’ï¼Œè¿™åº”è¯¥ä¸é”™äº†ã€‚é‚£ä¹ˆ1ç§’æ˜¯1000æ¯«ç§’ï¼Œåªèƒ½å®¹çº³50ä¸ªå¯¹è¿™ä¸ªå•†å“çš„è¯·æ±‚ä¾æ¬¡ä¸²è¡Œå®Œæˆå¤„ç†ã€‚<strong>æ•ˆç‡ä½ä¸‹</strong>.</p>
<p><strong>å‡å¦‚ä¸‹å•æ—¶ï¼Œç”¨åˆ†å¸ƒå¼é”æ¥é˜²æ­¢åº“å­˜è¶…å–ï¼Œä½†æ˜¯æ˜¯æ¯ç§’ä¸Šåƒè®¢å•çš„é«˜å¹¶å‘åœºæ™¯ï¼Œå¦‚ä½•å¯¹åˆ†å¸ƒå¼é”è¿›è¡Œé«˜å¹¶å‘ä¼˜åŒ–æ¥åº”å¯¹è¿™ä¸ªåœºæ™¯ï¼Ÿ</strong><br><strong>è§£å†³æ–¹æ¡ˆ: åˆ†æ®µåŠ é”</strong></p>
<p>å…¶å®è¯´å‡ºæ¥ä¹Ÿå¾ˆç®€å•ï¼Œç›¸ä¿¡å¾ˆå¤šäººçœ‹è¿‡javaé‡Œçš„ConcurrentHashMapçš„æºç å’Œåº•å±‚åŸç†ï¼Œåº”è¯¥çŸ¥é“é‡Œé¢çš„æ ¸å¿ƒæ€è·¯ï¼Œå°±æ˜¯åˆ†æ®µåŠ é”ï¼</p>
<blockquote>
<p>åœ¨æŸäº›æƒ…å†µä¸‹æˆ‘ä»¬å¯ä»¥å°†é”åˆ†è§£æŠ€æœ¯è¿›ä¸€æ­¥æ‰©å±•ä¸ºä¸€ç»„ç‹¬ç«‹å¯¹è±¡ä¸Šçš„é”è¿›è¡Œåˆ†è§£ï¼Œè¿™æˆä¸ºåˆ†æ®µé”ã€‚å…¶å®è¯´çš„ç®€å•ä¸€ç‚¹å°±æ˜¯ï¼šå®¹å™¨é‡Œæœ‰å¤šæŠŠé”ï¼Œæ¯ä¸€æŠŠé”ç”¨äºé”å®¹å™¨å…¶ä¸­ä¸€éƒ¨åˆ†æ•°æ®ï¼Œé‚£ä¹ˆå½“å¤šçº¿ç¨‹è®¿é—®å®¹å™¨é‡Œä¸åŒæ•°æ®æ®µçš„æ•°æ®æ—¶ï¼Œçº¿ç¨‹é—´å°±ä¸ä¼šå­˜åœ¨é”ç«äº‰ï¼Œä»è€Œå¯ä»¥æœ‰æ•ˆçš„æé«˜å¹¶å‘è®¿é—®æ•ˆç‡ï¼Œè¿™å°±æ˜¯ConcurrentHashMapæ‰€ä½¿ç”¨çš„é”åˆ†æ®µæŠ€æœ¯ï¼Œé¦–å…ˆå°†æ•°æ®åˆ†æˆä¸€æ®µä¸€æ®µçš„å­˜å‚¨ï¼Œç„¶åç»™æ¯ä¸€æ®µæ•°æ®é…ä¸€æŠŠé”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å ç”¨é”è®¿é—®å…¶ä¸­ä¸€ä¸ªæ®µæ•°æ®çš„æ—¶å€™ï¼Œå…¶ä»–æ®µçš„æ•°æ®ä¹Ÿèƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ã€‚</p>
<p>æ¯”å¦‚ï¼šåœ¨ConcurrentHashMapä¸­ä½¿ç”¨äº†ä¸€ä¸ªåŒ…å«16ä¸ªé”çš„æ•°ç»„ï¼Œæ¯ä¸ªé”ä¿æŠ¤æ‰€æœ‰æ•£åˆ—æ¡¶çš„1/16ï¼Œå…¶ä¸­ç¬¬Nä¸ªæ•£åˆ—æ¡¶ç”±ç¬¬ï¼ˆN mod 16ï¼‰ä¸ªé”æ¥ä¿æŠ¤ã€‚å‡è®¾ä½¿ç”¨åˆç†çš„æ•£åˆ—ç®—æ³•ä½¿å…³é”®å­—èƒ½å¤Ÿå‡åŒ€çš„åˆ†éƒ¨ï¼Œé‚£ä¹ˆè¿™å¤§çº¦èƒ½ä½¿å¯¹é”çš„è¯·æ±‚å‡å°‘åˆ°è¶Šæ¥çš„1/16ã€‚ä¹Ÿæ­£æ˜¯è¿™é¡¹æŠ€æœ¯ä½¿å¾—ConcurrentHashMapæ”¯æŒå¤šè¾¾16ä¸ªå¹¶å‘çš„å†™å…¥çº¿ç¨‹ã€‚</p>
</blockquote>
<p>å‡å¦‚ä½ ç°åœ¨iphoneæœ‰1000ä¸ªåº“å­˜ï¼Œé‚£ä¹ˆä½ å®Œå…¨å¯ä»¥ç»™æ‹†æˆ20ä¸ªåº“å­˜æ®µï¼Œè¦æ˜¯ä½ æ„¿æ„ï¼Œå¯ä»¥åœ¨æ•°æ®åº“çš„è¡¨é‡Œå»º20ä¸ªåº“å­˜å­—æ®µï¼Œæ¯”å¦‚stock_01ï¼Œstock_02ï¼Œç±»ä¼¼è¿™æ ·çš„ï¼Œä¹Ÿå¯ä»¥åœ¨redisä¹‹ç±»çš„åœ°æ–¹æ”¾20ä¸ªåº“å­˜keyã€‚<br>æ€»ä¹‹ï¼Œå°±æ˜¯æŠŠä½ çš„1000ä»¶åº“å­˜ç»™ä»–æ‹†å¼€ï¼Œæ¯ä¸ªåº“å­˜æ®µæ˜¯50ä»¶åº“å­˜ï¼Œæ¯”å¦‚stock_01å¯¹åº”50ä»¶åº“å­˜ï¼Œstock_02å¯¹åº”50ä»¶åº“å­˜ã€‚<br>æ¥ç€ï¼Œæ¯ç§’1000ä¸ªè¯·æ±‚è¿‡æ¥äº†ï¼Œå¥½ï¼æ­¤æ—¶å…¶å®å¯ä»¥æ˜¯è‡ªå·±å†™ä¸€ä¸ªç®€å•çš„éšæœºç®—æ³•ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æ˜¯éšæœºåœ¨20ä¸ªåˆ†æ®µåº“å­˜é‡Œï¼Œé€‰æ‹©ä¸€ä¸ªè¿›è¡ŒåŠ é”ã€‚<br>è¿™æ ·å°±å¥½äº†ï¼ŒåŒæ—¶å¯ä»¥æœ‰æœ€å¤š20ä¸ªä¸‹å•è¯·æ±‚ä¸€èµ·æ‰§è¡Œï¼Œæ¯ä¸ªä¸‹å•è¯·æ±‚é”äº†ä¸€ä¸ªåº“å­˜åˆ†æ®µï¼Œç„¶ååœ¨ä¸šåŠ¡é€»è¾‘é‡Œé¢ï¼Œå°±å¯¹æ•°æ®åº“æˆ–è€…æ˜¯Redisä¸­çš„é‚£ä¸ªåˆ†æ®µåº“å­˜è¿›è¡Œæ“ä½œå³å¯ï¼ŒåŒ…æ‹¬æŸ¥åº“å­˜ -&gt; åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ -&gt; æ‰£å‡åº“å­˜ã€‚</p>
<p><strong>æœ‰ä¸€ä¸ªå‘å¤§å®¶ä¸€å®šè¦æ³¨æ„</strong>ï¼šå¦‚æœæŸä¸ªä¸‹å•è¯·æ±‚ï¼Œå’”åš“åŠ é”ï¼Œç„¶åå‘ç°è¿™ä¸ªåˆ†æ®µåº“å­˜é‡Œçš„åº“å­˜ä¸è¶³äº†ï¼Œæ­¤æ—¶å’‹åŠï¼Ÿ<br>è¿™æ—¶ä½ å¾—è‡ªåŠ¨é‡Šæ”¾é”ï¼Œç„¶åç«‹é©¬æ¢ä¸‹ä¸€ä¸ªåˆ†æ®µåº“å­˜ï¼Œå†æ¬¡å°è¯•åŠ é”åå°è¯•å¤„ç†ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸€å®šè¦å®ç°ã€‚</p>
<h2 id="åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ-æœ¬æ–‡è¿™äº›éƒ½ä¸å¥½-ç°åœ¨ä¸€èˆ¬ç”¨Saga"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ-æœ¬æ–‡è¿™äº›éƒ½ä¸å¥½-ç°åœ¨ä¸€èˆ¬ç”¨Saga" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ(æœ¬æ–‡è¿™äº›éƒ½ä¸å¥½, ç°åœ¨ä¸€èˆ¬ç”¨Saga)"></a>åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ(æœ¬æ–‡è¿™äº›éƒ½ä¸å¥½, ç°åœ¨ä¸€èˆ¬ç”¨Saga)</h2><p>å‚è€ƒ:  </p>
<ul>
<li><a href="https://www.cnblogs.com/mayundalao/p/11798502.html" target="_blank" rel="noopener">https://www.cnblogs.com/mayundalao/p/11798502.html</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/88226625" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/88226625</a></li>
<li><a href="https://xiaomi-info.github.io/2020/01/02/distributed-transaction/" target="_blank" rel="noopener">https://xiaomi-info.github.io/2020/01/02/distributed-transaction/</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/183753774" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/183753774</a></li>
</ul>
<p>äº‹åŠ¡æœ‰ä¸¤ç§:  </p>
<ul>
<li><strong>åˆšæ€§äº‹åŠ¡</strong>ï¼šéµå¾ªACIDåŸåˆ™ï¼Œå¼ºä¸€è‡´æ€§ã€‚</li>
<li><strong>æŸ”æ€§äº‹åŠ¡</strong>ï¼šéµå¾ªBASEç†è®ºï¼Œæœ€ç»ˆä¸€è‡´æ€§ï¼›ä¸åˆšæ€§äº‹åŠ¡ä¸åŒï¼ŒæŸ”æ€§äº‹åŠ¡å…è®¸ä¸€å®šæ—¶é—´å†…ï¼Œä¸åŒèŠ‚ç‚¹çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä½†è¦æ±‚æœ€ç»ˆä¸€è‡´ã€‚</li>
</ul>
<h3 id="äºŒé˜¶æ®µæäº¤2PC"><a href="#äºŒé˜¶æ®µæäº¤2PC" class="headerlink" title="äºŒé˜¶æ®µæäº¤2PC"></a>äºŒé˜¶æ®µæäº¤2PC</h3><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/transaction/XA-first.jpg" alt><br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/transaction/XA-second.jpg" alt></p>
<p>å¤§è‡´çš„æµç¨‹ï¼š</p>
<ul>
<li>ç¬¬ä¸€é˜¶æ®µï¼ˆprepareï¼‰ï¼šäº‹åŠ¡ç®¡ç†å™¨å‘æ‰€æœ‰æœ¬åœ°èµ„æºç®¡ç†å™¨å‘èµ·è¯·æ±‚ï¼Œè¯¢é—®æ˜¯å¦æ˜¯ ready çŠ¶æ€ï¼Œæ‰€æœ‰å‚ä¸è€…éƒ½å°†æœ¬äº‹åŠ¡èƒ½å¦æˆåŠŸçš„ä¿¡æ¯åé¦ˆå‘ç»™åè°ƒè€…ï¼›  </li>
<li>ç¬¬äºŒé˜¶æ®µ (commit/rollback)ï¼šäº‹åŠ¡ç®¡ç†å™¨æ ¹æ®æ‰€æœ‰æœ¬åœ°èµ„æºç®¡ç†å™¨çš„åé¦ˆï¼Œé€šçŸ¥æ‰€æœ‰æœ¬åœ°èµ„æºç®¡ç†å™¨ï¼Œæ­¥è°ƒä¸€è‡´åœ°åœ¨æ‰€æœ‰åˆ†æ”¯ä¸Šæäº¤æˆ–è€…å›æ»šã€‚</li>
</ul>
<p><strong>ç¼ºç‚¹:</strong>  </p>
<ul>
<li>åŒæ­¥é˜»å¡ï¼šå½“å‚ä¸äº‹åŠ¡è€…å­˜åœ¨å ç”¨å…¬å…±èµ„æºçš„æƒ…å†µï¼Œå…¶ä¸­ä¸€ä¸ªå ç”¨äº†èµ„æºï¼Œå…¶ä»–äº‹åŠ¡å‚ä¸è€…å°±åªèƒ½é˜»å¡ç­‰å¾…èµ„æºé‡Šæ”¾ï¼Œå¤„äºé˜»å¡çŠ¶æ€ã€‚</li>
<li>å•ç‚¹æ•…éšœï¼šä¸€æ—¦äº‹åŠ¡ç®¡ç†å™¨å‡ºç°æ•…éšœï¼Œæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨</li>
<li>æ•°æ®ä¸ä¸€è‡´ï¼šåœ¨é˜¶æ®µäºŒï¼Œå¦‚æœäº‹åŠ¡ç®¡ç†å™¨åªå‘é€äº†éƒ¨åˆ† commit æ¶ˆæ¯ï¼Œæ­¤æ—¶ç½‘ç»œå‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆåªæœ‰éƒ¨åˆ†å‚ä¸è€…æ¥æ”¶åˆ° commit æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰éƒ¨åˆ†å‚ä¸è€…æäº¤äº†äº‹åŠ¡ï¼Œä½¿å¾—ç³»ç»Ÿæ•°æ®ä¸ä¸€è‡´ã€‚</li>
<li>ä¸ç¡®å®šæ€§ï¼šå½“åäº‹åŠ¡ç®¡ç†å™¨å‘é€ commit ä¹‹åï¼Œå¹¶ä¸”æ­¤æ—¶åªæœ‰ä¸€ä¸ªå‚ä¸è€…æ”¶åˆ°äº† commitï¼Œé‚£ä¹ˆå½“è¯¥å‚ä¸è€…ä¸äº‹åŠ¡ç®¡ç†å™¨åŒæ—¶å®•æœºä¹‹åï¼Œé‡æ–°é€‰ä¸¾çš„äº‹åŠ¡ç®¡ç†å™¨æ— æ³•ç¡®å®šè¯¥æ¡æ¶ˆæ¯æ˜¯å¦æäº¤æˆåŠŸã€‚</li>
</ul>
<p><strong>å®æˆ˜:</strong><br>ç›®å‰æ”¯ä»˜å®ä½¿ç”¨ä¸¤é˜¶æ®µæäº¤æ€æƒ³å®ç°äº†åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ (Distributed Transaction Service, DTS) ï¼Œå®ƒæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼Œç”¨æ¥ä¿éšœåœ¨å¤§è§„æ¨¡åˆ†å¸ƒå¼ç¯å¢ƒä¸‹äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚å…·ä½“å¯å‚è€ƒæ”¯ä»˜å®å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://tech.antfin.com/docs/2/46887" target="_blank" rel="noopener">https://tech.antfin.com/docs/2/46887</a></p>
<h3 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a>TCC</h3><p>å…³äº TCCï¼ˆTry-Confirm-Cancelï¼‰çš„æ¦‚å¿µï¼Œæœ€æ—©æ˜¯ç”± Pat Helland äº 2007 å¹´å‘è¡¨çš„ä¸€ç¯‡åä¸ºã€ŠLife beyond Distributed Transactions:an Apostateâ€™s Opinionã€‹çš„è®ºæ–‡æå‡ºã€‚ TCC äº‹åŠ¡æœºåˆ¶ç›¸æ¯”äºä¸Šé¢ä»‹ç»çš„ XAï¼Œè§£å†³äº†å…¶å‡ ä¸ªç¼ºç‚¹ï¼š</p>
<ul>
<li>è§£å†³äº†åè°ƒè€…å•ç‚¹ï¼Œç”±ä¸»ä¸šåŠ¡æ–¹å‘èµ·å¹¶å®Œæˆè¿™ä¸ªä¸šåŠ¡æ´»åŠ¨ã€‚ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨ä¹Ÿå˜æˆå¤šç‚¹ï¼Œå¼•å…¥é›†ç¾¤ã€‚</li>
<li>åŒæ­¥é˜»å¡ï¼šå¼•å…¥è¶…æ—¶ï¼Œè¶…æ—¶åè¿›è¡Œè¡¥å¿ï¼Œå¹¶ä¸”ä¸ä¼šé”å®šæ•´ä¸ªèµ„æºï¼Œå°†èµ„æºè½¬æ¢ä¸ºä¸šåŠ¡é€»è¾‘å½¢å¼ï¼Œç²’åº¦å˜å°ã€‚</li>
<li>æ•°æ®ä¸€è‡´æ€§ï¼Œæœ‰äº†è¡¥å¿æœºåˆ¶ä¹‹åï¼Œç”±ä¸šåŠ¡æ´»åŠ¨ç®¡ç†å™¨æ§åˆ¶ä¸€è‡´æ€§</li>
</ul>
<p>TCC(Try Confirm Cancel)  </p>
<ol>
<li>Try é˜¶æ®µï¼šå°è¯•æ‰§è¡Œï¼Œå®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥ï¼ˆä¸€è‡´æ€§ï¼‰, é¢„ç•™å¿…é¡»ä¸šåŠ¡èµ„æºï¼ˆå‡†éš”ç¦»æ€§ï¼‰  </li>
<li>Confirm é˜¶æ®µï¼šç¡®è®¤æ‰§è¡ŒçœŸæ­£æ‰§è¡Œä¸šåŠ¡ï¼Œä¸ä½œä»»ä½•ä¸šåŠ¡æ£€æŸ¥ï¼Œåªä½¿ç”¨ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºï¼ŒConfirm æ“ä½œæ»¡è¶³å¹‚ç­‰æ€§ã€‚è¦æ±‚å…·å¤‡å¹‚ç­‰è®¾è®¡ï¼ŒConfirm å¤±è´¥åéœ€è¦è¿›è¡Œé‡è¯•ã€‚  </li>
<li>Cancel é˜¶æ®µï¼šå–æ¶ˆæ‰§è¡Œï¼Œé‡Šæ”¾ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æº Cancel æ“ä½œæ»¡è¶³å¹‚ç­‰æ€§ Cancel é˜¶æ®µçš„å¼‚å¸¸å’Œ Confirm é˜¶æ®µå¼‚å¸¸å¤„ç†æ–¹æ¡ˆåŸºæœ¬ä¸Šä¸€è‡´ã€‚</li>
</ol>
<p>åœ¨ Try é˜¶æ®µï¼Œæ˜¯å¯¹ä¸šåŠ¡ç³»ç»Ÿè¿›è¡Œæ£€æŸ¥åŠèµ„æºé¢„è§ˆï¼Œæ¯”å¦‚è®¢å•å’Œå­˜å‚¨æ“ä½œï¼Œéœ€è¦æ£€æŸ¥åº“å­˜å‰©ä½™æ•°é‡æ˜¯å¦å¤Ÿç”¨ï¼Œå¹¶è¿›è¡Œé¢„ç•™ï¼Œé¢„ç•™æ“ä½œçš„è¯å°±æ˜¯æ–°å»ºä¸€ä¸ªå¯ç”¨åº“å­˜æ•°é‡å­—æ®µï¼ŒTry é˜¶æ®µæ“ä½œæ˜¯å¯¹è¿™ä¸ªå¯ç”¨åº“å­˜æ•°é‡è¿›è¡Œæ“ä½œã€‚<br>åŸºäº TCC å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¼šå°†åŸæ¥åªéœ€è¦ä¸€ä¸ªæ¥å£å°±å¯ä»¥å®ç°çš„é€»è¾‘æ‹†åˆ†ä¸º Tryã€Confirmã€Cancel ä¸‰ä¸ªæ¥å£ï¼Œæ‰€ä»¥ä»£ç å®ç°å¤æ‚åº¦ç›¸å¯¹è¾ƒé«˜ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/transaction/tcc.jpg" alt></p>
<p><strong>ç¼ºç‚¹:</strong><br>TCC éœ€è¦äº‹åŠ¡æ¥å£æä¾› try, confirm, cancel ä¸‰ä¸ªæ¥å£ï¼Œæé«˜äº†ç¼–ç¨‹çš„å¤æ‚æ€§ã€‚ä¾èµ–äºä¸šåŠ¡æ–¹æ¥é…åˆæä¾›è¿™æ ·çš„æ¥å£ï¼Œæ¨è¡Œéš¾åº¦å¤§ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸æ¨èä½¿ç”¨è¿™ç§æ–¹å¼ã€‚</p>
<p><strong>å®æˆ˜:</strong><br>ä¸€èˆ¬æ¥è¯´å’Œé’±ç›¸å…³çš„æ”¯ä»˜ã€äº¤æ˜“ç­‰ç›¸å…³çš„åœºæ™¯ï¼Œä¹Ÿå¯ä»¥ç”¨TCCï¼Œä¸¥æ ¼ä¸¥æ ¼ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨è‡ªåŠ¨å›æ»šï¼Œä¸¥æ ¼ä¿è¯èµ„é‡‘çš„æ­£ç¡®æ€§!</p>
<h3 id="æœ¬åœ°æ¶ˆæ¯è¡¨"><a href="#æœ¬åœ°æ¶ˆæ¯è¡¨" class="headerlink" title="æœ¬åœ°æ¶ˆæ¯è¡¨"></a>æœ¬åœ°æ¶ˆæ¯è¡¨</h3><p>æœ¬åœ°æ¶ˆæ¯è¡¨è¿™ä¸ªæ–¹æ¡ˆæœ€åˆæ˜¯ ebay æ¶æ„å¸ˆ Dan Pritchett åœ¨ 2008 å¹´å‘è¡¨ç»™ ACM çš„æ–‡ç« ã€‚è¯¥æ–¹æ¡ˆä¸­ä¼šæœ‰æ¶ˆæ¯ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ä¸¤ä¸ªè§’è‰²ï¼Œå‡è®¾ç³»ç»Ÿ A æ˜¯æ¶ˆæ¯ç”Ÿäº§è€…ï¼Œç³»ç»Ÿ B æ˜¯æ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œå…¶å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/transaction/native-message.jpg" alt></p>
<ol>
<li>å½“ç³»ç»Ÿ A è¢«å…¶ä»–ç³»ç»Ÿè°ƒç”¨å‘ç”Ÿæ•°æ®åº“è¡¨æ›´æ“ä½œï¼Œé¦–å…ˆä¼šæ›´æ–°æ•°æ®åº“çš„ä¸šåŠ¡è¡¨ï¼Œå…¶æ¬¡ä¼šå¾€ç›¸åŒæ•°æ®åº“çš„æ¶ˆæ¯è¡¨ä¸­æ’å…¥ä¸€æ¡æ•°æ®ï¼Œä¸¤ä¸ªæ“ä½œå‘ç”Ÿåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­, å¦‚æœæœ¬æ­¥éª¤å‘ç”Ÿæ“ä½œå¤±è´¥, åˆ™ç›´æ¥äº‹åŠ¡å›æ»š</li>
<li>ç³»ç»Ÿ A çš„è„šæœ¬å®šæœŸè½®è¯¢æœ¬åœ°æ¶ˆæ¯å¾€ mq ä¸­å†™å…¥ä¸€æ¡æ¶ˆæ¯ï¼Œå¦‚æœæ¶ˆæ¯å‘é€å¤±è´¥ä¼šè¿›è¡Œé‡è¯•</li>
<li>ç³»ç»Ÿ B æ¶ˆè´¹ mq ä¸­çš„æ¶ˆæ¯ï¼Œå¹¶å¤„ç†ä¸šåŠ¡é€»è¾‘ã€‚å¦‚æœæœ¬åœ°äº‹åŠ¡å¤„ç†å¤±è´¥ï¼Œä¼šåœ¨ç»§ç»­æ¶ˆè´¹ mq ä¸­çš„æ¶ˆæ¯è¿›è¡Œé‡è¯•ï¼Œå¦‚æœä¸šåŠ¡ä¸Šçš„å¤±è´¥ï¼Œå¯ä»¥é€šçŸ¥ç³»ç»Ÿ A è¿›è¡Œå›æ»šæ“ä½œ</li>
</ol>
<p>æœ¬åœ°æ¶ˆæ¯è¡¨å®ç°çš„æ¡ä»¶ï¼š</p>
<ul>
<li>æ¶ˆè´¹è€…ä¸ç”Ÿæˆè€…çš„æ¥å£éƒ½è¦æ”¯æŒå¹‚ç­‰</li>
<li>ç”Ÿäº§è€…éœ€è¦é¢å¤–çš„åˆ›å»ºæ¶ˆæ¯è¡¨</li>
<li>éœ€è¦æä¾›è¡¥å¿é€»è¾‘ï¼Œå¦‚æœæ¶ˆè´¹è€…ä¸šåŠ¡å¤±è´¥ï¼Œéœ€è¦ç”Ÿäº§è€…æ”¯æŒå›æ»šæ“ä½œ</li>
</ul>
<p>æ­¤æ–¹æ¡ˆçš„æ ¸å¿ƒæ˜¯å°†éœ€è¦åˆ†å¸ƒå¼å¤„ç†çš„ä»»åŠ¡é€šè¿‡æ¶ˆæ¯æ—¥å¿—çš„æ–¹å¼æ¥å¼‚æ­¥æ‰§è¡Œã€‚æ¶ˆæ¯æ—¥å¿—å¯ä»¥å­˜å‚¨åˆ°æœ¬åœ°æ–‡æœ¬ã€æ•°æ®åº“æˆ–æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå†é€šè¿‡ä¸šåŠ¡è§„åˆ™è‡ªåŠ¨æˆ–äººå·¥å‘èµ·é‡è¯•ã€‚äººå·¥é‡è¯•æ›´å¤šçš„æ˜¯åº”ç”¨äºæ”¯ä»˜åœºæ™¯ï¼Œé€šè¿‡å¯¹è´¦ç³»ç»Ÿå¯¹äº‹åé—®é¢˜çš„å¤„ç†ã€‚</p>
<p><strong>ç¼ºç‚¹:</strong><br>æœ€å¤§çš„é—®é¢˜å°±åœ¨äºä¸¥é‡ä¾èµ–äºæ•°æ®åº“çš„æ¶ˆæ¯è¡¨æ¥ç®¡ç†äº‹åŠ¡,è¿™ä¸ªä¼šå¯¼è‡´é«˜å¹¶å‘åœºæ™¯æ— åŠ›,éš¾ä»¥æ‰©å±•,ä¸€èˆ¬å¾ˆå°‘ç”¨</p>
<p><strong>å®æˆ˜:</strong><br>è·¨è¡Œè½¬è´¦å¯é€šè¿‡è¯¥æ–¹æ¡ˆå®ç°ã€‚<br>ç”¨æˆ· A å‘ç”¨æˆ· B å‘èµ·è½¬è´¦ï¼Œé¦–å…ˆç³»ç»Ÿä¼šæ‰£æ‰ç”¨æˆ· A è´¦æˆ·ä¸­çš„é‡‘é¢ï¼Œå°†è¯¥è½¬è´¦æ¶ˆæ¯å†™å…¥æ¶ˆæ¯è¡¨ä¸­ï¼Œå¦‚æœäº‹åŠ¡æ‰§è¡Œå¤±è´¥åˆ™è½¬è´¦å¤±è´¥ï¼Œå¦‚æœè½¬è´¦æˆåŠŸï¼Œç³»ç»Ÿä¸­ä¼šæœ‰å®šæ—¶è½®è¯¢æ¶ˆæ¯è¡¨ï¼Œå¾€ mq ä¸­å†™å…¥è½¬è´¦æ¶ˆæ¯ï¼Œå¤±è´¥é‡è¯•ã€‚mq æ¶ˆæ¯ä¼šè¢«å®æ—¶æ¶ˆè´¹å¹¶å¾€ç”¨æˆ· B ä¸­è´¦æˆ·å¢åŠ è½¬è´¦é‡‘é¢ï¼Œæ‰§è¡Œå¤±è´¥ä¼šä¸æ–­é‡è¯•ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/transaction/bank-transfer.jpg" alt></p>
<p>å°ç±³æµ·å¤–å•†åŸç”¨æˆ·è®¢å•æ•°æ®çŠ¶æ€å˜æ›´ï¼Œä¼šå°†å˜æ›´çŠ¶æ€è®°å½•æ¶ˆæ¯è¡¨ä¸­ï¼Œè„šæœ¬å°†è®¢å•çŠ¶æ€æ¶ˆæ¯å†™å…¥ mqï¼Œæœ€ç»ˆæ¶ˆè´¹ mq ç»™ç”¨æˆ·å‘é€é‚®ä»¶ã€çŸ­ä¿¡ã€push ç­‰ã€‚</p>
<h3 id="å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§"><a href="#å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§" class="headerlink" title="å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§"></a>å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§</h3><p>å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/transaction/mq-message.jpg" alt></p>
<ol>
<li>A ç³»ç»Ÿå…ˆå‘ mq å‘é€ä¸€æ¡ prepare æ¶ˆæ¯ï¼Œå¦‚æœ prepare æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œåˆ™ç›´æ¥å–æ¶ˆæ“ä½œ</li>
<li>å¦‚æœæ¶ˆæ¯å‘é€æˆåŠŸï¼Œåˆ™æ‰§è¡Œæœ¬åœ°äº‹åŠ¡</li>
<li>å¦‚æœæœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸï¼Œåˆ™å‘ mq å‘é€ä¸€æ¡ confirm æ¶ˆæ¯ï¼Œå¦‚æœå‘é€å¤±è´¥ï¼Œåˆ™å‘é€å›æ»šæ¶ˆæ¯</li>
<li>B ç³»ç»Ÿå®šæœŸæ¶ˆè´¹ mq ä¸­çš„ confirm æ¶ˆæ¯ï¼Œæ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œå¹¶å‘é€ ack æ¶ˆæ¯ã€‚å¦‚æœ B ç³»ç»Ÿä¸­çš„æœ¬åœ°äº‹åŠ¡å¤±è´¥ï¼Œä¼šä¸€ç›´ä¸æ–­é‡è¯•ï¼Œå¦‚æœæ˜¯ä¸šåŠ¡å¤±è´¥ï¼Œä¼šå‘ A ç³»ç»Ÿå‘èµ·å›æ»šè¯·æ±‚</li>
<li>mq ä¼šå®šæœŸè½®è¯¢æ‰€æœ‰ prepared æ¶ˆæ¯è°ƒç”¨ç³»ç»Ÿ A æä¾›çš„æ¥å£æŸ¥è¯¢æ¶ˆæ¯çš„å¤„ç†æƒ…å†µï¼Œå¦‚æœè¯¥ prepare æ¶ˆæ¯æœ¬åœ°äº‹åŠ¡å¤„ç†æˆåŠŸï¼Œåˆ™é‡æ–°å‘é€ confirm æ¶ˆæ¯ï¼Œå¦åˆ™ç›´æ¥å›æ»šè¯¥æ¶ˆæ¯</li>
</ol>
<p>è¯¥æ–¹æ¡ˆä¸æœ¬åœ°æ¶ˆæ¯æœ€å¤§çš„ä¸åŒæ˜¯å»æ‰äº†æœ¬åœ°æ¶ˆæ¯è¡¨ï¼Œå…¶æ¬¡æœ¬åœ°æ¶ˆæ¯è¡¨ä¾èµ–æ¶ˆæ¯è¡¨é‡è¯•å†™å…¥ mq è¿™ä¸€æ­¥ç”±æœ¬æ–¹æ¡ˆä¸­çš„è½®è¯¢ prepare æ¶ˆæ¯çŠ¶æ€æ¥é‡è¯•æˆ–è€…å›æ»šè¯¥æ¶ˆæ¯æ›¿ä»£ã€‚å…¶å®ç°æ¡ä»¶ä¸å®¹é”™æ–¹æ¡ˆåŸºæœ¬ä¸€è‡´ã€‚</p>
<p><strong>å®æˆ˜:</strong><br>ç›®å‰å¸‚é¢ä¸Šå®ç°è¯¥æ–¹æ¡ˆçš„åªæœ‰é˜¿é‡Œçš„ RocketMqã€‚</p>
<h3 id="å°½æœ€å¤§åŠªåŠ›é€šçŸ¥"><a href="#å°½æœ€å¤§åŠªåŠ›é€šçŸ¥" class="headerlink" title="å°½æœ€å¤§åŠªåŠ›é€šçŸ¥"></a>å°½æœ€å¤§åŠªåŠ›é€šçŸ¥</h3><p>æœ€å¤§åŠªåŠ›é€šçŸ¥å…¶å®å°±æ˜¯å®šæœŸæ ¡å¯¹, æ˜¯æœ€ç®€å•çš„ä¸€ç§æŸ”æ€§äº‹åŠ¡ï¼Œé€‚ç”¨äºä¸€äº›æœ€ç»ˆä¸€è‡´æ€§æ—¶é—´æ•æ„Ÿåº¦ä½çš„ä¸šåŠ¡ï¼Œä¸”è¢«åŠ¨æ–¹å¤„ç†ç»“æœ ä¸å½±å“ä¸»åŠ¨æ–¹çš„å¤„ç†ç»“æœã€‚</p>
<p>ä¸šåŠ¡æ´»åŠ¨çš„ä¸»åŠ¨æ–¹ï¼Œåœ¨å®Œæˆä¸šåŠ¡å¤„ç†ä¹‹åï¼Œå‘ä¸šåŠ¡æ´»åŠ¨çš„è¢«åŠ¨æ–¹å‘é€æ¶ˆæ¯ï¼Œå…è®¸æ¶ˆæ¯ä¸¢å¤±ã€‚ä¸»åŠ¨æ–¹å¯ä»¥è®¾ç½®æ—¶é—´é˜¶æ¢¯å‹é€šçŸ¥è§„åˆ™ï¼Œåœ¨é€šçŸ¥å¤±è´¥åæŒ‰è§„åˆ™é‡å¤é€šçŸ¥ï¼Œç›´åˆ°é€šçŸ¥Næ¬¡åä¸å†é€šçŸ¥ã€‚ä¸»åŠ¨æ–¹æä¾›æ ¡å¯¹æŸ¥è¯¢æ¥å£ç»™è¢«åŠ¨æ–¹æŒ‰éœ€æ ¡å¯¹æŸ¥è¯¢ï¼Œç”¨äºæ¢å¤ä¸¢å¤±çš„ä¸šåŠ¡æ¶ˆæ¯ã€‚ä¸šåŠ¡æ´»åŠ¨çš„è¢«åŠ¨æ–¹å¦‚æœæ­£å¸¸æ¥æ”¶äº†æ•°æ®ï¼Œå°±æ­£å¸¸è¿”å›å“åº”ï¼Œå¹¶ç»“æŸäº‹åŠ¡ã€‚å¦‚æœè¢«åŠ¨æ–¹æ²¡æœ‰æ­£å¸¸æ¥æ”¶ï¼Œæ ¹æ®å®šæ—¶ç­–ç•¥ï¼Œå‘ä¸šåŠ¡æ´»åŠ¨ä¸»åŠ¨æ–¹æŸ¥è¯¢ï¼Œæ¢å¤ä¸¢å¤±çš„ä¸šåŠ¡æ¶ˆæ¯</p>
<p>æœ€å¤§åŠªåŠ›é€šçŸ¥æ–¹æ¡ˆçš„ç‰¹ç‚¹:  </p>
<ul>
<li>ç”¨åˆ°çš„æœåŠ¡æ¨¡å¼ï¼šå¯æŸ¥è¯¢æ“ä½œã€å¹‚ç­‰æ“ä½œã€‚</li>
<li>è¢«åŠ¨æ–¹çš„å¤„ç†ç»“æœä¸å½±å“ä¸»åŠ¨æ–¹çš„å¤„ç†ç»“æœï¼›é€‚ç”¨äºå¯¹ä¸šåŠ¡æœ€ç»ˆä¸€è‡´æ€§çš„æ—¶é—´æ•æ„Ÿåº¦ä½çš„ç³»ç»Ÿ, æ¯”å¦‚é€‚åˆè·¨ä¼ä¸šçš„ç³»ç»Ÿé—´çš„æ“ä½œï¼Œæˆ–è€…ä¼ä¸šå†…éƒ¨æ¯”è¾ƒç‹¬ç«‹çš„ç³»ç»Ÿé—´çš„æ“ä½œï¼Œæ¯”å¦‚é“¶è¡Œé€šçŸ¥ã€å•†æˆ·é€šçŸ¥ç­‰ï¼›</li>
</ul>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/transaction/notify-callback.jpg" alt></p>
<p>è¿™ä¸ªæ–¹æ¡ˆçš„å¤§è‡´æ„æ€å°±æ˜¯ï¼š</p>
<ol>
<li>ç³»ç»Ÿ A æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå®Œä¹‹åï¼Œå‘é€ä¸ªæ¶ˆæ¯åˆ° MQï¼›</li>
<li>ä¼šæœ‰ä¸ªä¸“é—¨æ¶ˆè´¹ MQ çš„æœåŠ¡ notify_service(å³æœ€å¤§åŠªåŠ›é€šçŸ¥æœåŠ¡) ï¼Œè¿™ä¸ªæœåŠ¡ä¼šæ¶ˆè´¹ MQ å¹¶è°ƒç”¨ç³»ç»Ÿ B çš„æ¥å£ï¼›</li>
<li>è¦æ˜¯ç³»ç»Ÿ B æ‰§è¡ŒæˆåŠŸå°± ok äº†ï¼›è¦æ˜¯ç³»ç»Ÿ B æ‰§è¡Œå¤±è´¥äº†ï¼Œé‚£ä¹ˆ notify_service (å³æœ€å¤§åŠªåŠ›é€šçŸ¥æœåŠ¡)å°±å®šæ—¶å°è¯•é‡æ–°è°ƒç”¨ç³»ç»Ÿ B, åå¤ N æ¬¡ï¼Œæœ€åè¿˜æ˜¯ä¸è¡Œå°±æ”¾å¼ƒã€‚</li>
</ol>
<p><strong>å®æˆ˜:</strong><br>å°ç±³æµ·å¤–å•†åŸç›®å‰é™¤äº†æ”¯ä»˜å›è°ƒå¤–ï¼Œæœ€å¸¸ç”¨çš„åœºæ™¯æ˜¯è®¢å•æ•°æ®åŒæ­¥ã€‚ä¾‹å¦‚ç³»ç»Ÿ Aã€B è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œå½“ç³»ç»Ÿ A å‘ç”Ÿè®¢å•æ•°æ®å˜æ›´ï¼Œå…ˆå°†æ•°æ®å˜æ›´æ¶ˆæ¯å†™å…¥å°ç±³ notify ç³»ç»Ÿï¼ˆä½œç”¨ç­‰åŒ mqï¼‰ï¼Œç„¶å notify ç³»ç»Ÿå¼‚æ­¥å¤„ç†è¯¥æ¶ˆæ¯æ¥è°ƒç”¨ç³»ç»Ÿ B æä¾›çš„æ¥å£å¹¶è¿›è¡Œé‡è¯•åˆ°æœ€å¤§æ¬¡æ•°ã€‚</p>
<h2 id="è´Ÿè½½å‡è¡¡ç®—æ³•æœ‰å“ªäº›"><a href="#è´Ÿè½½å‡è¡¡ç®—æ³•æœ‰å“ªäº›" class="headerlink" title="è´Ÿè½½å‡è¡¡ç®—æ³•æœ‰å“ªäº›"></a>è´Ÿè½½å‡è¡¡ç®—æ³•æœ‰å“ªäº›</h2><ol>
<li>è½®è¯¢æ³•<br>ã€€ã€€å°†è¯·æ±‚æŒ‰é¡ºåºè½®æµåœ°åˆ†é…åˆ°åç«¯æœåŠ¡å™¨ä¸Šï¼Œå®ƒå‡è¡¡åœ°å¯¹å¾…åç«¯çš„æ¯ä¸€å°æœåŠ¡å™¨ï¼Œè€Œä¸å…³å¿ƒæœåŠ¡å™¨å®é™…çš„è¿æ¥æ•°å’Œå½“å‰çš„ç³»ç»Ÿè´Ÿè½½ã€‚</li>
<li>éšæœºæ³•<br>  é€šè¿‡ç³»ç»Ÿçš„éšæœºç®—æ³•ï¼Œæ ¹æ®åç«¯æœåŠ¡å™¨çš„åˆ—è¡¨å¤§å°å€¼æ¥éšæœºé€‰å–å…¶ä¸­çš„ä¸€å°æœåŠ¡å™¨è¿›è¡Œè®¿é—®ã€‚ç”±æ¦‚ç‡ç»Ÿè®¡ç†è®ºå¯ä»¥å¾—çŸ¥ï¼Œéšç€å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯çš„æ¬¡æ•°å¢å¤šï¼Œ<br>å…¶å®é™…æ•ˆæœè¶Šæ¥è¶Šæ¥è¿‘äºå¹³å‡åˆ†é…è°ƒç”¨é‡åˆ°åç«¯çš„æ¯ä¸€å°æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯è½®è¯¢çš„ç»“æœã€‚</li>
<li>æºåœ°å€å“ˆå¸Œæ³•<br>  æºåœ°å€å“ˆå¸Œçš„æ€æƒ³æ˜¯æ ¹æ®è·å–å®¢æˆ·ç«¯çš„ IP åœ°å€ï¼Œé€šè¿‡å“ˆå¸Œå‡½æ•°è®¡ç®—å¾—åˆ°çš„ä¸€ä¸ªæ•°å€¼ï¼Œç”¨è¯¥æ•°å€¼å¯¹æœåŠ¡å™¨åˆ—è¡¨çš„å¤§å°è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œå¾—åˆ°çš„ç»“æœä¾¿æ˜¯å®¢æœç«¯è¦è®¿é—®æœåŠ¡å™¨çš„åºå·ã€‚é‡‡ç”¨æºåœ°å€å“ˆå¸Œæ³•è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼ŒåŒä¸€ IP åœ°å€çš„å®¢æˆ·ç«¯ï¼Œå½“åç«¯æœåŠ¡å™¨åˆ—è¡¨ä¸å˜æ—¶ï¼Œå®ƒæ¯æ¬¡éƒ½ä¼šæ˜ å°„åˆ°åŒä¸€å°åç«¯æœåŠ¡å™¨è¿›è¡Œè®¿é—®ã€‚</li>
<li>åŠ æƒè½®è¯¢æ³•<br>ã€€ã€€ä¸åŒçš„åç«¯æœåŠ¡å™¨å¯èƒ½æœºå™¨çš„é…ç½®å’Œå½“å‰ç³»ç»Ÿçš„è´Ÿè½½å¹¶ä¸ç›¸åŒï¼Œå› æ­¤å®ƒä»¬çš„æŠ—å‹èƒ½åŠ›ä¹Ÿä¸ç›¸åŒã€‚ç»™é…ç½®é«˜ã€è´Ÿè½½ä½çš„æœºå™¨é…ç½®æ›´é«˜çš„æƒé‡ï¼Œè®©å…¶å¤„ç†æ›´å¤šçš„è¯·ï¼›è€Œé…ç½®ä½ã€è´Ÿè½½é«˜çš„æœºå™¨ï¼Œç»™å…¶åˆ†é…è¾ƒä½çš„æƒé‡ï¼Œé™ä½å…¶ç³»ç»Ÿè´Ÿè½½ï¼ŒåŠ æƒè½®è¯¢èƒ½å¾ˆå¥½åœ°å¤„ç†è¿™ä¸€é—®é¢˜ï¼Œå¹¶å°†è¯·æ±‚é¡ºåºä¸”æŒ‰ç…§æƒé‡åˆ†é…åˆ°åç«¯ã€‚åŠ æƒè½®è¯¢ç®—æ³•çš„ç»“æœï¼Œå°±æ˜¯è¦ç”Ÿæˆä¸€ä¸ªæœåŠ¡å™¨åºåˆ—ã€‚æ¯å½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶ï¼Œå°±ä¾æ¬¡ä»è¯¥åºåˆ—ä¸­å–å‡ºä¸‹ä¸€ä¸ªæœåŠ¡å™¨ç”¨äºå¤„ç†è¯¥è¯·æ±‚ã€‚æ¯”å¦‚é’ˆå¯¹<code>cæƒé‡4, bæƒé‡2, aæƒé‡1</code>çš„ä¾‹å­ï¼ŒåŠ æƒè½®è¯¢ç®—æ³•ä¼šç”Ÿæˆåºåˆ—<code>{c, c, b, c, a, b, c}</code>ä¹Ÿæœ‰å¯èƒ½æ˜¯<code>{a, a, a, a, a, b, c}</code>, æœ‰å¯èƒ½ä¸å‡åŒ€, å‰äº”ä¸ªè¯·æ±‚éƒ½ä¼šåˆ†é…ç»™æœåŠ¡å™¨aã€‚åœ¨Nginxæºç ä¸­ï¼Œå®ç°äº†ä¸€ç§å«åšå¹³æ»‘çš„åŠ æƒè½®è¯¢ï¼ˆsmooth weighted round-robin balancingï¼‰çš„ç®—æ³•ï¼Œå®ƒç”Ÿæˆçš„åºåˆ—æ›´åŠ å‡åŒ€ã€‚æ¯”å¦‚å‰é¢çš„ä¾‹å­ï¼Œå®ƒç”Ÿæˆçš„åºåˆ—ä¸º{ a, a, b, a, c, a, a}ï¼Œè½¬å‘ç»™åç«¯açš„5ä¸ªè¯·æ±‚ç°åœ¨åˆ†æ•£å¼€æ¥ï¼Œä¸å†æ˜¯è¿ç»­çš„ã€‚è¿™æ ·ï¼Œæ¯æ”¶åˆ°7ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä¼šæŠŠå…¶ä¸­çš„1ä¸ªè½¬å‘ç»™åç«¯aï¼ŒæŠŠå…¶ä¸­çš„2ä¸ªè½¬å‘ç»™åç«¯bï¼ŒæŠŠå…¶ä¸­çš„4ä¸ªè½¬å‘ç»™åç«¯cã€‚æ”¶åˆ°çš„ç¬¬8ä¸ªè¯·æ±‚ï¼Œé‡æ–°ä»è¯¥åºåˆ—çš„å¤´éƒ¨å¼€å§‹è½®è¯¢ã€‚<ul>
<li>æ™®é€šåŠ æƒè½®è¯¢æ³•</li>
<li><a href="#è´Ÿè½½å‡è¡¡çš„å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•æ€ä¹ˆå®ç°">å¹³æ»‘åŠ æƒè½®è¯¢æ³•</a></li>
</ul>
</li>
<li>åŠ æƒéšæœºæ³•<br>  ä¸åŠ æƒè½®è¯¢æ³•ä¸€æ ·ï¼ŒåŠ æƒéšæœºæ³•ä¹Ÿæ ¹æ®åç«¯æœºå™¨çš„é…ç½®ï¼Œç³»ç»Ÿçš„è´Ÿè½½åˆ†é…ä¸åŒçš„æƒé‡ã€‚ä¸åŒçš„æ˜¯ï¼Œå®ƒæ˜¯æŒ‰ç…§æƒé‡éšæœºè¯·æ±‚åç«¯æœåŠ¡å™¨ï¼Œè€Œéé¡ºåºã€‚</li>
<li>æœ€å°è¿æ¥æ•°æ³•<br>  æœ€å°è¿æ¥æ•°ç®—æ³•æ¯”è¾ƒçµæ´»å’Œæ™ºèƒ½ï¼Œç”±äºåç«¯æœåŠ¡å™¨çš„é…ç½®ä¸å°½ç›¸åŒï¼Œå¯¹äºè¯·æ±‚çš„å¤„ç†æœ‰å¿«æœ‰æ…¢ï¼Œå®ƒæ˜¯æ ¹æ®åç«¯æœåŠ¡å™¨å½“å‰çš„è¿æ¥æƒ…å†µï¼ŒåŠ¨æ€åœ°é€‰å–å…¶ä¸­å½“å‰ç§¯å‹è¿æ¥æ•°æœ€å°‘çš„ä¸€å°æœåŠ¡å™¨æ¥å¤„ç†å½“å‰çš„è¯·æ±‚ï¼Œå°½å¯èƒ½åœ°æé«˜åç«¯æœåŠ¡çš„åˆ©ç”¨æ•ˆç‡ï¼Œå°†è´Ÿè´£åˆç†åœ°åˆ†æµåˆ°æ¯ä¸€å°æœåŠ¡å™¨ã€‚</li>
</ol>
<h3 id="è´Ÿè½½å‡è¡¡çš„å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•æ€ä¹ˆå®ç°"><a href="#è´Ÿè½½å‡è¡¡çš„å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•æ€ä¹ˆå®ç°" class="headerlink" title="è´Ÿè½½å‡è¡¡çš„å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•æ€ä¹ˆå®ç°"></a>è´Ÿè½½å‡è¡¡çš„å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•æ€ä¹ˆå®ç°</h3><p>å½“æˆ‘ä»¬éœ€è¦æŠŠä¸€ä»½æ•°æ®å‘é€åˆ°ä¸€ä¸ªSetä¸­çš„ä»»æ„æœºå™¨çš„æ—¶å€™ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚ä½•æŒ‘Setä¸­çš„æœºå™¨ä½œä¸ºæ•°æ®çš„æ¥æ”¶æ–¹ï¼Ÿæ˜¾ç„¶ç®—æ³•éœ€è¦ç¬¦åˆä»¥ä¸‹è¦æ±‚ï¼š</p>
<ul>
<li>æ”¯æŒåŠ æƒï¼Œä»¥ä¾¿åœ¨æœºå™¨æ•…éšœæ—¶å¯ä»¥é™ä½å…¶æƒé‡</li>
<li>åœ¨åŠ æƒçš„å‰æä¸‹ï¼Œå°½å¯èƒ½åœ°æŠŠè¯·æ±‚å¹³æ‘Šåˆ°æ¯å°æœºå™¨ä¸Š</li>
</ul>
<p>ç¬¬ä¸€ç‚¹å¾ˆå¥½ç†è§£ï¼Œè€Œç¬¬äºŒç‚¹çš„æ„æ€æ˜¯ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬ç°åœ¨æœ‰a, b, cä¸‰ä¸ªé€‰æ‹©ï¼Œæƒé‡åˆ†åˆ«æ˜¯5, 1, 1ï¼Œæˆ‘ä»¬å¸Œæœ›è¾“å‡ºçš„ç»“æœæ˜¯ç±»ä¼¼äºa, a, b, a, c, a, aï¼Œè€Œä¸æ˜¯a, a, a, a, a, b, cã€‚</p>
<p>ä»Githubä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼ŒNginxä»¥å‰ä¹Ÿæ˜¯ä½¿ç”¨å’ŒLVSç±»ä¼¼çš„ç®—æ³•ï¼Œå¹¶åœ¨æŸä¸€æ¬¡æäº¤ä¸­ä¿®æ”¹ä¸ºå½“å‰çš„ç®—æ³•ï¼Œè¯¥ç®—æ³•å¤§è‡´æ€æƒ³å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Upstream: smooth weighted round-robin balancing.</span><br><span class="line"></span><br><span class="line">For edge case weights like &#123; 5, 1, 1 &#125; we now produce &#123; a, a, b, a, c, a, a &#125;</span><br><span class="line">sequence instead of &#123; c, b, a, a, a, a, a &#125; produced previously.</span><br><span class="line"></span><br><span class="line">Algorithm is as follows: on each peer selection we increase current_weight</span><br><span class="line">of each eligible peer by its weight, select peer with greatest current_weight</span><br><span class="line">and reduce its current_weight by total number of weight points distributed</span><br><span class="line">among peers.</span><br><span class="line"></span><br><span class="line">In case of &#123; 5, 1, 1 &#125; weights this gives the following sequence of</span><br><span class="line">current_weight&apos;s:</span><br><span class="line"></span><br><span class="line">     a  b  c</span><br><span class="line">     0  0  0  (initial state)</span><br><span class="line"></span><br><span class="line">     5  1  1  (a selected)</span><br><span class="line">    -2  1  1</span><br><span class="line"></span><br><span class="line">     3  2  2  (a selected)</span><br><span class="line">    -4  2  2</span><br><span class="line"></span><br><span class="line">     1  3  3  (b selected)</span><br><span class="line">     1 -4  3</span><br><span class="line"></span><br><span class="line">     6 -3  4  (a selected)</span><br><span class="line">    -1 -3  4</span><br><span class="line"></span><br><span class="line">     4 -2  5  (c selected)</span><br><span class="line">     4 -2 -2</span><br><span class="line"></span><br><span class="line">     9 -1 -1  (a selected)</span><br><span class="line">     2 -1 -1</span><br><span class="line"></span><br><span class="line">     7  0  0  (a selected)</span><br><span class="line">     0  0  0</span><br></pre></td></tr></table></figure></p>
<p>è¯¥ç®—æ³•é™¤äº†æœ‰æƒé‡weightï¼Œè¿˜å¼•å…¥äº†å¦ä¸€ä¸ªå˜é‡current_weightï¼Œåœ¨æ¯ä¸€æ¬¡éå†ä¸­ä¼šæŠŠcurrent_weightåŠ ä¸Šweightçš„å€¼ï¼Œå¹¶é€‰æ‹©current_weightæœ€å¤§çš„å…ƒç´ ï¼Œå¯¹äºè¢«é€‰æ‹©çš„å…ƒç´ ï¼Œå†æŠŠcurrent_weightå‡å»æ‰€æœ‰æƒé‡ä¹‹å’Œã€‚</p>
<p>å‡è®¾æœ‰ N å°æœåŠ¡å™¨ S = {S0, S1, S2, â€¦, Sn}ï¼Œé»˜è®¤æƒé‡ä¸º W = {W0, W1, W2, â€¦, Wn}ï¼Œå½“å‰æƒé‡ä¸º CW = {CW0, CW1, CW2, â€¦, CWn}ã€‚åœ¨è¯¥ç®—æ³•ä¸­æœ‰ä¸¤ä¸ªæƒé‡ï¼Œé»˜è®¤æƒé‡è¡¨ç¤ºæœåŠ¡å™¨çš„åŸå§‹æƒé‡ï¼Œå½“å‰æƒé‡è¡¨ç¤ºæ¯æ¬¡è®¿é—®åé‡æ–°è®¡ç®—çš„æƒé‡ï¼Œå½“å‰æƒé‡çš„å‡ºåˆå§‹å€¼ä¸ºé»˜è®¤æƒé‡å€¼ï¼Œå½“å‰æƒé‡å€¼æœ€å¤§çš„æœåŠ¡å™¨ä¸º maxWeightServerï¼Œæ‰€æœ‰é»˜è®¤æƒé‡ä¹‹å’Œä¸º weightSumï¼ŒæœåŠ¡å™¨åˆ—è¡¨ä¸º serverListï¼Œç®—æ³•å¯ä»¥æè¿°ä¸ºï¼š</p>
<ol>
<li>æ‰¾å‡ºå½“å‰æƒé‡å€¼æœ€å¤§çš„æœåŠ¡å™¨ maxWeightServerï¼›</li>
<li>è®¡ç®— {W0, W1, W2, â€¦, Wn} ä¹‹å’Œ weightSumï¼›</li>
<li>å°† maxWeightServer.CW = maxWeightServer.CW - weightSumï¼›</li>
<li>é‡æ–°è®¡ç®— {S0, S1, S2, â€¦, Sn} çš„å½“å‰æƒé‡ CWï¼Œè®¡ç®—å…¬å¼ä¸º Sn.CW = Sn.CW + Sn.Wn</li>
<li>è¿”å› maxWeightServer</li>
</ol>
<h2 id="æœåŠ¡å‘ç°æ˜¯æ€ä¹ˆå®ç°çš„"><a href="#æœåŠ¡å‘ç°æ˜¯æ€ä¹ˆå®ç°çš„" class="headerlink" title="æœåŠ¡å‘ç°æ˜¯æ€ä¹ˆå®ç°çš„"></a>æœåŠ¡å‘ç°æ˜¯æ€ä¹ˆå®ç°çš„</h2><p><a href="https://www.infoq.cn/article/etcd-interpretation-application-scenario-implement-principle" target="_blank" rel="noopener">å‚è€ƒ</a>  </p>
<p>æˆ‘ä»¬å¯ä»¥è€ƒè™‘ç”¨etcdæ¥åš,<br>æœåŠ¡å‘ç°è¦è§£å†³çš„ä¹Ÿæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æœ€å¸¸è§çš„é—®é¢˜ä¹‹ä¸€ï¼Œå³åœ¨åŒä¸€ä¸ªåˆ†å¸ƒå¼é›†ç¾¤ä¸­çš„è¿›ç¨‹æˆ–æœåŠ¡ï¼Œè¦å¦‚ä½•æ‰èƒ½æ‰¾åˆ°å¯¹æ–¹å¹¶å»ºç«‹è¿æ¥ã€‚æœ¬è´¨ä¸Šæ¥è¯´ï¼ŒæœåŠ¡å‘ç°å°±æ˜¯æƒ³è¦äº†è§£é›†ç¾¤ä¸­æ˜¯å¦æœ‰è¿›ç¨‹åœ¨ç›‘å¬ udp æˆ– tcp ç«¯å£ï¼Œå¹¶ä¸”é€šè¿‡åå­—å°±å¯ä»¥æŸ¥æ‰¾å’Œè¿æ¥ã€‚è¦è§£å†³æœåŠ¡å‘ç°çš„é—®é¢˜ï¼Œéœ€è¦æœ‰ä¸‹é¢ä¸‰å¤§æ”¯æŸ±ï¼Œç¼ºä¸€ä¸å¯ã€‚</p>
<ol>
<li><strong>ä¸€ä¸ªå¼ºä¸€è‡´æ€§ã€é«˜å¯ç”¨çš„æœåŠ¡å­˜å‚¨ç›®å½•</strong>ã€‚åŸºäº Raft ç®—æ³•çš„ etcd å¤©ç”Ÿå°±æ˜¯è¿™æ ·ä¸€ä¸ªå¼ºä¸€è‡´æ€§é«˜å¯ç”¨çš„æœåŠ¡å­˜å‚¨ç›®å½•ã€‚</li>
<li><strong>ä¸€ç§æä¾›æ–¹çš„æ³¨å†ŒæœåŠ¡</strong>ã€‚æä¾›æ–¹å¯ä»¥åœ¨ etcd ä¸­æ³¨å†ŒæœåŠ¡ï¼Œå¹¶ä¸”å¯¹æ³¨å†Œçš„æœåŠ¡è®¾ç½®<code>key TTL</code>ï¼Œå®šæ—¶ä¿æŒæœåŠ¡çš„å¿ƒè·³ä»¥è¾¾åˆ°ç›‘æ§å¥åº·çŠ¶æ€çš„æ•ˆæœ, æ¯”å¦‚æ¯éš” 30s å‘é€ä¸€æ¬¡å¿ƒè·³è®¾ç½®ä¸€ä¸‹è¿™ä¸ª<code>key</code>ä½¿ä»£è¡¨è¯¥æœºå™¨å­˜æ´»çš„èŠ‚ç‚¹ç»§ç»­å­˜åœ¨ï¼Œå¦åˆ™å½“etcd æ²¡æœ‰æ£€æµ‹åˆ°å¿ƒè·³è¿™ä¸ª<code>key</code>çš„ttlåˆ°äº†è¿‡æœŸäº†å°±ä¼šæŠŠè¿™ä¸ªé”®å€¼å¯¹åˆ äº†</li>
<li><strong>éœ€æ±‚æ–¹å¯ä»¥å³æ—¶æ›´æ–°æä¾›æ–¹æœåŠ¡çŠ¶æ€çš„æœºåˆ¶</strong>.éœ€æ±‚æ–¹é€šè¿‡watchæœºåˆ¶ç›‘å¬è‡ªå·±éœ€è¦ç”¨åˆ°çš„æä¾›æ–¹ä¿¡æ¯çš„æ”¹åŠ¨ï¼Œæä¾›æ–¹ç›¸å…³ä¿¡æ¯æœ‰å˜åŠ¨çš„æ—¶å€™éœ€æ±‚æ–¹å°±ä¼šæ”¶åˆ°æ¶ˆæ¯,åœ¨æ¥æ”¶åˆ°ä¿¡æ¯å˜åŠ¨çš„æ—¶å€™ç«‹å³ä»etcdè·å–ç›¸åº”æœ€æ–°çš„ä¿¡æ¯å³å¯, å®ç°æ–¹å¼é€šå¸¸æ˜¯è¿™æ ·ï¼šä¸åŒç³»ç»Ÿéƒ½åœ¨ etcd ä¸Šå¯¹åŒä¸€ä¸ªç›®å½•è¿›è¡Œæ³¨å†Œï¼ŒåŒæ—¶è®¾ç½® Watcher è§‚æµ‹è¯¥ç›®å½•çš„å˜åŒ–ï¼ˆå¦‚æœå¯¹å­ç›®å½•çš„å˜åŒ–ä¹Ÿæœ‰éœ€è¦ï¼Œå¯ä»¥è®¾ç½®é€’å½’æ¨¡å¼ï¼‰ï¼Œå½“æŸä¸ªç³»ç»Ÿæ›´æ–°äº† etcd çš„ç›®å½•ï¼Œé‚£ä¹ˆè®¾ç½®äº† Watcher çš„ç³»ç»Ÿå°±ä¼šæ”¶åˆ°é€šçŸ¥ï¼Œå¹¶ä½œå‡ºç›¸åº”å¤„ç†ã€‚<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/etcd/service_discovery.png" alt="æœåŠ¡å‘ç°ç¤ºæ„å›¾"><br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/etcd/1beabef5a1168cdc43766903e65f907d.jpg" alt="æœåŠ¡å‘ç°ç¤ºæ„å›¾"></li>
</ol>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹æœåŠ¡å‘ç°å¯¹åº”çš„å…·ä½“åœºæ™¯ã€‚<br><strong>å¾®æœåŠ¡ååŒå·¥ä½œæ¶æ„ä¸­ï¼ŒæœåŠ¡åŠ¨æ€æ·»åŠ </strong>ã€‚éšç€ Docker å®¹å™¨çš„æµè¡Œï¼Œå¤šç§å¾®æœåŠ¡å…±åŒåä½œï¼Œæ„æˆä¸€ä¸ªç›¸å¯¹åŠŸèƒ½å¼ºå¤§çš„æ¶æ„çš„æ¡ˆä¾‹è¶Šæ¥è¶Šå¤šã€‚é€æ˜åŒ–çš„åŠ¨æ€æ·»åŠ è¿™äº›æœåŠ¡çš„éœ€æ±‚ä¹Ÿæ—¥ç›Šå¼ºçƒˆã€‚é€šè¿‡æœåŠ¡å‘ç°æœºåˆ¶ï¼Œåœ¨ etcd ä¸­æ³¨å†ŒæŸä¸ªæœåŠ¡åå­—çš„ç›®å½•ï¼Œåœ¨è¯¥ç›®å½•ä¸‹å­˜å‚¨å¯ç”¨çš„æœåŠ¡èŠ‚ç‚¹çš„ IPã€‚åœ¨ä½¿ç”¨æœåŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œåªè¦ä»æœåŠ¡ç›®å½•ä¸‹æŸ¥æ‰¾å¯ç”¨çš„æœåŠ¡èŠ‚ç‚¹å»ä½¿ç”¨å³å¯ã€‚<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/etcd/e7d6918c1c9b7c9f2829779966ffb5d8.jpg" alt="å¾®æœåŠ¡ååŒå·¥ä½œ"></p>
<h2 id="ç†”æ–­æ˜¯æ€ä¹ˆå®ç°çš„"><a href="#ç†”æ–­æ˜¯æ€ä¹ˆå®ç°çš„" class="headerlink" title="ç†”æ–­æ˜¯æ€ä¹ˆå®ç°çš„"></a>ç†”æ–­æ˜¯æ€ä¹ˆå®ç°çš„</h2><p>ä»€ä¹ˆæ˜¯æœåŠ¡ç†”æ–­å‘¢ï¼Ÿ æœåŠ¡ç†”æ–­ï¼šå½“ä¸‹æ¸¸çš„æœåŠ¡å› ä¸ºæŸç§åŸå› çªç„¶<strong>å˜å¾—ä¸å¯ç”¨</strong>æˆ–<strong>å“åº”è¿‡æ…¢</strong>ï¼Œä¸Šæ¸¸æœåŠ¡ä¸ºäº†ä¿è¯è‡ªå·±æ•´ä½“æœåŠ¡çš„å¯ç”¨æ€§ï¼Œä¸å†ç»§ç»­è°ƒç”¨ç›®æ ‡æœåŠ¡ï¼Œç›´æ¥è¿”å›ï¼Œå¿«é€Ÿé‡Šæ”¾èµ„æºã€‚å¦‚æœç›®æ ‡æœåŠ¡æƒ…å†µå¥½è½¬åˆ™æ¢å¤è°ƒç”¨ã€‚ éœ€è¦è¯´æ˜çš„æ˜¯ç†”æ–­å…¶å®æ˜¯ä¸€ä¸ªæ¡†æ¶çº§çš„å¤„ç†ï¼Œé‚£ä¹ˆè¿™å¥—ç†”æ–­æœºåˆ¶çš„è®¾è®¡ï¼ŒåŸºæœ¬ä¸Šä¸šå†…ç”¨çš„æ˜¯<code>æ–­è·¯å™¨æ¨¡å¼</code>:</p>
<ul>
<li>æœ€å¼€å§‹å¤„äº<code>closed</code>çŠ¶æ€ï¼Œä¸€æ—¦æ£€æµ‹åˆ°é”™è¯¯åˆ°è¾¾ä¸€å®šé˜ˆå€¼ï¼Œä¾¿è½¬ä¸º<code>open</code>çŠ¶æ€ï¼›</li>
<li>è¿™æ—¶å€™ä¼šæœ‰ä¸ª reset timeoutï¼Œåˆ°äº†è¿™ä¸ªæ—¶é—´äº†ï¼Œä¼šè½¬ç§»åˆ°<code>half open</code>çŠ¶æ€ï¼›</li>
<li>å°è¯•æ”¾è¡Œä¸€éƒ¨åˆ†è¯·æ±‚åˆ°åç«¯ï¼Œä¸€æ—¦æ£€æµ‹æˆåŠŸä¾¿å›å½’åˆ°<code>closed</code>çŠ¶æ€ï¼Œå³æ¢å¤æœåŠ¡ï¼›</li>
</ul>
<p>ä¸šå†…ç›®å‰æµè¡Œçš„ç†”æ–­å™¨å¾ˆå¤šï¼Œä¾‹å¦‚é˜¿é‡Œå‡ºçš„ <code>Sentinel</code>, ä»¥åŠæœ€å¤šäººä½¿ç”¨çš„ <code>Hystrix</code> åœ¨ <code>Hystrix</code> ä¸­ï¼Œå¯¹åº”é…ç½®å¦‚ä¸‹<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//æ»‘åŠ¨çª—å£çš„å¤§å°ï¼Œé»˜è®¤ä¸º20</span><br><span class="line">circuitBreaker.requestVolumeThreshold </span><br><span class="line">//è¿‡å¤šé•¿æ—¶é—´ï¼Œç†”æ–­å™¨å†æ¬¡æ£€æµ‹æ˜¯å¦å¼€å¯ï¼Œé»˜è®¤ä¸º5000ï¼Œå³5sé’Ÿ</span><br><span class="line">circuitBreaker.sleepWindowInMilliseconds </span><br><span class="line">//é”™è¯¯ç‡ï¼Œé»˜è®¤50%</span><br><span class="line">circuitBreaker.errorThresholdPercentage</span><br></pre></td></tr></table></figure></p>
<p>æ¯å½“ 20 ä¸ªè¯·æ±‚ä¸­ï¼Œæœ‰ 50% å¤±è´¥æ—¶ï¼Œç†”æ–­å™¨å°±ä¼šæ‰“å¼€ï¼Œæ­¤æ—¶å†è°ƒç”¨æ­¤æœåŠ¡ï¼Œå°†ä¼šç›´æ¥è¿”å›å¤±è´¥ï¼Œä¸å†è°ƒè¿œç¨‹æœåŠ¡ã€‚ç›´åˆ° 5s é’Ÿä¹‹åï¼Œé‡æ–°æ£€æµ‹è¯¥è§¦å‘æ¡ä»¶ï¼Œåˆ¤æ–­æ˜¯å¦æŠŠç†”æ–­å™¨å…³é—­ï¼Œæˆ–è€…ç»§ç»­æ‰“å¼€ã€‚<br>è¿™äº›å±äºæ¡†æ¶å±‚çº§çš„å®ç°ï¼Œæˆ‘ä»¬åªè¦å®ç°å¯¹åº”æ¥å£å°±å¥½ï¼</p>
<h2 id="æœåŠ¡é™çº§"><a href="#æœåŠ¡é™çº§" class="headerlink" title="æœåŠ¡é™çº§"></a>æœåŠ¡é™çº§</h2><ul>
<li><strong>é™çº§çš„æœ¬è´¨</strong>:  <ul>
<li>é™çº§å°±æ˜¯ä¸ºäº†è§£å†³èµ„æºä¸è¶³å’Œè®¿é—®é‡å¢åŠ çš„çŸ›ç›¾</li>
<li>åœ¨æœ‰é™çš„èµ„æºæƒ…å†µä¸‹ï¼Œä¸ºäº†èƒ½æŠ—ä½å¤§é‡çš„è¯·æ±‚ï¼Œå°±éœ€è¦å¯¹ç³»ç»Ÿåšå‡ºä¸€äº›ç‰ºç‰²ï¼Œæœ‰ç‚¹â€œå¼ƒå’ä¿å¸…â€çš„æ„æ€ã€‚æ”¾å¼ƒä¸€äº›åŠŸèƒ½ï¼Œä¿è¯æ•´ä¸ªç³»ç»Ÿèƒ½å¹³ç¨³è¿è¡Œ</li>
</ul>
</li>
<li><strong>é™çº§ç‰ºç‰²çš„æ˜¯</strong>: <ul>
<li>å¼ºå¼ºä¸€è‡´æ€§å˜æˆæœ€ç»ˆä¸€è‡´æ€§<ul>
<li>å¤§å¤šæ•°çš„ç³»ç»Ÿæ˜¯ä¸éœ€è¦å¼ºä¸€è‡´æ€§çš„ã€‚</li>
<li>å¼ºä¸€è‡´æ€§å°±è¦æ±‚å¤šç§èµ„æºçš„å ç”¨ï¼Œå‡å°‘å¼ºä¸€è‡´æ€§å°±èƒ½é‡Šæ”¾æ›´å¤šèµ„æº</li>
<li>è¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸€èˆ¬åˆ©ç”¨æ¶ˆæ¯ä¸­é—´ä»¶æ¥å‰Šå³°å¡«è°·ï¼Œå˜å¼ºä¸€è‡´æ€§ä¸ºæœ€ç»ˆä¸€è‡´æ€§ï¼Œä¹Ÿèƒ½è¾¾åˆ°æ•ˆæœ</li>
</ul>
</li>
<li>å¹²æ‰ä¸€äº›æ¬¡è¦åŠŸèƒ½<ul>
<li>åœæ­¢è®¿é—®ä¸é‡è¦çš„åŠŸèƒ½ï¼Œä»è€Œé‡Šæ”¾å‡ºæ›´å¤šçš„èµ„æº</li>
<li>ä¸¾ä¾‹æ¥è¯´ï¼Œæ¯”å¦‚ç”µå•†ç½‘ç«™ï¼Œè¯„è®ºåŠŸèƒ½æµé‡å¤§çš„æ—¶å€™å°±èƒ½åœæ‰ï¼Œå½“ç„¶èƒ½ä¸ç›´æ¥å¹²æ‰å°±åˆ«ç›´æ¥ï¼Œæœ€å¥½èƒ½ç®€åŒ–æµç¨‹æˆ–è€…é™æµæœ€å¥½ç®€åŒ–åŠŸèƒ½æµç¨‹ã€‚æŠŠä¸€äº›åŠŸèƒ½ç®€åŒ–æ‰</li>
</ul>
</li>
</ul>
</li>
<li><strong>é™çº§çš„æ³¨æ„ç‚¹</strong>:<ul>
<li>å¯¹ä¸šåŠ¡è¿›è¡Œä»”ç»†çš„æ¢³ç†å’Œåˆ†æ<ul>
<li>å“ªäº›æ˜¯æ ¸å¿ƒæµç¨‹å¿…é¡»ä¿è¯çš„ï¼Œå“ªäº›æ˜¯å¯ä»¥ç‰ºç‰²çš„</li>
</ul>
</li>
<li>ä»€ä¹ˆæŒ‡æ ‡ä¸‹èƒ½è¿›è¡Œé™çº§<ul>
<li>ååé‡ã€å“åº”æ—¶é—´ã€å¤±è´¥æ¬¡æ•°ç­‰è¾¾åˆ°ä¸€ä¸ªé˜ˆå€¼æ‰è¿›è¡Œé™çº§å¤„ç†</li>
</ul>
</li>
</ul>
</li>
<li><strong>å¦‚ä½•é™çº§</strong>:<ul>
<li>é™çº§æœ€ç®€å•çš„å°±æ˜¯åœ¨ä¸šåŠ¡ä»£ç ä¸­é…ç½®ä¸€ä¸ªå¼€å…³æˆ–è€…åšæˆé…ç½®ä¸­å¿ƒæ¨¡å¼ï¼Œç›´æ¥åœ¨é…ç½®ä¸­å¿ƒä¸Šæ›´æ”¹é…ç½®ï¼Œæ¨é€åˆ°ç›¸åº”çš„æœåŠ¡ã€‚</li>
</ul>
</li>
</ul>
<h2 id="é™æµ"><a href="#é™æµ" class="headerlink" title="é™æµ"></a>é™æµ</h2><p>é™æµå°±æ˜¯é€šè¿‡å¯¹å¹¶å‘è®¿é—®è¿›è¡Œé™é€Ÿã€‚é™æµçš„å®ç°æ–¹å¼: </p>
<ul>
<li>è®¡æ•°å™¨:<br>  æœ€ç®€å•çš„å®ç°æ–¹å¼ ï¼Œç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ¥ä¸€ä¸ªè¯·æ±‚è®¡æ•°åŠ ä¸€ï¼Œè¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œç›´æ¥æ‹’ç»è¯·æ±‚ã€‚<br>  ä¸€èˆ¬å®è·µä¸­ç”¨ ngnix + lua + redis è¿™ç§æ–¹å¼ï¼Œredis å­˜è®¡æ•°å€¼</li>
<li>æ¼æ–—æ¨¡å¼:<br>  æµé‡å°±åƒè¿›å…¥æ¼æ–—ä¸­çš„æ°´ä¸€æ ·ï¼Œè€Œå‡ºå»çš„æ°´å’Œæˆ‘ä»¬ç³»ç»Ÿå¤„ç†çš„è¯·æ±‚ä¸€æ ·ï¼Œå½“æµé‡å¤§äºæ¼æ–—çš„æµå‡ºé€Ÿåº¦ï¼Œå°±ä¼šå‡ºç°ç§¯æ°´ï¼Œæ°´å¤šäº†ä¼šæº¢å‡º,<br>  æ¼æ–—å¾ˆå¤šæ˜¯ç”¨ä¸€ä¸ªé˜Ÿåˆ—å®ç°çš„ï¼Œå½“æµé‡è¿‡å¤šæ—¶ï¼Œé˜Ÿåˆ—ä¼šå‡ºç°ç§¯å‹ï¼Œé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™å¼€å§‹æ‹’ç»è¯·æ±‚ã€‚</li>
<li>ä»¤ç‰Œæ¡¶:<br>  çœ‹å›¾ä¾‹ï¼Œä»¤ç‰Œé€šå’Œæ¼æ–—æ¨¡å¼å¾ˆåƒï¼Œä¸»è¦çš„åŒºåˆ«æ˜¯å¢åŠ äº†ä¸€ä¸ªä¸­é—´äººï¼Œè¿™ä¸ªä¸­é—´äººæŒ‰ç…§ä¸€å®šçš„é€Ÿç‡æ”¾å…¥ä¸€äº›tokenï¼Œç„¶åï¼Œå¤„ç†è¯·æ±‚æ—¶ï¼Œéœ€è¦å…ˆæ‹¿åˆ°tokenæ‰èƒ½å¤„ç†ï¼Œå¦‚æœæ¡¶é‡Œæ²¡æœ‰tokenå¯ä»¥è·å–ï¼Œåˆ™ä¸è¿›è¡Œå¤„ç†ã€‚</li>
</ul>
<h2 id="ç†”æ–­-é™çº§-é™æµä¸‰è€…çš„å…³ç³»"><a href="#ç†”æ–­-é™çº§-é™æµä¸‰è€…çš„å…³ç³»" class="headerlink" title="ç†”æ–­-é™çº§-é™æµä¸‰è€…çš„å…³ç³»"></a>ç†”æ–­-é™çº§-é™æµä¸‰è€…çš„å…³ç³»</h2><ul>
<li>ç†”æ–­å¼ºè°ƒçš„æ˜¯æœåŠ¡ä¹‹é—´çš„è°ƒç”¨èƒ½å®ç°è‡ªæˆ‘æ¢å¤çš„çŠ¶æ€ï¼›</li>
<li>é™æµæ˜¯ä»ç³»ç»Ÿçš„æµé‡å…¥å£è€ƒè™‘ï¼Œä»è¿›å…¥çš„æµé‡ä¸Šè¿›è¡Œé™åˆ¶ï¼Œè¾¾åˆ°ä¿æŠ¤ç³»ç»Ÿçš„ä½œç”¨ï¼›</li>
<li>é™çº§ï¼Œæ˜¯ä»ç³»ç»Ÿå†…éƒ¨çš„å¹³çº§æœåŠ¡æˆ–è€…ä¸šåŠ¡çš„ç»´åº¦è€ƒè™‘ï¼Œæµé‡å¤§äº†ï¼Œå¯ä»¥å¹²æ‰ä¸€äº›ï¼Œä¿æŠ¤å…¶ä»–æ­£å¸¸ä½¿ç”¨ï¼›</li>
</ul>
<p>ç†”æ–­æ˜¯é™çº§æ–¹å¼çš„ä¸€ç§ï¼›<br>é™çº§åˆæ˜¯é™æµçš„ä¸€ç§æ–¹å¼ï¼›<br>ä¸‰è€…éƒ½æ˜¯ä¸ºäº†é€šè¿‡ä¸€å®šçš„æ–¹å¼å»ä¿æŠ¤æµé‡è¿‡å¤§æ—¶ï¼Œä¿æŠ¤ç³»ç»Ÿçš„æ‰‹æ®µã€‚</p>
<h2 id="idç”Ÿæˆå™¨å¦‚ä½•å®ç°å…¨å±€é€’å¢"><a href="#idç”Ÿæˆå™¨å¦‚ä½•å®ç°å…¨å±€é€’å¢" class="headerlink" title="idç”Ÿæˆå™¨å¦‚ä½•å®ç°å…¨å±€é€’å¢"></a>idç”Ÿæˆå™¨å¦‚ä½•å®ç°å…¨å±€é€’å¢</h2><p><a href="https://tech.meituan.com/2017/04/21/mt-leaf.html" target="_blank" rel="noopener">å‚è€ƒ</a>  </p>
<p>ä»‹ç»ä¸€ä¸‹ç¾å›¢åœ¨ç”¨çš„å·¥ä¸šçº§ <strong>Leaf-snowflake æ–¹æ¡ˆ</strong>ã€‚<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/distributed/721ceeff.png" alt></p>
<ul>
<li>41-bitçš„æ—¶é—´æ˜¯æ¯«ç§’çº§æ—¶é—´, å¯ä»¥è¡¨ç¤º<code>(1L&lt;&lt;41)/(1000L*3600*24*365)=69</code>å¹´çš„æ—¶é—´ï¼Œ</li>
<li>10-bitæœºå™¨å¯ä»¥åˆ†åˆ«è¡¨ç¤º1024å°æœºå™¨ã€‚å¦‚æœæˆ‘ä»¬å¯¹IDCåˆ’åˆ†æœ‰éœ€æ±‚ï¼Œè¿˜å¯ä»¥å°†10-bitåˆ†5-bitç»™IDCï¼Œåˆ†5-bitç»™å·¥ä½œæœºå™¨ã€‚è¿™æ ·å°±å¯ä»¥è¡¨ç¤º32ä¸ªIDCï¼Œæ¯ä¸ªIDCä¸‹å¯ä»¥æœ‰32å°æœºå™¨ï¼Œå¯ä»¥æ ¹æ®è‡ªèº«éœ€æ±‚å®šä¹‰ã€‚</li>
<li>12ä¸ªè‡ªå¢åºåˆ—å·å¯ä»¥è¡¨ç¤º<code>2^12</code>ä¸ªIDï¼Œç†è®ºä¸Šsnowflakeæ–¹æ¡ˆçš„QPSçº¦ä¸º409.6w/sï¼Œ</li>
<li><p><strong>è¿™ç§åˆ†é…æ–¹å¼å¯ä»¥ä¿è¯åœ¨ä»»ä½•ä¸€ä¸ªIDCçš„ä»»ä½•ä¸€å°æœºå™¨åœ¨ä»»æ„æ¯«ç§’å†…ç”Ÿæˆçš„IDéƒ½æ˜¯ä¸åŒçš„</strong></p>
</li>
<li><p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ¯«ç§’æ•°åœ¨é«˜ä½ï¼Œè‡ªå¢åºåˆ—åœ¨ä½ä½ï¼Œæ•´ä¸ªIDéƒ½æ˜¯è¶‹åŠ¿é€’å¢çš„ã€‚</li>
<li>ä¸ä¾èµ–æ•°æ®åº“ç­‰ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼Œä»¥æœåŠ¡çš„æ–¹å¼éƒ¨ç½²ï¼Œç¨³å®šæ€§æ›´é«˜ï¼Œç”ŸæˆIDçš„æ€§èƒ½ä¹Ÿæ˜¯éå¸¸é«˜çš„ã€‚</li>
<li>å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹æ€§åˆ†é…bitä½ï¼Œéå¸¸çµæ´»ã€‚</li>
</ul>
</li>
<li>ç¼ºç‚¹ï¼šå¼ºä¾èµ–æœºå™¨æ—¶é’Ÿï¼Œå¦‚æœæœºå™¨ä¸Šæ—¶é’Ÿå›æ‹¨ï¼Œä¼šå¯¼è‡´å‘å·é‡å¤æˆ–è€…æœåŠ¡ä¼šå¤„äºä¸å¯ç”¨çŠ¶æ€ã€‚</li>
</ul>
<h3 id="è§£å†³æ—¶é’Ÿå›æ‹¨é—®é¢˜"><a href="#è§£å†³æ—¶é’Ÿå›æ‹¨é—®é¢˜" class="headerlink" title="è§£å†³æ—¶é’Ÿå›æ‹¨é—®é¢˜"></a>è§£å†³æ—¶é’Ÿå›æ‹¨é—®é¢˜</h3><p>è§£å†³æ–¹æ¡ˆ:   </p>
<ul>
<li>ç”±äºå¼ºä¾èµ–æ—¶é’Ÿï¼Œå¯¹æ—¶é—´çš„è¦æ±‚æ¯”è¾ƒæ•æ„Ÿï¼Œåœ¨æœºå™¨å·¥ä½œæ—¶ NTP åŒæ­¥ä¹Ÿä¼šé€ æˆç§’çº§åˆ«çš„å›é€€ï¼Œå»ºè®®å¯ä»¥ç›´æ¥å…³é—­ NTP åŒæ­¥ã€‚</li>
<li>åœ¨æ—¶é’Ÿå›æ‹¨çš„æ—¶å€™ç›´æ¥ä¸æä¾›æœåŠ¡ç›´æ¥è¿”å› ERROR_CODEï¼Œç­‰æ—¶é’Ÿè¿½ä¸Šå³å¯</li>
<li>åå·®åœ¨5ç§’ä¹‹å†…, æ¯”å¦‚å°±ç­‰å¾…2å€çš„åå·®æ—¶é—´(æ¯”å¦‚æ¯”ä¸Šæ¬¡çš„è¿˜å°3ç§’, é‚£æˆ‘å°±ç­‰6ç§’)ã€‚ç„¶ååšä¸€å±‚é‡è¯•, å¦‚æœè¿˜æ˜¯å°äºä¸Šæ¬¡çš„æ—¶é—´, å°±ä¸ŠæŠ¥æŠ¥è­¦ç³»ç»Ÿ</li>
<li>æ›´æˆ–è€…æ˜¯å‘ç°æœ‰æ—¶é’Ÿå›æ‹¨ä¹‹åè‡ªåŠ¨æ‘˜é™¤æœ¬èº«èŠ‚ç‚¹å¹¶æŠ¥è­¦</li>
</ul>
<p>ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å‘ç”Ÿäº†å›æ‹¨ï¼Œæ­¤åˆ»æ—¶é—´å°äºä¸Šæ¬¡å‘å·æ—¶é—´</span></span><br><span class="line"><span class="keyword">if</span> (timestamp &lt; lastTimestamp) &#123;</span><br><span class="line">    <span class="keyword">long</span> offset = lastTimestamp - timestamp;</span><br><span class="line">    <span class="keyword">if</span> (offset &lt;= <span class="number">5</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//æ—¶é—´åå·®å¤§å°å°äº5msï¼Œåˆ™ç­‰å¾…ä¸¤å€æ—¶é—´</span></span><br><span class="line">            wait(offset &lt;&lt; <span class="number">1</span>);<span class="comment">//wait</span></span><br><span class="line">            timestamp = timeGen();</span><br><span class="line">            <span class="keyword">if</span> (timestamp &lt; lastTimestamp) &#123;</span><br><span class="line">                <span class="comment">//è¿˜æ˜¯å°äºï¼ŒæŠ›å¼‚å¸¸å¹¶ä¸ŠæŠ¥</span></span><br><span class="line">                throwClockBackwardsEx(timestamp);</span><br><span class="line">              &#125;    </span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span>  e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//throw</span></span><br><span class="line">        throwClockBackwardsEx(timestamp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="comment">//åˆ†é…ID</span></span><br></pre></td></tr></table></figure></p>
<p>ä»ä¸Šçº¿æƒ…å†µæ¥çœ‹ï¼Œåœ¨ 2017 å¹´é—°ç§’å‡ºç°é‚£ä¸€æ¬¡å‡ºç°è¿‡éƒ¨åˆ†æœºå™¨å›æ‹¨ï¼Œç”±äº Leaf-snowflake çš„ç­–ç•¥ä¿è¯ï¼ŒæˆåŠŸé¿å…äº†å¯¹ä¸šåŠ¡é€ æˆçš„å½±å“ã€‚<br>Leaf åœ¨ç¾å›¢ç‚¹è¯„å…¬å¸å†…éƒ¨æœåŠ¡åŒ…å«é‡‘èã€æ”¯ä»˜äº¤æ˜“ã€é¤é¥®ã€å¤–å–ã€é…’åº—æ—…æ¸¸ã€çŒ«çœ¼ç”µå½±ç­‰ä¼—å¤šä¸šåŠ¡çº¿ã€‚ç›®å‰ Leaf çš„æ€§èƒ½åœ¨ 4C8G çš„æœºå™¨ä¸Š QPS èƒ½å‹æµ‹åˆ°è¿‘ 5w/sï¼ŒTP999 1msï¼Œå·²ç»èƒ½å¤Ÿæ»¡è¶³å¤§éƒ¨åˆ†çš„ä¸šåŠ¡çš„éœ€æ±‚ã€‚æ¯å¤©æä¾›äº¿æ•°é‡çº§çš„è°ƒç”¨é‡ï¼Œä½œä¸ºå…¬å¸å†…éƒ¨å…¬å…±çš„åŸºç¡€æŠ€æœ¯è®¾æ–½ï¼Œå¿…é¡»ä¿è¯é«˜ SLA å’Œé«˜æ€§èƒ½çš„æœåŠ¡ï¼Œæˆ‘ä»¬ç›®å‰è¿˜ä»…ä»…è¾¾åˆ°äº†åŠæ ¼çº¿ï¼Œè¿˜æœ‰å¾ˆå¤šæé«˜çš„ç©ºé—´ã€‚</p>
<!-- 
**Leaf-snowflakeæ–¹æ¡ˆ**å®Œå…¨æ²¿ç”¨ snowflake æ–¹æ¡ˆçš„ bit ä½è®¾è®¡ï¼Œå³æ˜¯ â€œ1+41+10+12â€ çš„æ–¹å¼ç»„è£… ID å·ã€‚å¯¹äº workerID çš„åˆ†é…ï¼Œå½“æœåŠ¡é›†ç¾¤æ•°é‡è¾ƒå°çš„æƒ…å†µä¸‹ï¼Œå®Œå…¨å¯ä»¥æ‰‹åŠ¨é…ç½®ã€‚Leaf æœåŠ¡è§„æ¨¡è¾ƒå¤§ï¼ŒåŠ¨æ‰‹é…ç½®æˆæœ¬å¤ªé«˜ã€‚æ‰€ä»¥ä½¿ç”¨ Zookeeper æŒä¹…é¡ºåºèŠ‚ç‚¹çš„ç‰¹æ€§è‡ªåŠ¨å¯¹ snowflake èŠ‚ç‚¹é…ç½® wokerIDã€‚Leaf-snowflake æ˜¯æŒ‰ç…§ä¸‹é¢å‡ ä¸ªæ­¥éª¤å¯åŠ¨çš„ï¼š
1.  å¯åŠ¨ Leaf-snowflake æœåŠ¡ï¼Œè¿æ¥ Zookeeperï¼Œåœ¨ leaf_forever çˆ¶èŠ‚ç‚¹ä¸‹æ£€æŸ¥è‡ªå·±æ˜¯å¦å·²ç»æ³¨å†Œè¿‡ï¼ˆæ˜¯å¦æœ‰è¯¥é¡ºåºå­èŠ‚ç‚¹ï¼‰ã€‚
2.  å¦‚æœæœ‰æ³¨å†Œè¿‡ç›´æ¥å–å›è‡ªå·±çš„ workerIDï¼ˆzk é¡ºåºèŠ‚ç‚¹ç”Ÿæˆçš„ int ç±»å‹ ID å·ï¼‰ï¼Œå¯åŠ¨æœåŠ¡ã€‚
3.  å¦‚æœæ²¡æœ‰æ³¨å†Œè¿‡ï¼Œå°±åœ¨è¯¥çˆ¶èŠ‚ç‚¹ä¸‹é¢åˆ›å»ºä¸€ä¸ªæŒä¹…é¡ºåºèŠ‚ç‚¹ï¼Œåˆ›å»ºæˆåŠŸåå–å›é¡ºåºå·å½“åšè‡ªå·±çš„ workerID å·ï¼Œå¯åŠ¨æœåŠ¡ã€‚

![](/img/noodle_plan/distributed/a3f985a8.png)

#### å¼±ä¾èµ– ZooKeeper

é™¤äº†æ¯æ¬¡ä¼šå» ZK æ‹¿æ•°æ®ä»¥å¤–ï¼Œä¹Ÿä¼šåœ¨æœ¬æœºæ–‡ä»¶ç³»ç»Ÿä¸Šç¼“å­˜ä¸€ä¸ª workerID æ–‡ä»¶ã€‚å½“ ZooKeeper å‡ºç°é—®é¢˜ï¼Œæ°å¥½æœºå™¨å‡ºç°é—®é¢˜éœ€è¦é‡å¯æ—¶ï¼Œèƒ½ä¿è¯æœåŠ¡èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨ã€‚è¿™æ ·åšåˆ°äº†å¯¹ä¸‰æ–¹ç»„ä»¶çš„å¼±ä¾èµ–ã€‚ä¸€å®šç¨‹åº¦ä¸Šæé«˜äº† SLA


#### å¯åŠ¨æµç¨‹

å› ä¸ºè¿™ç§æ–¹æ¡ˆä¾èµ–æ—¶é—´ï¼Œå¦‚æœæœºå™¨çš„æ—¶é’Ÿå‘ç”Ÿäº†å›æ‹¨ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å¯èƒ½ç”Ÿæˆé‡å¤çš„ ID å·ï¼Œéœ€è¦è§£å†³æ—¶é’Ÿå›é€€çš„é—®é¢˜ã€‚
![](/img/noodle_plan/distributed/1453b4e9.png)

å‚è§ä¸Šå›¾æ•´ä¸ªå¯åŠ¨æµç¨‹å›¾ï¼ŒæœåŠ¡å¯åŠ¨æ—¶é¦–å…ˆæ£€æŸ¥è‡ªå·±æ˜¯å¦å†™è¿‡ ZooKeeper leaf_forever èŠ‚ç‚¹ï¼š
1.  è‹¥å†™è¿‡ï¼Œåˆ™ç”¨è‡ªèº«ç³»ç»Ÿæ—¶é—´ä¸ `leaf_forever/${self}` èŠ‚ç‚¹è®°å½•æ—¶é—´åšæ¯”è¾ƒï¼Œè‹¥å°äº `leaf_forever/${self}` æ—¶é—´åˆ™è®¤ä¸ºæœºå™¨æ—¶é—´å‘ç”Ÿäº†å¤§æ­¥é•¿å›æ‹¨ï¼ŒæœåŠ¡å¯åŠ¨å¤±è´¥å¹¶æŠ¥è­¦ã€‚
2.  è‹¥æœªå†™è¿‡ï¼Œè¯æ˜æ˜¯æ–°æœåŠ¡èŠ‚ç‚¹ï¼Œç›´æ¥åˆ›å»ºæŒä¹…èŠ‚ç‚¹ `leaf_forever/${self}`å¹¶å†™å…¥è‡ªèº«ç³»ç»Ÿæ—¶é—´ï¼Œæ¥ä¸‹æ¥ç»¼åˆå¯¹æ¯”å…¶ä½™ Leaf èŠ‚ç‚¹çš„ç³»ç»Ÿæ—¶é—´æ¥åˆ¤æ–­è‡ªèº«ç³»ç»Ÿæ—¶é—´æ˜¯å¦å‡†ç¡®ï¼Œå…·ä½“åšæ³•æ˜¯å– leaf_temporary ä¸‹çš„æ‰€æœ‰ä¸´æ—¶èŠ‚ç‚¹ (æ‰€æœ‰è¿è¡Œä¸­çš„ Leaf-snowflake èŠ‚ç‚¹) çš„æœåŠ¡ IPï¼šPortï¼Œç„¶åé€šè¿‡ RPC è¯·æ±‚å¾—åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ç³»ç»Ÿæ—¶é—´ï¼Œè®¡ç®— sum(time)/nodeSizeã€‚
3.  è‹¥ abs(ç³»ç»Ÿæ—¶é—´ - sum(time)/nodeSize ) < é˜ˆå€¼ï¼Œè®¤ä¸ºå½“å‰ç³»ç»Ÿæ—¶é—´å‡†ç¡®ï¼Œæ­£å¸¸å¯åŠ¨æœåŠ¡ï¼ŒåŒæ—¶å†™ä¸´æ—¶èŠ‚ç‚¹ leaf_temporary/${self} ç»´æŒç§Ÿçº¦ã€‚
4.  å¦åˆ™è®¤ä¸ºæœ¬æœºç³»ç»Ÿæ—¶é—´å‘ç”Ÿå¤§æ­¥é•¿åç§»ï¼Œå¯åŠ¨å¤±è´¥å¹¶æŠ¥è­¦ã€‚
5.  æ¯éš”ä¸€æ®µæ—¶é—´ (3s) ä¸ŠæŠ¥è‡ªèº«ç³»ç»Ÿæ—¶é—´å†™å…¥ `leaf_forever/${self}`ã€‚
 -->

          
        
      


      

    
      <footer class="post-footer">
        

        

        

        
        
          <div class="post-eof"></div>
        
      </footer>
      
    </div>
    
    
    

    

    

    

  </div>
  
  
  
  </article>


      
    
      
        

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hulinhong.com/self_cultivation_cpp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mike">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ğŸš™">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/self_cultivation_cpp/" itemprop="url">æœåŠ¡å™¨å¼€å‘è‡ªæˆ‘ä¿®å…»ä¸“æ -CPPè¦ç‚¹</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-13T19:08:06+00:00">
                03-13-2021
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Self-cultivation/" itemprop="url" rel="index">
                    <span itemprop="name">Self-cultivation</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    




    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      

      
      
        <div class="post-eof"></div>
      

      
      

      
        
          
            <h1 id="C"><a href="#C" class="headerlink" title="C++"></a>C++</h1><p>å‚è€ƒ: çœ‹ä¹‹å‰ä¸€ä¸ªå“¥ä»¬æ€»ç»“çš„c++è¦ç‚¹ <a href="https://interview.huihut.com/" target="_blank" rel="noopener">https://interview.huihut.com/</a></p>
<ul>
<li><p><code>new</code> å’Œ <code>delete</code> ä¸ºä»€ä¹ˆè¦é…å¯¹ç”¨:</p>
<ul>
<li><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&#123;</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;;</span><br><span class="line">A *pa = <span class="keyword">new</span> A();</span><br><span class="line">A *pas = <span class="keyword">new</span> A[NUM]();</span><br></pre></td></tr></table></figure>
</li>
<li><p>delete []pas; //è¯¦ç»†æµç¨‹: delete[] pas ç”¨æ¥é‡Šæ”¾pasæŒ‡å‘çš„å†…å­˜ï¼ï¼è¿˜é€ä¸€è°ƒç”¨æ•°ç»„ä¸­æ¯ä¸ªå¯¹è±¡çš„destructorï¼ï¼</p>
</li>
<li>delete []pa; //ä¼šå‘ç”Ÿä»€ä¹ˆ, ç­”æ¡ˆæ˜¯è°ƒç”¨æœªçŸ¥æ¬¡æ•°çš„Açš„ææ„å‡½æ•°. å› ä¸ºdelete[]ä¼šå»é€šè¿‡pa+offsetæ‰¾ä¸€ä¸ªåŸºäºpaçš„åç§»é‡æ‰¾ä¸€ä¸ªå†…å­˜é‡Œçš„æ•°æ®, ä»–å‡å®šè¿™ä¸ªå†…å­˜é‡Œæ”¾äº†è¦è°ƒç”¨ææ„çš„æ¬¡æ•°nè¿™ä¸ªæ•°æ®, è€Œè¿™ä¸ªå†…å­˜é‡Œåˆ°åº•æ˜¯å¤šå°‘æ˜¯æœªçŸ¥çš„.</li>
<li>delete pas; //å“ªäº›æŒ‡é’ˆä¼šå˜æˆé‡æŒ‡é’ˆ, ç­”æ¡ˆæ˜¯paså’ŒA[0]ä¸­çš„æŒ‡é’ˆä¼šå˜æˆé‡æŒ‡é’ˆ. å› ä¸ºåªæœ‰è¿™ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜è¢«é‡Šæ”¾äº†, ä¹Ÿå°±æ˜¯è¯´, ä»…é‡Šæ”¾äº†pasæŒ‡é’ˆæŒ‡å‘çš„è¿™ä¸ªæ•°ç»„çš„å…¨éƒ¨å†…å­˜ç©ºé—´, ä»¥åŠåªè°ƒç”¨äº†a[0]å¯¹è±¡çš„ææ„å‡½æ•°</li>
</ul>
</li>
<li>cqq vec set map list<ul>
<li><a href="/stl_vector_string/" title="vectorå’Œstringçš„å†…å­˜åˆ†é…ä¸ä½¿ç”¨æ³¨æ„ç‚¹">vectorå’Œstringçš„å†…å­˜åˆ†é…ä¸ä½¿ç”¨æ³¨æ„ç‚¹</a></li>
<li><a href="/stll_set_map_tutorial/" title="stlå…³è”å®¹å™¨çš„ç‰¹æ€§">stlå…³è”å®¹å™¨çš„ç‰¹æ€§</a></li>
</ul>
</li>
<li>mapçš„<code>[]</code>å’Œinsertçš„åŒºåˆ«?<ul>
<li>insert å«ä¹‰æ˜¯ï¼šå¦‚æœkeyå­˜åœ¨ï¼Œåˆ™æ’å…¥å¤±è´¥ï¼Œå¦‚æœkeyä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºè¿™ä¸ªkeyï¼valueã€‚å®ä¾‹: <code>map.insert((key, value))</code></li>
<li>åˆ©ç”¨ä¸‹æ ‡æ“ä½œçš„å«ä¹‰æ˜¯ï¼šå¦‚æœè¿™ä¸ªkeyå­˜åœ¨ï¼Œå°±æ›´æ–°valueï¼›å¦‚æœkeyä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºè¿™ä¸ªkeyï¼valueå¯¹ å®ä¾‹ï¼š<code>map[key] = value</code></li>
</ul>
</li>
<li>vectorçš„resizeå’Œreserveçš„åŒºåˆ«?<ul>
<li>æ€»ç»“: <ul>
<li>resizeæ—¢åˆ†é…äº†ç©ºé—´ï¼Œä¹Ÿåˆ›å»ºäº†å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡ä¸‹æ ‡è®¿é—®ã€‚å½“new_sizeå¤§äºåŸsize, åˆ™resizeæ—¢ä¿®æ”¹capacityå¤§å°ï¼Œä¹Ÿä¿®æ”¹sizeå¤§å°ã€‚å¦åˆ™åªä¿®æ”¹sizeå¤§å°.</li>
<li>reserveåªåˆ†é…äº†ç©ºé—´, ä¹Ÿå°±æ˜¯è¯´å®ƒåªä¿®æ”¹capacityå¤§å°ï¼Œä¸ä¿®æ”¹sizeå¤§å°, è‹¥ new_cap å°äºç­‰äºå½“å‰çš„ capacity(), å®ƒå•¥ä¹Ÿä¸å¹².</li>
</ul>
</li>
<li>resize: é‡è®¾å®¹å™¨å¤§å°ä»¥å®¹çº³ count ä¸ªå…ƒç´ ã€‚<br>  è‹¥å½“å‰å¤§å°å¤§äº count ï¼Œåˆ™å‡å°å®¹å™¨ä¸ºå…¶é¦– count ä¸ªå…ƒç´ ã€‚<br>  è‹¥å½“å‰å¤§å°å°äº count:<ul>
<li>åˆ™åé™„é¢å¤–çš„é»˜è®¤æ’å…¥çš„å…ƒç´ </li>
<li>åˆ™åé™„é¢å¤–çš„ value çš„å‰¯æœ¬</li>
</ul>
</li>
<li>reserve: å¢åŠ  vector çš„å®¹é‡åˆ°å¤§äºæˆ–ç­‰äº new_cap çš„å€¼ã€‚è‹¥ new_cap å¤§äºå½“å‰çš„ capacity() ï¼Œåˆ™åˆ†é…æ–°å­˜å‚¨ï¼Œ<strong>å¦åˆ™è¯¥æ–¹æ³•ä¸åšä»»ä½•äº‹</strong>ã€‚reserve() ä¸æ›´æ”¹ vector çš„ size ã€‚è‹¥ new_cap å¤§äº capacity() ï¼Œåˆ™æ‰€æœ‰è¿­ä»£å™¨ï¼ŒåŒ…å«å°¾åè¿­ä»£å™¨å’Œæ‰€æœ‰åˆ°å…ƒç´ çš„å¼•ç”¨éƒ½è¢«éæ³•åŒ–ã€‚å¦åˆ™ï¼Œæ²¡æœ‰è¿­ä»£å™¨æˆ–å¼•ç”¨è¢«éæ³•åŒ–ã€‚</li>
</ul>
</li>
<li>å­—èŠ‚å¯¹é½<ul>
<li><a href="/sizeof_struct/" title="å¯¹è±¡æ¨¡å‹ä¹‹å†…å­˜å¯¹é½åŸºç¡€">å¯¹è±¡æ¨¡å‹ä¹‹å†…å­˜å¯¹é½åŸºç¡€</a></li>
</ul>
</li>
<li><p>å®šä½new </p>
<ul>
<li><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">512</span>];   <span class="comment">//chunk of memoryå†…å­˜æ± </span></span><br><span class="line">    <span class="keyword">int</span> *p2, *p3;</span><br><span class="line">    <span class="comment">//å®šä½new:</span></span><br><span class="line">    p2 = <span class="keyword">new</span> (buffer) <span class="keyword">int</span>[<span class="number">10</span>];</span><br><span class="line">    p2[<span class="number">0</span>] = <span class="number">99</span>;</span><br><span class="line">    p2[<span class="number">1</span>] = <span class="number">88</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"buffer = "</span> &lt;&lt;(<span class="keyword">void</span> *)buffer &lt;&lt; <span class="built_in">endl</span>; <span class="comment">//å†…å­˜æ± åœ°å€</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"p2 = "</span> &lt;&lt; p2 &lt;&lt; <span class="built_in">endl</span>;             <span class="comment">//å®šä½newæŒ‡å‘çš„åœ°å€</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"p2[0] = "</span> &lt;&lt; p2[<span class="number">0</span>] &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    p3 = <span class="keyword">new</span> (buffer) <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">    p3[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    p3[<span class="number">1</span>] = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"p3 = "</span> &lt;&lt; p3 &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"p2[0] = "</span> &lt;&lt; p2[<span class="number">0</span>] &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"p2[1] = "</span> &lt;&lt; p2[<span class="number">1</span>] &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"p2[2] = "</span> &lt;&lt; p2[<span class="number">2</span>] &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"p2[3] = "</span> &lt;&lt; p2[<span class="number">3</span>] &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»“æœå‘ç°p3å’Œp2è¿˜æœ‰bufferéƒ½æ˜¯ä½¿ç”¨åŒæ ·çš„å†…å­˜åœ°å€ï¼Œç¬¦åˆæŒ‡å®šåœ°å€çš„å†…å­˜å—ï¼Œè€Œä¸”p3åœ¨æŒ‡å®šä½ç½®è¦†ç›–äº†p2çš„å‰ä¸¤å¤„çš„å€¼ã€‚</p>
</li>
</ul>
</li>
<li>c++ä¸€ä¸ªç©ºç±»ä¼šç”Ÿæˆä»€ä¹ˆ (ç­”: é»˜è®¤æ„é€ /ææ„(éè™š)/èµ‹å€¼è¿ç®—ç¬¦/é»˜è®¤æ‹·è´/å–åœ°å€/constå–åœ°å€) </li>
<li><p>è™šå‡½æ•°ï¼ˆvirtualï¼‰å¯ä»¥æ˜¯å†…è”å‡½æ•°ï¼ˆinlineï¼‰å—ï¼Ÿ</p>
<ul>
<li>è™šå‡½æ•°å¯ä»¥æ˜¯å†…è”å‡½æ•°ï¼Œå†…è”æ˜¯å¯ä»¥ä¿®é¥°è™šå‡½æ•°çš„ï¼Œä½†æ˜¯å½“è™šå‡½æ•°è¡¨ç°å¤šæ€æ€§çš„æ—¶å€™ä¸èƒ½å†…è”ã€‚</li>
<li>å†…è”æ˜¯åœ¨ç¼–è¯‘å™¨å»ºè®®ç¼–è¯‘å™¨å†…è”ï¼Œè€Œè™šå‡½æ•°çš„å¤šæ€æ€§åœ¨è¿è¡ŒæœŸï¼Œç¼–è¯‘å™¨æ— æ³•çŸ¥é“è¿è¡ŒæœŸè°ƒç”¨å“ªä¸ªä»£ç ï¼Œå› æ­¤è™šå‡½æ•°è¡¨ç°ä¸ºå¤šæ€æ€§æ—¶ï¼ˆè¿è¡ŒæœŸï¼‰ä¸å¯ä»¥å†…è”ã€‚</li>
<li>inline virtual å”¯ä¸€å¯ä»¥å†…è”çš„æ—¶å€™æ˜¯ï¼šç¼–è¯‘å™¨çŸ¥é“æ‰€è°ƒç”¨çš„å¯¹è±¡æ˜¯å“ªä¸ªç±»ï¼ˆå¦‚ Base::who()ï¼‰ï¼Œè¿™åªæœ‰åœ¨ç¼–è¯‘å™¨å…·æœ‰å®é™…å¯¹è±¡è€Œä¸æ˜¯å¯¹è±¡çš„æŒ‡é’ˆæˆ–å¼•ç”¨æ—¶æ‰ä¼šå‘ç”Ÿã€‚<br>è™šå‡½æ•°å†…è”ä½¿ç”¨:<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ­¤å¤„çš„è™šå‡½æ•° who()ï¼Œæ˜¯é€šè¿‡ç±»ï¼ˆBaseï¼‰çš„å…·ä½“å¯¹è±¡ï¼ˆbï¼‰æ¥è°ƒç”¨çš„ï¼Œ</span></span><br><span class="line"><span class="comment">// ç¼–è¯‘æœŸé—´å°±èƒ½ç¡®å®šäº†ï¼Œæ‰€ä»¥å®ƒå¯ä»¥æ˜¯å†…è”çš„ï¼Œ</span></span><br><span class="line"><span class="comment">// ä½†æœ€ç»ˆæ˜¯å¦å†…è”å–å†³äºç¼–è¯‘å™¨ã€‚ </span></span><br><span class="line">Base b;</span><br><span class="line">b.who();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ­¤å¤„çš„è™šå‡½æ•°æ˜¯é€šè¿‡æŒ‡é’ˆè°ƒç”¨çš„ï¼Œå‘ˆç°å¤šæ€æ€§ï¼Œ</span></span><br><span class="line"><span class="comment">// éœ€è¦åœ¨è¿è¡Œæ—¶æœŸé—´æ‰èƒ½ç¡®å®šï¼Œæ‰€ä»¥ä¸èƒ½ä¸ºå†…è”ã€‚  </span></span><br><span class="line">Base *ptr = <span class="keyword">new</span> Derived();</span><br><span class="line">ptr-&gt;who();</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>è™šå‡½æ•°æŒ‡é’ˆã€è™šå‡½æ•°è¡¨</p>
<ul>
<li>è™šå‡½æ•°æŒ‡é’ˆï¼šåœ¨å«æœ‰è™šå‡½æ•°ç±»çš„å¯¹è±¡ä¸­ï¼ŒæŒ‡å‘è™šå‡½æ•°è¡¨ï¼Œåœ¨è¿è¡Œæ—¶ç¡®å®šã€‚</li>
<li>è™šå‡½æ•°è¡¨ï¼šåœ¨ç¨‹åºå†…å­˜çš„<code>åªè¯»æ•°æ®æ®µ</code>ï¼ˆ.rodata sectionï¼Œè§ï¼š<a href="#CPPç›®æ ‡æ–‡ä»¶å†…å­˜å¸ƒå±€">CPPç›®æ ‡æ–‡ä»¶å†…å­˜å¸ƒå±€</a>ï¼‰ï¼Œå­˜æ”¾è™šå‡½æ•°æŒ‡é’ˆï¼Œå¦‚æœæ´¾ç”Ÿç±»å®ç°äº†åŸºç±»çš„æŸä¸ªè™šå‡½æ•°ï¼Œåˆ™åœ¨è™šè¡¨ä¸­è¦†ç›–åŸæœ¬åŸºç±»çš„é‚£ä¸ªè™šå‡½æ•°æŒ‡é’ˆï¼Œåœ¨ç¼–è¯‘æ—¶æ ¹æ®ç±»çš„å£°æ˜åˆ›å»ºã€‚</li>
<li>virtualä¿®é¥°ç¬¦:<br>  å¦‚æœä¸€ä¸ªç±»æ˜¯å±€éƒ¨å˜é‡åˆ™è¯¥ç±»æ•°æ®å­˜å‚¨åœ¨æ ˆåŒºï¼Œå¦‚æœä¸€ä¸ªç±»æ˜¯é€šè¿‡new/mallocåŠ¨æ€ç”³è¯·çš„ï¼Œåˆ™è¯¥ç±»æ•°æ®å­˜å‚¨åœ¨å †åŒºã€‚<br>  å¦‚æœè¯¥ç±»æ˜¯virutalç»§æ‰¿è€Œæ¥çš„å­ç±»ï¼Œåˆ™è¯¥ç±»çš„è™šå‡½æ•°è¡¨æŒ‡é’ˆå’Œè¯¥ç±»å…¶ä»–æˆå‘˜ä¸€èµ·å­˜å‚¨ã€‚è™šå‡½æ•°è¡¨æŒ‡é’ˆæŒ‡å‘åªè¯»æ•°æ®æ®µä¸­çš„ç±»è™šå‡½æ•°è¡¨ï¼Œè™šå‡½æ•°è¡¨ä¸­å­˜æ”¾ç€ä¸€ä¸ªä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå‡½æ•°æŒ‡é’ˆæŒ‡å‘ä»£ç æ®µä¸­çš„å…·ä½“å‡½æ•°ã€‚</li>
<li><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/cpp/virtual_func_1.jpg" alt></li>
</ul>
</li>
<li><p>å†…å­˜æ³„æ¼çš„å·¥å…· vargrid..? è¿˜æœ‰å•¥å·¥å…·</p>
</li>
<li>äº†è§£ASANæŸ¥æ‰¾å†…å­˜è¶Šç•Œé—®é¢˜ </li>
<li>cppæ‰¾æ‰¾å†°å·, å¤§æ¢¦é¾™å›¾çš„é¢è¯•é¢˜ï¼Œç½‘ä¸Šå¸¸ç”¨é¢˜</li>
<li>gdbæ€ä¹ˆåˆ‡æ¢çº¿ç¨‹</li>
<li>C++ çš„åŠ¨æ€å¤šæ€æ€ä¹ˆå®ç°çš„ï¼Ÿ</li>
<li>C++ çš„æ„é€ å‡½æ•°å¯ä»¥æ˜¯è™šå‡½æ•°å—ï¼Ÿ</li>
<li>æ— é”é˜Ÿåˆ—åŸç†æ˜¯å¦ä¸€å®šæ¯”æœ‰é”å¿«?(ä¸ä¸€å®š, å¦‚æœä¸´ç•ŒåŒºå°å› ä¸ºæœ‰ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ™mutexæ…¢, å†æ¥çœ‹lockfreeçš„spinï¼Œä¸€èˆ¬éƒ½éµå¾ªä¸€ä¸ªå›ºå®šçš„æ ¼å¼ï¼šå…ˆæŠŠä¸€ä¸ªä¸å˜çš„å€¼Xå­˜åˆ°æŸä¸ªå±€éƒ¨å˜é‡Aé‡Œï¼Œç„¶ååšä¸€äº›è®¡ç®—ï¼Œè®¡ç®—/ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œç„¶ååšä¸€ä¸ªCASæ“ä½œï¼Œåˆ¤æ–­Aå’ŒXè¿˜æ˜¯ä¸æ˜¯ç›¸ç­‰çš„ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆè¿™æ¬¡CASå°±ç®—æˆåŠŸäº†ï¼Œå¦åˆ™å†æ¥ä¸€éã€‚å¦‚æœä¸Šé¢è¿™ä¸ªloopé‡Œé¢â€œè®¡ç®—/ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯¹è±¡â€éå¸¸è€—æ—¶å¹¶ä¸”contentionå¾ˆä¸¥é‡ï¼Œé‚£ä¹ˆlockfreeæ€§èƒ½æœ‰æ—¶ä¼šæ¯”mutexå·®ã€‚å¦å¤–lockfreeä¸æ–­åœ°spinå¼•èµ·çš„CPUåŒæ­¥cachelineçš„å¼€é”€ä¹Ÿæ¯”mutexç‰ˆæœ¬çš„å¤§ã€‚å…³äºABAé—®é¢˜)</li>
</ul>
<h2 id="ç¼–è¯‘è¿‡ç¨‹"><a href="#ç¼–è¯‘è¿‡ç¨‹" class="headerlink" title="ç¼–è¯‘è¿‡ç¨‹"></a>ç¼–è¯‘è¿‡ç¨‹</h2><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="http://www.plantuml.com/plantuml/svg/YzQALT3LjLF8ICt9oTTBveg6yejBKZBpzJAueE8AkaMPwHabG8cNYrgUBcbvFg6D2we4h1mX2cSXj43Co5JWWZ7WCi_tJ7knVY8NX4BNa0XLduYGUBQn7QYM2qAXgy-7gi-7k6ZolcTzIxboCfEIGIOWH20KGdEYNdvf2G00">
<ol>
<li>é¢„å¤„ç†(Preprocessing): åšä¸€äº›ç±»ä¼¼äºå°†æ‰€æœ‰çš„<code>#define</code>åˆ é™¤ï¼Œå¹¶ä¸”å±•å¼€æ‰€æœ‰çš„å®å®šä¹‰çš„æ“ä½œ, ç„¶åç”Ÿæˆhello.i</li>
<li>ç¼–è¯‘(Compilation): ç¼–è¯‘è¿‡ç¨‹å°±æ˜¯æŠŠé¢„å¤„ç†å®Œçš„æ–‡ä»¶è¿›è¡Œä¸€ç³»åˆ—çš„è¯æ³•åˆ†æï¼Œè¯­æ³•åˆ†æï¼Œè¯­ä¹‰åˆ†æåŠä¼˜åŒ–åç”Ÿæˆç›¸åº”çš„æ±‡ç¼–ä»£ç ã€‚å¾—åˆ°hello.a</li>
<li>æ±‡ç¼–(Assembly): æ±‡ç¼–å™¨æ˜¯å°†æ±‡ç¼–ä»£ç è½¬å˜æˆæœºå™¨å¯ä»¥æ‰§è¡Œçš„å‘½ä»¤ï¼Œæ¯ä¸€ä¸ªæ±‡ç¼–è¯­å¥å‡ ä¹éƒ½å¯¹åº”ä¸€æ¡æœºå™¨æŒ‡ä»¤ã€‚æ±‡ç¼–ç›¸å¯¹äºç¼–è¯‘è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œæ ¹æ®æ±‡ç¼–æŒ‡ä»¤å’Œæœºå™¨æŒ‡ä»¤çš„å¯¹ç…§è¡¨ä¸€ä¸€ç¿»è¯‘å³å¯ã€‚å¾—åˆ°hello.o</li>
<li>é“¾æ¥(Linking): é€šè¿‡è°ƒç”¨é“¾æ¥å™¨ldæ¥é“¾æ¥ç¨‹åºè¿è¡Œéœ€è¦çš„ä¸€å¤§å †ç›®æ ‡æ–‡ä»¶ï¼Œä»¥åŠæ‰€ä¾èµ–çš„å…¶å®ƒåº“æ–‡ä»¶ï¼Œæœ€åç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶<ul>
<li>é™æ€é“¾æ¥: æŒ‡åœ¨ç¼–è¯‘é˜¶æ®µç›´æ¥æŠŠé™æ€åº“åŠ å…¥åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­å»ï¼Œè¿™æ ·å¯æ‰§è¡Œæ–‡ä»¶ä¼šæ¯”è¾ƒå¤§</li>
<li>åŠ¨æ€é“¾æ¥: æŒ‡é“¾æ¥é˜¶æ®µä»…ä»…åªåŠ å…¥ä¸€äº›æè¿°ä¿¡æ¯ï¼Œè€Œç¨‹åºæ‰§è¡Œæ—¶å†ä»ç³»ç»Ÿä¸­æŠŠç›¸åº”åŠ¨æ€åº“åŠ è½½åˆ°å†…å­˜ä¸­å»ã€‚</li>
</ul>
</li>
</ol>
<h2 id="ç›®æ ‡æ–‡ä»¶"><a href="#ç›®æ ‡æ–‡ä»¶" class="headerlink" title="ç›®æ ‡æ–‡ä»¶"></a>ç›®æ ‡æ–‡ä»¶</h2><p>ç¼–è¯‘å™¨ç¼–è¯‘æºä»£ç åç”Ÿæˆçš„æ–‡ä»¶å«åšç›®æ ‡æ–‡ä»¶ã€‚ç›®æ ‡æ–‡ä»¶ä»ç»“æ„ä¸Šè®²ï¼Œå®ƒæ˜¯å·²ç»ç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼Œåªæ˜¯è¿˜æ²¡æœ‰ç»è¿‡é“¾æ¥çš„è¿‡ç¨‹ï¼Œå…¶ä¸­å¯èƒ½æœ‰äº›ç¬¦å·æˆ–æœ‰äº›åœ°å€è¿˜æ²¡æœ‰è¢«è°ƒæ•´ã€‚</p>
<blockquote>
<p>å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆWindows çš„ <code>.exe</code> å’Œ Linux çš„ <code>ELF</code>ï¼‰ã€åŠ¨æ€é“¾æ¥åº“ï¼ˆWindows çš„ <code>.dll</code> å’Œ Linux çš„ <code>.so</code>ï¼‰ã€é™æ€é“¾æ¥åº“ï¼ˆWindows çš„ <code>.lib</code> å’Œ Linux çš„ <code>.a</code>ï¼‰éƒ½æ˜¯æŒ‰ç…§å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼å­˜å‚¨ï¼ˆWindows æŒ‰ç…§ PE-COFFï¼ŒLinux æŒ‰ç…§ ELFï¼‰</p>
</blockquote>
<p>ç›®æ ‡æ–‡ä»¶æ ¼å¼:  </p>
<ul>
<li>Windows çš„ PEï¼ˆPortable Executableï¼‰ï¼Œæˆ–ç§°ä¸º PE-COFFï¼Œ<code>.obj</code> æ ¼å¼</li>
<li>Linux çš„ ELFï¼ˆExecutable Linkable Formatï¼‰ï¼Œ<code>.o</code> æ ¼å¼</li>
<li>Intel/Microsoft çš„ OMFï¼ˆObject Module Formatï¼‰</li>
<li>Unix çš„ <code>a.out</code> æ ¼å¼</li>
<li>MS-DOS çš„ <code>.COM</code> æ ¼å¼</li>
</ul>
<blockquote>
<p>PE å’Œ ELF éƒ½æ˜¯ COFFï¼ˆCommon File Formatï¼‰çš„å˜ç§</p>
</blockquote>
<h3 id="CPPç›®æ ‡æ–‡ä»¶å†…å­˜å¸ƒå±€"><a href="#CPPç›®æ ‡æ–‡ä»¶å†…å­˜å¸ƒå±€" class="headerlink" title="CPPç›®æ ‡æ–‡ä»¶å†…å­˜å¸ƒå±€"></a>CPPç›®æ ‡æ–‡ä»¶å†…å­˜å¸ƒå±€</h3><table><thead><tr><th>æ®µ</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>File Header</td><td>æ–‡ä»¶å¤´ï¼Œæè¿°æ•´ä¸ªæ–‡ä»¶çš„æ–‡ä»¶å±æ€§ï¼ˆåŒ…æ‹¬æ–‡ä»¶æ˜¯å¦å¯æ‰§è¡Œã€æ˜¯é™æ€é“¾æ¥æˆ–åŠ¨æ€è¿æ¥åŠå…¥å£åœ°å€ã€ç›®æ ‡ç¡¬ä»¶ã€ç›®æ ‡æ“ä½œç³»ç»Ÿç­‰ï¼‰</td></tr><tr><td>.text section</td><td>ä»£ç æ®µï¼Œæ‰§è¡Œè¯­å¥ç¼–è¯‘æˆçš„æœºå™¨ä»£ç </td></tr><tr><td>.data section</td><td>æ•°æ®æ®µï¼Œå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡</td></tr><tr><td>.bss section</td><td>BSS æ®µï¼ˆBlock Started by Symbolï¼‰ï¼Œæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡ï¼ˆå› ä¸ºé»˜è®¤å€¼ä¸º 0ï¼Œæ‰€ä»¥åªæ˜¯åœ¨æ­¤é¢„ç•™ä½ç½®ï¼Œä¸å ç©ºé—´ï¼‰</td></tr><tr><td>.rodata section</td><td>åªè¯»æ•°æ®æ®µï¼Œå­˜æ”¾åªè¯»æ•°æ®ï¼Œä¸€èˆ¬æ˜¯ç¨‹åºé‡Œé¢çš„åªè¯»å˜é‡ï¼ˆå¦‚ const ä¿®é¥°çš„å˜é‡ï¼‰å’Œå­—ç¬¦ä¸²å¸¸é‡</td></tr><tr><td>.comment section</td><td>æ³¨é‡Šä¿¡æ¯æ®µï¼Œå­˜æ”¾ç¼–è¯‘å™¨ç‰ˆæœ¬ä¿¡æ¯</td></tr><tr><td>.note.GNU-stack section</td><td>å †æ ˆæç¤ºæ®µ</td></tr></tbody></table>


          
        
      


      

    
      <footer class="post-footer">
        

        

        

        
        
          <div class="post-eof"></div>
        
      </footer>
      
    </div>
    
    
    

    

    

    

  </div>
  
  
  
  </article>


      
    
      
        

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hulinhong.com/self_cultivation_linux_process/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mike">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ğŸš™">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/self_cultivation_linux_process/" itemprop="url">æœåŠ¡å™¨å¼€å‘è‡ªæˆ‘ä¿®å…»ä¸“æ -Linuxè¿›ç¨‹ç®¡ç†</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-08T19:08:06+00:00">
                03-08-2021
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Self-cultivation/" itemprop="url" rel="index">
                    <span itemprop="name">Self-cultivation</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    




    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      

      
      
        <div class="post-eof"></div>
      

      
      

      
        
          
            <h1 id="Linuxè¿›ç¨‹ç®¡ç†"><a href="#Linuxè¿›ç¨‹ç®¡ç†" class="headerlink" title="Linuxè¿›ç¨‹ç®¡ç†"></a>Linuxè¿›ç¨‹ç®¡ç†</h1><h2 id="è¯»è€…-å†™è€…é—®é¢˜"><a href="#è¯»è€…-å†™è€…é—®é¢˜" class="headerlink" title="è¯»è€…-å†™è€…é—®é¢˜"></a>è¯»è€…-å†™è€…é—®é¢˜</h2><p>å®šä¹‰ï¼š å…è®¸å¤šä¸ªè¿›ç¨‹åŒæ—¶å¯¹æ•°æ®è¿›è¡Œè¯»æ“ä½œï¼Œä½†æ˜¯ä¸å…è®¸è¯»å’Œå†™ä»¥åŠå†™å’Œå†™æ“ä½œåŒæ—¶å‘ç”Ÿã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š  </p>
<ul>
<li>è¯»è€…ä¼˜å…ˆ<br>  è¯»è¿›ç¨‹åªè¦çœ‹åˆ°æœ‰å…¶ä»–è¯»è¿›ç¨‹æ­£åœ¨è®¿é—®æ–‡ä»¶ï¼Œå°±å¯ä»¥ç»§ç»­ä½œè¯»è®¿é—®ï¼›å†™è¿›ç¨‹å¿…é¡»ç­‰å¾…æ‰€æœ‰è¯»è¿›ç¨‹éƒ½ä¸è®¿é—®æ—¶æ‰èƒ½å†™æ–‡ä»¶ï¼Œå³ä½¿å†™è¿›ç¨‹å¯èƒ½æ¯”ä¸€äº›è¯»è¿›ç¨‹æ›´æ—©æå‡ºç”³è¯·ã€‚</li>
<li>è¯»è€…å†™è€…å…¬å¹³ç«äº‰ï¼Œè€å®æ’é˜Ÿ<br>  å› ä¸ºè¯»è€…ä¼˜å…ˆçš„æ–¹æ¡ˆå¦‚æœåœ¨è¯»è®¿é—®éå¸¸é¢‘ç¹çš„åœºåˆï¼Œæœ‰å¯èƒ½é€ æˆå†™è¿›ç¨‹ä¸€ç›´æ— æ³•è®¿é—®æ–‡ä»¶çš„å±€é¢â€¦.ä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„äº§ç”Ÿï¼Œè¯»è€…å†™è€…è¯·æ±‚éƒ½è€å®æ’é˜Ÿï¼Œ æ’åˆ°è°å°±æ‰§è¡Œè°ï¼Œ ä¸å‡†è¯»è€…æ’é˜Ÿ</li>
<li>å†™è€…ä¼˜å…ˆ<br>  å¦‚æœæœ‰å†™è€…ç”³è¯·å†™æ–‡ä»¶ï¼Œé‚£ä¹ˆåœ¨ç”³è¯·ä¹‹å‰å·²ç»å¼€å§‹è¯»å–æ–‡ä»¶çš„å¯ä»¥ç»§ç»­è¯»å–ï¼Œä½†æ˜¯å¦‚æœå†æœ‰è¯»è€…ç”³è¯·è¯»å–æ–‡ä»¶ï¼Œåˆ™ä¸èƒ½å¤Ÿè¯»å–ï¼Œåªæœ‰åœ¨æ‰€æœ‰çš„å†™è€…å†™å®Œä¹‹åæ‰å¯ä»¥è¯»å–</li>
</ul>
<h2 id="å“²å­¦å®¶å°±é¤é—®é¢˜"><a href="#å“²å­¦å®¶å°±é¤é—®é¢˜" class="headerlink" title="å“²å­¦å®¶å°±é¤é—®é¢˜"></a>å“²å­¦å®¶å°±é¤é—®é¢˜</h2><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/an_illustration_of_the_dining_philosophers_problem.png" alt></p>
<p>5 ä¸ªæ²‰é»˜å¯¡è¨€çš„å“²å­¦å®¶å›´ååœ¨åœ†æ¡Œå‰ï¼Œæ¯äººé¢å‰ä¸€ç›˜æ„é¢ã€‚å‰å­æ”¾åœ¨å“²å­¦å®¶ä¹‹é—´çš„æ¡Œé¢ä¸Šã€‚ï¼ˆ5 ä¸ªå“²å­¦å®¶ï¼Œ5 æ ¹å‰å­ï¼‰</p>
<p>æ‰€æœ‰çš„å“²å­¦å®¶éƒ½åªä¼šåœ¨æ€è€ƒå’Œè¿›é¤ä¸¤ç§è¡Œä¸ºé—´äº¤æ›¿ã€‚å“²å­¦å®¶åªæœ‰åŒæ—¶æ‹¿åˆ°å·¦è¾¹å’Œå³è¾¹çš„å‰å­æ‰èƒ½åƒåˆ°é¢ï¼Œè€ŒåŒä¸€æ ¹å‰å­åœ¨åŒä¸€æ—¶é—´åªèƒ½è¢«ä¸€ä¸ªå“²å­¦å®¶ä½¿ç”¨ã€‚æ¯ä¸ªå“²å­¦å®¶åƒå®Œé¢åéƒ½éœ€è¦æŠŠå‰å­æ”¾å›æ¡Œé¢ä»¥ä¾›å…¶ä»–å“²å­¦å®¶åƒé¢ã€‚åªè¦æ¡ä»¶å…è®¸ï¼Œå“²å­¦å®¶å¯ä»¥æ‹¿èµ·å·¦è¾¹æˆ–è€…å³è¾¹çš„å‰å­ï¼Œä½†åœ¨æ²¡æœ‰åŒæ—¶æ‹¿åˆ°å·¦å³å‰å­æ—¶ä¸èƒ½è¿›é£Ÿã€‚</p>
<p>è®¾è®¡ä¸€ä¸ªè¿›é¤è§„åˆ™ï¼ˆå¹¶è¡Œç®—æ³•ï¼‰ä½¿å¾—æ¯ä¸ªå“²å­¦å®¶éƒ½ä¸ä¼šæŒ¨é¥¿ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ²¡æœ‰äººçŸ¥é“åˆ«äººä»€ä¹ˆæ—¶å€™æƒ³åƒä¸œè¥¿æˆ–æ€è€ƒçš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå“²å­¦å®¶éƒ½å¯ä»¥åœ¨åƒé¥­å’Œæ€è€ƒä¹‹é—´ä¸€ç›´äº¤æ›¿ä¸‹å»ã€‚</p>
<p>æ˜¾è€Œæ˜“è§ï¼Œ<strong>å¦‚æœä¸å°å¿ƒå¤„ç†ä¼šæœ‰æ­»é”ç°è±¡</strong>ï¼Œ æ¯”å¦‚ï¼šå½“æ¯ä¸ªç§‘å­¦å®¶éƒ½åŒæ—¶æ‹¿èµ·äº†å·¦è¾¹çš„ç­·å­æ—¶å€™æ­»é”å‘ç”Ÿäº†ï¼Œéƒ½æƒ³æ‹¿è‡ªå·±å³è¾¹çš„ç­·å­ï¼Œä½†æ˜¯ç§‘å­¦å®¶æ¯ä¸ªäººå·¦æ‰‹éƒ½ä¸æ¾æ‰‹ã€‚å¯¼è‡´éƒ½åƒä¸äº†é¥­</p>
<p><a href="https://zhuanlan.zhihu.com/p/34553097" target="_blank" rel="noopener">å‚è€ƒ</a><br>è§£å†³æ–¹æ¡ˆï¼š  </p>
<ul>
<li>è§„å®šå¥‡æ•°å·ç§‘å­¦å®¶å…ˆæ‹¿å·¦è¾¹çš„ç­·å­ï¼Œç„¶åæ‹¿å³è¾¹çš„ç­·å­ã€‚å¶æ•°å·ç§‘å­¦å®¶å…ˆæ‹¿å³è¾¹çš„ç­·å­ï¼Œç„¶åé‚£å·¦è¾¹çš„ç­·å­ã€‚å¯¼è‡´0ï¼Œ1ç§‘å­¦å®¶ç«äº‰1å·ç­·å­ï¼Œ2ï¼Œ3ç§‘å­¦å®¶ç«äº‰3å·ç­·å­ã€‚å››å·ç§‘å­¦å®¶æ— äººç«äº‰ã€‚æœ€åæ€»æœ‰ä¸€ä¸ªç§‘å­¦å®¶èƒ½è·å¾—ä¸¤åªç­·å­ã€‚</li>
<li>ä»…å½“ç§‘å­¦å®¶å·¦å³ä¸¤åªç­·å­éƒ½èƒ½ç”¨çš„æ—¶å€™ï¼Œæ‰å…è®¸ä»–è¿›é¤ï¼Œä»£ç é‡Œçš„ç”¨trylockæ¥å®ç°</li>
<li>è‡³å¤šå…è®¸å››ä¸ªå“²å­¦å®¶åŒæ—¶å»æ‹¿å·¦è¾¹çš„ç­·å­ï¼Œæœ€ç»ˆä¿è¯è‡³å°‘æœ‰ä¸€ä¸ªç§‘å­¦å®¶èƒ½è¿›é¤ï¼Œå¹¶ä¸”ç”¨å®Œä¹‹åé‡Šæ”¾ç­·å­ï¼Œä»è€Œä½¿æ›´å¤šçš„å“²å­¦å®¶èƒ½å¤Ÿæ‹¿åˆ°ç­·å­ã€‚</li>
</ul>
<h2 id="æ´»é”"><a href="#æ´»é”" class="headerlink" title="æ´»é”"></a>æ´»é”</h2><p>åœ¨æŸç§æƒ…å½¢ä¸‹ï¼Œè½®è¯¢ï¼ˆå¿™ç­‰å¾…ï¼‰å¯ç”¨äºè¿›å…¥ä¸´ç•ŒåŒºæˆ–å­˜å–èµ„æºã€‚é‡‡ç”¨è¿™ä¸€ç­–ç•¥çš„ä¸»è¦åŸå› æ˜¯ï¼Œç›¸æ¯”æ‰€åšçš„å·¥ä½œè€Œè¨€ï¼Œäº’æ–¥çš„æ—¶é—´å¾ˆçŸ­è€ŒæŒ‚èµ·ç­‰å¾…çš„æ—¶é—´å¼€é”€å¾ˆå¤§ã€‚è€ƒè™‘ä¸€ä¸ªåŸè¯­ï¼Œé€šè¿‡è¯¥åŸè¯­ï¼Œè°ƒç”¨è¿›ç¨‹æµ‹è¯•ä¸€ä¸ªäº’æ–¥ä¿¡å·é‡ï¼Œç„¶åæˆ–è€…å¾—åˆ°è¯¥ä¿¡å·é‡æˆ–è€…è¿”å›å¤±è´¥ä¿¡æ¯ã€‚</p>
<p>ç°åœ¨å‡è®¾æœ‰ä¸€å¯¹è¿›ç¨‹ä½¿ç”¨ä¸¤ç§èµ„æºã€‚æ¯ä¸ªè¿›ç¨‹éœ€è¦ä¸¤ç§èµ„æºï¼Œå®ƒä»¬åˆ©ç”¨è½®è¯¢åŸè¯­enter_regionå»å°è¯•å–å¾—å¿…è¦çš„é”ï¼Œå¦‚æœå°è¯•å¤±è´¥ï¼Œåˆ™è¯¥è¿›ç¨‹ç»§ç»­å°è¯•ã€‚å¦‚æœè¿›ç¨‹Aå…ˆè¿è¡Œå¹¶å¾—åˆ°èµ„æº1ï¼Œç„¶åè¿›ç¨‹2è¿è¡Œå¹¶å¾—åˆ°èµ„æº2ï¼Œä»¥åä¸ç®¡å“ªä¸€ä¸ªè¿›ç¨‹è¿è¡Œï¼Œéƒ½ä¸ä¼šæœ‰ä»»ä½•è¿›å±•ï¼Œä½†æ˜¯å“ªä¸€ä¸ªè¿›ç¨‹ä¹Ÿæ²¡æœ‰è¢«é˜»å¡ã€‚ç»“æœæ˜¯ä¸¤ä¸ªè¿›ç¨‹æ€»æ˜¯ä¸€å†æ¶ˆè€—å®Œåˆ†é…ç»™å®ƒä»¬çš„CPUé…é¢ï¼Œ<strong>ä½†æ˜¯æ²¡æœ‰è¿›å±•ä¹Ÿæ²¡æœ‰é˜»å¡</strong>ã€‚å› æ­¤ï¼Œæ²¡æœ‰å‡ºç°æ­»é”ç°è±¡ï¼ˆå› ä¸ºæ²¡æœ‰è¿›ç¨‹é˜»å¡ï¼‰ï¼Œä½†æ˜¯ä»ç°è±¡ä¸Šçœ‹å¥½åƒæ­»é”å‘ç”Ÿäº†ï¼Œè¿™å°±æ˜¯æ´»é”ï¼ˆlivelockï¼‰ã€‚</p>
<h2 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h2><p><a href="https://www.cyc2018.xyz/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%20-%20%E6%AD%BB%E9%94%81.html" target="_blank" rel="noopener">å‚è€ƒ</a></p>
<h3 id="å¿…è¦æ¡ä»¶"><a href="#å¿…è¦æ¡ä»¶" class="headerlink" title="å¿…è¦æ¡ä»¶"></a>å¿…è¦æ¡ä»¶</h3><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/dead_lock/dead_lock1.png" alt></p>
<p>(å£è¯€äº’å ä¸è¿˜ï¼Ÿ233):  </p>
<ul>
<li>äº’æ–¥ï¼šæ¯ä¸ªèµ„æºè¦ä¹ˆå·²ç»åˆ†é…ç»™äº†ä¸€ä¸ªè¿›ç¨‹ï¼Œè¦ä¹ˆå°±æ˜¯å¯ç”¨çš„ã€‚</li>
<li>å æœ‰å’Œç­‰å¾…ï¼šå·²ç»å¾—åˆ°äº†æŸä¸ªèµ„æºçš„è¿›ç¨‹å¯ä»¥å†è¯·æ±‚æ–°çš„èµ„æºã€‚</li>
<li>ä¸å¯æŠ¢å ï¼šå·²ç»åˆ†é…ç»™ä¸€ä¸ªè¿›ç¨‹çš„èµ„æºä¸èƒ½å¼ºåˆ¶æ€§åœ°è¢«æŠ¢å ï¼Œå®ƒåªèƒ½è¢«å æœ‰å®ƒçš„è¿›ç¨‹æ˜¾å¼åœ°é‡Šæ”¾ã€‚</li>
<li>ç¯è·¯ç­‰å¾…ï¼šæœ‰ä¸¤ä¸ªæˆ–è€…ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹ç»„æˆä¸€æ¡ç¯è·¯ï¼Œè¯¥ç¯è·¯ä¸­çš„æ¯ä¸ªè¿›ç¨‹éƒ½åœ¨ç­‰å¾…ä¸‹ä¸€ä¸ªè¿›ç¨‹æ‰€å æœ‰çš„èµ„æºã€‚</li>
</ul>
<h3 id="æ­»é”å¤„ç†æ–¹æ³•å¤§çº²"><a href="#æ­»é”å¤„ç†æ–¹æ³•å¤§çº²" class="headerlink" title="æ­»é”å¤„ç†æ–¹æ³•å¤§çº²"></a>æ­»é”å¤„ç†æ–¹æ³•å¤§çº²</h3><p>ä¸»è¦æœ‰ä»¥ä¸‹å››ç§æ–¹æ³•ï¼š  </p>
<ul>
<li>é¸µé¸Ÿç­–ç•¥</li>
<li>æ­»é”æ£€æµ‹ä¸æ­»é”æ¢å¤</li>
<li>æ­»é”é¢„é˜²</li>
<li>æ­»é”é¿å…</li>
</ul>
<h3 id="é¸µé¸Ÿç­–ç•¥"><a href="#é¸µé¸Ÿç­–ç•¥" class="headerlink" title="é¸µé¸Ÿç­–ç•¥"></a>é¸µé¸Ÿç­–ç•¥</h3><p>æŠŠå¤´åŸ‹åœ¨æ²™å­é‡Œï¼Œå‡è£…æ ¹æœ¬æ²¡å‘ç”Ÿé—®é¢˜ã€‚<br>å› ä¸ºè§£å†³æ­»é”é—®é¢˜çš„ä»£ä»·å¾ˆé«˜ï¼Œå› æ­¤é¸µé¸Ÿç­–ç•¥è¿™ç§ä¸é‡‡å–ä»»åŠ¡æªæ–½çš„æ–¹æ¡ˆä¼šè·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚å½“å‘ç”Ÿæ­»é”æ—¶ä¸ä¼šå¯¹ç”¨æˆ·é€ æˆå¤šå¤§å½±å“ï¼Œæˆ–å‘ç”Ÿæ­»é”çš„æ¦‚ç‡å¾ˆä½ï¼Œå¯ä»¥é‡‡ç”¨é¸µé¸Ÿç­–ç•¥ã€‚å¤§å¤šæ•°æ“ä½œç³»ç»Ÿï¼ŒåŒ…æ‹¬ Unixï¼ŒLinux å’Œ Windowsï¼Œå¤„ç†æ­»é”é—®é¢˜çš„åŠæ³•ä»…ä»…æ˜¯å¿½ç•¥å®ƒã€‚</p>
<h3 id="æ­»é”æ£€æµ‹ä¸æ­»é”æ¢å¤"><a href="#æ­»é”æ£€æµ‹ä¸æ­»é”æ¢å¤" class="headerlink" title="æ­»é”æ£€æµ‹ä¸æ­»é”æ¢å¤"></a>æ­»é”æ£€æµ‹ä¸æ­»é”æ¢å¤</h3><p>ä¸è¯•å›¾é˜»æ­¢æ­»é”ï¼Œè€Œæ˜¯å½“æ£€æµ‹åˆ°æ­»é”å‘ç”Ÿæ—¶ï¼Œé‡‡å–æªæ–½è¿›è¡Œæ¢å¤ã€‚</p>
<h4 id="æ¯ç§ç±»å‹ä¸€ä¸ªèµ„æºçš„æ­»é”æ£€æµ‹"><a href="#æ¯ç§ç±»å‹ä¸€ä¸ªèµ„æºçš„æ­»é”æ£€æµ‹" class="headerlink" title="æ¯ç§ç±»å‹ä¸€ä¸ªèµ„æºçš„æ­»é”æ£€æµ‹"></a>æ¯ç§ç±»å‹ä¸€ä¸ªèµ„æºçš„æ­»é”æ£€æµ‹</h4><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/dead_lock/dead_lock2.png" alt></p>
<p>ä¸Šå›¾ä¸ºèµ„æºåˆ†é…å›¾ï¼Œå…¶ä¸­æ–¹æ¡†è¡¨ç¤ºèµ„æºï¼Œåœ†åœˆè¡¨ç¤ºè¿›ç¨‹ã€‚èµ„æºæŒ‡å‘è¿›ç¨‹è¡¨ç¤ºè¯¥èµ„æºå·²ç»åˆ†é…ç»™è¯¥è¿›ç¨‹ï¼Œè¿›ç¨‹æŒ‡å‘èµ„æºè¡¨ç¤ºè¿›ç¨‹è¯·æ±‚è·å–è¯¥èµ„æºã€‚</p>
<p>å›¾ a å¯ä»¥æŠ½å–å‡ºç¯ï¼Œå¦‚å›¾ bï¼Œå®ƒæ»¡è¶³äº†ç¯è·¯ç­‰å¾…æ¡ä»¶ï¼Œå› æ­¤ä¼šå‘ç”Ÿæ­»é”ã€‚</p>
<p>æ¯ç§ç±»å‹ä¸€ä¸ªèµ„æºçš„æ­»é”æ£€æµ‹ç®—æ³•æ˜¯é€šè¿‡æ£€æµ‹æœ‰å‘å›¾æ˜¯å¦å­˜åœ¨ç¯æ¥å®ç°ï¼Œä»ä¸€ä¸ªèŠ‚ç‚¹å‡ºå‘è¿›è¡Œæ·±åº¦ä¼˜å…ˆæœç´¢ï¼Œå¯¹è®¿é—®è¿‡çš„èŠ‚ç‚¹è¿›è¡Œæ ‡è®°ï¼Œå¦‚æœè®¿é—®äº†å·²ç»æ ‡è®°çš„èŠ‚ç‚¹ï¼Œå°±è¡¨ç¤ºæœ‰å‘å›¾å­˜åœ¨ç¯ï¼Œä¹Ÿå°±æ˜¯æ£€æµ‹åˆ°æ­»é”çš„å‘ç”Ÿã€‚ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ç”¨æ‹“æ‰‘æ’åºæ€è·¯æ¥æ£€æµ‹å“ˆï¼‰</p>
<h4 id="æ¯ç§ç±»å‹å¤šä¸ªèµ„æºçš„æ­»é”æ£€æµ‹"><a href="#æ¯ç§ç±»å‹å¤šä¸ªèµ„æºçš„æ­»é”æ£€æµ‹" class="headerlink" title="æ¯ç§ç±»å‹å¤šä¸ªèµ„æºçš„æ­»é”æ£€æµ‹"></a>æ¯ç§ç±»å‹å¤šä¸ªèµ„æºçš„æ­»é”æ£€æµ‹</h4><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/dead_lock/dead_lock3.png" alt></p>
<p>ä¸Šå›¾ä¸­ï¼Œæœ‰ä¸‰ä¸ªè¿›ç¨‹å››ä¸ªèµ„æºï¼Œæ¯ä¸ªæ•°æ®ä»£è¡¨çš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>E å‘é‡ï¼šèµ„æºæ€»é‡</li>
<li>A å‘é‡ï¼šèµ„æºå‰©ä½™é‡</li>
<li>C çŸ©é˜µï¼šæ¯ä¸ªè¿›ç¨‹æ‰€æ‹¥æœ‰çš„èµ„æºæ•°é‡ï¼Œæ¯ä¸€è¡Œéƒ½ä»£è¡¨ä¸€ä¸ªè¿›ç¨‹æ‹¥æœ‰èµ„æºçš„æ•°é‡</li>
<li>R çŸ©é˜µï¼šæ¯ä¸ªè¿›ç¨‹è¯·æ±‚çš„èµ„æºæ•°é‡</li>
</ul>
<p>è¿›ç¨‹ P<sub>1</sub> å’Œ P<sub>2</sub> æ‰€è¯·æ±‚çš„èµ„æºéƒ½å¾—ä¸åˆ°æ»¡è¶³ï¼Œåªæœ‰è¿›ç¨‹ P<sub>3</sub> å¯ä»¥ï¼Œè®© P<sub>3</sub> æ‰§è¡Œï¼Œä¹‹åé‡Šæ”¾ P<sub>3</sub> æ‹¥æœ‰çš„èµ„æºï¼Œæ­¤æ—¶ A = (2 2 2 0)ã€‚P<sub>2</sub> å¯ä»¥æ‰§è¡Œï¼Œæ‰§è¡Œåé‡Šæ”¾ P<sub>2</sub> æ‹¥æœ‰çš„èµ„æºï¼ŒA = (4 2 2 1) ã€‚P<sub>1</sub> ä¹Ÿå¯ä»¥æ‰§è¡Œã€‚æ‰€æœ‰è¿›ç¨‹éƒ½å¯ä»¥é¡ºåˆ©æ‰§è¡Œï¼Œæ²¡æœ‰æ­»é”ã€‚</p>
<p>ç®—æ³•æ€»ç»“å¦‚ä¸‹ï¼š</p>
<p>æ¯ä¸ªè¿›ç¨‹æœ€å¼€å§‹æ—¶éƒ½ä¸è¢«æ ‡è®°ï¼Œæ‰§è¡Œè¿‡ç¨‹æœ‰å¯èƒ½è¢«æ ‡è®°ã€‚å½“ç®—æ³•ç»“æŸæ—¶ï¼Œä»»ä½•æ²¡æœ‰è¢«æ ‡è®°çš„è¿›ç¨‹éƒ½æ˜¯æ­»é”è¿›ç¨‹ã€‚</p>
<ol>
<li>å¯»æ‰¾ä¸€ä¸ªæ²¡æœ‰æ ‡è®°çš„è¿›ç¨‹ P<sub>i</sub>ï¼Œå®ƒæ‰€è¯·æ±‚çš„èµ„æºå°äºç­‰äº Aã€‚</li>
<li>å¦‚æœæ‰¾åˆ°äº†è¿™æ ·ä¸€ä¸ªè¿›ç¨‹ï¼Œé‚£ä¹ˆå°† C çŸ©é˜µçš„ç¬¬ i è¡Œå‘é‡åŠ åˆ° A ä¸­ï¼Œæ ‡è®°è¯¥è¿›ç¨‹ï¼Œå¹¶è½¬å› 1ã€‚</li>
<li>å¦‚æœæ²¡æœ‰è¿™æ ·ä¸€ä¸ªè¿›ç¨‹ï¼Œç®—æ³•ç»ˆæ­¢ã€‚</li>
</ol>
<h4 id="æ­»é”æ¢å¤"><a href="#æ­»é”æ¢å¤" class="headerlink" title="æ­»é”æ¢å¤"></a>æ­»é”æ¢å¤</h4><ul>
<li>åˆ©ç”¨æŠ¢å æ¢å¤</li>
<li>åˆ©ç”¨å›æ»šæ¢å¤</li>
<li>é€šè¿‡æ€æ­»è¿›ç¨‹æ¢å¤</li>
</ul>
<h3 id="æ­»é”é¢„é˜²"><a href="#æ­»é”é¢„é˜²" class="headerlink" title="æ­»é”é¢„é˜²"></a>æ­»é”é¢„é˜²</h3><p>åœ¨ç¨‹åºè¿è¡Œä¹‹å‰é¢„é˜²å‘ç”Ÿæ­»é”ã€‚</p>
<ul>
<li>ç ´åäº’æ–¥æ¡ä»¶<br>  ä¾‹å¦‚å‡è„±æœºæ‰“å°æœºæŠ€æœ¯å…è®¸è‹¥å¹²ä¸ªè¿›ç¨‹åŒæ—¶è¾“å‡ºï¼Œå”¯ä¸€çœŸæ­£è¯·æ±‚ç‰©ç†æ‰“å°æœºçš„è¿›ç¨‹æ˜¯æ‰“å°æœºå®ˆæŠ¤è¿›ç¨‹ã€‚</li>
<li>ç ´åå æœ‰å’Œç­‰å¾…æ¡ä»¶<br>  ä¸€ç§å®ç°æ–¹å¼æ˜¯è§„å®šæ‰€æœ‰è¿›ç¨‹åœ¨å¼€å§‹æ‰§è¡Œå‰è¯·æ±‚æ‰€éœ€è¦çš„å…¨éƒ¨èµ„æºã€‚</li>
<li>ç ´åä¸å¯æŠ¢å æ¡ä»¶</li>
<li>ç ´åç¯è·¯ç­‰å¾…<br>  ç»™èµ„æºç»Ÿä¸€ç¼–å·ï¼Œè¿›ç¨‹åªèƒ½æŒ‰ç¼–å·é¡ºåºæ¥è¯·æ±‚èµ„æºã€‚</li>
</ul>
<h3 id="æ­»é”é¿å…"><a href="#æ­»é”é¿å…" class="headerlink" title="æ­»é”é¿å…"></a>æ­»é”é¿å…</h3><p>åœ¨ç¨‹åºè¿è¡Œæ—¶é¿å…å‘ç”Ÿæ­»é”ã€‚é¿å…æ­»é”çš„ä¸»è¦ç®—æ³•æ˜¯åŸºäºä¸€ä¸ªå®‰å…¨çŠ¶æ€çš„æ¦‚å¿µã€‚åœ¨æè¿°ç®—æ³•å‰ï¼Œæˆ‘ä»¬å…ˆè®¨è®ºæœ‰å…³å®‰å…¨çš„æ¦‚å¿µã€‚</p>
<h4 id="å®‰å…¨çŠ¶æ€çš„æ£€æµ‹"><a href="#å®‰å…¨çŠ¶æ€çš„æ£€æµ‹" class="headerlink" title="å®‰å…¨çŠ¶æ€çš„æ£€æµ‹"></a>å®‰å…¨çŠ¶æ€çš„æ£€æµ‹</h4><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/dead_lock/dead_lock4.png" alt></p>
<p>å›¾ a çš„ç¬¬äºŒåˆ— Has è¡¨ç¤ºå·²æ‹¥æœ‰çš„èµ„æºæ•°ï¼Œç¬¬ä¸‰åˆ— Max è¡¨ç¤ºæ€»å…±éœ€è¦çš„èµ„æºæ•°ï¼ŒFree è¡¨ç¤ºè¿˜æœ‰å¯ä»¥ä½¿ç”¨çš„èµ„æºæ•°ã€‚ä»å›¾ a å¼€å§‹å‡ºå‘ï¼Œå…ˆè®© B æ‹¥æœ‰æ‰€éœ€çš„æ‰€æœ‰èµ„æºï¼ˆå›¾ bï¼‰ï¼Œè¿è¡Œç»“æŸåé‡Šæ”¾ Bï¼Œæ­¤æ—¶ Free å˜ä¸º 5ï¼ˆå›¾ cï¼‰ï¼›æ¥ç€ä»¥åŒæ ·çš„æ–¹å¼è¿è¡Œ C å’Œ Aï¼Œä½¿å¾—æ‰€æœ‰è¿›ç¨‹éƒ½èƒ½æˆåŠŸè¿è¡Œï¼Œå› æ­¤å¯ä»¥ç§°å›¾ a æ‰€ç¤ºçš„çŠ¶æ€æ—¶å®‰å…¨çš„ã€‚</p>
<p><strong>å®‰å…¨çŠ¶æ€çš„å®šä¹‰</strong>ï¼šå¦‚æœæ²¡æœ‰æ­»é”å‘ç”Ÿï¼Œå¹¶ä¸”å³ä½¿æ‰€æœ‰è¿›ç¨‹çªç„¶è¯·æ±‚å¯¹èµ„æºçš„æœ€å¤§éœ€æ±‚ï¼Œä¹Ÿä»ç„¶<strong>å­˜åœ¨æŸç§è°ƒåº¦æ¬¡åº</strong>èƒ½å¤Ÿä½¿å¾—æ¯ä¸€ä¸ªè¿›ç¨‹è¿è¡Œå®Œæ¯•ï¼Œåˆ™ç§°è¯¥çŠ¶æ€æ˜¯å®‰å…¨çš„ã€‚</p>
<p>å®‰å…¨çŠ¶æ€çš„æ£€æµ‹ä¸æ­»é”çš„æ£€æµ‹ç±»ä¼¼ï¼Œå› ä¸ºå®‰å…¨çŠ¶æ€å¿…é¡»è¦æ±‚ä¸èƒ½å‘ç”Ÿæ­»é”ã€‚ä¸‹é¢çš„é“¶è¡Œå®¶ç®—æ³•ä¸æ­»é”æ£€æµ‹ç®—æ³•éå¸¸ç±»ä¼¼ï¼Œå¯ä»¥ç»“åˆç€åšå‚è€ƒå¯¹æ¯”ã€‚</p>
<h4 id="å•ä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•"><a href="#å•ä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•" class="headerlink" title="å•ä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•"></a>å•ä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•</h4><p>Dijkstraï¼ˆ1965ï¼‰æå‡ºäº†ä¸€ç§èƒ½å¤Ÿé¿å…æ­»é”çš„è°ƒåº¦ç®—æ³•ï¼Œç§°ä¸ºé“¶è¡Œå®¶ç®—æ³•ï¼ˆbankerâ€™s algorithmï¼‰ï¼Œ<br>ä¸€ä¸ªå°åŸé•‡çš„é“¶è¡Œå®¶ï¼Œä»–å‘ä¸€ç¾¤å®¢æˆ·åˆ†åˆ«æ‰¿è¯ºäº†ä¸€å®šçš„è´·æ¬¾é¢åº¦ï¼Œç®—æ³•è¦åšçš„æ˜¯åˆ¤æ–­å¯¹è¯·æ±‚çš„æ»¡è¶³æ˜¯å¦ä¼šè¿›å…¥ä¸å®‰å…¨çŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œå°±æ‹’ç»è¯·æ±‚ï¼›å¦åˆ™äºˆä»¥åˆ†é…ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/dead_lock/dead_lock5.png" alt></p>
<p>å®¢æˆ·ä»¬å„è‡ªåšè‡ªå·±çš„ç”Ÿæ„ï¼Œåœ¨æŸäº›æ—¶åˆ»éœ€è¦è´·æ¬¾ï¼ˆç›¸å½“äºè¯·æ±‚èµ„æºï¼‰ã€‚åœ¨æŸä¸€æ—¶åˆ»ï¼Œå…·ä½“æƒ…å†µå¦‚å›¾bæ‰€ç¤ºã€‚è¿™ä¸ªçŠ¶æ€æ˜¯å®‰å…¨çš„ï¼Œç”±äºä¿ç•™ç€2ä¸ªå•ä½ï¼Œé“¶è¡Œå®¶èƒ½å¤Ÿæ‹–å»¶é™¤äº†Cä»¥å¤–çš„å…¶ä»–è¯·æ±‚ã€‚å› è€Œå¯ä»¥è®©Cå…ˆå®Œæˆï¼Œç„¶åé‡Šæ”¾Cæ‰€å çš„4ä¸ªå•ä½èµ„æºã€‚æœ‰äº†è¿™4ä¸ªå•ä½èµ„æºï¼Œé“¶è¡Œå®¶å°±å¯ä»¥ç»™Dæˆ–Båˆ†é…æ‰€éœ€çš„è´·æ¬¾å•ä½ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<p>è€ƒè™‘å‡å¦‚å‘Bæä¾›äº†å¦ä¸€ä¸ªä»–æ‰€è¯·æ±‚çš„è´·æ¬¾å•ä½ï¼Œå¦‚å›¾bæ‰€ç¤ºï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æœ‰å¦‚å›¾cæ‰€ç¤ºçš„çŠ¶æ€ï¼Œè¯¥çŠ¶æ€æ˜¯ä¸å®‰å…¨çš„ã€‚å¦‚æœå¿½ç„¶æ‰€æœ‰çš„å®¢æˆ·éƒ½è¯·æ±‚æœ€å¤§çš„é™é¢ï¼Œè€Œé“¶è¡Œå®¶æ— æ³•æ»¡è¶³å…¶ä¸­ä»»ä½•ä¸€ä¸ªçš„è¦æ±‚ï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿæ­»é”ã€‚ä¸å®‰å…¨çŠ¶æ€å¹¶ä¸ä¸€å®šå¼•èµ·æ­»é”ï¼Œç”±äºå®¢æˆ·ä¸ä¸€å®šéœ€è¦å…¶æœ€å¤§è´·æ¬¾é¢åº¦ï¼Œä½†é“¶è¡Œå®¶ä¸æ•¢æŠ±è¿™ç§ä¾¥å¹¸å¿ƒç†ã€‚</p>
<p><strong>é“¶è¡Œå®¶ç®—æ³•å°±æ˜¯å¯¹æ¯ä¸€ä¸ªè¯·æ±‚è¿›è¡Œæ£€æŸ¥ï¼Œæ£€æŸ¥å¦‚æœæ»¡è¶³è¿™ä¸€è¯·æ±‚æ˜¯å¦ä¼šè¾¾åˆ°å®‰å…¨çŠ¶æ€ã€‚è‹¥æ˜¯ï¼Œé‚£ä¹ˆå°±æ»¡è¶³è¯¥è¯·æ±‚ï¼›è‹¥å¦ï¼Œé‚£ä¹ˆå°±æ¨è¿Ÿå¯¹è¿™ä¸€è¯·æ±‚çš„æ»¡è¶³ã€‚</strong>ä¸ºäº†çœ‹çŠ¶æ€æ˜¯å¦å®‰å…¨ï¼Œé“¶è¡Œå®¶çœ‹ä»–æ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æºæ»¡è¶³æŸä¸€ä¸ªå®¢æˆ·ã€‚å¦‚æœå¯ä»¥ï¼Œé‚£ä¹ˆè¿™ç¬”æŠ•èµ„è®¤ä¸ºæ˜¯èƒ½å¤Ÿæ”¶å›çš„ï¼Œå¹¶ä¸”æ¥ç€æ£€æŸ¥æœ€æ¥è¿‘æœ€å¤§é™é¢çš„ä¸€ä¸ªå®¢æˆ·ï¼Œä»¥æ­¤ç±»æ¨ã€‚å¦‚æœæ‰€æœ‰æŠ•èµ„æœ€ç»ˆéƒ½è¢«æ”¶å›ï¼Œé‚£ä¹ˆè¯¥çŠ¶æ€æ˜¯å®‰å…¨çš„ï¼Œæœ€åˆçš„è¯·æ±‚å¯ä»¥æ‰¹å‡†ã€‚</p>
<p>ä¸Šå›¾ c ä¸ºä¸å®‰å…¨çŠ¶æ€ï¼Œå› æ­¤ç®—æ³•ä¼šæ‹’ç»ä¹‹å‰çš„è¯·æ±‚ï¼Œä»è€Œé¿å…è¿›å…¥å›¾ c ä¸­çš„çŠ¶æ€ã€‚</p>
<h4 id="å¤šä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•"><a href="#å¤šä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•" class="headerlink" title="å¤šä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•"></a>å¤šä¸ªèµ„æºçš„é“¶è¡Œå®¶ç®—æ³•</h4><p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/dead_lock/dead_lock6.png" alt></p>
<p>å¯ä»¥æŠŠé“¶è¡Œå®¶ç®—æ³•è¿›è¡Œæ¨å¹¿ä»¥å¤„ç†å¤šä¸ªèµ„æº  </p>
<p>ä¸Šå›¾ä¸­æœ‰äº”ä¸ªè¿›ç¨‹ï¼Œå››ä¸ªèµ„æºã€‚å·¦è¾¹çš„å›¾è¡¨ç¤ºå·²ç»åˆ†é…çš„èµ„æºï¼Œå³è¾¹çš„å›¾è¡¨ç¤ºè¿˜éœ€è¦åˆ†é…çš„èµ„æºã€‚æœ€å³è¾¹çš„ Eã€P ä»¥åŠ A åˆ†åˆ«è¡¨ç¤ºï¼šæ€»èµ„æºã€å·²åˆ†é…èµ„æºä»¥åŠå¯ç”¨èµ„æºï¼Œæ³¨æ„è¿™ä¸‰ä¸ªä¸ºå‘é‡ï¼Œè€Œä¸æ˜¯å…·ä½“æ•°å€¼ï¼Œä¾‹å¦‚ A=(1020)ï¼Œè¡¨ç¤º 4 ä¸ªèµ„æºåˆ†åˆ«è¿˜å‰©ä¸‹ 1/0/2/0ã€‚</p>
<p>æ£€æŸ¥ä¸€ä¸ªçŠ¶æ€æ˜¯å¦å®‰å…¨çš„ç®—æ³•å¦‚ä¸‹ï¼š</p>
<ul>
<li>æŸ¥æ‰¾å³è¾¹çš„çŸ©é˜µæ˜¯å¦å­˜åœ¨ä¸€è¡Œå°äºç­‰äºå‘é‡ Aã€‚å¦‚æœä¸å­˜åœ¨è¿™æ ·çš„è¡Œï¼Œé‚£ä¹ˆç³»ç»Ÿå°†ä¼šå‘ç”Ÿæ­»é”ï¼ŒçŠ¶æ€æ˜¯ä¸å®‰å…¨çš„ã€‚</li>
<li>å‡è‹¥æ‰¾åˆ°è¿™æ ·ä¸€è¡Œï¼Œå°†è¯¥è¿›ç¨‹æ ‡è®°ä¸ºç»ˆæ­¢ï¼Œå¹¶å°†å…¶å·²åˆ†é…èµ„æºåŠ åˆ° A ä¸­ã€‚</li>
<li>é‡å¤ä»¥ä¸Šä¸¤æ­¥ï¼Œç›´åˆ°æ‰€æœ‰è¿›ç¨‹éƒ½æ ‡è®°ä¸ºç»ˆæ­¢ï¼Œåˆ™çŠ¶æ€æ—¶å®‰å…¨çš„ã€‚</li>
</ul>
<p>å¦‚æœä¸€ä¸ªçŠ¶æ€ä¸æ˜¯å®‰å…¨çš„ï¼Œéœ€è¦æ‹’ç»è¿›å…¥è¿™ä¸ªçŠ¶æ€ã€‚</p>
<h2 id="linuxè¿›ç¨‹è°ƒåº¦"><a href="#linuxè¿›ç¨‹è°ƒåº¦" class="headerlink" title="linuxè¿›ç¨‹è°ƒåº¦"></a>linuxè¿›ç¨‹è°ƒåº¦</h2><p>å‚è€ƒ <a href="https://juejin.im/post/6844903568613310477" target="_blank" rel="noopener">https://juejin.im/post/6844903568613310477</a></p>
<p>åœ¨Linuxä¸­ï¼Œçº¿ç¨‹å’Œè¿›ç¨‹ä¸€è§†åŒä»ï¼Œæ‰€ä»¥è®²åˆ°è¿›ç¨‹è°ƒåº¦ï¼Œä¹ŸåŒ…å«äº†çº¿ç¨‹è°ƒåº¦ã€‚</p>
<p>è°ƒåº¦åˆ†ä¸¤ç§:  </p>
<ul>
<li>éæŠ¢å å¼å¤šä»»åŠ¡<br>  é™¤éä»»åŠ¡è‡ªå·±ç»“æŸï¼Œå¦åˆ™å°†ä¼šä¸€ç›´æ‰§è¡Œã€‚</li>
<li><strong>æŠ¢å å¼å¤šä»»åŠ¡ï¼ˆLinuxç”¨çš„æ˜¯è¿™ç§)</strong><br>  è¿™ç§æƒ…å†µä¸‹ï¼Œç”±è°ƒåº¦ç¨‹åºæ¥å†³å®šä»€ä¹ˆæ—¶å€™åœæ­¢ä¸€ä¸ªè¿›ç¨‹çš„è¿è¡Œï¼Œè¿™ä¸ªå¼ºåˆ¶çš„æŒ‚èµ·åŠ¨ä½œå³ä¸º<strong>æŠ¢å </strong>ã€‚é‡‡ç”¨æŠ¢å å¼å¤šä»»åŠ¡çš„åŸºç¡€æ˜¯ä½¿ç”¨æ—¶é—´ç‰‡è½®è½¬æœºåˆ¶æ¥ä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…å¯ä»¥è¿è¡Œçš„æ—¶é—´å•ä½ã€‚</li>
</ul>
<p>Linuxæœ‰ä¸¤ç§ä¸åŒçš„è¿›ç¨‹ä¼˜å…ˆçº§èŒƒå›´:</p>
<ul>
<li>ä½¿ç”¨niceå€¼ï¼šè¶Šå¤§çš„niceå€¼æ„å‘³ç€æ›´ä½çš„ä¼˜å…ˆçº§ã€‚ (-19 ~ 20ä¹‹é—´)</li>
<li>å®æ—¶ä¼˜å…ˆçº§ï¼šå¯é…ç½®(é€šè¿‡å®æ—¶è°ƒåº¦API)ï¼Œè¶Šé«˜æ„å‘³ç€è¿›ç¨‹ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
</ul>
<p>ä»»ä½•å®æ—¶çš„è¿›ç¨‹ä¼˜å…ˆçº§éƒ½é«˜äºæ™®é€šçš„è¿›ç¨‹ï¼Œå› æ­¤ä¸Šé¢çš„ä¸¤ç§ä¼˜å…ˆçº§èŒƒå›´å¤„äºäº’ä¸ç›¸äº¤çš„èŒƒç•´ã€‚</p>
<p>æ—¶é—´ç‰‡ï¼šLinuxä¸­å¹¶ä¸æ˜¯ä»¥å›ºå®šçš„æ—¶é—´å€¼(å¦‚10ms)æ¥åˆ†é…æ—¶é—´ç‰‡çš„ï¼Œè€Œæ˜¯å°†å¤„ç†å™¨çš„ä½¿ç”¨æ¯”ä½œä¸ºâ€œæ—¶é—´ç‰‡â€åˆ’åˆ†ç»™è¿›ç¨‹ã€‚è¿™æ ·ï¼Œè¿›ç¨‹æ‰€è·å¾—çš„å®é™…CPUæ—¶é—´å°±å’Œç³»ç»Ÿçš„è´Ÿè½½å¯†åˆ‡ç›¸å…³ã€‚</p>
<p>Linuxå†…æ ¸æœ‰ä¸¤ä¸ªè°ƒåº¦ç±»ï¼š</p>
<ul>
<li>CFS(å®Œå…¨å…¬å¹³è°ƒåº¦å™¨Completely Fair Scheduler)</li>
<li>å®æ—¶è°ƒåº¦ç±»ã€‚</li>
</ul>
<h3 id="å…¬å¹³è°ƒåº¦CFS"><a href="#å…¬å¹³è°ƒåº¦CFS" class="headerlink" title="å…¬å¹³è°ƒåº¦CFS"></a>å…¬å¹³è°ƒåº¦CFS</h3><p>ä¸¾ä¸ªä¾‹å­æ¥åŒºåˆ†Unixè°ƒåº¦å’ŒCFS, æœ‰ä¸¤ä¸ªè¿è¡Œçš„ä¼˜å…ˆçº§ç›¸åŒçš„è¿›ç¨‹:</p>
<ul>
<li>åœ¨Unixä¸­å¯èƒ½æ˜¯æ¯ä¸ªå„æ‰§è¡Œ5msï¼Œæ‰§è¡ŒæœŸé—´å®Œå…¨å ç”¨å¤„ç†å™¨ï¼Œä½†åœ¨â€œç†æƒ³æƒ…å†µâ€ä¸‹ï¼Œåº”è¯¥æ˜¯ï¼Œèƒ½å¤Ÿåœ¨10mså†…åŒæ—¶è¿è¡Œä¸¤ä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªå ç”¨å¤„ç†å™¨ä¸€åŠçš„èƒ½åŠ›ã€‚</li>
<li>CFSçš„åšæ³•æ˜¯ï¼šCFS è°ƒåº¦ç¨‹åºå¹¶ä¸é‡‡ç”¨ä¸¥æ ¼è§„åˆ™æ¥ä¸ºä¸€ä¸ªä¼˜å…ˆçº§åˆ†é…æŸä¸ªé•¿åº¦çš„æ—¶é—´ç‰‡, åœ¨æ‰€æœ‰å¯è¿è¡Œè¿›ç¨‹çš„æ€»æ•°ä¸Šè®¡ç®—å‡ºä¸€ä¸ªè¿›ç¨‹åº”è¯¥è¿è¡Œçš„æ—¶é—´ï¼Œniceå€¼ä¸å†ä½œä¸ºæ—¶é—´ç‰‡åˆ†é…çš„æ ‡å‡†ï¼Œè€Œæ˜¯ç”¨äºå¤„ç†è®¡ç®—è·å¾—çš„å¤„ç†å™¨ä½¿ç”¨æƒé‡ã€‚</li>
</ul>
<p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬çš„ç³»ç»Ÿåªæœ‰ä¸¤ä¸ªè¿›ç¨‹åœ¨è¿è¡Œï¼Œä¸€ä¸ªæ˜¯æ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆI/Oæ¶ˆè€—å‹ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯è§†é¢‘è§£ç å™¨ï¼ˆå¤„ç†å™¨æ¶ˆè€—å‹ï¼‰ã€‚<br>ç†æƒ³çš„æƒ…å†µä¸‹ï¼Œæ–‡æœ¬ç¼–è¾‘å™¨åº”è¯¥å¾—åˆ°æ›´å¤šçš„å¤„ç†å™¨æ—¶é—´ï¼Œè‡³å°‘å½“å®ƒéœ€è¦å¤„ç†å™¨æ—¶ï¼Œå¤„ç†å™¨åº”è¯¥ç«‹åˆ»è¢«åˆ†é…ç»™å®ƒï¼ˆè¿™æ ·æ‰èƒ½å®Œæˆç”¨æˆ·çš„äº¤äº’ï¼‰ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€å½“æ–‡æœ¬ç¼–è¾‘å™¨è¢«å”¤é†’çš„æ—¶å€™ï¼Œå®ƒåº”è¯¥æŠ¢å è§†é¢‘è§£ç ç¨‹åºã€‚<br>æŒ‰ç…§æ™®é€šçš„æƒ…å†µï¼ŒOSåº”è¯¥åˆ†é…ç»™æ–‡æœ¬ç¼–è¾‘å™¨æ›´å¤§çš„ä¼˜å…ˆçº§å’Œæ›´å¤šçš„æ—¶é—´ç‰‡ï¼Œä½†åœ¨Linuxä¸­ï¼Œè¿™ä¸¤ä¸ªè¿›ç¨‹éƒ½æ˜¯æ™®é€šè¿›ç¨‹ï¼Œä»–ä»¬å…·æœ‰ç›¸åŒçš„niceå€¼ï¼Œå› æ­¤å®ƒä»¬å°†å¾—åˆ°ç›¸åŒçš„å¤„ç†å™¨ä½¿ç”¨æ¯”ï¼ˆ50%ï¼‰ã€‚<br>ä½†å®é™…çš„è¿è¡Œè¿‡ç¨‹ä¸­ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼ŸCFSå°†èƒ½å¤Ÿæ³¨æ„åˆ°ï¼Œæ–‡æœ¬ç¼–è¾‘å™¨ä½¿ç”¨çš„å¤„ç†å™¨æ—¶é—´æ¯”åˆ†é…ç»™å®ƒçš„è¦å°‘å¾—å¤šï¼ˆå› ä¸ºå¤§å¤šæ—¶é—´åœ¨ç­‰å¾…I/Oï¼‰ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œè¦å®ç°æ‰€æœ‰è¿›ç¨‹â€œå…¬å¹³â€åœ°åˆ†äº«å¤„ç†å™¨ï¼Œå°±ä¼šè®©æ–‡æœ¬ç¼–è¾‘å™¨åœ¨éœ€è¦è¿è¡Œæ—¶ç«‹åˆ»æŠ¢å è§†é¢‘è§£ç å™¨ï¼ˆæ¯æ¬¡éƒ½æ˜¯å¦‚æ­¤ï¼‰ã€‚</p>
<h3 id="å®æ—¶è°ƒåº¦"><a href="#å®æ—¶è°ƒåº¦" class="headerlink" title="å®æ—¶è°ƒåº¦"></a>å®æ—¶è°ƒåº¦</h3><p>Linuxè¿˜å®ç°äº† POS1Xå®æ—¶è°ƒåº¦æ‰©å±•ã€‚è¿™äº›æ‰©å±•å…è®¸åº”ç”¨ç¨‹åºç²¾ç¡®åœ°æ§åˆ¶å¦‚ä½•åˆ†é…CPU<br>ç»™è¿›ç¨‹ã€‚è¿ä½œåœ¨ä¸¤ä¸ªå®æ—¶è°ƒåº¦ç­–ç•¥</p>
<ul>
<li>SCHED RR ï¼ˆå¾ªç¯ï¼‰</li>
<li>SCHED FIFO ï¼ˆå…ˆå…¥å…ˆå‡ºï¼‰</li>
</ul>
<p>ä¸‹çš„è¿›ç¨‹çš„ä¼˜å…ˆçº§æ€»æ˜¯é«˜äºè¿ä½œåœ¨éå®æ—¶ç­–ç•¥ä¸‹çš„è¿›ç¨‹ã€‚å®æ—¶è¿›ç¨‹ä¼˜å…ˆçº§çš„å–å€¼èŒƒå›´ä¸º1 ï¼ˆä½ï¼‰ã€œ99<br>ï¼ˆé«˜ï¼‰ã€‚åªæœ‰è¿›ç¨‹å¤„äºå¯è¿è¡ŒçŠ¶æ€ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§æ›´é«˜çš„è¿›ç¨‹å°±ä¼šå®Œå…¨å°†ä¼˜å…ˆçº§ä½çš„è¿›ç¨‹æ’é™¤åœ¨<br>CPUä¹‹å¤–ã€‚è¿ä½œåœ¨SCHED_FIFOç­–ç•¥ä¸‹çš„è¿›ç¨‹ä¼šäº’æ–¥åœ°è®¿é—®CPUç›´åˆ°å®ƒæ‰§è¡Œç»ˆæ­¢æˆ–è‡ªåŠ¨é‡Šæ”¾<br>CPUæˆ–è¢«è¿›å…¥å¯è¿è¡ŒçŠ¶æ€çš„ä¼˜å…ˆçº§æ›´é«˜çš„è¿›ç¨‹æŠ¢å ã€‚ç±»ä¼¼çš„è§„åˆ™åŒæ ·é€‚ç”¨äºSCHED RRç­–ç•¥,<br>ä½†åœ¨è¯¥ç­–ç•¥ä¸‹ï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªè¿›ç¨‹è¿è¡ŒäºåŒæ ·çš„ä¼˜å…ˆçº§ä¸‹ï¼Œé‚£ä¹ˆCPUå°±ä¼šä»¥å¾ªç¯çš„æ–¹å¼è¢«è¿™<br>äº›è¿›ç¨‹å…±äº«ã€‚</p>
<p>å®æ—¶è°ƒåº¦é‡‡ç”¨ SCHED_FIFO æˆ– SCHED_RR å®æ—¶ç­–ç•¥æ¥è°ƒåº¦çš„ä»»ä½•ä»»åŠ¡ï¼Œä¸æ™®é€šï¼ˆéå®æ—¶çš„ï¼‰ä»»åŠ¡ç›¸æ¯”ï¼Œå…·æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚</p>
<p>Linux é‡‡ç”¨ä¸¤ä¸ªå•ç‹¬çš„ä¼˜å…ˆçº§èŒƒå›´ï¼Œä¸€ä¸ªç”¨äºå®æ—¶ä»»åŠ¡ï¼Œå¦ä¸€ä¸ªç”¨äºæ­£å¸¸ä»»åŠ¡ã€‚å®æ—¶ä»»åŠ¡åˆ†é…çš„é™æ€ä¼˜å…ˆçº§ä¸º 0ã€œ99ï¼Œè€Œæ­£å¸¸ä»»åŠ¡åˆ†é…çš„ä¼˜å…ˆçº§ä¸º 100ã€œ139ã€‚</p>
<p>è¿™ä¸¤ä¸ªå€¼åŸŸåˆå¹¶æˆä¸ºä¸€ä¸ªå…¨å±€çš„ä¼˜å…ˆçº§æ–¹æ¡ˆï¼Œå…¶ä¸­è¾ƒä½æ•°å€¼è¡¨æ˜è¾ƒé«˜çš„ä¼˜å…ˆçº§ã€‚æ­£å¸¸ä»»åŠ¡ï¼Œæ ¹æ®å®ƒä»¬çš„niceå€¼ï¼Œåˆ†é…ä¸€ä¸ªä¼˜å…ˆçº§ï¼›è¿™é‡Œ -20 çš„niceå€¼æ˜ å°„åˆ°ä¼˜å…ˆçº§ 100ï¼Œè€Œ +19 çš„niceå€¼æ˜ å°„åˆ° 139ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†è¿™ä¸ªæ–¹æ¡ˆã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/process_scheduler.jpg" alt></p>
<h2 id="linuxè½»é‡çº§è¿›ç¨‹LWP"><a href="#linuxè½»é‡çº§è¿›ç¨‹LWP" class="headerlink" title="linuxè½»é‡çº§è¿›ç¨‹LWP"></a>linuxè½»é‡çº§è¿›ç¨‹LWP</h2><p>å¯¹äºLinuxæ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œå®ƒå¯¹Threadçš„å®ç°æ–¹å¼æ¯”è¾ƒç‰¹æ®Šã€‚åœ¨Linuxå†…æ ¸ä¸­ï¼Œå…¶å®æ˜¯æ²¡æœ‰çº¿ç¨‹çš„æ¦‚å¿µçš„ï¼Œå®ƒæŠŠæ‰€æœ‰çš„çº¿ç¨‹å½“åšæ ‡å‡†çš„è¿›ç¨‹æ¥å®ç°ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>Linuxå†…æ ¸ï¼Œå¹¶æ²¡æœ‰ä¸ºçº¿ç¨‹æä¾›ä»»ä½•ç‰¹æ®Šçš„è°ƒåº¦è¯­ä¹‰ï¼Œä¹Ÿæ²¡æœ‰ä¸ºçº¿ç¨‹å®ç°ç‰¹å®šçš„æ•°æ®ç»“æ„ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œçº¿ç¨‹åªæ˜¯ä¸€ä¸ªä¸å…¶ä»–è¿›ç¨‹å…±äº«æŸäº›èµ„æºçš„è¿›ç¨‹ã€‚</strong>æ¯ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰ä¸€ä¸ªå”¯ä¸€çš„task_structç»“æ„ï¼ŒLinuxå†…æ ¸å®ƒä»…ä»…æŠŠçº¿ç¨‹å½“åšä¸€ä¸ªæ­£å¸¸çš„è¿›ç¨‹ï¼Œæˆ–è€…è¯´æ˜¯è½»é‡çº§è¿›ç¨‹ï¼ŒLWP(Lightweight processes)ã€‚</p>
<p>Linuxçº¿ç¨‹ä¸è¿›ç¨‹çš„åŒºåˆ«ï¼Œä¸»è¦ä½“ç°åœ¨èµ„æºå…±äº«ã€è°ƒåº¦ã€æ€§èƒ½å‡ ä¸ªæ–¹é¢ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹èµ„æºå…±äº«æ–¹é¢ã€‚ä¸Šé¢ä¹Ÿæåˆ°ï¼Œçº¿ç¨‹å…¶å®æ˜¯å…±äº«äº†æŸä¸€ä¸ªè¿›ç¨‹çš„èµ„æºï¼Œè¿™äº›èµ„æºåŒ…æ‹¬ï¼š</p>
<ul>
<li>å†…å­˜åœ°å€ç©ºé—´</li>
<li>è¿›ç¨‹åŸºç¡€ä¿¡æ¯</li>
<li>å¤§éƒ¨åˆ†æ•°æ®</li>
<li>æ‰“å¼€çš„æ–‡ä»¶</li>
<li>ä¿¡å·å¤„ç†</li>
<li>å½“å‰å·¥ä½œç›®å½•</li>
<li>ç”¨æˆ·å’Œç”¨æˆ·ç»„å±æ€§</li>
<li>â€¦</li>
</ul>
<p>å“ªäº›æ˜¯çº¿ç¨‹ç‹¬è‡ªæ‹¥æœ‰çš„å‘¢ï¼Ÿ</p>
<ul>
<li>çº¿ç¨‹ID</li>
<li>ä¸€ç³»åˆ—çš„å¯„å­˜å™¨</li>
<li>æ ˆçš„å±€éƒ¨å˜é‡å’Œè¿”å›åœ°å€</li>
<li>é”™è¯¯ç  errno</li>
<li>ä¿¡å·æ©ç </li>
<li>ä¼˜å…ˆçº§</li>
<li>â€¦</li>
</ul>
<p>è¿™é‡Œè¯´ä¸€ä¸ªé»‘ç§‘æŠ€ï¼Œçº¿ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„è°ƒç”¨æ ˆï¼Œé™¤äº†æ ˆä¹‹å¤–å…±äº«äº†å…¶ä»–æ‰€æœ‰çš„æ®µsegmentã€‚ä½†æ˜¯ç”±äºçº¿ç¨‹é—´å…±äº«äº†å†…å­˜ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªçº¿ç¨‹ï¼Œç†è®ºä¸Šæ˜¯å¯ä»¥è®¿é—®åˆ°å…¶ä»–çº¿ç¨‹çš„è°ƒç”¨æ ˆçš„ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªæŒ‡é’ˆå˜é‡ï¼Œå»è®¿é—®å…¶ä»–çº¿ç¨‹çš„å±€éƒ¨æ ˆå¸§ï¼Œä»¥è®¿é—®å…¶ä»–çº¿ç¨‹çš„å±€éƒ¨å˜é‡ã€‚</p>
<h3 id="LWPå¦‚ä½•åˆ›å»ºå‡ºæ¥"><a href="#LWPå¦‚ä½•åˆ›å»ºå‡ºæ¥" class="headerlink" title="LWPå¦‚ä½•åˆ›å»ºå‡ºæ¥"></a>LWPå¦‚ä½•åˆ›å»ºå‡ºæ¥</h3><p>é‚£ä¹ˆLinuxä¸­çº¿ç¨‹æ˜¯å¦‚ä½•åˆ›å»ºå‡ºæ¥çš„å‘¢ï¼Ÿä¸Šé¢ä¹Ÿæåˆ°ï¼Œåœ¨Linuxä¸­çº¿ç¨‹æ˜¯ä¸€ç§èµ„æºå…±äº«çš„æ–¹å¼ï¼Œå¯ä»¥åœ¨åˆ›å»ºè¿›ç¨‹çš„æ—¶å€™ï¼ŒæŒ‡å®šæŸäº›èµ„æºæ˜¯ä»å…¶ä»–è¿›ç¨‹å…±äº«çš„ï¼Œä»è€Œåœ¨æ¦‚å¿µä¸Šåˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ã€‚åœ¨Linuxä¸­ï¼Œå¯ä»¥é€šè¿‡cloneç³»ç»Ÿè°ƒç”¨æ¥åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ï¼Œå®ƒçš„å‡½æ•°ç­¾åå¦‚ä¸‹ï¼š<br><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line">int clone(int (*fn)(void *), void *child_stack, int flags, void *arg, ...);</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬åœ¨ä½¿ç”¨cloneåˆ›å»ºè¿›ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥æŒ‡æ˜ç›¸åº”çš„å‚æ•°ï¼Œæ¥å†³å®šå…±äº«æŸäº›èµ„æºï¼Œæ¯”å¦‚:<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">clone(CLONE_VM | CLONE_FS | CLONE_FILES | CLONE_SIGHAND, <span class="number">0</span>);</span><br></pre></td></tr></table></figure></p>
<p><strong>è¿™ä¸ªcloneç³»ç»Ÿè°ƒç”¨çš„è¡Œä¸ºç±»ä¼¼äºforkï¼Œä¸è¿‡æ–°åˆ›å»ºå‡ºæ¥çš„è¿›ç¨‹ï¼Œå®ƒçš„å†…å­˜åœ°å€ã€æ–‡ä»¶ç³»ç»Ÿèµ„æºã€æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦å’Œä¿¡å·å¤„ç†å™¨ï¼Œéƒ½æ˜¯å…±äº«çˆ¶è¿›ç¨‹çš„ã€‚æ¢å¥è¯è¯´ï¼Œè¿™ä¸ªæ–°åˆ›å»ºå‡ºæ¥çš„è¿›ç¨‹ï¼Œä¹Ÿè¢«å«åšLinux Thread</strong>ã€‚ä»è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¹Ÿå¯ä»¥çœ‹å‡º<strong>Linuxä¸­ï¼Œçº¿ç¨‹å…¶å®æ˜¯è¿›ç¨‹å®ç°èµ„æºå…±äº«çš„ä¸€ç§æ–¹å¼ã€‚</strong></p>
<p>åœ¨å†…æ ¸ä¸­ï¼Œcloneè°ƒç”¨ç»è¿‡å‚æ•°ä¼ é€’å’Œè§£é‡Šåä¼šè°ƒç”¨do_forkï¼Œè¿™ä¸ªæ ¸å†…å‡½æ•°åŒæ—¶ä¹Ÿæ˜¯forkã€vforkç³»ç»Ÿè°ƒç”¨çš„æœ€ç»ˆå®ç°ï¼š<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_fork</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> clone_flags, <span class="keyword">unsigned</span> <span class="keyword">long</span> stack_start, struct pt_regs* regs,<span class="keyword">unsigned</span> <span class="keyword">long</span> stack_size)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨do_forkä¸­ï¼Œä¸åŒçš„clone_flagså°†å¯¼è‡´ä¸åŒçš„è¡Œä¸ºï¼ˆå…±äº«ä¸åŒçš„èµ„æºï¼‰ï¼Œä¸‹é¢åˆ—ä¸¾å‡ ä¸ªflagçš„ä½œç”¨ã€‚ </p>
<ul>
<li>CLONE_VM<br>  å¦‚æœdo_forkæ—¶æŒ‡å®šäº†CLONE_VMå¼€å…³ï¼Œåˆ›å»ºçš„è½»é‡çº§è¿›ç¨‹çš„å†…å­˜ç©ºé—´å°†ä¼šå’Œçˆ¶è¿›ç¨‹æŒ‡å‘åŒä¸€ä¸ªåœ°å€ï¼Œå³åˆ›å»ºçš„è½»é‡çº§è¿›ç¨‹å°†ä¸çˆ¶è¿›ç¨‹å…±äº«å†…å­˜åœ°å€ç©ºé—´ã€‚</li>
<li>CLONE_FS<br>  å¦‚æœdo_forkæ—¶æŒ‡å®šäº†CLONE_FSå¼€å…³ï¼Œå¯¹äºè½»é‡çº§è¿›ç¨‹åˆ™ä¼šä¸çˆ¶è¿›ç¨‹å…±äº«ç›¸åŒçš„æ‰€åœ¨æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ç›®å½•å’Œå½“å‰ç›®å½•ä¿¡æ¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè½»é‡çº§è¿›ç¨‹æ²¡æœ‰ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„ä¿¡æ¯ï¼Œè¿›ç¨‹ä¸­ä»»ä½•ä¸€ä¸ªçº¿ç¨‹æ”¹å˜å½“å‰ç›®å½•ã€æ ¹ç›®å½•ç­‰ä¿¡æ¯éƒ½å°†ç›´æ¥å½±å“åˆ°å…¶ä»–çº¿ç¨‹ã€‚</li>
<li>CLONE_FILES<br>  å¦‚æœdo_forkæ—¶æŒ‡å®šäº†CLONE_FILESå¼€å…³ï¼Œåˆ›å»ºçš„è½»é‡çº§è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å°†ä¼šå…±äº«å·²ç»æ‰“å¼€çš„æ–‡ä»¶ã€‚è¿™ä¸€å…±äº«ä½¿å¾—ä»»ä½•çº¿ç¨‹éƒ½èƒ½è®¿é—®è¿›ç¨‹æ‰€ç»´æŠ¤çš„æ‰“å¼€æ–‡ä»¶ï¼Œå¯¹å®ƒä»¬çš„æ“ä½œä¼šç›´æ¥åæ˜ åˆ°è¿›ç¨‹ä¸­çš„å…¶ä»–çº¿ç¨‹ã€‚</li>
<li>CLONE_SIGHAND<br>  å¦‚æœdo_forkæ—¶æŒ‡å®šäº†CLONE_FILESå¼€å…³ï¼Œè½»é‡çº§è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å°†ä¼šå…±äº«å¯¹ä¿¡å·çš„å¤„ç†æ–¹å¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹çš„ä¿¡å·å¤„ç†æ–¹å¼å®Œå…¨ç›¸åŒï¼Œè€Œä¸”å¯ä»¥ç›¸äº’æ›´æ”¹ã€‚</li>
</ul>
<p>å°½ç®¡linuxæ”¯æŒè½»é‡çº§è¿›ç¨‹ï¼Œä½†å¹¶ä¸èƒ½è¯´å®ƒå°±æ”¯æŒå†…æ ¸çº¿ç¨‹ï¼Œå› ä¸ºlinuxçš„â€çº¿ç¨‹â€å’Œâ€è¿›ç¨‹â€å®é™…ä¸Šå¤„äºä¸€ä¸ªè°ƒåº¦å±‚æ¬¡ï¼Œå…±äº«ä¸€ä¸ªè¿›ç¨‹æ ‡è¯†ç¬¦ç©ºé—´ï¼Œè¿™ç§é™åˆ¶ä½¿å¾—ä¸å¯èƒ½åœ¨linuxä¸Šå®ç°å®Œå…¨æ„ä¹‰ä¸Šçš„POSIXçº¿ç¨‹æœºåˆ¶ï¼Œå› æ­¤ä¼—å¤šçš„linuxçº¿ç¨‹åº“å®ç°å°è¯•éƒ½åªèƒ½å°½å¯èƒ½å®ç°POSIXçš„ç»å¤§éƒ¨åˆ†è¯­ä¹‰ï¼Œå¹¶åœ¨åŠŸèƒ½ä¸Šå°½å¯èƒ½é€¼è¿‘ã€‚</p>
<h2 id="å¤šæ ¸CPUæ˜¯å¦èƒ½åŒæ—¶æ‰§è¡Œå¤šä¸ªè¿›ç¨‹ï¼Ÿ"><a href="#å¤šæ ¸CPUæ˜¯å¦èƒ½åŒæ—¶æ‰§è¡Œå¤šä¸ªè¿›ç¨‹ï¼Ÿ" class="headerlink" title="å¤šæ ¸CPUæ˜¯å¦èƒ½åŒæ—¶æ‰§è¡Œå¤šä¸ªè¿›ç¨‹ï¼Ÿ"></a>å¤šæ ¸CPUæ˜¯å¦èƒ½åŒæ—¶æ‰§è¡Œå¤šä¸ªè¿›ç¨‹ï¼Ÿ</h2><p>å¤šæ ¸çš„ä½œç”¨å°±æ˜¯æ¯ä¸ªCPUå¯ä»¥è°ƒåº¦ä¸åŒçš„ä»»åŠ¡â€œå¹¶è¡Œâ€æ‰§è¡Œã€‚æ³¨æ„ï¼Œè¿™é‡Œè¯´çš„æ˜¯â€œå¹¶è¡Œâ€ï¼Œè€Œä¸æ˜¯â€œå¹¶å‘â€ï¼Œæ‰€ä»¥é—®é¢˜çš„å›ç­”æ˜¯â€œèƒ½â€ã€‚</p>
<p>ç¬¬äºŒä¸ªé—®é¢˜ï¼Œâ€œåŒæ—¶æœ€å¤šæ‰§è¡Œå‡ ä¸ªè¿›ç¨‹â€œ?<br>è¿™é‡Œä½ æƒ³æè¿°çš„â€œåŒæ—¶â€çš„æ„æ€ï¼Œæ˜¯æŸä¸€ä¸ªç‰¹å®šæ—¶åˆ»å—ï¼Ÿå¦‚æœæ˜¯ï¼Œå¾ˆæ˜æ˜¾ï¼Œåœ¨æŸä¸€ç‰¹å®šæ—¶åˆ»ï¼Œæ¯ä¸ªæ ¸åªèƒ½è°ƒåº¦ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œï¼Œæ‰€ä»¥æœ‰å¤šå°‘ä¸ªæ ¸æœ€å¤šå°±å¯ä»¥è°ƒåº¦å¤šå°‘ä¸ªè¿›ç¨‹ï¼ˆæˆ–è€…è¯´æˆçº¿ç¨‹æ¯”è¾ƒå‡†ç¡®äº›ï¼‰ã€‚ä½†åœ¨ä¸€æ®µæ—¶é—´ä¹‹å†…ï¼Œæ¯ä¸ªæ ¸å¯ä»¥â€œå¹¶å‘â€è°ƒåº¦å¤šä¸ªä»»åŠ¡æ‰§è¡Œã€‚å¦‚ä½•â€œå¹¶å‘â€ï¼Œè¿™å°±æ˜¯ç”±ä¸åŒæ“ä½œç³»ç»Ÿçš„è¿›ç¨‹è°ƒåº¦ç­–ç•¥è§„å®šçš„äº†ï¼Œæ¯”å¦‚å¸¸è§Linuxçš„CFSè°ƒåº¦ç®—æ³•å’ŒWindowsçš„æŠ¢å å¼è°ƒåº¦ç®—æ³•ã€‚</p>
<h2 id="åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹çš„æ­¥éª¤"><a href="#åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹çš„æ­¥éª¤" class="headerlink" title="åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹çš„æ­¥éª¤"></a>åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹çš„æ­¥éª¤</h2><p>(ä¸¤forkä¸€set, uå·¥æ–‡dev)<br>æœ€å…³é”®çš„ä¸‰æ­¥éª¤:</p>
<ol>
<li><p>è°ƒç”¨forkï¼Œç„¶åä½¿çˆ¶è¿›ç¨‹exitã€‚<br>è™½ç„¶å­è¿›ç¨‹ç»§æ‰¿äº†çˆ¶è¿›ç¨‹çš„è¿›ç¨‹ç»„IDï¼Œä½†è·å¾—äº†ä¸€ä¸ªæ–°çš„è¿›ç¨‹IDï¼Œè¿™å°±ä¿è¯äº†å­è¿›ç¨‹ä¸æ˜¯ä¸€ä¸ªè¿›ç¨‹ç»„çš„ç»„é•¿è¿›ç¨‹ã€‚è¿™æ˜¯ä¸‹é¢å°†è¦è¿›è¡Œçš„setsidè°ƒç”¨çš„å…ˆå†³æ¡ä»¶ã€‚</p>
</li>
<li><p>è°ƒç”¨setsidåˆ›å»ºä¸€ä¸ªæ–°ä¼šè¯ã€‚<br>ä½¿è°ƒç”¨è¿›ç¨‹ï¼š(a)æˆä¸ºæ–°ä¼šè¯çš„é¦–è¿›ç¨‹ï¼Œ(b)æˆä¸ºä¸€ä¸ªæ–°è¿›ç¨‹ç»„çš„ç»„é•¿è¿›ç¨‹ï¼(c)æ²¡æœ‰æ§åˆ¶ç»ˆç«¯ã€‚ä¹Ÿå¯æ¦‚æ‹¬ä¸º : å¼€å¯ä¸€ä¸ªæ–°ä¼šè¯å¹¶é‡Šæ”¾å®ƒä¸æ§åˆ¶ç»ˆç«¯ä¹‹é—´çš„æ‰€æœ‰å…³è”å…³ç³»</p>
</li>
<li><p>å†æ¬¡forkå¹¶æ€æ‰é¦–è¿›ç¨‹.<br>è¿™æ ·å°±ç¡®ä¿äº†å­è¿›ç¨‹ä¸æ˜¯ä¸€ä¸ªä¼šè¯é¦–è¿›ç¨‹ï¼Œ æ ¹æ®linuxä¸­è·å–ç»ˆç«¯çš„è§„åˆ™ï¼ˆåªæœ‰ä¼šè¯é¦–è¿›ç¨‹æ‰èƒ½è¯·æ±‚ä¸€ä¸ªæ§åˆ¶ç»ˆç«¯ï¼‰ï¼Œ è¿™æ ·è¿›ç¨‹æ°¸è¿œä¸ä¼šé‡æ–°è¯·æ±‚ä¸€ä¸ªæ§åˆ¶ç»ˆç«¯</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">                   ä¼š      è¯</span><br><span class="line">                 /     |      \</span><br><span class="line">               /       |       \</span><br><span class="line">             /         |         \</span><br><span class="line">     å‰å°è¿›ç¨‹ç»„     åå°è¿›ç¨‹ç»„1     åå°è¿›ç¨‹ç»„2 ...</span><br><span class="line">   /    |   \     /    |   \      /    |   \</span><br><span class="line">è¿›ç¨‹1 è¿›ç¨‹2 ...  è¿›ç¨‹3 è¿›ç¨‹4 ...       ...</span><br></pre></td></tr></table></figure>
<h2 id="è¿›ç¨‹ç»„"><a href="#è¿›ç¨‹ç»„" class="headerlink" title="è¿›ç¨‹ç»„"></a>è¿›ç¨‹ç»„</h2><p>è¿›ç¨‹ç»„å°±æ˜¯ä¸€ç³»åˆ—ç›¸äº’å…³è”çš„è¿›ç¨‹é›†åˆï¼Œç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ªè¿›ç¨‹ä¹Ÿå¿…é¡»ä»å±äºæŸä¸€ä¸ªè¿›ç¨‹ç»„ï¼›æ¯ä¸ªè¿›ç¨‹ç»„ä¸­éƒ½ä¼šæœ‰ä¸€ä¸ªå”¯ä¸€çš„ ID(process group id)ï¼Œç®€ç§° PGIDï¼›PGID ä¸€èˆ¬ç­‰åŒäºè¿›ç¨‹ç»„çš„åˆ›å»ºè¿›ç¨‹çš„ Process IDï¼Œè€Œè¿™ä¸ªè¿›è¿›ç¨‹ä¸€èˆ¬ä¹Ÿä¼šè¢«ç§°ä¸ºè¿›ç¨‹ç»„å…ˆå¯¼ (process group leader)</p>
<h2 id="ä¼šè¯"><a href="#ä¼šè¯" class="headerlink" title="ä¼šè¯"></a>ä¼šè¯</h2><p>ä¼šè¯ï¼ˆsessionï¼‰æ˜¯ä¸€ä¸ªè‹¥å¹²è¿›ç¨‹ç»„çš„é›†åˆï¼ŒåŒæ ·çš„ï¼Œç³»ç»Ÿä¸­æ¯ä¸€ä¸ªè¿›ç¨‹ç»„ä¹Ÿéƒ½å¿…é¡»ä»å±äºæŸä¸€ä¸ªä¼šè¯ï¼›ä¸€ä¸ªä¼šè¯åªæ‹¥æœ‰æœ€å¤šä¸€ä¸ªæ§åˆ¶ç»ˆç«¯ï¼ˆä¹Ÿå¯ä»¥æ²¡æœ‰ï¼‰ï¼Œè¯¥ç»ˆç«¯ä¸ºä¼šè¯ä¸­æ‰€æœ‰è¿›ç¨‹ç»„ä¸­çš„è¿›ç¨‹æ‰€å…±ç”¨ã€‚ä¸€ä¸ªä¼šè¯ä¸­å‰å°è¿›ç¨‹ç»„åªä¼šæœ‰ä¸€ä¸ªï¼Œåªæœ‰å…¶ä¸­çš„è¿›ç¨‹æ‰å¯ä»¥å’Œæ§åˆ¶ç»ˆç«¯è¿›è¡Œäº¤äº’ï¼›é™¤äº†å‰å°è¿›ç¨‹ç»„å¤–çš„è¿›ç¨‹ç»„ï¼Œéƒ½æ˜¯åå°è¿›ç¨‹ç»„ï¼›å’Œè¿›ç¨‹ç»„å…ˆå¯¼ç±»ä¼¼ï¼Œä¼šè¯ä¸­ä¹Ÿæœ‰ä¼šè¯å…ˆå¯¼ (session leader) çš„æ¦‚å¿µï¼Œç”¨æ¥è¡¨ç¤ºå»ºç«‹èµ·åˆ°æ§åˆ¶ç»ˆç«¯è¿æ¥çš„è¿›ç¨‹ã€‚åœ¨æ‹¥æœ‰æ§åˆ¶ç»ˆç«¯çš„ä¼šè¯ä¸­ï¼Œsession leader ä¹Ÿè¢«ç§°ä¸ºæ§åˆ¶è¿›ç¨‹(controlling process)ï¼Œä¸€èˆ¬æ¥è¯´æ§åˆ¶è¿›ç¨‹ä¹Ÿå°±æ˜¯ç™»å…¥ç³»ç»Ÿçš„ shell è¿›ç¨‹(login shell)ï¼›</p>
<h2 id="æ€æ­»è¿›ç¨‹ç»„æˆ–ä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹"><a href="#æ€æ­»è¿›ç¨‹ç»„æˆ–ä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹" class="headerlink" title="æ€æ­»è¿›ç¨‹ç»„æˆ–ä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹"></a>æ€æ­»è¿›ç¨‹ç»„æˆ–ä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹</h2><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥ PGIDï¼Œé€šè¿‡ kill å‘½ä»¤å‘æ•´ä¸ªè¿›ç¨‹ç»„å‘é€ä¿¡å·ï¼š</p>
<p><code>kill -SIGTERM -- -19701</code></p>
<p>æˆ‘ä»¬ç”¨ä¸€ä¸ªè´Ÿæ•° -19701 å‘è¿›ç¨‹ç»„å‘é€ä¿¡å·ã€‚å¦‚æœæˆ‘ä»¬ä¼ é€’çš„æ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œè¿™ä¸ªæ•°å°†è¢«è§†ä¸ºè¿›ç¨‹ ID ç”¨äºç»ˆæ­¢è¿›ç¨‹ã€‚å¦‚æœæˆ‘ä»¬ä¼ é€’çš„æ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼Œå®ƒè¢«è§†ä¸º PGIDï¼Œç”¨äºç»ˆæ­¢æ•´ä¸ªè¿›ç¨‹ç»„ã€‚<br>è´Ÿæ•°æ¥è‡ªç³»ç»Ÿè°ƒç”¨çš„ç›´æ¥å®šä¹‰ã€‚</p>
<p>æ€æ­»ä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹ä¸ä¹‹å®Œå…¨ä¸åŒã€‚æœ‰äº›ç³»ç»Ÿæ²¡æœ‰ä¼šè¯ ID çš„æ¦‚å¿µã€‚å³ä½¿æ˜¯å…·æœ‰ä¼šè¯ ID çš„ç³»ç»Ÿï¼Œä¾‹å¦‚ Linuxï¼Œä¹Ÿæ²¡æœ‰æä¾›ç³»ç»Ÿè°ƒç”¨æ¥ç»ˆæ­¢ä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹ã€‚ä½ éœ€è¦éå† /proc è¾“å‡ºçš„è¿›ç¨‹æ ‘ï¼Œæ”¶é›†æ‰€æœ‰çš„ SIDï¼Œç„¶åä¸€ä¸€ç»ˆæ­¢è¿›ç¨‹ã€‚<br>Pgrep å®ç°äº†éå†ã€æ”¶é›†å¹¶é€šè¿‡ä¼šè¯ ID æ€æ­»è¿›ç¨‹çš„ç®—æ³•ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p>
<p><code>pkill -s &lt;SID&gt;</code></p>
<h2 id="SIGHUP"><a href="#SIGHUP" class="headerlink" title="SIGHUP"></a>SIGHUP</h2><p>SIGHUP ä¼šåœ¨ä»¥ä¸‹ 3 ç§æƒ…å†µä¸‹è¢«å‘é€ç»™ç›¸åº”çš„è¿›ç¨‹ï¼š</p>
<ul>
<li>ç»ˆç«¯å…³é—­æ—¶ï¼Œè¯¥ä¿¡å·è¢«å‘é€åˆ° session é¦–è¿›ç¨‹ä»¥åŠä½œä¸º job æäº¤çš„è¿›ç¨‹ï¼ˆå³ç”¨ &amp; ç¬¦å·æäº¤çš„è¿›ç¨‹ï¼‰ï¼›</li>
<li>session é¦–è¿›ç¨‹é€€å‡ºæ—¶ï¼Œè¯¥ä¿¡å·è¢«å‘é€åˆ°è¯¥ session ä¸­çš„å‰å°è¿›ç¨‹ç»„ä¸­çš„æ¯ä¸€ä¸ªè¿›ç¨‹ï¼›</li>
<li>è‹¥çˆ¶è¿›ç¨‹é€€å‡ºå¯¼è‡´è¿›ç¨‹ç»„æˆä¸ºå­¤å„¿è¿›ç¨‹ç»„ï¼Œä¸”è¯¥è¿›ç¨‹ç»„ä¸­æœ‰è¿›ç¨‹å¤„äºåœæ­¢çŠ¶æ€ï¼ˆæ”¶åˆ° SIGSTOP æˆ– SIGTSTP ä¿¡å·ï¼‰ï¼Œè¯¥ä¿¡å·ä¼šè¢«å‘é€åˆ°è¯¥è¿›ç¨‹ç»„ä¸­çš„æ¯ä¸€ä¸ªè¿›ç¨‹ã€‚</li>
</ul>
<p>ä¾‹å¦‚ï¼šåœ¨æˆ‘ä»¬ç™»å½• Linux æ—¶ï¼Œç³»ç»Ÿä¼šåˆ†é…ç»™ç™»å½•ç”¨æˆ·ä¸€ä¸ªç»ˆç«¯ (Session)ã€‚åœ¨è¿™ä¸ªç»ˆç«¯è¿è¡Œçš„æ‰€æœ‰ç¨‹åºï¼ŒåŒ…æ‹¬å‰å°è¿›ç¨‹ç»„å’Œåå°è¿›ç¨‹ç»„ï¼Œä¸€èˆ¬éƒ½å±äºè¿™ä¸ª Sessionã€‚å½“ç”¨æˆ·é€€å‡º Linux ç™»å½•æ—¶ï¼Œå‰å°è¿›ç¨‹ç»„å’Œåå°æœ‰å¯¹ç»ˆç«¯è¾“å‡ºçš„è¿›ç¨‹å°†ä¼šæ”¶åˆ° SIGHUP ä¿¡å·ã€‚è¿™ä¸ªä¿¡å·çš„é»˜è®¤æ“ä½œä¸ºç»ˆæ­¢è¿›ç¨‹ï¼Œå› æ­¤å‰å°è¿›ç¨‹ç»„å’Œåå°æœ‰ç»ˆç«¯è¾“å‡ºçš„è¿›ç¨‹å°±ä¼šä¸­æ­¢ã€‚<br><strong>æ­¤å¤–ï¼Œå¯¹äºä¸ç»ˆç«¯è„±ç¦»å…³ç³»çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œæ­£å¸¸æƒ…å†µä¸‹æ˜¯æ°¸è¿œéƒ½æ”¶ä¸åˆ°è¿™ä¸ªä¿¡å·çš„, æ‰€ä»¥å¯ä»¥äººä¸ºçš„å‘SIGHUPä¿¡å·ç»™å¥¹ç”¨äºé€šçŸ¥å®ƒåšä¸€äº›æƒ³è¦çš„è‡ªå®šä¹‰çš„æ“ä½œ</strong>, æ¯”è¾ƒå¸¸è§çš„å¦‚é‡æ–°è¯»å–é…ç½®æ–‡ä»¶æ“ä½œã€‚ æ¯”å¦‚ xinetd è¶…çº§æœåŠ¡ç¨‹åºã€‚</p>
<h2 id="SIGCHLDä¸åƒµæ­»è¿›ç¨‹"><a href="#SIGCHLDä¸åƒµæ­»è¿›ç¨‹" class="headerlink" title="SIGCHLDä¸åƒµæ­»è¿›ç¨‹"></a>SIGCHLDä¸åƒµæ­»è¿›ç¨‹</h2><p>SIGCHLDä¿¡å·,å­è¿›ç¨‹ç»“æŸæ—¶, çˆ¶è¿›ç¨‹ä¼šæ”¶åˆ°è¿™ä¸ªä¿¡å·ã€‚å¦‚æœçˆ¶è¿›ç¨‹æ²¡æœ‰å¤„ç†è¿™ä¸ªä¿¡å·ï¼Œä¹Ÿæ²¡æœ‰ç­‰å¾…(waitpid)å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹è™½ç„¶ç»ˆæ­¢ï¼Œä½†æ˜¯è¿˜ä¼šåœ¨å†…æ ¸è¿›ç¨‹è¡¨ä¸­å æœ‰è¡¨é¡¹ï¼Œè¿™æ—¶çš„å­è¿›ç¨‹ç§°ä¸ºåƒµå°¸è¿›ç¨‹ã€‚è¿™ç§æƒ… å†µæˆ‘ä»¬åº”è¯¥æ•æ‰å®ƒï¼Œæˆ–è€…waitå®ƒæ´¾ç”Ÿçš„å­è¿›ç¨‹ï¼Œæˆ–è€…çˆ¶è¿›ç¨‹å…ˆç»ˆæ­¢ï¼Œè¿™æ—¶å­è¿›ç¨‹çš„ç»ˆæ­¢è‡ªåŠ¨ç”±initè¿›ç¨‹ æ¥æ¥ç®¡</p>
<h2 id="SIGPIPE"><a href="#SIGPIPE" class="headerlink" title="SIGPIPE"></a>SIGPIPE</h2><p>åœ¨ç½‘ç»œç¼–ç¨‹ä¸­ï¼ŒSIGPIPE è¿™ä¸ªä¿¡å·æ˜¯å¾ˆå¸¸è§çš„ã€‚å½“å¾€ä¸€ä¸ªå†™ç«¯å…³é—­çš„ç®¡é“æˆ– socket è¿æ¥ä¸­è¿ç»­å†™å…¥æ•°æ®æ—¶ä¼šå¼•å‘ SIGPIPE ä¿¡å·, å¼•å‘ SIGPIPE ä¿¡å·çš„å†™æ“ä½œå°†è®¾ç½® errno ä¸º EPIPEã€‚åœ¨ TCP é€šä¿¡ä¸­ï¼Œå½“é€šä¿¡çš„åŒæ–¹ä¸­çš„ä¸€æ–¹ close ä¸€ä¸ªè¿æ¥æ—¶ï¼Œè‹¥å¦ä¸€æ–¹æ¥ç€å‘æ•°æ®ï¼Œæ ¹æ® TCP åè®®çš„è§„å®šï¼Œä¼šæ”¶åˆ°ä¸€ä¸ª RST å“åº”æŠ¥æ–‡ï¼Œè‹¥å†å¾€è¿™ä¸ªæœåŠ¡å™¨å‘é€æ•°æ®æ—¶ï¼Œç³»ç»Ÿä¼šå‘å‡ºä¸€ä¸ª SIGPIPE ä¿¡å·ç»™è¿›ç¨‹ï¼Œå‘Šè¯‰è¿›ç¨‹è¿™ä¸ªè¿æ¥å·²ç»æ–­å¼€äº†ï¼Œä¸èƒ½å†å†™å…¥æ•°æ®ã€‚</p>
<p>å› ä¸º SIGPIPE ä¿¡å·çš„é»˜è®¤è¡Œä¸ºæ˜¯ç»“æŸè¿›ç¨‹ï¼Œè€Œæˆ‘ä»¬ç»å¯¹ä¸å¸Œæœ›å› ä¸ºå†™æ“ä½œçš„é”™è¯¯è€Œå¯¼è‡´ç¨‹åºé€€å‡ºï¼Œå°¤å…¶æ˜¯ä½œä¸ºæœåŠ¡å™¨ç¨‹åºæ¥è¯´å°±æ›´æ¶åŠ£äº†ã€‚æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å¯¹è¿™ç§ä¿¡å·åŠ ä»¥å¤„ç†ï¼Œåœ¨è¿™é‡Œï¼Œä»‹ç»å¤„ç† SIGPIPE ä¿¡å·çš„æ–¹å¼ï¼š</p>
<p>ä¸€èˆ¬ç»™ SIGPIPE è®¾ç½® SIG_IGN ä¿¡å·å¤„ç†å‡½æ•°ï¼Œå¿½ç•¥è¯¥ä¿¡å·:</p>
<p><code>signal(SIGPIPE, SIG_IGN);</code></p>
<p>å‰æ–‡è¯´è¿‡ï¼Œå¼•å‘ SIGPIPE ä¿¡å·çš„å†™æ“ä½œå°†è®¾ç½® errno ä¸º EPIPE,ã€‚æ‰€ä»¥ï¼Œç¬¬äºŒæ¬¡å¾€å…³é—­çš„ socket ä¸­å†™å…¥æ•°æ®æ—¶, ä¼šè¿”å› - 1, åŒæ—¶ errno ç½®ä¸º EPIPE. è¿™æ ·ï¼Œä¾¿èƒ½çŸ¥é“å¯¹ç«¯å·²ç»å…³é—­ï¼Œç„¶åè¿›è¡Œç›¸åº”å¤„ç†ï¼Œè€Œä¸ä¼šå¯¼è‡´æ•´ä¸ªè¿›ç¨‹é€€å‡º.</p>
<h2 id="å†…æ ¸æ€ä¸ç”¨æˆ·æ€çš„åŒºåˆ«"><a href="#å†…æ ¸æ€ä¸ç”¨æˆ·æ€çš„åŒºåˆ«" class="headerlink" title="å†…æ ¸æ€ä¸ç”¨æˆ·æ€çš„åŒºåˆ«"></a>å†…æ ¸æ€ä¸ç”¨æˆ·æ€çš„åŒºåˆ«</h2><ul>
<li>å†…æ ¸æ€ï¼šcpuå¯ä»¥è®¿é—®å†…å­˜çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬å¤–å›´è®¾å¤‡ï¼Œä¾‹å¦‚ç¡¬ç›˜ï¼Œç½‘å¡ï¼Œcpuä¹Ÿå¯ä»¥å°†è‡ªå·±ä»ä¸€ä¸ªç¨‹åºåˆ‡æ¢åˆ°å¦ä¸€ä¸ªç¨‹åºã€‚</li>
<li>ç”¨æˆ·æ€ï¼šåªèƒ½å—é™çš„è®¿é—®å†…å­˜ï¼Œä¸”ä¸å…è®¸è®¿é—®å¤–å›´è®¾å¤‡ï¼Œå ç”¨cpuçš„èƒ½åŠ›è¢«å‰¥å¤ºï¼Œcpuèµ„æºå¯ä»¥è¢«å…¶ä»–ç¨‹åºè·å–ã€‚</li>
</ul>
<p>ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€åˆ‡æ¢å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼ï¼š</p>
<ul>
<li>ç³»ç»Ÿè°ƒç”¨: å…¶å®ç³»ç»Ÿè°ƒç”¨æœ¬èº«å°±æ˜¯ä¸­æ–­ï¼Œä½†æ˜¯è½¯ä»¶ä¸­æ–­ï¼Œè·Ÿç¡¬ä¸­æ–­ä¸åŒã€‚</li>
<li>å¼‚å¸¸ï¼šå¦‚æœå½“å‰è¿›ç¨‹è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™å‘ç”Ÿäº†å¼‚å¸¸äº‹ä»¶ï¼Œå°±ä¼šè§¦å‘åˆ‡æ¢ã€‚ä¾‹å¦‚ï¼šç¼ºé¡µå¼‚å¸¸ã€‚</li>
<li>å¤–è®¾ä¸­æ–­ï¼šå½“å¤–è®¾å®Œæˆç”¨æˆ·çš„è¯·æ±‚æ—¶ï¼Œä¼šå‘CPUå‘é€ä¸­æ–­ä¿¡å·ã€‚</li>
</ul>

          
        
      


      

    
      <footer class="post-footer">
        

        

        

        
        
          <div class="post-eof"></div>
        
      </footer>
      
    </div>
    
    
    

    

    

    

  </div>
  
  
  
  </article>


      
    
      
        

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hulinhong.com/self_cultivation_linux_memory_manage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mike">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ğŸš™">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/self_cultivation_linux_memory_manage/" itemprop="url">æœåŠ¡å™¨å¼€å‘è‡ªæˆ‘ä¿®å…»ä¸“æ -Linuxå†…å­˜ç®¡ç†</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-03-08T19:08:06+00:00">
                03-08-2021
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Self-cultivation/" itemprop="url" rel="index">
                    <span itemprop="name">Self-cultivation</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    




    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      

      
      
        <div class="post-eof"></div>
      

      
      

      
        
          
            <h1 id="Linuxå†…å­˜ç®¡ç†"><a href="#Linuxå†…å­˜ç®¡ç†" class="headerlink" title="Linuxå†…å­˜ç®¡ç†"></a>Linuxå†…å­˜ç®¡ç†</h1><h2 id="ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿå†…å­˜"><a href="#ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿå†…å­˜" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿå†…å­˜"></a>ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿå†…å­˜</h2><p>è™šæ‹Ÿå†…å­˜çš„ç›®çš„æ˜¯ä¸ºäº†è®©ç‰©ç†å†…å­˜æ‰©å……æˆæ›´å¤§çš„é€»è¾‘å†…å­˜ï¼Œä»è€Œè®©ç¨‹åºè·å¾—æ›´å¤šçš„å¯ç”¨å†…å­˜ã€‚</p>
<p>ä¸ºäº†æ›´å¥½çš„ç®¡ç†å†…å­˜ï¼Œæ“ä½œç³»ç»Ÿå°†å†…å­˜æŠ½è±¡æˆåœ°å€ç©ºé—´ã€‚æ¯ä¸ªç¨‹åºæ‹¥æœ‰è‡ªå·±çš„åœ°å€ç©ºé—´ï¼Œè¿™ä¸ªåœ°å€ç©ºé—´è¢«åˆ†å‰²æˆå¤šä¸ªå—ï¼Œæ¯ä¸€å—ç§°ä¸ºä¸€é¡µã€‚è¿™äº›é¡µè¢«æ˜ å°„åˆ°ç‰©ç†å†…å­˜ï¼Œä½†ä¸éœ€è¦æ˜ å°„åˆ°è¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œä¹Ÿä¸éœ€è¦æ‰€æœ‰é¡µéƒ½å¿…é¡»åœ¨ç‰©ç†å†…å­˜ä¸­ã€‚å½“ç¨‹åºå¼•ç”¨åˆ°ä¸åœ¨ç‰©ç†å†…å­˜ä¸­çš„é¡µæ—¶ï¼Œç”±ç¡¬ä»¶æ‰§è¡Œå¿…è¦çš„æ˜ å°„ï¼Œå°†ç¼ºå¤±çš„éƒ¨åˆ†è£…å…¥ç‰©ç†å†…å­˜å¹¶é‡æ–°æ‰§è¡Œå¤±è´¥çš„æŒ‡ä»¤ã€‚</p>
<p>ä»ä¸Šé¢çš„æè¿°ä¸­å¯ä»¥çœ‹å‡ºï¼Œ<strong>è™šæ‹Ÿå†…å­˜å…è®¸ç¨‹åºä¸ç”¨å°†åœ°å€ç©ºé—´ä¸­çš„æ¯ä¸€é¡µéƒ½æ˜ å°„åˆ°ç‰©ç†å†…å­˜ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªç¨‹åºä¸éœ€è¦å…¨éƒ¨è°ƒå…¥å†…å­˜å°±å¯ä»¥è¿è¡Œï¼Œè¿™ä½¿å¾—æœ‰é™çš„å†…å­˜è¿è¡Œå¤§ç¨‹åºæˆä¸ºå¯èƒ½ã€‚</strong>ä¾‹å¦‚æœ‰ä¸€å°è®¡ç®—æœºå¯ä»¥äº§ç”Ÿ 16 ä½åœ°å€ï¼Œé‚£ä¹ˆä¸€ä¸ªç¨‹åºçš„åœ°å€ç©ºé—´èŒƒå›´æ˜¯ 0~64Kã€‚è¯¥è®¡ç®—æœºåªæœ‰ 32KB çš„ç‰©ç†å†…å­˜ï¼Œè™šæ‹Ÿå†…å­˜æŠ€æœ¯å…è®¸è¯¥è®¡ç®—æœºè¿è¡Œä¸€ä¸ª 64K å¤§å°çš„ç¨‹åºã€‚</p>
<h2 id="MMUå·¥ä½œåŸç†"><a href="#MMUå·¥ä½œåŸç†" class="headerlink" title="MMUå·¥ä½œåŸç†"></a>MMUå·¥ä½œåŸç†</h2><p>å†…å­˜ç®¡ç†å•å…ƒï¼ˆMMUï¼‰ç®¡ç†ç€åœ°å€ç©ºé—´å’Œç‰©ç†å†…å­˜çš„è½¬æ¢ï¼Œå…¶ä¸­çš„é¡µè¡¨ï¼ˆPage tableï¼‰å­˜å‚¨ç€é¡µï¼ˆç¨‹åºåœ°å€ç©ºé—´ï¼‰å’Œé¡µæ¡†ï¼ˆç‰©ç†å†…å­˜ç©ºé—´ï¼‰çš„æ˜ å°„è¡¨ã€‚</p>
<p>ä¸€ä¸ªè™šæ‹Ÿåœ°å€åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†:  </p>
<ul>
<li>ä¸€éƒ¨åˆ†å­˜å‚¨é¡µé¢å·ï¼Œ</li>
<li>ä¸€éƒ¨åˆ†å­˜å‚¨åç§»é‡ã€‚</li>
</ul>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/mmu_1.jpg" alt><br>ä¸Šå›¾çš„é¡µè¡¨å­˜æ”¾ç€ 16 ä¸ªé¡µï¼Œè¿™ 16 ä¸ªé¡µéœ€è¦ç”¨ 4 ä¸ªæ¯”ç‰¹ä½æ¥è¿›è¡Œç´¢å¼•å®šä½ã€‚ä¾‹å¦‚å¯¹äºè™šæ‹Ÿåœ°å€ï¼ˆ0010 000000000100ï¼‰ï¼Œå‰ 4 ä½æ˜¯å­˜å‚¨é¡µé¢å· 2ï¼Œè¯»å–è¡¨é¡¹å†…å®¹ä¸ºï¼ˆ110 1ï¼‰ï¼Œé¡µè¡¨é¡¹æœ€åä¸€ä½è¡¨ç¤ºæ˜¯å¦å­˜åœ¨äºå†…å­˜ä¸­ï¼Œ1 è¡¨ç¤ºå­˜åœ¨ã€‚å 12 ä½å­˜å‚¨åç§»é‡ã€‚è¿™ä¸ªé¡µå¯¹åº”çš„é¡µæ¡†çš„åœ°å€ä¸º ï¼ˆ110 000000000100ï¼‰ã€‚</p>
<h2 id="ä¸»æœºå­—èŠ‚åº"><a href="#ä¸»æœºå­—èŠ‚åº" class="headerlink" title="ä¸»æœºå­—èŠ‚åº"></a>ä¸»æœºå­—èŠ‚åº</h2><p>ä¸»æœºå­—èŠ‚åºåˆå« CPU å­—èŠ‚åºï¼Œå…¶ä¸æ˜¯ç”±æ“ä½œç³»ç»Ÿå†³å®šçš„ï¼Œè€Œæ˜¯ç”± CPU æŒ‡ä»¤é›†æ¶æ„å†³å®šçš„ã€‚ä¸»æœºå­—èŠ‚åºåˆ†ä¸ºä¸¤ç§ï¼š  </p>
<ul>
<li><strong>è®°å¿†æŠ€å·§</strong>: ä½åºåœ°å€å­˜äº†é«˜åºå­—èŠ‚å°±å«å¤§ç«¯, åä¹‹å°±å°ç«¯</li>
<li>å¤§ç«¯å­—èŠ‚åºï¼ˆBig Endianï¼‰ï¼šé«˜åºå­—èŠ‚å­˜å‚¨åœ¨ä½ä½åœ°å€ï¼Œä½åºå­—èŠ‚å­˜å‚¨åœ¨é«˜ä½åœ°å€, ç›®å‰ä¸»è¦æ˜¯ARM/PowerPCåœ¨ç”¨</li>
<li>å°ç«¯å­—èŠ‚åºï¼ˆLittle Endianï¼‰ï¼šä½åºå­—èŠ‚å­˜å‚¨åœ¨ä½ä½åœ°å€, é«˜åºå­—èŠ‚å­˜å‚¨åœ¨é«˜ä½åœ°å€ï¼Œç›®å‰ä¸»è¦æ˜¯Intelåœ¨ç”¨</li>
</ul>
<p>å­˜å‚¨æ–¹å¼:<br>32 ä½æ•´æ•° 0x12345678 æ˜¯ä»èµ·å§‹ä½ç½®ä¸º 0x00 çš„åœ°å€å¼€å§‹å­˜æ”¾ï¼Œåˆ™ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">å†…å­˜åœ°å€</th>
<th style="text-align:center">0x00</th>
<th style="text-align:center">0x01</th>
<th style="text-align:center">0x02</th>
<th style="text-align:center">0x03</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">å¤§ç«¯</td>
<td style="text-align:center">12</td>
<td style="text-align:center">34</td>
<td style="text-align:center">56</td>
<td style="text-align:center">78</td>
</tr>
<tr>
<td style="text-align:center">å°ç«¯</td>
<td style="text-align:center">78</td>
<td style="text-align:center">56</td>
<td style="text-align:center">34</td>
<td style="text-align:center">12</td>
</tr>
</tbody>
</table>
<h2 id="ç½‘ç»œå­—èŠ‚åº"><a href="#ç½‘ç»œå­—èŠ‚åº" class="headerlink" title="ç½‘ç»œå­—èŠ‚åº"></a>ç½‘ç»œå­—èŠ‚åº</h2><p>ç½‘ç»œå­—èŠ‚é¡ºåºæ˜¯ TCP/IP ä¸­è§„å®šå¥½çš„ä¸€ç§æ•°æ®è¡¨ç¤ºæ ¼å¼ï¼Œå®ƒä¸å…·ä½“çš„ CPU ç±»å‹ã€æ“ä½œç³»ç»Ÿç­‰æ— å…³ï¼Œä»è€Œå¯ä»¥ä¿è¯æ•°æ®åœ¨ä¸åŒä¸»æœºä¹‹é—´ä¼ è¾“æ—¶èƒ½å¤Ÿè¢«æ­£ç¡®è§£é‡Šã€‚</p>
<p>ç½‘ç»œå­—èŠ‚é¡ºåºé‡‡ç”¨ï¼šå¤§ç«¯ï¼ˆBig Endianï¼‰æ’åˆ—æ–¹å¼ã€‚</p>
<h2 id="Linuxè™šæ‹Ÿåœ°å€ç©ºé—´å¦‚ä½•åˆ†å¸ƒ"><a href="#Linuxè™šæ‹Ÿåœ°å€ç©ºé—´å¦‚ä½•åˆ†å¸ƒ" class="headerlink" title="Linuxè™šæ‹Ÿåœ°å€ç©ºé—´å¦‚ä½•åˆ†å¸ƒ"></a>Linuxè™šæ‹Ÿåœ°å€ç©ºé—´å¦‚ä½•åˆ†å¸ƒ</h2><p>Linux ä½¿ç”¨è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¤§å¤§å¢åŠ äº†è¿›ç¨‹çš„å¯»å€ç©ºé—´ï¼Œç”±ä½åœ°å€åˆ°é«˜åœ°å€(ä¸‹å›¾ä¸­ä»ä¸‹åˆ°ä¸Šå³ä¸ºä»ä½åˆ°é«˜)åˆ†åˆ«ä¸º(å£è¯€: æ–‡åˆå †æ ˆ)ï¼š</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/virtual_memory_mgr.jpeg" alt></p>
<ul>
<li>æ–‡æœ¬æ®µ(åªè¯»æ®µ)ï¼šè¯¥éƒ¨åˆ†ç©ºé—´åªèƒ½è¯»ï¼Œä¸å¯å†™ï¼›(åŒ…æ‹¬ï¼šä»£ç æ®µã€rodata æ®µ(Cå¸¸é‡å­—ç¬¦ä¸²å’Œ#defineå®šä¹‰çš„å¸¸é‡) )</li>
<li>æ•°æ®æ®µ(åˆå§‹åŒ–æ•°æ®æ®µä¸æœªåˆå§‹åŒ–æ•°æ®æ®µ)ï¼šä¿å­˜åˆå§‹åŒ–äº†çš„ä¸æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ã€é™æ€å˜é‡çš„ç©ºé—´ï¼›</li>
<li>å † ï¼šå°±æ˜¯å¹³æ—¶æ‰€è¯´çš„åŠ¨æ€å†…å­˜ï¼Œ malloc/new å¤§éƒ¨åˆ†éƒ½æ¥æºäºæ­¤ã€‚å…¶ä¸­å †é¡¶çš„ä½ç½®å¯é€šè¿‡å‡½æ•° brk å’Œ sbrk è¿›è¡ŒåŠ¨æ€è°ƒæ•´ã€‚</li>
<li>æ–‡ä»¶æ˜ å°„åŒºåŸŸ ï¼šå¦‚åŠ¨æ€åº“ã€å…±äº«å†…å­˜ç­‰æ˜ å°„ç‰©ç†ç©ºé—´çš„å†…å­˜ï¼Œä¸€èˆ¬æ˜¯ mmap å‡½æ•°æ‰€åˆ†é…çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</li>
<li>æ ˆï¼šç”¨äºç»´æŠ¤å‡½æ•°è°ƒç”¨çš„ä¸Šä¸‹æ–‡ç©ºé—´ï¼Œä¸€èˆ¬ä¸º 8M ï¼Œå¯é€šè¿‡ ulimit â€“s æŸ¥çœ‹ã€‚</li>
<li>å†…æ ¸è™šæ‹Ÿç©ºé—´ï¼šç”¨æˆ·ä»£ç ä¸å¯è§çš„å†…å­˜åŒºåŸŸï¼Œç”±å†…æ ¸ç®¡ç†(é¡µè¡¨å°±å­˜æ”¾åœ¨å†…æ ¸è™šæ‹Ÿç©ºé—´)ã€‚ä¸Šå›¾æ˜¯ 32 ä½ç³»ç»Ÿå…¸å‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†å¸ƒ(æ¥è‡ªã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹)ã€‚</li>
</ul>
<h2 id="brkå‡½æ•°"><a href="#brkå‡½æ•°" class="headerlink" title="brkå‡½æ•°"></a>brkå‡½æ•°</h2><p>å…ˆäº†è§£ï¼šbrk()å’Œsbrk()å‡½æ•°<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">brk</span><span class="params">( <span class="keyword">const</span> <span class="keyword">void</span> *addr )</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">sbrk</span> <span class="params">( <span class="keyword">intptr_t</span> incr )</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸¤ä¸ªå‡½æ•°çš„ä½œç”¨ä¸»è¦æ˜¯æ‰©å±•heapçš„ä¸Šç•Œbrkã€‚ç¬¬ä¸€ä¸ªå‡½æ•°çš„å‚æ•°ä¸ºè®¾ç½®çš„æ–°çš„brkä¸Šç•Œåœ°å€ï¼Œå¦‚æœæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1ã€‚ç¬¬äºŒä¸ªå‡½æ•°çš„å‚æ•°ä¸ºéœ€è¦ç”³è¯·çš„å†…å­˜çš„å¤§å°ï¼Œç„¶åè¿”å›heapæ–°çš„ä¸Šç•Œbrkåœ°å€ã€‚å¦‚æœsbrkçš„å‚æ•°ä¸º0ï¼Œåˆ™è¿”å›çš„ä¸ºåŸæ¥çš„brkåœ°å€ã€‚</p>
<h2 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h2><p>è™šæ‹Ÿå†…å­˜ç³»ç»Ÿé€šè¿‡å°†è™šæ‹Ÿå†…å­˜åˆ†å‰²ä¸ºç§°ä½œè™šæ‹Ÿé¡µ (Virtual Pageï¼ŒVP) å¤§å°å›ºå®šçš„å—ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯ä¸ªè™šæ‹Ÿé¡µçš„å¤§å°é»˜è®¤æ˜¯ 4096 å­—èŠ‚ã€‚åŒæ ·çš„ï¼Œç‰©ç†å†…å­˜ä¹Ÿè¢«åˆ†å‰²ä¸ºç‰©ç†é¡µ(Physical Pageï¼ŒPP)ï¼Œä¹Ÿä¸º 4096 å­—èŠ‚ã€‚</p>
<p>åœ¨ LINUX ä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ mmap ç”¨æ¥åœ¨è¿›ç¨‹è™šæ‹Ÿå†…å­˜åœ°å€ç©ºé—´ä¸­åˆ†é…åœ°å€ç©ºé—´ï¼Œåˆ›å»ºå’Œç‰©ç†å†…å­˜çš„æ˜ å°„å…³ç³»ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/mmap.jpg" alt="æ˜ å°„å…³ç³»"></p>
<p><strong>æ˜ å°„å…³ç³»å¯ä»¥åˆ†ä¸ºä¸¤ç§</strong>  </p>
<ol>
<li>æ–‡ä»¶æ˜ å°„<br> ç£ç›˜æ–‡ä»¶æ˜ å°„è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä½¿ç”¨æ–‡ä»¶å†…å®¹åˆå§‹åŒ–ç‰©ç†å†…å­˜ã€‚  </li>
<li>åŒ¿åæ˜ å°„<br> åˆå§‹åŒ–å…¨ä¸º 0 çš„å†…å­˜ç©ºé—´ã€‚</li>
</ol>
<p><strong>è€Œå¯¹äºæ˜ å°„å…³ç³»æ˜¯å¦å…±äº«åˆåˆ†ä¸º</strong>  </p>
<ol>
<li>ç§æœ‰æ˜ å°„ (MAP_PRIVATE)<br> å¤šè¿›ç¨‹é—´æ•°æ®å…±äº«ï¼Œä¿®æ”¹ä¸ååº”åˆ°ç£ç›˜å®é™…æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ª copy-on-writeï¼ˆå†™æ—¶å¤åˆ¶ï¼‰çš„æ˜ å°„æ–¹å¼ã€‚  </li>
<li>å…±äº«æ˜ å°„ (MAP_SHARED)<br> å¤šè¿›ç¨‹é—´æ•°æ®å…±äº«ï¼Œä¿®æ”¹ååº”åˆ°ç£ç›˜å®é™…æ–‡ä»¶ä¸­ã€‚</li>
</ol>
<p><strong>å› æ­¤æ€»ç»“èµ·æ¥æœ‰ 4 ç§ç»„åˆ</strong>  </p>
<ol>
<li>ç§æœ‰æ–‡ä»¶æ˜ å°„<br> å¤šä¸ªè¿›ç¨‹ä½¿ç”¨åŒæ ·çš„ç‰©ç†å†…å­˜é¡µè¿›è¡Œåˆå§‹åŒ–ï¼Œä½†æ˜¯å„ä¸ªè¿›ç¨‹å¯¹å†…å­˜æ–‡ä»¶çš„ä¿®æ”¹ä¸ä¼šå…±äº«ï¼Œä¹Ÿä¸ä¼šååº”åˆ°ç‰©ç†æ–‡ä»¶ä¸­</li>
<li>ç§æœ‰åŒ¿åæ˜ å°„<br> mmap ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ˜ å°„ï¼Œå„ä¸ªè¿›ç¨‹ä¸å…±äº«ï¼Œè¿™ç§ä½¿ç”¨ä¸»è¦ç”¨äºåˆ†é…å†…å­˜ (malloc åˆ†é…å¤§å†…å­˜ä¼šè°ƒç”¨ mmap)ã€‚<br> ä¾‹å¦‚å¼€è¾Ÿæ–°è¿›ç¨‹æ—¶ï¼Œä¼šä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…è™šæ‹Ÿçš„åœ°å€ç©ºé—´ï¼Œè¿™äº›è™šæ‹Ÿåœ°å€æ˜ å°„çš„ç‰©ç†å†…å­˜ç©ºé—´å„ä¸ªè¿›ç¨‹é—´è¯»çš„æ—¶å€™å…±äº«ï¼Œå†™çš„æ—¶å€™ä¼š copy-on-writeã€‚</li>
<li>å…±äº«æ–‡ä»¶æ˜ å°„<br> å¤šä¸ªè¿›ç¨‹é€šè¿‡è™šæ‹Ÿå†…å­˜æŠ€æœ¯å…±äº«åŒæ ·çš„ç‰©ç†å†…å­˜ç©ºé—´ï¼Œå¯¹å†…å­˜æ–‡ä»¶ çš„ä¿®æ”¹ä¼šååº”åˆ°å®é™…ç‰©ç†æ–‡ä»¶ä¸­ï¼Œä»–ä¹Ÿæ˜¯è¿›ç¨‹é—´é€šä¿¡ (IPC) çš„ä¸€ç§æœºåˆ¶ã€‚</li>
<li>å…±äº«åŒ¿åæ˜ å°„<br> è¿™ç§æœºåˆ¶åœ¨è¿›è¡Œ fork çš„æ—¶å€™ä¸ä¼šé‡‡ç”¨å†™æ—¶å¤åˆ¶ï¼Œçˆ¶å­è¿›ç¨‹å®Œå…¨å…±äº«åŒæ ·çš„ç‰©ç†å†…å­˜é¡µï¼Œè¿™ä¹Ÿå°±å®ç°äº†çˆ¶å­è¿›ç¨‹é€šä¿¡ (IPC).</li>
</ol>
<p><strong>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œmmap åªæ˜¯åœ¨è™šæ‹Ÿå†…å­˜åˆ†é…äº†åœ°å€ç©ºé—´ï¼Œåªæœ‰åœ¨ç¬¬ä¸€æ¬¡è®¿é—®è™šæ‹Ÿå†…å­˜çš„æ—¶å€™æ‰åˆ†é…ç‰©ç†å†…å­˜ã€‚</strong><br>åœ¨ mmap ä¹‹åï¼Œå¹¶æ²¡æœ‰åœ¨å°†æ–‡ä»¶å†…å®¹åŠ è½½åˆ°ç‰©ç†é¡µä¸Šï¼Œåªä¸Šåœ¨è™šæ‹Ÿå†…å­˜ä¸­åˆ†é…äº†åœ°å€ç©ºé—´ã€‚å½“è¿›ç¨‹åœ¨è®¿é—®è¿™æ®µåœ°å€æ—¶ï¼Œé€šè¿‡æŸ¥æ‰¾é¡µè¡¨ï¼Œå‘ç°è™šæ‹Ÿå†…å­˜å¯¹åº”çš„é¡µæ²¡æœ‰åœ¨ç‰©ç†å†…å­˜ä¸­ç¼“å­˜ï¼Œåˆ™äº§ç”Ÿ â€œç¼ºé¡µâ€ï¼Œç”±å†…æ ¸çš„ç¼ºé¡µå¼‚å¸¸å¤„ç†ç¨‹åºå¤„ç†ï¼Œå°†æ–‡ä»¶å¯¹åº”å†…å®¹ï¼Œä»¥é¡µä¸ºå•ä½ (4096) åŠ è½½åˆ°ç‰©ç†å†…å­˜ï¼Œæ³¨æ„æ˜¯åªåŠ è½½ç¼ºé¡µï¼Œä½†ä¹Ÿä¼šå—æ“ä½œç³»ç»Ÿä¸€äº›è°ƒåº¦ç­–ç•¥å½±å“ï¼ŒåŠ è½½çš„æ¯”æ‰€éœ€çš„å¤šã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> length, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags, <span class="keyword">int</span> fd, <span class="keyword">off_t</span> offset)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">munmap</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> length)</span></span>;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯fdå‚æ•°ï¼Œfdä¸ºæ˜ å°„çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¦‚æœæ˜¯åŒ¿åæ˜ å°„ï¼Œå¯ä»¥è®¾ä¸º-1ï¼›</p>
<ul>
<li>mmapå‡½æ•°ç¬¬ä¸€ç§ç”¨æ³•æ˜¯æ˜ å°„ç£ç›˜æ–‡ä»¶åˆ°å†…å­˜ä¸­ï¼›è€Œmallocä½¿ç”¨çš„æ˜¯mmapå‡½æ•°çš„ç¬¬äºŒç§ç”¨æ³•ï¼Œå³åŒ¿åæ˜ å°„ï¼ŒåŒ¿åæ˜ å°„ä¸æ˜ å°„ç£ç›˜æ–‡ä»¶ï¼Œè€Œæ˜¯å‘æ˜ å°„åŒºç”³è¯·ä¸€å—å†…å­˜ã€‚</li>
<li>munmapå‡½æ•°æ˜¯ç”¨äºé‡Šæ”¾å†…å­˜ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå†…å­˜é¦–åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå†…å­˜çš„é•¿åº¦ã€‚æ¥ä¸‹æ¥çœ‹ä¸‹mmapå‡½æ•°çš„å‚æ•°ã€‚</li>
</ul>
<p>ç”±äºbrk/sbrk/mmapå±äºç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚æœæ¯æ¬¡ç”³è¯·å†…å­˜ï¼Œéƒ½è°ƒç”¨è¿™ä¸‰ä¸ªå‡½æ•°ä¸­çš„ä¸€ä¸ªï¼Œé‚£ä¹ˆæ¯æ¬¡éƒ½è¦äº§ç”Ÿç³»ç»Ÿè°ƒç”¨å¼€é”€ï¼ˆå³cpuä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œè¿™é‡Œè¦ä¿å­˜ç”¨æˆ·æ€æ•°æ®ï¼Œç­‰ä¼šè¿˜è¦åˆ‡æ¢å›ç”¨æˆ·æ€ï¼‰ï¼Œè¿™æ˜¯éå¸¸å½±å“æ€§èƒ½çš„ï¼›å…¶æ¬¡ï¼Œè¿™æ ·ç”³è¯·çš„å†…å­˜å®¹æ˜“äº§ç”Ÿç¢ç‰‡ï¼Œå› ä¸ºå †æ˜¯ä»ä½åœ°å€åˆ°é«˜åœ°å€ï¼Œå¦‚æœä½åœ°å€çš„å†…å­˜æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œé«˜åœ°å€çš„å†…å­˜å°±ä¸èƒ½è¢«å›æ”¶ã€‚</p>
<h2 id="mallocå’ŒfreeåŸç†"><a href="#mallocå’ŒfreeåŸç†" class="headerlink" title="mallocå’ŒfreeåŸç†"></a>mallocå’ŒfreeåŸç†</h2><p>malloc: </p>
<ul>
<li><strong>å½“ç”³è¯·å°å†…å­˜çš„æ—¶ï¼Œmallocä½¿ç”¨sbrkåˆ†é…å†…å­˜</strong></li>
<li><strong>å½“ç”³è¯·å¤§å†…å­˜æ—¶ï¼Œä½¿ç”¨mmapå‡½æ•°ç”³è¯·å†…å­˜</strong></li>
<li><strong>ä½†æ˜¯è¿™åªæ˜¯åˆ†é…äº†è™šæ‹Ÿå†…å­˜ï¼Œè¿˜æ²¡æœ‰æ˜ å°„åˆ°ç‰©ç†å†…å­˜ï¼Œå½“è®¿é—®ç”³è¯·çš„å†…å­˜æ—¶ï¼Œæ‰ä¼šå› ä¸ºç¼ºé¡µå¼‚å¸¸ï¼Œå†…æ ¸åˆ†é…ç‰©ç†å†…å­˜ã€‚</strong></li>
<li>å°†æ‰€æœ‰ç©ºé—²å†…å­˜å—è¿æˆé“¾è¡¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹è®°å½•ç©ºé—²å†…å­˜å—çš„åœ°å€ã€å¤§å°ç­‰ä¿¡æ¯</li>
<li>åˆ†é…å†…å­˜æ—¶ï¼Œæ‰¾åˆ°å¤§å°åˆé€‚çš„å—ï¼Œåˆ‡æˆä¸¤ä»½ï¼Œä¸€åˆ†ç»™ç”¨æˆ·ï¼Œä¸€ä»½æ”¾å›ç©ºé—²é“¾è¡¨</li>
<li>freeæ—¶ï¼Œç›´æ¥æŠŠå†…å­˜å—è¿”å›é“¾è¡¨</li>
<li>è§£å†³å¤–éƒ¨ç¢ç‰‡ï¼šå°†èƒ½å¤Ÿåˆå¹¶çš„å†…å­˜å—è¿›è¡Œåˆå¹¶</li>
</ul>
<p>mallocå‡½æ•°çš„å®è´¨ä½“ç°åœ¨ï¼šå®ƒæœ‰ä¸€ä¸ªå°†å¯ç”¨çš„å†…å­˜å—è¿æ¥ä¸ºä¸€ä¸ªé•¿é•¿çš„åˆ—è¡¨çš„æ‰€è°“ç©ºé—²é“¾è¡¨ã€‚è°ƒç”¨mallocå‡½æ•°æ—¶ï¼Œå®ƒæ²¿è¿æ¥è¡¨å¯»æ‰¾ä¸€ä¸ªå¤§åˆ°è¶³ä»¥æ»¡è¶³ç”¨æˆ·è¯·æ±‚æ‰€éœ€è¦çš„å†…å­˜å—ã€‚ç„¶åï¼Œå°†è¯¥å†…å­˜å—ä¸€åˆ†ä¸ºäºŒï¼ˆä¸€å—çš„å¤§å°ä¸ç”¨æˆ·è¯·æ±‚çš„å¤§å°ç›¸ç­‰ï¼Œå¦ä¸€å—çš„å¤§å°å°±æ˜¯å‰©ä¸‹çš„å­—èŠ‚ï¼‰ã€‚æ¥ä¸‹æ¥ï¼Œå°†åˆ†é…ç»™ç”¨æˆ·çš„é‚£å—å†…å­˜ä¼ ç»™ç”¨æˆ·ï¼Œå¹¶å°†å‰©ä¸‹çš„é‚£å—ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰è¿”å›åˆ°è¿æ¥è¡¨ä¸Šã€‚</p>
<p>è¿™é‡Œæ³¨æ„ï¼Œmallocæ‰¾åˆ°çš„å†…å­˜å—å¤§å°ä¸€å®šæ˜¯ä¼šå¤§äºç­‰äºæˆ‘ä»¬éœ€è¦çš„å†…å­˜å¤§å°ï¼Œä¸‹é¢ä¼šæåˆ°å¦‚æœæ‰€æœ‰çš„å†…å­˜å—éƒ½æ¯”è¦æ±‚çš„å°ä¼šæ€ä¹ˆåŠï¼Ÿ</p>
<p><strong>è°ƒç”¨freeå‡½æ•°æ—¶ï¼Œå®ƒå°†ç”¨æˆ·é‡Šæ”¾çš„å†…å­˜å—è¿æ¥åˆ°ç©ºé—²é“¾ä¸Šã€‚åˆ°æœ€åï¼Œç©ºé—²é“¾ä¼šè¢«åˆ‡æˆå¾ˆå¤šçš„å°å†…å­˜ç‰‡æ®µï¼Œå¦‚æœè¿™æ—¶ç”¨æˆ·ç”³è¯·ä¸€ä¸ªå¤§çš„å†…å­˜ç‰‡æ®µï¼Œé‚£ä¹ˆç©ºé—²é“¾ä¸Šå¯èƒ½æ²¡æœ‰å¯ä»¥æ»¡è¶³ç”¨æˆ·è¦æ±‚çš„ç‰‡æ®µäº†ã€‚äºæ˜¯ï¼Œmallocå‡½æ•°è¯·æ±‚å»¶æ—¶ï¼Œå¹¶å¼€å§‹åœ¨ç©ºé—²é“¾ä¸Šç¿»ç®±å€’æŸœåœ°æ£€æŸ¥å„å†…å­˜ç‰‡æ®µï¼Œå¯¹å®ƒä»¬è¿›è¡Œæ•´ç†ï¼Œå°†ç›¸é‚»çš„å°ç©ºé—²å—åˆå¹¶æˆè¾ƒå¤§çš„å†…å­˜å—ã€‚</strong></p>
<p>åœ¨å¯¹å†…å­˜å—è¿›è¡Œäº† free è°ƒç”¨ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åšçš„æ˜¯è¯¸å¦‚å°†å®ƒä»¬æ ‡è®°ä¸ºæœªè¢«ä½¿ç”¨çš„ç­‰äº‹æƒ…ï¼Œå¹¶ä¸”ï¼Œåœ¨è°ƒç”¨ malloc æ—¶ï¼Œæˆ‘ä»¬è¦èƒ½å¤Ÿå®šä½æœªè¢«ä½¿ç”¨çš„å†…å­˜å—ã€‚å› æ­¤ï¼Œ mallocè¿”å›çš„æ¯å—å†…å­˜çš„èµ·å§‹å¤„é¦–å…ˆè¦æœ‰è¿™ä¸ªç»“æ„ï¼š</p>
<p>è¿™å°±è§£é‡Šäº†ï¼Œä¸ºä»€ä¹ˆåœ¨ç¨‹åºä¸­freeä¹‹åï¼Œä½†æ˜¯å †çš„å†…å­˜è¿˜æ˜¯æ²¡æœ‰é‡Šæ”¾ã€‚</p>
<p>å†…å­˜æ§åˆ¶å—ç»“æ„å®šä¹‰<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mem_control_block</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> is_available;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>ç°åœ¨ï¼Œæ‚¨å¯èƒ½ä¼šè®¤ä¸ºå½“ç¨‹åºè°ƒç”¨ malloc æ—¶è¿™ä¼šå¼•å‘é—®é¢˜ â€”â€” å®ƒä»¬å¦‚ä½•çŸ¥é“è¿™ä¸ªç»“æ„ï¼Ÿç­”æ¡ˆæ˜¯å®ƒä»¬ä¸å¿…çŸ¥é“ï¼›åœ¨è¿”å›æŒ‡é’ˆä¹‹å‰ï¼Œæˆ‘ä»¬ä¼šå°†å…¶ç§»åŠ¨åˆ°è¿™ä¸ªç»“æ„ä¹‹åï¼ŒæŠŠå®ƒéšè—èµ·æ¥ã€‚è¿™ä½¿å¾—è¿”å›çš„æŒ‡é’ˆæŒ‡å‘æ²¡æœ‰ç”¨äºä»»ä½•å…¶ä»–ç”¨é€”çš„å†…å­˜ã€‚é‚£æ ·ï¼Œä»è°ƒç”¨ç¨‹åºçš„è§’åº¦æ¥çœ‹ï¼Œå®ƒä»¬æ‰€å¾—åˆ°çš„å…¨éƒ¨æ˜¯ç©ºé—²çš„ã€å¼€æ”¾çš„å†…å­˜ã€‚ç„¶åï¼Œå½“é€šè¿‡ free() å°†è¯¥æŒ‡é’ˆä¼ é€’å›æ¥æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦å€’é€€å‡ ä¸ªå†…å­˜å­—èŠ‚å°±å¯ä»¥å†æ¬¡æ‰¾åˆ°è¿™ä¸ªç»“æ„ã€‚</p>
<p><strong>å…³äº malloc è·å¾—è™šå­˜ç©ºé—´çš„å®ç°ï¼Œä¸ glibc çš„ç‰ˆæœ¬æœ‰å…³ï¼Œä½†å¤§ä½“é€»è¾‘æ˜¯ï¼š</strong></p>
<ul>
<li>è‹¥åˆ†é…å†…å­˜å°äº 128k ï¼Œè°ƒç”¨ sbrk() ï¼Œå°†å †é¡¶æŒ‡é’ˆå‘é«˜åœ°å€ç§»åŠ¨ï¼Œè·å¾—æ–°çš„è™šå­˜ç©ºé—´ã€‚</li>
<li>è‹¥åˆ†é…å†…å­˜å¤§äº 128k ï¼Œè°ƒç”¨ mmap() ï¼Œåœ¨æ–‡ä»¶æ˜ å°„åŒºåŸŸä¸­åˆ†é…åŒ¿åè™šå­˜ç©ºé—´ã€‚</li>
</ul>
<p>æ¥ç€ï¼š VSZä¸ºè™šæ‹Ÿå†…å­˜ RSSä¸ºç‰©ç†å†…å­˜</p>
<ul>
<li>VSZ å¹¶ä¸æ˜¯æ¯æ¬¡ malloc åéƒ½å¢é•¿ï¼Œæ˜¯ä¸ä¸Šä¸€èŠ‚è¯´çš„å †é¡¶æ²¡å‘ç”Ÿå˜åŒ–æœ‰å…³ï¼Œå› ä¸ºå¯é‡ç”¨å †é¡¶å†…å‰©ä½™çš„ç©ºé—´ï¼Œè¿™æ ·çš„ malloc æ˜¯å¾ˆè½»é‡å¿«é€Ÿçš„ã€‚</li>
<li>ä½†å¦‚æœ VSZ å‘ç”Ÿå˜åŒ–ï¼ŒåŸºæœ¬ä¸åˆ†é…å†…å­˜é‡ç›¸å½“ï¼Œå› ä¸º VSZ æ˜¯è®¡ç®—è™šæ‹Ÿåœ°å€ç©ºé—´æ€»å¤§å°ã€‚</li>
<li>RSS çš„å¢é‡å¾ˆå°‘ï¼Œæ˜¯å› ä¸º malloc åˆ†é…çš„å†…å­˜å¹¶ä¸å°±é©¬ä¸Šåˆ†é…å®é™…å­˜å‚¨ç©ºé—´ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œå¦‚ç¬¬ä¸€æ¬¡ memset åæ‰ä¼šåˆ†é…ã€‚</li>
<li>ç”±äºæ¯ä¸ªç‰©ç†å†…å­˜é¡µé¢å¤§å°æ˜¯ 4k ï¼Œä¸ç®¡ memset å…¶ä¸­çš„ 1k è¿˜æ˜¯ 5k ã€ 7k ï¼Œå®é™…å ç”¨ç‰©ç†å†…å­˜æ€»æ˜¯ 4k çš„å€æ•°ã€‚æ‰€ä»¥ RSS çš„å¢é‡æ€»æ˜¯ 4k çš„å€æ•°ã€‚</li>
<li>å› æ­¤ï¼Œä¸æ˜¯ malloc åå°±é©¬ä¸Šå ç”¨å®é™…å†…å­˜ï¼Œè€Œæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶å‘ç°è™šå­˜å¯¹åº”çš„ç‰©ç†é¡µé¢æœªåˆ†é…ï¼Œäº§ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œæ‰çœŸæ­£åˆ†é…ç‰©ç†é¡µé¢ï¼ŒåŒæ—¶æ›´æ–°è¿›ç¨‹é¡µé¢çš„æ˜ å°„å…³ç³»ã€‚è¿™ä¹Ÿæ˜¯ Linux è™šæ‹Ÿå†…å­˜ç®¡ç†çš„æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ã€‚</li>
</ul>
<h2 id="vmallocå’Œkmallocå’Œmallocçš„åŒºåˆ«"><a href="#vmallocå’Œkmallocå’Œmallocçš„åŒºåˆ«" class="headerlink" title="vmallocå’Œkmallocå’Œmallocçš„åŒºåˆ«"></a>vmallocå’Œkmallocå’Œmallocçš„åŒºåˆ«</h2><ul>
<li>kmallocå’Œvmallocæ˜¯åˆ†é…çš„æ˜¯å†…æ ¸çš„å†…å­˜,mallocåˆ†é…çš„æ˜¯ç”¨æˆ·çš„å†…å­˜</li>
<li>kmallocä¿è¯åˆ†é…çš„å†…å­˜åœ¨ç‰©ç†ä¸Šæ˜¯è¿ç»­çš„,vmallocä¿è¯çš„æ˜¯åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸Šçš„è¿ç»­,mallocä¸ä¿è¯ä»»ä½•ä¸œè¥¿(è¿™ç‚¹æ˜¯è‡ªå·±çŒœæµ‹çš„,ä¸ä¸€å®šæ­£ç¡®)</li>
<li>kmallocèƒ½åˆ†é…çš„å¤§å°æœ‰é™,vmallocå’Œmallocèƒ½åˆ†é…çš„å¤§å°ç›¸å¯¹è¾ƒå¤§</li>
<li>å†…å­˜åªæœ‰åœ¨è¦è¢«DMAè®¿é—®çš„æ—¶å€™æ‰éœ€è¦ç‰©ç†ä¸Šè¿ç»­</li>
<li>vmallocæ¯”kmallocè¦æ…¢</li>
</ul>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/virtual_memory_mgr1.jpg" alt></p>
<p>å¯¹äºæä¾›äº†MMUï¼ˆå­˜å‚¨ç®¡ç†å™¨ï¼Œè¾…åŠ©æ“ä½œç³»ç»Ÿè¿›è¡Œå†…å­˜ç®¡ç†ï¼Œæä¾›è™šå®åœ°å€è½¬æ¢ç­‰ç¡¬ä»¶æ”¯æŒï¼‰çš„å¤„ç†å™¨è€Œè¨€ï¼ŒLinuxæä¾›äº†å¤æ‚çš„å­˜å‚¨ç®¡ç†ç³»ç»Ÿï¼Œä½¿å¾—è¿›ç¨‹æ‰€èƒ½è®¿é—®çš„å†…å­˜è¾¾åˆ°4GBã€‚</p>
<p>è¿›ç¨‹çš„4GBå†…å­˜ç©ºé—´è¢«äººä¸ºçš„åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†â€“ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´ã€‚ç”¨æˆ·ç©ºé—´åœ°å€åˆ†å¸ƒä»0åˆ°3GB(PAGE_OFFSETï¼Œåœ¨0x86ä¸­å®ƒç­‰äº0xC0000000)ï¼Œ3GBåˆ°4GBä¸ºå†…æ ¸ç©ºé—´ã€‚</p>
<p>å†…æ ¸ç©ºé—´ä¸­ï¼Œä»3Gåˆ°vmalloc_startè¿™æ®µåœ°å€æ˜¯ç‰©ç†å†…å­˜æ˜ å°„åŒºåŸŸï¼ˆè¯¥åŒºåŸŸä¸­åŒ…å«äº†å†…æ ¸é•œåƒã€ç‰©ç†é¡µæ¡†è¡¨mem_mapç­‰ç­‰ï¼‰ï¼Œæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨ çš„ VMwareè™šæ‹Ÿç³»ç»Ÿå†…å­˜æ˜¯160Mï¼Œé‚£ä¹ˆ3Gï½3G+160Mè¿™ç‰‡å†…å­˜å°±åº”è¯¥æ˜ å°„ç‰©ç†å†…å­˜ã€‚åœ¨ç‰©ç†å†…å­˜æ˜ å°„åŒºä¹‹åï¼Œå°±æ˜¯vmallocåŒºåŸŸã€‚å¯¹äº 160Mçš„ç³»ç»Ÿè€Œè¨€ï¼Œvmalloc_startä½ç½®åº”åœ¨3G+160Mé™„è¿‘ï¼ˆåœ¨ç‰©ç†å†…å­˜æ˜ å°„åŒºä¸vmalloc_startæœŸé—´è¿˜å­˜åœ¨ä¸€ä¸ª8Mçš„gap æ¥é˜²æ­¢è·ƒç•Œï¼‰ï¼Œvmalloc_endçš„ä½ç½®æ¥è¿‘4G(æœ€åä½ç½®ç³»ç»Ÿä¼šä¿ç•™ä¸€ç‰‡128kå¤§å°çš„åŒºåŸŸç”¨äºä¸“ç”¨é¡µé¢æ˜ å°„)</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªæœ‰ç¡¬ä»¶è®¾å¤‡æ‰éœ€è¦ç‰©ç†åœ°å€è¿ç»­çš„å†…å­˜ï¼Œå› ä¸ºç¡¬ä»¶è®¾å¤‡å¾€å¾€å­˜åœ¨äºMMUä¹‹å¤–ï¼Œæ ¹æœ¬ä¸äº†è§£è™šæ‹Ÿåœ°å€ï¼›ä½†ä¸ºäº†æ€§èƒ½ä¸Šçš„è€ƒè™‘ï¼Œå†…æ ¸ä¸­ä¸€èˆ¬ä½¿ç”¨kmalloc(),è€Œåªæœ‰åœ¨éœ€è¦è·å¾—å¤§å—å†…å­˜æ—¶æ‰ä½¿ç”¨vmallocï¼Œä¾‹å¦‚å½“æ¨¡å—è¢«åŠ¨æ€åŠ è½½åˆ°å†…æ ¸å½“ä¸­æ—¶ï¼Œå°±æŠŠæ¨¡å—è£…è½½åˆ°ç”±vmallocï¼ˆï¼‰åˆ†é…çš„å†…å­˜ä¸Šã€‚</p>
<ul>
<li><strong>kmalloc</strong>:<br>  kmallocç”³è¯·çš„æ˜¯è¾ƒå°çš„è¿ç»­çš„ç‰©ç†å†…å­˜ï¼Œå†…å­˜ç‰©ç†åœ°å€ä¸Šè¿ç»­ï¼Œè™šæ‹Ÿåœ°å€ä¸Šä¹Ÿæ˜¯è¿ç»­çš„ï¼Œä½¿ç”¨çš„æ˜¯å†…å­˜åˆ†é…å™¨slabçš„ä¸€å°ç‰‡ã€‚ç”³è¯·çš„å†…å­˜ä½äºç‰©ç†å†…å­˜çš„æ˜ å°„åŒºåŸŸã€‚å…¶çœŸæ­£çš„ç‰©ç†åœ°å€åªç›¸å·®ä¸€ä¸ªå›ºå®šçš„åç§»ã€‚è€Œä¸”ä¸å¯¹è·å¾—ç©ºé—´æ¸…é›¶ã€‚å¯ä»¥æŸ¥çœ‹<a href="#Slabåˆ†é…å™¨">slabåˆ†é…å™¨</a></li>
<li><strong>kzalloc</strong>:<br>  ç”¨kzallocç”³è¯·å†…å­˜çš„æ—¶å€™ï¼Œ æ•ˆæœç­‰åŒäºå…ˆæ˜¯ç”¨ kmalloc() ç”³è¯·ç©ºé—´ , ç„¶åç”¨ memset() æ¥åˆå§‹åŒ– ,æ‰€æœ‰ç”³è¯·çš„å…ƒç´ éƒ½è¢«åˆå§‹åŒ–ä¸º 0.</li>
<li><strong>vmalloc</strong>:<br>  vmallocç”¨äºç”³è¯·è¾ƒå¤§çš„å†…å­˜ç©ºé—´ï¼Œè™šæ‹Ÿå†…å­˜æ˜¯è¿ç»­ã€‚ç”³è¯·çš„å†…å­˜çš„åˆ™ä½äºvmalloc_startï½vmalloc_endä¹‹é—´ï¼Œä¸ç‰©ç†åœ°å€æ²¡æœ‰ç®€å•çš„è½¬æ¢å…³ç³»ï¼Œè™½ç„¶åœ¨é€»è¾‘ä¸Šå®ƒä»¬ä¹Ÿæ˜¯è¿ç»­çš„ï¼Œä½†æ˜¯åœ¨ç‰©ç†ä¸Šå®ƒä»¬ä¸è¦æ±‚è¿ç»­ã€‚</li>
<li><strong>malloc</strong>:<br>  mallocåˆ†é…çš„æ˜¯ç”¨æˆ·çš„å†…å­˜ã€‚é™¤éè¢«é˜»å¡å¦åˆ™ä»–æ‰§è¡Œçš„é€Ÿåº¦éå¸¸å¿«ï¼Œè€Œä¸”ä¸å¯¹è·å¾—ç©ºé—´æ¸…é›¶ã€‚</li>
</ul>
<h2 id="Buddyï¼ˆä¼™ä¼´ï¼‰åˆ†é…ç®—æ³•"><a href="#Buddyï¼ˆä¼™ä¼´ï¼‰åˆ†é…ç®—æ³•" class="headerlink" title="Buddyï¼ˆä¼™ä¼´ï¼‰åˆ†é…ç®—æ³•"></a>Buddyï¼ˆä¼™ä¼´ï¼‰åˆ†é…ç®—æ³•</h2><p>å‚è€ƒ: <a href="https://zhuanlan.zhihu.com/p/149581303" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/149581303</a></p>
<p>ä¼™ä¼´ç³»ç»Ÿç”¨äºç®¡ç†ç‰©ç†é¡µï¼Œä¸»è¦ç›®çš„åœ¨äºç»´æŠ¤å¯ç”¨çš„è¿ç»­ç‰©ç†ç©ºé—´ï¼Œé¿å…å¤–éƒ¨ç¢ç‰‡ã€‚æ‰€æœ‰å…³äºå†…å­˜åˆ†é…çš„æ“ä½œéƒ½ä¼šä¸å…¶æ‰“äº¤é“ï¼Œbuddyæ˜¯ç‰©ç†å†…å­˜çš„ç®¡ç†çš„é—¨æˆ·</p>
<p>Linux å†…æ ¸å¼•å…¥äº†ä¼™ä¼´ç³»ç»Ÿç®—æ³•ï¼ˆBuddy systemï¼‰ï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå°±æ˜¯æŠŠç›¸åŒå¤§å°çš„é¡µæ¡†å—ç”¨é“¾è¡¨ä¸²èµ·æ¥ï¼Œé¡µæ¡†å—å°±åƒæ‰‹æ‹‰æ‰‹çš„å¥½ä¼™ä¼´ï¼Œä¹Ÿæ˜¯è¿™ä¸ªç®—æ³•åå­—çš„ç”±æ¥ã€‚</p>
<p>å…·ä½“çš„ï¼Œæ‰€æœ‰çš„ç©ºé—²é¡µæ¡†åˆ†ç»„ä¸º11ä¸ªå—é“¾è¡¨ï¼Œæ¯ä¸ªå—é“¾è¡¨åˆ†åˆ«åŒ…å«å¤§å°ä¸º1ï¼Œ2ï¼Œ4ï¼Œ8ï¼Œ16ï¼Œ32ï¼Œ64ï¼Œ128ï¼Œ256ï¼Œ512å’Œ1024ä¸ªè¿ç»­é¡µæ¡†çš„é¡µæ¡†å—ã€‚æœ€å¤§å¯ä»¥ç”³è¯·1024ä¸ªè¿ç»­é¡µæ¡†ï¼Œå¯¹åº”4MBå¤§å°çš„è¿ç»­å†…å­˜ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/buddy_algo.jpg" alt></p>
<p>ä¼™ä¼´ç³»ç»Ÿ:<br>å› ä¸ºä»»ä½•æ­£æ•´æ•°éƒ½å¯ä»¥ç”± 2^n çš„å’Œç»„æˆï¼Œæ‰€ä»¥æ€»èƒ½æ‰¾åˆ°åˆé€‚å¤§å°çš„å†…å­˜å—åˆ†é…å‡ºå»ï¼Œå‡å°‘äº†å¤–éƒ¨ç¢ç‰‡äº§ç”Ÿ ã€‚</p>
<p>åˆ†é…å®ä¾‹:<br>æ¯”å¦‚ï¼šæˆ‘éœ€è¦ç”³è¯·4ä¸ªé¡µæ¡†ï¼Œä½†æ˜¯é•¿åº¦ä¸º4ä¸ªè¿ç»­é¡µæ¡†å—é“¾è¡¨æ²¡æœ‰ç©ºé—²çš„é¡µæ¡†å—ï¼Œä¼™ä¼´ç³»ç»Ÿä¼šä»è¿ç»­8ä¸ªé¡µæ¡†å—çš„é“¾è¡¨è·å–ä¸€ä¸ªï¼Œå¹¶å°†å…¶æ‹†åˆ†ä¸ºä¸¤ä¸ªè¿ç»­4ä¸ªé¡µæ¡†å—ï¼Œå–å…¶ä¸­ä¸€ä¸ªï¼Œå¦å¤–ä¸€ä¸ªæ”¾å…¥è¿ç»­4ä¸ªé¡µæ¡†å—çš„ç©ºé—²é“¾è¡¨ä¸­ã€‚é‡Šæ”¾çš„æ—¶å€™ä¼šæ£€æŸ¥ï¼Œé‡Šæ”¾çš„è¿™å‡ ä¸ªé¡µæ¡†å‰åçš„é¡µæ¡†æ˜¯å¦ç©ºé—²ï¼Œèƒ½å¦ç»„æˆä¸‹ä¸€çº§é•¿åº¦çš„å—ã€‚</p>
<h2 id="Slabåˆ†é…å™¨"><a href="#Slabåˆ†é…å™¨" class="headerlink" title="Slabåˆ†é…å™¨"></a>Slabåˆ†é…å™¨</h2><p>ä¼™ä¼´ç³»ç»Ÿå’Œslabä¸æ˜¯äºŒé€‰ä¸€çš„å…³ç³»ï¼Œslab å†…å­˜åˆ†é…å™¨æ˜¯å¯¹ä¼™ä¼´åˆ†é…ç®—æ³•çš„è¡¥å……</p>
<p>slabçš„ç›®çš„åœ¨äºé¿å…å†…éƒ¨ç¢ç‰‡ã€‚ä»buddyç³»ç»Ÿè·å–çš„å†…å­˜è‡³å°‘æ˜¯ä¸€ä¸ªé¡µï¼Œä¹Ÿå°±æ˜¯4Kï¼Œå¦‚æœä»…ä»…éœ€è¦8å­—èŠ‚çš„å†…å­˜ï¼Œæ˜¾ç„¶å·¨å¤§çš„å†…éƒ¨ç¢ç‰‡æ— æ³•å®¹å¿ã€‚</p>
<p><strong>slabä»buddyç³»ç»Ÿç”³è¯·ç©ºé—´ï¼Œå°†è¾ƒå¤§çš„è¿ç»­å†…å­˜æ‹†åˆ†æˆä¸€ç³»åˆ—è¾ƒå°çš„å†…å­˜å—ã€‚</strong></p>
<p>ç”¨æˆ·ç”³è¯·ç©ºé—´æ—¶ä»slabä¸­è·å–å¤§å°æœ€ç›¸è¿‘çš„å°å—å†…å­˜ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆå‡å°‘å†…éƒ¨ç¢ç‰‡ã€‚åœ¨slabæœ€å¤§çš„å—ä¸º8Kï¼Œslabä¸­æ‰€æœ‰å—åœ¨ç‰©ç†ä¸Šä¹Ÿæ˜¯è¿ç»­çš„ã€‚</p>
<p>ä¸Šé¢è¯´çš„ç”¨äºå†…å­˜åˆ†é…çš„slabæ˜¯é€šç”¨çš„slabï¼Œä¸»è¦ç”¨äºæ”¯æŒkmallocåˆ†é…å†…å­˜ã€‚</p>
<p>slabè¿˜æœ‰ä¸€ä¸ªä½œç”¨å°±æ˜¯ç”¨ä½œå¯¹è±¡æ± ï¼Œé’ˆå¯¹ç»å¸¸åˆ†é…å’Œå›æ”¶çš„å¯¹è±¡æ¯”å¦‚task_structï¼Œå¯ä»¥åˆ†é…ä¸€ä¸ªslabå¯¹è±¡æ± å¯¹å…¶ä¼˜åŒ–ã€‚è¿™ç§slabæ˜¯ç‹¬ç«‹äºé€šç”¨çš„å†…å­˜åˆ†é…slabçš„ï¼Œåœ¨å†…æ ¸ä¸­æœ‰å¾ˆå¤šè¿™æ ·çš„é’ˆå¯¹ç‰¹å®šå¯¹è±¡çš„slabã€‚</p>
<p><strong>åœ¨å†…æ ¸ä¸­æƒ³è¦åˆ†é…ä¸€æ®µè¿ç»­çš„å†…å­˜</strong>ï¼Œé¦–å…ˆå‘slabç³»ç»Ÿç”³è¯·ï¼Œå¦‚æœä¸æ»¡è¶³ï¼ˆè¶…è¿‡ä¸¤ä¸ªé¡µé¢ï¼Œä¹Ÿå°±æ˜¯8Kï¼‰ï¼Œç›´æ¥å‘buddyç³»ç»Ÿç”³è¯·ã€‚å¦‚æœè¿˜ä¸æ»¡è¶³ï¼ˆè¶…è¿‡4Mï¼Œä¹Ÿå°±æ˜¯1024ä¸ªé¡µé¢ï¼‰ï¼Œå°†æ— æ³•è·å–åˆ°è¿ç»­çš„ç‰©ç†åœ°å€ã€‚å¯ä»¥é€šè¿‡vmallocè·å–è™šæ‹Ÿåœ°å€ç©ºé—´è¿ç»­ï¼Œä½†ç‰©ç†åœ°å€ä¸è¿ç»­çš„æ›´å¤§çš„å†…å­˜ç©ºé—´ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/buddy_algo2.png" alt></p>
<p>mallocæ˜¯ç”¨æˆ·æ€ä½¿ç”¨çš„å†…å­˜åˆ†é…æ¥å£ï¼Œæœ€ç»ˆè¿˜æ˜¯å‘buddyç”³è¯·å†…å­˜ï¼Œå› ä¸ºbuddyç³»ç»Ÿæ˜¯ç®¡ç†ç‰©ç†å†…å­˜çš„é—¨æˆ·ã€‚ç”³è¯·åˆ°å¤§å—å†…å­˜åï¼Œå†åƒslabä¸€æ ·å¯¹å…¶è¿›è¡Œç»†åˆ†ç»´æŠ¤ï¼Œæ ¹æ®ç”¨æˆ·éœ€è¦è¿”å›ç›¸åº”å†…å­˜çš„æŒ‡é’ˆã€‚</p>
<h2 id="forkå†…å­˜è¯­ä¹‰"><a href="#forkå†…å­˜è¯­ä¹‰" class="headerlink" title="forkå†…å­˜è¯­ä¹‰"></a>forkå†…å­˜è¯­ä¹‰</h2><ul>
<li>å…±äº«ä»£ç æ®µ, å­æŒ‡å‘çˆ¶ : çˆ¶å­è¿›ç¨‹å…±äº«åŒä¸€ä»£ç æ®µ, å­è¿›ç¨‹çš„é¡µè¡¨é¡¹æŒ‡å‘çˆ¶è¿›ç¨‹ç›¸åŒçš„ç‰©ç†å†…å­˜é¡µ(å³æ•°æ®æ®µ/å †æ®µ/æ ˆæ®µçš„å„é¡µ)</li>
<li>å†™æ—¶å¤åˆ¶(copy-on-write) : å†…æ ¸ä¼šæ•è·æ‰€æœ‰çˆ¶è¿›ç¨‹æˆ–å­è¿›ç¨‹é’ˆå¯¹è¿™äº›é¡µé¢(å³æ•°æ®æ®µ/å †æ®µ/æ ˆæ®µçš„å„é¡µ)çš„ä¿®æ”¹ä¼å›¾, å¹¶ä¸ºå°†è¦ä¿®æ”¹çš„é¡µé¢åˆ›å»ºæ‹·è´, å°†æ–°çš„é¡µé¢æ‹·è´åˆ†é…ç»™é­å†…æ ¸æ•è·çš„è¿›ç¨‹, ä»æ­¤çˆ¶/å­è¿›ç¨‹å¯ä»¥åˆ†åˆ«ä¿®æ”¹å„è‡ªçš„é¡µæ‹·è´, ä¸å†ç›¸äº’å½±å“.</li>
</ul>
<p>è™½ç„¶forkåˆ›å»ºçš„å­è¿›ç¨‹ä¸éœ€è¦æ‹·è´çˆ¶è¿›ç¨‹çš„ç‰©ç†å†…å­˜ç©ºé—´, ä½†æ˜¯ä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„ç©ºé—´å†…å­˜é¡µè¡¨. ä¾‹å¦‚å¯¹äº10GBçš„redisè¿›ç¨‹, éœ€è¦å¤åˆ¶çº¦20MBçš„å†…å­˜é¡µè¡¨, å› ä¸ºæ­¤forkæ“ä½œè€—æ—¶è·Ÿè¿›ç¨‹æ€»å†…å­˜é‡æ¯æ¯ç›¸å…³</p>
<h2 id="é›¶æ‹·è´"><a href="#é›¶æ‹·è´" class="headerlink" title="é›¶æ‹·è´"></a>é›¶æ‹·è´</h2><p>å‚è€ƒ <a href="https://juejin.im/post/6844903949359644680" target="_blank" rel="noopener">https://juejin.im/post/6844903949359644680</a></p>
<p>â€œå…ˆä»ç®€å•å¼€å§‹ï¼Œå®ç°ä¸‹è¿™ä¸ªåœºæ™¯ï¼šä»ä¸€ä¸ªæ–‡ä»¶ä¸­è¯»å‡ºæ•°æ®å¹¶å°†æ•°æ®ä¼ åˆ°å¦ä¸€å°æœåŠ¡å™¨ä¸Šï¼Ÿâ€<br>å¤§æ¦‚ä¼ªä»£ç å¦‚ä¸‹:<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">File.read(file, buf, len);</span><br><span class="line">Socket.send(socket, buf, len);</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹å‡º, è¿™æ ·æ•ˆç‡æ˜¯å¾ˆä½çš„. </p>
<p>ä¸‹å›¾åˆ†åˆ«å¯¹åº”ä¼ ç»Ÿ I/O æ“ä½œçš„æ•°æ®è¯»å†™æµç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹æ¶‰åŠ 2 æ¬¡ CPU æ‹·è´ã€2 æ¬¡ DMA æ‹·è´æ€»å…± 4 æ¬¡æ‹·è´ï¼Œä»¥åŠ 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä¸‹é¢ç®€å•åœ°é˜è¿°ä¸€ä¸‹ç›¸å…³çš„æ¦‚å¿µã€‚<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/traditional_io.jpg" alt></p>
<ul>
<li>ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šå½“ç”¨æˆ·ç¨‹åºå‘å†…æ ¸å‘èµ·ç³»ç»Ÿè°ƒç”¨æ—¶ï¼ŒCPU å°†ç”¨æˆ·è¿›ç¨‹ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼›å½“ç³»ç»Ÿè°ƒç”¨è¿”å›æ—¶ï¼ŒCPU å°†ç”¨æˆ·è¿›ç¨‹ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€ã€‚</li>
<li>CPUæ‹·è´ï¼šç”± CPU ç›´æ¥å¤„ç†æ•°æ®çš„ä¼ é€ï¼Œæ•°æ®æ‹·è´æ—¶ä¼šä¸€ç›´å ç”¨ CPU çš„èµ„æºã€‚</li>
<li>DMAæ‹·è´ï¼šç”± CPU å‘DMAç£ç›˜æ§åˆ¶å™¨ä¸‹è¾¾æŒ‡ä»¤ï¼Œè®© DMA æ§åˆ¶å™¨æ¥å¤„ç†æ•°æ®çš„ä¼ é€ï¼Œæ•°æ®ä¼ é€å®Œæ¯•å†æŠŠä¿¡æ¯åé¦ˆç»™ CPUï¼Œä»è€Œå‡è½»äº† CPU èµ„æºçš„å æœ‰ç‡ã€‚</li>
</ul>
<h3 id="ä¼ ç»Ÿè¯»æ“ä½œ"><a href="#ä¼ ç»Ÿè¯»æ“ä½œ" class="headerlink" title="ä¼ ç»Ÿè¯»æ“ä½œ"></a>ä¼ ç»Ÿè¯»æ“ä½œ</h3><p>å½“åº”ç”¨ç¨‹åºæ‰§è¡Œ read ç³»ç»Ÿè°ƒç”¨è¯»å–ä¸€å—æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœè¿™å—æ•°æ®å·²ç»å­˜åœ¨äºç”¨æˆ·è¿›ç¨‹çš„é¡µå†…å­˜ä¸­ï¼Œå°±ç›´æ¥ä»å†…å­˜ä¸­è¯»å–æ•°æ®ï¼›å¦‚æœæ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™å…ˆå°†æ•°æ®ä»ç£ç›˜åŠ è½½æ•°æ®åˆ°å†…æ ¸ç©ºé—´çš„è¯»ç¼“å­˜ï¼ˆread bufferï¼‰ä¸­ï¼Œå†ä»è¯»ç¼“å­˜æ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹çš„é¡µå†…å­˜ä¸­ã€‚<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">read(file_fd, tmp_buf, len);</span><br></pre></td></tr></table></figure></p>
<p>å¤åˆ¶ä»£ç åŸºäºä¼ ç»Ÿçš„ I/O è¯»å–æ–¹å¼ï¼Œread ç³»ç»Ÿè°ƒç”¨ä¼šè§¦å‘ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ1 æ¬¡ DMA æ‹·è´å’Œ 1 æ¬¡ CPU æ‹·è´ï¼Œå‘èµ·æ•°æ®è¯»å–çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç”¨æˆ·è¿›ç¨‹é€šè¿‡ read() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚</li>
<li>CPUåˆ©ç”¨DMAæ§åˆ¶å™¨å°†æ•°æ®ä»ä¸»å­˜æˆ–ç¡¬ç›˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ã€‚</li>
<li>CPUå°†è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ä¸­çš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼ˆuser spaceï¼‰çš„ç”¨æˆ·ç¼“å†²åŒºï¼ˆuser bufferï¼‰ã€‚</li>
<li>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œread è°ƒç”¨æ‰§è¡Œè¿”å›ã€‚</li>
</ol>
<h3 id="ä¼ ç»Ÿå†™æ“ä½œ"><a href="#ä¼ ç»Ÿå†™æ“ä½œ" class="headerlink" title="ä¼ ç»Ÿå†™æ“ä½œ"></a>ä¼ ç»Ÿå†™æ“ä½œ</h3><p>å½“åº”ç”¨ç¨‹åºå‡†å¤‡å¥½æ•°æ®ï¼Œæ‰§è¡Œ write ç³»ç»Ÿè°ƒç”¨å‘é€ç½‘ç»œæ•°æ®æ—¶ï¼Œå…ˆå°†æ•°æ®ä»ç”¨æˆ·ç©ºé—´çš„é¡µç¼“å­˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´çš„ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ä¸­ï¼Œç„¶åå†å°†å†™ç¼“å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ°ç½‘å¡è®¾å¤‡å®Œæˆæ•°æ®å‘é€ã€‚<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">write(socket_fd, tmp_buf, len);</span><br></pre></td></tr></table></figure></p>
<p>å¤åˆ¶ä»£ç åŸºäºä¼ ç»Ÿçš„ I/O å†™å…¥æ–¹å¼ï¼Œwrite() ç³»ç»Ÿè°ƒç”¨ä¼šè§¦å‘ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ1 æ¬¡ CPU æ‹·è´å’Œ 1 æ¬¡ DMA æ‹·è´ï¼Œç”¨æˆ·ç¨‹åºå‘é€ç½‘ç»œæ•°æ®çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç”¨æˆ·è¿›ç¨‹é€šè¿‡ write() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚</li>
<li>CPU å°†ç”¨æˆ·ç¼“å†²åŒºï¼ˆuser bufferï¼‰ä¸­çš„æ•°æ®æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ã€‚</li>
<li>CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰æ‹·è´åˆ°ç½‘å¡è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</li>
<li>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œwrite ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œè¿”å›ã€‚</li>
</ol>
<h3 id="sendfile"><a href="#sendfile" class="headerlink" title="sendfile"></a>sendfile</h3><p>sendfile ç³»ç»Ÿè°ƒç”¨åœ¨ Linux å†…æ ¸ç‰ˆæœ¬ 2.1 ä¸­è¢«å¼•å…¥ï¼Œç›®çš„æ˜¯ç®€åŒ–é€šè¿‡ç½‘ç»œåœ¨ä¸¤ä¸ªé€šé“ä¹‹é—´è¿›è¡Œçš„æ•°æ®ä¼ è¾“è¿‡ç¨‹ã€‚sendfile ç³»ç»Ÿè°ƒç”¨çš„å¼•å…¥ï¼Œä¸ä»…å‡å°‘äº† CPU æ‹·è´çš„æ¬¡æ•°ï¼Œè¿˜å‡å°‘äº†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¬¡æ•°ï¼Œå®ƒçš„ä¼ªä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sendfile(socket_fd, file_fd, len);</span><br></pre></td></tr></table></figure></p>
<p>å¤åˆ¶ä»£ç é€šè¿‡ sendfile ç³»ç»Ÿè°ƒç”¨ï¼Œæ•°æ®å¯ä»¥ç›´æ¥åœ¨å†…æ ¸ç©ºé—´å†…éƒ¨è¿›è¡Œ I/O ä¼ è¾“ï¼Œä»è€Œçœå»äº†æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´çš„æ¥å›æ‹·è´ã€‚ä¸ mmap å†…å­˜æ˜ å°„æ–¹å¼ä¸åŒçš„æ˜¯ï¼Œ sendfile è°ƒç”¨ä¸­ I/O æ•°æ®å¯¹ç”¨æˆ·ç©ºé—´æ˜¯å®Œå…¨ä¸å¯è§çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™æ˜¯ä¸€æ¬¡å®Œå…¨æ„ä¹‰ä¸Šçš„æ•°æ®ä¼ è¾“è¿‡ç¨‹ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/sendfile1.jpg" alt></p>
<p>åŸºäº sendfile ç³»ç»Ÿè°ƒç”¨çš„é›¶æ‹·è´æ–¹å¼ï¼Œæ•´ä¸ªæ‹·è´è¿‡ç¨‹ä¼šå‘ç”Ÿ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ1 æ¬¡ CPU æ‹·è´å’Œ 2 æ¬¡ DMA æ‹·è´ï¼Œç”¨æˆ·ç¨‹åºè¯»å†™æ•°æ®çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç”¨æˆ·è¿›ç¨‹é€šè¿‡ sendfile() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚</li>
<li>CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ä¸»å­˜æˆ–ç¡¬ç›˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ã€‚</li>
<li>CPU å°†è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ä¸­çš„æ•°æ®æ‹·è´åˆ°çš„ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ã€‚</li>
<li>CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰æ‹·è´åˆ°ç½‘å¡è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</li>
<li>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œsendfile ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œè¿”å›ã€‚</li>
</ol>
<p>ç›¸æ¯”è¾ƒäº mmap å†…å­˜æ˜ å°„çš„æ–¹å¼ï¼Œsendfile å°‘äº† 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ˜¯ä»ç„¶æœ‰ 1 æ¬¡ CPU æ‹·è´æ“ä½œã€‚sendfile å­˜åœ¨çš„é—®é¢˜æ˜¯ç”¨æˆ·ç¨‹åºä¸èƒ½å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œè€Œåªæ˜¯å•çº¯åœ°å®Œæˆäº†ä¸€æ¬¡æ•°æ®ä¼ è¾“è¿‡ç¨‹ã€‚</p>
<p>â€œè¿™æ ·ç¡®å®æ”¹å–„äº†å¾ˆå¤šï¼Œä½†è¿˜æ²¡è¾¾åˆ°é›¶æ‹·è´çš„è¦æ±‚ï¼ˆè¿˜æœ‰ä¸€æ¬¡cpuå‚ä¸çš„æ‹·è´ï¼‰ï¼Œè¿˜æœ‰å…¶å®ƒé»‘æŠ€æœ¯ï¼Ÿâ€<br>â€œå¯¹çš„ï¼Œå¦‚æœåº•å±‚ç½‘ç»œæ¥å£å¡æ”¯æŒæ”¶é›†(gather)æ“ä½œçš„è¯ï¼Œå°±å¯ä»¥è¿›ä¸€æ­¥çš„ä¼˜åŒ–ã€‚â€<br>â€œæ€ä¹ˆè¯´ï¼Ÿâ€<br>â€œç»§ç»­çœ‹ä¸‹ä¸€å°èŠ‚â€  </p>
<h3 id="sendfile-DMA-gather-copy"><a href="#sendfile-DMA-gather-copy" class="headerlink" title="sendfile + DMA gather copy"></a>sendfile + DMA gather copy</h3><p>Linux 2.4 ç‰ˆæœ¬çš„å†…æ ¸å¯¹ sendfile ç³»ç»Ÿè°ƒç”¨è¿›è¡Œä¿®æ”¹ï¼Œå¦‚æœåº•å±‚ç½‘ç»œæ¥å£å¡æ”¯æŒæ”¶é›†(gather)æ“ä½œçš„è¯, ä¸º  DMA æ‹·è´å¼•å…¥äº† gather æ“ä½œã€‚å®ƒå°†å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ä¸­å¯¹åº”çš„æ•°æ®æè¿°ä¿¡æ¯ï¼ˆå†…å­˜åœ°å€ã€åœ°å€åç§»é‡ï¼‰è®°å½•åˆ°ç›¸åº”çš„ç½‘ç»œç¼“å†²åŒºï¼ˆ socket  bufferï¼‰ä¸­ï¼Œç”± DMA æ ¹æ®å†…å­˜åœ°å€ã€åœ°å€åç§»é‡å°†æ•°æ®æ‰¹é‡åœ°ä»è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰æ‹·è´åˆ°ç½‘å¡è®¾å¤‡ä¸­ï¼Œè¿™æ ·å°±çœå»äº†å†…æ ¸ç©ºé—´ä¸­ä»…å‰©çš„ 1 æ¬¡ CPU æ‹·è´æ“ä½œï¼Œsendfile çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sendfile(socket_fd, file_fd, len);</span><br></pre></td></tr></table></figure></p>
<p>å¤åˆ¶ä»£ç åœ¨ç¡¬ä»¶çš„æ”¯æŒä¸‹ï¼Œsendfile æ‹·è´æ–¹å¼ä¸å†ä»å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºï¼Œå–è€Œä»£ä¹‹çš„ä»…ä»…æ˜¯ç¼“å†²åŒºæ–‡ä»¶æè¿°ç¬¦å’Œæ•°æ®é•¿åº¦çš„æ‹·è´ï¼Œè¿™æ · DMA å¼•æ“ç›´æ¥åˆ©ç”¨ gather æ“ä½œå°†é¡µç¼“å­˜ä¸­æ•°æ®æ‰“åŒ…å‘é€åˆ°ç½‘ç»œä¸­å³å¯ï¼Œæœ¬è´¨å°±æ˜¯å’Œè™šæ‹Ÿå†…å­˜æ˜ å°„çš„æ€è·¯ç±»ä¼¼ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/noodle_plan/linux/sendfile2.jpg" alt></p>
<p>åŸºäº sendfile + DMA gather copy ç³»ç»Ÿè°ƒç”¨çš„é›¶æ‹·è´æ–¹å¼ï¼Œæ•´ä¸ªæ‹·è´è¿‡ç¨‹ä¼šå‘ç”Ÿ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€0 æ¬¡ CPU æ‹·è´ä»¥åŠ 2 æ¬¡ DMA æ‹·è´ï¼Œç”¨æˆ·ç¨‹åºè¯»å†™æ•°æ®çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç”¨æˆ·è¿›ç¨‹é€šè¿‡ sendfile() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚</li>
<li>CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ä¸»å­˜æˆ–ç¡¬ç›˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ã€‚</li>
<li>CPU æŠŠè¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰å’Œæ•°æ®é•¿åº¦æ‹·è´åˆ°ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ã€‚</li>
<li>åŸºäºå·²æ‹·è´çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰å’Œæ•°æ®é•¿åº¦ï¼ŒCPU åˆ©ç”¨ DMA æ§åˆ¶å™¨çš„ gather/scatter æ“ä½œç›´æ¥æ‰¹é‡åœ°å°†æ•°æ®ä»å†…æ ¸çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰æ‹·è´åˆ°ç½‘å¡è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</li>
<li>ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œsendfile ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œè¿”å›ã€‚</li>
</ol>
<p>sendfile + DMA gather copy æ‹·è´æ–¹å¼åŒæ ·å­˜åœ¨ç”¨æˆ·ç¨‹åºä¸èƒ½å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„é—®é¢˜ï¼Œè€Œä¸”æœ¬èº«éœ€è¦ç¡¬ä»¶çš„æ”¯æŒï¼Œå®ƒåªé€‚ç”¨äºå°†æ•°æ®ä»æ–‡ä»¶æ‹·è´åˆ° socket å¥—æ¥å­—ä¸Šçš„ä¼ è¾“è¿‡ç¨‹ã€‚</p>

          
        
      


      

    
      <footer class="post-footer">
        

        

        

        
        
          <div class="post-eof"></div>
        
      </footer>
      
    </div>
    
    
    

    

    

    

  </div>
  
  
  
  </article>


      
    
      
        

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hulinhong.com/quic_intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mike">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ğŸš™">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/quic_intro/" itemprop="url">QUICåŸç†ä¸KCPä¼šè¯æ¡æ‰‹å€Ÿé‰´</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-02-26T18:08:06+00:00">
                02-26-2021
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NP/" itemprop="url" rel="index">
                    <span itemprop="name">NP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    




    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      

      
      
        <div class="post-eof"></div>
      

      
      

      
        
          
            <p>å‚è€ƒ: </p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/142794794" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/142794794</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/32553477" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/32553477</a></li>
</ul>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç» QUIC åè®®äº§ç”Ÿçš„èƒŒæ™¯å’Œæ ¸å¿ƒç‰¹æ€§ã€‚</p>
<h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>å¦‚æœä½ çš„ Appï¼Œåœ¨ä¸éœ€è¦ä»»ä½•ä¿®æ”¹çš„æƒ…å†µä¸‹å°±èƒ½æå‡ 15% ä»¥ä¸Šçš„è®¿é—®é€Ÿåº¦ã€‚ç‰¹åˆ«æ˜¯å¼±ç½‘ç»œçš„æ—¶å€™èƒ½å¤Ÿæå‡ 20% ä»¥ä¸Šçš„è®¿é—®é€Ÿåº¦ã€‚</p>
<p>å¦‚æœä½ çš„ Appï¼Œåœ¨é¢‘ç¹åˆ‡æ¢ 4G å’Œ WIFI ç½‘ç»œçš„æƒ…å†µä¸‹ï¼Œä¸ä¼šæ–­çº¿ï¼Œä¸éœ€è¦é‡è¿ï¼Œç”¨æˆ·æ— ä»»ä½•æ„ŸçŸ¥ã€‚å¦‚æœä½ çš„ Appï¼Œæ—¢éœ€è¦ TLS çš„å®‰å…¨ï¼Œä¹Ÿæƒ³å®ç° HTTP2 å¤šè·¯å¤ç”¨çš„å¼ºå¤§ã€‚</p>
<p>å¦‚æœä½ åˆšåˆšæ‰å¬è¯´ HTTP2 æ˜¯ä¸‹ä¸€ä»£äº’è”ç½‘åè®®ï¼Œå¦‚æœä½ åˆšåˆšæ‰å…³æ³¨åˆ° TLS1.3 æ˜¯ä¸€ä¸ªé©å‘½æ€§å…·æœ‰é‡Œç¨‹ç¢‘æ„ä¹‰çš„åè®®ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªåè®®å´ä¸€ç›´åœ¨è¢«å¦ä¸€ä¸ªæ›´æ–°å…´çš„åè®®æ‰€å½±å“å’ŒæŒ‘æˆ˜ã€‚</p>
<p>å¦‚æœè¿™ä¸ªæ–°å…´çš„åè®®ï¼Œå®ƒçš„åå­—å°±å«åš â€œå¿«â€ï¼Œå¹¶ä¸”æ­£åœ¨æ ‡å‡†åŒ–ä¸ºæ–°ä¸€ä»£çš„äº’è”ç½‘ä¼ è¾“åè®®ã€‚</p>
<p>ä½ æ„¿æ„èŠ±ä¸€ç‚¹ç‚¹æ—¶é—´äº†è§£è¿™ä¸ªåè®®å—ï¼Ÿä½ æ„¿æ„æŠ•å…¥ç²¾åŠ›å»ç ”ç©¶è¿™ä¸ªåè®®å—ï¼Ÿä½ æ„¿æ„å…¨åŠ›æ¨åŠ¨ä¸šåŠ¡æ¥ä½¿ç”¨è¿™ä¸ªåè®®å—ï¼Ÿ</p>
<h1 id="QUIC-æ¦‚è¿°"><a href="#QUIC-æ¦‚è¿°" class="headerlink" title="QUIC æ¦‚è¿°"></a>QUIC æ¦‚è¿°</h1><p>Quic å…¨ç§° quick udp internet connection [1]ï¼Œâ€œå¿«é€Ÿ UDP äº’è”ç½‘è¿æ¥â€ï¼Œï¼ˆå’Œè‹±æ–‡ quick è°éŸ³ï¼Œç®€ç§° â€œå¿«â€ï¼‰æ˜¯ç”± google æå‡ºçš„ä½¿ç”¨ udp è¿›è¡Œå¤šè·¯å¹¶å‘ä¼ è¾“çš„åè®®ã€‚</p>
<p>Quic ç›¸æ¯”ç°åœ¨å¹¿æ³›åº”ç”¨çš„ http2+tcp+tls åè®®æœ‰å¦‚ä¸‹ä¼˜åŠ¿ [2]ï¼š</p>
<ol>
<li>å‡å°‘äº† TCP ä¸‰æ¬¡æ¡æ‰‹åŠ TLS æ¡æ‰‹æ—¶é—´ã€‚</li>
<li>æ”¹è¿›çš„æ‹¥å¡æ§åˆ¶ã€‚</li>
<li>é¿å…é˜Ÿå¤´é˜»å¡çš„å¤šè·¯å¤ç”¨ã€‚</li>
<li>è¿æ¥è¿ç§»ã€‚</li>
<li>å‰å‘å†—ä½™çº é”™ã€‚</li>
</ol>
<h1 id="TCPçš„ç¼ºé™·"><a href="#TCPçš„ç¼ºé™·" class="headerlink" title="TCPçš„ç¼ºé™·"></a>TCPçš„ç¼ºé™·</h1><p>ä»ä¸Šä¸ªä¸–çºª 90 å¹´ä»£äº’è”ç½‘å¼€å§‹å…´èµ·ä¸€ç›´åˆ°ç°åœ¨ï¼Œå¤§éƒ¨åˆ†çš„äº’è”ç½‘æµé‡ä¼ è¾“åªä½¿ç”¨äº†å‡ ä¸ªç½‘ç»œåè®®ã€‚ä½¿ç”¨ IPv4 è¿›è¡Œè·¯ç”±ï¼Œä½¿ç”¨ TCP è¿›è¡Œè¿æ¥å±‚é¢çš„æµé‡æ§åˆ¶ï¼Œä½¿ç”¨ SSL/TLS åè®®å®ç°ä¼ è¾“å®‰å…¨ï¼Œä½¿ç”¨ DNS è¿›è¡ŒåŸŸåè§£æï¼Œä½¿ç”¨ HTTP è¿›è¡Œåº”ç”¨æ•°æ®çš„ä¼ è¾“ã€‚</p>
<p>è€Œä¸”è¿‘ä¸‰åå¹´æ¥ï¼Œè¿™å‡ ä¸ªåè®®çš„å‘å±•éƒ½éå¸¸ç¼“æ…¢ã€‚TCP ä¸»è¦æ˜¯æ‹¥å¡æ§åˆ¶ç®—æ³•çš„æ”¹è¿›ï¼ŒSSL/TLS åŸºæœ¬ä¸Šåœç•™åœ¨åŸåœ°ï¼Œå‡ ä¸ªå°ç‰ˆæœ¬çš„æ”¹åŠ¨ä¸»è¦æ˜¯å¯†ç å¥—ä»¶çš„å‡çº§ï¼ŒTLS1.3[3] æ˜¯ä¸€ä¸ªé£è·ƒå¼çš„å˜åŒ–ï¼Œä½†æˆªæ­¢åˆ°ä»Šå¤©ï¼Œè¿˜æ²¡æœ‰æ­£å¼å‘å¸ƒã€‚IPv4 è™½ç„¶æœ‰ä¸€ä¸ªå¤§çš„è¿›æ­¥ï¼Œå®ç°äº† IPv6ï¼ŒDNS ä¹Ÿå¢åŠ äº†ä¸€ä¸ªå®‰å…¨çš„ DNSSECï¼Œä½†å’Œ IPv6 ä¸€æ ·ï¼Œéƒ¨ç½²è¿›åº¦è¾ƒæ…¢ã€‚</p>
<p>éšç€ç§»åŠ¨äº’è”ç½‘å¿«é€Ÿå‘å±•ä»¥åŠç‰©è”ç½‘çš„é€æ­¥å…´èµ·ï¼Œç½‘ç»œäº¤äº’çš„åœºæ™¯è¶Šæ¥è¶Šä¸°å¯Œï¼Œç½‘ç»œä¼ è¾“çš„å†…å®¹ä¹Ÿè¶Šæ¥è¶Šåºå¤§ï¼Œç”¨æˆ·å¯¹ç½‘ç»œä¼ è¾“æ•ˆç‡å’Œ WEB å“åº”é€Ÿåº¦çš„è¦æ±‚ä¹Ÿè¶Šæ¥è¶Šé«˜ã€‚</p>
<p>ä¸€æ–¹é¢æ˜¯å†å²æ‚ ä¹…ä½¿ç”¨å¹¿æ³›çš„å¤è€åè®®ï¼Œå¦å¤–ä¸€æ–¹é¢ç”¨æˆ·çš„ä½¿ç”¨åœºæ™¯å¯¹ä¼ è¾“æ€§èƒ½çš„è¦æ±‚åˆè¶Šæ¥è¶Šé«˜ã€‚å¦‚ä¸‹å‡ ä¸ªç”±æ¥å·²ä¹…çš„é—®é¢˜å’ŒçŸ›ç›¾å°±å˜å¾—è¶Šæ¥è¶Šçªå‡ºã€‚</p>
<ol>
<li>åè®®å†å²æ‚ ä¹…å¯¼è‡´ä¸­é—´è®¾å¤‡åƒµåŒ–ã€‚</li>
<li>ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„å®ç°å¯¼è‡´åè®®æœ¬èº«åƒµåŒ–ã€‚</li>
<li>å»ºç«‹è¿æ¥çš„æ¡æ‰‹å»¶è¿Ÿå¤§ã€‚</li>
<li>é˜Ÿå¤´é˜»å¡ã€‚</li>
</ol>
<p>è¿™é‡Œåˆ†å°èŠ‚ç®€å•è¯´æ˜ä¸€ä¸‹ï¼š</p>
<h2 id="ä¸­é—´è®¾å¤‡çš„åƒµåŒ–"><a href="#ä¸­é—´è®¾å¤‡çš„åƒµåŒ–" class="headerlink" title="ä¸­é—´è®¾å¤‡çš„åƒµåŒ–"></a>ä¸­é—´è®¾å¤‡çš„åƒµåŒ–</h2><p>å¯èƒ½æ˜¯ TCP åè®®ä½¿ç”¨å¾—å¤ªä¹…ï¼Œä¹Ÿéå¸¸å¯é ã€‚æ‰€ä»¥æˆ‘ä»¬å¾ˆå¤šä¸­é—´è®¾å¤‡ï¼ŒåŒ…æ‹¬é˜²ç«å¢™ã€NAT ç½‘å…³ï¼Œæ•´æµå™¨ç­‰å‡ºç°äº†ä¸€äº›çº¦å®šä¿—æˆçš„åŠ¨ä½œã€‚</p>
<p>æ¯”å¦‚æœ‰äº›é˜²ç«å¢™åªå…è®¸é€šè¿‡ 80 å’Œ 443ï¼Œä¸æ”¾é€šå…¶ä»–ç«¯å£ã€‚NAT ç½‘å…³åœ¨è½¬æ¢ç½‘ç»œåœ°å€æ—¶é‡å†™ä¼ è¾“å±‚çš„å¤´éƒ¨ï¼Œæœ‰å¯èƒ½å¯¼è‡´åŒæ–¹æ— æ³•ä½¿ç”¨æ–°çš„ä¼ è¾“æ ¼å¼ã€‚æ•´æµå™¨å’Œä¸­é—´ä»£ç†æœ‰æ—¶å€™å‡ºäºå®‰å…¨çš„éœ€è¦ï¼Œä¼šåˆ é™¤ä¸€äº›å®ƒä»¬ä¸è®¤è¯†çš„é€‰é¡¹å­—æ®µã€‚</p>
<p>TCP åè®®æœ¬æ¥æ˜¯æ”¯æŒç«¯å£ã€é€‰é¡¹åŠç‰¹æ€§çš„å¢åŠ å’Œä¿®æ”¹ã€‚ä½†æ˜¯ç”±äº TCP åè®®å’ŒçŸ¥åç«¯å£åŠé€‰é¡¹ä½¿ç”¨çš„å†å²å¤ªæ‚ ä¹…ï¼Œä¸­é—´è®¾å¤‡å·²ç»ä¾èµ–äºè¿™äº›æ½œè§„åˆ™ï¼Œæ‰€ä»¥å¯¹è¿™äº›å†…å®¹çš„ä¿®æ”¹å¾ˆå®¹æ˜“é­åˆ°ä¸­é—´ç¯èŠ‚çš„å¹²æ‰°è€Œå¤±è´¥ã€‚</p>
<p>è€Œè¿™äº›å¹²æ‰°ï¼Œä¹Ÿå¯¼è‡´å¾ˆå¤šåœ¨ TCP åè®®ä¸Šçš„ä¼˜åŒ–å˜å¾—å°å¿ƒè°¨æ…ï¼Œæ­¥å±¥ç»´è‰°ã€‚</p>
<h2 id="ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„å®ç°å¯¼è‡´åè®®åƒµåŒ–"><a href="#ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„å®ç°å¯¼è‡´åè®®åƒµåŒ–" class="headerlink" title="ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„å®ç°å¯¼è‡´åè®®åƒµåŒ–"></a>ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„å®ç°å¯¼è‡´åè®®åƒµåŒ–</h2><p>TCP æ˜¯ç”±æ“ä½œç³»ç»Ÿåœ¨å†…æ ¸è¥¿æ–¹æ ˆå±‚é¢å®ç°çš„ï¼Œåº”ç”¨ç¨‹åºåªèƒ½ä½¿ç”¨ï¼Œä¸èƒ½ç›´æ¥ä¿®æ”¹ã€‚è™½ç„¶åº”ç”¨ç¨‹åºçš„æ›´æ–°è¿­ä»£éå¸¸å¿«é€Ÿå’Œç®€å•ã€‚ä½†æ˜¯ TCP çš„è¿­ä»£å´éå¸¸ç¼“æ…¢ï¼ŒåŸå› å°±æ˜¯æ“ä½œç³»ç»Ÿå‡çº§å¾ˆéº»çƒ¦ã€‚</p>
<p>ç°åœ¨ç§»åŠ¨ç»ˆç«¯æ›´åŠ æµè¡Œï¼Œä½†æ˜¯ç§»åŠ¨ç«¯éƒ¨åˆ†ç”¨æˆ·çš„æ“ä½œç³»ç»Ÿå‡çº§ä¾ç„¶å¯èƒ½æ»åæ•°å¹´æ—¶é—´ã€‚PC ç«¯çš„ç³»ç»Ÿå‡çº§æ»åå¾—æ›´åŠ ä¸¥é‡ï¼Œwindows xp ç°åœ¨è¿˜æœ‰å¤§é‡ç”¨æˆ·åœ¨ä½¿ç”¨ï¼Œå°½ç®¡å®ƒå·²ç»å­˜åœ¨å¿« 20 å¹´ã€‚</p>
<p>æœåŠ¡ç«¯ç³»ç»Ÿä¸ä¾èµ–ç”¨æˆ·å‡çº§ï¼Œä½†æ˜¯ç”±äºæ“ä½œç³»ç»Ÿå‡çº§æ¶‰åŠåˆ°åº•å±‚è½¯ä»¶å’Œè¿è¡Œåº“çš„æ›´æ–°ï¼Œæ‰€ä»¥ä¹Ÿæ¯”è¾ƒä¿å®ˆå’Œç¼“æ…¢ã€‚</p>
<p>è¿™ä¹Ÿå°±æ„å‘³ç€å³ä½¿ TCP æœ‰æ¯”è¾ƒå¥½çš„ç‰¹æ€§æ›´æ–°ï¼Œä¹Ÿå¾ˆéš¾å¿«é€Ÿæ¨å¹¿ã€‚æ¯”å¦‚ TCP Fast Openã€‚å®ƒè™½ç„¶ 2013 å¹´å°±è¢«æå‡ºäº†ï¼Œä½†æ˜¯ Windows å¾ˆå¤šç³»ç»Ÿç‰ˆæœ¬ä¾ç„¶ä¸æ”¯æŒå®ƒã€‚</p>
<h2 id="å»ºç«‹è¿æ¥çš„æ¡æ‰‹å»¶è¿Ÿå¤§"><a href="#å»ºç«‹è¿æ¥çš„æ¡æ‰‹å»¶è¿Ÿå¤§" class="headerlink" title="å»ºç«‹è¿æ¥çš„æ¡æ‰‹å»¶è¿Ÿå¤§"></a>å»ºç«‹è¿æ¥çš„æ¡æ‰‹å»¶è¿Ÿå¤§</h2><p>ä¸ç®¡æ˜¯ HTTP1.0/1.1 è¿˜æ˜¯ HTTPSï¼ŒHTTP2ï¼Œéƒ½ä½¿ç”¨äº† TCP è¿›è¡Œä¼ è¾“ã€‚HTTPS å’Œ HTTP2 è¿˜éœ€è¦ä½¿ç”¨ TLS åè®®æ¥è¿›è¡Œå®‰å…¨ä¼ è¾“ã€‚è¿™å°±å‡ºç°äº†ä¸¤ä¸ªæ¡æ‰‹å»¶è¿Ÿï¼š</p>
<p>1.TCP ä¸‰æ¬¡æ¡æ‰‹å¯¼è‡´çš„ TCP è¿æ¥å»ºç«‹çš„å»¶è¿Ÿã€‚</p>
<p>2.TLS å®Œå…¨æ¡æ‰‹éœ€è¦è‡³å°‘ 2 ä¸ª RTT æ‰èƒ½å»ºç«‹ï¼Œç®€åŒ–æ¡æ‰‹éœ€è¦ 1 ä¸ª RTT çš„æ¡æ‰‹å»¶è¿Ÿã€‚</p>
<p>å¯¹äºå¾ˆå¤šçŸ­è¿æ¥åœºæ™¯ï¼Œè¿™æ ·çš„æ¡æ‰‹å»¶è¿Ÿå½±å“å¾ˆå¤§ï¼Œä¸”æ— æ³•æ¶ˆé™¤ã€‚</p>
<h2 id="é˜Ÿå¤´é˜»å¡"><a href="#é˜Ÿå¤´é˜»å¡" class="headerlink" title="é˜Ÿå¤´é˜»å¡"></a>é˜Ÿå¤´é˜»å¡</h2><p>é˜Ÿå¤´é˜»å¡ä¸»è¦æ˜¯ TCP åè®®çš„å¯é æ€§æœºåˆ¶å¼•å…¥çš„ã€‚TCP ä½¿ç”¨åºåˆ—å·æ¥æ ‡è¯†æ•°æ®çš„é¡ºåºï¼Œæ•°æ®å¿…é¡»æŒ‰ç…§é¡ºåºå¤„ç†ï¼Œå¦‚æœå‰é¢çš„æ•°æ®ä¸¢å¤±ï¼Œåé¢çš„æ•°æ®å°±ç®—åˆ°è¾¾äº†ä¹Ÿä¸ä¼šé€šçŸ¥åº”ç”¨å±‚æ¥å¤„ç†ã€‚</p>
<p>å¦å¤– TLS åè®®å±‚é¢ä¹Ÿæœ‰ä¸€ä¸ªé˜Ÿå¤´é˜»å¡ï¼Œå› ä¸º TLS åè®®éƒ½æ˜¯æŒ‰ç…§ record æ¥å¤„ç†æ•°æ®çš„ï¼Œå¦‚æœä¸€ä¸ª record ä¸­ä¸¢å¤±äº†æ•°æ®ï¼Œä¹Ÿä¼šå¯¼è‡´æ•´ä¸ª record æ— æ³•æ­£ç¡®å¤„ç†ã€‚</p>
<p>æ¦‚æ‹¬æ¥è®²ï¼ŒTCP å’Œ TLS1.2 ä¹‹å‰çš„åè®®å­˜åœ¨ç€ç»“æ„æ€§çš„é—®é¢˜ï¼Œå¦‚æœç»§ç»­åœ¨ç°æœ‰çš„ TCPã€TLS åè®®ä¹‹ä¸Šå®ç°ä¸€ä¸ªå…¨æ–°çš„åº”ç”¨å±‚åè®®ï¼Œä¾èµ–äºæ“ä½œç³»ç»Ÿã€ä¸­é—´è®¾å¤‡è¿˜æœ‰ç”¨æˆ·çš„æ”¯æŒã€‚éƒ¨ç½²æˆæœ¬éå¸¸é«˜ï¼Œé˜»åŠ›éå¸¸å¤§ã€‚</p>
<p>æ‰€ä»¥ QUIC åè®®é€‰æ‹©äº† UDPï¼Œå› ä¸º UDP æœ¬èº«æ²¡æœ‰è¿æ¥çš„æ¦‚å¿µï¼Œä¸éœ€è¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œä¼˜åŒ–äº†è¿æ¥å»ºç«‹çš„æ¡æ‰‹å»¶è¿Ÿï¼ŒåŒæ—¶åœ¨åº”ç”¨ç¨‹åºå±‚é¢å®ç°äº† TCP çš„å¯é æ€§ï¼ŒTLS çš„å®‰å…¨æ€§å’Œ HTTP2 çš„å¹¶å‘æ€§ï¼Œåªéœ€è¦ç”¨æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„åº”ç”¨ç¨‹åºæ”¯æŒ QUIC åè®®ï¼Œå®Œå…¨é¿å¼€äº†æ“ä½œç³»ç»Ÿå’Œä¸­é—´è®¾å¤‡çš„é™åˆ¶ã€‚</p>
<h1 id="0RTTå»ºç«‹è¿æ¥"><a href="#0RTTå»ºç«‹è¿æ¥" class="headerlink" title="0RTTå»ºç«‹è¿æ¥"></a>0RTTå»ºç«‹è¿æ¥</h1><p>ç°å¦‚ä»Šï¼Œé«˜é€Ÿä¸”å®‰å…¨çš„ç½‘ç»œæ¥å…¥æœåŠ¡å·²ç»æˆä¸ºäººä»¬çš„å¿…é¡»ã€‚ä¼ ç»Ÿ TCP+TLS æ„å»ºçš„å®‰å…¨äº’è”æœåŠ¡ï¼Œå‡çº§ä¸è¡¥ä¸æ›´æ–°æ—¶æœ‰æå‡ºï¼ˆå¦‚ TCP Fastopenï¼Œæ–°çš„ TLS 1.3ï¼‰ï¼Œä½†æ˜¯ç”±äºåŸºç¡€è®¾æ–½åƒµåŒ–ï¼Œå‡çº§ä¸åº”ç”¨å›°éš¾ã€‚ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒGoogle å¦è¾Ÿè¹Šå¾„åœ¨ UDP çš„åŸºç¡€ä¸Šå®ç°äº†å¸¦åŠ å¯†çš„æ›´å¥½çš„ TCPâ€“QUICï¼ˆQuick UDP Internet Connection), ä¸€ç§åŸºäº UDP çš„ä½æ—¶å»¶çš„äº’è”ç½‘ä¼ è¾“å±‚åè®®ã€‚è¿‘æœŸæˆç«‹äº† Working Group ä¹Ÿå°† QUIC ä½œä¸ºåˆ¶å®š HTTP 3.0 çš„æ ‡å‡†çš„åŸºç¡€, è¯´æ˜ QUIC çš„åº”ç”¨å‰æ™¯ç¾å¥½ã€‚æœ¬æ–‡å•ç‹¬å°±ç½‘ç»œä¼ è¾“çš„å»ºè¿é—®é¢˜å±•å¼€äº†åˆ†æ, æµ…æäº†å»ºè¿æ—¶é—´å¯¹ä¼ è¾“çš„å½±å“, ä»¥åŠ QUIC çš„ 0-RTT å»ºè¿æ˜¯å¦‚ä½•è§£å†³å»ºè¿è€—æ—¶é•¿çš„é—®é¢˜çš„ã€‚åœ¨æ­¤åŸºç¡€ä¸Š, ç»“åˆ QUIC çš„æºç , æµ…æäº† QUIC çš„åŸºæœ¬å®ç°, å¹¶æè¿°ä¸€ç§å¯ä¾›å‚è€ƒçš„åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ 0-RTT çš„è½åœ°å®è·µæ–¹æ¡ˆã€‚</p>
<p>ä»¥ä¸€æ¬¡ç®€å•çš„ HTTPS è¯·æ±‚ï¼ˆexample.comï¼‰ä¸ºä¾‹ï¼ˆå‡è®¾è®¿é—® example.com æ—¶è¿”å›çš„å†…å®¹è¾ƒå°ï¼Œserver ç«¯å¯ä»¥åœ¨ä¸€ä¸ªæ•°æ®åŒ…é‡Œè¿”å›å“åº”ï¼‰ï¼Œä¸ºè·å–è¯·æ±‚èµ„æºã€‚éœ€è¦ç»è¿‡ä»¥ä¸‹ 4 ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>DNS æŸ¥è¯¢ example.com è·å– IPã€‚DNS æœåŠ¡ä¸€èˆ¬é»˜è®¤æ˜¯ç”±ä½ çš„ ISP æä¾›ï¼ŒISP é€šå¸¸éƒ½ä¼šæœ‰ç¼“å­˜çš„ï¼Œè¿™éƒ¨åˆ†æ—¶é—´èƒ½é€‚å½“å‡å°‘ï¼›</li>
<li>TCP æ¡æ‰‹ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰çš„ TCP ä¸‰æ¬¡æ¡æ‰‹éœ€è¦éœ€è¦ 1 ä¸ª RTTï¼›</li>
<li>TLS æ¡æ‰‹ï¼Œä»¥ç›®å‰åº”ç”¨æœ€å¹¿æ³›çš„ TLS 1.2 è€Œè¨€ï¼Œéœ€è¦ 2 ä¸ª RTTã€‚å¯¹äºéé¦–æ¬¡å»ºè¿, å¯ä»¥é€‰æ‹©å¯ç”¨ä¼šè¯é‡ç”¨ (Session Resumption)ï¼Œåˆ™å¯ç¼©å°æ¡æ‰‹æ—¶é—´åˆ° 1 ä¸ª RTTï¼›</li>
<li>HTTP ä¸šåŠ¡æ•°æ®äº¤äº’ï¼Œå‡è®¾ example.com çš„æ•°æ®åœ¨ä¸€æ¬¡äº¤äº’å°±èƒ½å–å›æ¥ã€‚é‚£ä¹ˆä¸šåŠ¡æ•°æ®çš„äº¤äº’éœ€è¦ 1 ä¸ª RTTï¼› ç»è¿‡ä¸Šé¢çš„è¿‡ç¨‹åˆ†æå¯çŸ¥ï¼Œè¦å®Œæˆä¸€æ¬¡ç®€çŸ­çš„ HTTPS ä¸šåŠ¡æ•°æ®äº¤äº’ï¼Œéœ€è¦ç»å†ï¼š</li>
</ol>
<ul>
<li>æ–°è¿æ¥ï¼š4RTT + DNSã€‚</li>
<li>ä¼šè¯é‡ç”¨ï¼š3RTT + DNS</li>
</ul>
<p>å°¤å…¶å¯¹äºå°æ•°æ®é‡çš„äº¤äº’è€Œè¨€ï¼ŒæŠ›å¼€ DNS æŸ¥è¯¢æ—¶é—´, å»ºè¿æ—¶é—´å å‰©ä¸‹çš„æ€»æ—¶é—´çš„ 2/3 è‡³ 3/4 ä¸ç­‰ï¼Œå½±å“ä¸å¯å°è§‘ã€‚åŠ ä¹‹å¦‚æœç”¨æˆ·ç½‘ç»œä¸å¥½ï¼ŒRTT å»¶æ—¶å¤§çš„è¯ï¼Œå»ºè¿æ—¶é—´å¯èƒ½è€—è´¹æ•°ç™¾æ¯«ç§’è‡³æ•°ç§’ä¸ç­‰ï¼Œè¿™å°†æå¤§çš„å½±å“ç”¨æˆ·ä½“éªŒã€‚ç©¶å…¶åŸå› ä¸€æ–¹é¢æ˜¯ TCP å’Œ TLS åˆ†å±‚è®¾è®¡å¯¼è‡´çš„ï¼šåˆ†å±‚çš„è®¾è®¡éœ€è¦æ¯ä¸ªé€»è¾‘å±‚æ¬¡åˆ†åˆ«å»ºç«‹è‡ªå·±çš„è¿æ¥çŠ¶æ€ã€‚å¦ä¸€æ–¹é¢æ˜¯ TLS çš„æ¡æ‰‹é˜¶æ®µå¤æ‚çš„å¯†é’¥åå•†æœºåˆ¶å¯¼è‡´çš„ã€‚è¦é™ä½å»ºè¿è€—æ—¶ï¼Œéœ€è¦ä»è¿™ä¸¤æ–¹é¢ç€æ‰‹ã€‚</p>
<p>é’ˆå¯¹ TLS çš„æ¡æ‰‹é˜¶æ®µå¤æ‚çš„å¯†é’¥åå•†æœºé—®é¢˜, TLS 1.3 ç²¾ç®€äº†æ¡æ‰‹äº¤äº’è¿‡ç¨‹, å®ç°äº† 1-RTT æ¡æ‰‹ã€‚åœ¨ä¼šè¯é‡ç”¨ç±»ä¼¼çš„ç†å¿µçš„åŸºç¡€ä¸Š, å¯¹éé¦–æ¬¡æ¡æ‰‹ä¼šè¯, å¯ä»¥è¿›ä¸€æ­¥å®ç° 0-RTT æ¡æ‰‹ (åœ¨åˆšå¼€å§‹ TLS å¯†é’¥åå•†çš„æ—¶å€™ï¼Œå°±èƒ½é™„é€ä¸€éƒ¨åˆ†ç»è¿‡åŠ å¯†çš„æ•°æ®ä¼ é€’ç»™å¯¹æ–¹)ã€‚ç”±äº TLS æ˜¯å»ºç«‹åœ¨ TCP ä¹‹ä¸Šçš„, 0-RTT æ²¡æœ‰è®¡ç®— TCP å±‚çš„æ¡æ‰‹å¼€é”€, å› è€Œå¯¹ç”¨æˆ·æ¥è¯´, å‘é€æ•°æ®ä¹‹å‰è¿˜æ˜¯è¦ç»å† TCP å±‚çš„ 1RTT æ¡æ‰‹, å› è€Œä¸æ˜¯çœŸæ­£çš„ 0-RTT æ¡æ‰‹ã€‚</p>
<blockquote>
<p>TLS 1.3 ä¸ºå®ç° 0-RTTï¼Œéœ€è¦åŒæ–¹åœ¨åˆšå¼€å§‹å»ºç«‹è¿æ¥çš„æ—¶å€™å°±å·²ç»æŒæœ‰ä¸€ä¸ªå¯¹ç§°å¯†é’¥ï¼Œè¿™ä¸ªå¯†é’¥åœ¨ TLS 1.3 ä¸­ç§°ä¸º PSKï¼ˆPre-Shared-Keyï¼‰ã€‚PSK æ˜¯ TLS 1.2 ä¸­çš„ä¼šè¯é‡ç”¨ (Session Resumption) æœºåˆ¶çš„ä¸€ä¸ªå‡çº§ï¼ŒTLS 1.3 æ¡æ‰‹ç»“æŸåï¼ŒæœåŠ¡å™¨å¯ä»¥å‘é€ä¸€ä¸ª NSTï¼ˆNew-Session-Ticketï¼‰çš„æŠ¥æ–‡ç»™å®¢æˆ·ç«¯ï¼Œè¯¥æŠ¥æ–‡ä¸­è®°å½• PSK çš„å€¼ã€åå­—å’Œæœ‰æ•ˆæœŸç­‰ä¿¡æ¯ï¼ŒåŒæ–¹ä¸‹ä¸€æ¬¡å»ºç«‹è¿æ¥å¯ä»¥ä½¿ç”¨è¯¥ PSK å€¼ä½œä¸ºåˆå§‹å¯†é’¥ææ–™ã€‚å› ä¸º PSK æ˜¯ä»ä»¥å‰å»ºç«‹çš„å®‰å…¨ä¿¡é“ä¸­è·å¾—çš„ï¼Œåªè¦è¯æ˜äº†åŒæ–¹éƒ½æŒæœ‰ç›¸åŒçš„ PSKï¼Œä¸å†éœ€è¦è¯ä¹¦è®¤è¯ï¼Œå°±å¯ä»¥è¯æ˜åŒæ–¹çš„èº«ä»½(å› æ­¤ PSK ä¹Ÿæ˜¯ä¸€ç§èº«ä»½è®¤è¯æœºåˆ¶)ã€‚TLS 1.3 æ–°åŠ äº† Early Data ç±»å‹çš„æŠ¥æ–‡, ç”¨äºåœ¨ 0-RTT çš„æ¡æ‰‹é˜¶æ®µä¼ é€’åº”ç”¨å±‚æ•°æ®, å®ç°äº†æ¡æ‰‹çš„åŒæ—¶å°±èƒ½é™„å¸¦åŠ å¯†çš„åº”ç”¨å±‚æ•°æ®ä»è€Œå®ç° 0-RTTã€‚</p>
<p>TLS 1.3 çš„ 0-RTT ç‰¹æ€§ä¸èƒ½é˜²æ­¢é‡æ”¾æ”»å‡», éœ€è¦ä¸šåŠ¡åœ¨ä½¿ç”¨æ—¶è¯„ä¼°æ˜¯å¦æœ‰é‡æ”¾æ”»å‡»é£é™©ã€‚å¦‚æœ‰ç›¸å…³é£é™©çš„è¯, å¯èƒ½éœ€è¦é…Œæƒ…è€ƒè™‘ç¦ç”¨ 0-RTT ç‰¹æ€§ã€‚</p>
</blockquote>
<p>ä¸‹å›¾å¯¹æ¯”äº† TLS å„ç‰ˆæœ¬ä¸åœºæ™¯ä¸‹çš„å»¶æ—¶å¯¹æ¯”:<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/quic_intro/quic_intro_1.jpg" alt></p>
<p>TLS å„ç‰ˆæœ¬ä¸åœºæ™¯ä¸‹çš„è€—æ—¶</p>
<p>ä»å¯¹æ¯”æˆ‘ä»¬å¯ä»¥çœ‹åˆ°, å³ä½¿ç”¨ä¸Šäº† TLS 1.3, ç²¾ç®€äº†æ¡æ‰‹è¿‡ç¨‹, æœ€å¿«èƒ½åšåˆ° 0-RTT æ¡æ‰‹ (é¦–æ¬¡æ˜¯ 1-RTT), ä½†æ˜¯å¯¹ç”¨æˆ·æ„ŸçŸ¥è€Œè¨€, è¿˜è¦åŠ ä¸Š 1RTT çš„ TCP æ¡æ‰‹å¼€é”€ã€‚ Google æœ‰æå‡º Fastopen çš„æ–¹æ¡ˆæ¥ä½¿å¾— TCP éé¦–æ¬¡æ¡æ‰‹å°±èƒ½é™„å¸¦ç”¨æˆ·æ•°æ®, ä½†æ˜¯ç”±äº TCP å®ç°åƒµåŒ–, æ— æ³•å‡çº§åº”ç”¨, ç›¸å…³ RFC åˆ°ç°ä»Šéƒ½æ˜¯ experimental çŠ¶æ€ã€‚è¿™ç§åˆ†å±‚è®¾è®¡å¸¦æ¥çš„å»¶æ—¶, æœ‰æ²¡æœ‰åŠæ³•è¿›ä¸€æ­¥é™ä½å‘¢? QUIC é€šè¿‡åˆå¹¶åŠ å¯†ä¸è¿æ¥ç®¡ç†è§£å†³äº†è¿™ä¸ªé—®é¢˜, æˆ‘ä»¬æ¥çœ‹çœ‹å…¶æ˜¯å¦‚ä½•å®ç°çœŸæ­£æ„ä¹‰ä¸Šçš„ 0-RTT çš„æ¡æ‰‹, è®©ä¸ server è¿›è¡Œç¬¬ä¸€ä¸ªæ•°æ®åŒ…çš„äº¤äº’å°±èƒ½å¸¦ä¸Šç”¨æˆ·æ•°æ®ã€‚</p>
<p>QUIC ä¸ºè§„é¿ TCP åè®®åƒµåŒ–çš„é—®é¢˜ï¼Œå°† QUIC åè®®å»ºç«‹åœ¨äº† UDP ä¹‹ä¸Šã€‚è€ƒè™‘åˆ°å®‰å…¨æ€§æ˜¯ç½‘ç»œçš„å¿…å¤‡é€‰é¡¹ï¼ŒåŠ å¯†åœ¨ QUIC é‡Œå¼ºåˆ¶çš„ã€‚ä¼ è¾“æ–¹é¢å‚è€ƒ TCP å¹¶å……åˆ†ä¼˜åŒ–äº† TCP å¤šå¹´å‘ç°çš„ç¼ºé™·å’Œä¸è¶³, å®ç°äº†ä¸€å¥—ç«¯åˆ°ç«¯çš„å¯é åŠ å¯†ä¼ è¾“ã€‚é€šè¿‡å°†åŠ å¯†å’Œè¿æ¥ç®¡ç†ä¸¤å±‚åˆäºŒä¸ºä¸€ï¼Œæ¶ˆé™¤äº†å½“å‰ TCP+TLS çš„åˆ†å±‚è®¾è®¡ä¼ è¾“å¼•å…¥çš„æ—¶å»¶ã€‚</p>
<p>åŒ TLS çš„æ¡æ‰‹ä¸€æ ·, QUIC çš„åŠ å¯†æ¡æ‰‹çš„æ ¸å¿ƒåœ¨äºåå•†å‡ºä¸€ä¸ªåŠ å¯†ä¼šè¯æ•°æ®çš„å¯¹ç§°å¯†é’¥ã€‚QUIC çš„æ¡æ‰‹ä½¿ç”¨äº† DH å¯†é’¥åå•†ç®—æ³•æ¥åå•†ä¸€ä¸ªå¯¹ç§°å¯†é’¥ã€‚DH å¯†é’¥åå•†ç®—æ³•ç®€å•æ¥è®², éœ€è¦é€šä¿¡åŒæ–¹å„è‡ªç”Ÿæˆè‡ªå·±çš„éå¯¹ç§°å…¬ç§é’¥å¯¹, åŒå‘å„è‡ªä¿ç•™è‡ªå·±çš„ç§é’¥, å°†å…¬é’¥å‘ç»™å¯¹æ–¹, åˆ©ç”¨å¯¹æ–¹çš„å…¬é’¥å’Œè‡ªå·±çš„ç§é’¥å¯ä»¥è¿ç®—å‡ºåŒä¸€ä¸ªå¯¹ç§°å¯†é’¥ã€‚è¯¦ç»†çš„åŸç†è¿™é‡Œä¸å±•å¼€å™è¿°, æœ‰ä¸“ä¸šçš„<a href="https://book.douban.com/subject/19986936/" target="_blank" rel="noopener">å¯†ç å­¦ä¹¦ç±</a>å¯¹å…¶åŸç†æœ‰è¯¦ç»†çš„è®ºè¿°, ç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šå¥½çš„æ•™ç¨‹å¯¹å…¶ç”±æ·±å…¥æµ…å‡ºçš„æ€»ç»“, å¦‚<a href="https://labuladong.gitbook.io/algo/di-wu-zhang-ji-suan-ji-ji-shu/mi-ma-ji-shu" target="_blank" rel="noopener">è¿™ä¸€ç¯‡</a>ã€‚</p>
<p>å¦‚ä¸Šæ‰€è¿°, DH å¯†é’¥åå•†éœ€è¦é€šè¡ŒåŒæ–¹å„è‡ªç”Ÿæˆè‡ªå·±çš„éå¯¹ç§°å…¬ç§é’¥å¯¹ã€‚server ç«¯ä¸å®¢æˆ·ç«¯çš„å…³ç³»æ˜¯ 1 å¯¹ N çš„å…³ç³», æ˜æ˜¾ server ç«¯ç”Ÿæˆä¸€ä»½å…¬ç§é’¥å¯¹, è®© N ä¸ªå®¢æˆ·ç«¯å…¬ç”¨, èƒ½æ˜æ˜¾å‡å°‘ç”Ÿæˆå¼€é”€, é™ä½ç®¡ç†çš„æˆæœ¬ã€‚server ç«¯çš„è¿™ä»½å…¬ç§é’¥å¯¹å°±æ˜¯ä¸“é—¨ç”¨äºæ¡æ‰‹ä½¿ç”¨çš„, å®¢æˆ·ç«¯ä¸€ç»è·å–, å°±å¯ä»¥ç¼“å­˜ä¸‹æ¥åç»­å»ºè¿æ—¶ç»§ç»­ä½¿ç”¨, è¿™ä¸ªå°±æ˜¯è¾¾æˆ 0-RTT æ¡æ‰‹çš„å…³é”®, å› æ­¤ server ç”Ÿæˆçš„è¿™ä»½å…¬é’¥ç§°ä¸º 0-RTT æ¡æ‰‹å…¬é’¥ã€‚çœŸæ­£çš„æ¡æ‰‹è¿‡ç¨‹æ˜¯è¿™æ · (ç®€åŒ–äº†å®ç°ç»†èŠ‚):</p>
<ol>
<li>server ç«¯åœ¨æ¡æ‰‹å¼€å§‹å‰ï¼Œserver ç«¯éœ€è¦é¦–å…ˆç”Ÿæˆ (æˆ–åŠ è½½ä½¿ç”¨ä¸Šæ¬¡ä¿å­˜ä¸‹æ¥çš„) æ¡æ‰‹å…¬ç§é’¥å¯¹, è¯¥ä»½å…¬ç§é’¥å¯¹æ˜¯æ‰€æœ‰å®¢æˆ·ç«¯å…±äº«çš„ã€‚</li>
<li>client ç«¯é¦–æ¬¡æ¡æ‰‹æ—¶, client å¯¹ server ä¸€æ— æ‰€çŸ¥, éœ€è¦ 1 ä¸ª RTT æ¥è¯¢é—® server ç«¯çš„æ¡æ‰‹å…¬é’¥ (å®é™…çš„æ¡æ‰‹äº¤äº’è¿˜ä¼šå‘é€è¯¸å¦‚ç‰ˆæœ¬ç­‰å…¶ä»–æ•°æ®) å¹¶ç¼“å­˜ä¸‹æ¥ã€‚æœ¬æ­¥éª¤åªåœ¨é¦–æ¬¡å»ºè¿æ—¶å‘ç”Ÿ(0-RTT æ¡æ‰‹å…¬é’¥çš„è¿‡æœŸä¹Ÿä¼šå¯¼è‡´éœ€è¦é‡èµ°è¿™ä¸€æ­¥), ä½†è¿™ç§æƒ…å†µå¾ˆå°‘å‘ç”Ÿ, å½±å“å¾ˆå°(ä¹Ÿæ²¡åŠæ³•é¿å…)ã€‚</li>
<li>client æ”¶åˆ° server ç«¯è¿”å›è¿™ä»½æ¡æ‰‹å…¬é’¥åï¼Œç”Ÿæˆè‡ªå·±çš„ä¸´æ—¶å…¬ç§é’¥å¯¹å, è®¡ç®—å‡ºå…±äº«çš„å¯¹ç§°å¯†é’¥å, åŠ å¯†å¥½æ•°æ®, å¹¶è¿åŒ client çš„å…¬é’¥ä¸€å¹¶å‘ç»™ server ç«¯ã€‚ç…§ DH å¯†é’¥åå•†çš„åŸç†, æ­¤å¤„å·²ç»å¯ä»¥åå•†å‡ºæ¯æ¡ä¼šè¯ä¸ä¸€æ ·çš„ä¼šè¯å¯†é’¥äº† (å› ä¸ºæ¯ä¸ª client ç”Ÿæˆçš„å…¬ç§é’¥æ˜¯ä¸åŒçš„), æ˜¯ä¸æ˜¯æ‹¿è¿™ä¸ªæ¥åŠ å¯†ä¼šè¯æ•°æ®å°±è¡Œäº†å‘¢? çœŸå®çš„æƒ…å†µä¸æ˜¯è¿™æ ·çš„!</li>
<li>server ç«¯ä¼šå†æ¬¡ç”Ÿæˆä¸€ä»½ä¸´æ—¶çš„å…¬ç§é’¥å¯¹ï¼Œä½¿ç”¨è¿™ä»½ä¸´æ—¶çš„ç§é’¥ä¸å®¢æˆ·ç«¯çš„å…¬é’¥è¿ç®—å‡ºæœ€ç»ˆçš„ä¼šè¯å¯¹ç§°å¯†é’¥ã€‚æ¥ä¸‹æ¥ server ä¼šæ‹¿è¿™ä¸ªæœ€ç»ˆçš„ä¼šè¯å¯†é’¥åŠ å¯†åº”ç”¨å±‚æ•°æ®, è¿åŒè¿™ä»½ä¸´æ—¶çš„ server ç«¯å…¬é’¥ä¸€å¹¶å‘ç»™ client ç«¯, client ç«¯æ”¶åˆ°åå¯ä»¥æŒ‰ç…§ DH çš„åŸç†ä¾ç“¢ç”»è‘«ä¼šæ¢å¤å‡ºæœ€ç»ˆçš„ä¼šè¯å¯¹ç§°å¯†é’¥ã€‚åç»­æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯ç”¨æœ€ç»ˆçš„ä¼šè¯å¯¹ç§°å¯†é’¥è¿›è¡ŒåŠ å¯†ã€‚server ä¾§è¿™ä¸ªåŠ¨ä½œæ˜¯ä¸æ˜¯å¤šæ­¤ä¸€ä¸¾å‘¢? ä¸æ˜¯çš„, è¿™ä¹ˆåšçš„ç›®çš„æ˜¯ä¸ºäº†è·å–æ‰€è°“çš„å‰å‘å®‰å…¨ç‰¹æ€§: å› ä¸º server ç«¯çš„åé¢ç”Ÿæˆçš„è¿™ä»½å…¬ç§é’¥æ˜¯ä¸´æ—¶ç”Ÿæˆçš„, ä¸ä¼šä¿å­˜ä¸‹æ¥ï¼Œä¹Ÿå°±æœç»äº†å¯†é’¥æ³„æ¼å¯¼è‡´ä¼šè¯æ•°æ®è¢«æ¶æ„æ”¶é›†åçš„è¢«è§£å¯†æ‰çš„é£é™©ã€‚</li>
</ol>
<p>é¦–æ¬¡æ¡æ‰‹è¦å¤šä¸€ä¸ª RTT è¯¢é—® server ç«¯çš„ 0-RTT æ¡æ‰‹å…¬é’¥, æ­¤è¯¢é—®è¿‡ç¨‹ä¸æºå¸¦ä»»ä½•åº”ç”¨å±‚æ•°æ®, å› æ­¤æ˜¯ 1-RTT æ¡æ‰‹ã€‚åœ¨é¦–æ¬¡æ¡æ‰‹å®Œæˆå, client ç«¯å¯ä»¥ç¼“å­˜ä¸‹ç¬¬ä¸€æ¬¡è¯¢é—®è·çŸ¥çš„ server ç«¯çš„å…¬é’¥ä¿¡æ¯, åç»­çš„è¿æ¥è¿‡ç¨‹å¯ä»¥è·³è¿‡è¯¢é—®ï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ server ç«¯çš„å…¬é’¥ã€‚å…¬é’¥ä¿¡æ¯åœ¨ QUIC çš„å®ç°é‡Œæ˜¯ä¿å­˜åœ¨æ¡æ‰‹æ•°æ®åŒ…é‡Œçš„ SCFG ä¸­çš„ (Server Config), è·å– 0-RTT æ¡æ‰‹å…¬é’¥å°±æ˜¯è¦è·å– SCFG, åç»­å‡ä»¥è·å– SCFG ä»£æ›¿ã€‚è¯¦ç»†çš„æ¡æ‰‹è¿‡ç¨‹, å¯ä»¥å‚è§ <a href="https://blog.csdn.net/dog250/article/details/80935534" target="_blank" rel="noopener">dog250</a> åšå®¢æ–‡ç« çš„è¯¦ç»†å™è¿°ã€‚</p>
<blockquote>
<p>ä»ä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼Œ0-RTT æ¡æ‰‹çš„é¦–æ¬¡äº¤äº’ï¼Œserver ç«¯ä½¿ç”¨çš„æ˜¯ä¿å­˜ä¸‹æ¥çš„æ¡æ‰‹å¯†é’¥ï¼Œå› è€Œæ²¡æœ‰æ— æ³•åšåˆ°å‰å‘å®‰å…¨ï¼Œä¸èƒ½é˜²æ­¢é‡æ”¾æ”»å‡», éœ€è¦ä¸šåŠ¡åœ¨ä½¿ç”¨æ—¶è¯„ä¼°æ˜¯å¦æœ‰é‡æ”¾æ”»å‡»é£é™©ã€‚</p>
</blockquote>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/quic_intro/quic_intro_1_2.jpg" alt></p>
<p>QUIC 0-RTT æ¡æ‰‹</p>
<p>ä¸Šæ–‡ç®€è¿°äº† QUIC æ¡æ‰‹çš„å¯†é’¥åå•†è¿‡ç¨‹ï¼Œé¦–æ¬¡éœ€è¦è¯¢é—®ä¸€æ¬¡ Server ä»¥è·å– SCFG, ä»è€Œè·å–å­˜å‚¨äºå…¶ä¸­çš„ 0-RTT æ¡æ‰‹å…¬é’¥ã€‚è¿™ä¸€äº¤äº’è¿‡ç¨‹ä¸­ client å’Œ server åœ¨ QUIC çš„æ¡æ‰‹åè®®å‘é€çš„æŠ¥æ–‡ä¸­åˆ†åˆ«å« Inchoate Client hello message (inchoate CHLO) å’Œ Rejection message (REJ)ã€‚å› è€ŒåŒ…å« server ç«¯çš„æ¡æ‰‹å…¬é’¥çš„ SCFG æ˜¯åœ¨ REJ æŠ¥æ–‡ä¸­å‘ç»™å®¢æˆ·ç«¯çš„ã€‚æœ‰äº† SCFGï¼Œæ¥ä¸‹æ¥å°±èƒ½å‘èµ· 0-RTT æ¡æ‰‹ã€‚è¿™ä¸€è¿‡ç¨‹ä¸­ client å’Œ server ç«¯åœ¨ QUIC çš„æ¡æ‰‹åè®®å‘é€çš„æŠ¥æ–‡ä¸­åˆ†åˆ«å« Full Client Hello message (full CHLO) å’Œ Server Hello message (SHLO)ã€‚ä¸‹å›¾æ‘˜è‡ª Google QUIC æ¡æ‰‹åè®®çš„å®˜æ–¹æ–‡æ¡£ï¼Œè¯¦ç»†å™è¿°äº†æ¡æ‰‹è¿‡ç¨‹ client ä¾§çš„å¤„ç†æµç¨‹ï¼š</p>
<p>QUIC æ¡æ‰‹å®¢æˆ·ç«¯ä¾§å¤„ç†æµç¨‹<br><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/quic_intro/quic_intro_1_3.jpg" alt></p>
<h2 id="0RTTçš„é‡æ”¾æ”»å‡»é£é™©"><a href="#0RTTçš„é‡æ”¾æ”»å‡»é£é™©" class="headerlink" title="0RTTçš„é‡æ”¾æ”»å‡»é£é™©"></a>0RTTçš„é‡æ”¾æ”»å‡»é£é™©</h2><p>0-RTTè¿æ¥æ¢å¤å¹¶éé‚£ä¹ˆç®€å•ï¼Œå®ƒä¼šå¸¦æ¥è®¸å¤šæ„å¤–é£é™©åŠè­¦å‘Šï¼Œè¿™æ­£æ˜¯ä¸ºä»€ä¹ˆæœ‰äº›é»˜è®¤ç¨‹åºä¸å¯ç”¨0-RTTè¿æ¥æ¢å¤çš„åŸå› ã€‚ç”¨æˆ·å¿…é¡»æå‰è€ƒè™‘æ‰€æ¶‰åŠçš„é£é™©ï¼Œå¹¶åšå‡ºå†³å®šæ˜¯å¦ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚å¯ä»¥åœ¨åº”ç”¨ç¨‹åºå±‚é¢ä½¿ç”¨é¢„é˜²æªæ–½æ¥å‡è½»è¿™ç§æƒ…å†µã€‚</p>
<p>é¦–å…ˆï¼Œ0-RTTè¿æ¥æ¢å¤æ˜¯ä¸æä¾›forwardsecrecyçš„ï¼Œé’ˆå¯¹è¿æ¥çš„secret parametersçš„å¦¥åå°†å¾®ä¸è¶³é“åœ°å…è®¸æ¢å¤æ–°è¿æ¥0-RTTé˜¶æ®µæœŸé—´ï¼Œå‘é€applicationdata è¿›è¡Œç‰¹å®šçš„å¦¥åã€‚</p>
<p>åœ¨0-RTTé˜¶æ®µä¹‹åã€æˆ–æ¡æ‰‹ä¹‹åå‘é€çš„æ•°æ®ï¼Œä»ç„¶æ˜¯å®‰å…¨çš„ã€‚è¿™æ˜¯å› ä¸ºTLS1.3 (åŠQUIC)è¿˜æ˜¯ä¼šå¯¹handshakecompletionä¹‹åå‘é€çš„æ•°æ®æ‰§è¡Œnormal key exchange algorithm (è¿™æ˜¯forwardsecret) ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨0-RTTæœŸé—´å‘é€çš„applicationdata å¯ä»¥è¢«è·¯å¾„ä¸Šçš„on-path attacker æ•è·ï¼Œç„¶åå¤šæ¬¡é‡æ’­åˆ°åŒä¸€ä¸ªæœåŠ¡å™¨ã€‚è¿™ä¸ªåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¹Ÿè®¸ä¸æ˜¯é—®é¢˜ï¼Œå› ä¸ºattackeræ— æ³•è§£å¯†æ•°æ®ï¼Œ0-RTTè¿æ¥æ¢å¤è¿˜æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚åœ¨å…¶ä»–çš„æƒ…å†µä¸‹ï¼Œè¿™å¯èƒ½ä¼šå¼•èµ·å‡ºä¹æ„æ–™çš„é£é™©ã€‚</p>
<p>ä¸¾ä¸ªæ¯”ä¾‹ï¼Œå‡è®¾ä¸€å®¶é“¶è¡Œå…è®¸authenticated user (e.g using HTTPcookie, æˆ–å…¶ä»–HTTPèº«ä»½éªŒè¯æœºåˆ¶)é€šè¿‡specificAPI endpointå‘å‡ºHTTPè¯·æ±‚å°†èµ„é‡‘ä»å…¶è´¦æˆ·å‘é€åˆ°å¦ä¸€ä¸ªç”¨æˆ·ã€‚</p>
<p>å¦‚æœattackerèƒ½å¤Ÿåœ¨ä½¿ç”¨0-RTTè¿æ¥æ¢å¤æ—¶æ•è·è¯¥è¯·æ±‚ï¼Œä»–ä»¬å°†æ— æ³•çœ‹åˆ°plaintextå¹¶ä¸”è·å–ç”¨æˆ·çš„å‡­æ®ï¼ŒåŸå› æ˜¯å› ä¸ºä»–ä»¬ä¸çŸ¥é“ç”¨äºåŠ å¯†æ•°æ®çš„secretkeyï¼›ä½†æ˜¯ä»–ä»¬ä»ç„¶æœ‰å¯èƒ½ä¸€ç›´æ•£å‘é‡å¤æ€§åœ°è¯·æ±‚ï¼Œè€—å°½è¯¥ç”¨æˆ·çš„é“¶è¡Œè´¦æˆ·é‡Œçš„é’±ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/quic_intro/quic_intro_1_4.jpg" alt></p>
<h1 id="æ”¹è¿›çš„æ‹¥å¡æ§åˆ¶"><a href="#æ”¹è¿›çš„æ‹¥å¡æ§åˆ¶" class="headerlink" title="æ”¹è¿›çš„æ‹¥å¡æ§åˆ¶"></a>æ”¹è¿›çš„æ‹¥å¡æ§åˆ¶</h1><p>TCP çš„æ‹¥å¡æ§åˆ¶å®é™…ä¸ŠåŒ…å«äº†å››ä¸ªç®—æ³•ï¼šæ…¢å¯åŠ¨ï¼Œæ‹¥å¡é¿å…ï¼Œå¿«é€Ÿé‡ä¼ ï¼Œå¿«é€Ÿæ¢å¤ [22]ã€‚</p>
<p>QUIC åè®®å½“å‰é»˜è®¤ä½¿ç”¨äº† TCP åè®®çš„ Cubic æ‹¥å¡æ§åˆ¶ç®—æ³• [6]ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒ CubicBytes, Reno, RenoBytes, BBR, PCC ç­‰æ‹¥å¡æ§åˆ¶ç®—æ³•ã€‚</p>
<p>ä»æ‹¥å¡ç®—æ³•æœ¬èº«æ¥çœ‹ï¼ŒQUIC åªæ˜¯æŒ‰ç…§ TCP åè®®é‡æ–°å®ç°äº†ä¸€éï¼Œé‚£ä¹ˆ QUIC åè®®åˆ°åº•æ”¹è¿›åœ¨å“ªäº›æ–¹é¢å‘¢ï¼Ÿä¸»è¦æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š</p>
<h1 id="å¯æ’æ‹”"><a href="#å¯æ’æ‹”" class="headerlink" title="å¯æ’æ‹”"></a>å¯æ’æ‹”</h1><p>ä»€ä¹ˆå«å¯æ’æ‹”å‘¢ï¼Ÿå°±æ˜¯èƒ½å¤Ÿéå¸¸çµæ´»åœ°ç”Ÿæ•ˆï¼Œå˜æ›´å’Œåœæ­¢ã€‚ä½“ç°åœ¨å¦‚ä¸‹æ–¹é¢ï¼š</p>
<ol>
<li>åº”ç”¨ç¨‹åºå±‚é¢å°±èƒ½å®ç°ä¸åŒçš„æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼Œä¸éœ€è¦æ“ä½œç³»ç»Ÿï¼Œä¸éœ€è¦å†…æ ¸æ”¯æŒã€‚è¿™æ˜¯ä¸€ä¸ªé£è·ƒï¼Œå› ä¸ºä¼ ç»Ÿçš„ TCP æ‹¥å¡æ§åˆ¶ï¼Œå¿…é¡»è¦ç«¯åˆ°ç«¯çš„ç½‘ç»œåè®®æ ˆæ”¯æŒï¼Œæ‰èƒ½å®ç°æ§åˆ¶æ•ˆæœã€‚è€Œå†…æ ¸å’Œæ“ä½œç³»ç»Ÿçš„éƒ¨ç½²æˆæœ¬éå¸¸é«˜ï¼Œå‡çº§å‘¨æœŸå¾ˆé•¿ï¼Œè¿™åœ¨äº§å“å¿«é€Ÿè¿­ä»£ï¼Œç½‘ç»œçˆ†ç‚¸å¼å¢é•¿çš„ä»Šå¤©ï¼Œæ˜¾ç„¶æœ‰ç‚¹æ»¡è¶³ä¸äº†éœ€æ±‚ã€‚</li>
<li>å³ä½¿æ˜¯å•ä¸ªåº”ç”¨ç¨‹åºçš„ä¸åŒè¿æ¥ä¹Ÿèƒ½æ”¯æŒé…ç½®ä¸åŒçš„æ‹¥å¡æ§åˆ¶ã€‚å°±ç®—æ˜¯ä¸€å°æœåŠ¡å™¨ï¼Œæ¥å…¥çš„ç”¨æˆ·ç½‘ç»œç¯å¢ƒä¹Ÿåƒå·®ä¸‡åˆ«ï¼Œç»“åˆå¤§æ•°æ®åŠäººå·¥æ™ºèƒ½å¤„ç†ï¼Œæˆ‘ä»¬èƒ½ä¸ºå„ä¸ªç”¨æˆ·æä¾›ä¸åŒçš„ä½†åˆæ›´åŠ ç²¾å‡†æ›´åŠ æœ‰æ•ˆçš„æ‹¥å¡æ§åˆ¶ã€‚æ¯”å¦‚ BBR é€‚åˆï¼ŒCubic é€‚åˆã€‚</li>
<li>åº”ç”¨ç¨‹åºä¸éœ€è¦åœæœºå’Œå‡çº§å°±èƒ½å®ç°æ‹¥å¡æ§åˆ¶çš„å˜æ›´ï¼Œæˆ‘ä»¬åœ¨æœåŠ¡ç«¯åªéœ€è¦ä¿®æ”¹ä¸€ä¸‹é…ç½®ï¼Œreload ä¸€ä¸‹ï¼Œå®Œå…¨ä¸éœ€è¦åœæ­¢æœåŠ¡å°±èƒ½å®ç°æ‹¥å¡æ§åˆ¶çš„åˆ‡æ¢ã€‚</li>
</ol>
<p>STGW åœ¨é…ç½®å±‚é¢è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥é’ˆå¯¹ä¸åŒä¸šåŠ¡ï¼Œä¸åŒç½‘ç»œåˆ¶å¼ï¼Œç”šè‡³ä¸åŒçš„ RTTï¼Œä½¿ç”¨ä¸åŒçš„æ‹¥å¡æ§åˆ¶ç®—æ³•ã€‚</p>
<h1 id="å•è°ƒé€’å¢çš„-Packet-Number"><a href="#å•è°ƒé€’å¢çš„-Packet-Number" class="headerlink" title="å•è°ƒé€’å¢çš„ Packet Number"></a>å•è°ƒé€’å¢çš„ Packet Number</h1><p>TCP ä¸ºäº†ä¿è¯å¯é æ€§ï¼Œä½¿ç”¨äº†åŸºäºå­—èŠ‚åºå·çš„ Sequence Number åŠ Ack æ¥ç¡®è®¤æ¶ˆæ¯çš„æœ‰åºåˆ°è¾¾ã€‚</p>
<p>QUIC åŒæ ·æ˜¯ä¸€ä¸ªå¯é çš„åè®®ï¼Œå®ƒä½¿ç”¨ Packet Number ä»£æ›¿äº† TCP çš„ sequence numberï¼Œå¹¶ä¸”æ¯ä¸ª Packet Number éƒ½ä¸¥æ ¼é€’å¢ï¼Œä¹Ÿå°±æ˜¯è¯´å°±ç®— Packet N ä¸¢å¤±äº†ï¼Œé‡ä¼ çš„ Packet N çš„ Packet Number å·²ç»ä¸æ˜¯ Nï¼Œè€Œæ˜¯ä¸€ä¸ªæ¯” N å¤§çš„å€¼ã€‚è€Œ TCP å‘¢ï¼Œé‡ä¼  segment çš„ sequence number å’ŒåŸå§‹çš„ segment çš„ Sequence Number ä¿æŒä¸å˜ï¼Œä¹Ÿæ­£æ˜¯ç”±äºè¿™ä¸ªç‰¹æ€§ï¼Œå¼•å…¥äº† Tcp é‡ä¼ çš„æ­§ä¹‰é—®é¢˜ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/quic_intro/quic_intro_2.jpg" alt></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¶…æ—¶äº‹ä»¶ RTO å‘ç”Ÿåï¼Œå®¢æˆ·ç«¯å‘èµ·é‡ä¼ ï¼Œç„¶åæ¥æ”¶åˆ°äº† Ack æ•°æ®ã€‚ç”±äºåºåˆ—å·ä¸€æ ·ï¼Œè¿™ä¸ª Ack æ•°æ®åˆ°åº•æ˜¯åŸå§‹è¯·æ±‚çš„å“åº”è¿˜æ˜¯é‡ä¼ è¯·æ±‚çš„å“åº”å‘¢ï¼Ÿä¸å¥½åˆ¤æ–­ã€‚</p>
<p>å¦‚æœç®—æˆåŸå§‹è¯·æ±‚çš„å“åº”ï¼Œä½†å®é™…ä¸Šæ˜¯é‡ä¼ è¯·æ±‚çš„å“åº”ï¼ˆä¸Šå›¾å·¦ï¼‰ï¼Œä¼šå¯¼è‡´é‡‡æ · RTT å˜å¤§ã€‚å¦‚æœç®—æˆé‡ä¼ è¯·æ±‚çš„å“åº”ï¼Œä½†å®é™…ä¸Šæ˜¯åŸå§‹è¯·æ±‚çš„å“åº”ï¼Œåˆå¾ˆå®¹æ˜“å¯¼è‡´é‡‡æ · RTT è¿‡å°ã€‚</p>
<p>ç”±äº Quic é‡ä¼ çš„ Packet å’ŒåŸå§‹ Packet çš„ Pakcet Number æ˜¯ä¸¥æ ¼é€’å¢çš„ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/quic_intro/quic_intro_3.jpg" alt></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒRTO å‘ç”Ÿåï¼Œæ ¹æ®é‡ä¼ çš„ Packet Number å°±èƒ½ç¡®å®šç²¾ç¡®çš„ RTT è®¡ç®—ã€‚å¦‚æœ Ack çš„ Packet Number æ˜¯ N+Mï¼Œå°±æ ¹æ®é‡ä¼ è¯·æ±‚è®¡ç®—é‡‡æ · RTTã€‚å¦‚æœ Ack çš„ Pakcet Number æ˜¯ Nï¼Œå°±æ ¹æ®åŸå§‹è¯·æ±‚çš„æ—¶é—´è®¡ç®—é‡‡æ · RTTï¼Œæ²¡æœ‰æ­§ä¹‰æ€§ã€‚</p>
<p>ä½†æ˜¯å•çº¯ä¾é ä¸¥æ ¼é€’å¢çš„ Packet Number è‚¯å®šæ˜¯æ— æ³•ä¿è¯æ•°æ®çš„é¡ºåºæ€§å’Œå¯é æ€§ã€‚QUIC åˆå¼•å…¥äº†ä¸€ä¸ª Stream Offset çš„æ¦‚å¿µã€‚</p>
<p>å³ä¸€ä¸ª Stream å¯ä»¥ç»è¿‡å¤šä¸ª Packet ä¼ è¾“ï¼ŒPacket Number ä¸¥æ ¼é€’å¢ï¼Œæ²¡æœ‰ä¾èµ–ã€‚ä½†æ˜¯ Packet é‡Œçš„ Payload å¦‚æœæ˜¯ Stream çš„è¯ï¼Œå°±éœ€è¦ä¾é  Stream çš„ Offset æ¥ä¿è¯åº”ç”¨æ•°æ®çš„é¡ºåºã€‚å¦‚é”™è¯¯! æœªæ‰¾åˆ°å¼•ç”¨æºã€‚æ‰€ç¤ºï¼Œå‘é€ç«¯å…ˆåå‘é€äº† Pakcet N å’Œ Pakcet N+1ï¼ŒStream çš„ Offset åˆ†åˆ«æ˜¯ x å’Œ x+yã€‚</p>
<p>å‡è®¾ Packet N ä¸¢å¤±äº†ï¼Œå‘èµ·é‡ä¼ ï¼Œé‡ä¼ çš„ Packet Number æ˜¯ N+2ï¼Œä½†æ˜¯å®ƒçš„ Stream çš„ Offset ä¾ç„¶æ˜¯ xï¼Œè¿™æ ·å°±ç®— Packet N + 2 æ˜¯ååˆ°çš„ï¼Œä¾ç„¶å¯ä»¥å°† Stream x å’Œ Stream x+y æŒ‰ç…§é¡ºåºç»„ç»‡èµ·æ¥ï¼Œäº¤ç»™åº”ç”¨ç¨‹åºå¤„ç†ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/quic_intro/quic_intro_4.jpg" alt></p>
<h1 id="ä¸å…è®¸-Reneging"><a href="#ä¸å…è®¸-Reneging" class="headerlink" title="ä¸å…è®¸ Reneging"></a>ä¸å…è®¸ Reneging</h1><p>ä»€ä¹ˆå« Reneging å‘¢ï¼Ÿå°±æ˜¯æ¥æ”¶æ–¹ä¸¢å¼ƒå·²ç»æ¥æ”¶å¹¶ä¸”ä¸ŠæŠ¥ç»™ SACK é€‰é¡¹çš„å†…å®¹ [8]ã€‚TCP åè®®ä¸é¼“åŠ±è¿™ç§è¡Œä¸ºï¼Œä½†æ˜¯åè®®å±‚é¢å…è®¸è¿™æ ·çš„è¡Œä¸ºã€‚ä¸»è¦æ˜¯è€ƒè™‘åˆ°æœåŠ¡å™¨èµ„æºæœ‰é™ï¼Œæ¯”å¦‚ Buffer æº¢å‡ºï¼Œå†…å­˜ä¸å¤Ÿç­‰æƒ…å†µã€‚</p>
<p>Reneging å¯¹æ•°æ®é‡ä¼ ä¼šäº§ç”Ÿå¾ˆå¤§çš„å¹²æ‰°ã€‚å› ä¸º Sack éƒ½å·²ç»è¡¨æ˜æ¥æ”¶åˆ°äº†ï¼Œä½†æ˜¯æ¥æ”¶ç«¯äº‹å®ä¸Šä¸¢å¼ƒäº†è¯¥æ•°æ®ã€‚</p>
<p>QUIC åœ¨åè®®å±‚é¢ç¦æ­¢ Renegingï¼Œä¸€ä¸ª Packet åªè¦è¢« Ackï¼Œå°±è®¤ä¸ºå®ƒä¸€å®šè¢«æ­£ç¡®æ¥æ”¶ï¼Œå‡å°‘äº†è¿™ç§å¹²æ‰°ã€‚</p>
<h1 id="æ›´å¤šçš„-Ack-å—"><a href="#æ›´å¤šçš„-Ack-å—" class="headerlink" title="æ›´å¤šçš„ Ack å—"></a>æ›´å¤šçš„ Ack å—</h1><p>TCP çš„ Sack é€‰é¡¹èƒ½å¤Ÿå‘Šè¯‰å‘é€æ–¹å·²ç»æ¥æ”¶åˆ°çš„è¿ç»­ Segment çš„èŒƒå›´ï¼Œæ–¹ä¾¿å‘é€æ–¹è¿›è¡Œé€‰æ‹©æ€§é‡ä¼ ã€‚</p>
<p>ç”±äº TCP å¤´éƒ¨æœ€å¤§åªæœ‰ 60 ä¸ªå­—èŠ‚ï¼Œæ ‡å‡†å¤´éƒ¨å ç”¨äº† 20 å­—èŠ‚ï¼Œæ‰€ä»¥ Tcp Option æœ€å¤§é•¿åº¦åªæœ‰ 40 å­—èŠ‚ï¼Œå†åŠ ä¸Š Tcp Timestamp option å ç”¨äº† 10 ä¸ªå­—èŠ‚ [25]ï¼Œæ‰€ä»¥ç•™ç»™ Sack é€‰é¡¹çš„åªæœ‰ 30 ä¸ªå­—èŠ‚ã€‚</p>
<p>æ¯ä¸€ä¸ª Sack Block çš„é•¿åº¦æ˜¯ 8 ä¸ªï¼ŒåŠ ä¸Š Sack Option å¤´éƒ¨ 2 ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ„å‘³ç€ Tcp Sack Option æœ€å¤§åªèƒ½æä¾› 3 ä¸ª Blockã€‚</p>
<p>ä½†æ˜¯ Quic Ack Frame å¯ä»¥åŒæ—¶æä¾› 256 ä¸ª Ack Blockï¼Œåœ¨ä¸¢åŒ…ç‡æ¯”è¾ƒé«˜çš„ç½‘ç»œä¸‹ï¼Œæ›´å¤šçš„ Sack Block å¯ä»¥æå‡ç½‘ç»œçš„æ¢å¤é€Ÿåº¦ï¼Œå‡å°‘é‡ä¼ é‡ã€‚</p>
<h1 id="Ack-Delay-æ—¶é—´"><a href="#Ack-Delay-æ—¶é—´" class="headerlink" title="Ack Delay æ—¶é—´"></a>Ack Delay æ—¶é—´</h1><p>Tcp çš„ Timestamp é€‰é¡¹å­˜åœ¨ä¸€ä¸ªé—®é¢˜ [25]ï¼Œå®ƒåªæ˜¯å›æ˜¾äº†å‘é€æ–¹çš„æ—¶é—´æˆ³ï¼Œä½†æ˜¯æ²¡æœ‰è®¡ç®—æ¥æ”¶ç«¯æ¥æ”¶åˆ° segment åˆ°å‘é€ Ack è¯¥ segment çš„æ—¶é—´ã€‚è¿™ä¸ªæ—¶é—´å¯ä»¥ç®€ç§°ä¸º Ack Delayã€‚</p>
<p>è¿™æ ·å°±ä¼šå¯¼è‡´ RTT è®¡ç®—è¯¯å·®ã€‚å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/quic_intro/quic_intro_5.jpg" alt></p>
<ul>
<li>å¯ä»¥è®¤ä¸º TCP çš„ RTT è®¡ç®—ï¼š<code>RTT = timestamp2 - timestamp1</code></li>
<li>è€Œ Quic è®¡ç®—å¦‚ä¸‹ï¼š<code>RTT = timestamp2 - timestamp1 - AckDelay</code></li>
</ul>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/quic_intro/quic_intro_3.jpg" alt></p>
<p>å½“ç„¶ RTT çš„å…·ä½“è®¡ç®—æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œéœ€è¦é‡‡æ ·ï¼Œå‚è€ƒå†å²æ•°å€¼è¿›è¡Œå¹³æ»‘è®¡ç®—ï¼Œå‚è€ƒå¦‚ä¸‹å…¬å¼<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SRTT = SRTT + Î±(RTT - SRTT)</span><br><span class="line">RTO = Î¼ * SRTT + Î´*DevRTT</span><br></pre></td></tr></table></figure></p>
<h1 id="åŸºäº-stream-å’Œ-connecton-çº§åˆ«çš„æµé‡æ§åˆ¶"><a href="#åŸºäº-stream-å’Œ-connecton-çº§åˆ«çš„æµé‡æ§åˆ¶" class="headerlink" title="åŸºäº stream å’Œ connecton çº§åˆ«çš„æµé‡æ§åˆ¶"></a>åŸºäº stream å’Œ connecton çº§åˆ«çš„æµé‡æ§åˆ¶</h1><p>QUIC çš„æµé‡æ§åˆ¶ [22] ç±»ä¼¼ HTTP2ï¼Œå³åœ¨ Connection å’Œ Strea6 çº§åˆ«æä¾›äº†ä¸¤ç§æµé‡æ§åˆ¶ã€‚ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ç±»æµé‡æ§åˆ¶å‘¢ï¼Ÿä¸»è¦æ˜¯å› ä¸º QUIC æ”¯æŒå¤šè·¯å¤ç”¨ã€‚</p>
<ol>
<li>Stream å¯ä»¥è®¤ä¸ºå°±æ˜¯ä¸€æ¡ HTTP è¯·æ±‚ã€‚</li>
<li>Connection å¯ä»¥ç±»æ¯”ä¸€æ¡ TCP è¿æ¥ã€‚å¤šè·¯å¤ç”¨æ„å‘³ç€åœ¨ä¸€7 Connetion ä¸Šä¼šåŒæ—¶å­˜åœ¨å¤šæ¡ Streamã€‚æ—¢éœ€è¦å¯¹å•ä¸ª Stream è¿›è¡Œæ§åˆ¶ï¼Œåˆéœ€è¦é’ˆå¯¹æ‰€æœ‰ Stream è¿›è¡Œæ€»ä½“æ§åˆ¶ã€‚</li>
</ol>
<p>QUIC å®ç°æµé‡æ§åˆ¶çš„åŸç†æ¯”è¾ƒç®€å•ï¼š</p>
<p>é€šè¿‡ window_update å¸§å‘Šè¯‰å¯¹ç«¯è‡ªå·±å¯ä»¥æ¥æ”¶çš„å­—èŠ‚æ•°ï¼Œè¿™æ ·å‘é€æ–¹å°±ä¸ä¼šå‘é€è¶…è¿‡è¿™ä¸ªæ•°é‡çš„æ•°æ®ã€‚</p>
<p>é€šè¿‡ BlockFrame å‘Šè¯‰å¯¹ç«¯ç”±äºæµé‡æ§åˆ¶è¢«é˜»å¡äº†ï¼Œæ— æ³•å‘é€æ•°æ®ã€‚</p>
<p>QUIC çš„æµé‡æ§åˆ¶å’Œ TCP æœ‰ç‚¹åŒºåˆ«ï¼ŒTCP ä¸ºäº†ä¿è¯å¯é æ€§ï¼Œçª—å£å·¦è¾¹æ²¿å‘å³æ»‘åŠ¨æ—¶çš„é•¿åº¦å–å†³äºå·²ç»ç¡®è®¤çš„å­—èŠ‚æ•°ã€‚å¦‚æœä¸­é—´å‡ºç°ä¸¢åŒ…ï¼Œå°±ç®—æ¥æ”¶åˆ°äº†æ›´å¤§åºå·çš„ Segmentï¼Œçª—å£ä¹Ÿæ— æ³•è¶…è¿‡è¿™ä¸ªåºåˆ—å·ã€‚</p>
<p>ä½† QUIC ä¸åŒï¼Œå°±ç®—æ­¤å‰æœ‰äº› packet æ²¡æœ‰æ¥æ”¶åˆ°ï¼Œå®ƒçš„æ»‘åŠ¨åªå–å†³äºæ¥æ”¶åˆ°çš„æœ€å¤§åç§»å­—èŠ‚æ•°ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/quic_intro/quic_intro_6.jpg" alt></p>
<ul>
<li>é’ˆå¯¹ Streamï¼š<code>å¯ç”¨çª—å£ = æœ€å¤§çª—å£æ•° - æ¥æ”¶åˆ°çš„æœ€å¤§åç§»æ•°</code></li>
<li>é’ˆå¯¹ Connectionï¼š<code>å¯ç”¨çª—å£ = stream1å¯ç”¨çª—å£ + stream2å¯ç”¨çª—å£ + ... + streamNå¯ç”¨çª—å£</code></li>
</ul>
<p>åŒæ ·åœ°ï¼ŒSTGW ä¹Ÿåœ¨è¿æ¥å’Œ Stream çº§åˆ«è®¾ç½®äº†ä¸åŒçš„çª—å£æ•°ã€‚</p>
<p>æœ€é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å†…å­˜ä¸è¶³æˆ–è€…ä¸Šæ¸¸å¤„ç†æ€§èƒ½å‡ºç°é—®é¢˜æ—¶ï¼Œé€šè¿‡æµé‡æ§åˆ¶æ¥é™åˆ¶ä¼ è¾“é€Ÿç‡ï¼Œä¿éšœæœåŠ¡å¯ç”¨æ€§ã€‚</p>
<h1 id="æ²¡æœ‰é˜Ÿå¤´é˜»å¡çš„å¤šè·¯å¤ç”¨"><a href="#æ²¡æœ‰é˜Ÿå¤´é˜»å¡çš„å¤šè·¯å¤ç”¨" class="headerlink" title="æ²¡æœ‰é˜Ÿå¤´é˜»å¡çš„å¤šè·¯å¤ç”¨"></a>æ²¡æœ‰é˜Ÿå¤´é˜»å¡çš„å¤šè·¯å¤ç”¨</h1><p>QUIC çš„å¤šè·¯å¤ç”¨å’Œ HTTP2 ç±»ä¼¼ã€‚åœ¨ä¸€æ¡ QUIC è¿æ¥ä¸Šå¯ä»¥å¹¶å‘å‘é€å¤šä¸ª HTTP è¯·æ±‚ (stream)ã€‚ä½†æ˜¯ QUIC çš„å¤šè·¯å¤ç”¨ç›¸æ¯” HTTP2 æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ä¼˜åŠ¿ã€‚</p>
<p>QUIC ä¸€ä¸ªè¿æ¥ä¸Šçš„å¤šä¸ª stream ä¹‹é—´æ²¡æœ‰ä¾èµ–ã€‚è¿™æ ·å‡å¦‚ stream2 ä¸¢äº†ä¸€ä¸ª udp packetï¼Œä¹Ÿåªä¼šå½±å“ stream2 çš„å¤„ç†ã€‚ä¸ä¼šå½±å“ stream2 ä¹‹å‰åŠä¹‹åçš„ stream çš„å¤„ç†ã€‚</p>
<p>è¿™ä¹Ÿå°±åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šç¼“è§£ç”šè‡³æ¶ˆé™¤äº†é˜Ÿå¤´é˜»å¡çš„å½±å“ã€‚</p>
<p>å¤šè·¯å¤ç”¨æ˜¯ HTTP2 æœ€å¼ºå¤§çš„ç‰¹æ€§ [7]ï¼Œèƒ½å¤Ÿå°†å¤šæ¡è¯·æ±‚åœ¨ä¸€æ¡ TCP è¿æ¥ä¸ŠåŒæ—¶å‘å‡ºå»ã€‚ä½†ä¹Ÿæ¶åŒ–äº† TCP çš„ä¸€ä¸ªé—®é¢˜ï¼Œé˜Ÿå¤´é˜»å¡ [11]ï¼Œå¦‚ä¸‹å›¾ç¤ºï¼š</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/quic_intro/quic_intro_7.jpg" alt></p>
<p>HTTP2 åœ¨ä¸€ä¸ª TCP è¿æ¥ä¸ŠåŒæ—¶å‘é€ 4 ä¸ª Streamã€‚å…¶ä¸­ Stream1 å·²ç»æ­£ç¡®åˆ°è¾¾ï¼Œå¹¶è¢«åº”ç”¨å±‚è¯»å–ã€‚ä½†æ˜¯ Stream2 çš„ç¬¬ä¸‰ä¸ª tcp segment ä¸¢å¤±äº†ï¼ŒTCP ä¸ºäº†ä¿è¯æ•°æ®çš„å¯é æ€§ï¼Œéœ€è¦å‘é€ç«¯é‡ä¼ ç¬¬ 3 ä¸ª segment æ‰èƒ½é€šçŸ¥åº”ç”¨å±‚è¯»å–æ¥ä¸‹å»çš„æ•°æ®ï¼Œè™½ç„¶è¿™ä¸ªæ—¶å€™ Stream3 å’Œ Stream4 çš„å…¨éƒ¨æ•°æ®å·²ç»åˆ°è¾¾äº†æ¥æ”¶ç«¯ï¼Œä½†éƒ½è¢«é˜»å¡ä½äº†ã€‚</p>
<p>ä¸ä»…å¦‚æ­¤ï¼Œç”±äº HTTP2 å¼ºåˆ¶ä½¿ç”¨ TLSï¼Œè¿˜å­˜åœ¨ä¸€ä¸ª TLS åè®®å±‚é¢çš„é˜Ÿå¤´é˜»å¡ [12]ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/quic_intro/quic_intro_8.jpg" alt></p>
<p>Record æ˜¯ TLS åè®®å¤„ç†çš„æœ€å°å•ä½ï¼Œæœ€å¤§ä¸èƒ½è¶…è¿‡ 16Kï¼Œä¸€äº›æœåŠ¡å™¨æ¯”å¦‚ Nginx é»˜è®¤çš„å¤§å°å°±æ˜¯ 16Kã€‚ç”±äºä¸€ä¸ª record å¿…é¡»ç»è¿‡æ•°æ®ä¸€è‡´æ€§æ ¡éªŒæ‰èƒ½è¿›è¡ŒåŠ è§£å¯†ï¼Œæ‰€ä»¥ä¸€ä¸ª 16K çš„ recordï¼Œå°±ç®—ä¸¢äº†ä¸€ä¸ªå­—èŠ‚ï¼Œä¹Ÿä¼šå¯¼è‡´å·²ç»æ¥æ”¶åˆ°çš„ 15.99K æ•°æ®æ— æ³•å¤„ç†ï¼Œå› ä¸ºå®ƒä¸å®Œæ•´ã€‚</p>
<p>é‚£ QUIC å¤šè·¯å¤ç”¨ä¸ºä»€ä¹ˆèƒ½é¿å…ä¸Šè¿°é—®é¢˜å‘¢ï¼Ÿ</p>
<ol>
<li>QUIC æœ€åŸºæœ¬çš„ä¼ è¾“å•å…ƒæ˜¯ Packetï¼Œä¸ä¼šè¶…è¿‡ MTU çš„å¤§å°ï¼Œæ•´ä¸ªåŠ å¯†å’Œè®¤è¯è¿‡ç¨‹éƒ½æ˜¯åŸºäº Packet çš„ï¼Œä¸ä¼šè·¨è¶Šå¤šä¸ª Packetã€‚è¿™æ ·å°±èƒ½é¿å… TLS åè®®å­˜åœ¨çš„é˜Ÿå¤´é˜»å¡ã€‚</li>
<li>Stream ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œæ¯”å¦‚ Stream2 ä¸¢äº†ä¸€ä¸ª Pakcetï¼Œä¸ä¼šå½±å“ Stream3 å’Œ Stream4ã€‚ä¸å­˜åœ¨ TCP é˜Ÿå¤´é˜»å¡ã€‚</li>
</ol>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/quic_intro/quic_intro_9.jpg" alt></p>
<p>å½“ç„¶ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ QUIC æ•°æ®éƒ½ä¸ä¼šå—åˆ°é˜Ÿå¤´é˜»å¡çš„å½±å“ï¼Œæ¯”å¦‚ QUIC å½“å‰ä¹Ÿæ˜¯ä½¿ç”¨ Hpack å‹ç¼©ç®—æ³• [10]ï¼Œç”±äºç®—æ³•çš„é™åˆ¶ï¼Œä¸¢å¤±ä¸€ä¸ªå¤´éƒ¨æ•°æ®æ—¶ï¼Œå¯èƒ½é‡åˆ°é˜Ÿå¤´é˜»å¡ã€‚</p>
<p>æ€»ä½“æ¥è¯´ï¼ŒQUIC åœ¨ä¼ è¾“å¤§é‡æ•°æ®æ—¶ï¼Œæ¯”å¦‚è§†é¢‘ï¼Œå—åˆ°é˜Ÿå¤´é˜»å¡çš„å½±å“å¾ˆå°ã€‚</p>
<h1 id="åŠ å¯†è®¤è¯çš„æŠ¥æ–‡"><a href="#åŠ å¯†è®¤è¯çš„æŠ¥æ–‡" class="headerlink" title="åŠ å¯†è®¤è¯çš„æŠ¥æ–‡"></a>åŠ å¯†è®¤è¯çš„æŠ¥æ–‡</h1><p>TCP åè®®å¤´éƒ¨æ²¡æœ‰ç»è¿‡ä»»ä½•åŠ å¯†å’Œè®¤è¯ï¼Œæ‰€ä»¥åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­å¾ˆå®¹æ˜“è¢«ä¸­é—´ç½‘ç»œè®¾å¤‡ç¯¡æ”¹ï¼Œæ³¨å…¥å’Œçªƒå¬ã€‚æ¯”å¦‚ä¿®æ”¹åºåˆ—å·ã€æ»‘åŠ¨çª—å£ã€‚è¿™äº›è¡Œä¸ºæœ‰å¯èƒ½æ˜¯å‡ºäºæ€§èƒ½ä¼˜åŒ–ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸»åŠ¨æ”»å‡»ã€‚</p>
<p>ä½†æ˜¯ QUIC çš„ packet å¯ä»¥è¯´æ˜¯æ­¦è£…åˆ°äº†ç‰™é½¿ã€‚é™¤äº†ä¸ªåˆ«æŠ¥æ–‡æ¯”å¦‚ PUBLIC_RESET å’Œ CHLOï¼Œæ‰€æœ‰æŠ¥æ–‡å¤´éƒ¨éƒ½æ˜¯ç»è¿‡è®¤è¯çš„ï¼ŒæŠ¥æ–‡ Body éƒ½æ˜¯ç»è¿‡åŠ å¯†çš„ã€‚</p>
<p>è¿™æ ·åªè¦å¯¹ QUIC æŠ¥æ–‡ä»»ä½•ä¿®æ”¹ï¼Œæ¥æ”¶ç«¯éƒ½èƒ½å¤ŸåŠæ—¶å‘ç°ï¼Œæœ‰æ•ˆåœ°é™ä½äº†å®‰å…¨é£é™©ã€‚</p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¢è‰²éƒ¨åˆ†æ˜¯ Stream Frame çš„æŠ¥æ–‡å¤´éƒ¨ï¼Œæœ‰è®¤è¯ã€‚ç»¿è‰²éƒ¨åˆ†æ˜¯æŠ¥æ–‡å†…å®¹ï¼Œå…¨éƒ¨ç»è¿‡åŠ å¯†ã€‚</p>
<p><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/img/quic_intro/quic_intro_10.jpg" alt></p>
<h1 id="è¿æ¥è¿ç§»"><a href="#è¿æ¥è¿ç§»" class="headerlink" title="è¿æ¥è¿ç§»"></a>è¿æ¥è¿ç§»</h1><p>ä¸€æ¡ TCP è¿æ¥ [17] æ˜¯ç”±å››å…ƒç»„æ ‡è¯†çš„ï¼ˆæº IPï¼Œæºç«¯å£ï¼Œç›®çš„ IPï¼Œç›®çš„ç«¯å£ï¼‰ã€‚ä»€ä¹ˆå«è¿æ¥è¿ç§»å‘¢ï¼Ÿå°±æ˜¯å½“å…¶ä¸­ä»»ä½•ä¸€ä¸ªå…ƒç´ å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè¿™æ¡è¿æ¥ä¾ç„¶ç»´æŒç€ï¼Œèƒ½å¤Ÿä¿æŒä¸šåŠ¡é€»è¾‘ä¸ä¸­æ–­ã€‚å½“ç„¶è¿™é‡Œé¢ä¸»è¦å…³æ³¨çš„æ˜¯å®¢æˆ·ç«¯çš„å˜åŒ–ï¼Œå› ä¸ºå®¢æˆ·ç«¯ä¸å¯æ§å¹¶ä¸”ç½‘ç»œç¯å¢ƒç»å¸¸å‘ç”Ÿå˜åŒ–ï¼Œè€ŒæœåŠ¡ç«¯çš„ IP å’Œç«¯å£ä¸€èˆ¬éƒ½æ˜¯å›ºå®šçš„ã€‚</p>
<p>æ¯”å¦‚å¤§å®¶ä½¿ç”¨æ‰‹æœºåœ¨ WIFI å’Œ 4G ç§»åŠ¨ç½‘ç»œåˆ‡æ¢æ—¶ï¼Œå®¢æˆ·ç«¯çš„ IP è‚¯å®šä¼šå‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦é‡æ–°å»ºç«‹å’ŒæœåŠ¡ç«¯çš„ TCP è¿æ¥ã€‚</p>
<p>åˆæ¯”å¦‚å¤§å®¶ä½¿ç”¨å…¬å…± NAT å‡ºå£æ—¶ï¼Œæœ‰äº›è¿æ¥ç«äº‰æ—¶éœ€è¦é‡æ–°ç»‘å®šç«¯å£ï¼Œå¯¼è‡´å®¢æˆ·ç«¯çš„ç«¯å£å‘ç”Ÿå˜åŒ–ï¼ŒåŒæ ·éœ€è¦é‡æ–°å»ºç«‹ TCP è¿æ¥ã€‚</p>
<p>é’ˆå¯¹ TCP çš„è¿æ¥å˜åŒ–ï¼ŒMPTCP[5] å…¶å®å·²ç»æœ‰äº†è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯ç”±äº MPTCP éœ€è¦æ“ä½œç³»ç»ŸåŠç½‘ç»œåè®®æ ˆæ”¯æŒï¼Œéƒ¨ç½²é˜»åŠ›éå¸¸å¤§ï¼Œç›®å‰å¹¶ä¸é€‚ç”¨ã€‚</p>
<p>æ‰€ä»¥ä» TCP è¿æ¥çš„è§’åº¦æ¥è®²ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯æ— è§£çš„ã€‚</p>
<p>é‚£ QUIC æ˜¯å¦‚ä½•åšåˆ°è¿æ¥è¿ç§»å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œä»»ä½•ä¸€æ¡ QUIC è¿æ¥ä¸å†ä»¥ IP åŠç«¯å£å››å…ƒç»„æ ‡è¯†ï¼Œè€Œæ˜¯ä»¥ä¸€ä¸ª 64 ä½çš„éšæœºæ•°ä½œä¸º ID æ¥æ ‡è¯†ï¼Œè¿™æ ·å°±ç®— IP æˆ–è€…ç«¯å£å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåªè¦ ID ä¸å˜ï¼Œè¿™æ¡è¿æ¥ä¾ç„¶ç»´æŒç€ï¼Œä¸Šå±‚ä¸šåŠ¡é€»è¾‘æ„ŸçŸ¥ä¸åˆ°å˜åŒ–ï¼Œä¸ä¼šä¸­æ–­ï¼Œä¹Ÿå°±ä¸éœ€è¦é‡è¿ã€‚</p>
<p>ç”±äºè¿™ä¸ª ID æ˜¯å®¢æˆ·ç«¯éšæœºäº§ç”Ÿçš„ï¼Œå¹¶ä¸”é•¿åº¦æœ‰ 64 ä½ï¼Œæ‰€ä»¥å†²çªæ¦‚ç‡éå¸¸ä½ã€‚</p>
<h1 id="å…¶ä»–äº®ç‚¹"><a href="#å…¶ä»–äº®ç‚¹" class="headerlink" title="å…¶ä»–äº®ç‚¹"></a>å…¶ä»–äº®ç‚¹</h1><p>æ­¤å¤–ï¼ŒQUIC è¿˜èƒ½å®ç°å‰å‘å†—ä½™çº é”™ï¼Œåœ¨é‡è¦çš„åŒ…æ¯”å¦‚æ¡æ‰‹æ¶ˆæ¯å‘ç”Ÿä¸¢å¤±æ—¶ï¼Œèƒ½å¤Ÿæ ¹æ®å†—ä½™ä¿¡æ¯è¿˜åŸå‡ºæ¡æ‰‹æ¶ˆæ¯ã€‚</p>
<p>QUIC è¿˜èƒ½å®ç°è¯ä¹¦å‹ç¼©ï¼Œå‡å°‘è¯ä¹¦ä¼ è¾“é‡ï¼Œé’ˆå¯¹åŒ…å¤´è¿›è¡ŒéªŒè¯ç­‰ã€‚</p>
<p>é™äºç¯‡å¹…ï¼Œæœ¬æ–‡ä¸å†è¯¦ç»†ä»‹ç»ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å‚è€ƒæ–‡æ¡£ [23] å’Œæ–‡æ¡£ [4] å’Œæ–‡æ¡£ [26]ã€‚</p>

          
        
      


      

    
      <footer class="post-footer">
        

        

        

        
        
          <div class="post-eof"></div>
        
      </footer>
      
    </div>
    
    
    

    

    

    

  </div>
  
  
  
  </article>


      
    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><a class="page-number" href="/page/11/">11</a><a class="page-number" href="/page/12/">12</a><a class="page-number" href="/page/13/">13</a><a class="page-number" href="/page/14/">14</a><a class="page-number" href="/page/15/">15</a><a class="page-number" href="/page/16/">16</a><a class="page-number" href="/page/17/">17</a><a class="page-number" href="/page/18/">18</a><span class="space">&hellip;</span><a class="page-number" href="/page/38/">38</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  

  <aside id="sidebar" class="sidebar">

    
      
        <div id="sidebar-dimmer"></div>
      
    

    <div class="sidebar-inner">
    
      <div class="sidebar-toggle-inside motion-element">
        <div class="sidebar-toggle-line-wrap">
          <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
          <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
          <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
        </div>
      </div>

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a href="/" class="site-author-image" rel="start" style="border:none">
            <img class="site-author-image" itemprop="image" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSAyNUg0NVYzNUgzNVYyNVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+" data-src="/uploads/avatar.png" alt="Mike">
          </a>
          <p class="site-author-name" itemprop="name">Mike</p>
           
              <p class="site-description motion-element" itemprop="description">ğŸš™ ğŸš— ğŸ’¨ ğŸ’¨ If you want to create a blog like this, just follow my open-source project, "hexo-theme-neo", click the GitHub button below and check it out ^_^ . It is recommended to use Chrome, Safari, or Edge to read this blog since this blog was developed on Edge (Chromium kernel version) and tested on Safari.</p>
          
        </div>

        <nav class="site-state motion-element">

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">298</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">111</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

          <div class="site-state-item site-state-about">
            <a href="/about/">
              <span class="site-state-item-about fa fa-fw fa-user"></span>
              <span class="site-state-item-name">about</span>
            </a>
          </div>
          
        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/no5ix" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://open.spotify.com/user/313duq77ekebrfyak3xijqewzss4?si=e7653b829a9747bf" target="_blank" title="Spotify">
                  
                    <i class="fa fa-fw fa-spotify"></i>
                  
                    
                      Spotify
                    
                </a>
              </span>
            
          
          
          <!-- ç½‘æ˜“äº‘éŸ³ä¹ -->
            <!-- <div class="netease-cloud-music"> -->
              <!-- <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=110 src="//music.163.com/outchain/player?type=0&id=992743594&auto=0&height=90"></iframe> -->
            <!-- </div> -->
          <!-- ç½‘æ˜“äº‘éŸ³ä¹ -->

        </div>

        
        

        
        

        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mike</span>
</div>



        

        
      </div>
    </footer>

    <!--
    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      
        <span id="scrollpercent"><span>0</span>%</span>
      
    </div>
    -->

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>










  















  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/mediumzoom/medium-zoom.js?v=1.1.0"></script>





  




  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>


  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  

    <script src="/js/src/local-search.js"></script>





  

  

  

  

  

  


  <script type="text/javascript" src="/lib/wobble_window/wobblewindow.js"> </script>
<script type="text/javascript" src="/js/src/custom.js"></script>
</body>
</html>






<script type="text/javascript" src="/js/src/headroom.js"></script>

<!-- ä»£ç å—å¤åˆ¶åŠŸèƒ½ -->
<script type="text/javascript" src="/js/src/code-highlight-modification.js"></script>

<!-- Flashcards Script -->
<script type="text/javascript" src="/js/src/flashcards.js"></script>
